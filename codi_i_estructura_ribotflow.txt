ESTRUCTURA DEL PROJECTE (./src)

â”œâ”€â”€ app
â”‚   â”œâ”€â”€ actions
â”‚   â”‚   â”œâ”€â”€ chatbotActions.ts
â”‚   â”‚   â”œâ”€â”€ departaments
â”‚   â”‚   â”‚   â””â”€â”€ actions.ts
â”‚   â”‚   â”œâ”€â”€ invitationActions.ts
â”‚   â”‚   â”œâ”€â”€ localeActions.ts
â”‚   â”‚   â””â”€â”€ tasks
â”‚   â”‚       â””â”€â”€ actions.ts
â”‚   â”œâ”€â”€ api
â”‚   â”‚   â”œâ”€â”€ chatbot
â”‚   â”‚   â”‚   â””â”€â”€ route.ts
â”‚   â”‚   â”œâ”€â”€ oauth
â”‚   â”‚   â”‚   â””â”€â”€ callback
â”‚   â”‚   â”‚       â””â”€â”€ [provider]
â”‚   â”‚   â”‚           â””â”€â”€ route.ts
â”‚   â”‚   â””â”€â”€ sync-imap
â”‚   â”‚       â””â”€â”€ route.ts
â”‚   â”œâ”€â”€ globals.css
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”œâ”€â”€ page.tsx
â”‚   â””â”€â”€ [locale]
â”‚       â”œâ”€â”€ (app)
â”‚       â”‚   â”œâ”€â”€ comunicacio
â”‚       â”‚   â”‚   â”œâ”€â”€ inbox
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ _components
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ComposeDialog.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ContactPanel.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EmailEditorToolbar.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ InboxClient.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ InboxData.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ InboxSkeleton.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MobileDetailView.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SafeEmailRenderer.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TicketDetail.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ticketList
â”‚       â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ index.tsx
â”‚       â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ TicketListFilters.tsx
â”‚       â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ TicketListHeader.tsx
â”‚       â”‚   â”‚   â”‚   â”‚       â””â”€â”€ TicketListItem.tsx
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _hooks
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ useCompose.ts
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ useInbox.ts
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ useInboxComputed.ts
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ useInboxStateAndFilter.ts
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ useTicketData.ts
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ useURLSync.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ marketing
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ _components
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AICampaignWizard.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CampaignCalendar.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CampaignDetailDialog.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CampaignList.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ marketing-client.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MarketingData.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MarketingSkeleton.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MetricCard.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ wizard
â”‚       â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ WizardStep1_Goal.tsx
â”‚       â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ WizardStep2_SelectStrategy.tsx
â”‚       â”‚   â”‚   â”‚   â”‚       â””â”€â”€ WizardStep3_Finalize.tsx
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _hooks
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ useAICampaignWizard.ts
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ useMarketing.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ planificador
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ types.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ _components
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CreatePostDialog.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PostCard.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PostPreview.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SchedulePostDialog.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SocialPlannerClient.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SocialPlannerData.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SocialPlannerSkeleton.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ViewPostDialog.tsx
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _hooks
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ useCreatePost.ts
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ useSocialPlanner.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ templates
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ _components
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TemplateEditor.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TemplateList.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ templates-client.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TemplatesData.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TemplatesSkeleton.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ TemplateVariables.tsx
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _hooks
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ useTemplates.ts
â”‚       â”‚   â”‚   â””â”€â”€ transcripcio
â”‚       â”‚   â”‚       â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚       â”œâ”€â”€ new
â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚       â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚       â”‚       â””â”€â”€ AudioJobUploader.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ [jobId]
â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚       â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚       â”‚       â””â”€â”€ AudioJobResult.tsx
â”‚       â”‚   â”‚       â””â”€â”€ _components
â”‚       â”‚   â”‚           â”œâ”€â”€ AudioJobsList.tsx
â”‚       â”‚   â”‚           â”œâ”€â”€ CreateTaskDialog.tsx
â”‚       â”‚   â”‚           â”œâ”€â”€ FormattedTranscription.tsx
â”‚       â”‚   â”‚           â”œâ”€â”€ JobStatusBadge.tsx
â”‚       â”‚   â”‚           â”œâ”€â”€ KeyMomentsFlow.tsx
â”‚       â”‚   â”‚           â””â”€â”€ ParticipantsList.tsx
â”‚       â”‚   â”œâ”€â”€ crm
â”‚       â”‚   â”‚   â”œâ”€â”€ activitats
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ activitats-client.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ ActivitiesData.tsx
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ ActivitiesSkeleton.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ calendari
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ _components
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ calendar-custom.css
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CalendarClient.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CalendarData.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CalendarSkeleton.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CalendarSkeletonEvent.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CalendarToolbar.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EmailDetailDialog.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ QuoteDetailDialog.tsx
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _hooks
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ calendarFetch.ts
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ calendarHelpers.ts
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ calendarMapEvents.ts
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ useCalendar.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ useCalendarController.ts
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ useCalendarDialog.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ contactes
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ [contactId]
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ _components
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ contact-detail-client.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ContactDetailData.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ContactDetailHeader.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ContactDetailSkeleton.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ContactViewSwitcher.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ EditableField.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ tabs
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ ActivitiesTab.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ ContactSummaryDashboard.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ DetailsTab.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ GeneralInfoSection.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚       â””â”€â”€ RelatedDataTable.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ _hooks
â”‚       â”‚   â”‚   â”‚   â”‚       â””â”€â”€ useContactDetail.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ _components
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ContactCard.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ContactDialog.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ contacts-client.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ContactsData.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ContactsSkeleton.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ContactTable.tsx
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _hooks
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ useContactFilters.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ general
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ charts
â”‚       â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ CampaignPerformanceChart.tsx
â”‚       â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ DailySummaryWidget.tsx
â”‚       â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ LeadSourceChart.tsx
â”‚       â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ LeadSourceConversionChart.tsx
â”‚       â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ OpportunityAgingChart.tsx
â”‚       â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ RevenueForecastChart.tsx
â”‚       â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ SalesActivityChart.tsx
â”‚       â”‚   â”‚   â”‚       â”‚   â””â”€â”€ SalesFunnelChart.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ ComposeEmailDialog.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ crm-client.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ CrmData.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ CrmSkeleton.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ kip
â”‚       â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ KipGrid.tsx
â”‚       â”‚   â”‚   â”‚       â”‚   â””â”€â”€ KpiItem.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ lists
â”‚       â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ ActivityList.tsx
â”‚       â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ HealtRadarList.tsx
â”‚       â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ ListItem.tsx
â”‚       â”‚   â”‚   â”‚       â”‚   â””â”€â”€ TopClientsList.tsx
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ send-email-action.ts
â”‚       â”‚   â”‚   â””â”€â”€ pipeline
â”‚       â”‚   â”‚       â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚       â”œâ”€â”€ loading.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ pipeline-client.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ _components
â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ ColumnsView.tsx
â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ OportunityCard.tsx
â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ OportunityRowCard.tsx
â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ OpportunityDialog.tsx
â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ PipelineData.tsx
â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ PipelineSkeleton.tsx
â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ RowsView.tsx
â”‚       â”‚   â”‚       â”‚   â””â”€â”€ StageColumn.tsx
â”‚       â”‚   â”‚       â””â”€â”€ _hooks
â”‚       â”‚   â”‚           â”œâ”€â”€ useOpportunityForm.ts
â”‚       â”‚   â”‚           â””â”€â”€ usePipeline.ts
â”‚       â”‚   â”œâ”€â”€ dashboard
â”‚       â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ dashboard-client.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚       â”œâ”€â”€ agenda
â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ Agenda.tsx
â”‚       â”‚   â”‚       â”‚   â””â”€â”€ TaskCard.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ AIOracle.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ AIOracleSkeleton.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ DashboardData.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ DashboardMainGrid.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ DashboardSkeleton.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ QuickAccess.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ Radar.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ RecentActivities.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ RecentEmails.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ RecentQuotes.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ SalesPerformance.tsx
â”‚       â”‚   â”‚       â””â”€â”€ StatCardsGrid.tsx
â”‚       â”‚   â”œâ”€â”€ excel
â”‚       â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â””â”€â”€ ExcelDropdownButton.tsx
â”‚       â”‚   â”œâ”€â”€ finances
â”‚       â”‚   â”‚   â”œâ”€â”€ expenses
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ [expenseId]
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ _components
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AttachmentUploader.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ExpenseAttachmentCard.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ExpenseAttachmentUploader.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ExpenseDetailClient.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ExpenseDetailData.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ExpenseDetailSkeleton.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ExpenseItemsEditor.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ SupplierCombobox.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ _hooks
â”‚       â”‚   â”‚   â”‚   â”‚       â””â”€â”€ useExpenseDetail.ts
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ ExpenseFilters.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ ExpensesClient.tsx
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ ExpensesData.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ invoices
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ [invoiceId]
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ _components
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ client
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ InvoiceDetailHeader.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ InvoiceMainContent.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ InvoiceMetaGrid.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ InvoiceDetailClient.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ InvoiceDetailData.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ InvoiceDetailSkeleton.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ InvoiceItemsEditor.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ InvoicePreview.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ PDF
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ InvoiceDownloadButton.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ InvoicePDF.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚       â””â”€â”€ InvoicePdfDocument.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ _hooks
â”‚       â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ fetchInvoiceDetail.ts
â”‚       â”‚   â”‚   â”‚   â”‚       â””â”€â”€ useInvoiceDetail.ts
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ InvoiceClient.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ InvoicesData.tsx
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ InvoicesFilters.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ products
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ schemas.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ [productId]
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ ProductDetailClient.tsx
â”‚       â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ ProductDetailData.tsx
â”‚       â”‚   â”‚   â”‚   â”‚       â””â”€â”€ ProductDetailView.tsx
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ ProductsClient.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ ProductsData.tsx
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ ProductsFilters.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ quotes
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ [id]
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ _components
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ CompanyProfileDialog.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ PDF
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ QuoteDownloadButton.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ QuotePdfDocument.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ QuoteEditorClient.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ QuoteEditorData.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ QuoteEditorSkeleton.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ QuoteItems.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ QuoteMeta.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ QuotePreview.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ QuoteTotals.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ _hooks
â”‚       â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ useQuoteEditor.ts
â”‚       â”‚   â”‚   â”‚   â”‚       â””â”€â”€ useQuoteItems.ts
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ QuotesClient.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ QuotesData.tsx
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ QuotesFilters.tsx
â”‚       â”‚   â”‚   â””â”€â”€ suppliers
â”‚       â”‚   â”‚       â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚       â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ [supplierId]
â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ schemas.ts
â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ _components
â”‚       â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ LinkContactDialog.tsx
â”‚       â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ LinkExpenseDialog.tsx
â”‚       â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ SupplierDetailClient.tsx
â”‚       â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ SupplierDetailData.tsx
â”‚       â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ SupplierForm.tsx
â”‚       â”‚   â”‚       â”‚   â”‚   â””â”€â”€ tabs
â”‚       â”‚   â”‚       â”‚   â”‚       â”œâ”€â”€ ContactsTabContent.tsx
â”‚       â”‚   â”‚       â”‚   â”‚       â”œâ”€â”€ ExpensesTabContent.tsx
â”‚       â”‚   â”‚       â”‚   â”‚       â”œâ”€â”€ RelateDataTabs.tsx
â”‚       â”‚   â”‚       â”‚   â”‚       â””â”€â”€ TicketsTabContent.tsx
â”‚       â”‚   â”‚       â”‚   â””â”€â”€ _hooks
â”‚       â”‚   â”‚       â”‚       â””â”€â”€ useSupplierForm.ts
â”‚       â”‚   â”‚       â””â”€â”€ _components
â”‚       â”‚   â”‚           â”œâ”€â”€ SuppliersClient.tsx
â”‚       â”‚   â”‚           â”œâ”€â”€ SuppliersData.tsx
â”‚       â”‚   â”‚           â””â”€â”€ SuppliersFilters.tsx
â”‚       â”‚   â”œâ”€â”€ layout.tsx
â”‚       â”‚   â”œâ”€â”€ loading.tsx
â”‚       â”‚   â”œâ”€â”€ network
â”‚       â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ loading.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ schemas.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ types.ts
â”‚       â”‚   â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚       â”œâ”€â”€ AddressAutocomplete.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ CreateProjectDialog.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ MapContainer.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ NetworkClient.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ NetworkData.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ NetworkSkeleton.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ profiles
â”‚       â”‚   â”‚       â”‚   â”œâ”€â”€ ProfileCard.tsx
â”‚       â”‚   â”‚       â”‚   â””â”€â”€ ProfileList.tsx
â”‚       â”‚   â”‚       â””â”€â”€ projects
â”‚       â”‚   â”‚           â”œâ”€â”€ ProjectCard.tsx
â”‚       â”‚   â”‚           â””â”€â”€ ProjecteList.tsx
â”‚       â”‚   â”œâ”€â”€ projectStrocture
â”‚       â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚       â””â”€â”€ ArchitectureVisualizer.tsx
â”‚       â”‚   â”œâ”€â”€ redirecting
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ settings
â”‚       â”‚   â”‚   â”œâ”€â”€ billing
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ BillingClient.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ BillingData.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ BillingSkeleton.tsx
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ UpgradePlanNotice.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ blacklist
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ action.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ BlacklistClient.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ BlacklistData.tsx
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ BlacklistSkeleton.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ customization
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ CustomizationClient.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ CustomizationData.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ CustomizationSkeleton.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ LanguageSwitcher.tsx
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ ThemeSwitcher.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ install
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ DeviceIcons.tsx
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ InstallationManager.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ integrations
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ schemas.ts
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ ImapSmtpDialog.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ IntegrationsClient.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ IntegrationsData.tsx
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ IntegrationsSkeleton.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ layout.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ permissions
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ PermissionsClient.tsx
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ PermissionsData.tsx
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ PermissionsSkeleton.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ profile
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ _components
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProfileData.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ProfileForm.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ProfileSkeleton.tsx
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _hooks
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ useProfileForm.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ team
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ _components
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ActiveTeamManagerData.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TeamClient.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TeamDashboard.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TeamData.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TeamHub.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TeamSelectorData.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ TeamSkeleton.tsx
â”‚       â”‚   â”‚   â”‚   â”‚   â””â”€â”€ TeamStateCorrector.tsx
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ _hooks
â”‚       â”‚   â”‚   â”‚       â”œâ”€â”€ useTeamHub.ts
â”‚       â”‚   â”‚   â”‚       â””â”€â”€ useTeamManagement.ts
â”‚       â”‚   â”‚   â””â”€â”€ _components
â”‚       â”‚   â”‚       â”œâ”€â”€ settings-nav.tsx
â”‚       â”‚   â”‚       â””â”€â”€ SettingsSkeleton.tsx
â”‚       â”‚   â””â”€â”€ _components
â”‚       â”‚       â”œâ”€â”€ AppClientLayout.tsx
â”‚       â”‚       â”œâ”€â”€ main-sidebar.tsx
â”‚       â”‚       â”œâ”€â”€ MobileMenu.tsx
â”‚       â”‚       â”œâ”€â”€ module-sidebar.tsx
â”‚       â”‚       â”œâ”€â”€ NavItem.tsx
â”‚       â”‚       â””â”€â”€ ui
â”‚       â”‚           â””â”€â”€ redirect-animation.tsx
â”‚       â”œâ”€â”€ (auth)
â”‚       â”‚   â”œâ”€â”€ auth
â”‚       â”‚   â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ callback
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ route.ts
â”‚       â”‚   â”‚   â”œâ”€â”€ check-email
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”‚   â””â”€â”€ reset-password
â”‚       â”‚   â”‚       â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ login
â”‚       â”‚   â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ _components
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ ForgotPasswordDialog.tsx
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ LoginClient.tsx
â”‚       â”‚   â”‚   â””â”€â”€ _hooks
â”‚       â”‚   â”‚       â””â”€â”€ useLoginForm.ts
â”‚       â”‚   â””â”€â”€ signup
â”‚       â”‚       â”œâ”€â”€ page.tsx
â”‚       â”‚       â”œâ”€â”€ _components
â”‚       â”‚       â”‚   â””â”€â”€ SignupClient.tsx
â”‚       â”‚       â””â”€â”€ _hooks
â”‚       â”‚           â””â”€â”€ useSignupForm.ts
â”‚       â”œâ”€â”€ (legal)
â”‚       â”‚   â”œâ”€â”€ avis-legal
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ politica-cookies
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ politica-privacitat
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ termes-condicions
â”‚       â”‚   â”‚   â””â”€â”€ page.tsx
â”‚       â”‚   â””â”€â”€ _components
â”‚       â”‚       â”œâ”€â”€ CookiePolicyContent.tsx
â”‚       â”‚       â”œâ”€â”€ LegalNoticeContent.tsx
â”‚       â”‚       â”œâ”€â”€ PrivacyPolicyContent.tsx
â”‚       â”‚       â””â”€â”€ TermsContent.tsx
â”‚       â”œâ”€â”€ (public)
â”‚       â”‚   â”œâ”€â”€ MainLandingView.tsx
â”‚       â”‚   â””â”€â”€ _components
â”‚       â”‚       â”œâ”€â”€ BentoCard.tsx
â”‚       â”‚       â”œâ”€â”€ FeatureBentoGrid.tsx
â”‚       â”‚       â”œâ”€â”€ HeroContent.tsx
â”‚       â”‚       â”œâ”€â”€ IconCloudBackground.tsx
â”‚       â”‚       â”œâ”€â”€ LandingNav.tsx
â”‚       â”‚       â””â”€â”€ ParticleBackground.tsx
â”‚       â”œâ”€â”€ accept-invite
â”‚       â”‚   â””â”€â”€ route.ts
â”‚       â”œâ”€â”€ global-error.tsx
â”‚       â”œâ”€â”€ invitation
â”‚       â”‚   â””â”€â”€ accept
â”‚       â”‚       â”œâ”€â”€ page.tsx
â”‚       â”‚       â””â”€â”€ _components
â”‚       â”‚           â””â”€â”€ InvitedSignupForm.tsx
â”‚       â”œâ”€â”€ layout.tsx
â”‚       â”œâ”€â”€ onboarding
â”‚       â”‚   â”œâ”€â”€ actions.ts
â”‚       â”‚   â”œâ”€â”€ page.tsx
â”‚       â”‚   â”œâ”€â”€ _components
â”‚       â”‚   â”‚   â”œâ”€â”€ OnboardingClient.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ OnboardingContext.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ OnboardingData.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ OnboardingLayout.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ OnboardingSkeleton.tsx
â”‚       â”‚   â”‚   â”œâ”€â”€ ServiceSelectionModal.tsx
â”‚       â”‚   â”‚   â””â”€â”€ steps
â”‚       â”‚   â”‚       â”œâ”€â”€ index.ts
â”‚       â”‚   â”‚       â”œâ”€â”€ Step1.tsx
â”‚       â”‚   â”‚       â”œâ”€â”€ Step2.tsx
â”‚       â”‚   â”‚       â””â”€â”€ Step3.tsx
â”‚       â”‚   â””â”€â”€ _hooks
â”‚       â”‚       â””â”€â”€ useOnboardingForm.ts
â”‚       â”œâ”€â”€ page.tsx
â”‚       â”œâ”€â”€ quote
â”‚       â”‚   â””â”€â”€ [secureId]
â”‚       â”‚       â”œâ”€â”€ actions.ts
â”‚       â”‚       â”œâ”€â”€ page.tsx
â”‚       â”‚       â”œâ”€â”€ _components
â”‚       â”‚       â”‚   â”œâ”€â”€ PublicQuoteClient.tsx
â”‚       â”‚       â”‚   â”œâ”€â”€ PublicQuoteData.tsx
â”‚       â”‚       â”‚   â”œâ”€â”€ PublicQuoteView.tsx
â”‚       â”‚       â”‚   â”œâ”€â”€ QuoteStatusScreeen.tsx
â”‚       â”‚       â”‚   â””â”€â”€ RejectionDialog.tsx
â”‚       â”‚       â””â”€â”€ _hooks
â”‚       â”‚           â””â”€â”€ usePublicQuote.ts
â”‚       â””â”€â”€ _components
â”‚           â””â”€â”€ AddressSearch.tsx
â”œâ”€â”€ components
â”‚   â”œâ”€â”€ chatbot
â”‚   â”‚   â””â”€â”€ Chatbot.tsx
â”‚   â”œâ”€â”€ features
â”‚   â”‚   â”œâ”€â”€ contactes
â”‚   â”‚   â”‚   â””â”€â”€ ContactSelector.tsx
â”‚   â”‚   â”œâ”€â”€ EditorWysiwyg
â”‚   â”‚   â”‚   â”œâ”€â”€ EditorToolbar.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ EditorWysiwyg.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”‚   â””â”€â”€ tiptapExtensions.ts
â”‚   â”‚   â””â”€â”€ tasks
â”‚   â”‚       â”œâ”€â”€ hooks
â”‚   â”‚       â”‚   â””â”€â”€ useTaskForm.ts
â”‚   â”‚       â”œâ”€â”€ TaskDetailView.tsx
â”‚   â”‚       â”œâ”€â”€ TaskDialogManager.tsx
â”‚   â”‚       â”œâ”€â”€ TaskFormActrions.tsx
â”‚   â”‚       â”œâ”€â”€ TaskFormPrimary.tsx
â”‚   â”‚       â”œâ”€â”€ TaskFormSecondary.tsx
â”‚   â”‚       â””â”€â”€ TaskFormView.tsx
â”‚   â”œâ”€â”€ LanguageSwitcher.tsx
â”‚   â”œâ”€â”€ PWARegistration.tsx
â”‚   â”œâ”€â”€ shared
â”‚   â”‚   â”œâ”€â”€ AccessDenied.tsx
â”‚   â”‚   â”œâ”€â”€ ActivityItem.tsx
â”‚   â”‚   â”œâ”€â”€ ColumnToggleButton.tsx
â”‚   â”‚   â”œâ”€â”€ EmptyState.tsx
â”‚   â”‚   â”œâ”€â”€ GenericDataTable.tsx
â”‚   â”‚   â”œâ”€â”€ GenericDataTableSkeleton.tsx
â”‚   â”‚   â”œâ”€â”€ ModuleCard.tsx
â”‚   â”‚   â”œâ”€â”€ PageHeader.tsx
â”‚   â”‚   â”œâ”€â”€ PaginationBar.tsx
â”‚   â”‚   â”œâ”€â”€ ProductSelector.tsx
â”‚   â”‚   â”œâ”€â”€ StatCard.tsx
â”‚   â”‚   â”œâ”€â”€ StatusBadge.tsx
â”‚   â”‚   â””â”€â”€ SupplierCombobox.tsx
â”‚   â”œâ”€â”€ theme-provider.tsx
â”‚   â”œâ”€â”€ ThemeSwitcher.tsx
â”‚   â””â”€â”€ ui
â”‚       â”œâ”€â”€ accordion.tsx
â”‚       â”œâ”€â”€ alert-dialog.tsx
â”‚       â”œâ”€â”€ alert.tsx
â”‚       â”œâ”€â”€ avatar.tsx
â”‚       â”œâ”€â”€ badge.jsx
â”‚       â”œâ”€â”€ button.tsx
â”‚       â”œâ”€â”€ calendar.tsx
â”‚       â”œâ”€â”€ card.tsx
â”‚       â”œâ”€â”€ checkbox.tsx
â”‚       â”œâ”€â”€ collapsible.tsx
â”‚       â”œâ”€â”€ command.tsx
â”‚       â”œâ”€â”€ dialog.tsx
â”‚       â”œâ”€â”€ drawer.tsx
â”‚       â”œâ”€â”€ dropdown-menu.tsx
â”‚       â”œâ”€â”€ form.tsx
â”‚       â”œâ”€â”€ index.tsx
â”‚       â”œâ”€â”€ input.tsx
â”‚       â”œâ”€â”€ label.tsx
â”‚       â”œâ”€â”€ LegalModalTrigger.tsx
â”‚       â”œâ”€â”€ pagination.tsx
â”‚       â”œâ”€â”€ popover.tsx
â”‚       â”œâ”€â”€ progress.tsx
â”‚       â”œâ”€â”€ scroll-area.tsx
â”‚       â”œâ”€â”€ select.tsx
â”‚       â”œâ”€â”€ separator.tsx
â”‚       â”œâ”€â”€ sheet.tsx
â”‚       â”œâ”€â”€ skeleton.tsx
â”‚       â”œâ”€â”€ sonner.tsx
â”‚       â”œâ”€â”€ switch.tsx
â”‚       â”œâ”€â”€ table.tsx
â”‚       â”œâ”€â”€ tabs.tsx
â”‚       â”œâ”€â”€ textarea.tsx
â”‚       â”œâ”€â”€ toast.tsx
â”‚       â”œâ”€â”€ toaster.tsx
â”‚       â”œâ”€â”€ toggle-group.tsx
â”‚       â”œâ”€â”€ toggle.tsx
â”‚       â””â”€â”€ tooltip.tsx
â”œâ”€â”€ config
â”‚   â”œâ”€â”€ billing.ts
â”‚   â”œâ”€â”€ contacts.ts
â”‚   â”œâ”€â”€ inbox.ts
â”‚   â”œâ”€â”€ invoices.ts
â”‚   â”œâ”€â”€ navigation.ts
â”‚   â”œâ”€â”€ pipeline.ts
â”‚   â”œâ”€â”€ styles
â”‚   â”‚   â”œâ”€â”€ quotes.ts
â”‚   â”‚   â””â”€â”€ task.ts
â”‚   â””â”€â”€ subscriptions.ts
â”œâ”€â”€ emails
â”‚   â””â”€â”€ TranscriptionSummaryEmail.tsx
â”œâ”€â”€ hooks
â”‚   â”œâ”€â”€ useAppNavigation.ts
â”‚   â”œâ”€â”€ useMediaQuery.ts
â”‚   â”œâ”€â”€ usePaginateResource.ts
â”‚   â””â”€â”€ useUser.ts
â”œâ”€â”€ i18n.ts
â”œâ”€â”€ lib
â”‚   â”œâ”€â”€ data
â”‚   â”‚   â””â”€â”€ dashboard.ts
â”‚   â”œâ”€â”€ google
â”‚   â”‚   â””â”€â”€ google-api.ts
â”‚   â”œâ”€â”€ pdf
â”‚   â”‚   â”œâ”€â”€ generateInvoicePDF.tsx
â”‚   â”‚   â””â”€â”€ generateQuotePDF.tsx
â”‚   â”œâ”€â”€ permissions
â”‚   â”‚   â”œâ”€â”€ permissions.config.ts
â”‚   â”‚   â””â”€â”€ permissions.ts
â”‚   â”œâ”€â”€ services
â”‚   â”‚   â”œâ”€â”€ comunicacio
â”‚   â”‚   â”‚   â”œâ”€â”€ inbox.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ marketing.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ socialPlanner.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ templates.service.ts
â”‚   â”‚   â”‚   â””â”€â”€ transcripcio.service.ts
â”‚   â”‚   â”œâ”€â”€ crm
â”‚   â”‚   â”‚   â”œâ”€â”€ activities
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ activities.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ calendar
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ calendar.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ contacts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ contacts.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ general
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ campaignPerformance.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ charts.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ dailySummary.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ data.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ funnel.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ lists.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ revenue.service.ts
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ stats.service.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ types.ts
â”‚   â”‚   â”‚   â””â”€â”€ pipeline
â”‚   â”‚   â”‚       â”œâ”€â”€ opportunities.service.ts
â”‚   â”‚   â”‚       â”œâ”€â”€ pipline.service.ts
â”‚   â”‚   â”‚       â””â”€â”€ stages.service.ts
â”‚   â”‚   â”œâ”€â”€ crm.service.ts
â”‚   â”‚   â”œâ”€â”€ dashboard
â”‚   â”‚   â”‚   â””â”€â”€ dashboard.service.ts
â”‚   â”‚   â”œâ”€â”€ departments.service.ts
â”‚   â”‚   â”œâ”€â”€ finances
â”‚   â”‚   â”‚   â”œâ”€â”€ expenses
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ expenseDetail.service.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ expenses.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ invoices
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ invoices.service.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ invoicesDetail.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ products
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ products.service.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ quotes
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ quote-editor.service.ts
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ quotes.service.ts
â”‚   â”‚   â”‚   â””â”€â”€ suppliers
â”‚   â”‚   â”‚       â””â”€â”€ suppliers.service.ts
â”‚   â”‚   â”œâ”€â”€ network
â”‚   â”‚   â”‚   â””â”€â”€ network.service.ts
â”‚   â”‚   â”œâ”€â”€ onboarding
â”‚   â”‚   â”‚   â”œâ”€â”€ onboarding.service.ts
â”‚   â”‚   â”‚   â””â”€â”€ schema.ts
â”‚   â”‚   â”œâ”€â”€ publicQuote
â”‚   â”‚   â”‚   â””â”€â”€ public-quote.service.ts
â”‚   â”‚   â””â”€â”€ settings
â”‚   â”‚       â”œâ”€â”€ billing
â”‚   â”‚       â”‚   â””â”€â”€ billing.service.ts
â”‚   â”‚       â”œâ”€â”€ blacklist
â”‚   â”‚       â”‚   â””â”€â”€ blacklist.service.ts
â”‚   â”‚       â”œâ”€â”€ integrations
â”‚   â”‚       â”‚   â””â”€â”€ integrations.service.ts
â”‚   â”‚       â”œâ”€â”€ permissions
â”‚   â”‚       â”‚   â””â”€â”€ permissions.service.ts
â”‚   â”‚       â”œâ”€â”€ profile
â”‚   â”‚       â”‚   â””â”€â”€ profile.service.ts
â”‚   â”‚       â””â”€â”€ team
â”‚   â”‚           â””â”€â”€ team.service.ts
â”‚   â”œâ”€â”€ subscription
â”‚   â”‚   â””â”€â”€ subscription.ts
â”‚   â”œâ”€â”€ supabase
â”‚   â”‚   â”œâ”€â”€ admin.ts
â”‚   â”‚   â”œâ”€â”€ client.ts
â”‚   â”‚   â”œâ”€â”€ server.ts
â”‚   â”‚   â”œâ”€â”€ session.ts
â”‚   â”‚   â”œâ”€â”€ teamContext.ts
â”‚   â”‚   â””â”€â”€ teams.ts
â”‚   â”œâ”€â”€ utils
â”‚   â”‚   â”œâ”€â”€ crypto.ts
â”‚   â”‚   â”œâ”€â”€ formatters.ts
â”‚   â”‚   â”œâ”€â”€ media.ts
â”‚   â”‚   â”œâ”€â”€ templates.ts
â”‚   â”‚   â””â”€â”€ utils.ts
â”‚   â””â”€â”€ verifactu
â”‚       â””â”€â”€ service.ts
â”œâ”€â”€ middleware.ts
â”œâ”€â”€ stores
â”‚   â””â”€â”€ navigationStore.ts
â””â”€â”€ types
    â”œâ”€â”€ app
    â”‚   â””â”€â”€ navigation.ts
    â”œâ”€â”€ comunicacio
    â”‚   â”œâ”€â”€ inbox.ts
    â”‚   â””â”€â”€ marketing.ts
    â”œâ”€â”€ crm
    â”‚   â”œâ”€â”€ calendar.ts
    â”‚   â”œâ”€â”€ contacts.ts
    â”‚   â”œâ”€â”€ deals.ts
    â”‚   â”œâ”€â”€ general.ts
    â”‚   â”œâ”€â”€ index.ts
    â”‚   â””â”€â”€ opportunitys.ts
    â”œâ”€â”€ dashboard
    â”‚   â””â”€â”€ types.ts
    â”œâ”€â”€ db.ts
    â”œâ”€â”€ declarations
    â”‚   â”œâ”€â”€ mapbox.d.ts
    â”‚   â””â”€â”€ prism.d.ts
    â”œâ”€â”€ declarations.d.ts
    â”œâ”€â”€ finances
    â”‚   â”œâ”€â”€ expenses.ts
    â”‚   â”œâ”€â”€ index.ts
    â”‚   â”œâ”€â”€ invoices.ts
    â”‚   â”œâ”€â”€ products.ts
    â”‚   â”œâ”€â”€ quotes.ts
    â”‚   â”œâ”€â”€ scheams.ts
    â”‚   â””â”€â”€ suppliers.ts
    â”œâ”€â”€ network
    â”‚   â””â”€â”€ network.ts
    â”œâ”€â”€ settings
    â”‚   â”œâ”€â”€ blackListRule.ts
    â”‚   â”œâ”€â”€ index.ts
    â”‚   â”œâ”€â”€ profiles.ts
    â”‚   â”œâ”€â”€ subscription.ts
    â”‚   â””â”€â”€ team.ts
    â”œâ”€â”€ shared
    â”‚   â”œâ”€â”€ actionResult.ts
    â”‚   â”œâ”€â”€ address.ts
    â”‚   â”œâ”€â”€ index.ts
    â”‚   â”œâ”€â”€ nextPageProps.ts
    â”‚   â””â”€â”€ notification.ts
    â”œâ”€â”€ supabase.ts
    â””â”€â”€ tasks
        â””â”€â”€ task.ts


CONTINGUT DELS FITXERS


// =================== FILE: src/app/actions/chatbotActions.ts ===================

"use server";

import { createClient } from "@/lib/supabase/server";



export async function chatbotAction(question: string): Promise<{ data: string | null, error: string | null }> {
  if (!process.env.GEMINI_API_KEY) {
    return { data: null, error: "La clau de l'API de Gemini no estÃ  configurada." };
  }

  try {
    // ğŸ”¹ 1. Recuperem documents similars de Supabase
    const supabase = createClient();

    const { data: matches, error: dbError } = await supabase.rpc("match_documents", {
      query_embedding: JSON.stringify(await embedQuestion(question)),
      match_threshold: 0.7,
      match_count: 3,
    });

    if (dbError) throw dbError;

    console.log("[Chatbot] Documents trobats:", matches?.length);

    console.log("[Chatbot] Context generat:");

    // ğŸ”¹ 2. Preparem el prompt per a Gemini
    const prompt = `
      Ets un assistent Ãºtil.
      Pregunta de l'usuari: "${question}"
      Context de la base de dades:
      
      Respon en catalÃ , de manera clara i concisa.
    `;

    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

    // ğŸ”¹ 3. Cridem Gemini directament via fetch
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${process.env.GEMINI_API_KEY}`,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      }
    );

    if (!response.ok) throw new Error("Error de l'API de Gemini");

    const result = await response.json();
    const answer: string = result.candidates[0].content.parts[0].text;

    return { data: answer, error: null };
  } catch (error: unknown) {
    const message = error instanceof Error ? error.message : "Error desconegut";
    console.error("Error al chatbot:", message);
    return { data: null, error: message };
  }
}

async function embedQuestion(question: string): Promise<number[]> {
  const response = await fetch("https://api.openai.com/v1/embeddings", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
    },
    body: JSON.stringify({
      model: "text-embedding-3-small",
      input: question,
    }),
  });

  if (!response.ok) throw new Error("Error generant embedding amb OpenAI");
  const data = await response.json();
  return data.data[0].embedding;
}


// =================== FILE: src/app/actions/departaments/actions.ts ===================

// src/app/actions/departments/actions.ts (Ãšltim Intent amb 'as any')

'use server';

import { revalidatePath } from 'next/cache';
import { z } from 'zod';
import { validateUserSession } from '@/lib/supabase/session';
import { Database, Tables } from '@/types/supabase';
import { createServerActionClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import { PostgrestSingleResponse } from '@supabase/supabase-js';

type ActionResult = {
    success?: boolean;
    error?: string;
    newDepartment?: Tables<'departments'>;
};

const departmentNameSchema = z.string()
    .min(1, 'El nom del departament Ã©s obligatori.')
    .max(100, 'El nom no pot superar els 100 carÃ cters.');

// --- Crear Departament ---
export async function createDepartment(teamId: string | undefined, name: string): Promise<ActionResult> {
    if (!teamId) { return { error: "Falta l'identificador de l'equip." }; }
    const validation = departmentNameSchema.safeParse(name);
    if (!validation.success) { return { error: validation.error.issues[0]?.message ?? "Nom de departament invÃ lid." }; }
    const validatedName = validation.data;

    console.log(`--- [Server Action] Intentant crear departament: "${validatedName}" per a l'equip ${teamId} ---`);

    const sessionInfo = await validateUserSession();
    if ('error' in sessionInfo) { return { error: sessionInfo.error.message }; }
    const supabase = createServerActionClient<Database>({ cookies });




    // Intent d'inserciÃ³
    // Tipem explÃ­citament l'objecte per evitar 'any'
    const { data: insertedData, error }: PostgrestSingleResponse<Tables<'departments'>> = await supabase
        .from('departments')
     
        .select()
        .single();

    // GestiÃ³ d'errors
    if (error) {
        console.error("Error creant departament a Supabase:", error);
        if (error.code === '23505') { return { error: `Ja existeix un departament amb el nom "${validatedName}" en aquest equip.` }; }
        return { error: `Error de base de dades: ${error.message}` };
    }

    // ComprovaciÃ³ de dades retornades
    if (!insertedData) {
         console.error("Supabase no ha retornat dades desprÃ©s de la inserciÃ³ tot i no haver error.");
         return { error: "No s'han pogut obtenir les dades del nou departament." };
    }

    // AccÃ©s a les propietats (ara hauria de funcionar grÃ cies al tipat de PostgrestSingleResponse)
    console.log(`Departament "${insertedData.name}" creat amb ID: ${insertedData.id}`);

    // RevalidaciÃ³
    revalidatePath('/[locale]/(app)/dashboard', 'layout');
    revalidatePath('/[locale]/(app)/crm/calendari', 'layout');

    // Retorn
    return { success: true, newDepartment: insertedData };
}

// --- Eliminar Departament ---
// (Es mantÃ© igual)
export async function deleteDepartment(departmentId: number): Promise<ActionResult> {
     if (isNaN(departmentId) || departmentId <= 0) { return { error: "ID de departament invÃ lid." }; }
     console.log(`--- [Server Action] Intentant eliminar departament ID: ${departmentId} ---`);
     const sessionInfo = await validateUserSession();
     if ('error' in sessionInfo) { return { error: sessionInfo.error.message }; }
     const supabase = createServerActionClient<Database>({ cookies });
     // TODO: ComprovaciÃ³ de Permisos
     const { count, error: checkError } = await supabase
         .from('tasks')
         .select('*', { count: 'exact', head: true })
         .eq('department_id', departmentId);
     if (checkError) { console.error("Error comprovant l'Ãºs del departament:", checkError); return { error: "No s'ha pogut verificar si el departament estÃ  en Ãºs." }; }
     if (count !== null && count > 0) { return { error: `No es pot eliminar. El departament estÃ  assignat a ${count} tasca(ques). Desassigna'l primer.` }; }
     const { error } = await supabase.from('departments').delete().eq('id', departmentId);
     if (error) { console.error("Error eliminant departament de Supabase:", error); return { error: `Error de base de dades: ${error.message}` }; }
     console.log(`Departament ID: ${departmentId} eliminat correctament.`);
     revalidatePath('/[locale]/(app)/dashboard', 'layout');
     revalidatePath('/[locale]/(app)/crm/calendari', 'layout');
     return { success: true };
}

// =================== FILE: src/app/actions/invitationActions.ts ===================

"use server";

import { redirect } from "next/navigation";
import { createClient, createAdminClient } from "@/lib/supabase/server";

export async function resolveInvitationAction(token: string) {
  if (!token) {
    return redirect('/login?message=Token d\'invitaciÃ³ invÃ lid.');
  }

  const supabaseAdmin = createAdminClient();
  const { data: invitation } = await supabaseAdmin.from('invitations').select('email').eq('token', token).single();
  if (!invitation) {
    return redirect('/login?message=La teva invitaciÃ³ Ã©s invÃ lida o ha caducat.');
  }

  // âœ… CORRECCIÃ“: Obtenim la llista completa i la filtrem a la memÃ²ria.
  const { data: { users }, error: listError } = await supabaseAdmin.auth.admin.listUsers();
  if (listError) {
    console.error("Error en obtenir la llista d'usuaris:", listError);
    return redirect('/login?message=Hi ha hagut un error al servidor.');
  }

  const existingUser = users.find(u => u.email === invitation.email);

  if (existingUser) {
    redirect(`/login?invite_token=${token}&email=${encodeURIComponent(invitation.email)}`);
  } else {
    redirect(`/invitation/accept?invite_token=${token}&email=${encodeURIComponent(invitation.email)}`);
  }
}

export async function acceptInviteAction(token: string) {
  const supabase = createClient();
  const supabaseAdmin = createAdminClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    return redirect(`/login?invite_token=${token}&message=Has d'iniciar sessiÃ³ per acceptar.`);
  }

  try {
    const { data: invitation } = await supabase.from('invitations').select('*').eq('token', token).single().throwOnError();
    if (invitation.email !== user.email) {
      throw new Error("Aquesta invitaciÃ³ estÃ  destinada a un altre usuari.");
    }

    await supabase.from('team_members').insert({ 
      team_id: invitation.team_id ?? '', 
      user_id: user.id, 
      role: invitation.role 
    }).throwOnError();
    
    const { data: subscription } = await supabase.from('subscriptions').select('plan_id, status').eq('team_id', invitation.team_id ?? '').single();
    const teamPlan = (subscription?.status === 'active') ? subscription.plan_id : 'free';

    await supabaseAdmin.auth.admin.updateUserById(
        user.id,
        {
            app_metadata: {
                ...user.app_metadata,
                active_team_id: invitation.team_id,
                active_team_plan: teamPlan
            }
        }
    );
    await supabase.auth.refreshSession();
    await supabase.from('invitations').delete().eq('id', invitation.id);
  } catch (error) {
    if (error instanceof Error && error.message.includes('duplicate key value')) {
        console.log("L'usuari ja era membre, procedint a actualitzar el seu token...");
    } else {
        const message = error instanceof Error ? error.message : "Error en processar la invitaciÃ³.";
        return redirect(`/dashboard?message=${encodeURIComponent(message)}`);
    }
  }

  redirect('/settings/team');
}



// =================== FILE: src/app/actions/localeActions.ts ===================

// src/app/actions/localeActions.ts
// Aquest fitxer s'executarÃ  exclusivament al servidor
'use server';

import { cookies } from 'next/headers';
// âŒ Eliminem la importaciÃ³ innecessÃ ria de NextResponse.
// âŒ Eliminem la importaciÃ³ incorrecta de Locale de '@/types/shared/index'.

// âœ… Importem directament les llistes i el defaultLocale des de la font canÃ²nica.
import { locales, defaultLocale } from '@/i18n'; 

// ğŸš€ Constant per al nom de la Cookie de persistÃ¨ncia (Ha de coincidir amb el middleware)
const LOCALE_COOKIE_NAME = 'NEXT_LOCALE';

// ğŸ”‘ CLAU: Determinar si estem en un entorn segur (HTTPS)
const isProduction = process.env.NODE_ENV === 'production';

// Definim un tipus d'uniÃ³ per als nostres idiomes basat en l'array de i18n
type AppLocale = typeof locales[number];

/**
 * Estableix la cookie de preferÃ¨ncia d'idioma de forma explÃ­cita amb mÃ xim temps de vida.
 * Aquesta acciÃ³ garanteix el maxAge i la configuraciÃ³ secure/httpOnly correcte.
 * @param locale - L'idioma a establir (ha de ser un string, ja que ve del client).
 */
export async function setLocalePersistence(locale: string) {
  
  // 1. ValidaciÃ³ segura sense 'any'
  const finalLocale: AppLocale = locales.includes(locale as AppLocale) 
    ? (locale as AppLocale) 
    : defaultLocale;
  
  // 2. Fixar la cookie
  // Utilitzem next/headers/cookies().set per fixar la cookie des del servidor.
  (await
        // 2. Fixar la cookie
        // Utilitzem next/headers/cookies().set per fixar la cookie des del servidor.
        cookies()).set(LOCALE_COOKIE_NAME, finalLocale, {
    maxAge: 60 * 60 * 24 * 365, // 1 any
    httpOnly: false, // Permetem que el client (o el middleware) la llegeixi si cal.
    secure: isProduction, // Condicional per a Localhost vs ProducciÃ³
    path: '/', // Disponible a tota l'aplicaciÃ³
    sameSite: 'lax',
  });
  
  return { success: true, locale: finalLocale };
}

// =================== FILE: src/app/actions/tasks/actions.ts ===================

// src/app/actions/tasks/actions.ts (COMPLET I CORREGIT)

"use server";

import { revalidatePath } from 'next/cache';
import { z } from 'zod';
import { validateUserSession } from '@/lib/supabase/session';
import { Tables, Json } from '@/types/supabase';
import { JSONContent } from '@tiptap/react';
import { getValidGoogleCalendarToken } from "@/lib/google/google-api"; // âœ… NOU: Importem el gestor de tokens
import type { ActionResult } from '@/types/shared';

type FormState = {
  error?: {
    form?: string;
    db?: string;
    title?: string[];
    description?: string[];
    due_date?: string[];
    priority?: string[];
    user_asign_id?: string[];
    contact_id?: string[];
    department_id?: string[];
    duration?: string[];
    description_json?: string[];
  };
  success?: boolean;
};

interface ChecklistProgress {
  total: number;
  completed: number;
}

const taskSchema = z.object({
  title: z.string().min(1, "El tÃ­tol Ã©s obligatori."),
  description: z.string().nullable().optional(),
  due_date: z.string().datetime(
    "La data de venciment ha de ser una data vÃ lida.",
  ),
  priority: z.enum(["Baixa", "Mitjana", "Alta"]),
  user_asign_id: z.string().uuid().nullable().optional(),
  contact_id: z.coerce.number().nullable().optional(),
  department_id: z.coerce.number().nullable().optional(),
  duration: z.coerce.number().positive(
    "La duraciÃ³ ha de ser un nÃºmero positiu.",
  ).optional().nullable(),
});

const processFormData = (formData: FormData) => {
  let userId = formData.get("user_asign_id");
  if (userId === "none") userId = null;

  let contactId = formData.get("contact_id");
  if (contactId === "none") contactId = null;

  let departmentId = formData.get("department_id");
  if (departmentId === "none") departmentId = null;

  const duration = formData.get("duration");
  const dueDateRaw = formData.get("due_date") as string | null;

  return {
    title: formData.get("title"),
    description: formData.get("description") || null,
    due_date: dueDateRaw ? new Date(dueDateRaw).toISOString() : null,
    priority: formData.get("priority"),
    user_asign_id: userId,
    contact_id: contactId ? parseInt(contactId as string, 10) : null,
    department_id: departmentId ? parseInt(departmentId as string, 10) : null,
    duration: duration ? parseFloat(duration as string) : null,
  };
};

function findTaskItems(
  node: JSONContent | undefined,
  items: { checked: boolean }[],
) {
  if (!node) return;
  if (node.type === "taskItem") {
    items.push({ checked: node.attrs?.checked === true });
  }
  if (node.content) {
    node.content.forEach((childNode) => findTaskItems(childNode, items));
  }
}

function calculateChecklistProgress(
  jsonContent: JSONContent | null,
): ChecklistProgress {
  const result: ChecklistProgress = { total: 0, completed: 0 };
  if (!jsonContent?.content) {
    return result;
  }
  const taskItems: { checked: boolean }[] = [];
  jsonContent.content.forEach((node) => findTaskItems(node, taskItems));
  result.total = taskItems.length;
  result.completed = taskItems.filter((item) => item.checked).length;
  return result;
}

export async function createTask(
  prevState: FormState,
  formData: FormData,
): Promise<FormState> {
  const session = await validateUserSession();
  if ("error" in session) return { error: { form: session.error.message } };
  const { supabase, activeTeamId, user } = session;

  const parsedData = processFormData(formData);

  const validatedFields = taskSchema.safeParse(parsedData);
  if (!validatedFields.success) {
    return { error: validatedFields.error.flatten().fieldErrors };
  }

  let descriptionJson: JSONContent | null = null;
  let checklistProgress: ChecklistProgress = { total: 0, completed: 0 };
  try {
    const jsonString = formData.get("description_json")?.toString();
    if (jsonString && jsonString !== "null") {
      descriptionJson = JSON.parse(jsonString);
      checklistProgress = calculateChecklistProgress(descriptionJson);
    }
  } catch (e) {
    console.error("Error parsing description_json in createTask:", e);
    return {
      error: {
        description_json: [
          "El format del contingut de la descripciÃ³ Ã©s invÃ lid.",
        ],
      },
    };
  }

  const dataToInsert: Partial<Tables<"tasks">> = {
    ...validatedFields.data,
    team_id: activeTeamId,
    user_id: user.id,
    description_json: descriptionJson as Json,
    checklist_progress: checklistProgress as unknown as Json,
  };

  if (validatedFields.data.user_asign_id) {
    dataToInsert.asigned_date = new Date().toISOString();
  }

  const { error } = await supabase.from("tasks").insert(dataToInsert);

  if (error) return { error: { db: error.message } };

  revalidatePath("/[locale]/(app)/crm/calendari", "layout");
  revalidatePath("/[locale]/(app)/dashboard", "layout");
  return { success: true };
}

// âœ… FUNCIÃ“ CORREGIDA
export async function updateTask(
  prevState: FormState,
  formData: FormData,
): Promise<FormState> {
  console.log("--- [Server Action] La funciÃ³ 'updateTask' s'ha executat! ---");

  const session = await validateUserSession();
  if ("error" in session) return { error: { form: session.error.message } };
  const { supabase } = session;

  const taskId = Number(formData.get("taskId"));
  if (!taskId || isNaN(taskId)) {
    return { error: { form: "ID de la tasca no trobat o invÃ lid." } };
  }

  // âœ… PAS 1: Obtenim la tasca actual completa per preservar camps importants
  const { data: currentTask, error: fetchError } = await supabase
    .from("tasks")
    .select('*') // Demanem TOTES les dades per no perdre res
    .eq("id", taskId)
    .single(); // Usem single() per assegurar que existeix

  if (fetchError) {
    return {
      error: {
        db: `No s'ha pogut obtenir la tasca actual: ${fetchError.message}`,
      },
    };
  }

  const parsedData = processFormData(formData);
  const validatedFields = taskSchema.safeParse(parsedData);

  if (!validatedFields.success) {
    return { error: validatedFields.error.flatten().fieldErrors };
  }

  let descriptionJson: JSONContent | null = null;
  let checklistProgress: ChecklistProgress = { total: 0, completed: 0 };
  try {
    const jsonString = formData.get("description_json")?.toString();
    if (jsonString && jsonString !== "null") {
      descriptionJson = JSON.parse(jsonString);
      checklistProgress = calculateChecklistProgress(descriptionJson);
    }
  } catch (e) {
    console.error("Error parsing description_json in updateTask:", e);
    return {
      error: {
        description_json: [
          "El format del contingut de la descripciÃ³ Ã©s invÃ lid.",
        ],
      },
    };
  }
  
  // âœ… PAS 2: ConstruÃ¯m l'objecte d'actualitzaciÃ³ barrejant l'existent amb el nou
  const dataToUpdate: Partial<Tables<"tasks">> = {
    ...currentTask, // Preservem TOTS els camps existents
    ...validatedFields.data, // Sobreescrivim nomÃ©s els camps del formulari
    description_json: descriptionJson as Json,
    checklist_progress: checklistProgress as unknown as Json,
  };

  // LÃ²gica per actualitzar asigned_date (aquesta es mantÃ©)
  const newAssignedId = validatedFields.data.user_asign_id;
  const oldAssignedId = currentTask.user_asign_id;

  if (newAssignedId && newAssignedId !== oldAssignedId) {
    dataToUpdate.asigned_date = new Date().toISOString();
  } else if (!newAssignedId && oldAssignedId) {
    dataToUpdate.asigned_date = null;
  }
  
  const { error } = await supabase
    .from("tasks")
    .update(dataToUpdate)
    .eq("id", taskId);

  if (error) return { error: { db: error.message } };

  revalidatePath("/[locale]/(app)/crm/calendari", "layout");
  revalidatePath("/[locale]/(app)/dashboard", "layout");
  return { success: true };
}


export async function deleteTask(taskId: number): Promise<FormState> {
  const session = await validateUserSession();
  if ("error" in session) return { error: { db: session.error.message } };
  const { supabase } = session;

  const { error } = await supabase.from("tasks").delete().eq("id", taskId);

  if (error) return { error: { db: error.message } };

  revalidatePath("/[locale]/(app)/crm/calendari", "layout");
  revalidatePath("/[locale]/(app)/dashboard", "layout");
  return { success: true };
}


export async function updateSimpleTask(
  taskIdOrObject: number | { id: number },
  updatedData: Partial<Tables<"tasks">>,
) {
  const session = await validateUserSession();
  if ("error" in session) return { error: { db: session.error.message } };
  const { supabase } = session;

  const taskId = typeof taskIdOrObject === 'number' ? taskIdOrObject : taskIdOrObject.id;

  if (!taskId || typeof taskId !== 'number') {
    const errorMessage = "ID de tasca invÃ lid o no proporcionat a updateSimpleTask.";
    console.error(errorMessage, { received: taskIdOrObject });
    return { error: { db: errorMessage } };
  }

  const { error } = await supabase
    .from("tasks")
    .update(updatedData)
    .eq("id", taskId);

  if (error) {
    console.error("Error updating simple task:", error);
    return { error: { db: error.message } };
  }

  revalidatePath("/[locale]/(app)/crm/calendari", "layout");
  revalidatePath("/[locale]/(app)/dashboard", "layout");
  return { success: true };
}

export async function setTaskActiveStatus(taskId: number, newStatus: boolean) {
  const session = await validateUserSession();
  if ("error" in session) {
    return { error: { db: session.error.message } };
  }
  const { supabase } = session;

  const { error } = await supabase.rpc("log_task_activity", {
    task_id_input: taskId,
    new_status_input: newStatus,
  });

  if (error) {
    console.error("Error en RPC 'log_task_activity':", error);
    return { error: { db: error.message } };
  }

  revalidatePath("/[locale]/(app)/crm/calendari", "layout");
  revalidatePath("/[locale]/(app)/dashboard", "layout");

  return { success: true };
}

/**
 * Server Action per pujar una imatge associada a una tasca des de l'editor.
 */
type UploadSuccessData = {
    signedUrl: string;
    filePath: string;
};

// A 'src/app/actions/tasks/actions.ts'
// (Assegura't que 'validateUserSession' estigui importat al principi del fitxer)
// import { validateUserSession } from '@/lib/supabase/session';

export async function uploadTaskImageAction(formData: FormData): Promise<ActionResult<UploadSuccessData>> {
    
    // âœ… PAS 1: Fer servir la mateixa validaciÃ³ que 'createTask'
    const session = await validateUserSession();
    if ("error" in session) {
        console.error("[uploadTaskImageAction] Error validant sessiÃ³:", session.error.message);
        return { success: false, message: session.error.message };
    }
    // Ara tenim el client 'supabase', 'activeTeamId' i 'user' correctes
    const { supabase, activeTeamId, user } = session; 
    
    console.log("[uploadTaskImageAction] SessiÃ³ validada per:", user.id);
    console.log("[uploadTaskImageAction] Equip actiu:", activeTeamId);
    
    // --- LÃ²gica de Fitxer (Aquesta no canvia) ---
    console.log("[uploadTaskImageAction] Validant fitxer...");
    const file = formData.get('file') as File | null;
    if (!file) return { success: false, message: "No s'ha rebut cap fitxer." };
    if (file.size > 5 * 1024 * 1024) return { success: false, message: "Fitxer massa gran (mÃ x 5MB)." };
    if (!file.type.startsWith('image/')) return { success: false, message: "Format no permÃ¨s (nomÃ©s imatges)." };
    console.log("[uploadTaskImageAction] Fitxer vÃ lid:", file.name);

    const fileExt = file.name.split('.').pop() || 'tmp';
    const uniqueFileName = `${user.id}-${Date.now()}-${Math.random().toString(36).substring(2, 8)}.${fileExt}`;
    const filePath = `task-uploads/${activeTeamId}/${uniqueFileName}`;
    console.log("[uploadTaskImageAction] Path destÃ­:", filePath);

    // --- LÃ²gica de Pujada i URL Signada (Ara fem servir el client 'supabase' validat) ---
    try {
        console.log(`[uploadTaskImageAction] Iniciant pujada...`);
        // Fem servir el client 'supabase' obtingut de 'validateUserSession'
        const { data: uploadData, error: uploadError } = await supabase.storage
            .from('fitxers-privats') // Bucket privat
            .upload(filePath, file);

        if (uploadError) throw new Error(`Error en pujar: ${uploadError.message}`);
        console.log("[uploadTaskImageAction] Pujada OK:", uploadData.path);

        console.log("[uploadTaskImageAction] Generant URL signada...");
        const { data: signedUrlData, error: signedUrlError } = await supabase.storage
            .from('fitxers-privats')
            .createSignedUrl(filePath, 60 * 5); // 5 minuts validesa

        if (signedUrlError) throw new Error(`Error generant URL: ${signedUrlError.message}`);
        console.log("[uploadTaskImageAction] URL signada OK.");

        return {
            success: true,
            data: {
                signedUrl: signedUrlData.signedUrl,
                filePath: filePath
            }
        };

    } catch (error: unknown) {
        const message = error instanceof Error ? error.message : "Error desconegut processant imatge.";
        console.error("[uploadTaskImageAction] Error:", message, error);
        return { success: false, message: message };
    }
}
/**
 * Server Action per obtenir una URL signada i segura per a un fitxer privat.
 * Aquesta acciÃ³ s'ha de cridar CADA COP que el client necessiti
 * visualitzar la imatge (p.ex., des del component PrivateImage).
 * @param filePath El path complet del fitxer (p.ex., "task-uploads/team-123/file.jpg")
 * @returns Un objecte ActionResult amb la URL signada o un error.
 */
// A 'src/app/actions/tasks/actions.ts'

export async function getSignedUrlForFile(filePath: string): Promise<ActionResult<string>> {
    
    // âœ… PAS 1: Fer servir la mateixa validaciÃ³ que 'createTask'
    const session = await validateUserSession();
    if ("error" in session) {
        console.warn("[getSignedUrlForFile] Usuari no autenticat.");
        return { success: false, message: "SessiÃ³ invÃ lida." };
    }
    // Ara tenim el client 'supabase' validat
    const { supabase } = session;

    if (!filePath || typeof filePath !== 'string' || filePath.trim() === '') {
        return { success: false, message: "No s'ha proporcionat cap 'filePath' o Ã©s invÃ lid." };
    }

    // 3. Generar la URL signada
    const expiresIn = 60 * 60; // 1 hora
    
    console.log(`[getSignedUrlForFile] Generant URL per a: ${filePath}`);
    // Fem servir el client 'supabase' obtingut de 'validateUserSession'
    const { data, error } = await supabase.storage
        .from('fitxers-privats') // El teu bucket privat
        .createSignedUrl(filePath, expiresIn);

    if (error) {
        console.error(`[getSignedUrlForFile] Error generant URL per a ${filePath}:`, error);
        return { success: false, message: `No s'ha pogut obtenir la URL: ${error.message}` };
    }

    // 4. Retornar Ã¨xit
    return { success: true, data: data.signedUrl };
}


type SyncResult = {
  synced: boolean;
  googleCalendarId: string | null;
  message: string;
};

/**
 * Sincronitza UNA tasca (crea o actualitza) amb Google Calendar.
 */
async function syncTaskWithGoogle(
  task: Tables<"tasks">,
  accessToken: string,
): Promise<SyncResult> {

  // 1. Definir l'inici i el final de l'esdeveniment
  // Suposem que 'due_date' Ã©s l'hora de FINALITZACIÃ“
  const endDate = new Date(task.due_date as string);
  
  // Mirem si tenim durada. Si no, per defecte Ã©s 1 hora.
  const durationInMinutes = typeof task.duration === 'number' ? task.duration : 60;
  
  // Calculem l'inici restant-li la durada al final
  const startDate = new Date(endDate.getTime() - durationInMinutes * 60 * 1000);

  // 2. Construir el cos de l'esdeveniment
  const eventBody = {
    summary: task.title,
    description: task.description || "Tasca de Ribotflow",
    start: {
      dateTime: startDate.toISOString(),
      timeZone: "UTC", // O la timezone de l'usuari
    },
    end: {
      dateTime: endDate.toISOString(),
      timeZone: "UTC",
    },
    // Podem afegir un enllaÃ§ de tornada a l'app (opcional)
    // source: {
    //   title: "Obrir a Ribotflow",
    //   url: `https://ribotflow.com/tasks/${task.id}`
    // }
  };

  let url: string;
  let method: string;

  // 3. Decidir si CREEM (POST) o ACTUALITZEM (PATCH)
  if (task.google_calendar_id) {
    // Ja existeix, fem un UPDATE (PATCH)
    console.log(`Actualitzant tasca ${task.id} a Google Calendar...`);
    url = `https://www.googleapis.com/calendar/v3/calendars/primary/events/${task.google_calendar_id}`;
    method = "PATCH";
  } else {
    // Ã‰s nova, fem un CREATE (POST)
    console.log(`Creant tasca ${task.id} a Google Calendar...`);
    url = "https://www.googleapis.com/calendar/v3/calendars/primary/events";
    method = "POST";
  }

  // 4. Cridar a l'API de Google
  const response = await fetch(url, {
    method: method,
    headers: {
      "Authorization": `Bearer ${accessToken}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify(eventBody),
  });

  if (!response.ok) {
    const errorBody = await response.json();
    console.error(`Error de Google API [${method}] per a la tasca ${task.id}:`, errorBody);
    
    // Cas especial: Si intentem actualitzar un event que no existeix (404)
    if (response.status === 404 && task.google_calendar_id) {
      console.log("L'esdeveniment no existia a Google. ForÃ§ant nova creaciÃ³...");
      // Netegem l'ID vell i intentem crear-lo de nou (nomÃ©s 1 cop)
      const newTask = { ...task, google_calendar_id: null };
      return syncTaskWithGoogle(newTask, accessToken);
    }
    
    return {
      synced: false,
      googleCalendarId: task.google_calendar_id, // Retornem l'ID antic
      message: errorBody.error.message || "Error desconegut de Google API",
    };
  }

  // 5. Ãˆxit! Obtenim l'ID de Google i el retornem
  const googleEvent = await response.json();
  return {
    synced: true,
    googleCalendarId: googleEvent.id, // Aquest Ã©s el nou ID
    message: "Sincronitzat correctament.",
  };
}


/**
 * AcciÃ³ pÃºblica per ser cridada des del botÃ³ del client.
 * Sincronitza una tasca especÃ­fica amb Google Calendar.
 */
export async function syncTaskToGoogleAction(
  taskId: number,
): Promise<ActionResult> {
  const session = await validateUserSession();
  if ("error" in session) {
    return { success: false, message: "No autenticat" };
  }
  const { user, supabase } = session;

  try {
    // 1. Obtenim la tasca completa
    const { data: task, error: taskError } = await supabase
      .from("tasks")
      .select("*")
      .eq("id", taskId)
      .single();

    if (taskError) throw new Error(`No s'ha trobat la tasca amb ID ${taskId}`);

    // 2. Obtenim un token vÃ lid (la nostra funciÃ³ mÃ gica)
    // Passem l'ID de l'usuari que estÃ  fent l'acciÃ³
    const accessToken = await getValidGoogleCalendarToken(user.id);

    // 3. Cridem a la lÃ²gica de sincronitzaciÃ³
    const syncResult = await syncTaskWithGoogle(task, accessToken);

    if (!syncResult.synced) {
      throw new Error(syncResult.message);
    }

    // 4. Si ha anat bÃ©, actualitzem la nostra BD amb el nou google_calendar_id
    if (syncResult.googleCalendarId !== task.google_calendar_id) {
      const { error: updateError } = await supabase
        .from("tasks")
        .update({ google_calendar_id: syncResult.googleCalendarId })
        .eq("id", task.id);
      
      if (updateError) {
        // No Ã©s un error fatal, perÃ² l'hem de registrar
        console.error(`Error en desar el google_calendar_id per a la tasca ${task.id}:`, updateError);
      }
    }

    revalidatePath("/[locale]/(app)/crm/calendari", "layout");
    return { success: true, message: "Tasca sincronitzada amb Google Calendar!" };

  } catch (error: unknown) {
    const message = error instanceof Error ? error.message : "Error desconegut";
    console.error("[syncTaskToGoogleAction] Error:", message, error);
    return { success: false, message: message };
  }
}

// =================== FILE: src/app/api/chatbot/route.ts ===================

import { chatbotAction } from '../../actions/chatbotActions';

export async function POST(req: Request) {
  try {
    const { question } = await req.json();
    if (!question) {
      return new Response(JSON.stringify({ error: "La pregunta Ã©s obligatÃ²ria." }), { status: 400 });
    }

    const { data, error } = await chatbotAction(question);

    if (error) {
      return new Response(JSON.stringify({ error }), { status: 500 });
    }

    return new Response(JSON.stringify({ data }), { status: 200 });
  } catch (err) {
    const message = err instanceof Error ? err.message : "Error desconegut";
    return new Response(JSON.stringify({ error: message }), { status: 500 });
  }
}


// =================== FILE: src/app/api/oauth/callback/[provider]/route.ts ===================

import { createAdminClient, createClient } from "@/lib/supabase/server";
import { cookies } from "next/headers";
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";
// âœ… NOU: Importem la nostra nova funciÃ³ de xifratge rÃ pida
import { encryptToken } from "@/lib/utils/crypto";

export const dynamic = "force-dynamic";

// InterfÃ­cie base per a les dades.
// Nota: els tokens aquÃ­ NO van xifrats encara.
interface CredentialData {
  user_id: string;
  team_id: string; // Afegim team_id aquÃ­ per tenir-lo sempre
  provider: string;
  access_token: string; // Token en text pla de l'API
  refresh_token?: string | null; // Token en text pla de l'API
  expires_at: string | null;
  provider_user_id: string | null;
  provider_page_id?: string | null;
  provider_page_name?: string | null;
}

function decodeJwtPayload(token: string) {
  try {
    const payloadBase64 = token.split(".")[1];
    const base64 = payloadBase64.replace(/-/g, "+").replace(/_/g, "/");
    const decodedPayload = atob(base64);
    return JSON.parse(decodedPayload);
  } catch (e) {
    console.error("Error decodificant el JWT (id_token):", e);
    return null;
  }
}

type GoogleUserInfo = {
  id: string;
  email: string;
  verified_email: boolean;
};

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ provider: string }> },
) {
  const { provider } = await params;
  const url = new URL(request.url);
  const code = url.searchParams.get("code");
  const state = url.searchParams.get("state");

  const cookieStore = cookies();
  const savedState = (await cookieStore).get("oauth_state")?.value;
  (await cookieStore).delete("oauth_state");

  if (!code || !state || state !== savedState) {
    return NextResponse.redirect(
      new URL("/settings/integrations?error=auth_failed", request.url),
    );
  }

  const supabase = createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return NextResponse.redirect(new URL("/login", request.url));

  try {
    // âœ… NOU: Utilitzem el nom de variable consistent amb el worker
    const encryptionSecret = process.env.ENCRYPTION_SECRET_KEY;
    if (!encryptionSecret) {
      throw new Error("La clau d'encriptaciÃ³ (ENCRYPTION_SECRET_KEY) no estÃ  configurada al servidor.");
    }

    let tokenUrl = "";
    const body = new URLSearchParams();
    const redirectUri =
      `${process.env.NEXT_PUBLIC_SITE_URL}/api/oauth/callback/${provider}`;

    // ... (El teu switch(provider) per omplir 'body' i 'tokenUrl' es queda exactament igual)
    switch (provider) {
      case "google_gmail": 
      case "google_calendar": 
        tokenUrl = "https://oauth2.googleapis.com/token";
        body.append("client_id", process.env.GOOGLE_CLIENT_ID!);
        body.append("client_secret", process.env.GOOGLE_CLIENT_SECRET!);
        body.append("code", code);
        body.append("grant_type", "authorization_code");
        body.append("redirect_uri", redirectUri);
        break;
      case "linkedin":
        tokenUrl = "https://www.linkedin.com/oauth/v2/accessToken";
        body.append("grant_type", "authorization_code");
        body.append("code", code);
        body.append("redirect_uri", redirectUri);
        body.append("client_id", process.env.LINKEDIN_CLIENT_ID!);
        body.append(
          "client_secret",
          process.env.LINKEDIN_CLIENT_SECRET!,
        );
        break;
      case "microsoft":
        tokenUrl =
          "https://login.microsoftonline.com/common/oauth2/v2.0/token";
        body.append("client_id", process.env.AZURE_CLIENT_ID!);
        body.append("client_secret", process.env.AZURE_CLIENT_SECRET!);
        body.append(
          "scope",
          "openid email offline_access User.Read Mail.Read Mail.Send",
        );
        body.append("code", code);
        body.append("redirect_uri", redirectUri);
        body.append("grant_type", "authorization_code");
        break;
      case "facebook":
        tokenUrl =
          "https://graph.facebook.com/v19.0/oauth/access_token";
        body.append("client_id", process.env.FACEBOOK_CLIENT_ID!);
        body.append(
          "client_secret",
          process.env.FACEBOOK_CLIENT_SECRET!,
        );
        body.append("redirect_uri", redirectUri);
        body.append("code", code);
        break;
    }

    const tokenResponse = await fetch(tokenUrl, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body,
    });
    if (!tokenResponse.ok) {
      throw new Error(
        `Error en obtenir el token de ${provider}: ${await tokenResponse
          .text()}`,
      );
    }
    const tokens = await tokenResponse.json();

    // âœ… NOU: ReintroduÃ¯m les teves variables de control
    const isTeamIntegration = ["linkedin", "facebook", "instagram"]
      .includes(provider);
    const isPersonalIntegration = [
      "google_gmail",
      "google_calendar",
      "microsoft",
    ].includes(provider);
      
    const supabaseAdmin = createAdminClient();
    const activeTeamId = user.app_metadata?.active_team_id;

    if (!activeTeamId) {
      throw new Error(
        "S'ha de seleccionar un equip actiu abans de connectar una integraciÃ³.",
      );
    }

    // Preparem les dades base amb els tokens EN TEXT PLA
    const baseDataToUpsert: CredentialData = {
      user_id: user.id,
      team_id: activeTeamId,
      provider: provider,
      access_token: tokens.access_token,
      refresh_token: tokens.refresh_token || null,
      expires_at: tokens.expires_in
        ? new Date(Date.now() + (tokens.expires_in * 1000))
          .toISOString()
        : null,
      provider_user_id: null,
    };

    // Obtenim el 'provider_user_id' (email, etc.)
    if (provider === "google_gmail" || provider === "google_calendar") {
      const userInfoResponse = await fetch(
        "https://www.googleapis.com/oauth2/v2/userinfo",
        {
          headers: { Authorization: `Bearer ${tokens.access_token}` }, // Fem servir el token pla original
        },
      );
      if (!userInfoResponse.ok) {
        throw new Error("No s'ha pogut obtenir la info de l'usuari de Google.");
      }
      const userInfo: GoogleUserInfo = await userInfoResponse.json();
      baseDataToUpsert.provider_user_id = userInfo.email;
    } else if (provider === "microsoft" || provider === "linkedin") {
      baseDataToUpsert.provider_user_id = tokens.id_token
        ? decodeJwtPayload(tokens.id_token)?.sub
        : null;
    }

    // âœ… NOU: LÃ²gica de xifratge i desament separada
    
    // Xifrem els tokens ABANS de desar-los
    const encrypted_access_token = await encryptToken(
      baseDataToUpsert.access_token,
      encryptionSecret,
    );
    const encrypted_refresh_token = baseDataToUpsert.refresh_token
      ? await encryptToken(baseDataToUpsert.refresh_token, encryptionSecret)
      : null;

    if (isTeamIntegration) {
      // âœ… LÃ’GICA DE RRSS: Inserim a 'team_credentials'
      const { error: dbError } = await supabaseAdmin.from("team_credentials").upsert({
          team_id: baseDataToUpsert.team_id,
          provider: baseDataToUpsert.provider,
          access_token: encrypted_access_token,
          refresh_token: encrypted_refresh_token,
          expires_at: baseDataToUpsert.expires_at,
          // ... altres camps especÃ­fics de team_credentials
        }, { onConflict: 'team_id, provider' }); // Assegura't de la teva clau 'onConflict'

      if (dbError) throw dbError;
      console.log(`Credencials D'EQUIP (${provider}) desades (ENCRIPTADES amb Subtle) a l'equip ${activeTeamId}`);

    } else if (isPersonalIntegration) {
      // âœ… LÃ’GICA PERSONAL: Inserim a 'user_credentials'
      const { error: dbError } = await supabaseAdmin.from("user_credentials").upsert({
          user_id: baseDataToUpsert.user_id,
          team_id: baseDataToUpsert.team_id,
          provider: baseDataToUpsert.provider,
          access_token: encrypted_access_token,
          refresh_token: encrypted_refresh_token,
          expires_at: baseDataToUpsert.expires_at,
          provider_user_id: baseDataToUpsert.provider_user_id,
          config: null,
          encrypted_password: null,
        }, { onConflict: 'user_id, provider' }); // Assegura't de la teva clau 'onConflict'

      if (dbError) throw dbError;
      console.log(`Credencials PERSONALS (${provider}) desades (ENCRIPTADES amb Subtle) per a l'usuari ${user.id}`);
    }

  } catch (error) {
    console.error(`Error en el callback de ${provider}:`, error);
    const errorMessage = error instanceof Error
      ? error.message
      : "Unknown error";
    return NextResponse.redirect(
      new URL(
        `/settings/integrations?error=callback_failed&message=${encodeURIComponent(errorMessage)}`,
        request.url,
      ),
    );
  }

  return NextResponse.redirect(
    new URL("/settings/integrations?success=true", request.url),
  );
}

// =================== FILE: src/app/api/sync-imap/route.ts ===================

// src/app/api/sync-imap/route.ts

import { NextResponse } from 'next/server';
// Importem els tipus necessaris, incloent ListResponse i MessageAddressObject si estan disponibles
import { ImapFlow, FetchMessageObject, ListResponse, MessageAddressObject } from 'imapflow';
import { simpleParser, ParsedMail } from 'mailparser';
import AES from 'crypto-js/aes';
import Utf8 from 'crypto-js/enc-utf8';
import { Buffer } from 'buffer';

// --- InterfÃ­cies ---
interface NormalizedEmail { provider_message_id: string; subject: string; body: string; preview: string; sent_at: string; sender_name: string; sender_email: string; status: 'Llegit' | 'NoLlegit'; type: 'rebut' | 'enviat'; }

type ImapSearchCriteria = {
  all: boolean;
  since?: Date;
};

// FunciÃ³ auxiliar per trobar el nom real de la bÃºstia d'enviats amb imapflow
async function getSentBoxNameFlow(client: ImapFlow): Promise<string> {
  console.log('[API-IMAP-DEBUG] getSentBoxNameFlow: Cridant a client.list().');
  try {
    const mailboxes: ListResponse[] = await client.list(); // Tipem l'array
    console.log('[API-IMAP-DEBUG] getSentBoxNameFlow: BÃºsties obtingudes.');

    const commonNames = ['Sent', 'Sent Items', 'Enviats', '[Gmail]/Sent Mail'];

    for (const name of commonNames) {
      const found = mailboxes.find(box => box.name.toUpperCase() === name.toUpperCase());
      if (found) {
        console.log(`[API-IMAP-DEBUG] getSentBoxNameFlow: Trobada bÃºstia comuna: ${found.path}`);
        return found.path;
      }
    }

    // âœ… CORRECCIÃ“ 1: Comprovem 'flags' en lloc d''attributes'
    const sentBox = mailboxes.find(box => box.specialUse === '\\Sent' || box.flags?.has('\\Sent'));
    if (sentBox) {
      console.log(`[API-IMAP-DEBUG] getSentBoxNameFlow: Trobada bÃºstia amb flag \\Sent: ${sentBox.path}`);
      return sentBox.path;
    }

  } catch (listError: unknown) {
    console.error(`[API-IMAP-ERROR] getSentBoxNameFlow: Error obtenint llista de bÃºsties: ${(listError as Error).message}`);
  }

  console.warn('[API-IMAP-WARN] getSentBoxNameFlow: No s\'ha trobat cap bÃºstia d\'enviats especÃ­fica. Utilitzant "Sent" per defecte.');
  return 'Sent';
}


// FunciÃ³ principal per obtenir i processar correus amb imapflow
async function fetchEmailsFromMailboxFlow(
  client: ImapFlow,
  boxName: string,
  type: 'rebut' | 'enviat',
  lastSyncDate: string | null
): Promise<NormalizedEmail[]> {

  let lock;
  try {
    console.log(`[API-IMAP-FETCH] Intentant obrir bÃºstia '${boxName}'...`);
    lock = await client.getMailboxLock(boxName);
    console.log(`[API-IMAP-FETCH] BÃºstia '${boxName}' oberta i bloquejada.`);

    const searchCriteria: ImapSearchCriteria = { all: true };
    if (lastSyncDate) {
        const sinceDate = new Date(new Date(lastSyncDate).getTime() + 1000);
        searchCriteria.since = sinceDate;
    } else {
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        searchCriteria.since = sevenDaysAgo;
    }

    console.log(`[API-IMAP-FETCH] Criteris de cerca per a '${boxName}':`, searchCriteria);

    const messages: NormalizedEmail[] = [];
    interface FetchedMsg extends FetchMessageObject {
        source?: Buffer;
        // Tipem envelope de forma mÃ©s explÃ­cita si cal, basat en l'Ãºs
        envelope?: FetchMessageObject['envelope'] & {
            from?: (MessageAddressObject & { address?: string })[]; // Afegim 'address' opcional
        };
    }

    for await (const msg of client.fetch(searchCriteria, { uid: true, envelope: true, source: true }) as AsyncGenerator<FetchedMsg>) {
      try {
        console.log(`[API-IMAP-FETCH] Processant missatge UID ${msg.uid} de '${boxName}'`);

        if (!msg.source) {
          console.warn(`[API-IMAP-PARSE] Missatge ${msg.uid} a '${boxName}' descartat per falta de source.`);
          continue;
        }

        const parsed: ParsedMail = await simpleParser(msg.source);

        let body = parsed.html || parsed.textAsHtml || parsed.text || '';
        if (parsed.attachments) {
          for (const attachment of parsed.attachments) {
            if (attachment.cid && attachment.content) {
              const contentBuffer = Buffer.isBuffer(attachment.content)
                ? attachment.content
                : Buffer.from(attachment.content);
              const dataUri = `data:${attachment.contentType};base64,${contentBuffer.toString('base64')}`;
              const cidRegex = new RegExp(`cid:${attachment.cid}`, "g");
              body = body.replace(cidRegex, dataUri);
            }
          }
        }

        const fromHeader = parsed.from?.value[0];
        const envelopeFrom = msg.envelope?.from?.[0];

        const senderName = fromHeader?.name || envelopeFrom?.name || 'Desconegut';

        // âœ… CORRECCIÃ“ 2 & 3: Utilitzem 'address' de l'envelope si existeix
        const envelopeEmail = envelopeFrom?.address; // 'address' contÃ© l'email complet
        const senderEmail = (fromHeader?.address || envelopeEmail || 'unknown@domain.com').toLowerCase();

        messages.push({
          provider_message_id: msg.uid.toString(),
          subject: parsed.subject || msg.envelope?.subject || '(Sense assumpte)',
          body: body,
          preview: (parsed.text || body.replace(/<[^>]*>?/gm, " ").replace(/\s+/g, " ")).trim().substring(0, 150),
          sent_at: (msg.envelope?.date || parsed.date || new Date()).toISOString(),
          sender_name: senderName,
          sender_email: senderEmail,
          status: 'NoLlegit',
          type: type,
        });
      } catch (parseError: unknown) {
        console.error(`[API-IMAP-PARSE] Error parsejant el missatge UID ${msg.uid} a ${boxName}:`, (parseError as Error).message);
      }
    }

    console.log(`[API-IMAP-FETCH] Processats ${messages.length} missatges (desprÃ©s de parseig) de '${boxName}'.`);
    return messages;

  } catch (err: unknown) {
    const message = err instanceof Error ? err.message : String(err);
    console.warn(`[API SYNC-IMAP] Error a fetchEmailsFromMailboxFlow per a '${boxName}'. Missatge:`, message);
    if (message.toLowerCase().includes('mailbox does not exist') || message.toLowerCase().includes('no such mailbox')) {
         console.log(`[API-IMAP-FETCH] La bÃºstia '${boxName}' no existeix. Saltant...`);
         return [];
    }
    throw err;
  } finally {
    if (lock) {
      await lock.release();
      console.log(`[API-IMAP-FETCH] Bloqueig de la bÃºstia '${boxName}' alliberat.`);
    }
  }
}

// --- Handler POST principal (sense canvis) ---
export async function POST(request: Request) {
  // ... (codi igual que abans) ...
   console.log('[API-IMAP-INICI] PeticiÃ³ rebuda.');
  let client: ImapFlow | null = null;
  try {
    const functionsSecret = process.env.FUNCTIONS_SECRET;
    const authHeader = request.headers.get('Authorization');
    if (!functionsSecret || authHeader !== `Bearer ${functionsSecret}`) {
      console.error('[API-IMAP-ERROR] AutoritzaciÃ³ fallida.');
      return NextResponse.json({ error: "No autoritzat." }, { status: 401 });
    }
    const body = await request.json();
    const { config, encryptedPassword, lastSyncDate } = body;
    if (!config || !config.imap || !encryptedPassword) {
      return NextResponse.json({ error: "Falten credencials o configuraciÃ³ imap." }, { status: 400 });
    }
    const secretKey = process.env.ENCRYPTION_SECRET_KEY;
    if (!secretKey) {
      console.error("[API-IMAP-ERROR] ENCRYPTION_SECRET_KEY no configurada.");
      return NextResponse.json({ error: "Error de configuraciÃ³ del servidor." }, { status: 500 });
    }
    const decryptedPassword = AES.decrypt(encryptedPassword, secretKey).toString(Utf8);
    if (!decryptedPassword) {
      return NextResponse.json({ error: "No s'ha pogut desencriptar la contrasenya." }, { status: 500 });
    }

    client = new ImapFlow({ /* ...configuraciÃ³... */
        host: config.imap.host,
        port: config.imap.port,
        secure: config.imap.tls ?? true,
        auth: { user: config.imap.user, pass: decryptedPassword },
        logger: false,
        tls: { rejectUnauthorized: false },
        socketTimeout: 60000,
        connectionTimeout: 15000
    });

    console.log(`[API-IMAP-CONN] Intentant connectar (imapflow) a ${config.imap.host} per a l'usuari ${config.imap.user}`);
    await client.connect();
    console.log(`[API-IMAP-CONN] ConnexiÃ³ (imapflow) amb ${config.imap.host} establerta.`);

    const sentBoxName = await getSentBoxNameFlow(client);
    console.log(`[API-IMAP-FETCH] BÃºstia d'enviats detectada/assignada: '${sentBoxName}'`);

    console.log('[API-IMAP-FETCH] Obtenint correus de INBOX...');
    const inboxEmails = await fetchEmailsFromMailboxFlow(client, 'INBOX', 'rebut', lastSyncDate);
    console.log(`[API-IMAP-FETCH] Obtinguts ${inboxEmails.length} correus de INBOX.`);

    console.log(`[API-IMAP-FETCH] Obtenint correus de ${sentBoxName}...`);
    const sentEmails = await fetchEmailsFromMailboxFlow(client, sentBoxName, 'enviat', lastSyncDate);
    console.log(`[API-IMAP-FETCH] Obtinguts ${sentEmails.length} correus de ${sentBoxName}.`);

    console.log(`[API-IMAP-COMPLET] S'han trobat ${inboxEmails.length} a INBOX i ${sentEmails.length} a ${sentBoxName}.`);

    await client.logout();
    console.log('[API-IMAP-CONN] Desconnectat (logout) del servidor IMAP.');
    client = null;

    return NextResponse.json([...inboxEmails, ...sentEmails]);

  } catch (error: unknown) {
    const errorMessage = error instanceof Error ? error.message : "Error desconegut a l'API de sync-imap";
    console.error("[API SYNC-IMAP ERROR GENERAL]:", errorMessage);
    console.error("[API SYNC-IMAP ERROR OBJECT]:", error);

    if (client && client.usable) {
      try {
        console.log('[API-IMAP-CLEANUP] Intentant logout desprÃ©s d\'error...');
        await client.logout();
        console.log('[API-IMAP-CLEANUP] Logout amb Ã¨xit desprÃ©s d\'error.');
      } catch (logoutErr: unknown) {
        console.error("[API-IMAP-CLEANUP] Error durant el logout desprÃ©s d'un error:", (logoutErr as Error).message);
      }
    }
    client = null;

    return NextResponse.json({ error: errorMessage }, { status: 500 });
  }
}

// =================== FILE: src/app/globals.css ===================

@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

/* Aquestes sÃ³n les directives de Tailwind CSS. Injecten els estils base,
   els components i les utilitats de Tailwind al teu projecte. */
@tailwind base;
@tailwind components;
@tailwind utilities;

/* === COLORS I VARIABLES === */
@layer base {
  :root {
    --background: 220 20% 97%;
    --foreground: 220 15% 15%;
    --card: 0 0% 100%;
    --card-foreground: 220 15% 15%;
    --popover: 220 20% 95%;
    --popover-foreground: 220 15% 15%;
    /* âœ… --primary ja sembla ser el cian que volÃ­em (ajusta si cal) */
    --primary: 205 90% 65%;
    --primary-foreground: 0 0% 100%;
    --secondary: 220 15% 90%;
    --secondary-foreground: 220 15% 20%;
    --muted: 220 15% 92%;
    --muted-foreground: 220 10% 45%;
    --accent: 262 80% 95%; /* Aquest Ã©s un altre color d'accent, no el primari */
    --accent-foreground: 262 83% 50%; /* Text per a l'accent */
    --destructive: 0 84.2% 50%;
    --destructive-foreground: 0 0% 100%;
    --border: 220 15% 88%;
    --input: 220 15% 88%;
    /* --ring: 262 83% 58%; */ /* <-- Antic Lila (Comentat o eliminat) */
    --ring: 205 90% 65%;    /* <-- âœ… NOU: Cian (igual que el primari) */
    --radius: 0.75rem;
  }

  .dark {
    --background: 230 15% 8%;
    --foreground: 230 15% 92%;
    --card: 230 15% 10%;
    --card-foreground: 230 15% 95%;
    --popover: 230 15% 12%;
    --popover-foreground: 230 15% 90%;
    --primary: 205 90% 65%;
    --primary-foreground: 0 0% 100%;
    --secondary: 230 15% 18%;
    --secondary-foreground: 230 15% 80%;
    --muted: 230 15% 14%;
    --muted-foreground: 230 15% 60%;
    --accent: 262 70% 30%;
    --accent-foreground: 262 70% 95%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 0 0% 100%;
    --border: 230 15% 22%;
    --input: 230 15% 22%;
    --ring: 262 83% 58%;
  }

  html,
  body,
  #root {
    height: 100%;
    width: 100%;
    overflow-x: hidden;
  }
  
  * {
    @apply border-border scroll-smooth;
  }
  
  body {
    @apply bg-background text-foreground antialiased;
    font-family: 'Inter', sans-serif;
  }
}

/* === EFECTES I ESTILS PERSONALITZATS === */
@layer components {
  .glass-effect {
    @apply backdrop-blur-xl border border-black/10 rounded-xl bg-white/50;
  }
  .dark .glass-effect {
    @apply bg-white/5 border-white/10;
  }
}

.glass-effect {
  @apply backdrop-blur-xl border border-black/10 rounded-xl bg-white/5;
}
.dark .glass-effect {
  @apply bg-white/5 border-white/10;
}

.gradient-text {
  @apply bg-gradient-to-r from-purple-500 via-pink-500 to-blue-500 bg-clip-text text-transparent;
}

.futuristic-shadow {
  @apply shadow-[0_4px_30px_rgba(0,0,0,0.1)];
}
.mapbox-search-menu {
  z-index: 100 !important;
}
.card-hover {
  @apply transition-all duration-300 hover:scale-105 hover:shadow-[0_15px_30px_rgba(102,126,234,0.3)];
}

.sidebar-item {
  @apply flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 bg-white/5 hover:bg-white/10 cursor-pointer;
}
.sidebar-item.active {
  @apply bg-gradient-to-r from-purple-500 to-blue-500 text-white;
}

.metric-card {
  @apply glass-effect p-6 card-hover;
}

.contact-card {
  @apply glass-effect p-4 card-hover cursor-pointer;
}

.search-input {
  @apply glass-effect px-4 py-3 w-full text-white placeholder-gray-300 border-0 focus:ring-2 focus:ring-purple-500 focus:outline-none;
}

.empty-state {
  @apply flex flex-col items-center justify-center py-16 text-center text-muted-foreground;
}

.status-badge {
  @apply px-3 py-1 rounded-full text-xs font-semibold uppercase tracking-wide;
}
.status-c {
  @apply bg-green-500/10 text-green-400 border border-green-400/30;
}
.status-l {
  @apply bg-blue-500/10 text-blue-400 border border-blue-400/30;
}
.status-p {
  @apply bg-purple-500/10 text-purple-400 border border-purple-400/30;
}
.status-pending {
  @apply bg-yellow-500/10 text-yellow-400 border border-yellow-400/30;
}

@keyframes gradient-shift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.animate-gradient-shift {
  background-size: 200% auto;
  animation: gradient-shift 6s ease infinite;
}
.animate-gradient-slow {
  background-size: 400% 400%;
  animation: gradient-shift 8s ease infinite;
}

.feature-block.opacity-100 {
  opacity: 1;
}

.mapboxgl-popup-content {
  background-color: #2d3748;
  color: #edf2f7;
  border-radius: 8px;
  padding: 10px 15px;
}
.mapboxgl-popup-close-button {
  color: #edf2f7;
}

.floating-animation {
  animation: floating 6s ease-in-out infinite;
}

@keyframes floating {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-12px); }
}

.pulse-glow {
  animation: pulse-glow 2s ease-in-out infinite alternate;
}
@keyframes pulse-glow {
  from { box-shadow: 0 0 10px rgba(102, 126, 234, 0.4); }
  to { box-shadow: 0 0 25px rgba(102, 126, 234, 0.8); }
}

.filter-button {
  @apply px-4 py-2 rounded-lg transition-all duration-200 text-sm font-medium;
}
.filter-button.active {
  @apply bg-gradient-to-r from-purple-600 to-blue-500 text-white shadow-md;
}
.filter-button:not(.active) {
  @apply bg-white/10 text-gray-300 hover:bg-white/20;
}

/* === ESTILS PER A LLIBRERIES EXTERNES === */
.mapboxgl-popup-content {
  background-color: #1f2937;
  color: #ffffff;
  border-radius: 8px;
  padding: 8px 12px;
}

.mapboxgl-popup-tip {
  border-top-color: #1f2937 !important;
}

.mapboxgl-popup-close-button {
  color: #ffffff !important;
}

.popup-dark .mapboxgl-popup-content {
  background-color: #1f2937;
  color: #d1d5db;
  border-radius: 8px;
  padding: 12px;
  box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
  font-family: inherit;
}
.popup-dark .mapboxgl-popup-tip {
  border-top-color: #1f2937 !important;
}
.popup-dark .mapboxgl-popup-close-button {
  color: #9ca3af;
}
.popup-dark .mapboxgl-popup-close-button:hover {
  background-color: #374151;
}

.custom-scrollbar::-webkit-scrollbar {
  width: 8px;
}
.custom-scrollbar::-webkit-scrollbar-track {
  background: transparent;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
  background: #4b5563;
  border-radius: 4px;
}
.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: #6b7280;
}

input[type="range"].slider {
  -webkit-appearance: none;
  appearance: none;
  background: transparent;
  cursor: ew-resize;
}
input[type="range"].slider::-webkit-slider-runnable-track {
  background: hsl(var(--muted));
  height: 0.5rem;
  border-radius: 9999px;
}
input[type="range"].slider::-moz-range-track {
  background: hsl(var(--muted));
  height: 0.5rem;
  border-radius: 9999px;
}
input[type="range"].slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  background: hsl(var(--primary));
  height: 1rem;
  width: 1rem;
  border-radius: 50%;
  border: 2px solid hsl(var(--primary-foreground));
  margin-top: -0.25rem;
  transition: all 0.2s ease;
}
input[type="range"].slider::-moz-range-thumb {
  background: hsl(var(--primary));
  height: 1rem;
  width: 1rem;
  border-radius: 50%;
  border: 2px solid hsl(var(--primary-foreground));
  transition: all 0.2s ease;
}

.text-muted-strong {
  color: hsl(220, 10%, 35%);
}

@layer components {
  .prose-email {
    @apply break-words;
  }
  .prose-email a {
    @apply text-blue-500 hover:underline;
  }
  .prose-email p {
    @apply mb-4 leading-relaxed;
  }
  .prose-email blockquote {
    @apply border-l-4 border-border pl-4 italic text-muted-foreground;
  }
  .prose-email ul, .prose-email ol {
    @apply list-inside list-disc pl-4;
  }

  .prose-email img,
  .prose-email video,
  .prose-email iframe {
    @apply max-w-full h-auto rounded-md;
  }

  .prose-email table {
    @apply w-full table-fixed;
  }

  .prose-email pre {
    @apply whitespace-pre-wrap break-words;
  }
  /* ========================================================================= */
/* FORÃ‡AR EL TEMA CLAR DE REACT-BIG-CALENDAR (Requisit 1) */
/* Aplicar aquesta classe a l'embolcall del component Calendar */
/* ========================================================================= */
.rbc-calendar-force-light-theme {
  /* ForÃ§ar fons blanc i colors clars per defecte */
  background-color: white !important;
  color: #000 !important; /* Text fosc */
  border-radius: 8px; /* Opcional: per millorar la visualitzaciÃ³ */
  padding: 1rem;
}

.rbc-calendar-force-light-theme .rbc-header {
  color: #333 !important; /* Caps de setmana */
  border-bottom-color: #eee !important;
  background-color: #f8f8f8 !important; /* Fons del capÃ§alera */
}

.rbc-calendar-force-light-theme .rbc-day-bg {
  background-color: white !important;
}

.rbc-calendar-force-light-theme .rbc-today {
  background-color: #e6f7ff !important; /* Color per al dia d'avui */
}

.rbc-calendar-force-light-theme .rbc-toolbar button {
  color: #333 !important;
  border-color: #ccc !important;
}

/* Fons de les celÂ·les per a vistes de mes/setmana */
.rbc-calendar-force-light-theme .rbc-row-segment, 
.rbc-calendar-force-light-theme .rbc-time-slot, 
.rbc-calendar-force-light-theme .rbc-time-view,
.rbc-calendar-force-light-theme .rbc-month-view,
.rbc-calendar-force-light-theme .rbc-agenda-view {
  background-color: white !important;
}

/* Sobreescriure qualsevol ombra o text fosc residual */
.rbc-calendar-force-light-theme .rbc-off-range-bg {
  background-color: #fafafa !important;
}

.rbc-calendar-force-light-theme .rbc-date-cell {
  color: #333 !important;
}

/* El text dels dies que no sÃ³n del mes */
.rbc-calendar-force-light-theme .rbc-off-range .rbc-date-cell {
  color: #999 !important;
}

.rbc-calendar-force-light-theme .rbc-rtl .rbc-btn-group,
.rbc-calendar-force-light-theme .rbc-btn-group {
    background-color: transparent !important;
}

/* Assegurem que el cos de la vista de temps estigui clar */
.rbc-calendar-force-light-theme .rbc-time-view-resources .rbc-time-view-content {
    background-color: white !important;
}
.rbc-time-view .rbc-day-slot .rbc-events-container {
  display: flex;
  flex-direction: column;
  gap: 3px; /* Afegeix un petit espai vertical entre esdeveniments */
}
.rbc-time-view .rbc-event {
  position: relative !important;
  left: 0 !important;
  top: 0 !important;
  width: 100%;
}
.rbc-event {
  height: auto;
  min-height: 25px; /* Una alÃ§ada mÃ­nima per a esdeveniments curts */
}
/* Permetem que la celÂ·la de la franja horÃ ria creixi si el contingut la supera */
.rbc-day-slot .rbc-time-slot {
  flex-grow: 1;
}

}

/* === ESTILS PER A L'EDITOR TIPTAP === */
ul[data-type="taskList"] {
  list-style: none;
  padding: 0;
  padding-left: 1rem; 
}

ul[data-type="taskList"] li {
  display: flex;
  align-items: center; 
  margin-top: 0.5rem;
}

ul[data-type="taskList"] li > label {
  flex-shrink: 0;
  margin-right: 0.75rem;
  cursor: pointer;
  position: relative;
  width: 1rem;
  height: 1rem;
}

ul[data-type="taskList"] li > div {
  flex-grow: 1;
}

ul[data-type="taskList"] li::before {
  content: none;
}

/* âœ… NOU: Amaguem el checkbox original del navegador */
ul[data-type="taskList"] li input[type="checkbox"] {
  -webkit-appearance: none;
  appearance: none;
  background-color: transparent;
  margin: 0;
  font: inherit;
  width: 1rem;
  height: 1rem;
  border: 2px solid hsl(var(--border));
  border-radius: 0.25rem;
  transform: translateY(-0.075em);
  display: grid;
  place-content: center;
  transition: all 0.2s;
}

/* âœ… NOU: Creem el "check" de dins amb un pseudo-element */
ul[data-type="taskList"] li input[type="checkbox"]::before {
  content: "";
  width: 0.65em;
  height: 0.65em;
  transform: scale(0);
  transition: 120ms transform ease-in-out;
  box-shadow: inset 1em 1em hsl(var(--primary-foreground));
  background-color: CanvasText; /* Per a compatibilitat */
  -webkit-clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
  clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
}

/* âœ… NOU: Estil quan el checkbox estÃ  marcat */
ul[data-type="taskList"] li input[type="checkbox"]:checked {
  background-color: hsl(var(--primary));
  border-color: hsl(var(--primary));
}

ul[data-type="taskList"] li input[type="checkbox"]:checked::before {
  transform: scale(1);
}

ul[data-type="taskList"] li[data-checked="true"] > div > p {
  text-decoration: line-through;
  color: hsl(var(--muted-foreground));
}
/*
 * =========================================
 * SOLUCIÃ“ EDITOR TIPTAP (EditorWysiwyg) - v2 REFORÃ‡ADA
 * =========================================
 * AnulÂ·la el fons blanc ('background-color') que Tiptap
 * afegeix per defecte als nodes (parÃ grafs, tÃ­tols) quan
 * reben focus, especialment quan es fa servir 'prose dark:prose-invert'.
 */

/* * Regla principal: Forcem la transparÃ¨ncia per a qualsevol node
 * que Tiptap marqui com a enfocat dins de 'prose'.
 */
.prose .is-focused,
.prose .is-editor-focused {
    background-color: transparent !important;
    box-shadow: none !important;
    outline: none !important;
}

/* * Regla de reforÃ§ per al mode fosc (dark mode):
 * Si 'html' tÃ© la classe 'dark' (de next-themes),
 * apliquem la regla de forma encara mÃ©s especÃ­fica.
 */
html.dark .prose-invert .is-focused,
html.dark .prose-invert .is-editor-focused {
    background-color: transparent !important;
    box-shadow: none !important;
    outline: none !important;
}

/* * Assegurem que el focus del navegador (outline)
 * tampoc aparegui.
 */
.prose[contenteditable="true"]:focus,
.prose > *:focus-visible {
    background-color: transparent !important;
    box-shadow: none !important;
    outline: none !important;
}

// =================== FILE: src/app/layout.tsx ===================

/**
 * @file src/app/layout.tsx
 * @summary Layout raÃ­z que solo actÃºa como un contenedor vacÃ­o.
 * No debe renderizar etiquetas <html> o <body>.
 */
import './globals.css';
import { ReactNode } from 'react';

export default function RootLayout({ children }: { children: ReactNode }) {
  // Simplemente devuelve los hijos sin aÃ±adir ninguna etiqueta.
  // El layout de [locale] se encargarÃ¡ del <html> y <body>.
  return children;
}

// =================== FILE: src/app/page.tsx ===================

/**
 * @file src/app/page.tsx (Root Page)
 * @summary Aquesta pÃ gina no renderitza res. El middleware s'activa abans.
 */
export default function RootPage() {
  return null;
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/actions.ts ===================

// src/app/[locale]/(app)/comunicacio/inbox/actions.ts
"use server";

import { revalidatePath } from "next/cache";
import { validateUserSession } from "@/lib/supabase/session";
import { getActiveTeam } from "@/lib/supabase/teams";
import type { EnrichedTicket, TicketFilter, TicketForSupplier } from '@/types/db';

// âœ… 1. Importem TOT el nostre servei
import * as inboxService from "@/lib/services/comunicacio/inbox.service";
import type { NetworkContactData } from "@/lib/services/comunicacio/inbox.service";

// --- Tipus d'AcciÃ³ EstÃ ndard ---
interface ActionResult {
Â  success: boolean;
Â  message?: string;
}

// --- Accions Refactoritzades ---

/**
Â * ACCIÃ“: Retorna el cos d'un tiquet.
Â * (AcciÃ³ de lectura, no retorna ActionResult)
Â */
export async function getTicketBodyAction(ticketId: number): Promise<{ body: string }> {
Â  const session = await validateUserSession();
Â  if ('error' in session) return { body: `<p>Error: ${session.error.message}</p>` };
Â  const { supabase } = session;

Â  try {
    // 2. Cridem al servei
Â  Â  const body = await inboxService.getTicketBody(supabase, ticketId);
Â  Â  return { body };
Â  } catch (error: unknown) {
Â  Â  console.error("Error en getTicketBodyAction:", (error as Error).message);
Â  Â  return { body: "<p>Error carregant el cos del tiquet.</p>" };
Â  }
}

/**
Â * ACCIÃ“: Elimina un tiquet.
Â */
export async function deleteTicketAction(ticketId: number): Promise<ActionResult> {
Â  // 1. Validar SessiÃ³
Â  const session = await validateUserSession();
Â  if ('error' in session) return { success: false, message: session.error.message };
Â  const { supabase } = session;

Â  try {
Â  Â  // 2. Cridar al SERVEI
Â  Â  await inboxService.deleteTicket(supabase, ticketId);

Â  Â  // 3. Gestionar Infraestructura
Â  Â  revalidatePath("/comunicacio/inbox");
Â  Â  return { success: true, message: "Tiquet eliminat." };

Â  } catch (error: unknown) {
Â  Â  // 4. Gestionar errors del servei
Â  Â  return { success: false, message: (error as Error).message };
Â  }
}

/**
Â * ACCIÃ“: Marca un tiquet com a llegit.
Â */
export async function markTicketAsReadAction(ticketId: number): Promise<ActionResult> {
Â  const session = await validateUserSession();
Â  if ('error' in session) return { success: false, message: session.error.message };
Â  const { supabase} = session;

Â  try {
Â  Â  await inboxService.markTicketAsRead(supabase, ticketId);
Â  Â  revalidatePath("/comunicacio/inbox", 'page');
Â  Â  return { success: true };
Â  } catch (error: unknown) {
Â  Â  return { success: false, message: (error as Error).message };
Â  }
}

/**
Â * ACCIÃ“: sendEmailAction
Â */
interface SendEmailParams {
Â  contactId: number;
Â  subject: string;
Â  htmlBody: string;
Â  isReply: boolean;
}

export async function sendEmailAction({
Â  contactId,
Â  subject,
Â  htmlBody,
Â  isReply,
}: SendEmailParams): Promise<ActionResult> {
Â  // 1. Validar SessiÃ³
Â  const session = await validateUserSession();
Â  if ('error' in session) return { success: false, message: session.error.message };
Â  const { supabase, user, activeTeamId } = session;

Â  try {
Â  Â  // 2. Cridar al SERVEI
Â  Â  await inboxService.sendEmail({
Â  Â  Â  supabase,
Â  Â  Â  contactId,
Â  Â  Â  subject,
Â  Â  Â  htmlBody,
Â  Â  Â  isReply,
Â  Â  Â  userId: user.id,
Â  Â  Â  teamId: activeTeamId,
Â  Â  });

Â  Â  // 3. Gestionar Infraestructura
Â  Â  revalidatePath("/comunicacio/inbox");
Â  Â  return { success: true, message: "Correu enviat correctament." };

Â  } catch (error: unknown) {
Â  Â  // 4. Gestionar errors
Â  Â  const message = error instanceof Error ? error.message : "Error desconegut";
Â  Â  console.error("Error en sendEmailAction:", message);
Â  Â  return { success: false, message };
Â  }
}

/**
Â * ACCIÃ“: Assigna un tiquet a un tracte (opportunity).
Â */
export async function assignTicketAction(ticketId: number, dealId: number): Promise<ActionResult> {
Â  const session = await validateUserSession();
Â  if ('error' in session) return { success: false, message: session.error.message };
Â  const { supabase, activeTeamId } = session;

Â  try {
Â  Â  await inboxService.assignTicket(supabase, ticketId, dealId, activeTeamId);
Â  Â  revalidatePath("/comunicacio/inbox");
Â  Â  return { success: true, message: "Tiquet assignat." };
Â  } catch (error: unknown) {
Â  Â  console.error("Error en assignar el tiquet (action):", error);
Â  Â  return { success: false, message: (error as Error).message };
Â  }
}

/**
Â * ACCIÃ“: Carrega mÃ©s tiquets de forma paginada.
Â * (AcciÃ³ de lectura)
Â */
export async function loadMoreTicketsAction(page: number, filter: TicketFilter, inboxOwnerId: string): Promise<EnrichedTicket[]> {
Â  Â  const session = await validateUserSession();
Â  Â  if ('error' in session) return [];
Â  Â  const { supabase, user, activeTeamId } = session;

Â  Â  try {
Â  Â  Â  Â  return await inboxService.loadMoreTickets(
Â  Â  Â  Â  Â  Â  supabase,
Â  Â  Â  Â  Â  Â  page,
Â  Â  Â  Â  Â  Â  filter,
Â  Â  Â  Â  Â  Â  inboxOwnerId,
Â  Â  Â  Â  Â  Â  user.id,
Â  Â  Â  Â  Â  Â  activeTeamId
Â  Â  Â  Â  );
Â  Â  } catch (error: unknown) {
Â  Â  Â  Â  console.error("Error loading more tickets (action):", error);
Â  Â  Â  Â  return [];
Â  Â  }
}

/**
Â * ACCIÃ“: Afegeix un email a la llista negra.
Â */
export async function addToBlacklistAction(emailToBlock: string): Promise<ActionResult> {
Â  const session = await validateUserSession();
Â  if ('error' in session) return { success: false, message: session.error.message };
Â  const { supabase, user, activeTeamId } = session;

Â  try {
Â  Â  await inboxService.addToBlacklist(supabase, emailToBlock, user.id, activeTeamId);
Â  Â  revalidatePath("/comunicacio/inbox");
Â  Â  return { success: true, message: `${emailToBlock} ha estat afegit a la llista negra.` };

Â  } catch (error) {
Â  Â  // âœ… Gestionem l'error de clau duplicada
Â  Â  if (error instanceof Error && (error.message.includes('duplicate key') || error.message.includes('23505'))) {
Â  Â  Â  return { success: false, message: "Aquest correu ja Ã©s a la llista negra." };
Â  Â  }
Â  Â  console.error("Error afegint a la blacklist (action):", error);
Â  Â  const message = error instanceof Error ? error.message : "Error desconegut.";
Â  Â  return { success: false, message };
Â  }
}

/**
Â * ACCIÃ“: Vincula tots els tiquets d'un remitent a un contacte existent.
Â */
export async function linkTicketsToContactAction(contactId: number, senderEmail: string): Promise<ActionResult> {
Â  const session = await validateUserSession();
Â  if ('error' in session) return { success: false, message: session.error.message };
Â  const { supabase, user } = session;

Â  try {
Â  Â  await inboxService.linkTicketsToContact(supabase, contactId, senderEmail, user.id);
Â  Â  revalidatePath("/comunicacio/inbox");
Â  Â  return { success: true, message: "Contacte vinculat correctament." };
Â  } catch (error: unknown) {
Â  Â  const message = error instanceof Error ? error.message : "Error desconegut al vincular tiquets.";
Â  Â  return { success: false, message };
Â  }
}

/**
Â * ACCIÃ“: Carrega tiquets de forma paginada o per cerca.
Â * (AcciÃ³ de lectura)
Â */
export async function getTicketsAction(
Â  page: number, 
Â  filter: TicketFilter, 
Â  inboxOwnerId: string,
Â  searchTerm: string = ''
): Promise<EnrichedTicket[]> {
Â  const session = await validateUserSession();
Â  if ('error' in session) return [];
Â  const { supabase, user, activeTeamId } = session;

Â  try {
Â  Â  return await inboxService.getTickets(
Â  Â  Â  supabase,
Â  Â  Â  page,
Â  Â  Â  filter,
Â  Â  Â  inboxOwnerId,
Â  Â  Â  searchTerm,
Â  Â  Â  user.id,
Â  Â  Â  activeTeamId
Â  Â  );
Â  } catch (error: unknown) {
Â  Â  console.error("Error a getTicketsAction (action):", error);
Â  Â  return [];
Â  }
}

/**
Â * ACCIÃ“: Carrega un tiquet especÃ­fic pel seu ID.
Â * (AcciÃ³ de lectura, retorna format de dades/error per al client)
Â */
export async function getTicketByIdAction(ticketId: number): Promise<{ data: EnrichedTicket | null, error: string | null }> {
Â  try {
Â  Â  const session = await validateUserSession();
Â  Â  if ('error' in session) throw new Error(session.error.message);
Â  Â  const { supabase, user, activeTeamId } = session;
Â  Â  if (!user) throw new Error('User not authenticated');

Â  Â  const ticket = await inboxService.getTicketById(supabase, ticketId, user.id, activeTeamId);
Â  Â  
Â  Â  if (!ticket) {
Â  Â  Â  return { data: null, error: "No s'ha pogut trobar el correu (accÃ©s denegat o no existeix)." };
Â  Â  }
Â  Â  return { data: ticket, error: null };

Â  } catch (err: unknown) {
Â  Â  console.error('Error in getTicketByIdAction (action):', err);
Â  Â  const errorMessage = err instanceof Error ? err.message : String(err);
Â  Â  return { data: null, error: `Error intern en carregar el tiquet: ${errorMessage}` };
Â  }
}

/**
Â * ACCIÃ“: ObtÃ© els tickets dels contactes associats a un proveÃ¯dor.
Â * (AcciÃ³ de lectura)
Â */
export async function fetchTicketsForSupplierContacts(supplierId: string): Promise<TicketForSupplier[]> {
Â  const session = await validateUserSession();
Â  if ("error" in session) return [];
Â  const { supabase, activeTeamId } = session;

Â  try {
Â  Â  const tickets = await inboxService.fetchTicketsForSupplierContacts(supabase, supplierId, activeTeamId);
Â  Â  // Fem un 'cast' per assegurar que les dades retornades compleixen amb la nostra interface.
Â  Â  return (tickets as TicketForSupplier[]) || [];
Â  } catch (error: unknown) {
Â  Â  console.error("Error fetching tickets for supplier contacts (action):", error);
Â  Â  return [];
Â  }
}

/**
Â * ACCIÃ“: Elimina mÃºltiples tiquets alhora.
Â */
export async function deleteMultipleTicketsAction(ticketIds: number[]): Promise<ActionResult> {
Â  const session = await validateUserSession();
Â  if ('error' in session) {
Â  Â  return { success: false, message: session.error.message };
Â  }
Â  const { supabase} = session;

Â  try {
Â  Â  await inboxService.deleteMultipleTickets(supabase, ticketIds);
Â  Â  revalidatePath("/comunicacio/inbox");
Â  Â  return { success: true, message: "Tiquets eliminats." };
Â  } catch (error: unknown) {
Â  Â  console.error("Error en l'esborrat mÃºltiple (action):", error);
Â  Â  return { success: false, message: (error as Error).message };
Â  }
}

/**
Â * ACCIÃ“: Prepara les dades per a un nou missatge de Network.
Â * (AcciÃ³ mixta de lectura/escriptura, retorna dades o error)
Â */
export async function prepareNetworkContactAction(recipientTeamId: string, projectId: string): Promise<{
    success: boolean;
    data?: NetworkContactData;
    message?: string;
}> {
Â  Â  const session = await validateUserSession();
Â  Â  if ('error' in session) {
Â  Â  Â  Â  return { success: false, message: "AccÃ©s denegat." };
Â  Â  }
Â  Â  const { supabase, activeTeamId } = session;

Â  Â  // Obtenim l'equip actiu (necessari per al servei)
Â  Â  const activeTeam = await getActiveTeam(supabase, activeTeamId);
Â  Â  if (!activeTeam) {
Â  Â  Â  Â  return { success: false, message: "No s'ha trobat l'equip actiu." };
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  // 1. Cridem al servei
Â  Â  Â  Â  const { data, contactCreated } = await inboxService.prepareNetworkContact(
Â  Â  Â  Â  Â  Â  supabase,
Â  Â  Â  Â  Â  Â  recipientTeamId,
Â  Â  Â  Â  Â  Â  projectId,
Â  Â  Â  Â  Â  Â  activeTeam
Â  Â  Â  Â  );

Â  Â  Â  Â  // 2. Revalidem si s'ha creat un contacte
Â  Â  Â  Â  if (contactCreated) {
Â  Â  Â  Â  Â  Â  revalidatePath(`/${activeTeam.id}/crm/contacts`);
Â  Â  Â  Â  }

Â  Â  Â  Â  // 3. Retornem Ã¨xit amb les dades
Â  Â  Â  Â  return { success: true, data };

Â  Â  } catch (error: unknown) {
Â  Â  Â  Â  // 4. Gestionem errors del servei
Â  Â  Â  Â  const message = error instanceof Error ? error.message : "Error desconegut preparant el missatge.";
Â  Â  Â  Â  console.error("Error a prepareNetworkContactAction:", message);
Â  Â  Â  Â  return { success: false, message };
Â  Â  }
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/page.tsx ===================

/**
 * @file src/app/[locale]/(app)/comunicacio/inbox/page.tsx (VERSIÃ“ FINAL)
 */
import { Suspense } from 'react';
import type { Metadata } from 'next';
import { InboxData } from './_components/InboxData';
import { InboxSkeleton } from './_components/InboxSkeleton';

export const metadata: Metadata = {
  title: 'Bandeja de Entrada | Ribot',
};

// Aquesta pÃ gina ja no necessita cap prop. Ã‰s un component estÃ tic.
export default function InboxPage() {
  return (
    // Sense 'key' dinÃ mica. El client gestionarÃ  els canvis.
    <Suspense fallback={<InboxSkeleton />}>
      <InboxData />
    </Suspense>
  );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_components/ComposeDialog.tsx ===================

// src/app/[locale]/(app)/comunicacio/inbox/_components/ComposeDialog.tsx
"use client";

import React from 'react';
import { useTranslations } from 'next-intl';
import { EditorContent } from '@tiptap/react';
import { Loader2, Send, FileText, Variable, User, Mail, Search } from 'lucide-react';

// Components de UI
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from "@/components/ui/dialog";
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { EmailEditorToolbar } from './EmailEditorToolbar';

// Hook i Tipus
import { useCompose } from '../_hooks/useCompose';
// âœ¨ CANVI: Importem els tipus de la nostra Ãºnica font de la veritat.
import type { Contact, Template } from '@/types/db';

export type InitialData = {
  contactId?: string | null;
  to?: string | null;
  subject?: string | null;
  body?: string | null;
};

interface ComposeDialogProps {
  open: boolean;
  onOpenChange: (isOpen: boolean) => void;
  onEmailSent: () => void;
  initialData: InitialData | null;
  templates: Template[];
  contacts: Contact[];
}

export const ComposeDialog = (props: ComposeDialogProps) => {
  const { open, onOpenChange, onEmailSent, initialData, templates, contacts } = props;
  const t = useTranslations('InboxPage');

  const {
    editor, subject, setSubject,
    selectedContactId, setSelectedContactId,
    contactSearch, setContactSearch,
    selectedTemplate, handleTemplateSelect,
    variableValues, setVariableValues,
    finalHtmlBody, filteredContacts, isSending, handleSend,
  } = useCompose({
    templates,
    contacts,
    initialData,
    onClose: () => onOpenChange(false),
    onEmailSent,
  });

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-6xl h-[90vh] flex flex-col">
        <DialogHeader>
          <DialogTitle>{t('composeDialogTitle')}</DialogTitle>
          <DialogDescription>{t('composeDialogDescription')}</DialogDescription>
        </DialogHeader>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1 min-h-0">
          <div className="lg:col-span-2 flex flex-col gap-4 min-h-0">
            <div className="relative">
              <Mail className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
              <Input placeholder={t('subjectPlaceholder')} value={subject} onChange={e => setSubject(e.target.value)} className="pl-9" />
            </div>
            <div className="flex-1 flex flex-col gap-2 min-h-0">
              {!selectedTemplate && <EmailEditorToolbar editor={editor} />}
              {selectedTemplate ? (
                <div className="border rounded-md flex-1 bg-white">
                  <iframe srcDoc={finalHtmlBody} title={t('previewTitle')} className="w-full h-full border-0" />
                </div>
              ) : (
                <EditorContent editor={editor} className="flex-1 overflow-y-auto" />
              )}
            </div>
          </div>

          <div className="lg:col-span-1 flex flex-col gap-6 bg-muted/30 p-4 rounded-lg overflow-y-auto">
            <div className="space-y-2">
              <Label htmlFor="contact-select" className="flex items-center gap-2 font-semibold"><User className="w-4 h-4" />{t('recipientLabel')}</Label>
              <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
                <Input id="contact-search" placeholder={t('searchContactPlaceholder')} value={contactSearch} onChange={(e) => setContactSearch(e.target.value)} className="pl-9 mb-2" />
              </div>
              <Select onValueChange={(value) => setSelectedContactId(Number(value))} value={String(selectedContactId)}>
                <SelectTrigger id="contact-select"><SelectValue placeholder={t('selectContactPlaceholder')} /></SelectTrigger>
                <SelectContent>
                  {filteredContacts.length > 0 ? filteredContacts.map(contact => <SelectItem key={contact.id} value={String(contact.id)}>{contact.nom} ({contact.email})</SelectItem>) : <p className="p-4 text-sm text-muted-foreground">{t('noContactsFound')}</p>}
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
                <Label htmlFor="template-select" className="flex items-center gap-2 font-semibold"><FileText className="w-4 h-4" />{t('templateLabel')}</Label>
                <Select onValueChange={handleTemplateSelect} defaultValue="none" disabled={templates.length === 0}>
                    <SelectTrigger id="template-select"><SelectValue placeholder={t('selectTemplatePlaceholder')} /></SelectTrigger>
                    <SelectContent>
                        <SelectItem value="none">{t('noTemplateOption')}</SelectItem>
                        {templates.map(template => <SelectItem key={template.id} value={template.id.toString()}>{template.name}</SelectItem>)}
                    </SelectContent>
                </Select>
            </div>

            {selectedTemplate?.variables && Array.isArray(selectedTemplate.variables) && selectedTemplate.variables.length > 0 && (
                <div className="space-y-4">
                    <Label className="flex items-center gap-2 font-semibold"><Variable className="w-4 h-4 text-primary" />{t('variablesLabel')}</Label>
                    <div className="space-y-3">
                        {(selectedTemplate.variables as string[]).map(varName => (
                            <div key={varName} className="space-y-1.5">
                                <label htmlFor={`var-${varName}`} className="text-xs font-medium text-muted-foreground">{`{{${varName}}}`}</label>
                                <Input
                                    id={`var-${varName}`}
                                    value={variableValues[varName] || ''}
                                    onChange={e => setVariableValues(prev => ({ ...prev, [varName]: e.target.value }))}
                                    placeholder={t('variablePlaceholder', { varName })}
                                />
                            </div>
                        ))}
                    </div>
                </div>
            )}
          </div>
        </div>
        <DialogFooter className="pt-4 border-t">
          <Button variant="ghost" onClick={() => onOpenChange(false)}>{t('cancelButton')}</Button>
          <Button onClick={handleSend} disabled={isSending}>
            {isSending ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Send className="w-4 h-4 mr-2" />}
            {t('sendButton')}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
};

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_components/ContactPanel.tsx ===================

// src/app/[locale]/(app)/comunicacio/inbox/_components/ContactPanel.tsx
"use client";

import React, { useMemo, useTransition } from 'react';
import { Button } from '@/components/ui/button';
import { User, Building, UserPlus, Mail, Phone, MapPin, ExternalLink, Euro, Ban, Loader2 } from 'lucide-react';
import Link from 'next/link';
import { toast } from 'sonner';

import { useTranslations } from 'next-intl';
import { ContactDialog } from '@/app/[locale]/(app)/crm/contactes/_components/ContactDialog';
import { addToBlacklistAction } from '../actions';
import { type UsageCheckResult } from '@/lib/subscription/subscription';
// âœ¨ CANVI: Importem els tipus directament des de la nostra Ãºnica font de la veritat.
import type { Contact, EnrichedTicket } from '@/types/db';

interface ContactPanelProps {
    ticket: EnrichedTicket | null;
    isPendingSave: boolean;
    onSaveContact: (newlyCreatedContact: Contact, originalTicket: EnrichedTicket) => void;
    allTeamContacts: Contact[];
    limitStatus: UsageCheckResult; // âœ… 3. Afegim la nova prop
    
}

export const ContactPanel: React.FC<ContactPanelProps> = ({ ticket, isPendingSave, onSaveContact, allTeamContacts, limitStatus }) => {
    const [isPending, startTransition] = useTransition();
    const t = useTranslations('InboxPage');
   // âœ… 6. Calculem si s'ha assolit el lÃ­mit
    const isLimitReached = !limitStatus.allowed;
    console.log("ContactPanel: limitStatus =", limitStatus, "isLimitReached =", isLimitReached);
    // Simplifiquem la lÃ²gica per trobar el contacte a mostrar.
    const contactToShow: Contact | null = useMemo(() => {
        if (!ticket) return null;

        // Cas 1: El tiquet ja tÃ© un contact_id vinculat.
        // ConstruÃ¯m un objecte 'Contact' a partir de les dades planes de 'EnrichedTicket'.
        if (ticket.contact_id && ticket.contact_nom) {
            return {
                id: ticket.contact_id,
                nom: ticket.contact_nom,
                email: ticket.contact_email || '',
                // Afegim la resta de camps com a null o valors per defecte, ja que no els tenim a la vista.
                // AixÃ² Ã©s suficient per a la visualitzaciÃ³.
                empresa: null,
                telefon: null,
                ubicacio: null,
                valor: null,
                estat: null,
                created_at: null,
                address: null,
                birthday: null,
                children_count: null,
                hobbies: null,
                industry: null,
                job_title: null,
                last_interaction_at: null,
                lead_source: null,
                marital_status: null,
                notes: null,
                partner_name: null,
                social_media: null,
                team_id: null,
                ultim_contacte: null,
                user_id: null,
                supplier_id: null, // <-- Afegit per complir amb el tipus Contact
            };
        }

        // Cas 2: El tiquet no tÃ© contacte vinculat, busquem si existeix un contacte amb el mateix email.
        if (!ticket.sender_email) return null;
        const ticketEmail = ticket.sender_email.trim().toLowerCase();
        return allTeamContacts.find(c => c.email?.trim().toLowerCase() === ticketEmail) || null;

    }, [ticket, allTeamContacts]);

    const handleBlacklist = () => {
        if (!ticket || !ticket.sender_email) return;
        if (confirm(t('confirmBlacklist', { email: ticket.sender_email }))) {
            startTransition(async () => {
                const result = await addToBlacklistAction(ticket.sender_email!);
                toast[result.success ? 'success' : 'error'](result.message);
            });
        }
    };
    return (
        <div className="flex flex-col h-full border-l border-border bg-background/95">
            {!ticket ? (
                <div className="flex-1 flex flex-col items-center justify-center text-center p-4">
                    <User className="w-16 h-16 text-muted-foreground mb-4" />
                    <p className="text-muted-foreground">{t('selectConversationDescription')}</p>
                </div>
            ) : contactToShow ? (
                <>
                    <div className="p-4 border-b flex justify-between items-center flex-shrink-0">
                        <h2 className="text-xl font-bold">{t('contactDetailsTitle')}</h2>
                        <Button asChild variant="secondary" size="sm">
                            <Link href={`/crm/contactes/${contactToShow.id}`}>
                                {t('viewFullProfile')} <ExternalLink className="w-4 h-4 ml-2" />
                            </Link>
                        </Button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-6 space-y-4">
                        <div className="flex items-center gap-4">
                            <div className="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center">
                                <User className="w-8 h-8 text-primary" />
                            </div>
                            <div>
                                <h3 className="text-lg font-semibold">{contactToShow.nom}</h3>
                                {contactToShow.empresa && (
                                    <p className="text-sm text-muted-foreground flex items-center gap-1.5">
                                        <Building className="w-4 h-4" />{contactToShow.empresa}
                                    </p>
                                )}
                            </div>
                        </div>
                        <div className="space-y-3 text-sm pt-4">
                            <div className="flex items-center gap-3">
                                <Mail className="w-4 h-4 text-muted-foreground flex-shrink-0" />
                                <a href={`mailto:${contactToShow.email}`} className="hover:underline truncate">{contactToShow.email}</a>
                            </div>
                            <div className="flex items-center gap-3">
                                <Phone className="w-4 h-4 text-muted-foreground flex-shrink-0" />
                                <span>{contactToShow.telefon || t('notSpecified')}</span>
                            </div>
                            <div className="flex items-center gap-3">
                                <MapPin className="w-4 h-4 text-muted-foreground flex-shrink-0" />
                                <span>{contactToShow.ubicacio || t('notSpecified')}</span>
                            </div>
                            <div className="flex items-center gap-3">
                                <Euro className="w-4 h-4 text-muted-foreground flex-shrink-0" />
                                <span>{t('valueLabel')}: {contactToShow.valor ?? 0} â‚¬</span>
                            </div>
                            <div className="flex items-center gap-3">
                                <UserPlus className="w-4 h-4 text-muted-foreground flex-shrink-0" />
                                <span>{t('statusLabel')}: <span className="font-medium">{contactToShow.estat}</span></span>
                            </div>
                        </div>
                    </div>
                </>
            ) : (
                // --- VISTA QUAN EL CONTACTE NO EXISTEIX ---
                <div className="flex-1 flex flex-col items-center justify-center text-center p-4">
                    <User className="w-16 h-16 text-muted-foreground mb-4" />
                    <p className="font-semibold">{ticket.sender_name}</p>
                    <p className="text-sm text-muted-foreground mb-4">{ticket.sender_email}</p>
                    <ContactDialog
                        trigger={
                            <Button disabled={isPendingSave || isLimitReached}>
                                <UserPlus className="w-4 h-4 mr-2" />
                                {t('saveContactButton')}
                            </Button>
                        }
                        initialData={{
                            nom: ticket.sender_name,
                            email: ticket.sender_email
                        }}
                        // âœ… CORRECCIÃ“ 2: La lÃ²gica aquÃ­ ara Ã©s correcta, ja que 'onSaveContact' espera dos parÃ metres.
                        onContactSaved={(newContact) => onSaveContact(newContact as Contact, ticket)}
                    />
                </div>

            )}
            {ticket && (
                <div className="p-4 border-t mt-auto flex-shrink-0">
                    <Button
                        variant="destructive"
                        size="sm"
                        className="w-full"
                        onClick={handleBlacklist}
                        // âœ… CORRECCIÃ“ 2: Utilitzem 'isPending' per a desactivar el botÃ³
                        disabled={isPendingSave || isPending}
                    >
                        {isPending ? (
                            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                        ) : (
                            <Ban className="w-4 h-4 mr-2" />
                        )}
                        {isPending ? t('blocking') : t('addToBlacklist')}
                    </Button>
                </div>
            )}
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_components/EmailEditorToolbar.tsx ===================

// UbicaciÃ³: /app/(app)/comunicacio/inbox/_components/EmailEditorToolbar.tsx

"use client";

import { type Editor } from '@tiptap/react';
import { useTranslations } from 'next-intl';
import { Toggle } from '@/components/ui/toggle';
import { Bold, Italic, Strikethrough, List, ListOrdered, Heading2 } from 'lucide-react';

interface EmailEditorToolbarProps {
    editor: Editor | null;
}

export const EmailEditorToolbar = ({ editor }: EmailEditorToolbarProps) => {
    const t = useTranslations('InboxPage.editor');
    if (!editor) return null;

    return (
        <div className="border border-input bg-transparent rounded-md p-1 flex gap-1 flex-wrap">
            <Toggle size="sm" pressed={editor.isActive('bold')} onPressedChange={() => editor.chain().focus().toggleBold().run()} title={t('bold')}>
                <Bold className="h-4 w-4" />
            </Toggle>
            <Toggle size="sm" pressed={editor.isActive('italic')} onPressedChange={() => editor.chain().focus().toggleItalic().run()} title={t('italic')}>
                <Italic className="h-4 w-4" />
            </Toggle>
            <Toggle size="sm" pressed={editor.isActive('strike')} onPressedChange={() => editor.chain().focus().toggleStrike().run()} title={t('strike')}>
                <Strikethrough className="h-4 w-4" />
            </Toggle>
            <Toggle size="sm" pressed={editor.isActive('heading', { level: 2 })} onPressedChange={() => editor.chain().focus().toggleHeading({ level: 2 }).run()} title={t('heading')}>
                <Heading2 className="h-4 w-4" />
            </Toggle>
            <Toggle size="sm" pressed={editor.isActive('bulletList')} onPressedChange={() => editor.chain().focus().toggleBulletList().run()} title={t('bulletList')}>
                <List className="h-4 w-4" />
            </Toggle>
            <Toggle size="sm" pressed={editor.isActive('orderedList')} onPressedChange={() => editor.chain().focus().toggleOrderedList().run()} title={t('orderedList')}>
                <ListOrdered className="h-4 w-4" />
            </Toggle>
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_components/InboxClient.tsx ===================

// /app/[locale]/(app)/comunicacio/inbox/_components/InboxClient.tsx
"use client";

import React, { useEffect, useRef, useTransition } from 'react';
import { useSearchParams } from 'next/navigation';
import { AnimatePresence } from 'framer-motion';
import { useMediaQuery } from '@/hooks/useMediaQuery';
import { useTranslations } from 'next-intl';
import { useInbox } from '../_hooks/useInbox';
import type { User } from '@supabase/supabase-js';
import type { Contact, EnrichedTicket, InboxPermission, TeamMemberWithProfile, Template } from '@/types/db';

// Components
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from "@/components/ui/alert-dialog";
import { TicketList } from './ticketList/index';
import { TicketDetail } from './TicketDetail';
import { ContactPanel } from './ContactPanel';
import { ComposeDialog } from './ComposeDialog';
import { MobileDetailView } from './MobileDetailView';
import { type UsageCheckResult } from '@/lib/subscription/subscription';

import { prepareNetworkContactAction } from '../actions';
import { toast } from 'sonner'; // Importem toast

interface InboxClientProps {
  user: User;
  initialTickets: EnrichedTicket[];
  initialTemplates: Template[];
  initialReceivedCount: number;
  initialSentCount: number;
  teamMembers: TeamMemberWithProfile[];
  permissions: InboxPermission[];
  allTeamContacts: Contact[];
  limitStatus: UsageCheckResult;
}

export function InboxClient(props: InboxClientProps) {
  const t = useTranslations('InboxPage.toast');
  const isDesktop = useMediaQuery('(min-width: 1024px)');
  const searchParams = useSearchParams();
  // âœ… 1. Canviem el nom per a mÃ©s claredat i per utilitzar-lo
  const [isPreparingNetworkMessage, startPreparingTransition] = useTransition();
  const networkContactProcessed = useRef(false);

  const {
    selectedTicket, ticketToDelete, activeFilter, composeState, selectedTicketBody,
    isBodyLoading, hasMore, searchTerm, isPending, isContactPanelOpen, inboxFilter,
    counts, enrichedTickets,
    setTicketToDelete, setActiveFilter, setComposeState, setSearchTerm,
    setIsContactPanelOpen, setInboxFilter, handleSelectTicket, handleDeleteTicket,
    handleLoadMore, handleSaveContact, handleComposeNew, handleReply, handleRefresh, isSelectionMode,
    selectedTicketIds,
    onToggleSelectionMode,
    onToggleSelection,
    onDeleteSelected
  } = useInbox({
    ...props,
    initialUnreadCount: props.initialReceivedCount,
    t
  });

  // Efecte per llegir la URL
  useEffect(() => {
    if (networkContactProcessed.current) return;

    const recipientTeamId = searchParams.get('to');
    const projectId = searchParams.get('projectId');

    if (recipientTeamId && projectId) {
      networkContactProcessed.current = true;

      startPreparingTransition(async () => {
        // âœ… 2. Arreglem la lÃ²gica del TOAST
        const toastId = toast.loading(t('preparingMessage', { default: "Preparant missatge..." }));

        const result = await prepareNetworkContactAction(recipientTeamId, projectId);

        if (result.success) {
          toast.success(t('messageReady', { default: "Missatge a punt!" }), { id: toastId });
          setComposeState({
            open: true,
            initialData: result.data ?? null
          });
        } else {
          toast.error(t('errorPreparingMessage', { default: "Error preparant el missatge" }), {
            id: toastId,
            description: result.message
          });
        }
      });
    } else {
      networkContactProcessed.current = true;
    }
    // Assegurem que les traduccions sÃ³n estables o les traiem de les dependÃ¨ncies
  }, [searchParams, setComposeState, t]);


  return (
    <>
      <ComposeDialog
        open={composeState.open}
        onOpenChange={(isOpen) => setComposeState({ ...composeState, open: isOpen })}
        onEmailSent={handleRefresh}
        initialData={composeState.initialData}
        templates={props.initialTemplates}
        contacts={props.allTeamContacts}
      />

      <AlertDialog open={!!ticketToDelete} onOpenChange={() => setTicketToDelete(null)}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>{t("deleteConfirmTitle")}</AlertDialogTitle>
            <AlertDialogDescription>{t("deleteConfirmDescription")}</AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={isPending}>{t("cancelButton")}</AlertDialogCancel>
            <AlertDialogAction onClick={handleDeleteTicket} disabled={isPending}>{t("confirmDeleteButton")}</AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>

      <div
        className="h-[calc(100vh-var(--header-height,64px))] w-full grid transition-all duration-300 ease-in-out"
        style={{ gridTemplateColumns: isDesktop ? `384px 1fr minmax(0, ${isContactPanelOpen ? '320px' : '0px'})` : '1fr' }}
      >
        {(!isDesktop && selectedTicket) ? null : (
          <div className="min-h-0 flex flex-col h-full overflow-hidden">
            <TicketList
              user={props.user}
              teamMembers={props.teamMembers}
              permissions={props.permissions}
              tickets={enrichedTickets}
              selectedTicketId={selectedTicket?.id ?? null}
              activeFilter={activeFilter}
              inboxFilter={inboxFilter}
              onSetInboxFilter={setInboxFilter}
              unreadCount={counts.unread}
              sentCount={counts.sent}
              totalCount={counts.received}
              onSetFilter={setActiveFilter}
              onSelectTicket={handleSelectTicket}
              onComposeNew={handleComposeNew}
              onRefresh={handleRefresh}
              hasMore={hasMore}
              onLoadMore={handleLoadMore}
              // âœ… 3. Utilitzem l'estat 'isPreparingNetworkMessage' per desactivar la UI
              isPendingRefresh={isPending || isPreparingNetworkMessage}
              searchTerm={searchTerm}
              onSearchChange={setSearchTerm}
              isSelectionMode={isSelectionMode}
              selectedTicketIds={selectedTicketIds}
              onToggleSelection={onToggleSelection}
              onToggleSelectionMode={onToggleSelectionMode}
              onDeleteSelected={onDeleteSelected}
            />
          </div>
        )}

        {isDesktop && (
          <div className="min-h-0">
            <TicketDetail
              ticket={selectedTicket}
              body={selectedTicketBody}
              isLoading={isBodyLoading}
              onReply={handleReply}
              isContactPanelOpen={isContactPanelOpen}
              onToggleContactPanel={() => setIsContactPanelOpen(prev => !prev)}
            />
          </div>
        )}

        {isDesktop && isContactPanelOpen && (
          <div className="overflow-hidden min-h-0">
            <ContactPanel
              ticket={selectedTicket}
              onSaveContact={handleSaveContact}
              isPendingSave={isPending}
              allTeamContacts={props.allTeamContacts}
              limitStatus={props.limitStatus}
            />
          </div>
        )}

        <AnimatePresence>
          {!isDesktop && selectedTicket && (
            <MobileDetailView
              ticket={selectedTicket}
              body={selectedTicketBody}
              isLoading={isBodyLoading}
              isPending={isPending}
              onClose={() => handleSelectTicket(null)}
              onReply={handleReply}
              onSaveContact={handleSaveContact}
            />
          )}
        </AnimatePresence>
      </div>
    </>
  );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_components/InboxData.tsx ===================

// src/app/[locale]/(app)/comunicacio/inbox/_components/InboxData.tsx

import { redirect } from 'next/navigation';
import { headers } from "next/headers";
import { InboxClient } from "./InboxClient";
import { validateUserSession } from "@/lib/supabase/session";
// âœ… 1. Importem el servei i els tipus necessaris des del servei
import { getInboxInitialData } from '@/lib/services/comunicacio/inbox.service';
import type { Contact, EnrichedTicket, TeamMemberWithProfile, Template, InboxPermission } from '@/types/db'; // Mantenim tipus per claredat al component client
import { getUsageLimitStatus } from "@/lib/subscription/subscription";
// Re-exportem tipus per a InboxClient
export type { Contact, EnrichedTicket, TeamMemberWithProfile, Template, InboxPermission };

export async function InboxData() {
    // Obtenim sessiÃ³ i locale
    const session = await validateUserSession();
    const locale = ((await headers()).get('x-next-intl-locale')) || 'ca'; // Simplificat

    if ('error' in session) {
        console.error("InboxData: SessiÃ³ invÃ lida.", session.error.message);
        redirect(`/${locale}/login`);
    }
    const { supabase, user, activeTeamId } = session;

    // âœ… 2. Executem la comprovaciÃ³ de lÃ­mit i la cÃ rrega de dades EN PARALÂ·LEL
    const [limitCheck, { data, error }] = await Promise.all([
        getUsageLimitStatus('maxContacts'), // <-- MÃ©s net i reutilitzable
        getInboxInitialData(supabase, user.id, activeTeamId)
    ]);
    // âœ… 2. Cridem al servei per obtenir totes les dades inicials

    // âœ… 3. Gestionem l'error del servei
    if (error || !data) {
        console.error("Error en carregar les dades de l'Inbox (Component):", error);
        // Podries mostrar un missatge d'error mÃ©s especÃ­fic o un estat buit robust
        return (
            <InboxClient
                user={user} initialTickets={[]} initialTemplates={[]}
                initialReceivedCount={0} initialSentCount={0}
                teamMembers={[]} permissions={[]} allTeamContacts={[]}
                limitStatus={limitCheck} // Passa l'estat del lÃ­mit fins i tot si falla la llista

            // Passa un estat d'error opcional al client si vols
            // errorLoading={error ? 'Error en carregar les dades inicials.' : undefined}
            />
        );
    }

    // âœ… 4. Passem les dades obtingudes del servei al component client
    return (
        <InboxClient
            user={user} initialTickets={data.tickets} initialTemplates={data.templates}
            initialReceivedCount={data.receivedCount} initialSentCount={data.sentCount}
            teamMembers={data.teamMembers} permissions={data.permissions} allTeamContacts={data.allTeamContacts}
            limitStatus={limitCheck} // Passa l'estat del lÃ­mit fins i tot si falla la llista

        />
    );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_components/InboxSkeleton.tsx ===================

"use client";

/**
 * @summary Mostra un esquelet de cÃ rrega per a la pÃ gina de l'Inbox.
 */
export function InboxSkeleton() {
  return (
    <div className="flex flex-row h-full w-full animate-pulse">
      {/* Esquelet de la llista de tiquets */}
      <div className="w-80 lg:w-96 flex-shrink-0 border-r border-border glass-card p-4 space-y-4">
        <div className="h-8 w-1/2 bg-gray-700/50 rounded-md"></div>
        <div className="flex gap-2">
          <div className="h-8 w-24 bg-gray-700/50 rounded-md"></div>
          <div className="h-8 w-24 bg-gray-700/50 rounded-md"></div>
        </div>
        <div className="space-y-4 pt-2">
          {[...Array(8)].map((_, i) => (
            <div key={i} className="h-16 bg-gray-800/50 rounded-md"></div>
          ))}
        </div>
      </div>
      
      {/* Esquelet del detall del tiquet */}
      <div className="flex-1 p-6 space-y-4">
        <div className="h-8 w-3/4 bg-gray-700/50 rounded-md"></div>
        <div className="h-4 w-full bg-gray-700/50 rounded-md"></div>
        <div className="h-4 w-full bg-gray-700/50 rounded-md"></div>
        <div className="h-4 w-5/6 bg-gray-700/50 rounded-md"></div>
      </div>

      {/* Esquelet del panell de contacte */}
      <div className="w-80 lg:w-96 flex-shrink-0 border-l border-border glass-card p-4 space-y-4 hidden lg:block">
        <div className="h-8 w-1/2 bg-gray-700/50 rounded-md"></div>
        <div className="flex items-center gap-4">
          <div className="w-16 h-16 bg-gray-700/50 rounded-full"></div>
          <div className="flex-1 space-y-2">
            <div className="h-5 w-full bg-gray-700/50 rounded-md"></div>
            <div className="h-4 w-3/4 bg-gray-700/50 rounded-md"></div>
          </div>
        </div>
        <div className="h-4 w-full bg-gray-700/50 rounded-md"></div>
        <div className="h-4 w-full bg-gray-700/50 rounded-md"></div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_components/MobileDetailView.tsx ===================

// src/app/[locale]/(app)/comunicacio/inbox/_components/MobileDetailView.tsx
"use client";

import { motion } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { X, Reply, Info, UserPlus, Loader2 } from 'lucide-react';
import { useTranslations } from 'next-intl';
import React from 'react';
import { ContactDialog } from '../../../crm/contactes/_components/ContactDialog';
import { SafeEmailRenderer } from './SafeEmailRenderer';

// âœ¨ CANVI: Importem els tipus de la nostra Ãºnica font de la veritat.
import type { Contact, EnrichedTicket } from '@/types/db';

interface MobileDetailViewProps {
  ticket: EnrichedTicket;
  body: string | null;
  isLoading: boolean;
  isPending: boolean;
  onClose: () => void;
  onReply: (ticket: EnrichedTicket) => void;
  onSaveContact: (newlyCreatedContact: Contact, originalTicket: EnrichedTicket) => void;
}

export function MobileDetailView({ ticket, body, isLoading, isPending, onClose, onReply, onSaveContact }: MobileDetailViewProps) {
  const t = useTranslations('InboxPage');
  return (
    <motion.div 
      key={ticket.id} 
      initial={{ x: '100%' }} 
      animate={{ x: 0 }} 
      exit={{ x: '100%' }} 
      transition={{ type: 'tween', ease: 'easeInOut', duration: 0.3 }} 
      className="absolute inset-0 flex flex-col bg-background z-20"
    >
      <div className="p-2 border-b border-border flex justify-between items-center flex-shrink-0">
        <div className="flex items-center min-w-0">
          <Button variant="ghost" size="icon" onClick={onClose} className="flex-shrink-0" aria-label={t('closeButton')}>
            <X className="w-5 h-5" />
          </Button>
          <div className="ml-2 truncate">
            <p className="font-semibold truncate" title={ticket.subject ?? undefined}>{ticket.subject}</p>
            <p className="text-sm text-muted-foreground truncate" title={(ticket.contact_nom || ticket.sender_name) ?? undefined}>
              {t('fromLabel')}: {ticket.contact_nom || ticket.sender_name}
            </p>
          </div>
        </div>
        <Button size="sm" variant="outline" className="mr-2 flex-shrink-0" onClick={() => onReply(ticket)}>
          <Reply className="mr-2 h-4 w-4" />
          {t('replyButton')}
        </Button>
      </div>
      
      <div className="flex-1 min-h-0 flex flex-col">
        <div className="p-4 md:p-6 flex-shrink-0">
          <details className="border rounded-lg p-3 bg-muted/50">
            <summary className="cursor-pointer font-semibold flex items-center gap-2 text-sm">
              <Info className="w-4 h-4 text-primary" /> {t('senderDetailsLabel')}
            </summary>
            <div className="mt-3 pt-3 border-t space-y-2 text-sm">
              {/* âœ¨ CORRECCIÃ“: Utilitzem les propietats planes de EnrichedTicket */}
              <p><strong>{t('nameLabel')}:</strong> {ticket.contact_nom || ticket.sender_name}</p>
              <p><strong>{t('emailLabel')}:</strong> {ticket.contact_email || ticket.sender_email}</p>
              {!ticket.contact_id && (
                <ContactDialog
                  trigger={
                    <Button size="sm" className="w-full mt-2" disabled={isPending}>
                      <UserPlus className="w-4 h-4 mr-2"/>
                      {t('saveContactButton')}
                    </Button>
                  }
                  initialData={{
                    nom: ticket.sender_name || '',
                    email: ticket.sender_email || ''
                  }}
                  onContactSaved={(newContact) => onSaveContact(newContact as Contact, ticket)}
                />
              )}
            </div>
          </details>
        </div>
        <div className="flex-1 relative">
          {isLoading ? (
            <div className="absolute inset-0 flex items-center justify-center">
              <Loader2 className="w-8 h-8 animate-spin text-primary" />
            </div>
          ) : (
            <div className="absolute inset-0">
                 <SafeEmailRenderer htmlBody={body || ''} />
            </div>
          )}
        </div>
      </div>
    </motion.div>
  );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_components/SafeEmailRenderer.tsx ===================

// src/app/[locale]/(app)/comunicacio/inbox/_components/SafeEmailRenderer.tsx
"use client";

import React, { useMemo, useRef, useState, useEffect } from 'react';
import { useTranslations } from 'next-intl';

interface SafeEmailRendererProps {
    htmlBody: string;
}

// ====================================================================================
// CSS v4.0: MÃ€XIMA COMPATIBILITAT I FIDELITAT
// ====================================================================================
const compatibilityStyles = `
    /* --- 1. PREPARACIÃ“ DE L'ENTORN --- */
    :root {
        color-scheme: dark light;
    }
    body {
        background-color: transparent;
        color: hsl(var(--foreground));
        margin: 0;
        /* âœ… NOU: El padding es posa aquÃ­, dins de l'iframe, no fora. */
        padding: 0; /* âœ… CANVI: El padding ara anirÃ  al wrapper */
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        /* âœ… NOU: Assegurem que paraules llargues (URLs, etc.) no trenquin el layout */
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    * {
        box-sizing: border-box;
    }

    /* --- 2. REGLES DE SEGURETAT ESTRUCTURAL (NO NEGOCIABLE) --- */
    img, video, iframe, embed, object {
        max-width: 100% !important;
        height: auto !important;
        width: auto; /* Permet que s'encongeixi si cal */
    }

    table {
        /* âœ… MILLORAT: Forcem un layout que respecti l'amplada mÃ xima */
        table-layout: fixed;
        width: 100% !important; /* Molts correus antics no ho fan bÃ© */
        max-width: 100% !important;
    }
    
    td, th {
       /* âœ… NOU: Permet que el text dins les celÂ·les es trenqui correctament */
       word-break: break-word;
    }

    /* --- 3. SOLUCIÃ“ AL PROBLEMA DEL TEXT FOSC SOBRE FONS FOSC (MANTINGUT) --- */
    [style*="color:#000"]:not([style*="background"]),
    [style*="color:black"]:not([style*="background"]),
    [style*="color:#000000"]:not([style*="background"]) {
        color: hsl(var(--foreground)) !important;
    }

    /* --- 4. MILLORES DE VISUALITZACIÃ“ --- */
    a {
        /* âœ… NOU: Donem un color als enllaÃ§os per defecte, si el correu no ho fa */
        color: hsl(var(--primary));
    }
           /* âœ… NOU: El wrapper que actua com a llenÃ§ per al correu */
    #email-wrapper {
        background-color: #ffffff; /* Fons blanc garantit */
        color: #000000; /* Color de text per defecte negre */
        padding: 1.5rem; /* El padding que abans tenÃ­em al body */
    }
`;

export const SafeEmailRenderer: React.FC<SafeEmailRendererProps> = ({ htmlBody }) => {
    const t = useTranslations('InboxPage');
    const iframeRef = useRef<HTMLIFrameElement>(null);
    // âœ… MILLORAT: Comencem amb '100%' per evitar salts visuals mentre es calcula l'alÃ§ada real
    const [iframeHeight, setIframeHeight] = useState<string | number>('100%');

    const documentSource = useMemo(() => {
        return `
            <!DOCTYPE html>
            <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>${compatibilityStyles}</style>
                </head>
                <body>
                    <div id="email-wrapper">
                        ${htmlBody}
                    </div>
                    <script>
                        document.addEventListener('DOMContentLoaded', () => {
                            const body = document.body;
                            const html = document.documentElement;
                            const sendHeight = () => {
                                // Utilitzem el mÃ xim de diverses propietats per ser mÃ©s robustos
                                const height = Math.max(body.scrollHeight, body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight);
                                window.parent.postMessage({ type: 'iframeResize', height: height }, '*');
                            };
                            
                         // âœ… LÃ’GICA DEBOUNCE:
                            // Aquesta funciÃ³ embolcalla 'sendHeight' i s'assegura que no es cridi
                            // massa rÃ pidament, esperant 150ms d'inactivitat.
                            const debouncedSendHeight = () => {
                                clearTimeout(debounceTimeout);
                                debounceTimeout = setTimeout(sendHeight, 150);
                            };


                            // Observem canvis en el cos (imatges que es carreguen, contingut dinÃ mic)
                            const resizeObserver = new ResizeObserver(sendHeight);
                            resizeObserver.observe(body);

                            // Un Ãºltim intent quan tots els recursos (imatges) s'han carregat
                            window.addEventListener('load', sendHeight);
                        });
                    </script>
                </body>
            </html>
        `;
    }, [htmlBody]);

    useEffect(() => {
        const handleMessage = (event: MessageEvent) => {
            if (
                iframeRef.current &&
                event.source === iframeRef.current.contentWindow &&
                event.data.type === 'iframeResize' &&
                event.data.height > 0
            ) {
                // Li donem un pÃ­xel extra per evitar problemes d'arrodoniment
                setIframeHeight(event.data.height + 1);
            }
        };

        window.addEventListener('message', handleMessage);
        return () => window.removeEventListener('message', handleMessage);
    }, []);

    // âœ… SOLUCIÃ“: Retornem directament l'iframe, sense la 'div' que el limitava.
    return (
        <iframe
            ref={iframeRef}
            srcDoc={documentSource}
            title={t('emailContentTitle')}
            sandbox="allow-scripts"
            width="100%"
            height={iframeHeight}
            style={{
                border: 'none',
                display: 'block',
                background: 'transparent',
                // âœ… Afegim un alÃ§ada mÃ­nima per evitar que es colÂ·lapsi a 0px mentre carrega
                minHeight: '200px'
            }}
            scrolling="no"
        />
    );
};

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_components/TicketDetail.tsx ===================

// src/app/[locale]/(app)/comunicacio/inbox/_components/TicketDetail.tsx
"use client";

import React from 'react';
import { useTranslations } from 'next-intl';
import { Button } from '@/components/ui/button';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Reply, MoreVertical, Loader2, Info } from 'lucide-react';
import { SafeEmailRenderer } from './SafeEmailRenderer';

// âœ¨ CANVI: Importem el tipus correcte des de la nostra font de veritat.
import type { EnrichedTicket } from '@/types/db';

interface TicketDetailProps {
  ticket: EnrichedTicket | null; // âœ¨ CANVI: Ara espera el tipus correcte.
  body: string | null;
  isLoading: boolean;
  onReply: (ticket: EnrichedTicket) => void;
  isContactPanelOpen: boolean;
  onToggleContactPanel: () => void;
}

export const TicketDetail: React.FC<TicketDetailProps> = ({
  ticket,
  body,
  isLoading,
  onReply,
  isContactPanelOpen,
  onToggleContactPanel,
}) => {
  
  const t = useTranslations('InboxPage');

  if (!ticket) {
    return (
      <div className="h-full flex items-center justify-center">
        <p className="text-muted-foreground">{t('noTicketSelected')}</p>
      </div>
    );
  }

  // âœ¨ CORRECCIÃ“: Accedim a les dades de contacte planes directament des del tiquet.
  const senderName = ticket.contact_nom || ticket.sender_name || t('unknownSender');
  const senderEmail = ticket.contact_email || ticket.sender_email;
  const avatarUrl = ticket.profile_avatar_url;

  const getInitials = (name: string, fallback: string) => {
    if (!name) return fallback;
    return name.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase();
};

  return (
    <div className="h-full flex flex-col">
      <div className="p-4 border-b flex justify-between items-center flex-shrink-0">
        <div className="flex items-center gap-3 min-w-0">
          <Avatar>
            <AvatarImage src={avatarUrl ?? undefined} />
            <AvatarFallback>{getInitials(senderName, t('initialsFallback'))}</AvatarFallback>
          </Avatar>
          <div className="truncate">
            <p className="font-semibold truncate">{senderName}</p>
            <p className="text-sm text-muted-foreground truncate" title={senderEmail ?? undefined}>{senderEmail}</p>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <Button variant="ghost" size="icon" onClick={onToggleContactPanel}>
            <Info className={`w-5 h-5 ${isContactPanelOpen ? 'text-primary' : ''}`} />
          </Button>
          <Button onClick={() => onReply(ticket)}>
            <Reply className="mr-2 h-4 w-4" />
            {t('replyButton')}
          </Button>
          <Button variant="ghost" size="icon">
            <MoreVertical className="w-5 h-5" />
          </Button>
        </div>
      </div>

      <div className="p-4 border-b flex-shrink-0">
        <h2 className="text-xl font-bold">{ticket.subject}</h2>
      </div>

      <div className="flex-1 relative min-h-0">
        {isLoading ? (
          <div className="absolute inset-0 flex items-center justify-center">
            <Loader2 className="w-8 h-8 animate-spin text-primary" />
          </div>
        ) : (
          <div className="absolute inset-0">
            <SafeEmailRenderer htmlBody={body || ''} />
          </div>
        )}
      </div>
    </div>
  );
};

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_components/ticketList/index.tsx ===================

"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { Inbox } from 'lucide-react';
import type { User } from '@supabase/supabase-js';

import { useTranslations } from 'next-intl';
import { AnimatePresence, motion } from 'framer-motion';
import type { EnrichedTicket, TeamMemberWithProfile, InboxPermission, TicketFilter } from '@/types/db';

import { TicketListHeader } from './TicketListHeader';
import { TicketListFilters } from './TicketListFilters';
import { TicketListItem } from './TicketListItem';

export type UITicket = EnrichedTicket & { ownerColorClass?: string };

interface TicketListProps {
  user: User;
  teamMembers: TeamMemberWithProfile[];
  permissions: InboxPermission[];
  tickets: UITicket[];
  selectedTicketId: number | null; // Aquest Ã©s el tiquet OBERT per VEURE
  activeFilter: string;
  inboxFilter: string;
  onSetInboxFilter: (userId: string) => void;
  unreadCount: number;
  sentCount: number;
  isPendingRefresh: boolean;
  totalCount: number;
  onSelectTicket: (ticket: EnrichedTicket) => void;
  // âŒ onDeleteTicket ja no Ã©s una prop de TicketList, es gestionarÃ  al Header
  onSetFilter: (filter: TicketFilter) => void;
  onComposeNew: () => void;
  onRefresh: () => void;
  hasMore: boolean;
  onLoadMore: () => void;
  searchTerm: string;
  onSearchChange: (value: string) => void;

  // âœ… 1. Noves props per a la selecciÃ³
  isSelectionMode: boolean;
  selectedTicketIds: Set<number>; // Un Set Ã©s mÃ©s eficient per a lookups
  onToggleSelection: (ticketId: number) => void;
  onToggleSelectionMode: () => void;
  onDeleteSelected: () => void;
}

export const TicketList: React.FC<TicketListProps> = (props) => {
  const {
    tickets,
    selectedTicketId,
    onSelectTicket,
    hasMore,
    onLoadMore,
    isPendingRefresh,
    // âœ… 2. Extraiem les noves props
    isSelectionMode,
    selectedTicketIds,
    onToggleSelection,
  } = props;

  const t = useTranslations('InboxPage');

  return (
    <div className="w-full h-full flex flex-col flex-shrink-0 border-r border-border glass-card">
      {/* âœ… 3. Passem totes les props (incloses les noves) al Header */}
      <TicketListHeader
        {...props}
        selectedCount={selectedTicketIds.size}
      />

      <TicketListFilters {...props} />

      <div className="flex-1 h-0 overflow-y-auto">
        {/* âœ… 2. Embolcallem la llista amb AnimatePresence */}
        {/* 'initial={false}' evita l'animaciÃ³ en la cÃ rrega inicial */}
        <AnimatePresence initial={false}>
          {tickets.length > 0 ? (
            tickets.map(ticket => (
              <TicketListItem
                key={ticket.id} // La 'key' Ã©s fonamental per AnimatePresence
                ticket={ticket}
                isSelectionMode={isSelectionMode}
                isSelected={selectedTicketIds.has(ticket.id!)}
                isCurrentlyViewed={selectedTicketId === ticket.id}
                onToggleSelection={onToggleSelection}
                onSelectTicket={onSelectTicket}
              />
            ))
          ) : (
            // TambÃ© podem animar l'estat buit
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              className="flex flex-col items-center justify-center h-full p-4 text-center"
            >
              <Inbox className="w-12 h-12 text-muted-foreground mb-2" />
              <p className="text-muted-foreground">{t('emptyInbox')}</p>
            </motion.div>
          )}
        </AnimatePresence>
      </div>

      {hasMore && (
        <div className="p-4 border-t border-border flex-shrink-0">
          <Button
            variant="outline"
            className="w-full"
            onClick={onLoadMore}
            disabled={isPendingRefresh || isSelectionMode} // Deshabilitem si estem seleccionant
          >
            {isPendingRefresh ? t('loading') : t('loadMore')}
          </Button>
        </div>
      )}
    </div>
  );
};

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_components/ticketList/TicketListFilters.tsx ===================

// src/app/[locale]/(app)/comunicacio/inbox/_components/ticketList/TicketListFilters.tsx
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { LayoutGrid, Inbox, Mail, Send, Filter } from "lucide-react";
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from "@/components/ui/dropdown-menu";
import { useTranslations } from 'next-intl';
import { useMediaQuery } from '@/hooks/useMediaQuery';
import type { TicketFilter } from '@/types/db';

interface TicketListFiltersProps {
  activeFilter: string;
  onSetFilter: (filter: TicketFilter) => void;
  totalCount: number;
  sentCount: number;
  unreadCount: number;
}

export const TicketListFilters: React.FC<TicketListFiltersProps> = ({
  activeFilter,
  onSetFilter,
  totalCount,
  sentCount,
  unreadCount
}) => {  
  const t = useTranslations('InboxPage');
  const isMobile = useMediaQuery('(max-width: 1023px)');

  const filters: { id: TicketFilter, label: string, icon: React.ElementType, count?: number | string }[] = [
    { id: 'tots', label: t('allFilter'), icon: LayoutGrid, count: totalCount },
    { id: 'rebuts', label: t('receivedFilter'), icon: Inbox, count: totalCount - sentCount },
    { id: 'noLlegits', label: t('unreadFilter'), icon: Mail, count: unreadCount },
    { id: 'enviats', label: t('sentFilter'), icon: Send, count: sentCount },
  ];

  if (isMobile) {
    // ğŸ§­ MODE MÃ’BIL: mostrem un botÃ³ amb menÃº desplegable
    const active = filters.find(f => f.id === activeFilter) ?? filters[0];
    return (
      <div className="p-2 border-b border-border flex items-center justify-between">
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="outline" size="sm" className="flex items-center gap-2 w-full justify-between">
              <span className="flex items-center gap-2">
                <active.icon className="h-4 w-4" />
                {active.label}
              </span>
              <Filter className="w-4 h-4 text-muted-foreground" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="start" className="w-[180px]">
            {filters.map(filter => (
              <DropdownMenuItem key={filter.id} onClick={() => onSetFilter(filter.id)}>
                <filter.icon className="h-4 w-4 mr-2" />
                {filter.label}
                <span className="ml-auto text-xs text-muted-foreground">{filter.count}</span>
              </DropdownMenuItem>
            ))}
          </DropdownMenuContent>
        </DropdownMenu>
      </div>
    );
  }

  // ğŸ§± MODE DESKTOP: disseny original amb 4 botons
  return (
    <TooltipProvider delayDuration={0}>
      <div className="p-2 grid grid-cols-4 gap-2 border-b border-border flex-shrink-0">
        {filters.map(filter => (
          <Tooltip key={filter.id}>
            <TooltipTrigger asChild>
              <Button
                variant={activeFilter === filter.id ? 'secondary' : 'ghost'} 
                size="sm" 
                onClick={() => onSetFilter(filter.id)} 
                className="w-full flex items-center justify-center gap-2"
              >
                <filter.icon className="h-4 w-4" />
                {filter.id === 'noLlegits' ? (
                  <span className={`text-xs px-2 py-0.5 rounded-full ${unreadCount > 0 ? 'bg-primary text-primary-foreground' : 'text-muted-foreground bg-muted'}`}>{filter.count}</span>
                ) : (
                  <span className="text-xs text-muted-foreground">{filter.count}</span>
                )}
              </Button>
            </TooltipTrigger>
            <TooltipContent><p>{filter.label}</p></TooltipContent>
          </Tooltip>
        ))}
      </div>
    </TooltipProvider>
  );
};


// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_components/ticketList/TicketListHeader.tsx ===================

"use client";

import React, { useMemo } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { PenSquare, RefreshCw, ChevronDown, Search, ListChecks, Trash2 } from 'lucide-react';
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuSeparator, DropdownMenuTrigger } from "@/components/ui/dropdown-menu";
import { useTranslations } from 'next-intl';
import type { User } from '@supabase/supabase-js';
import type { TeamMemberWithProfile, InboxPermission } from '@/types/db';

interface TicketListHeaderProps {
  user: User;
  teamMembers: TeamMemberWithProfile[];
  permissions: InboxPermission[];
  inboxFilter: string;
  onSetInboxFilter: (userId: string) => void;
  onComposeNew: () => void;
  onRefresh: () => void;
  isPendingRefresh: boolean;
  searchTerm: string;
  onSearchChange: (value: string) => void;

  // âœ… 2. Noves props per a la selecciÃ³ mÃºltiple
  isSelectionMode: boolean;
  selectedCount: number;
  onToggleSelectionMode: () => void;
  onDeleteSelected: () => void;
}

export const TicketListHeader: React.FC<TicketListHeaderProps> = ({
  user,
  teamMembers,
  permissions,
  inboxFilter,
  onSetInboxFilter,
  onComposeNew,
  onRefresh,
  isPendingRefresh,
  searchTerm,
  onSearchChange,
  // âœ… 3. Rebem les noves props
  isSelectionMode,
  selectedCount,
  onToggleSelectionMode,
  onDeleteSelected
}) => {
  const t = useTranslations('InboxPage');

  const permittedMembers = useMemo(() => {
    const permittedIds = new Set(permissions.map(p => p.target_user_id));
    return teamMembers.filter(m => m.user_id && m.user_id !== user.id && permittedIds.has(m.user_id));
  }, [permissions, teamMembers, user.id]);

  const selectedInboxName = useMemo(() => {
    if (inboxFilter === 'all') return t('allInboxes');
    if (inboxFilter === user.id) return t('myEmails');
    const member = teamMembers.find(m => m.user_id === inboxFilter);
    return member?.full_name || t('unknownMailbox');
  }, [inboxFilter, teamMembers, user.id, t]);

  return (
    // âœ… CORRECCIÃ“ DE LAYOUT:
    // L'arrel Ã©s un 'div' amb 'flex-shrink-0' (NO un Fragment <>)
    <div className="flex-shrink-0 border-b border-border">
      <div className="flex justify-between items-center px-2 py-1">
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" className="text-lg font-bold p-2 -ml-2">
              {/* âœ… CORRECCIÃ“ DE CRASH:
                  Un 'span' embolcalla els dos fills del botÃ³ */}
              <span className="flex items-center">
                {selectedInboxName}
                <ChevronDown className="w-5 h-5 ml-2 text-muted-foreground" />
              </span>
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="start">
            <DropdownMenuItem onClick={() => onSetInboxFilter('all')}>{t('allInboxes')}</DropdownMenuItem>
            <DropdownMenuItem onClick={() => onSetInboxFilter(user.id)}>{t('myEmails')}</DropdownMenuItem>

            {permittedMembers.length > 0 && <DropdownMenuSeparator />}

            {permittedMembers
              .filter(member => !!member.user_id)
              .map(member => (
                <DropdownMenuItem key={member.user_id} onClick={() => onSetInboxFilter(member.user_id!)}>
                  {member.full_name || t('unnamedUser')}
                </DropdownMenuItem>
              ))
            }
          </DropdownMenuContent>
        </DropdownMenu>
        {/* âœ… 4. Controls de la capÃ§alera actualitzats */}
        <div className="flex items-center gap-1">
          {/* BotÃ³ de "Redactar" - es deshabilita en mode selecciÃ³ */}
          <Button variant="ghost" size="icon" onClick={onComposeNew} title={t('composeButtonTooltip')} disabled={isSelectionMode}>
            <PenSquare className="w-4 h-4" />
          </Button>

          {/* BotÃ³ de "Refrescar" - es deshabilita en mode selecciÃ³ */}
          <Button variant="ghost" size="icon" onClick={onRefresh} disabled={isPendingRefresh || isSelectionMode} title={t('refreshButtonTooltip')}>
            <RefreshCw className={`w-4 h-4 ${isPendingRefresh ? 'animate-spin' : ''}`} />
          </Button>

          {/* BotÃ³ per activar/desactivar mode selecciÃ³ */}
          <Button variant={isSelectionMode ? "secondary" : "ghost"} size="icon" onClick={onToggleSelectionMode} title={t('selectMultiple')}>
            <ListChecks className="w-4 h-4" />
          </Button>

          {/* BotÃ³ per esborrar seleccionats - NOMÃ‰S visible en mode selecciÃ³ */}
          {isSelectionMode && (
            <Button
              variant="ghost"
              size="icon"
              onClick={onDeleteSelected}
              disabled={selectedCount === 0}
              title={t('deleteSelected')}
            >
              <Trash2 className="w-4 h-4 text-destructive" />
              {selectedCount > 0 && (
                <span className="absolute -top-1 -right-1 bg-destructive text-destructive-foreground text-xs rounded-full h-4 w-4 flex items-center justify-center">
                  {selectedCount}
                </span>
              )}
            </Button>
          )}
        </div>
      </div>


      {/* Cerca: molt mÃ©s petita */}
      <div className="p-1 border-t border-border">
        <div className="relative">
          <Search className="absolute left-2 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground" />
          <Input
            placeholder={t('searchInboxPlaceholder')}
            className="px-8 pl-7 h-8 text-sm"
            value={searchTerm}
            onChange={(e) => onSearchChange(e.target.value)}
          />
        </div>
      </div>
    </div>
  );
};

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_components/ticketList/TicketListItem.tsx ===================

"use client";

import React from 'react';
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Checkbox } from "@/components/ui/checkbox"; // âœ… 1. Importem Checkbox
import { useLocale, useTranslations } from 'next-intl';
import type { UITicket } from './index';
import type { EnrichedTicket } from '@/types/db';
import { cn } from '@/lib/utils/utils'; // Ã‰s probable que necessitis 'cn'
import { motion } from 'framer-motion';

const formatTicketDate = (dateString: string | null, locale: string) => {
    if (!dateString) return '';
    const date = new Date(dateString);
    const now = new Date();
    const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    if (date >= startOfToday) {
        return date.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' });
    } else {
        return date.toLocaleDateString(locale, { day: 'numeric', month: 'short' });
    }
};

const getInitials = (name: string | null | undefined, fallback: string) => {
    if (!name) return fallback;
    return name.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase();
};

interface TicketListItemProps {
    ticket: UITicket;
    isSelected: boolean;
    isCurrentlyViewed: boolean; // Nou: per saber quin estÃ  obert ara mateix
    isSelectionMode: boolean; // âœ… 2. Nou estat per saber si mostrem checkboxes
    onSelectTicket: (ticket: EnrichedTicket) => void;
    onToggleSelection: (ticketId: number) => void; // âœ… 3. Nova funciÃ³ per al checkbox
}

export const TicketListItem: React.FC<TicketListItemProps> = ({ ticket, isSelected, isCurrentlyViewed, isSelectionMode, onSelectTicket, onToggleSelection }) => {
    const t = useTranslations('InboxPage');
    const locale = useLocale();

    // âœ… 4. Gestor unificat de clics
    const handleClick = () => {
        if (ticket.id === null) return;

        if (isSelectionMode) {
            // Si estem en mode selecciÃ³, el clic marca/desmarca
            onToggleSelection(ticket.id);
        } else {
            // Si no, el clic l'obre
            onSelectTicket(ticket as EnrichedTicket);
        }
    };
    // Gestor nomÃ©s per al checkbox (per aturar la propagaciÃ³)
    const handleCheckboxToggle = (e: React.MouseEvent) => {
        e.stopPropagation();
        if (ticket.id === null) return;
        onToggleSelection(ticket.id);
    };

   return (
    // âœ… 2. Canviem 'div' per 'motion.div'
    <motion.div
      layout // Aquesta Ã©s la mÃ gia que fa que la resta pugi
      animate={{ opacity: 1, y: 0 }}
      // AnimaciÃ³ de sortida: desapareix i redueix l'alÃ§ada a 0
      exit={{ 
        opacity: 0, 
        height: 0, 
        y: -10, 
        transition: { duration: 0.2 } 
      }}
      // 'initial' no el posem perquÃ¨ AnimatePresence ja s'encarrega
      // si ve d'una llista que canvia.
      
      onClick={handleClick}
      className={cn(
        `group cursor-pointer border-l-4 relative transition-colors flex items-center p-2 gap-3 overflow-hidden`, // Afegim overflow-hidden
        isCurrentlyViewed
          ? 'border-primary bg-muted'
          : `${ticket.ownerColorClass || 'border-transparent'} hover:bg-muted/30`,
        isSelectionMode && isSelected && 'bg-primary/10' 
      )}
    >
      {/* El contingut intern (checkbox, avatar, text) no canvia en absolut */}
      {isSelectionMode && (
        <div onClick={handleCheckboxToggle} className="pl-1 py-4 flex items-center cursor-pointer">
          <Checkbox
            checked={isSelected}
            aria-label={`Seleccionar tiquet ${ticket.subject}`}
          />
        </div>
      )}

      <Avatar className="h-8 w-8 mt-0.5 flex-shrink-0">
        <AvatarImage src={ticket.profile_avatar_url ?? undefined} />
        <AvatarFallback>{getInitials(ticket.profile_full_name, t('initialsFallback'))}</AvatarFallback>
      </Avatar>

      <div className="flex-1 min-w-0">
        <div className="flex justify-between items-center mb-0.5">
          <p className={cn(
            `truncate text-sm font-semibold`, 
            ticket.status === 'Llegit' && !isCurrentlyViewed && 'font-normal text-muted-foreground'
          )}>
            {ticket.contact_nom || ticket.sender_name || t('unknownSender')}
          </p>
          <div className="flex items-center gap-2 text-xs flex-shrink-0 ml-2">
            {ticket.status !== 'Llegit' && <span className="w-1.5 h-1.5 rounded-full bg-primary animate-pulse"></span>}
            <span className="text-muted-foreground">{formatTicketDate(ticket.sent_at, locale)}</span>
          </div>
        </div>
        <p className="text-xs truncate">{ticket.subject}</p>
        <p className="text-xs text-muted-foreground truncate mt-0.5">{ticket.preview}</p>
      </div>

    </motion.div>
  );
};

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_hooks/useCompose.ts ===================

// src/app/[locale]/(app)/comunicacio/inbox/_hooks/useCompose.ts
import { useState, useEffect, useMemo, useTransition } from 'react';
import { useEditor } from '@tiptap/react';
import StarterKit from '@tiptap/starter-kit';
import TextAlign from '@tiptap/extension-text-align';
import { toast } from "sonner";
import { useTranslations } from 'next-intl';

import { renderTemplate } from '@/lib/utils/templates';
import { sendEmailAction } from '../actions';

// âœ¨ CANVI: Importem els tipus directament de db.ts
import type { Contact, Template } from '@/types/db';
import type { InitialData } from '../_components/ComposeDialog';

interface UseComposeProps {
  templates: Template[];
  contacts: Contact[];
  initialData: InitialData | null;
  onClose: () => void;
  onEmailSent: () => void;
}

export function useCompose({ templates, contacts, initialData, onClose, onEmailSent }: UseComposeProps) {
  const t = useTranslations('InboxPage');
  const [isSending, startSendTransition] = useTransition();

  const editor = useEditor({
    immediatelyRender: false,
    extensions: [StarterKit, TextAlign.configure({ types: ['heading', 'paragraph'] })],
    editorProps: {
      attributes: {
        class: 'prose dark:prose-invert max-w-none text-base p-4 focus:outline-none h-full border border-input rounded-md min-h-[400px]',
      },
    },
  });
  
  const [subject, setSubject] = useState('');
  const [selectedContactId, setSelectedContactId] = useState<number | ''>(''); // âœ¨ CANVI: L'ID Ã©s un nÃºmero.
  const [contactSearch, setContactSearch] = useState('');
  const [selectedTemplate, setSelectedTemplate] = useState<Template | null>(null); // âœ¨ CANVI: Utilitzem el tipus 'Template'
  const [variableValues, setVariableValues] = useState<{ [key: string]: string }>({});
  const [debouncedVariableValues, setDebouncedVariableValues] = useState<{ [key: string]: string }>({});

  useEffect(() => {
    // âœ¨ CANVI: Assegurem que el contactId Ã©s un nÃºmero.
    setSelectedContactId(initialData?.contactId ? Number(initialData.contactId) : '');
    setSubject(initialData?.subject || '');
    editor?.commands.setContent(initialData?.body || '');
    setSelectedTemplate(null);
    setVariableValues({});
    setDebouncedVariableValues({});
    setContactSearch('');
  }, [initialData, editor]);

  useEffect(() => {
    const handler = setTimeout(() => setDebouncedVariableValues(variableValues), 500);
    return () => clearTimeout(handler);
  }, [variableValues]);
  
  useEffect(() => {
    if (selectedTemplate && selectedTemplate.subject) {
      setSubject(renderTemplate(selectedTemplate.subject, debouncedVariableValues));
    }
  }, [selectedTemplate, debouncedVariableValues]);

  const finalHtmlBody = useMemo(() => {
    if (selectedTemplate && selectedTemplate.body) {
      return renderTemplate(selectedTemplate.body, debouncedVariableValues);
    }
    return editor?.getHTML() || '';
  }, [selectedTemplate, debouncedVariableValues, editor]);
  
  const filteredContacts = useMemo(() => {
    if (!contactSearch) return contacts;
    const search = contactSearch.toLowerCase();
    return contacts.filter(contact => {
      // âœ¨ SENSE CANVI: 'nom' Ã©s correcte segons la teva definiciÃ³ de la taula.
      const hasMatchingName = contact.nom.toLowerCase().includes(search);
      const hasMatchingEmail = !!contact.email && contact.email.toLowerCase().includes(search);
      return hasMatchingName || hasMatchingEmail;
    });
  }, [contacts, contactSearch]);

  const handleTemplateSelect = (templateId: string) => {
    if (!templateId || templateId === 'none') {
      setSelectedTemplate(null);
      return;
    }
    const template = templates.find(t => t.id.toString() === templateId);
    if (template) {
      setSelectedTemplate(template);
      setVariableValues({});
    }
  };

  const handleSend = () => {
    if (!selectedContactId || !subject || !finalHtmlBody.replace(/<p><\/p>/g, '').trim()) {
      toast.error(t('requiredFieldsErrorTitle'), { description: t('requiredFieldsErrorDescription') });
      return;
    }
    startSendTransition(async () => {
      const result = await sendEmailAction({
        contactId: Number(selectedContactId), // Assegurem que Ã©s un nÃºmero.
        subject,
        htmlBody: finalHtmlBody,
        isReply: !!initialData?.contactId,
      });
      if (result.success) {
        toast.success(t('toastSuccessTitle'), { description: result.message });
        onClose();
        onEmailSent();
      } else {
        toast.error(t('toastErrorTitle'), { description: result.message });
      }
    });
  };

  return {
    editor, subject, setSubject,
    selectedContactId, setSelectedContactId,
    contactSearch, setContactSearch,
    selectedTemplate, handleTemplateSelect,
    variableValues, setVariableValues,
    finalHtmlBody, filteredContacts, isSending, handleSend,
  };
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_hooks/useInbox.ts ===================

// src/app/[locale]/(app)/comunicacio/inbox/_hooks/useInbox.ts
import { useCallback, useState, useTransition } from "react"; // âœ… 1. Importem useState
import { useRouter } from "next/navigation";
import { toast } from "sonner";
import type { User } from "@supabase/supabase-js";

import type {
  DbTableRow,
  EnrichedTicket,
  TeamMemberWithProfile,
} from "@/types/db";

// âœ… 2. Importem la nova acciÃ³
import {
  deleteMultipleTicketsAction,
  deleteTicketAction,
  linkTicketsToContactAction,
} from "../actions";
import { useInboxStateAndFilters } from "./useInboxStateAndFilter";
import { useTicketData } from "./useTicketData";
import { useURLSync } from "./useURLSync";
import { useInboxComputed } from "./useInboxComputed";

// âœ… Mantenim el tipus original, perÃ² ara algunes props seran ignorades a favor de la lÃ²gica interna
export type UseInboxProps = {
  user: User;
  initialTickets: EnrichedTicket[];
  initialTemplates: DbTableRow<"email_templates">[];
  initialUnreadCount: number;
  initialSentCount: number;
  teamMembers: TeamMemberWithProfile[];
  t: (key: string, values?: Record<string, string | number | Date>) => string;
  // Les props `initialSelectedTicket` i `initialSelectedTicketBody` ja no sÃ³n necessÃ ries aquÃ­
};

export function useInbox({
  user,
  initialTickets,
  initialUnreadCount,
  initialSentCount,
  teamMembers,
  t,
}: UseInboxProps) {
  const router = useRouter();
  const [isActionPending, startActionTransition] = useTransition();
  const [isDeleting, startDeleteTransition] = useTransition();
  const {
    selectedTicket,
    setSelectedTicket,
    ticketToDelete,
    setTicketToDelete,
    activeFilter,
    setActiveFilter,
    composeState,
    setComposeState,
    isContactPanelOpen,
    setIsContactPanelOpen,
    inboxFilter,
    setInboxFilter,
    searchTerm,
    setSearchTerm,
  } = useInboxStateAndFilters(user);

  const onTicketSelectedCallback = useCallback((ticket: EnrichedTicket) => {
    setSelectedTicket(ticket);
  }, [setSelectedTicket]);

  const onTicketDeselectedCallback = useCallback(() => {
    setSelectedTicket(null);
  }, [setSelectedTicket]);

  const {
    isPending: isDataPending,
    tickets,
    setTickets,
    selectedTicketBody,
    isBodyLoading,
    hasMore,
    debouncedSearchTerm,
    handleSelectTicket: performSelectTicket,
    fetchAndSelectTicket, // âœ… Rebem la funciÃ³ des de useTicketData

    handleLoadMore,
  } = useTicketData({
    initialTickets,
    activeFilter,
    inboxFilter,
    searchTerm,
    onTicketSelected: onTicketSelectedCallback,
    onTicketDeselected: onTicketDeselectedCallback,
  });

  const handleSelectTicket = useCallback((ticket: EnrichedTicket | null) => {
    performSelectTicket(ticket, selectedTicket?.id);
  }, [performSelectTicket, selectedTicket?.id]);

  useURLSync({
    selectedTicket,
    debouncedSearchTerm,
    initialTickets,
    onSelectTicketFromURL: handleSelectTicket,
    onFetchAndSelectTicket: fetchAndSelectTicket,
  });

  const { enrichedTickets, counts } = useInboxComputed({
    tickets,
    activeFilter,
    inboxFilter,
    teamMembers,
    initialUnreadCount,
    initialSentCount,
  });

  // Aquesta funciÃ³ ja actualitza l'estat local (setTickets), per aixÃ² ja s'animarÃ 
  const handleDeleteTicket = useCallback(() => {
    if (!ticketToDelete) return;
    startActionTransition(async () => {
      const result = await deleteTicketAction(ticketToDelete.id!);
      toast[result.success ? "success" : "error"](result.message);
      if (result.success) {
        setTickets((prev) => prev.filter((t) => t.id !== ticketToDelete.id)); // <-- Correcte
        if (selectedTicket?.id === ticketToDelete.id) {
          handleSelectTicket(null);
        }
        setTicketToDelete(null);
      }
    });
  }, [
    ticketToDelete,
    selectedTicket,
    handleSelectTicket,
    setTickets,
    setTicketToDelete,
  ]);

  const handleSaveContact = useCallback(
    (
      newlyCreatedContact: DbTableRow<"contacts">,
      originalTicket: EnrichedTicket,
    ) => {
      startActionTransition(async () => {
        if (!originalTicket.sender_email) {
          toast.error("El tiquet no tÃ© un email de remitent per vincular.");
          return;
        }
        const result = await linkTicketsToContactAction(
          newlyCreatedContact.id,
          originalTicket.sender_email,
        );
        toast[result.success ? "success" : "error"](result.message);
        if (result.success) {
          router.refresh();
        }
      });
    },
    [router],
  );

  const handleComposeNew = useCallback(
    () => setComposeState({ open: true, initialData: null }),
    [setComposeState],
  );

  const handleReply = useCallback((ticket: EnrichedTicket) => {
    const date = ticket.sent_at
      ? new Date(ticket.sent_at).toLocaleString("ca-ES")
      : new Date().toLocaleString("ca-ES");
    const name = ticket.contact_nom || ticket.sender_name || "";
    const quotedBody = `<br><br><p>${
      t("replyHeader", { date, name })
    }</p><blockquote>${selectedTicketBody ?? ""}</blockquote>`;
    setComposeState({
      open: true,
      initialData: {
        contactId: ticket.contact_id ? String(ticket.contact_id) : undefined,
        to: ticket.contact_email ?? ticket.sender_email ?? "",
        subject: `Re: ${ticket.subject}`,
        body: quotedBody,
      },
    });
  }, [selectedTicketBody, t, setComposeState]);

  const handleRefresh = useCallback(() => {
    startActionTransition(() => {
      router.refresh();
    });
  }, [router]);
  // --- LÃ’GICA DE SELECCIÃ“ MÃšLTIPLE ---
  const [isSelectionMode, setIsSelectionMode] = useState(false);
  const [selectedTicketIds, setSelectedTicketIds] = useState<Set<number>>(
    new Set(),
  );

  const handleToggleSelectionMode = useCallback(() => {
    setIsSelectionMode((prev) => {
      const newMode = !prev;
      if (!newMode) {
        setSelectedTicketIds(new Set());
      }
      return newMode;
    });
  }, []);

  const handleToggleSelection = useCallback((ticketId: number) => {
    setSelectedTicketIds((prev) => {
      const newSet = new Set(prev);
      if (newSet.has(ticketId)) {
        newSet.delete(ticketId);
      } else {
        newSet.add(ticketId);
      }
      return newSet;
    });
  }, []);

  // âœ… --- CANVI PRINCIPAL AQUÃ ---
  /**
   * Crida la Server Action per esborrar els tiquets seleccionats
   * i actualitza l'estat local.
   */
  const handleDeleteSelected = useCallback(() => {
    if (selectedTicketIds.size === 0) return;

    if (
      !confirm(t("deleteMultipleConfirm", { count: selectedTicketIds.size }))
    ) {
      return;
    }

    startDeleteTransition(async () => {
      const ids = Array.from(selectedTicketIds);
      const result = await deleteMultipleTicketsAction(ids);

      if (result.success) {
        toast.success(result.message || t("deleteMultipleSuccess"));

        // âœ… 1. ACTUALITZEM L'ESTAT LOCAL (en lloc de handleRefresh)
        setTickets((prev) => prev.filter((t) => !selectedTicketIds.has(t.id!)));

        // 2. Comprovem si el tiquet obert estava entre els esborrats
        if (selectedTicket && selectedTicketIds.has(selectedTicket.id!)) {
          handleSelectTicket(null); // Tanquem el panell de detall
        }

        // 3. Resetejem l'estat de selecciÃ³
        setSelectedTicketIds(new Set());
        setIsSelectionMode(false);

        // âŒ JA NO CAL: handleRefresh();
      } else {
        toast.error(result.message || t("deleteMultipleError"));
      }
    });
    // âœ… Afegim les dependÃ¨ncies necessÃ ries
  }, [selectedTicketIds, t, setTickets, selectedTicket, handleSelectTicket]);

  return {
    selectedTicket,
    ticketToDelete,
    activeFilter,
    composeState,
    selectedTicketBody,
    isBodyLoading,
    hasMore,
    searchTerm,
    isPending: isDataPending || isActionPending || isDeleting,
    isContactPanelOpen,
    inboxFilter,
    counts,
    enrichedTickets,
    setTicketToDelete,
    setActiveFilter,
    setComposeState,
    setSearchTerm,
    setIsContactPanelOpen,
    setInboxFilter,
    handleSelectTicket,
    handleDeleteTicket,
    handleLoadMore,
    handleSaveContact,
    handleComposeNew,
    handleReply,
    handleRefresh,

    // --- Nous valors retornats (sense canvis) ---
    isSelectionMode,
    selectedTicketIds,
    onToggleSelectionMode: handleToggleSelectionMode,
    onToggleSelection: handleToggleSelection,
    onDeleteSelected: handleDeleteSelected,
  };
}


// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_hooks/useInboxComputed.ts ===================

// src/app/[locale]/(app)/comunicacio/inbox/_hooks/useInboxComputed.ts
import { useMemo } from 'react';
import type { EnrichedTicket, TeamMemberWithProfile, TicketFilter } from '@/types/db';

type UITicket = EnrichedTicket & { ownerColorClass?: string };

type UseInboxComputedProps = {
  tickets: EnrichedTicket[];
  activeFilter: TicketFilter;
  inboxFilter: string;
  teamMembers: TeamMemberWithProfile[];
  initialUnreadCount: number;
  initialSentCount: number;
};

export function useInboxComputed({
  tickets,
  activeFilter,
  inboxFilter,
  teamMembers,
  initialUnreadCount,
  initialSentCount,
}: UseInboxComputedProps) {
  
  const filteredTickets = useMemo(() => {
    let displayTickets = tickets;
    if (inboxFilter !== 'all') {
      displayTickets = displayTickets.filter(t => t.user_id === inboxFilter);
    }
    if (activeFilter === 'rebuts') return displayTickets.filter(t => t.type === 'rebut' || !t.type);
    if (activeFilter === 'enviats') return displayTickets.filter(t => t.type === 'enviat');
    if (activeFilter === 'noLlegits') return displayTickets.filter(t => (t.type === 'rebut' || !t.type) && t.status !== 'Llegit');
    return displayTickets;
  }, [tickets, activeFilter, inboxFilter]);

  const enrichedTickets = useMemo<UITicket[]>(() => {
    const userProfileMap = new Map<string, TeamMemberWithProfile>();
    teamMembers.forEach(member => {
      if (member.user_id) {
        userProfileMap.set(member.user_id, member);
      }
    });
    const colors = ['border-blue-500', 'border-green-500', 'border-yellow-500', 'border-purple-500', 'border-pink-500', 'border-indigo-500'];
    
    return filteredTickets.map((ticket, index) => {
      const ownerProfile = ticket.user_id ? userProfileMap.get(ticket.user_id) : undefined;
      return {
        ...ticket,
        profile_full_name: ticket.profile_full_name ?? ownerProfile?.full_name ?? null,
        profile_avatar_url: ticket.profile_avatar_url ?? ownerProfile?.avatar_url ?? null,
        ownerColorClass: ticket.user_id ? colors[index % colors.length] : 'border-transparent',
      };
    });
  }, [filteredTickets, teamMembers]);

  const counts = useMemo(() => ({
    unread: tickets.filter(t => (t.type === 'rebut' || !t.type) && t.status !== 'Llegit').length,
    received: initialUnreadCount,
    sent: initialSentCount,
  }), [tickets, initialUnreadCount, initialSentCount]);

  return { enrichedTickets, counts };
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_hooks/useInboxStateAndFilter.ts ===================

// src/app/[locale]/(app)/comunicacio/inbox/_hooks/useInboxStateAndFilters.ts
import { useState } from 'react';
import { useSearchParams } from 'next/navigation';
import type { User } from '@supabase/supabase-js';
import type { EnrichedTicket, TicketFilter } from '@/types/db';
import type { InitialData as ComposeInitialData } from '../_components/ComposeDialog';

export function useInboxStateAndFilters(user: User) {
  const searchParams = useSearchParams();

  const [selectedTicket, setSelectedTicket] = useState<EnrichedTicket | null>(null);
  const [ticketToDelete, setTicketToDelete] = useState<EnrichedTicket | null>(null);
  const [activeFilter, setActiveFilter] = useState<TicketFilter>('rebuts');
  const [composeState, setComposeState] = useState<{ open: boolean; initialData: ComposeInitialData | null }>({ open: false, initialData: null });
  const [isContactPanelOpen, setIsContactPanelOpen] = useState(false);
  const [inboxFilter, setInboxFilter] = useState<string>(user.id);
  const [searchTerm, setSearchTerm] = useState(searchParams.get('q') || '');

  return {
    // States
    selectedTicket,
    ticketToDelete,
    activeFilter,
    composeState,
    isContactPanelOpen,
    inboxFilter,
    searchTerm,
    // Setters
    setSelectedTicket,
    setTicketToDelete,
    setActiveFilter,
    setComposeState,
    setIsContactPanelOpen,
    setInboxFilter,
    setSearchTerm,
  };
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_hooks/useTicketData.ts ===================

// src/app/[locale]/(app)/comunicacio/inbox/_hooks/useTicketData.ts (CORREGIT FINAL)
import { useState, useTransition, useEffect, useCallback } from 'react';
import { useDebounce } from 'use-debounce';
import { toast } from 'sonner';
import {
  getTicketsAction,
  getTicketBodyAction,
  markTicketAsReadAction,
  getTicketByIdAction
} from '../actions';
import type { EnrichedTicket, TicketFilter } from '@/types/db';

type UseTicketDataProps = {
  initialTickets: EnrichedTicket[];
  activeFilter: TicketFilter;
  inboxFilter: string;
  searchTerm: string;
  onTicketSelected: (ticket: EnrichedTicket) => void;
  onTicketDeselected: () => void;
};

export function useTicketData({
  initialTickets,
  activeFilter,
  inboxFilter,
  searchTerm,
  onTicketSelected,
  onTicketDeselected,
}: UseTicketDataProps) {
  const [isPending, startTransition] = useTransition();
  const [tickets, setTickets] = useState<EnrichedTicket[]>(initialTickets);
  const [selectedTicketBody, setSelectedTicketBody] = useState<string | null>(null);
  const [isBodyLoading, setIsBodyLoading] = useState(false);
  const [page, setPage] = useState(2);
  const [hasMore, setHasMore] = useState(initialTickets.length > 0);
  const [debouncedSearchTerm] = useDebounce(searchTerm, 500);

  useEffect(() => {
    startTransition(async () => {
      const results = await getTicketsAction(1, activeFilter, inboxFilter, debouncedSearchTerm);
      setTickets(results);
      setHasMore(results.length > 0);
      setPage(2);
    });
  }, [activeFilter, inboxFilter, debouncedSearchTerm]);

  const handleSelectTicket = useCallback(async (ticket: EnrichedTicket | null, currentSelectedId: number | undefined | null) => {
    if (currentSelectedId === ticket?.id) return;

    if (!ticket || !ticket.id) {
      setSelectedTicketBody(null);
      onTicketDeselected();
      return;
    }

    setIsBodyLoading(true);
    setSelectedTicketBody(null);
    onTicketSelected(ticket);

    try {
      const { body } = await getTicketBodyAction(ticket.id);
      setSelectedTicketBody(body);
    } catch (error) {
      console.error("Error en carregar el cos del tiquet:", error);
      setSelectedTicketBody('<p>Error en carregar el contingut.</p>');
    } finally {
      setIsBodyLoading(false);
    }

    if (ticket.status !== 'Llegit') {
      setTickets(currentTickets =>
        currentTickets.map(t => t.id === ticket.id ? { ...t, status: 'Llegit' as const } : t)
      );
      await markTicketAsReadAction(ticket.id);
    }
  }, [onTicketSelected, onTicketDeselected]);

  // ----------------------------------------------------------------------
  // ğŸ¯ FUNCIÃ“ CLAU: FETCH I SELECCIÃ“ FORÃ‡ADA (FIX BODY)
  // ----------------------------------------------------------------------
  const fetchAndSelectTicket = useCallback(async (ticketId: number) => {

    console.log(`ğŸ“¡ [Fetch Ticket] ForÃ§ant cÃ rrega per a l'ID: ${ticketId}`);

    // 1. Netejar cos anterior i posar cÃ rrega
    setIsBodyLoading(true);
    setSelectedTicketBody(null);
    onTicketDeselected(); // Desselecciona l'anterior mentre carreguem

    // 2. Crida a la Server Action per obtenir el tiquet ENRIQUIT (sense el body)
    const result = await getTicketByIdAction(ticketId);

    if (result.error || !result.data) {
      console.error('âŒ [Fetch Ticket] Error o tiquet no trobat:', result.error);
      toast.error("Error carregant el correu.", {
        description: result.error || "No s'ha pogut trobar el correu especificat."
      });
      setIsBodyLoading(false);
      return;
    }

    // 3. Trobem el tiquet, l'establirem com a seleccionat.
    const fetchedTicket = result.data;
    onTicketSelected(fetchedTicket); // ğŸ”‘ Estableix selectedTicket (sense el body)

    // --------------------------------------------------------------------
    // ğŸ”‘ FIX CLAU: Carregar el cos del correu amb la segona Server Action
    // --------------------------------------------------------------------
    try {
      if (typeof fetchedTicket.id === 'number') {
        const { body } = await getTicketBodyAction(fetchedTicket.id); // 5. Carrega el Body
        setSelectedTicketBody(body); // 6. Estableix el Body
      } else {
        throw new Error("ID del tiquet no vÃ lid.");
      }
    } catch (error) {
      console.error("Error en carregar el cos del tiquet forÃ§at:", error);
      setSelectedTicketBody('<p>Error en carregar el contingut del correu.</p>');
    } finally {
      setIsBodyLoading(false);
    }
    // --------------------------------------------------------------------

    // 7. Opcional: Afegeix el tiquet a la llista local (per a millor UX de la llista)
    setTickets(prevTickets => {
      if (!prevTickets.some(t => t.id === fetchedTicket.id)) {
        // Com que l'hem carregat per ID, assumim que hauria d'estar al principi de la llista.
        return [fetchedTicket, ...prevTickets];
      }
      return prevTickets;
    });

    // 8. Marcar com a llegit (si escau)
    if (fetchedTicket.status !== 'Llegit') {
      setTickets(currentTickets =>
        currentTickets.map(t => t.id === fetchedTicket.id ? { ...t, status: 'Llegit' as const } : t)
      );
      if (typeof fetchedTicket.id === 'number') {
        await markTicketAsReadAction(fetchedTicket.id);
      }
    }


  }, [onTicketSelected, onTicketDeselected, setTickets, setIsBodyLoading, setSelectedTicketBody]);
  // âœ… CORRECCIÃ“: Restaurem la lÃ²gica de 'handleLoadMore'
  const handleLoadMore = useCallback(() => {
    if (!hasMore || isPending) return;
    startTransition(async () => {
      // Ara 'page' es fa servir correctament aquÃ­
      const results = await getTicketsAction(page, activeFilter, inboxFilter, debouncedSearchTerm);
      if (results.length > 0) {
        setTickets(p => [...p, ...results]);
        setPage(p => p + 1);
      } else {
        setHasMore(false);
      }
    });
  }, [page, activeFilter, inboxFilter, debouncedSearchTerm, hasMore, isPending]);

  return {
    isPending,
    tickets,
    setTickets,
    selectedTicketBody,
    isBodyLoading,
    hasMore,
    debouncedSearchTerm,
    handleSelectTicket,
    handleLoadMore,
    fetchAndSelectTicket,
  };
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/inbox/_hooks/useURLSync.ts ===================

import { useEffect, useRef } from 'react';
import { usePathname, useSearchParams } from 'next/navigation';
import type { EnrichedTicket } from '@/types/db';

type UseURLSyncProps = {
Â  selectedTicket: EnrichedTicket | null;
Â  debouncedSearchTerm: string;
Â  initialTickets: EnrichedTicket[];
Â  onSelectTicketFromURL: (ticket: EnrichedTicket) => void;
Â  onFetchAndSelectTicket: (ticketId: number) => void;
};

export function useURLSync({
Â  selectedTicket,
Â  debouncedSearchTerm,
Â  initialTickets,
Â  onSelectTicketFromURL,
Â  onFetchAndSelectTicket,

}: UseURLSyncProps) {
Â  const searchParams = useSearchParams();
Â  const pathname = usePathname();

Â  const hasInitializedFromUrl = useRef(false);

Â  const ticketsRef = useRef(initialTickets);
Â  ticketsRef.current = initialTickets;

Â  const onSelectRef = useRef(onSelectTicketFromURL);
Â  onSelectRef.current = onSelectTicketFromURL;

Â  const onFetchRef = useRef(onFetchAndSelectTicket);
Â  onFetchRef.current = onFetchAndSelectTicket;

Â  const searchParamsString = searchParams.toString();

Â  // -------------------------------------------------------------------------
Â  // EFECTE 1: LLEGIR LA URL (InicialitzaciÃ³).
Â  // -------------------------------------------------------------------------
Â  useEffect(() => {
Â  Â  if (hasInitializedFromUrl.current) return; 
    
Â  Â  const params = new URLSearchParams(searchParamsString);
Â  Â  const ticketIdFromUrl = params.get('ticketId');

Â  Â  if (ticketIdFromUrl) {
Â  Â  Â  const ticketIdNum = Number(ticketIdFromUrl);
Â  Â  Â  const ticketToSelect = ticketsRef.current.find(t => t.id === ticketIdNum);

Â  Â  Â  if (ticketToSelect) {
Â  Â  Â  Â  // Cas A: Trobem el tiquet localment.
Â  Â  Â  Â  hasInitializedFromUrl.current = true;
Â  Â  Â  Â  onSelectRef.current(ticketToSelect);
Â  Â  Â  } else {
Â  Â  Â  Â  // Cas B: Tiquet NO a la llista (Cal anar a buscar-lo).
Â  Â  Â  Â  // Mantenim hasInitializedFromUrl = true per BLOCAR l'EFECTE 2 i evitar neteja
Â  Â  Â  Â  hasInitializedFromUrl.current = true; 
Â  Â  Â  Â  onFetchRef.current(ticketIdNum);
Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  // Cas C: Si NO hi ha ID a la URL, la inicialitzaciÃ³ de l'ID s'ha completat.
Â  Â  Â  hasInitializedFromUrl.current = true;
Â  Â  }
Â  }, [initialTickets, searchParamsString]); 
    // Nota: Eliminem les funcions com a dependÃ¨ncia ja que sÃ³n refs estables.


Â  // -------------------------------------------------------------------------
Â  // EFECTE 2: ESCRVIRE A LA URL (SincronitzaciÃ³).
Â  // -------------------------------------------------------------------------
Â  useEffect(() => {
Â  Â  const params = new URLSearchParams(searchParamsString);
    const ticketIdInUrl = params.get('ticketId'); // ğŸ”‘ Llegim l'estat actual de la URL
    
Â  Â  // ğŸ”‘ DOBLE BLOQUEIG:
    // 1. Si l'inicialitzaciÃ³ no ha acabat.
    // 2. Si hi ha un ticketId a la URL, perÃ² selectedTicket encara Ã©s null (estem esperant el fetch).
Â  Â  if (!hasInitializedFromUrl.current || (ticketIdInUrl && !selectedTicket?.id)) {
Â  Â  Â  return;
Â  Â  }

Â  Â  // La URL i l'estat estan sincronitzats, podem escriure
Â  Â  if (selectedTicket?.id) {
Â  Â  Â  // L'usuari ha seleccionat un tiquet: escrivim l'ID
Â  Â  Â  params.set('ticketId', selectedTicket.id.toString());
Â  Â  } else {
Â  Â  Â  // L'usuari ha tancat el detall (selectedTicket = null): esborrem l'ID
Â  Â  Â  params.delete('ticketId'); 
Â  Â  }

Â  Â  if (debouncedSearchTerm) {
Â  Â  Â  params.set('q', debouncedSearchTerm);
Â  Â  } else {
Â  Â  Â  params.delete('q');
Â  Â  }

Â  Â  if (params.toString() !== searchParamsString) {
Â  Â  Â  window.history.replaceState(null, '', `${pathname}?${params.toString()}`);
Â  Â  }
Â  }, [selectedTicket, debouncedSearchTerm, pathname, searchParamsString]);
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/marketing/actions.ts ===================

// UbicaciÃ³: /app/(app)/comunicacio/marketing/actions.ts

'use server';

import { revalidatePath } from 'next/cache';
import { validateUserSession } from '@/lib/supabase/session';
import { createClient as createSupabaseServerClient} from '@/lib/supabase/server'; // Necessari per crear el client
import { marketingService } from '@/lib/services/comunicacio/marketing.service'; // âœ… Importem el servei!
import type { Strategy, Campaign } from '@/types/comunicacio/marketing'; // âœ… Importem els tipus centralitzats!

/**
 * @summary Genera idees d'estratÃ¨gies de mÃ rqueting.
 * @description Aquesta acciÃ³ ara nomÃ©s orquestra. La lÃ²gica de 'prompt' i API estÃ  al servei.
 */
export async function generateStrategiesAction(
  goal: string,
): Promise<{ data: Strategy[] | null; error: string | null }> {
  if (!goal) {
    return { data: null, error: "L'objectiu no pot estar buit." };
  }
  // La crida a Gemini no requereix autenticaciÃ³ d'usuari, cridem el servei directament.
  return await marketingService.generateStrategies(goal);
}

/**
 * @summary Redacta el contingut d'una campanya.
 * @description La lÃ²gica de 'prompt' i API estÃ  al servei.
 */
export async function draftContentAction(
  goal: string,
  strategy: Strategy,
): Promise<{ data: string | null; error: string | null }> {
  if (!goal || !strategy) {
    return { data: null, error: 'Falten dades per redactar el contingut.' };
  }
  return await marketingService.draftContent(goal, strategy);
}

/**
 * @summary Desa una nova campanya.
 * @description Valida la sessiÃ³ i demana al servei que desi les dades.
 */
export async function saveCampaignAction(
  campaignData: Partial<Campaign>,
  goal: string,
) {
  // 1. ValidaciÃ³ de sessiÃ³
  const sessionResult = await validateUserSession();
  if ('error' in sessionResult) {
    return { data: null, error: sessionResult.error };
  }
  const { user, activeTeamId } = sessionResult;

  // 2. CreaciÃ³ del client de BBDD
  const supabase = createSupabaseServerClient();

  // 3. Crida al servei
  const { data, error } = await marketingService.saveCampaign(
    supabase,
    activeTeamId,
    user.id,
    campaignData,
    goal,
  );

  if (error) {
    console.error('Error en desar la campanya (Service):', error);
    return { data: null, error: error.message };
  }

  // 4. Efecte secundari
  revalidatePath('/comunicacio/marketing');
  
  // 5. Retornar dades
  return { data, error: null };
}

/**
 * @summary Actualitza una campanya.
 * @description Valida la sessiÃ³ i demana al servei que actualitzi les dades.
 */
export async function updateCampaignAction(
  campaignId: string,
  name: string,
  content: string,
) {
  // 1. ValidaciÃ³ de sessiÃ³
  const sessionResult = await validateUserSession();
  if ('error' in sessionResult) {
    return { data: null, error: sessionResult.error };
  }
  const { activeTeamId } = sessionResult;

  // 2. CreaciÃ³ del client de BBDD
  const supabase = createSupabaseServerClient();

  // 3. Crida al servei
  const { error } = await marketingService.updateCampaign(
    supabase,
    campaignId,
    { name, content },
    activeTeamId,
  );

  if (error) {
    console.error('Error en actualitzar la campanya (Service):', error);
    return { error: error.message };
  }

  // 4. Efecte secundari
  revalidatePath('/comunicacio/marketing');
  
  // 5. Retornar dades
  return { error: null };
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/marketing/page.tsx ===================

/**
 * @file page.tsx (Marketing)
 * @summary Punt d'entrada per a la pÃ gina de MÃ rqueting, implementant React Suspense.
 */

import { Suspense } from 'react';
import type { Metadata } from 'next';
import { MarketingData } from './_components/MarketingData';
import { MarketingSkeleton } from './_components/MarketingSkeleton';

// Les metadades es queden igual.
export const metadata: Metadata = {
  title: 'Marketing | Ribot',
};

// --- DefiniciÃ³ de Tipus de Dades ---
// Aquests tipus asseguren la consistÃ¨ncia de les dades entre el servidor, el client i la base de dades.

/**
* @function MarketingPage
* @summary Aquesta pÃ gina ja no Ã©s 'async'. Mostra un esquelet de cÃ rrega
* mentre el component 'MarketingData' va a buscar les dades al servidor.
*/
export default function MarketingPage() {
 return (
   <Suspense fallback={<MarketingSkeleton />}>
     <MarketingData />
   </Suspense>
 );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/marketing/_components/AICampaignWizard.tsx ===================

// UbicaciÃ³: /app/(app)/comunicacio/marketing/_components/AICampaignWizard.tsx

"use client";

import React from "react";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { AnimatePresence } from "framer-motion";
import { useTranslations } from 'next-intl';
import { Wand2 } from "lucide-react";

import { useAICampaignWizard } from "../_hooks/useAICampaignWizard";
import { WizardStep1_Goal } from "./wizard/WizardStep1_Goal";
import { WizardStep2_SelectStrategy } from "./wizard/WizardStep2_SelectStrategy";
import { WizardStep3_Finalize } from "./wizard/WizardStep3_Finalize";

interface AICampaignWizardProps {
    open: boolean;
    onOpenChange: (open: boolean) => void;
    onCampaignCreated: () => void;
}

const WizardProgressBar = ({ step }: { step: number }) => (
    <div className="flex items-center pt-4">
        {[1, 2, 3].map((s) => (
            <React.Fragment key={s}>
                <div className="flex flex-col items-center">
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center transition-all ${step >= s ? "bg-primary text-primary-foreground" : "bg-muted"}`}>
                        {s}
                    </div>
                </div>
                {s < 3 && <div className={`flex-1 h-0.5 transition-all ${step > s ? "bg-primary" : "bg-muted"}`} />}
            </React.Fragment>
        ))}
    </div>
);

export const AICampaignWizard: React.FC<AICampaignWizardProps> = ({ open, onOpenChange, onCampaignCreated }) => {
    const t = useTranslations('AICampaignWizard');
    const {
        step, goal, strategies, selectedStrategy, isPending, processingIndex,
        setStep, setGoal, setSelectedStrategy, resetWizard,
        handleGenerateStrategies, handleDraftContent, handleSaveCampaign
    } = useAICampaignWizard({
        onCampaignCreated,
        onClose: () => onOpenChange(false),
        t
    });

    return (
        <Dialog open={open} onOpenChange={(isOpen) => { if (!isOpen) resetWizard(); onOpenChange(isOpen); }}>
            <DialogContent className="max-w-2xl min-h-[400px]">
                <DialogHeader>
                    <DialogTitle className="flex items-center gap-2 text-2xl">
                        <Wand2 className="text-primary" /> {t('title')}
                    </DialogTitle>
                    <WizardProgressBar step={step} />
                </DialogHeader>

                <AnimatePresence mode="wait">
                    {step === 1 && (
                        <WizardStep1_Goal
                            goal={goal}
                            setGoal={setGoal}
                            onGenerate={handleGenerateStrategies}
                            isPending={isPending}
                            t={t}
                        />
                    )}

                    {step === 2 && (
                        <WizardStep2_SelectStrategy
                            strategies={strategies}
                            onSelect={handleDraftContent}
                            onBack={() => setStep(1)}
                            isPending={isPending}
                            processingIndex={processingIndex}
                            t={t}
                        />
                    )}

                    {step === 3 && selectedStrategy && (
                        <WizardStep3_Finalize
                            strategy={selectedStrategy}
                            // âœ… CORRECCIÃ“: Passem directament la funciÃ³ 'setSelectedStrategy'
                            // que ve del hook 'useState'.
                            onStrategyChange={setSelectedStrategy}
                            onSave={handleSaveCampaign}
                            onBack={() => setStep(2)}
                            isPending={isPending}
                            t={t}
                        />
                    )}
                </AnimatePresence>
            </DialogContent>
        </Dialog>
    );
};

// =================== FILE: src/app/[locale]/(app)/comunicacio/marketing/_components/CampaignCalendar.tsx ===================

/**
 * @file CampaignCalendar.tsx
 */

"use client";

import React, { useState, useMemo, FC } from 'react';
import { Button } from '@/components/ui/button';
import { ChevronLeft, ChevronRight } from 'lucide-react';
import { format, startOfMonth, endOfMonth, startOfWeek, endOfWeek, eachDayOfInterval, isSameMonth, isSameDay, addMonths, subMonths } from 'date-fns';
import { ca, es, enUS } from 'date-fns/locale';
import { type Campaign } from './MarketingData'; 
import { useLocale, useTranslations } from 'next-intl';

interface CampaignCalendarProps {
  campaigns: Campaign[]; 
  onCampaignSelect: (campaign: Campaign) => void; 
}

export const CampaignCalendar: FC<CampaignCalendarProps> = ({ campaigns, onCampaignSelect }) => {
  const [currentMonth, setCurrentMonth] = useState(new Date());
  const t = useTranslations('CampaignCalendar');
  const locale = useLocale();

  const monthStart = startOfMonth(currentMonth);
  const monthEnd = endOfMonth(monthStart);
  const startDate = startOfWeek(monthStart, { weekStartsOn: 1 }); 
  const endDate = endOfWeek(monthEnd, { weekStartsOn: 1 });
  const days = eachDayOfInterval({ start: startDate, end: endDate });

  const campaignsByDate = useMemo(() => {
    return campaigns.reduce((acc, campaign) => {
      const date = format(new Date(campaign.campaign_date), 'yyyy-MM-dd');
      if (!acc[date]) acc[date] = [];
      acc[date].push(campaign);
      return acc;
    }, {} as Record<string, Campaign[]>);
  }, [campaigns]);

  const getDateLocale = () => {
    switch (locale) {
      case 'es': return es;
      case 'en': return enUS;
      default: return ca;
    }
  }

  const daysOfWeek = [
    t('daysOfWeek.monday'), t('daysOfWeek.tuesday'), t('daysOfWeek.wednesday'),
    t('daysOfWeek.thursday'), t('daysOfWeek.friday'), t('daysOfWeek.saturday'),
    t('daysOfWeek.sunday')
  ];

  return (
        // âœ… CANVI: Reemplacem 'glass-effect' per 'bg-card' i 'border'
        <div className="bg-card border rounded-xl p-4">
          <div className="flex justify-between items-center mb-4">
            <Button variant="ghost" size="icon" onClick={() => setCurrentMonth(subMonths(currentMonth, 1))}><ChevronLeft /></Button>
            <h3 className="text-lg font-semibold capitalize">{format(currentMonth, "MMMM yyyy", { locale: getDateLocale() })}</h3>
            <Button variant="ghost" size="icon" onClick={() => setCurrentMonth(addMonths(currentMonth, 1))}><ChevronRight /></Button>
          </div>
          
          <div className="grid grid-cols-7 gap-1 text-center text-xs text-muted-foreground">
            {daysOfWeek.map(day => <div key={day} className="font-bold">{day}</div>)}
          </div>
          
          <div className="grid grid-cols-7 gap-1 mt-2">
            {days.map(day => {
                // Definim els colors del dia de forma mÃ©s robusta
                const isToday = isSameDay(day, new Date());
                const isCurrentMonth = isSameMonth(day, monthStart);

                // âœ… CANVI: Fons semÃ ntics.
                // 'bg-transparent' (per al mes actual) o 'bg-muted/50' (per a dies fora del mes)
                const dayBgClass = isCurrentMonth ? 'bg-transparent' : 'bg-muted/50';
                
                // âœ… CANVI: Colors de text semÃ ntics.
                const dayTextClass = isToday 
                    ? 'font-bold text-primary' 
                    : isCurrentMonth 
                        ? 'text-foreground' 
                        : 'text-muted-foreground';

                return (
                    <div key={day.toString()} className={`h-24 rounded-lg p-1 overflow-hidden ${dayBgClass}`}>
                        <time dateTime={format(day, 'yyyy-MM-dd')} className={`text-xs ${dayTextClass}`}>
                            {format(day, 'd')}
                        </time>
                        <div className="mt-1 space-y-1">
                            {(campaignsByDate[format(day, 'yyyy-MM-dd')] || []).map(campaign => (
                                // âœ… CANVI: Colors adaptables per a l'esdeveniment
                                <div 
                                    key={campaign.id} 
                                    onClick={() => onCampaignSelect(campaign)} 
                                    className="text-xs bg-primary/10 text-primary dark:bg-primary/20 dark:text-primary-foreground p-1 rounded truncate cursor-pointer hover:bg-primary/20 dark:hover:bg-primary/30"
                                >
                                    {campaign.name}
                                </div>
                            ))}
                        </div>
                    </div>
                );
            })}
          </div>
        </div>
      );
    };

// =================== FILE: src/app/[locale]/(app)/comunicacio/marketing/_components/CampaignDetailDialog.tsx ===================

// UbicaciÃ³: /app/(app)/comunicacio/marketing/_components/CampaignDetailDialog.tsx

"use client";

import React, { useState, useEffect, useTransition, FC } from 'react';
import { toast } from "sonner";
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import { Badge } from '@/components/ui/badge';
import { Loader2 } from 'lucide-react';
import { type Campaign } from './MarketingData';
import { updateCampaignAction } from '../actions';
import { format } from 'date-fns';
import { ca, es, enUS } from 'date-fns/locale';
import { useTranslations } from 'next-intl';
import { useLocale } from 'next-intl';

interface CampaignDetailDialogProps {
    campaign: Campaign | null;
    open: boolean;
    onOpenChange: (open: boolean) => void;
    onCampaignUpdated: () => void;
}

export const CampaignDetailDialog: FC<CampaignDetailDialogProps> = ({ campaign, open, onOpenChange, onCampaignUpdated }) => {
    const t = useTranslations('Marketing');
    const locale = useLocale();

    const [editedCampaign, setEditedCampaign] = useState<Campaign | null>(null);
    const [isPending, startTransition] = useTransition();

    useEffect(() => {
        // âœ… CORRECCIÃ“: NomÃ©s actualitzem l'estat intern si la 'prop' 'campaign' canvia.
        // AixÃ² evita que l'estat local es reseteji a cada render.
        setEditedCampaign(campaign);
    }, [campaign]);

    const handleSave = () => {
        if (!editedCampaign) return;
        startTransition(async () => {
            // âœ… CORRECCIÃ“: 'editedCampaign.id' Ã©s 'number',
            // perÃ² la teva acciÃ³ 'updateCampaignAction' espera un 'string'.
            // HaurÃ­em de corregir l'ACCIÃ“ perquÃ¨ accepti 'number',
            // perÃ² si no podem, fem la conversiÃ³ aquÃ­:
            const { error } = await updateCampaignAction(
                String(editedCampaign.id), // Convertim number a string
                editedCampaign.name,
                editedCampaign.content ?? '' // Assegurem que no sigui null
            );
            if (error) {
                toast.error('Error', { description: t('toastErrorUpdate') });
            } else {
                toast.success('Ãˆxit!', { description: t('toastSuccessUpdate') });
                onCampaignUpdated();
                onOpenChange(false);
            }
        });
    };
    const getDateLocale = () => {
        switch (locale) {
            case 'es': return es;
            case 'en': return enUS;
            default: return ca;
        }
    }

    // âœ… CORRECCIÃ“: No fem un retorn anticipat de 'null' si la campanya no existeix.
    // El component Dialog s'encarrega de no renderitzar el contingut si 'open' Ã©s fals.
    // AixÃ² garanteix que les animacions de sortida del diÃ leg funcionin correctament.

    return (
        <Dialog open={open} onOpenChange={onOpenChange}>
            <DialogContent className="max-w-2xl min-h-[400px]">
                {/* NomÃ©s renderitzem el contingut si tenim una campanya per editar */}
                {editedCampaign && (
                    <>
                        <DialogHeader>
                            <DialogTitle className="text-2xl">{t('detailDialogTitle')}</DialogTitle>
                            <div className="flex items-center gap-4 pt-2 text-sm text-muted-foreground">
                                <Badge variant="outline" className={undefined}>{editedCampaign.type}</Badge>
                                <span>|</span>
                                <span>{t('detailDialogScheduledFor')}: {format(new Date(editedCampaign.campaign_date), "d MMMM yyyy", { locale: getDateLocale() })}</span>
                            </div>
                        </DialogHeader>
                        <div className="flex-1 flex flex-col gap-6 overflow-y-auto pr-2 py-4">
                            <div className="space-y-2">
                                <Label htmlFor="campaignName" className="font-semibold">{t('detailDialogNameLabel')}</Label>
                                <Input
                                    id="campaignName"
                                    value={editedCampaign.name}
                                    onChange={(e) => setEditedCampaign(c => c ? { ...c, name: e.target.value } : null)}
                                    className="text-lg"
                                />
                            </div>
                            <div className="space-y-2">
                                <Label htmlFor="campaignAudience" className="font-semibold">{t('detailDialogAudienceLabel')}</Label>
                                <Input
                                    id="campaignAudience"
                                    // âœ… CORRECCIÃ“: Un <Input> no pot acceptar 'null'. Donem un 'fallback' a string buit.
                                    value={editedCampaign.target_audience ?? ''}
                                    disabled
                                />
                            </div>
                            <div className="space-y-2 flex-1 flex flex-col">
                                <Label htmlFor="campaignContent" className="font-semibold">{t('detailDialogContentLabel')}</Label>
                                <Textarea
                                    id="campaignContent"
                                    // âœ… CORRECCIÃ“: Un <Textarea> no pot acceptar 'null'.
                                    value={editedCampaign.content ?? ''}
                                    onChange={(e) => setEditedCampaign(c => c ? { ...c, content: e.target.value } : null)}
                                    className="flex-1 text-base"
                                    rows={15}
                                />
                            </div>
                        </div>
                        <DialogFooter className="pt-4 border-t border-border">
                            <Button variant="ghost" onClick={() => onOpenChange(false)}>Tancar</Button>
                            <Button onClick={handleSave} disabled={isPending}>
                                {isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                                {t('saveChangesButton')}
                            </Button>
                        </DialogFooter>
                    </>
                )}
            </DialogContent>
        </Dialog>
    );
};

// =================== FILE: src/app/[locale]/(app)/comunicacio/marketing/_components/CampaignList.tsx ===================

// /app/(app)/comunicacio/marketing/_components/CampaignList.tsx
"use client";

import React, { FC } from 'react';
import { Badge } from '@/components/ui/badge';
import { format } from 'date-fns';
import { ca, es, enUS } from 'date-fns/locale';
import { useLocale, useTranslations } from 'next-intl';
import type { Campaign } from './MarketingData'; 

// âœ… CANVI: Definim colors per al mode clar (per defecte) i afegim variants 'dark:'.
// Ara els badges tindran alt contrast en tots dos temes.
const statusColors: Record<string, string> = { 
    'Completat': 'bg-green-100 text-green-800 border border-green-200 dark:bg-green-500/20 dark:text-green-300 dark:border-green-500/30',
    'Actiu': 'bg-blue-100 text-blue-800 border border-blue-200 dark:bg-blue-500/20 dark:text-blue-300 dark:border-blue-500/30',
    'Planificat': 'bg-yellow-100 text-yellow-800 border border-yellow-200 dark:bg-yellow-500/20 dark:text-yellow-300 dark:border-yellow-500/30',
    'default': 'bg-gray-100 text-gray-800 border border-gray-200 dark:bg-gray-500/20 dark:text-gray-300 dark:border-gray-500/30'
};

interface CampaignListProps {
  campaigns: Campaign[];
  onCampaignSelect: (campaign: Campaign) => void;
}

export const CampaignList: FC<CampaignListProps> = ({ campaigns, onCampaignSelect }) => {
  const t = useTranslations('Marketing');
  const locale = useLocale();
  
  const getDateLocale = () => {
    switch(locale) {
      case 'es': return es;
      case 'en': return enUS;
      default: return ca;
    }
  }

  return (
    // âœ… CANVI: Reemplacem 'glass-effect' per 'bg-card' i 'border'
    <div className="bg-card border rounded-xl overflow-hidden">
      <table className="w-full text-left">
        {/* âœ… CANVI: Reemplacem 'bg-white/5' per 'bg-muted' */}
        <thead className="bg-muted">
            {/* âœ… CANVI: Usem 'border-border' */}
            <tr className="border-b border-border">
                <th className="p-4 font-semibold">{t('campaignListHeader')}</th>
                <th className="p-4 font-semibold hidden md:table-cell">{t('typeListHeader')}</th>
                <th className="p-4 font-semibold">{t('statusListHeader')}</th>
                <th className="p-4 font-semibold hidden md:table-cell">{t('dateListHeader')}</th>
            </tr>
        </thead>
        <tbody>
          {campaigns.map(c => (
            // âœ… CANVI: 'border-border' i fons 'hover:bg-muted/50' (mÃ©s subtil que 'bg-muted')
            <tr 
                key={c.id} 
                className="border-t border-border hover:bg-muted/50 transition-colors cursor-pointer" 
                onClick={() => onCampaignSelect(c)}
            >
              <td className="p-4 font-medium">{c.name}</td>
              {/* âœ… CANVI: Usem 'text-muted-foreground' */}
              <td className="p-4 text-muted-foreground hidden md:table-cell">{c.type}</td>
              <td className="p-4">
                <Badge 
                    // Les classes ara s'apliquen correctament
                    className={statusColors[c.status ?? 'default'] || statusColors['default']} 
                    // Important: resetejem la variant de shadcn per aplicar els nostres estils
                    variant="outline" 
                >
                  {c.status ?? 'N/A'}
                </Badge>
              </td>
              {/* âœ… CANVI: Usem 'text-muted-foreground' */}
              <td className="p-4 text-muted-foreground hidden md:table-cell">
                  {format(new Date(c.campaign_date), "d MMM, yyyy", { locale: getDateLocale() })}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
};

// =================== FILE: src/app/[locale]/(app)/comunicacio/marketing/_components/marketing-client.tsx ===================

// UbicaciÃ³: /app/(app)/comunicacio/marketing/_components/MarketingClient.tsx
"use client";

import React from 'react';
import { motion } from 'framer-motion';
import { useTranslations } from 'next-intl';
import { Button } from '@/components/ui/button';
import { Sparkles, List, Calendar, Target, BarChart2, CheckCircle } from 'lucide-react';

import { useMarketing } from '../_hooks/useMarketing';
import type { Campaign, Kpis } from './MarketingData';

import { MetricCard } from './MetricCard';
import { CampaignList } from './CampaignList';
import { CampaignCalendar } from './CampaignCalendar';
import { CampaignDetailDialog } from './CampaignDetailDialog';
import { AICampaignWizard } from './AICampaignWizard';


export function MarketingClient({ initialKpis, initialCampaigns }: { initialKpis: Kpis, initialCampaigns: Campaign[] }) {
    const t = useTranslations('Marketing');
    const {
        view,
        isWizardOpen,
        selectedCampaign,
        setView,
        setIsWizardOpen,
        handleRefreshData,
        handleOpenWizard,
        handleSelectCampaign,
    } = useMarketing();

    return (
        <>
            <AICampaignWizard
                open={isWizardOpen}
                onOpenChange={setIsWizardOpen}
                onCampaignCreated={handleRefreshData}
            />
            <CampaignDetailDialog
                open={!!selectedCampaign}
                onOpenChange={(isOpen) => !isOpen && handleSelectCampaign(null)}
                campaign={selectedCampaign}
                onCampaignUpdated={handleRefreshData}
            />

            <motion.div initial={{ opacity: 0, y: -20 }} animate={{ opacity: 1, y: 0 }} className="space-y-8">
                <div className="flex justify-between items-center">
                    <h1 className="text-3xl font-bold">{t('title')}</h1>
                    <Button onClick={handleOpenWizard}>
                        <Sparkles className="w-4 h-4 mr-2" /> {t('createCampaignButton')}
                    </Button>
                </div>

                <div className="flex flex-col md:flex-row gap-6">
                    {/* âœ… CANVI: Passem el component icona (Target) directament,
                        en lloc d'un element React (<Target className="..." />).
                        La 'MetricCard' ara s'encarrega d'afegir el color.
                    */}
                    <MetricCard title={t('kpiNewContacts')} value={initialKpis.totalLeads} icon={Target} />
                    <MetricCard title={t('kpiConversionRate')} value={`${initialKpis.conversionRate.toFixed(1)}%`} icon={CheckCircle} />
                    <MetricCard title={t('kpiInteraction')} value="N/A" icon={BarChart2} />
                </div>

                <div className="flex justify-between items-center mt-8">
                    <h2 className="text-2xl font-semibold">{t('yourCampaignsTitle')}</h2>
                    <div className="flex gap-2">
                        <Button variant={view === 'list' ? 'secondary' : 'ghost'} size="icon" onClick={() => setView('list')}><List className="h-4 w-4" /></Button>
                        <Button variant={view === 'calendar' ? 'secondary' : 'ghost'} size="icon" onClick={() => setView('calendar')}><Calendar className="h-4 w-4" /></Button>
                    </div>
                </div>

                {/* âœ… CANVI: Text semÃ ntic per al missatge de "no campanyes" */}
                {initialCampaigns.length === 0 ? (
                    <p className="text-center text-muted-foreground p-8">{t('noCampaignsMessage')}</p>
                ) : view === 'list' ? (
                    <CampaignList campaigns={initialCampaigns} onCampaignSelect={handleSelectCampaign} />
                ) : (
                    <CampaignCalendar campaigns={initialCampaigns} onCampaignSelect={handleSelectCampaign} />
                )}
            </motion.div>
        </>
    );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/marketing/_components/MarketingData.tsx ===================

// src/app/[locale]/(app)/comunicacio/marketing/_components/MarketingData.tsx

import { validatePageSession } from '@/lib/supabase/session';
import { MarketingClient } from './marketing-client';

// âœ… 1. Importem el nostre servei
import { marketingService } from '@/lib/services/comunicacio/marketing.service';

// âœ… 2. Importem els tipus des de la nostra font de la veritat
import type { Campaign, Kpis } from '@/types/comunicacio/marketing';

// âœ… 3. Re-exportem els tipus per al Client Component (bona prÃ ctica)
export type { Campaign, Kpis };

/**
 * @summary Component de servidor que obtÃ© les dades de mÃ rqueting
 * utilitzant el servei centralitzat.
 */
export async function MarketingData() {
Â  Â  const { supabase, activeTeamId } = await validatePageSession();

Â  Â  // âœ… 4. Cridem al servei en lloc de l'RPC directament
Â  Â  const { data, error } = await marketingService.getMarketingPageData(
Â  Â  Â  supabase,
Â  Â  Â  activeTeamId 
Â  Â  );

Â  Â  // âœ… 5. La gestiÃ³ d'errors Ã©s mÃ©s senzilla
Â  Â  // El servei ja ens retorna un 'fallbackData' si 'data' Ã©s nul,
Â  Â  // aixÃ­ que 'data' sempre hauria de ser un objecte vÃ lid si no hi ha error.
Â  Â  if (error || !data) {
Â  Â  Â  Â  console.error("Error en obtenir les dades de mÃ rqueting (MarketingData):", error);
Â  Â  Â  Â  // Retornem un estat buit en cas d'error
Â  Â  Â  Â  return <MarketingClient 
Â  Â  Â  Â  Â  Â  initialKpis={{ totalLeads: 0, conversionRate: 0 }} 
Â  Â  Â  Â  Â  Â  initialCampaigns={[]} 
Â  Â  Â  Â  />;
Â  Â  }
Â  Â  
Â  Â  // âœ… 6. Passem les dades netes del servei al client
Â  Â  return <MarketingClient 
Â  Â  Â  Â  initialKpis={data.kpis} 
Â  Â  Â  Â  initialCampaigns={data.campaigns} 
Â  Â  />;
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/marketing/_components/MarketingSkeleton.tsx ===================

"use client";

import React from 'react';

/**
 * @summary Mostra un esquelet de cÃ rrega per a la pÃ gina de MÃ rqueting.
 */
export const MarketingSkeleton: React.FC = () => (
    <div className="space-y-8 animate-pulse">
        {/* Esquelet per a la capÃ§alera */}
        <div className="flex justify-between items-center">
            <div className="h-9 bg-muted rounded-lg w-1/3"></div>
            <div className="h-10 bg-muted rounded-lg w-1/4"></div>
        </div>

        {/* Esquelet per a les targetes de KPI */}
        <div className="flex flex-col md:flex-row gap-6">
            <div className="h-24 bg-muted rounded-xl flex-1"></div>
            <div className="h-24 bg-muted rounded-xl flex-1"></div>
            <div className="h-24 bg-muted rounded-xl flex-1"></div>
        </div>

        {/* Esquelet per a la llista de campanyes */}
        <div className="flex justify-between items-center mt-8">
            <div className="h-8 bg-muted rounded-lg w-1/4"></div>
            <div className="flex gap-2">
                <div className="h-10 w-10 bg-muted rounded-lg"></div>
                <div className="h-10 w-10 bg-muted rounded-lg"></div>
            </div>
        </div>
        <div className="h-64 bg-muted rounded-xl"></div>
    </div>
);

// =================== FILE: src/app/[locale]/(app)/comunicacio/marketing/_components/MetricCard.tsx ===================

// UbicaciÃ³: /app/(app)/comunicacio/marketing/_components/MetricCard.tsx
"use client";

import React from 'react';
import { Card, CardContent } from '@/components/ui/card'; // âœ… Usem Card per semÃ ntica

interface MetricCardProps {
    title: string;
    value: string | number;
    // âœ… CANVI: Passem el component icona, no un node renderitzat.
    // AixÃ² ens dÃ³na control sobre els seus estils (color, mida) dins de la targeta.
    icon: React.ElementType; 
}

export const MetricCard: React.FC<MetricCardProps> = ({ title, value, icon: Icon }) => (
    // âœ… CANVI: Eliminem 'glass-effect' i fem servir 'Card' de shadcn.
    // 'bg-card' i 'border' s'adapten automÃ ticament al tema.
    <Card className="flex-1">
        <CardContent className="p-6">
            <div className="flex items-center gap-4">
                {/* âœ… CANVI: Fons i color de text semÃ ntics.
                    - Mode Clar: bg-primary/10 (ex: lila molt clar), text-primary (ex: lila fosc)
                    - Mode Fosc: bg-primary/20 (ex: lila fosc tÃ¨nue), text-primary (ex: lila clar)
                */}
                <div className="bg-primary/10 dark:bg-primary/20 p-3 rounded-lg">
                    <Icon className="w-6 h-6 text-primary" />
                </div>
                <div>
                    {/* âœ… CANVI: Usem 'text-muted-foreground' per al tÃ­tol.
                        - Mode Clar: Gris fosc
                        - Mode Fosc: Gris clar
                    */}
                    <p className="text-muted-foreground text-sm">{title}</p>
                    {/* âœ… CANVI: Usem 'text-foreground' per al valor.
                        - Mode Clar: Negre/Gris molt fosc
                        - Mode Fosc: Blanc/Gris molt clar
                    */}
                    <p className="text-2xl font-bold text-foreground">{value}</p>
                </div>
            </div>
        </CardContent>
    </Card>
);

// =================== FILE: src/app/[locale]/(app)/comunicacio/marketing/_components/wizard/WizardStep1_Goal.tsx ===================

// UbicaciÃ³: /app/(app)/comunicacio/marketing/_components/wizard/WizardStep1_Goal.tsx

import { motion } from "framer-motion";
import { Button } from "@/components/ui/button";
import { DialogDescription, DialogFooter } from "@/components/ui/dialog";
import { Textarea } from "@/components/ui/textarea";
import { Sparkles, Loader2 } from "lucide-react";

interface Props {
    goal: string;
    setGoal: (value: string) => void;
    onGenerate: () => void;
    isPending: boolean;
    t: (key: string) => string;
}

export const WizardStep1_Goal = ({ goal, setGoal, onGenerate, isPending, t }: Props) => (
    <motion.div key="step1" initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -20 }}>
        <DialogDescription>{t('step1Description')}</DialogDescription>
        <Textarea
            placeholder={t('step1Placeholder')}
            value={goal}
            onChange={(e) => setGoal(e.target.value)}
            className="my-4"
            rows={4}
        />
        <DialogFooter>
            <Button onClick={onGenerate} disabled={isPending || !goal.trim()}>
                {isPending ? <Loader2 className="animate-spin mr-2" /> : <Sparkles className="mr-2 h-4 w-4" />}
                {t('generateStrategiesButton')}
            </Button>
        </DialogFooter>
    </motion.div>
);

// =================== FILE: src/app/[locale]/(app)/comunicacio/marketing/_components/wizard/WizardStep2_SelectStrategy.tsx ===================

// UbicaciÃ³: /app/(app)/comunicacio/marketing/_components/wizard/WizardStep2_SelectStrategy.tsx

import { motion } from "framer-motion";
import { Button } from "@/components/ui/button";
import { DialogDescription, DialogFooter } from "@/components/ui/dialog";
import { Badge } from "@/components/ui/badge";
import { Loader2, Lightbulb, Users, ChevronLeft } from "lucide-react";

// El tipus 'Strategy' hauria d'estar en un fitxer compartit, perÃ² el definim aquÃ­ per claredat.
interface Strategy {
    name: string;
    type: string;
    target_audience: string;
    description: string;
}

interface Props {
    strategies: Strategy[];
    onSelect: (strategy: Strategy, index: number) => void;
    onBack: () => void;
    isPending: boolean;
    processingIndex: number | null;
    t: (key: string) => string;
}

export const WizardStep2_SelectStrategy = ({ strategies, onSelect, onBack, isPending, processingIndex, t }: Props) => (
    <motion.div key="step2" initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -20 }}>
        <DialogDescription>{t('step2Description')}</DialogDescription>

        <div className="my-4 space-y-3 max-h-[50vh] overflow-y-auto p-1">
            {strategies.map((s, i) => (
                <div
                    key={i}
                    className={`p-4 border border-border rounded-lg transition-all ${isPending && processingIndex !== i ? "opacity-50 cursor-not-allowed" : "hover:border-primary cursor-pointer"}`}
                    onClick={() => !isPending && onSelect(s, i)}
                >
                    {isPending && processingIndex === i ? (
                        <div className="flex items-center justify-center py-4">
                            <Loader2 className="animate-spin text-primary" />
                            <span className="ml-2">{t('creatingMagic')}</span>
                        </div>
                    ) : (
                        <>
                            <h3 className="font-semibold flex items-center gap-2">
                                <Lightbulb className="text-yellow-400 h-4 w-4" /> {s.name} <Badge variant="outline" className={undefined}>{s.type}</Badge>
                            </h3>
                            <p className="text-sm text-muted-foreground mt-1">
                                <Users className="inline h-4 w-4 mr-1" /> {s.target_audience}
                            </p>
                            <p className="text-sm mt-2">{s.description}</p>
                        </>
                    )}
                </div>
            ))}
        </div>
        <DialogFooter>
            <Button variant="ghost" onClick={onBack}>
                <ChevronLeft className="mr-2 h-4 w-4" /> {t('backButton')}
            </Button>
        </DialogFooter>
    </motion.div>
);

// =================== FILE: src/app/[locale]/(app)/comunicacio/marketing/_components/wizard/WizardStep3_Finalize.tsx ===================

// UbicaciÃ³: /app/(app)/comunicacio/marketing/_components/wizard/WizardStep3_Finalize.tsx

import { motion } from "framer-motion";
import { Button } from "@/components/ui/button";
import { DialogDescription, DialogFooter } from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Loader2} from "lucide-react";
import type { SetStateAction } from 'react';

// âœ… CORRECCIÃ“: Aquest tipus ha de ser el mateix que s'utilitza en el hook.
// Si Strategy tÃ© camps opcionals, els mantenim.
interface Strategy {
    name: string;
    type: string;
    target_audience: string;
    description: string;
    content?: string;
}

interface Props {
    // âœ… CORRECCIÃ“: Fem servir el tipus 'Strategy' complet.
    strategy: Strategy;
    // âœ… CORRECCIÃ“: El tipus ha de coincidir exactament.
    onStrategyChange: (value: SetStateAction<Strategy | null>) => void;
    onSave: () => void;
    onBack: () => void;
    isPending: boolean;
    t: (key: string) => string;
}

export const WizardStep3_Finalize = ({ strategy, onStrategyChange, onSave, onBack, isPending, t }: Props) => (
    <motion.div key="step3" initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} exit={{ opacity: 0, x: -20 }}>
        <DialogDescription>{t('step3Description')}</DialogDescription>

        <div className="my-4 space-y-4">
            <Input
                value={strategy.name}
                onChange={(e) => onStrategyChange(prev => prev ? { ...prev, name: e.target.value } : null)}
                className="text-lg font-bold"
            />
            <Textarea
                value={strategy.content ?? ""}
                onChange={(e) => onStrategyChange(prev => prev ? { ...prev, content: e.target.value } : null)}
                className="h-[40vh] text-base"
            />
        </div>
        <DialogFooter>
            <Button variant="ghost" onClick={onBack}>{t('backButton')}</Button>
            <Button onClick={onSave} disabled={isPending}>
                {isPending && <Loader2 className="animate-spin mr-2" />} {t('saveCampaignButton')}
            </Button>
        </DialogFooter>
    </motion.div>
);

// =================== FILE: src/app/[locale]/(app)/comunicacio/marketing/_hooks/useAICampaignWizard.ts ===================

// UbicaciÃ³: /app/(app)/comunicacio/marketing/_hooks/useAICampaignWizard.ts

import { useState, useTransition } from "react";
import { toast } from "sonner";
import { generateStrategiesAction, draftContentAction, saveCampaignAction } from "../actions";

// Tipus per a les estratÃ¨gies
interface Strategy {
    name: string;
    type: string;
    target_audience: string;
    description: string;
    content?: string;
}

// Propietats que rep el hook
interface UseAICampaignWizardProps {
    onCampaignCreated: () => void;
    onClose: () => void;
    t: (key: string) => string;
}

export function useAICampaignWizard({ onCampaignCreated, onClose, t }: UseAICampaignWizardProps) {
    const [step, setStep] = useState(1);
    const [goal, setGoal] = useState("");
    const [strategies, setStrategies] = useState<Strategy[]>([]);
    const [selectedStrategy, setSelectedStrategy] = useState<Strategy | null>(null);
    const [isPending, startTransition] = useTransition();
    const [processingIndex, setProcessingIndex] = useState<number | null>(null);

    const resetWizard = () => {
        setStep(1);
        setGoal("");
        setStrategies([]);
        setSelectedStrategy(null);
        setProcessingIndex(null);
    };

    const handleGenerateStrategies = () => {
        if (!goal.trim()) return;
        startTransition(async () => {
            const { data, error } = await generateStrategiesAction(goal);
            if (error) {
                toast.error(t('toastErrorAI'), { description: error });
            } else {
                setStrategies(data || []);
                setStep(2);
            }
        });
    };

    const handleDraftContent = (strategy: Strategy, index: number) => {
        setProcessingIndex(index);
        startTransition(async () => {
            const { data, error } = await draftContentAction(goal, strategy);
            if (error) {
                toast.error(t('toastErrorAI'), { description: error });
            } else {
                setSelectedStrategy({ ...strategy, content: data || "" });
                setStep(3);
            }
            setProcessingIndex(null);
        });
    };

    const handleSaveCampaign = () => {
        if (!selectedStrategy) return;
        startTransition(async () => {
            const { error } = await saveCampaignAction(selectedStrategy, goal);
            if (error) {
                toast.error(t('toastErrorSave'), { description: t('toastErrorSaveDescription') });
            } else {
                toast.success(t('toastSuccessSave'), { description: t('toastSuccessSaveDescription') });
                onCampaignCreated();
                onClose();
                resetWizard();
            }
        });
    };

    return {
        step,
        goal,
        strategies,
        selectedStrategy,
        isPending,
        processingIndex,
        setStep,
        setGoal,
        setSelectedStrategy,
        resetWizard,
        handleGenerateStrategies,
        handleDraftContent,
        handleSaveCampaign
    };
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/marketing/_hooks/useMarketing.ts ===================

// UbicaciÃ³: /app/(app)/comunicacio/marketing/_hooks/useMarketing.ts

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import type { Campaign } from '../_components/MarketingData';

export function useMarketing() {
    const router = useRouter();
    const [view, setView] = useState<'list' | 'calendar'>('list');
    const [isWizardOpen, setIsWizardOpen] = useState(false);
    const [selectedCampaign, setSelectedCampaign] = useState<Campaign | null>(null);

    const handleRefreshData = () => {
        router.refresh();
    };

    const handleOpenWizard = () => setIsWizardOpen(true);
    
    const handleCloseWizard = () => setIsWizardOpen(false);

    const handleSelectCampaign = (campaign: Campaign | null) => {
        setSelectedCampaign(campaign);
    };

    return {
        view,
        isWizardOpen,
        selectedCampaign,
        setView,
        setIsWizardOpen,
        handleRefreshData,
        handleOpenWizard,
        handleCloseWizard,
        handleSelectCampaign,
    };
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/planificador/actions.ts ===================

// src/app/[locale]/(app)/comunicacio/planificador/actions.ts
"use server";

import { revalidatePath } from "next/cache";
import { getTranslations } from "next-intl/server";
import { validateSessionAndPermission, PERMISSIONS } from "@/lib/permissions/permissions";
import { type ActionResult } from "@/types/shared/index";

// âœ… CANVI: Importem el tipus des de la font de la veritat
import type { SocialPost } from "@/types/db"; 

// âœ… NOU: Importem el nostre servei
import * as socialPlannerService from "@/lib/services/comunicacio/socialPlanner.service";


/**
Â * FunciÃ³ d'ajuda interna per a validar la sessiÃ³ i els permisos.
Â * (Es queda aquÃ­ perquÃ¨ gestiona i18n i la sessiÃ³, propis de l'Action)
Â */
async function validateSocialPlannerPermissions() {
Â  Â  const validationResult = await validateSessionAndPermission(PERMISSIONS.MANAGE_INTEGRATIONS);

Â  Â  if ('error' in validationResult) {
Â  Â  Â  Â  const t = await getTranslations('Errors');
Â  Â  Â  Â  return { error: t('permissionDenied') };
Â  Â  }
Â  Â  return validationResult;
}
// ----------------------------------------------------------------------------------

/**
Â * ACCIÃ“: Crea una URL de pujada signada (presigned URL).
Â */
export async function getPresignedUploadUrlAction(fileNames: string[]): Promise<ActionResult<{ signedUrls: { signedUrl: string; path: string; }[] }>> {
Â  Â  
Â  Â  const validation = await validateSocialPlannerPermissions();
Â  Â  if ('error' in validation) {
Â  Â  Â  Â  return { success: false, message: validation.error };
Â  Â  }
Â  Â  const { supabase, user, activeTeamId } = validation;

Â  Â  if (!activeTeamId) {
Â  Â  Â  Â return { success: false, message: "Equip actiu no trobat." };
Â  Â  }

Â  Â  try {
        // âœ… Cridem al servei
Â  Â  Â  Â  const { signedUrls } = await socialPlannerService.getPresignedUploadUrls(
Â  Â  Â  Â  Â  Â  supabase,
Â  Â  Â  Â  Â  Â  fileNames,
Â  Â  Â  Â  Â  Â  user.id,
Â  Â  Â  Â  Â  Â  activeTeamId
Â  Â  Â  Â  );
Â  Â  Â  Â  return { success: true, message: "URLs creades.", data: { signedUrls } };
Â  Â  } catch (err: unknown) {
Â  Â  Â  Â  const message = err instanceof Error ? err.message : "Error desconegut creant URLs signades.";
Â  Â  Â  Â  return { success: false, message };
Â  Â  }
}

/**
Â * ACCIÃ“: Crea un registre de publicaciÃ³ en esborrany.
Â */
export async function createSocialPostAction(
Â  Â  content: string,
Â  Â  providers: string[],
Â  Â  mediaPaths: string[] | null,
Â  Â  mediaType: string | null
): Promise<ActionResult<SocialPost>> {
Â  Â  const validation = await validateSocialPlannerPermissions();
Â  Â  if ('error' in validation) {
Â  Â  Â  Â  return { success: false, message: validation.error };
Â  Â  }
Â  Â  const { supabase, user, activeTeamId } = validation;
Â  Â  const t = await getTranslations('Planificador.toasts');

Â  Â  try {
        // âœ… Cridem al servei
Â  Â  Â  Â  const postData = await socialPlannerService.createSocialPost(
Â  Â  Â  Â  Â  Â  supabase,
Â  Â  Â  Â  Â  Â  content,
Â  Â  Â  Â  Â  Â  providers,
Â  Â  Â  Â  Â  Â  mediaPaths,
Â  Â  Â  Â  Â  Â  mediaType,
Â  Â  Â  Â  Â  Â  user.id,
Â  Â  Â  Â  Â  Â  activeTeamId
Â  Â  Â  Â  );

Â  Â  Â  Â  revalidatePath('/comunicacio/planificador');
Â  Â  Â  Â  return { success: true, message: t('successDraftCreated'), data: postData };
Â  Â  } catch (error: unknown) {
Â  Â  Â  Â  console.error("Error creant la publicaciÃ³ (action):", error);
Â  Â  Â  Â  return { success: false, message: (error as Error).message || t('errorPostCreation') };
Â  Â  }
}

/**
Â * ACCIÃ“: Planifica una publicaciÃ³.
Â */
export async function scheduleSocialPostAction(postId: number, scheduledAt: string): Promise<ActionResult> {
Â  Â  const validation = await validateSocialPlannerPermissions();
Â  Â  if ('error' in validation) return { success: false, message: validation.error };
Â  Â  const { supabase } = validation;
Â  Â  const t = await getTranslations('Planificador.toasts');

Â  Â  try {
        // âœ… Cridem al servei
Â  Â  Â  Â  await socialPlannerService.scheduleSocialPost(supabase, postId, scheduledAt);
Â  Â  Â  Â  revalidatePath('/comunicacio/planificador');
Â  Â  Â  Â  return { success: true, message: t('successScheduled') };
Â  Â  } catch (error: unknown) {
Â  Â  Â  Â  console.error("Error planificant la publicaciÃ³ (action):", error);
Â  Â  Â  Â  return { success: false, message: (error as Error).message || t('errorScheduling') };
Â  Â  }
}

/**
Â * ACCIÃ“: Retorna una publicaciÃ³ a l'estat d'esborrany.
Â */
export async function unscheduleSocialPostAction(postId: number): Promise<ActionResult> {
Â  Â  const validation = await validateSocialPlannerPermissions();
Â  Â  if ('error' in validation) return { success: false, message: validation.error };
Â  Â  const { supabase } = validation;
Â  Â  const t = await getTranslations('Planificador.toasts'); 
Â  Â  
Â  Â  try {
        // âœ… Cridem al servei
Â  Â  Â  Â  await socialPlannerService.unscheduleSocialPost(supabase, postId);
Â  Â  Â  Â  revalidatePath('/comunicacio/planificador');
Â  Â  Â  Â  return { success: true, message: t('successUnscheduled') };
Â  Â  } catch (error: unknown) {
Â  Â  Â  Â  console.error("Error desplanificant la publicaciÃ³ (action):", error);
Â  Â  Â  Â  return { success: false, message: (error as Error).message || t('errorUnscheduling') };
Â  Â  }
}

/**
Â * ACCIÃ“: Elimina una publicaciÃ³ social.
Â */
export async function deleteSocialPostAction(postId: number): Promise<ActionResult> {
Â  Â  const validation = await validateSocialPlannerPermissions();
Â  Â  if ('error' in validation) return { success: false, message: validation.error };
Â  Â  const { supabase } = validation;
Â  Â  const t = await getTranslations('Planificador.toasts');

Â  Â  try {
        // âœ… Cridem al servei
Â  Â  Â  Â  await socialPlannerService.deleteSocialPost(supabase, postId);
Â  Â  Â  Â  revalidatePath('/comunicacio/planificador');
Â  Â  Â  Â  return { success: true, message: t('successPostDeleted') };
Â  Â  } catch (error: unknown) {
Â  Â  Â  Â  console.error("Error eliminant la publicaciÃ³ (action):", error);
Â  Â  Â  Â  return { success: false, message: (error as Error).message || t('errorDeleting') };
Â  Â  }
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/planificador/page.tsx ===================


// Modifica la pÃ gina per usar el component de dades amb Suspense
// src/app/[locale]/(app)/comunicacio/planificador/page.tsx
import { Suspense } from 'react';
import { SocialPlannerData } from './_components/SocialPlannerData';
import { SocialPlannerSkeleton } from './_components/SocialPlannerSkeleton'; // Importa el Skeleton

export default function SocialPlannerPage() {
    // La comprovaciÃ³ de pla i sessiÃ³ ara es fa dins de SocialPlannerData
    return (
        <Suspense fallback={<SocialPlannerSkeleton />}>
            <SocialPlannerData />
        </Suspense>
    );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/planificador/types.ts ===================

// UbicaciÃ³: /app/(app)/comunicacio/planificador/types.ts (Fitxer nou)

export interface ConnectionStatuses {
    [key: string]: boolean;
    linkedin: boolean;
    facebook: boolean;
    instagram: boolean;
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/planificador/_components/CreatePostDialog.tsx ===================

//* eslint-disable react/jsx-no-undef */
// UbicaciÃ³: /app/(app)/comunicacio/planificador/_components/CreatePostDialog.tsx
"use client";

import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';
import { Checkbox } from "@/components/ui/checkbox";
import { Label } from "@/components/ui/label";
import Image from 'next/image';
import { Link, Loader2, PlayCircle, Trash2 } from 'lucide-react';

import { useCreatePost } from '../_hooks/useCreatePost';
import type { SocialPost } from '@/types/db';
import { type ConnectionStatuses } from '../types'; // âœ… Importem el tipus centralitzat

interface CreatePostDialogProps {
    isOpen: boolean;
    onOpenChange: (isOpen: boolean) => void;
    onCreate: (newPost: SocialPost) => void;
    connectionStatuses: ConnectionStatuses;
    t: (key: string) => string;
}

export function CreatePostDialog({ isOpen, onOpenChange, onCreate, connectionStatuses, t }: CreatePostDialogProps) {
    const {
        content, setContent, previewUrls, selectedProviders, isPending,
        handleMediaChange, removeMedia, setSelectedProviders, handleSubmit, resetState,
        mediaFiles // <-- Add this line to destructure mediaFiles from the hook
    } = useCreatePost({
        isOpen,
        connectionStatuses,
        onCreate,
        onClose: () => onOpenChange(false),
        t
    });

    const handleClose = (open: boolean) => {
        if (!open) {
            resetState();
        }
        onOpenChange(open);
    };
    const hasAnyConnection = Object.values(connectionStatuses).some(status => status === true);

    return (
        <Dialog open={isOpen} onOpenChange={handleClose}>
            <DialogContent className="max-w-4xl h-[90vh] md:h-[80vh] flex flex-col">
                <DialogHeader><DialogTitle>{t('createDialogTitle')}</DialogTitle></DialogHeader>
                <div className="grid md:grid-cols-2 gap-6 p-1 md:p-4 flex-grow overflow-y-auto">
                    <div className="space-y-4 flex flex-col">
                        <Textarea
                            placeholder={t('whatsOnYourMind')}
                            className="flex-grow text-base min-h-[200px]"
                            value={content}
                            onChange={(e) => setContent(e.target.value)}
                        />
                        <input type="file" multiple accept="image/*,video/*" onChange={handleMediaChange} className="text-sm" />
                        <div className="space-y-2 pt-4 border-t">
                            <h4 className="font-semibold text-sm">{t('publishTo')}:</h4>
                            {!hasAnyConnection ? (
                                <p className="text-sm text-muted-foreground italic">
                                    {t('noConnectionsMessage')} <Link href="/settings/integrations" className="underline text-primary hover:text-primary/80"> {t('connectHere')}</Link>.
                                </p>
                            ) : (
                                <div className="flex items-center gap-6 flex-wrap">
                                    {Object.entries(connectionStatuses).map(([key, isConnected]) => isConnected && (
                                        <div key={key} className="flex items-center space-x-2">
                                            <Checkbox
                                                id={key}
                                                checked={selectedProviders.includes(key)}
                                                onCheckedChange={(checked) => setSelectedProviders(prev => checked ? [...prev, key] : prev.filter(p => p !== key))}
                                            />
                                            <Label htmlFor={key} className="capitalize">{key}</Label>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                    <div className="bg-muted/50 p-4 rounded-lg flex flex-col">
                        <h3 className="font-semibold mb-2 text-sm flex-shrink-0">{t('preview')}</h3>
                        <div className="border rounded-md p-3 bg-card space-y-3 flex-grow overflow-y-auto">
                            <p className="text-sm whitespace-pre-wrap">{content || t('textWillAppearHere')}</p>
                            {previewUrls.length > 0 && (
                                <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-4">
                                    {previewUrls.map((url, index) => {
                                        const file = mediaFiles[index];
                                        const isVideo = file?.type.startsWith('video/');

                                        return (
                                            <div key={url} className="relative group aspect-square">
                                                <Image src={url} alt={`Preview ${index + 1}`} className="rounded-md object-cover" fill unoptimized />
                                                {/* âœ… ICONA DE PLAY PER A VÃDEOS */}
                                                {isVideo && (
                                                    <div className="absolute inset-0 bg-black/30 flex items-center justify-center">
                                                        <PlayCircle className="w-8 h-8 text-white" />
                                                    </div>
                                                )}
                                                <Button size="icon" variant="destructive" className="absolute top-1 right-1 h-6 w-6 opacity-0 group-hover:opacity-100 ..." onClick={() => removeMedia(index)}>
                                                    <Trash2 className="h-3 w-3" />
                                                </Button>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
                <DialogFooter className="flex-shrink-0 mt-4">
                    <Button variant="ghost" onClick={() => handleClose(false)}>{t('cancel')}</Button>
                    <Button onClick={handleSubmit} disabled={isPending || !content || selectedProviders.length === 0}>
                        {isPending && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
                        {isPending ? t('saving') : t('saveDraft')}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
};



// =================== FILE: src/app/[locale]/(app)/comunicacio/planificador/_components/PostCard.tsx ===================

// --- PostCard.tsx ---
import type { SocialPost } from '@/types/db';
import { format, parseISO } from 'date-fns';
import { Clock, CheckCircle, XCircle, Trash2, AlertTriangle, Images, Video } from 'lucide-react';
import { Button } from '@/components/ui/button';
import Image from 'next/image';
import React from 'react'; // âœ… Importem React

interface PostCardProps {
    post: SocialPost;
    isDragging: boolean;
    onDelete: (postId: number) => void;
    t: (key: string) => string;
    children?: React.ReactNode; // âœ… CORRECCIÃ“: Afegim la propietat 'children'
}

export function PostCard({ post, isDragging, onDelete, t, children }: PostCardProps) {
    const statusStyles: { [key: string]: { border: string; icon: React.ReactNode | null; text: string } } = {
        scheduled: { border: 'border-primary/50', icon: <Clock size={12} />, text: 'text-primary' },
        published: { border: 'border-green-500', icon: <CheckCircle size={12} />, text: 'text-green-600' },
        failed: { border: 'border-destructive', icon: <XCircle size={12} />, text: 'text-destructive' },
        partial_success: { border: 'border-amber-500', icon: <AlertTriangle size={12} />, text: 'text-amber-600' },
        draft: { border: 'border-border', icon: null, text: '' }
    };

    const style = statusStyles[post.status] || statusStyles.draft;
    
    const mediaUrls = post.media_url || [];
    const hasMedia = mediaUrls.length > 0;
    const imageCount = mediaUrls.length;

    return (
        <div className={`group relative p-1.5 rounded-md bg-card text-xs flex items-start gap-1.5 border ${style.border} ${isDragging ? 'shadow-2xl scale-105' : 'shadow-sm'}`}>
            
            {/* âœ… CORRECCIÃ“: Renderitzem el 'children' que contÃ© l'agafador */}
            {children}
            
            <div className="flex-grow overflow-hidden">
                {post.status !== 'draft' && post.scheduled_at && (
                    <p className={`font-bold flex items-center gap-1 mb-0.5 ${style.text}`}>
                        {style.icon}
                        {post.status === 'scheduled' && format(parseISO(post.scheduled_at), 'HH:mm')}
                    </p>
                )}
                <p className="truncate">{post.content || t('noContent')}</p>
            </div>

            {hasMedia && (
                <div className="relative w-10 h-10 flex-shrink-0 rounded-sm overflow-hidden bg-muted flex items-center justify-center">
                    {/* âœ… LÃ’GICA ACTUALITZADA PER A LA PREVISUALITZACIÃ“ */}
                    {post.media_type === 'image' ? (
                        <>
                            <Image src={mediaUrls[0]} alt={t('imagePreviewAlt')} fill className="object-cover" unoptimized />
                            {imageCount > 1 && (
                                <div className="absolute bottom-0.5 right-0.5 bg-black/70 ...">
                                    <Images size={10} />
                                    <span>{imageCount}</span>
                                </div>
                            )}
                        </>
                    ) : post.media_type === 'video' ? (
                        // Mostrem la icona de vÃ­deo
                        <Video className="w-5 h-5 text-muted-foreground" />
                    ) : null}
                </div>
            )}

            {post.status === 'draft' && (
                <Button variant="ghost" size="icon" className="absolute top-0 right-0 h-6 w-6 opacity-0 group-hover:opacity-100 focus:opacity-100" onClick={(e) => { e.stopPropagation(); onDelete(post.id); }}>
                    <Trash2 className="h-3.5 w-3.5 text-destructive" />
                </Button>
            )}
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/planificador/_components/PostPreview.tsx ===================

"use client";

import { useState } from 'react';
import type { SocialPost } from '@/types/db';
import Image from 'next/image';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { ChevronLeft, ChevronRight, ThumbsUp, MessageCircle, Share2 } from 'lucide-react';
import { FaLinkedin, FaFacebook, FaInstagram } from 'react-icons/fa';

const ProviderIcon = ({ provider }: { provider: string }) => {
    switch (provider) {
        case 'linkedin': return <FaLinkedin className="w-4 h-4 text-[#0A66C2]" />;
        case 'facebook': return <FaFacebook className="w-4 h-4 text-[#1877F2]" />;
        case 'instagram': return <FaInstagram className="w-4 h-4 text-[#E4405F]" />;
        default: return null;
    }
};

export function PostPreview({ post, t }: { post: Partial<SocialPost>, t: (key: string) => string }) {
    const [currentImageIndex, setCurrentImageIndex] = useState(0);

    const mediaUrls = Array.isArray(post.media_url) ? post.media_url : [];
    const hasMedia = mediaUrls.length > 0;
    const mediaType = post.media_type;

    const nextImage = () => setCurrentImageIndex(prev => (prev + 1) % mediaUrls.length);
    const prevImage = () => setCurrentImageIndex(prev => (prev - 1 + mediaUrls.length) % mediaUrls.length);

    return (
        <div className="border rounded-lg bg-card text-card-foreground shadow-sm w-full">
            {/* CapÃ§alera */}
            <div className="p-4 border-b">
                <div className="flex items-center gap-3">
                    <Avatar>
                        <AvatarFallback>R</AvatarFallback>
                    </Avatar>
                    <div>
                        <p className="font-semibold text-sm">{t('yourPage')}</p>
                        <div className="flex items-center gap-1 text-xs text-muted-foreground">
                            <span>{t('publishingTo')}</span>
                            {(post.provider || []).map(p => <ProviderIcon key={p} provider={p} />)}
                        </div>
                    </div>
                </div>
            </div>

            {/* Contingut */}
            <div className="p-4 space-y-4">
                <p className="text-sm whitespace-pre-wrap">
                    {post.content || t('yourTextPlaceholder')}
                </p>

                {hasMedia && (
                    <div className="relative w-full aspect-square overflow-hidden rounded-md">
                        {mediaUrls.map((url, index) => (
                            <div key={index} className="absolute w-full h-full transition-opacity duration-300" style={{ opacity: index === currentImageIndex ? 1 : 0 }}>
                                {mediaType === 'image' ? (
                                    <Image src={url} alt={`Preview ${index + 1}`} layout="fill" className="object-cover" unoptimized />
                                ) : (
                                    <video src={url} controls className="w-full h-full object-cover" />
                                )}
                            </div>
                        ))}
                        {mediaUrls.length > 1 && (
                            <>
                                <Button size="icon" variant="secondary" className="absolute left-2 top-1/2 -translate-y-1/2 h-8 w-8 rounded-full" onClick={prevImage}><ChevronLeft className="h-4 w-4" /></Button>
                                <Button size="icon" variant="secondary" className="absolute right-2 top-1/2 -translate-y-1/2 h-8 w-8 rounded-full" onClick={nextImage}><ChevronRight className="h-4 w-4" /></Button>
                                <div className="absolute bottom-2 left-1/2 -translate-x-1/2 flex gap-1.5">
                                    {mediaUrls.map((_, index) => (
                                        <div key={index} className={`h-2 w-2 rounded-full transition-colors ${index === currentImageIndex ? 'bg-white' : 'bg-white/50'}`} />
                                    ))}
                                </div>
                            </>
                        )}
                    </div>
                )}
            </div>

            {/* Peu */}
            <div className="p-2 border-t flex justify-around text-muted-foreground">
                <Button variant="ghost" size="sm" className="w-full flex items-center gap-2">
                    <ThumbsUp className="w-4 h-4" /> {t('like')}
                </Button>
                <Button variant="ghost" size="sm" className="w-full flex items-center gap-2">
                    <MessageCircle className="w-4 h-4" /> {t('comment')}
                </Button>
                <Button variant="ghost" size="sm" className="w-full flex items-center gap-2">
                    <Share2 className="w-4 h-4" /> {t('share')}
                </Button>
            </div>
        </div>
    );
}


// =================== FILE: src/app/[locale]/(app)/comunicacio/planificador/_components/SchedulePostDialog.tsx ===================

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from '@/components/ui/dialog';
import { useTranslations } from 'next-intl';

interface SchedulePostDialogProps {
    isOpen: boolean;
    onOpenChange: (isOpen: boolean) => void;
    onConfirm: (time: string) => void;
    isPending: boolean;
}

export function SchedulePostDialog({ isOpen, onOpenChange, onConfirm, isPending }: SchedulePostDialogProps) {
    const t = useTranslations('Planificador');
    const [time, setTime] = useState('10:00');
    const userTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

    return (
        <Dialog open={isOpen} onOpenChange={onOpenChange}>
            <DialogContent className="sm:max-w-xs">
                <DialogHeader>
                    <DialogTitle>{t('schedulePostTitle')}</DialogTitle>
                    <DialogDescription>{t('schedulePostDescription')}</DialogDescription>
                </DialogHeader>
                <div className="flex flex-col items-center p-4 gap-2">
                    <input 
                        type="time"
                        value={time}
                        onChange={(e) => setTime(e.target.value)}
                        className="p-2 rounded-md border bg-transparent text-2xl"
                    />
                    <p className="text-xs text-muted-foreground">
                        {t('timeZone', { timeZone: userTimeZone })}
                    </p>
                </div>
                <DialogFooter>
                    <Button variant="ghost" onClick={() => onOpenChange(false)}>{t('cancel')}</Button>
                    <Button onClick={() => onConfirm(time)} disabled={isPending}>
                        {isPending ? t('planning') : t('confirm')}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    )
}


// =================== FILE: src/app/[locale]/(app)/comunicacio/planificador/_components/SocialPlannerClient.tsx ===================

// UbicaciÃ³: /app/(app)/comunicacio/planificador/_components/SocialPlannerClient.tsx

"use client";

import { DragDropContext, Droppable, Draggable } from '@hello-pangea/dnd';
import { format, startOfMonth, endOfMonth, eachDayOfInterval, getDay, isSameDay, parseISO } from 'date-fns';
import { es } from 'date-fns/locale';
import { Button } from '@/components/ui/button';
import { PlusCircle, ChevronLeft, ChevronRight, GripVertical } from 'lucide-react';
import { useTranslations } from 'next-intl';

import { useSocialPlanner } from '../_hooks/useSocialPlanner';
import { PostCard } from './PostCard';
import { CreatePostDialog } from './CreatePostDialog';
import { SchedulePostDialog } from './SchedulePostDialog';
import { ViewPostDialog } from './ViewPostDialog';
import type { SocialPost, ConnectionStatuses } from './SocialPlannerData';

import { cn } from '@/lib/utils/utils'; // âœ… Importem la utilitat 'cn'

interface SocialPlannerClientProps {
    initialPosts: SocialPost[];
    connectionStatuses: ConnectionStatuses;
}

export function SocialPlannerClient({ initialPosts, connectionStatuses }: SocialPlannerClientProps) {
Â  Â  const t = useTranslations('Planificador');
Â  Â  const {
Â  Â  Â  Â  currentMonth, isPending, unscheduledDrafts, calendarPosts, dialogState, postToView,
Â  Â  Â  Â  onDragEnd, handleScheduleConfirm, handleCreatePost, handleUnschedule, handleDeletePost,
Â  Â  Â  Â  openViewDialog, openCreateDialog, setDialogState, nextMonth, prevMonth
Â  Â  } = useSocialPlanner({ initialPosts }); // âœ… 'initialPosts' ara coincideix

    const firstDayOfMonth = startOfMonth(currentMonth);
    const daysInMonth = eachDayOfInterval({ start: firstDayOfMonth, end: endOfMonth(currentMonth) });
    const startingDayIndex = getDay(firstDayOfMonth) === 0 ? 6 : getDay(firstDayOfMonth) - 1;

    return (
        <DragDropContext onDragEnd={onDragEnd}>
            {/* âœ… CORRECCIÃ“ 1: Canviem l'estructura principal per a un millor control */}
            <div className="flex flex-col lg:flex-row h-[calc(100vh-theme(spacing.24))] gap-6 p-4 md:p-6">

                {/* Columna d'Esborranys (Sidebar) */}
                <aside className="lg:w-[320px] xl:w-[350px] flex-shrink-0 flex flex-col gap-4 min-h-[300px] lg:min-h-0">
                    <Button onClick={openCreateDialog} className="w-full flex-shrink-0">
                        <PlusCircle className="mr-2 h-4 w-4" /> {t('createPost')}
                    </Button>
                    <div className="bg-muted/50 rounded-lg p-4 flex-grow flex flex-col">
                        <h2 className="font-semibold mb-3 flex-shrink-0">{t('pendingDrafts')}</h2>
                        <Droppable droppableId="unscheduled-drafts">
                            {(provided, snapshot) => (
                                <div
                                    {...provided.droppableProps}
                                    ref={provided.innerRef}
                                    className={cn(
                                        "space-y-3 flex-grow overflow-y-auto pr-2 -mr-2 rounded transition-colors",
                                        snapshot.isDraggingOver && "bg-primary/10" // âœ… Feedback visual en arrossegar
                                    )}
                                >
                                    {unscheduledDrafts.map((post, index) => (
                                        <Draggable key={post.id} draggableId={post.id.toString()} index={index}>
                                            {(provided, snapshot) => (
                                                <div ref={provided.innerRef} {...provided.draggableProps} onDoubleClick={() => openViewDialog(post)}>
                                                    <PostCard post={post} isDragging={snapshot.isDragging} onDelete={handleDeletePost} t={t}>
                                                        <div {...provided.dragHandleProps} className="cursor-grab p-2">
                                                            <GripVertical className="h-4 w-4 text-muted-foreground" />
                                                        </div>
                                                    </PostCard>
                                                </div>
                                            )}
                                        </Draggable>
                                    ))}
                                    {provided.placeholder}
                                </div>
                            )}
                        </Droppable>
                    </div>
                </aside>

                {/* Calendari */}
                <section className="flex-grow bg-card p-4 rounded-lg shadow-sm flex flex-col h-full overflow-hidden">
                    <div className="flex justify-between items-center mb-4 flex-shrink-0">
                        <Button variant="ghost" size="icon" onClick={prevMonth}><ChevronLeft className="h-4 w-4" /></Button>
                        <h2 className="text-xl font-bold capitalize">{format(currentMonth, 'MMMM yyyy', { locale: es })}</h2>
                        <Button variant="ghost" size="icon" onClick={nextMonth}><ChevronRight className="h-4 w-4" /></Button>
                    </div>
                    <header className="grid grid-cols-7 gap-1 text-center font-semibold text-xs text-muted-foreground mb-2 flex-shrink-0">
                        {['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'].map(day => <div key={day} className="capitalize">{t(`weekdays.${day}`)}</div>)}
                    </header>
                    {/* âœ… CORRECCIÃ“ 2: El 'grid' del calendari ara ocupa tot l'espai restant */}
                    <main className="grid grid-cols-7 grid-rows-5 gap-2 flex-grow min-h-0">
                        {Array.from({ length: startingDayIndex }).map((_, i) => <div key={`empty-${i}`} />)}
                        {daysInMonth.map(day => {
                            const postsOnThisDay = calendarPosts.filter(p => p.scheduled_at && isSameDay(parseISO(p.scheduled_at), day));
                            return (
                                <Droppable key={day.toString()} droppableId={`day-${day.toISOString()}`}>
                                    {(provided, snapshot) => (
                                        // âœ… CORRECCIÃ“ 3: Millorem el feedback visual i l'Ã rea de drop
                                        <div
                                            {...provided.droppableProps}
                                            ref={provided.innerRef}
                                            className={cn(
                                                'rounded-md p-1.5 flex flex-col gap-2 transition-colors',
                                                snapshot.isDraggingOver ? 'bg-primary/20' : 'bg-muted/30'
                                            )}
                                        >
                                            <span className="font-semibold text-sm text-center">{format(day, 'd')}</span>
                                            <div className="flex-grow space-y-2 overflow-y-auto pr-1">
                                                {postsOnThisDay.map((post, index) => (
                                                    <Draggable key={post.id} draggableId={post.id.toString()} index={index}>
                                                        {(provided, snapshot) => (
                                                            <div ref={provided.innerRef} {...provided.draggableProps} onDoubleClick={() => openViewDialog(post)}>
                                                                <PostCard post={post} isDragging={snapshot.isDragging} onDelete={handleDeletePost} t={t}>
                                                                    <div {...provided.dragHandleProps} className="cursor-grab p-2">
                                                                        <GripVertical className="h-4 w-4 text-muted-foreground" />
                                                                    </div>
                                                                </PostCard>
                                                            </div>
                                                        )}
                                                    </Draggable>
                                                ))}
                                                {provided.placeholder}
                                            </div>
                                        </div>
                                    )}
                                </Droppable>
                            );
                        })}
                    </main>
                </section>
            </div>

            {/* DiÃ legs (es mantenen igual) */}
            <CreatePostDialog isOpen={dialogState.create} onOpenChange={(isOpen) => setDialogState(p => ({...p, create: isOpen}))} onCreate={handleCreatePost} connectionStatuses={connectionStatuses} t={t} />
            <SchedulePostDialog isOpen={dialogState.schedule} onOpenChange={(isOpen) => setDialogState(p => ({...p, schedule: isOpen}))} onConfirm={handleScheduleConfirm} isPending={isPending} />
            <ViewPostDialog isOpen={dialogState.view} onOpenChange={(isOpen) => setDialogState(p => ({...p, view: isOpen}))} post={postToView} onUnschedule={handleUnschedule} onDelete={handleDeletePost} isPending={isPending} t={t} />
        </DragDropContext>
    );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/planificador/_components/SocialPlannerData.tsx ===================

import { SocialPlannerClient } from './SocialPlannerClient';
import { UpgradePlanNotice } from '@/app/[locale]/(app)/settings/billing/_components/UpgradePlanNotice';
import { validatePageSession } from '@/lib/supabase/session';
import { getSocialPlannerInitialData } from '@/lib/services/comunicacio/socialPlanner.service';
import type { SocialPost, ConnectionStatuses } from '@/lib/services/comunicacio/socialPlanner.service'; // Importem tipus del servei

// Re-exportem tipus per al client
export type { SocialPost, ConnectionStatuses };

// Plans permesos (pots moure'ls a config si vols)
const ALLOWED_PLANS = ['plus', 'premium'];

export async function SocialPlannerData() {
    const session = await validatePageSession();
    // validatePageSession ja gestiona redirecciÃ³ si no hi ha sessiÃ³/equip
    // PerÃ² afegim comprovaciÃ³ per a TypeScript i possibles errors inesperats
    if (!session) return null;

    const { supabase, user, activeTeamId } = session;
    const locale = user.user_metadata?.locale || 'ca';

    // ComprovaciÃ³ de pla de subscripciÃ³
    const activeTeamPlan = user.app_metadata?.active_team_plan as string | undefined;
    if (!activeTeamPlan || !ALLOWED_PLANS.includes(activeTeamPlan.toLowerCase())) {
        return <UpgradePlanNotice featureName="Planificador Social" requiredPlan="Plus" locale={locale} />;
    }

    // Cridem al servei per obtenir les dades
    const { data, error } = await getSocialPlannerInitialData(supabase, user.id, activeTeamId);

    if (error || !data) {
        console.error("Error carregant les dades del Planificador Social (Component):", error);
        // Mostrem un estat d'error o buit
        // Podries passar un prop 'errorLoading' al client
        return (
            <SocialPlannerClient
                initialPosts={[]}
                connectionStatuses={{ linkedin: false, facebook: false, instagram: false }}
                // errorLoading="No s'han pogut carregar les dades."
            />
        );
    }

    return (
        <SocialPlannerClient
            initialPosts={data.posts}
            connectionStatuses={data.connectionStatuses}
        />
    );
}


// =================== FILE: src/app/[locale]/(app)/comunicacio/planificador/_components/SocialPlannerSkeleton.tsx ===================

// src/app/[locale]/(app)/comunicacio/planificador/_components/SocialPlannerSkeleton.tsx

import { Skeleton } from "@/components/ui/skeleton";

export function SocialPlannerSkeleton() {
  return (
    // Estructura principal flex (columna en mÃ²bil, fila en desktop)
    <div className="flex flex-col lg:flex-row h-[calc(100vh-theme(spacing.24))] gap-6 p-4 md:p-6 animate-pulse">

      {/* --- Columna d'Esborranys (Sidebar) Skeleton --- */}
      <aside className="lg:w-[320px] xl:w-[350px] flex-shrink-0 flex flex-col gap-4 min-h-[300px] lg:min-h-0">
        {/* BotÃ³ Crear Post */}
        <Skeleton className="h-10 w-full" />
        {/* Caixa d'Esborranys */}
        <div className="bg-muted/50 rounded-lg p-4 flex-grow flex flex-col">
          {/* TÃ­tol Esborranys */}
          <Skeleton className="h-6 w-3/4 mb-3 flex-shrink-0" />
          {/* Llista d'Esborranys Skeletons */}
          <div className="space-y-3 flex-grow overflow-hidden">
            {[...Array(3)].map((_, index) => (
              // PostCard Skeleton a la Sidebar
              <div key={`draft-skel-${index}`} className="p-1.5 rounded-md bg-card border border-border flex items-start gap-1.5">
                {/* Drag Handle Skeleton */}
                <Skeleton className="h-8 w-8 flex-shrink-0" />
                {/* Contingut Skeleton */}
                <div className="flex-grow space-y-1.5 overflow-hidden">
                  <Skeleton className="h-3 w-1/2" /> {/* Simula text petit */}
                  <Skeleton className="h-3 w-full" /> {/* Simula text truncat */}
                </div>
                {/* Media Preview Skeleton (opcional, no sempre hi ha) */}
                <Skeleton className="h-10 w-10 rounded-sm flex-shrink-0" />
              </div>
            ))}
          </div>
        </div>
      </aside>

      {/* --- Calendari Skeleton --- */}
      <section className="flex-grow bg-card p-4 rounded-lg shadow-sm flex flex-col h-full overflow-hidden">
        {/* Header NavegaciÃ³ Mes Skeleton */}
        <div className="flex justify-between items-center mb-4 flex-shrink-0">
          <Skeleton className="h-8 w-8 rounded-full" />
          <Skeleton className="h-7 w-40" />
          <Skeleton className="h-8 w-8 rounded-full" />
        </div>
        {/* Header Dies Setmana Skeleton */}
        <header className="grid grid-cols-7 gap-1 text-center mb-2 flex-shrink-0">
          {[...Array(7)].map((_, index) => (
            <Skeleton key={`day-header-${index}`} className="h-4 w-8 mx-auto" />
          ))}
        </header>
        {/* Grid Calendari Skeleton */}
        <main className="grid grid-cols-7 grid-rows-5 gap-2 flex-grow min-h-0">
          {/* Generem celÂ·les skeleton (aprox 35 per a 5 setmanes) */}
          {[...Array(35)].map((_, index) => (
            <div key={`day-cell-${index}`} className="rounded-md p-1.5 flex flex-col gap-2 bg-muted/30">
              {/* NÃºmero del dia Skeleton */}
              <Skeleton className="h-4 w-4 self-center flex-shrink-0" />
              {/* Espai per a PostCards Skeletons (nomÃ©s en algunes celÂ·les) */}
              <div className="flex-grow space-y-2 overflow-hidden">
                {/* Afegim 1 o 2 post skeletons aleatÃ²riament per simular contingut */}
                {Math.random() > 0.6 && (
                  <div className="p-1 rounded-md bg-card border border-border flex items-start gap-1">
                    <Skeleton className="h-4 w-4 flex-shrink-0" /> {/* Icona petita */}
                    <Skeleton className="h-3 w-full" /> {/* Text truncat */}
                  </div>
                )}
                {Math.random() > 0.8 && (
                   <div className="p-1 rounded-md bg-card border border-border flex items-start gap-1">
                    <Skeleton className="h-4 w-4 flex-shrink-0" />
                    <Skeleton className="h-3 w-full" />
                  </div>
                )}
              </div>
            </div>
          ))}
        </main>
      </section>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/planificador/_components/ViewPostDialog.tsx ===================

import type { SocialPost } from '@/types/db';
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';
import { Undo2, Trash2 } from 'lucide-react';
import { PostPreview } from './PostPreview';

interface ViewPostDialogProps {
  isOpen: boolean;
  onOpenChange: (isOpen: boolean) => void;
  post: SocialPost | null;
  onUnschedule: (postId: number) => void;
  onDelete: (postId: number) => void;
  isPending: boolean;
  t: (key: string) => string;
}

export function ViewPostDialog({ isOpen, onOpenChange, post, onUnschedule, onDelete, isPending, t }: ViewPostDialogProps) {
  if (!post) return null;

  return (
    <Dialog open={isOpen} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-lg">
        <DialogHeader>
          <DialogTitle>{t('viewPostTitle')}</DialogTitle>
        </DialogHeader>

        <div className="max-h-[60vh] overflow-y-auto pr-2">
          <PostPreview post={post} t={t} />
        </div>

        <DialogFooter className="flex-col sm:flex-row sm:justify-between w-full gap-2">
          <div className="flex gap-2">
            {post.status === 'scheduled' && (
              <Button variant="outline" onClick={() => onUnschedule(post.id)} disabled={isPending}>
                <Undo2 className="mr-2 h-4 w-4" /> {t('returnToDraft')}
              </Button>
            )}
            {post.status === 'draft' && (
              <Button variant="destructive" onClick={() => { onDelete(post.id); onOpenChange(false); }} disabled={isPending}>
                <Trash2 className="mr-2 h-4 w-4" /> {t('deleteDraft')}
              </Button>
            )}
          </div>
          <Button onClick={() => onOpenChange(false)}>{t('close')}</Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}


// =================== FILE: src/app/[locale]/(app)/comunicacio/planificador/_hooks/useCreatePost.ts ===================

// UbicaciÃ³: /app/(app)/comunicacio/planificador/_hooks/useCreatePost.ts

"use client";

import { useState, useTransition, useEffect } from 'react';
import { toast } from 'sonner';
import { type ConnectionStatuses } from '../types';
import { generateVideoThumbnail } from '@/lib/utils/media';
import { getPresignedUploadUrlAction, createSocialPostAction } from '../actions';
import type { SocialPost } from '@/types/db';   
interface UseCreatePostProps {
    isOpen: boolean;
    connectionStatuses: ConnectionStatuses;
    onCreate: (newPost: SocialPost) => void;
    onClose: () => void;
    t: (key: string) => string;
}
// --- FunciÃ³ d'ajuda per a la validaciÃ³ ---
const validateImageAspectRatio = (file: File): Promise<boolean> => {
    return new Promise((resolve) => {
        if (!file.type.startsWith('image/')) {
            resolve(true); // No Ã©s una imatge, no la validem aquÃ­
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const aspectRatio = img.width / img.height;
                // Instagram requereix entre 4:5 (0.8) i 1.91:1
                const isValid = aspectRatio >= 0.8 && aspectRatio <= 1.91;
                resolve(isValid);
            };
            img.src = e.target?.result as string;
        };
        reader.readAsDataURL(file);
    });
};
export function useCreatePost({ isOpen, connectionStatuses, onCreate, onClose, t }: UseCreatePostProps) {
    const [content, setContent] = useState('');
    const [mediaFiles, setMediaFiles] = useState<File[]>([]);
    const [previewUrls, setPreviewUrls] = useState<string[]>([]);
    const [selectedProviders, setSelectedProviders] = useState<string[]>([]);
    const [isPending, startTransition] = useTransition();

    useEffect(() => {
        if (isOpen) {
            const defaultProviders = Object.keys(connectionStatuses).filter(key => connectionStatuses[key]);
            setSelectedProviders(defaultProviders);
        }
    }, [isOpen, connectionStatuses]);

    const resetState = () => {
        setContent('');
        setMediaFiles([]);
        previewUrls.forEach(url => URL.revokeObjectURL(url));
        setPreviewUrls([]);
        setSelectedProviders([]);
    };

    const handleMediaChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const files = Array.from(e.target.files || []);
        if (files.length === 0) return;

        const isUploadingVideo = files.some(file => file.type.startsWith('video/'));
        const hasExistingMedia = mediaFiles.length > 0;
        const hasExistingVideo = hasExistingMedia && mediaFiles[0].type.startsWith('video/');

        if ((isUploadingVideo && hasExistingMedia) || (hasExistingVideo && files.length > 0)) {
            toast.error(t('errorMediaMix'), { description: t('errorMediaMixDescription') });
            return;
        }
        if (isUploadingVideo && files.length > 1) {
            toast.error(t('errorMultipleVideos'), { description: t('errorMultipleVideosDescription') });
            return;
        }

        const validFiles: File[] = [];
        for (const file of files) {
            if (file.type.startsWith('image/')) {
                const isValid = await validateImageAspectRatio(file);
                if (isValid) {
                    validFiles.push(file);
                } else {
                    toast.error(t('invalidAspectRatioTitle'), { description: t('invalidAspectRatioDescription') });
                }
            } else {
                validFiles.push(file); // Afegim vÃ­deos directament
            }
        }
        if (validFiles.length === 0) return;

        const newFiles = [...mediaFiles, ...validFiles].slice(0, 10);
        setMediaFiles(newFiles);

        // Neteja URLs anteriors
        previewUrls.forEach(url => { if (url.startsWith('blob:')) URL.revokeObjectURL(url); });

        const newPreviewPromises = newFiles.map(file => {
            if (file.type.startsWith('video/')) {
                return generateVideoThumbnail(file);
            }
            return Promise.resolve(URL.createObjectURL(file));
        });
        const newUrls = await Promise.all(newPreviewPromises);
        setPreviewUrls(newUrls);
    };

    const removeMedia = (indexToRemove: number) => {
        setMediaFiles(prev => prev.filter((_, index) => index !== indexToRemove));
        setPreviewUrls(prev => {
            const urlToRemove = prev[indexToRemove];
            URL.revokeObjectURL(urlToRemove);
            return prev.filter((_, index) => index !== indexToRemove);
        });
    };

    const handleSubmit = () => {
        startTransition(async () => {
            let mediaPaths: string[] | null = null;
            let mediaType: string | null = null;

            if (mediaFiles.length > 0) {
                try {
                    const fileNames = mediaFiles.map(f => f.name);
                    const urlResult = await getPresignedUploadUrlAction(fileNames);
                    // âœ… CORRECCIÃ“: Proporcionem un missatge per defecte si 'urlResult.message' Ã©s undefined
                    if (!urlResult.success || !urlResult.data) {
                        throw new Error(urlResult.message || "Error desconegut en obtenir les URLs de pujada.");
                    }

                    await Promise.all(
                        urlResult.data.signedUrls.map((urlInfo, index) =>
                            fetch(urlInfo.signedUrl, { method: 'PUT', body: mediaFiles[index] })
                        )
                    );

                    mediaPaths = urlResult.data.signedUrls.map(info => info.path);
                    mediaType = mediaFiles[0].type.startsWith('image') ? 'image' : 'video';
                } catch (error) {
                    toast.error(error instanceof Error ? error.message : "Error en pujar els fitxers.");
                    return;
                }
            }

            const createResult = await createSocialPostAction(content, selectedProviders, mediaPaths, mediaType);
            if (createResult.success && createResult.data) {
                toast.success(t('successDraftCreated'));
                onCreate(createResult.data);
            } else {
                // âœ… CORRECCIÃ“: Proporcionem un missatge per defecte aquÃ­ tambÃ©
                toast.error(createResult.message || "Hi ha hagut un error en crear la publicaciÃ³.");
            }
            onClose();
        });
    };

    return {
        content, setContent, mediaFiles, previewUrls, selectedProviders, isPending,
        handleMediaChange, removeMedia, setSelectedProviders, handleSubmit, resetState
    };
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/planificador/_hooks/useSocialPlanner.ts ===================

// UbicaciÃ³: /app/(app)/comunicacio/planificador/_hooks/useSocialPlanner.ts
"use client";

import { useState, useMemo, useTransition } from 'react';
import { DropResult } from '@hello-pangea/dnd';
import { addMonths, subMonths } from 'date-fns';
import { toast } from 'sonner';

import { scheduleSocialPostAction, unscheduleSocialPostAction, deleteSocialPostAction } from '../actions';
import type { SocialPost } from '@/types/db';

interface UseSocialPlannerProps {
    initialPosts: SocialPost[];
}

export function useSocialPlanner({ initialPosts }: UseSocialPlannerProps) {
    const [posts, setPosts] = useState(initialPosts);
    const [currentMonth, setCurrentMonth] = useState(new Date());
    const [isPending, startTransition] = useTransition();

    // GestiÃ³ dels diÃ legs
    const [dialogState, setDialogState] = useState({
        create: false,
        schedule: false,
        view: false,
    });
    const [postToView, setPostToView] = useState<SocialPost | null>(null);
    const [postToSchedule, setPostToSchedule] = useState<{ post: SocialPost; date: Date } | null>(null);

    // Dades derivades
    const unscheduledDrafts = useMemo(() => posts.filter(p => p.status === 'draft'), [posts]);
    const calendarPosts = useMemo(() => posts.filter(p => p.status !== 'draft'), [posts]);

    // Handlers dels diÃ legs
    const openCreateDialog = () => setDialogState(p => ({ ...p, create: true }));
    const openViewDialog = (post: SocialPost) => {
        setPostToView(post);
        setDialogState(p => ({ ...p, view: true }));
    };

    // LÃ²gica de Drag & Drop
    const onDragEnd = (result: DropResult) => {
        const { destination, draggableId } = result;
        if (!destination) return;

        const postId = parseInt(draggableId);
        const post = posts.find(p => p.id === postId);
        if (!post) return;

        if (destination.droppableId.startsWith('day-')) {
            const dateStr = destination.droppableId.replace('day-', '');
            setPostToSchedule({ post, date: new Date(dateStr) });
            setDialogState(p => ({ ...p, schedule: true }));
        } else if (destination.droppableId === 'unscheduled-drafts' && post.status === 'scheduled') {
            handleUnschedule(post.id);
        }
    };

    // Accions
    const handleScheduleConfirm = (time: string) => {
        if (!postToSchedule) return;
        const [hours, minutes] = time.split(':').map(Number);
        const scheduledDateTime = new Date(postToSchedule.date.getFullYear(), postToSchedule.date.getMonth(), postToSchedule.date.getDate(), hours, minutes);

        startTransition(async () => {
            const { success, message } = await scheduleSocialPostAction(postToSchedule.post.id, scheduledDateTime.toISOString());
            toast[success ? 'success' : 'error'](message);
            if (success) {
                setPosts(prev => prev.map(p => p.id === postToSchedule.post.id ? { ...p, status: 'scheduled', scheduled_at: scheduledDateTime.toISOString() } : p));
            }
            setDialogState(p => ({ ...p, schedule: false }));
            setPostToSchedule(null);
        });
    };

    const handleCreatePost = (newPost: SocialPost) => {
        setPosts(prev => [newPost, ...prev]);
        setDialogState(p => ({ ...p, create: false }));
    };

    const handleUnschedule = (postId: number) => {
        startTransition(async () => {
            const result = await unscheduleSocialPostAction(postId);
            toast[result.success ? 'success' : 'error'](result.message);
            if (result.success) {
                setPosts(prev => prev.map(p => p.id === postId ? { ...p, status: 'draft', scheduled_at: null } : p));
                setDialogState(p => ({ ...p, view: false }));
            }
        });
    };

    const handleDeletePost = (postId: number) => {
        startTransition(async () => {
            const result = await deleteSocialPostAction(postId);
            toast[result.success ? 'success' : 'error'](result.message);
            if (result.success) {
                setPosts(prev => prev.filter(p => p.id !== postId));
            }
        });
    };
    
    // NavegaciÃ³ del calendari
    const nextMonth = () => setCurrentMonth(prev => addMonths(prev, 1));
    const prevMonth = () => setCurrentMonth(prev => subMonths(prev, 1));

    return {
        posts, currentMonth, isPending, unscheduledDrafts, calendarPosts, dialogState, postToView, postToSchedule,
        onDragEnd, handleScheduleConfirm, handleCreatePost, handleUnschedule, handleDeletePost, openViewDialog, openCreateDialog,
        setDialogState, nextMonth, prevMonth
    };
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/templates/actions.ts ===================

// src/app/[locale]/(app)/comunicacio/templates/actions.ts
"use server";

import { revalidatePath } from "next/cache";
import type { PostgrestError } from "@supabase/supabase-js";
import { validateUserSession } from "@/lib/supabase/session";

// âœ… 1. Importem el tipus correcte des de la font de la veritat
import type { EmailTemplate } from "@/types/db";

// âœ… 2. Importem el nostre nou servei
import * as templatesService from "@/lib/services/comunicacio/templates.service";

// Tipus per a les dades d'entrada, basat en el tipus real de la BD
type TemplateInput = Omit<EmailTemplate, "id" | "created_at" | "user_id" | "team_id">;

/**
 * ACCIÃ“: Desa (crea o actualitza) una plantilla d'email.
 */
export async function saveTemplateAction(
Â  Â  templateData: TemplateInput,
Â  Â  templateId: string | null
): Promise<{ data: EmailTemplate | null; error: PostgrestError | null }> {
Â  Â  // 1. ValidaciÃ³ de sessiÃ³
Â  Â  const session = await validateUserSession();
Â  Â  if ('error' in session) {
Â  Â  Â  Â  return { data: null, error: { message: session.error.message } as PostgrestError };
Â  Â  }
Â  Â  const { supabase, user, activeTeamId } = session;

Â  Â  try {
        // 2. Crida al servei
Â  Â  Â  Â  const data = await templatesService.saveTemplate(
Â  Â  Â  Â  Â  Â  supabase,
Â  Â  Â  Â  Â  Â  templateData,
Â  Â  Â  Â  Â  Â  templateId,
Â  Â  Â  Â  Â  Â  user.id,
Â  Â  Â  Â  Â  Â  activeTeamId
Â  Â  Â  Â  );

        // 3. Efecte secundari
Â  Â  Â  Â  revalidatePath('/comunicacio/templates');
Â  Â  Â  Â  return { data, error: null };
Â  Â  } catch (error: unknown) {
        // 4. GestiÃ³ d'errors
Â  Â  Â  Â  console.error("Error en saveTemplateAction:", error);
Â  Â  Â  Â  return { data: null, error: { message: (error as Error).message } as PostgrestError };
Â  Â  }
}

/**
 * ACCIÃ“: Elimina una plantilla d'email.
 */
export async function deleteTemplateAction(
Â  Â  templateId: string
): Promise<{ error: PostgrestError | null }> {
Â  Â  // 1. ValidaciÃ³ de sessiÃ³
Â  Â  const session = await validateUserSession();
Â  Â  if ('error' in session) {
Â  Â  Â  Â  return { error: { message: session.error.message } as PostgrestError };
Â  Â  }
Â  Â  const { supabase, activeTeamId } = session;

Â  Â  try {
        // 2. Crida al servei
Â  Â  Â  Â  await templatesService.deleteTemplate(supabase, templateId, activeTeamId);

        // 3. Efecte secundari
Â  Â  Â  Â  revalidatePath('/comunicacio/templates');
Â  Â  Â  Â  return { error: null };
Â  Â  } catch (error: unknown) {
        // 4. GestiÃ³ d'errors
Â  Â  Â  Â  console.error("Error en deleteTemplateAction:", error);
Â  Â  Â  Â  return { error: { message: (error as Error).message } as PostgrestError };
Â  Â  }
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/templates/page.tsx ===================

// src/app/[locale]/(app)/comunicacio/templates/page.tsx
import { Suspense } from 'react';
import type { Metadata } from 'next';
import { TemplatesData } from './_components/TemplatesData';
import { TemplatesSkeleton } from './_components/TemplatesSkeleton';

export const metadata: Metadata = {
Â  title: 'Plantilles d\'Email | Ribot',
};

// âŒ ELIMINAT: El 'type EmailTemplate' s'ha mogut a src/types/db.ts
// export type EmailTemplate = { ... };

export default function TemplatesPage() {
Â  return (
Â  Â  <Suspense fallback={<TemplatesSkeleton />}>
Â  Â  Â  <TemplatesData />
Â  Â  </Suspense>
Â  );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/templates/_components/TemplateEditor.tsx ===================

"use client";

import React, { useState } from 'react';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Code, Eye, FileText } from 'lucide-react';
import Editor from 'react-simple-code-editor';
import { highlight, languages } from 'prismjs/components/prism-core';
import 'prismjs/components/prism-clike';
import 'prismjs/components/prism-javascript';
import 'prismjs/components/prism-markup';
import { useTranslations } from 'next-intl';
import type { EmailTemplate } from '@/types/db';

interface TemplateEditorProps {
  selectedTemplate: EmailTemplate | null;
  onUpdateTemplate: React.Dispatch<React.SetStateAction<EmailTemplate | null>>;
  onSave: (currentTemplate: EmailTemplate, detectedVariables: string[]) => void;
}

export function TemplateEditor({ selectedTemplate, onUpdateTemplate }: TemplateEditorProps) {
  const t = useTranslations('TemplatesPage');
  const [editorView, setEditorView] = useState<'code' | 'preview'>('preview');

  if (!selectedTemplate) {
    return (
      <div className="flex flex-col items-center justify-center h-full text-center p-4 glass-card rounded-xl">
        <FileText className="w-14 h-14 text-muted-foreground mb-3" />
        <h2 className="text-lg font-medium text-muted-foreground">
          {t('noTemplateSelected')}
        </h2>
      </div>
    );
  }

  return (
    <div className="flex flex-col gap-3 h-full min-h-0">
      {/* ğŸ§­ CapÃ§alera amb inputs */}
      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <Input
          placeholder={t('templateNamePlaceholder')}
          value={selectedTemplate.name}
          onChange={(e) =>
            onUpdateTemplate((t) => (t ? { ...t, name: e.target.value } : null))
          }
        />
        <Input
          placeholder={t('subjectPlaceholder')}
          value={selectedTemplate.subject ?? ''}
          onChange={(e) =>
            onUpdateTemplate((t) => (t ? { ...t, subject: e.target.value } : null))
          }
        />
      </div>

      {/* ğŸ’» Editor / Preview */}
      <div className="flex-1 flex flex-col min-h-0 rounded-xl border border-border overflow-hidden bg-card">
        {/* ğŸ”¹ Toolbar */}
        <div className="flex items-center justify-between px-2 py-1 border-b border-border bg-muted/40">
          <h3 className="text-sm font-medium text-muted-foreground">
            {t('contentTitle')}
          </h3>
          <div className="flex items-center gap-1">
            <Button
              variant={editorView === 'code' ? 'secondary' : 'ghost'}
              size="icon"
              className="h-8 w-8"
              title={t('codeButton')}
              onClick={() => setEditorView('code')}
            >
              <Code className="w-4 h-4" />
            </Button>
            <Button
              variant={editorView === 'preview' ? 'secondary' : 'ghost'}
              size="icon"
              className="h-8 w-8"
              title={t('previewButton')}
              onClick={() => setEditorView('preview')}
            >
              <Eye className="w-4 h-4" />
            </Button>
          </div>
        </div>

        {/* âœï¸ Cos de lâ€™editor o vista prÃ¨via */}
        <div className="flex-1 min-h-0 overflow-auto bg-background">
          {editorView === 'code' ? (
            <Editor
              value={selectedTemplate.body || ''}
              onValueChange={(code) =>
                onUpdateTemplate((t) => (t ? { ...t, body: code } : null))
              }
              highlight={(code) => highlight(code, languages.markup!, 'markup')}
              padding={16}
              className="font-mono text-sm"
              style={{
                backgroundColor: '#1e1e1e',
                color: '#dcdcdc',
                height: '100%',
                minHeight: '100%',
                fontFamily: '"Fira Code", monospace',
              }}
            />

          ) : (
            <iframe
              srcDoc={selectedTemplate.body ?? undefined}
              title={t('previewTitle')}
              className="w-full h-full border-0 bg-white"
            />
          )}
        </div>
      </div>
    </div>
  );
}


// =================== FILE: src/app/[locale]/(app)/comunicacio/templates/_components/TemplateList.tsx ===================

/**
 * @file TemplateList.tsx
 * @summary Renderitza la columna esquerra amb la llista de plantilles i el botÃ³ per crear-ne de noves.
 */
"use client";

import { Button } from '@/components/ui/button';
import { Plus, Trash2 } from 'lucide-react';
import { useTranslations } from 'next-intl';
import type { EmailTemplate } from '@/types/db';

interface TemplateListProps {
  templates: EmailTemplate[];
  selectedTemplateId: string | null;
  onSelectTemplate: (template: EmailTemplate) => void;
  onNewTemplate: () => void;
  onSetTemplateToDelete: (template: EmailTemplate) => void;
}

export function TemplateList({
  templates,
  selectedTemplateId,
  onSelectTemplate,
  onNewTemplate,
  onSetTemplateToDelete,
}: TemplateListProps) {
  const t = useTranslations('TemplatesPage');

  return (
    <div className="glass-card flex flex-col overflow-hidden">
      <div className="p-4 border-b border-border flex justify-between items-center">
        <h2 className="font-semibold">{t('templatesListTitle')}</h2>
        <Button size="icon" variant="ghost" onClick={onNewTemplate}>
          <Plus className="w-4 h-4" />
        </Button>
      </div>

      <div className="flex-1 overflow-y-auto">
        {templates.map(template => (
          <div
            key={template.id}
            onClick={() => onSelectTemplate(template)}
            className={`group flex justify-between items-center p-4 cursor-pointer border-l-4 ${
              selectedTemplateId === String(template.id)
                ? 'bg-primary/20 border-primary'
                : 'border-transparent hover:bg-muted'
            }`}
          >
            <p className="font-semibold truncate">{template.name}</p>
            <Button
              variant="ghost"
              size="icon"
              className="h-7 w-7 opacity-0 group-hover:opacity-100"
              onClick={(e) => {
                e.stopPropagation(); // Evitem que el clic seleccioni la plantilla
                onSetTemplateToDelete(template);
              }}
            >
              <Trash2 className="w-4 h-4 text-destructive" />
            </Button>
          </div>
        ))}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/templates/_components/templates-client.tsx ===================

"use client";

import React, { useState } from 'react';
import { motion } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs';
import { Loader2, List, FileText, Variable, Plus } from 'lucide-react';
import {
  AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent,
  AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle
} from "@/components/ui/alert-dialog";
import { useTemplates } from '../_hooks/useTemplates';

import { TemplateList } from './TemplateList';
import { TemplateEditor } from './TemplateEditor';
import { TemplateVariables } from './TemplateVariables';
import type { EmailTemplate } from '@/types/db';

export function TemplatesClient({ initialTemplates }: { initialTemplates: EmailTemplate[] }) {
  const {
    isSaving, isDeleting,
    templates,
    selectedTemplate, setSelectedTemplate,
    templateToDelete, setTemplateToDelete,
    setDetectedVariables,
    handleNewTemplate,
    handleSaveTemplate,
    handleDeleteTemplate,
    t,
  } = useTemplates({ initialTemplates });

  const [activeTab, setActiveTab] = useState<'list' | 'editor' | 'variables'>('editor');

  // ğŸ”¹ Quan es crea una plantilla nova â†’ canviem automÃ ticament a lâ€™editor
  const handleCreateTemplate = () => {
    handleNewTemplate();
    setActiveTab('editor');
  };

  return (
    <>
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        className="h-full flex flex-col"
      >
        {/* ğŸ”¹ Header */}
        <div className="flex justify-between items-center mb-4 flex-shrink-0">
          <h1 className="text-2xl sm:text-3xl font-bold">{t('pageTitle')}</h1>
          <div className="flex gap-2">
            <Button onClick={handleCreateTemplate} variant="outline" className="h-9 px-3">
              <Plus className="w-4 h-4 mr-1" />
            </Button>
            <Button onClick={handleSaveTemplate} disabled={isSaving || !selectedTemplate} className="h-9 px-4">
              {isSaving && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
              {t('saveButton')}
            </Button>
          </div>
        </div>

        {/* ğŸ’» Layout Desktop */}
        <div className="hidden lg:grid lg:grid-cols-[280px_1fr_280px] gap-6 flex-1 min-h-0">
          <TemplateList
            templates={templates}
            selectedTemplateId={selectedTemplate ? String(selectedTemplate.id) : null}
            onSelectTemplate={setSelectedTemplate}
            onNewTemplate={handleCreateTemplate}
            onSetTemplateToDelete={setTemplateToDelete}
          />
          <TemplateEditor
            selectedTemplate={selectedTemplate}
            onUpdateTemplate={setSelectedTemplate}
            onSave={handleSaveTemplate}
          />
          <TemplateVariables
            selectedTemplate={selectedTemplate}
            onVariablesChange={setDetectedVariables}
          />
        </div>

        {/* ğŸ“± Layout Mobile */}
        <div className="lg:hidden flex-1 min-h-0 flex flex-col">
          <Tabs
            defaultValue="editor"
            value={activeTab}
            onValueChange={(value: string) => setActiveTab(value as 'list' | 'editor' | 'variables')}
            className="flex-1 flex flex-col"
          >
            {/* ğŸ”¹ TabsList responsive */}
            <TabsList className="grid grid-cols-3 gap-1 mb-2 w-full bg-muted rounded-lg text-xs sm:text-sm">
              <TabsTrigger value="list" className="flex items-center justify-center gap-1 py-2">
                <List className="w-4 h-4" /> {t('tabList')}
              </TabsTrigger>
              <TabsTrigger value="editor" className="flex items-center justify-center gap-1 py-2">
                <FileText className="w-4 h-4" /> {t('tabEditor')}
              </TabsTrigger>
              <TabsTrigger value="variables" className="flex items-center justify-center gap-1 py-2">
                <Variable className="w-4 h-4" /> {t('tabVariables')}
              </TabsTrigger>
            </TabsList>

            {/* ğŸ”¹ Contingut per pestanya */}
            <TabsContent value="list" className="flex-1 overflow-y-auto rounded-xl">
              <TemplateList
                templates={templates}
                selectedTemplateId={selectedTemplate ? String(selectedTemplate.id) : null}
                onSelectTemplate={setSelectedTemplate}
                onNewTemplate={handleCreateTemplate}
                onSetTemplateToDelete={setTemplateToDelete}
              />
            </TabsContent>

            <TabsContent value="editor" className="flex-1 min-h-0">
              <TemplateEditor
                selectedTemplate={selectedTemplate}
                onUpdateTemplate={setSelectedTemplate}
                onSave={handleSaveTemplate}
              />
            </TabsContent>

            <TabsContent value="variables" className="flex-1 overflow-y-auto">
              <TemplateVariables
                selectedTemplate={selectedTemplate}
                onVariablesChange={setDetectedVariables}
              />
            </TabsContent>
          </Tabs>
        </div>
      </motion.div>

      {/* ğŸ—‘ï¸ ConfirmaciÃ³ dâ€™eliminaciÃ³ */}
      <AlertDialog open={!!templateToDelete} onOpenChange={(isOpen) => !isOpen && setTemplateToDelete(null)}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>{t('deleteConfirmTitle')}</AlertDialogTitle>
            <AlertDialogDescription>{t('deleteConfirmDescription')}</AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>{t('cancelButton')}</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDeleteTemplate}
              disabled={isDeleting}
              className="bg-destructive hover:bg-destructive/90"
            >
              {isDeleting ? t('deletingButton') : t('confirmDeleteButton')}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
}


// =================== FILE: src/app/[locale]/(app)/comunicacio/templates/_components/TemplatesData.tsx ===================

// src/app/[locale]/(app)/comunicacio/templates/_components/TemplatesData.tsx
import { TemplatesClient } from './templates-client';
import { validatePageSession } from "@/lib/supabase/session";

// âœ… 1. Importem el nostre nou servei
import * as templatesService from '@/lib/services/comunicacio/templates.service';

// âœ… 2. Importem el tipus correcte des de la font de la veritat
import type { EmailTemplate } from '@/types/db';

export async function TemplatesData() {
Â  Â  const { supabase, activeTeamId } = await validatePageSession();

Â  Â  let templates: EmailTemplate[] = [];

Â  Â  try {
        // âœ… 3. Cridem al servei per obtenir les dades
Â  Â  Â  Â  templates = await templatesService.getTemplates(supabase, activeTeamId);
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error((error as Error).message);
        // Retornem el client amb dades buides en cas d'error
Â  Â  Â  Â  return <TemplatesClient initialTemplates={[]} />;
Â  Â  }

    // âœ… 4. Passem les dades directament. 
    // No cal mapar 'id' a string. El 'TemplatesClient' haurÃ  d'acceptar 'id: number'.
Â  Â  return (
Â  Â  Â  Â  <TemplatesClient initialTemplates={templates} />
Â  Â  );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/templates/_components/TemplatesSkeleton.tsx ===================

/**
 * @file TemplatesSkeleton.tsx
 * @summary Muestra un esqueleto de carga para la pÃ¡gina de Plantillas.
 */
"use client";

import React from 'react';

export const TemplatesSkeleton: React.FC = () => (
    <div className="space-y-6 animate-pulse">
        {/* Esqueleto para la cabecera */}
        <div className="flex justify-between items-center">
            <div className="h-9 bg-muted rounded-lg w-1/3"></div>
            <div className="h-10 bg-muted rounded-lg w-36"></div>
        </div>

        {/* Esqueleto para las 3 columnas */}
        <div className="grid grid-cols-1 lg:grid-cols-[280px_1fr_280px] gap-6 min-h-0 h-[calc(100vh-12rem)]">
            <div className="h-full bg-muted rounded-xl"></div>
            <div className="h-full bg-muted rounded-xl"></div>
            <div className="h-full bg-muted rounded-xl"></div>
        </div>
    </div>
);

// =================== FILE: src/app/[locale]/(app)/comunicacio/templates/_components/TemplateVariables.tsx ===================

/**
 * @file TemplateVariables.tsx
 * @summary Renderitza la columna dreta que detecta i mostra les variables de la plantilla.
 */
"use client";

import React, { useMemo, useEffect } from 'react'; // NomÃ©s necessitem aquests hooks
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { Variable } from 'lucide-react';
import { useTranslations } from 'next-intl';
import type { EmailTemplate } from '@/types/db';

interface TemplateVariablesProps {
  selectedTemplate: EmailTemplate | null;
  onVariablesChange: (variables: string[]) => void;
}

export function TemplateVariables({ selectedTemplate, onVariablesChange }: TemplateVariablesProps) {
    const t = useTranslations('TemplatesPage');

    // âœ… BONA PRÃ€CTICA: Utilitzem 'useMemo' per a calcular dades derivades.
    // Aquest codi nomÃ©s s'executa si 'selectedTemplate' canvia.
    const detectedVariables = useMemo(() => {
        if (!selectedTemplate) {
            return [];
        }
        const content = `${selectedTemplate.subject || ''} ${selectedTemplate.body || ''}`;
        const foundVariables = content.match(/\{\{([^}]+)\}\}/g) || [];
        // Retornem un array net de variables Ãºniques.
        return [...new Set(foundVariables.map(v => v.replace(/[{}]/g, '').trim()))];
    }, [selectedTemplate]);

    // âœ… BONA PRÃ€CTICA: Utilitzem 'useEffect' NOMÃ‰S per a efectes secundaris.
    // En aquest cas, el nostre efecte Ã©s notificar al component pare quan les variables han canviat.
    useEffect(() => {
        onVariablesChange(detectedVariables);
    }, [detectedVariables, onVariablesChange]);

    return (
        <div className="glass-card flex flex-col overflow-hidden">
            <div className="p-4 border-b border-border">
                <h3 className="font-semibold flex items-center gap-2">
                    <Variable className="w-4 h-4 text-primary"/>{t('detectedVariablesTitle')}
                </h3>
            </div>
            <div className="p-4 space-y-3 overflow-y-auto">
                <p className="text-xs text-muted-foreground">{t('variablesDescription')}</p>
                <div className="flex flex-wrap gap-2">
                    {detectedVariables.length > 0 ? (
                        detectedVariables.map(v => (
                            <Button
                                key={v}
                                variant="outline"
                                size="sm"
                                onClick={() => {
                                    navigator.clipboard.writeText(`{{${v}}}`);
                                    toast.success(t('toastCopiedTitle'), {
                                        description: t('toastCopiedDescription', { variable: `{{${v}}}` }),
                                    });
                                }}
                            >
                                {`{{${v}}}`}
                            </Button>
                        ))
                    ) : (
                        <p className="text-xs text-muted-foreground italic">{t('noVariablesDetected')}</p>
                    )}
                </div>
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/templates/_hooks/useTemplates.ts ===================

"use client";

import { useState, useTransition } from 'react';
import { toast } from "sonner";
import { useTranslations } from 'next-intl';
import type { EmailTemplate } from '@/types/db';
import { saveTemplateAction, deleteTemplateAction } from '../actions';

type UseTemplatesProps = {
    initialTemplates: EmailTemplate[];
};

export function useTemplates({ initialTemplates }: UseTemplatesProps) {
    const t = useTranslations('TemplatesPage');
    const [isSaving, startSaveTransition] = useTransition();
    const [isDeleting, startDeleteTransition] = useTransition();

    const [templates, setTemplates] = useState(initialTemplates);
    const [selectedTemplate, setSelectedTemplate] = useState<EmailTemplate | null>(initialTemplates[0] || null);
    const [templateToDelete, setTemplateToDelete] = useState<EmailTemplate | null>(null);
    const [detectedVariables, setDetectedVariables] = useState<string[]>([]);

    const handleNewTemplate = () => {
        const newTemplateBody = t.raw('newTemplateBody');
        const newTpl: EmailTemplate = {
            id: -1, // Use -1 or another sentinel number for new templates
            name: t('newTemplateName'),
            subject: '',
            body: newTemplateBody,
            variables: [],
            created_at: new Date().toISOString(),
            user_id: '',
            team_id: null // Add team_id as required by the type
        };
        setSelectedTemplate(newTpl);
    };

    const handleSaveTemplate = () => {
        if (!selectedTemplate) return;
        const templateData = { 
            name: selectedTemplate.name, 
            subject: selectedTemplate.subject, 
            body: selectedTemplate.body, 
            variables: detectedVariables 
        };
        
        startSaveTransition(async () => {
            const { data, error } = await saveTemplateAction(templateData, selectedTemplate.id !== null ? String(selectedTemplate.id) : null);
            if (error) {
                toast.error(t('toastErrorTitle'), { description: error.message });
            } else if (data) {
                toast.success(t('toastSuccessTitle'), { description: t('toastSaveSuccessDescription') });
                if (String(selectedTemplate?.id) === 'new') { 
                    setTemplates(prev => [data, ...prev]); 
                } else { 
                    setTemplates(prev => prev.map(t => String(t.id) === String(data.id) ? data : t)); 
                }
                setSelectedTemplate(data);
            }
        });
    };

    const handleDeleteTemplate = () => {
        if (!templateToDelete) return;
        startDeleteTransition(async () => {
            const { error } = await deleteTemplateAction(String(templateToDelete.id));
            if (error) {
                toast.error(t('toastErrorTitle'), { description: error.message });
            } else {
                toast.success(t('toastSuccessTitle'), { description: t('toastDeleteSuccessDescription') });
                const newTemplates = templates.filter(t => t.id !== templateToDelete.id);
                setTemplates(newTemplates);
                setSelectedTemplate(newTemplates[0] || null);
            }
            setTemplateToDelete(null);
        });
    };

    // Retornem tots els estats i funcions que el component necessita
    return {
        isSaving, isDeleting,
        templates,
        selectedTemplate, setSelectedTemplate,
        templateToDelete, setTemplateToDelete,
        detectedVariables, setDetectedVariables,
        handleNewTemplate,
        handleSaveTemplate,
        handleDeleteTemplate,
        t,
    };
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/transcripcio/actions.ts ===================

'use server'
// src/lib/services/comunicacio/transcripcio.service.ts
import { type SupabaseClient } from '@supabase/supabase-js';
import { type Database } from '@/types/supabase';
import type { DbTableInsert} from '@/types/db';
import { revalidatePath } from 'next/cache'
import { validateUserSession } from '@/lib/supabase/session'
// âœ… 1. Importem el tipus NOMÃ‰S per a Ãºs intern.
import * as transcripcioService from '@/lib/services/comunicacio/transcripcio.service'
import type { CreateAudioJobArgs } from '@/lib/services/comunicacio/transcripcio.service'
import { z } from 'zod'
// âœ… 1. Imports per a l'enviament d'email
import { Resend } from 'resend' // Assumim que fem servir Resend
import { TranscriptionSummaryEmail } from '@/emails/TranscriptionSummaryEmail' // La nostra plantilla
import { getTranslations } from 'next-intl/server'
import { redirect } from 'next/navigation';
// âŒ 2. ELIMINEM la lÃ­nia que fa "crash"
// export type { AudioJob }; 

/**
Â * ACCIÃ“: Crea una nova feina (job) a la taula 'audio_jobs'.
Â */
export async function createAudioJob(args: CreateAudioJobArgs) {
Â  // 1. Validar sessiÃ³
Â  const session = await validateUserSession()
Â  if ('error' in session) {
Â  Â  return { error: session.error.message }
Â  }
Â  const { supabase, user, activeTeamId } = session

Â  try {
Â  Â  // 2. Cridar al servei
Â  Â  const jobId = await transcripcioService.createAudioJob(
Â  Â  Â  Â  supabase,
Â  Â  Â  Â  args,
Â  Â  Â  Â  user.id,
Â  Â  Â  Â  activeTeamId
Â  Â  );

Â  Â  // 3. Efecte secundari
    // âœ… CANVI: Afegit el parÃ metre 'layout' per a la revalidaciÃ³ dinÃ mica.
Â  Â  revalidatePath('/[locale]/(app)/comunicacio/transcripcio', 'layout')
Â  Â  return { success: true, jobId: jobId }

Â  } catch (error: unknown) {
Â  Â  // 4. GestiÃ³ d'errors
Â  Â  const message = (error as Error).message;
Â  Â  console.error('Error creant audio_job (action):', message)
Â  Â  return { error: message }
Â  }
}

/**
Â * ACCIÃ“: ObtÃ© els detalls d'una feina d'Ã udio especÃ­fica.
Â */
export async function getAudioJobDetails(jobId: string) {
Â  // 1. Validar sessiÃ³
Â  const session = await validateUserSession()
Â  if ('error' in session) {
Â  Â  return { error: session.error.message }
Â  }
Â  const { supabase, activeTeamId } = session

Â  try {
Â  Â  // 2. Cridar al servei
Â  Â  const job = await transcripcioService.getAudioJobDetails(supabase, jobId, activeTeamId);
Â  Â  return { data: job };
Â  } catch (error: unknown) {
Â  Â  // 3. GestiÃ³ d'errors
Â  Â  const message = (error as Error).message;
Â  Â  return { error: message };
Â  }
}

/**
Â * ACCIÃ“: ObtÃ© totes les feines d'Ã udio per a l'equip actiu.
Â */
export async function getTeamAudioJobs() {
Â  // 1. Validar sessiÃ³
Â  const session = await validateUserSession()
Â  if ('error' in session) {
Â  Â  return { error: session.error.message }
Â  }
Â  const { supabase, activeTeamId } = session

Â  try {
Â  Â  // 2. Cridar al servei
Â  Â  const jobs = await transcripcioService.getTeamAudioJobs(supabase, activeTeamId);
Â  Â  return { data: jobs };
Â  } catch (error: unknown) {
Â  Â  // 3. GestiÃ³ d'errors
Â  Â  const message = (error as Error).message;
Â  Â  return { error: message };
Â  }
}

// --- NOVA ACCIÃ“ PER CREAR TASQUES MANUALS ---

// Esquema de validaciÃ³ per a la nova tasca
const createTaskSchema = z.object({
  title: z.string().min(3, "El tÃ­tol ha de tenir almenys 3 carÃ cters."),
  description: z.string().optional().nullable(),
  contact_id: z.number().nullable(),
  project_id: z.string().uuid().nullable(), // Assumim que project_id Ã©s un UUID
  job_id: z.number(), // Per enllaÃ§ar la tasca a la feina d'Ã udio
});

export async function createTaskFromTranscription(formData: FormData) {
  // 1. Validar sessiÃ³
  const session = await validateUserSession()
  if ('error' in session) {
    return { error: session.error.message }
  }
  const { supabase, user, activeTeamId } = session

  // 2. Validar dades del formulari
  const parseResult = createTaskSchema.safeParse({
    title: formData.get('title'),
    description: formData.get('description'),
    contact_id: formData.get('contact_id') ? Number(formData.get('contact_id')) : null,
    project_id: formData.get('project_id') || null,
    job_id: Number(formData.get('job_id')),
  });

  if (!parseResult.success) {
    return { error: 'Dades invÃ lides.', details: parseResult.error.flatten() };
  }

  const { title, description, contact_id,  job_id } = parseResult.data;

  // 3. Preparar dades per a la inserciÃ³
  const taskToInsert: DbTableInsert<'tasks'> = {
    team_id: activeTeamId,
    user_id: user.id,
    title,
    description: description || null,
    contact_id: contact_id || null,
    is_completed: false,
    priority: 'Mitjana', // Prioritat per defecte
  };
  
  // Alternativa si 'audio_job_id' no existeix:
  const finalDescription = (description || '') + 
    `\n\n---
    Tasca creada a partir de la transcripciÃ³: ${job_id}`;

  taskToInsert.description = finalDescription;


  // 4. Inserir a la base de dades
  try {
    const { error: insertError } = await supabase
      .from('tasks')
      .insert(taskToInsert);

    if (insertError) {
      throw new Error(insertError.message);
    }

    // 5. Revalidar i retornar Ã¨xit
    revalidatePath('/[locale]/(app)/crm/activitats'); // Revalidem la pÃ gina de tasques
    revalidatePath(`/[locale]/(app)/comunicacio/transcripcio/${job_id}`); // Revalidem la pÃ gina del job

    return { success: true };

  } catch (error: unknown) {
    const message = (error as Error).message;
    console.error('Error creant la tasca (action):', message);
    return { error: `No s'ha pogut crear la tasca: ${message}` };
  }
}


/**
 * âœ… NOU SERVEI: Esborra una feina d'Ã udio i el seu arxiu a l'storage.
 * LlanÃ§a un error si falla.
 */
export async function deleteAudioJob(
 Â  Â  supabase: SupabaseClient<Database>,
 Â  Â  jobId: string,
 Â  Â  teamId: string,
    storagePath: string
): Promise<void> {
    // 1. Esborrar la fila de la taula 'audio_jobs'
    const { error: dbError } = await supabase
        .from('audio_jobs')
        .delete()
        .eq('id', jobId)
        .eq('team_id', teamId);

    if (dbError) {
        console.error('Error esborrant feina (service):', dbError.message);
        throw new Error("No s'ha pogut esborrar la transcripciÃ³.");
    }

    // 2. Esborrar l'arxiu de l'storage
    const { error: storageError } = await supabase.storage
        .from('audio-uploads')
        .remove([storagePath]);

    if (storageError) {
        // No llancem error, nomÃ©s ho registrem. La feina ja estÃ  esborrada.
        console.warn(`Error esborrant arxiu de l'storage (${storagePath}):`, storageError.message);
    }
}

/**
 * âœ… NOU SERVEI: ObtÃ© els emails dels contactes participants.
 * LlanÃ§a un error si falla.
 */
export async function getParticipantEmails(
 Â  Â  supabase: SupabaseClient<Database>,
    contactIds: number[],
    teamId: string
): Promise<string[]> {
    if (contactIds.length === 0) return [];

    const { data, error } = await supabase
        .from('contacts')
        .select('email')
        .in('id', contactIds)
        .eq('team_id', teamId)
        .not('email', 'is', null); // Assegurem que l'email no sigui nul

    if (error) {
        console.error('Error obtenint emails participants (service):', error.message);
        throw new Error("No s'han pogut obtenir els emails dels destinataris.");
    }
    
    // Filtrem per assegurar que nomÃ©s retornem emails vÃ lids
    return data.map(c => c.email).filter((email): email is string => !!email);
}

// --- âœ… 2. NOVA ACCIÃ“ PER ESBORRAR TRANSCRIPCIÃ“ ---

const deleteJobSchema = z.object({
  jobId: z.string().uuid(),
  storagePath: z.string().min(1),
  locale: z.string().min(2),
});

export async function deleteAudioJobAction(formData: FormData) {
  // 1. Validar sessiÃ³
  const session = await validateUserSession()
  if ('error' in session) {
    return { error: session.error.message }
  }
  const { supabase, activeTeamId } = session

  // 2. Validar dades
  const parseResult = deleteJobSchema.safeParse({
    jobId: formData.get('jobId'),
    storagePath: formData.get('storagePath'),
    locale: formData.get('locale'),
  });

  if (!parseResult.success) {
    return { error: 'Dades invÃ lides.' };
  }
  
  const { jobId, storagePath, locale } = parseResult.data;

  // 3. Cridar al servei
  try {
    await transcripcioService.deleteAudioJob(supabase, jobId, activeTeamId, storagePath);
  } catch (error: unknown) {
    return { error: (error as Error).message };
  }

  // 4. Revalidar i redirigir
  revalidatePath('/[locale]/(app)/comunicacio/transcripcio', 'layout');
  redirect(`/${locale}/comunicacio/transcripcio`);
}


// --- âœ… 3. NOVA ACCIÃ“ PER ENVIAR RESUM PER EMAIL ---

const sendEmailSchema = z.object({
  jobId: z.string().uuid(),
});

export async function sendTranscriptionSummaryEmailAction(formData: FormData) {
  // 1. Validar sessiÃ³
  const session = await validateUserSession()
  if ('error' in session) {
    return { error: session.error.message }
  }
  const { supabase, activeTeamId, user } = session;
  const t = await getTranslations('Transcripcio'); // Carreguem traduccions

  // 2. Validar dades
  const parseResult = sendEmailSchema.safeParse({
    jobId: formData.get('jobId'),
  });
  if (!parseResult.success) return { error: t('sendEmailInvalidData') };
  
  const { jobId } = parseResult.data;

  // 3. Inicialitzar Resend (o el teu proveÃ¯dor d'email)
  if (!process.env.RESEND_API_KEY) {
    return { error: 'RESEND_API_KEY no estÃ  configurat.' };
  }
  const resend = new Resend(process.env.RESEND_API_KEY);

  try {
    // 4. Obtenir Dades de la Feina (incloent key_moments)
    const job = await transcripcioService.getAudioJobDetails(supabase, jobId, activeTeamId);
    
    // 5. Obtenir Emails dels Participants
    const participantIds = (job.participants as { contact_id: number | null }[])
        ?.map(p => p.contact_id)
        .filter(id => id != null) || [];
        
    const recipientEmails = await transcripcioService.getParticipantEmails(supabase, participantIds, activeTeamId);

    if (recipientEmails.length === 0) {
      return { error: t('sendEmailNoRecipients') };
    }

    // 6. Renderitzar la plantilla de React Email a HTML
    const emailSubject = t('sendEmailSubject', { jobDate: new Date(job.created_at).toLocaleDateString('ca-ES') });
    
    const { data: emailHtml, error: renderError } = await resend.emails.send({
        from: process.env.RESEND_FROM_EMAIL || 'RibotFlow <no-reply@ribotflow.com>',
        to: recipientEmails,
        cc: user.email, // Enviem una cÃ²pia a l'usuari que fa l'acciÃ³
        subject: emailSubject,
        // Passem les dades a la nostra plantilla
        react: TranscriptionSummaryEmail({
          job: job,
          emailSubject: emailSubject,
          t: t, // Passem les traduccions
        }),
    });

    if (renderError) {
      throw new Error(`Error renderitzant email: ${renderError.message}`);
    }

    return { success: true };

  } catch (error: unknown) {
    const message = (error as Error).message;
    console.error('Error enviant email de resum (action):', message);
    return { error: message };
  }
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/transcripcio/new/page.tsx ===================

import { validatePageSession } from '@/lib/supabase/session'
import { PageHeader } from '@/components/shared/PageHeader'
import { getTeamContactsList } from '@/app/[locale]/(app)/crm/contactes/actions'
// âœ… El component ara estÃ  a la seva prÃ²pia carpeta
import { AudioJobUploader } from './_components/AudioJobUploader'

export default async function AudioTranscriberPage() {
  // âœ… validatePageSession retorna l'ID de l'equip
  const { activeTeamId } = await validatePageSession()

  const contacts = await getTeamContactsList()

  return (
    <div className="flex flex-col h-full">
      <PageHeader
        title="Nova TranscripciÃ³"
        description="Puja un Ã udio i selecciona els participants per extreure tasques."
      />
      <div className="flex-1 overflow-auto p-4 md:p-6">
        {/* âœ… Passem el 'teamId' i els 'contacts' al client */}
        <AudioJobUploader contacts={contacts} teamId={activeTeamId} />
      </div>
    </div>
  )
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/transcripcio/new/_components/AudioJobUploader.tsx ===================

'use client'

import React, { useState, useTransition, useMemo } from 'react'
import { createClient as createSupabaseBrowserClient } from '@/lib/supabase/client'
import { Button } from '@/components/ui/button'
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { toast } from 'sonner'
import { useRouter } from 'next/navigation'
import { Loader2, UploadCloud, UserPlus, X } from 'lucide-react'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
  DialogFooter,
  DialogClose,
} from '@/components/ui/dialog'
import { Badge } from '@/components/ui/badge'
import { ContactSelector } from '@/components/features/contactes/ContactSelector'
import { createAudioJob } from '../../actions'
import type { Database } from '@/types/supabase' // âœ… Importem Database

// âœ¨ CORRECCIÃ“: Fem servir el tipus real de la BD
type Contact = Database['public']['Tables']['contacts']['Row']

// Aquest tipus el fem servir internament per a la llista de participants
interface ParticipantInput {
  contact_id: number
  name: string // El 'nom' del contacte
  role: string // El 'job_title' o rol
}

// âœ… La prop 'contacts' ara Ã©s del tipus correcte
export function AudioJobUploader({ contacts, teamId }: { contacts: Contact[], teamId: string }) {
  const [file, setFile] = useState<File | null>(null)
  const [participants, setParticipants] = useState<ParticipantInput[]>([])
  const [isPending, startTransition] = useTransition()
  const router = useRouter()
  const supabase = createSupabaseBrowserClient()

  const [isModalOpen, setIsModalOpen] = useState(false)
  const [currentSelectedContactId, setCurrentSelectedContactId] = useState<
    number | null
  >(null)

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      setFile(e.target.files[0])
    }
  }

  // Filtrem els contactes que ja han estat afegits
  const availableContacts = useMemo(() => {
    const selectedIds = new Set(participants.map((p) => p.contact_id))
    return contacts.filter((c) => !selectedIds.has(c.id))
  }, [contacts, participants])

  // FunciÃ³ per afegir el contacte seleccionat al Dialog
  const handleAddParticipant = () => {
    if (!currentSelectedContactId) return

    const contactToAdd = contacts.find((c) => c.id === currentSelectedContactId)
    if (contactToAdd) {
      setParticipants((prev) => [
        ...prev,
        {
          contact_id: contactToAdd.id,
          name: contactToAdd.nom ?? 'N/A', // Assegurem que 'name' sigui string
          role: contactToAdd.job_title || 'Contacte', // âœ… Llegim 'job_title'
        },
      ])
    }
    setCurrentSelectedContactId(null)
    setIsModalOpen(false)
  }

  // FunciÃ³ per eliminar un participant de la llista
  const removeParticipant = (contactId: number) => {
    setParticipants((prev) =>
      prev.filter((p) => p.contact_id !== contactId)
    )
  }

  // ... (La funciÃ³ handleSubmit es queda exactament igual)
  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault()
    if (!file || participants.length === 0) {
      toast.error('Error', {
        description:
          'Necessites pujar un arxiu i seleccionar almenys un participant.',
      })
      return
    }

    startTransition(async () => {
      try {
        const fileExt = file.name.split('.').pop()
        const fileName = `${new Date().toISOString()}.${fileExt}`

        // âœ¨ MILLORA: Creem la ruta amb el teamId
        const filePath = `${teamId}/${fileName}`

        const { error: uploadError } = await supabase.storage
          .from('audio-uploads')
          .upload(filePath, file) // Pugem al path correcte: 'TEAM_ID/nom_fitxer.mp3'

        if (uploadError) {
          throw new Error(`Error pujant arxiu: ${uploadError.message}`)
        }

        // 'storagePath' ara Ã©s 'TEAM_ID/nom_fitxer.mp3'
        const result = await createAudioJob({
          storagePath: filePath,
          participants: participants,
          projectId: null,
        })

        if (result.error) {
          throw new Error(result.error)
        }

        toast.success('Ãˆxit!', {
          description:
            "El teu Ã udio s'estÃ  processant. VeurÃ s els resultats aviat.",
        })

        router.push(
          `/comunicacio/transcripcio/${result.jobId}`
        )
      } catch (error) {
        toast.error('Error en el procÃ©s', {
          description: (error as Error).message,
        })
      }
    })
  }

  return (
    <>
      <Card className="max-w-2xl mx-auto">
        <CardHeader>
          <CardTitle>Nova TranscripciÃ³ d'Ã€udio</CardTitle>
          <CardDescription>
            Puja la gravaciÃ³ i assigna els participants per a l'extracciÃ³ de
            tasques.
          </CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit} className="space-y-6">
            <div className="space-y-2">
              <Label htmlFor="audio-file">
                1. Arxiu d'Ã€udio (.mp3, .m4a, .wav)
              </Label>
              <Input
                id="audio-file"
                type="file"
                accept="audio/*"
                onChange={handleFileChange}
                disabled={isPending}
              />
            </div>

            <div className="space-y-3">
              <Label>2. Participants de la ReuniÃ³</Label>
              <div className="flex flex-wrap gap-2 p-2 border rounded-md min-h-[40px] bg-background">
                {participants.map((p) => (
                  <Badge
                    key={p.contact_id}
                    variant="secondary"
                    className="flex items-center gap-1"
                  >
                    {p.name || 'N/A'} ({p.role}) {/* p.name Ã©s el 'nom' guardat */}
                    <button
                      type="button"
                      onClick={() => removeParticipant(p.contact_id)}
                      className="rounded-full hover:bg-muted-foreground/20"
                      disabled={isPending}
                    >
                      <X className="h-3 w-3" />
                    </button>
                  </Badge>
                ))}
                {participants.length === 0 && (
                  <span className="text-sm text-muted-foreground p-1">
                    Cap participant afegit...
                  </span>
                )}
              </div>
              <Dialog open={isModalOpen} onOpenChange={setIsModalOpen}>
                <DialogTrigger asChild>
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    disabled={isPending}
                  >
                    <UserPlus className="mr-2 h-4 w-4" />
                    Afegir Participant
                  </Button>
                </DialogTrigger>
                <DialogContent>
                  <DialogHeader>
                    <DialogTitle>Selecciona un Participant</DialogTitle>
                  </DialogHeader>
                  <div className="py-4">
                    {/*
                      âœ… 'availableContacts' Ã©s de tipus Contact[]
                      ContactSelector espera MinimalContact[] ({ id, nom })
                      AixÃ² Ã©s compatible, ja que Contact[] tÃ© 'id' i 'nom'.
                    */}
                    <ContactSelector
                      contacts={availableContacts}
                      selectedId={currentSelectedContactId}
                      onSelect={(id: number | null) =>
                        setCurrentSelectedContactId(id)
                      }
                      disabled={isPending}
                    />
                  </div>
                  <DialogFooter>
                    <DialogClose asChild>
                      <Button type="button" variant="ghost">
                        CancelÂ·lar
                      </Button>
                    </DialogClose>
                    <Button
                      type="button"
                      onClick={handleAddParticipant}
                      disabled={!currentSelectedContactId}
                    >
                      Afegir
                    </Button>
                  </DialogFooter>
                </DialogContent>
              </Dialog>
            </div>

            <Button type="submit" className="w-full" disabled={isPending}>
              {isPending ? (
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
              ) : (
                <UploadCloud className="mr-2 h-4 w-4" />
              )}
              Pujar i Processar
            </Button>
          </form>
        </CardContent>
      </Card>
    </>
  )
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/transcripcio/page.tsx ===================

// src/app/[locale]/(app)/comunicacio/transcripcio/page.tsx
import { validatePageSession } from '@/lib/supabase/session'
import { PageHeader } from '@/components/shared/PageHeader'
import { getTeamAudioJobs } from '@/lib/services/comunicacio/transcripcio.service' 
import { AudioJobsList } from './_components/AudioJobsList'
import { Button } from '@/components/ui/button'
import { Plus } from 'lucide-react'
import Link from 'next/link'
import { Alert, AlertTitle, AlertDescription } from '@/components/ui/alert'
import { Terminal } from 'lucide-react'
// âœ… CANVI: Importem el tipus directament des de la font original.
import type { AudioJob } from '@/types/db'

export default async function TranscripcioListPage() {
Â  // ... (la resta de la funciÃ³ es mantÃ© igual) ...
Â  const session = await validatePageSession()
Â  if ('error' in session) {
Â  Â  Â  return null;
Â  }
Â  const { supabase, activeTeamId } = session;

Â  let initialJobs: Pick<AudioJob, 'id' | 'created_at' | 'status' | 'summary' | 'error_message'>[] = [];
Â  let fetchError: string | null = null;

Â  try {
Â  Â  initialJobs = await getTeamAudioJobs(supabase, activeTeamId);
Â  } catch (error) {
Â  Â  fetchError = (error as Error).message;
Â  }

Â  return (
Â  Â  <div className="flex flex-col h-full">
Â  Â  Â  <PageHeader
Â  Â  Â  Â  title="Transcripcions d'Ã€udio"
Â  Â  Â  Â  description="Gestiona les teves gravacions i tasques extretes."
Â  Â  Â  >
Â  Â  Â  Â  <Link href="/comunicacio/transcripcio/new" passHref>
Â  Â  Â  Â  Â  <Button>
Â  Â  Â  Â  Â  Â  <Plus className="mr-2 h-4 w-4" />
Â  Â  Â  Â  Â  Â  Nova TranscripciÃ³
Â  Â  Â  Â  Â  </Button>
Â  Â  Â  Â  </Link>
Â  Â  Â  </PageHeader>
Â  Â  Â  
Â  Â  Â  <div className="flex-1 overflow-auto p-4 md:p-6">
Â  Â  Â  Â  {fetchError && (
Â  Â  Â  Â  Â  <Alert variant="destructive">
Â  Â  Â  Â  Â  Â  <Terminal className="h-4 w-4" />
Â  Â  Â  Â  Â  Â  <AlertTitle>Error</AlertTitle>
Â  Â  Â  Â  Â  Â  <AlertDescription>{fetchError}</AlertDescription>
Â  Â  Â  Â  Â  </Alert>
Â  Â  Â  Â  )}
Â  Â  Â  Â  <AudioJobsList initialJobs={initialJobs} />
Â  Â  Â  </div>
Â  Â  </div>
Â  )
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/transcripcio/[jobId]/page.tsx ===================

import { validatePageSession } from '@/lib/supabase/session'
import { PageHeader } from '@/components/shared/PageHeader'
import { getAudioJobDetails } from '../actions'
import { AudioJobResult } from './_components/AudioJobResult'
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'
import { Terminal, ArrowLeft } from 'lucide-react'
import { getTranslations } from 'next-intl/server'
import Link from 'next/link'
import { Button } from '@/components/ui/button'

// âœ… CANVI 1: El tipus de 'params' torna a ser una Promise.
interface AudioJobPageProps {
Â  params: Promise<{ 
Â  Â  jobId: string
Â  }>;
}

export default async function AudioJobPage(props: AudioJobPageProps) {
Â  // âœ… CANVI 2: Resolem 'params' amb 'await' abans d'utilitzar-lo.
Â  const params = await props.params; 
Â  
Â  // 1. Validar sessiÃ³
Â  await validatePageSession()
  const t = await getTranslations('Transcripcio'); 

Â  // 2. Obtenir les dades inicials de la feina
Â  const { data: initialJob, error } = await getAudioJobDetails(params.jobId) // <--- Ara 'params' Ã©s l'objecte resolt

Â  if (error || !initialJob) {
Â  Â  return (
Â  Â  Â  <Alert variant="destructive" className="max-w-2xl mx-auto">
Â  Â  Â  Â  <Terminal className="h-4 w-4" />
Â  Â  Â  Â  <AlertTitle>{t('errorTitle')}</AlertTitle>
Â  Â  Â  Â  <AlertDescription>
          {t('errorLoading')}
Â  Â  Â  Â  </AlertDescription>
Â  Â  Â  </Alert>
Â  Â  )
Â  }

Â  return (
Â  Â  <div className="flex flex-col h-full">
Â  Â  Â  <PageHeader
Â  Â  Â  Â  title={t('detailTitle')}
Â  Â  Â  Â  description={t('detailDescription', { jobId: params.jobId })} // <--- Ara 'params' Ã©s l'objecte resolt
Â  Â  Â  >
        <Link href="/comunicacio/transcripcio" passHref>
          <Button variant="outline">
            <ArrowLeft className="mr-2 h-4 w-4" />
            {t('backToListButton')}
          </Button>
        </Link>
      </PageHeader>
Â  Â  Â  <div className="flex-1 overflow-auto p-4 md:p-6">
Â  Â  Â  Â  <AudioJobResult initialJob={initialJob} />
Â  Â  Â  </div>
Â  Â  </div>
Â  )
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/transcripcio/[jobId]/_components/AudioJobResult.tsx ===================

'use client'

import React, { useState, useEffect, useTransition } from 'react'
import { createClient as createSupabaseBrowserClient } from '@/lib/supabase/client'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert'
import { Loader2, CheckCircle, XCircle, ListPlus, MoreVertical, Trash2, Send, ChevronDown } from 'lucide-react'
import { useTranslations } from 'next-intl'
import { useLocale } from 'next-intl'
import { toast } from 'sonner'

import type { AudioJob } from '@/types/db'
// âœ… 1. Importem els nous components
import { JobStatusBadge } from '../../_components/JobStatusBadge'
import { FormattedTranscription } from '../../_components/FormattedTranscription'
import { ParticipantsList } from '../../_components/ParticipantsList'
import { CreateTaskDialog } from '../../_components/CreateTaskDialog'

interface AudioJobResultProps {
  initialJob: AudioJob
}

import { Button } from '@/components/ui/button'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu"
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog"
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from "@/components/ui/collapsible"
// âœ… NOU: Importem el nou flux
import { KeyMomentsFlow } from '../../_components/KeyMomentsFlow'
// âœ… NOU: Importem les accions
import { deleteAudioJobAction, sendTranscriptionSummaryEmailAction } from '../../actions'


interface AudioJobResultProps {
  initialJob: AudioJob
}

export function AudioJobResult({ initialJob }: AudioJobResultProps) {
  const [job, setJob] = useState(initialJob)
  const [isTaskDialogOpen, setIsTaskDialogOpen] = useState(false)
  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false)
  const [isSendingEmail, startEmailTransition] = useTransition()
  const [isDeleting, startDeleteTransition] = useTransition()
  
  const supabase = createSupabaseBrowserClient()
  const t = useTranslations('Transcripcio');
  const locale = useLocale();
  
   useEffect(() => {
    const channel = supabase
      .channel(`audio_job_${job.id}`)
      .on(
        'postgres_changes',
        {
          event: 'UPDATE',
          schema: 'public',
          table: 'audio_jobs',
          filter: `id=eq.${job.id}`,
        },
        (payload) => {
          console.log('Canvi rebut en temps real!', payload)
          setJob(payload.new as AudioJob)
        }
      )
      .subscribe()

    return () => {
      supabase.removeChannel(channel)
    }
  }, [supabase, job.id])


  // --- Gestors d'Accions ---

  const handleDelete = () => {
    startDeleteTransition(async () => {
      const formData = new FormData();
      formData.append('jobId', job.id);
      formData.append('storagePath', job.storage_path);
      formData.append('locale', locale);

      const result = await deleteAudioJobAction(formData);
      if (result?.error) {
        toast.error(t('deleteErrorTitle'), { description: result.error });
      }
      // Si tÃ© Ã¨xit, la Server Action ja fa un redirect()
    });
  };

  const handleSendEmail = () => {
    startEmailTransition(async () => {
      const formData = new FormData();
      formData.append('jobId', job.id);
      
      const result = await sendTranscriptionSummaryEmailAction(formData);

      if (result.error) {
        toast.error(t('sendEmailErrorTitle'), { description: result.error });
      } else {
        toast.success(t('sendEmailSuccessTitle'));
      }
    });
  };


  // --- Renderitzat ---

  return (
    <>
      {/* --- DIÃ€LEGS (ARA SÃ“N GLOBALS) --- */}
      
      {/* âœ… 1. DiÃ leg de creaciÃ³ de tasca (nomÃ©s s'usa en 'completed') */}
      <CreateTaskDialog
        open={isTaskDialogOpen}
        onOpenChange={setIsTaskDialogOpen}
        job={job}
        defaultValues={{
          summary: job.summary,
          transcription: job.transcription_text,
        }}
      />
      
      {/* âœ… 2. DiÃ leg d'esborrat (MOGUT A NIVELL SUPERIOR) */}
      {/* Ara es pot cridar des de 'completed' o 'failed' */}
      <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>{t('deleteDialogTitle')}</AlertDialogTitle>
            <AlertDialogDescription>{t('deleteDialogDescription')}</AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={isDeleting}>{t('cancelButton')}</AlertDialogCancel>
            <AlertDialogAction 
              onClick={handleDelete} 
              disabled={isDeleting} 
              className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
            >
              {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}
              {t('deleteButtonConfirm')}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    
      
      {/* --- ESTATS DE RENDERITZAT --- */}
      
      {/* 1. Estat Pendent o Processant */}
      {(job.status === 'pending' || job.status === 'processing') && (
        <Card className="max-w-2xl mx-auto text-center">
          <CardHeader>
            <CardTitle>{t('pendingTitle')}</CardTitle>
            <CardDescription>{t('pendingDescription')}</CardDescription>
          </CardHeader>
          <CardContent>
            <Loader2 className="h-12 w-12 mx-auto animate-spin text-primary" />
            <p className="text-sm text-muted-foreground mt-4">
              <JobStatusBadge status={job.status} />
            </p>
          </CardContent>
        </Card>
      )}

      {/* âœ… 3. Estat Fallit (NOU LAYOUT AMB ACCIONS) */}
      {job.status === 'failed' && (
        <div className="max-w-2xl mx-auto space-y-6">
          <Alert variant="destructive">
            <XCircle className="h-4 w-4" />
            <AlertTitle>{t('failedTitle')}</AlertTitle>
            <AlertDescription>
              <p>{t('failedDescription')}</p>
              <pre className="mt-2 p-2 bg-background rounded text-sm whitespace-pre-wrap">
                {job.error_message || t('errorUnknown')}
              </pre>
            </AlertDescription>
          </Alert>
          
          <Card>
            <CardHeader>
              <CardTitle>{t('actionsTitle')}</CardTitle>
            </CardHeader>
            <CardContent>
              <Button 
                variant="destructive" 
                className="w-full" 
                onClick={() => setIsDeleteDialogOpen(true)}
                disabled={isDeleting}
              >
                {isDeleting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Trash2 className="mr-2 h-4 w-4" />}
                {t('deleteButton')}
              </Button>
            </CardContent>
          </Card>
        </div>
      )}

      {/* 4. Estat Completat (Sense canvis, ja utilitza els diÃ legs globals) */}
      {job.status === 'completed' && (
        <div className="max-w-7xl mx-auto space-y-6 lg:grid lg:grid-cols-3 lg:gap-6 lg:space-y-0">
          
          {/* Columna Esquerra (Info i Accions) */}
          <div className="lg:col-span-1 space-y-6">
            <Alert variant="default">
              <CheckCircle className="h-4 w-4" />
              <AlertTitle>{t('completedTitle')}</AlertTitle>
              <AlertDescription>{t('completedDescription')}</AlertDescription>
            </Alert>
            
            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle>{t('actionsTitle')}</CardTitle>
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="ghost" size="icon" disabled={isSendingEmail || isDeleting}>
                      <MoreVertical className="h-5 w-5" />
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    <DropdownMenuItem onClick={handleSendEmail} disabled={isSendingEmail}>
                      {isSendingEmail ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <Send className="mr-2 h-4 w-4" />}
                      {t('sendEmailButton')}
                    </DropdownMenuItem>
                    <DropdownMenuSeparator />
                    <DropdownMenuItem onClick={() => setIsDeleteDialogOpen(true)} disabled={isDeleting} className="text-destructive focus:text-destructive">
                      <Trash2 className="mr-2 h-4 w-4" />
                      {t('deleteButton')}
                    </DropdownMenuItem>
                  </DropdownMenuContent>
                </DropdownMenu>
              </CardHeader>
              <CardContent>
                <Button className="w-full" onClick={() => setIsTaskDialogOpen(true)}>
                  <ListPlus className="mr-2 h-4 w-4" />
                  {t('createTaskButton')}
                </Button>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle>{t('summaryTitle')}</CardTitle>
              </CardHeader>
              <CardContent className="prose prose-sm dark:prose-invert max-w-none">
                <p>{job.summary || t('summaryEmpty')}</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader>
                <CardTitle>{t('participantsTitle')}</CardTitle>
              </CardHeader>
              <CardContent>
                <ParticipantsList participants={job.participants} />
              </CardContent>
            </Card>
          </div>

          {/* Columna Dreta (Flux i TranscripciÃ³) */}
          <div className="lg:col-span-2 space-y-6">
            <KeyMomentsFlow moments={job.key_moments} />
            <Collapsible>
              <Card>
                <CollapsibleTrigger asChild>
                    <div className="flex items-center justify-between cursor-pointer p-6">
                      <CardTitle>{t('fullTranscriptionTitle')}</CardTitle>
                      <Button variant="ghost" size="sm" className="w-9 p-0">
                        <ChevronDown className="h-4 w-4 transition-transform [&[data-state=open]]:rotate-180" />
                        <span className="sr-only">{t('toggleButton')}</span>
                      </Button>
                    </div>
                </CollapsibleTrigger>
                <CollapsibleContent>
                  <CardContent>
                    <FormattedTranscription text={job.transcription_text} />
                  </CardContent>
                </CollapsibleContent>
              </Card>
            </Collapsible>
          </div>
        </div>
      )}
    </>
  )
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/transcripcio/_components/AudioJobsList.tsx ===================

'use client'

import React, { useState, useEffect } from 'react'
import { createClient as createSupabaseBrowserClient} from '@/lib/supabase/client'
import { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { FileText } from 'lucide-react'
import Link from 'next/link'
import { formatDistanceToNow } from 'date-fns'
import { ca } from 'date-fns/locale'

// âœ… 1. Importem el tipus des de la font original
import type { AudioJob } from '@/types/db'
import { JobStatusBadge } from './JobStatusBadge'

// Redefinim el tipus localment per a la llista (nomÃ©s els camps que necessitem)
type AudioJobListJob = Pick<AudioJob, 
  'id' | 'created_at' | 'status' | 'summary' | 'error_message'
>
// ... (la resta del component es mantÃ© igual) ...
export function AudioJobsList({ initialJobs }: { initialJobs: AudioJobListJob[] }) {
  const [jobs, setJobs] = useState(initialJobs)
  const supabase = createSupabaseBrowserClient()

  useEffect(() => {
    const channel = supabase
      .channel('audio_jobs_list')
      .on(
        'postgres_changes',
        { event: '*', schema: 'public', table: 'audio_jobs' },
        (payload) => {
          console.log('Canvi rebut a la llista:', payload)
          if (payload.eventType === 'INSERT') {
            setJobs((prevJobs) => [payload.new as AudioJobListJob, ...prevJobs])
          }
          if (payload.eventType === 'UPDATE') {
            setJobs((prevJobs) =>
              prevJobs.map((job) =>
                job.id === payload.old.id ? (payload.new as AudioJobListJob) : job
              )
            )
          }
        }
      )
      .subscribe()

    return () => {
      supabase.removeChannel(channel)
    }
  }, [supabase])

  if (jobs.length === 0) {
    return <p className='text-center text-muted-foreground'>No hi ha cap transcripciÃ³.</p>
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {jobs.map((job) => (
        <Link href={`/comunicacio/transcripcio/${job.id}`} key={job.id} passHref>
          <Card className="hover:border-primary/50 transition-colors h-full flex flex-col">
            <CardHeader>
              <CardTitle className="flex items-center justify-between">
                <span>Feina d'Ã€udio</span>
                <JobStatusBadge status={job.status} />
              </CardTitle>
              <CardDescription>
                Creat {formatDistanceToNow(new Date(job.created_at!), { addSuffix: true, locale: ca })}
              </CardDescription>
            </CardHeader>
            <CardContent className="flex-grow">
              {job.status === 'completed' && (
                <p className="text-sm text-muted-foreground line-clamp-3">
                  {job.summary || 'Completat sense resum.'}
                </p>
              )}
              {job.status === 'failed' && (
                <p className="text-sm text-destructive line-clamp-3">
                  {job.error_message || 'Error desconegut'}
                </p>
              )}
              {(job.status === 'pending' || job.status === 'processing') && (
                <p className="text-sm text-muted-foreground">
                  La transcripciÃ³ estÃ  en progrÃ©s...
                </p>
              )}
            </CardContent>
            <CardFooter>
              <Button variant="outline" size="sm" className="w-full">
                <FileText className="mr-2 h-4 w-4" />
                Veure Detalls
              </Button>
            </CardFooter>
          </Card>
        </Link>
      ))}
    </div>
  )
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/transcripcio/_components/CreateTaskDialog.tsx ===================

"use client";

import React, { useState, useTransition } from 'react';
import { useTranslations } from 'next-intl';
import { toast } from 'sonner';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Loader2 } from 'lucide-react';
import { createTaskFromTranscription } from '../actions';
import type { AudioJob } from '@/types/db';// Assumim que tenim un selector de contactes global
import { ContactSelector } from '@/components/features/contactes/ContactSelector';

interface CreateTaskDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  job: AudioJob; // Passem tota la feina per obtenir IDs
  defaultValues: {
    summary: string | null;
    transcription: string | null;
  };
}

export function CreateTaskDialog({ open, onOpenChange, job, defaultValues }: CreateTaskDialogProps) {
  const t = useTranslations('Transcripcio');
  const [isPending, startTransition] = useTransition();
  const [title, setTitle] = useState(t('defaultTaskTitle'));
  const [description, setDescription] = useState(defaultValues.summary || defaultValues.transcription || '');
  const [selectedContactId, setSelectedContactId] = useState<number | null>(null);

  const handleSubmit = () => {
    startTransition(async () => {
      const formData = new FormData();
      formData.append('title', title);
      formData.append('description', description);
      if (selectedContactId) {
        formData.append('contact_id', String(selectedContactId));
      }
      if (job.project_id) {
        formData.append('project_id', job.project_id);
      }
      formData.append('job_id', String(job.id));

      const result = await createTaskFromTranscription(formData);

      if (result.error) {
        toast.error(t('createTaskErrorTitle'), { description: result.error });
      } else {
        toast.success(t('createTaskSuccessTitle'));
        onOpenChange(false);
        // Resetejem el formulari
        setTitle(t('defaultTaskTitle'));
        setDescription(defaultValues.summary || defaultValues.transcription || '');
        setSelectedContactId(null);
      }
    });
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-lg">
        <DialogHeader>
          <DialogTitle>{t('createTaskDialogTitle')}</DialogTitle>
          <DialogDescription>{t('createTaskDialogDescription')}</DialogDescription>
        </DialogHeader>
        <div className="grid gap-4 py-4">
          <div className="space-y-2">
            <Label htmlFor="title">{t('createTaskLabelTitle')}</Label>
            <Input
              id="title"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              disabled={isPending}
            />
          </div>
          <div className="space-y-2">
            <Label htmlFor="description">{t('createTaskLabelDescription')}</Label>
            <Textarea
              id="description"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              disabled={isPending}
              rows={8}
            />
          </div>
          <div className="space-y-2">
            <Label>{t('createTaskLabelAssignee')}</Label>
            
          </div>
        </div>
        <DialogFooter>
          <Button variant="ghost" onClick={() => onOpenChange(false)} disabled={isPending}>
            {t('cancelButton')}
          </Button>
          <Button onClick={handleSubmit} disabled={isPending}>
            {isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
            {t('createButton')}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/transcripcio/_components/FormattedTranscription.tsx ===================

"use client";

import React from 'react';

interface FormattedTranscriptionProps {
  text: string | null;
}

export function FormattedTranscription({ text }: FormattedTranscriptionProps) {
  if (!text) {
    return (
      <p className="text-muted-foreground italic">
        No s'ha generat cap transcripciÃ³.
      </p>
    );
  }

  return (
    <div className="prose prose-sm sm:prose-base dark:prose-invert max-w-none">
      {/* 'whitespace-pre-wrap' Ã©s clau aquÃ­: 
        Respecta els salts de lÃ­nia i els espais en blanc del text original, 
        perÃ² fa un 'wrap' del text si se surt del contenidor.
      */}
      <p style={{ whiteSpace: 'pre-wrap' }}>{text}</p>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/transcripcio/_components/JobStatusBadge.tsx ===================

"use client";

import React from 'react';
// âœ… CANVI: Importem el tipus des de la font original
import type { AudioJob } from '@/types/db';
import { Badge } from '@/components/ui/badge';
import { Loader2, CheckCircle, XCircle } from 'lucide-react';

// Definim el tipus d'estat basant-nos en el tipus importat
type JobStatus = AudioJob['status'];

// Definim els colors adaptables per a tema clar/fosc
const statusStyles: Record<JobStatus | 'default', { className: string; icon: React.ElementType }> = {
  completed: {
    className: 'bg-green-100 text-green-800 border-green-200 dark:bg-green-500/20 dark:text-green-300 dark:border-green-500/30',
    icon: CheckCircle,
  },
  failed: {
    className: 'bg-red-100 text-red-800 border-red-200 dark:bg-red-500/20 dark:text-red-300 dark:border-red-500/30',
    icon: XCircle,
  },
  processing: {
    className: 'bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-500/20 dark:text-blue-300 dark:border-blue-500/30',
    icon: Loader2,
  },
  pending: {
    className: 'bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-500/20 dark:text-blue-300 dark:border-blue-500/30',
    icon: Loader2,
  },
  default: {
    className: 'bg-gray-100 text-gray-800 border-gray-200 dark:bg-gray-500/20 dark:text-gray-300 dark:border-gray-500/30',
    icon: Loader2,
  },
};

// Mapejem els estats a les traduccions
const statusLabels: Record<JobStatus | 'default', string> = {
  completed: 'Completat',
  failed: 'Fallit',
  processing: 'En progrÃ©s',
  pending: 'Pendent',
  default: 'Desconegut',
};

interface JobStatusBadgeProps {
  status: JobStatus;
}

export function JobStatusBadge({ status }: JobStatusBadgeProps) {
  const style = statusStyles[status] ?? statusStyles.default;
  const label = statusLabels[status] ?? statusLabels.default;
  const Icon = style.icon;
  const isSpinning = status === 'pending' || status === 'processing';

  return (
    <Badge variant="outline" className={style.className}>
      <Icon className={`mr-1 h-3 w-3 ${isSpinning ? 'animate-spin' : ''}`} />
      {label}
    </Badge>
  );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/transcripcio/_components/KeyMomentsFlow.tsx ===================

"use client";

import React from 'react';
import type { AudioJob } from '@/types/db';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { FileText, CheckSquare, MessageSquareWarning } from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { useTranslations } from 'next-intl';

// Definim el tipus basat en el que la Edge Function retorna
type KeyMoment = {
  topic: string;
  details: string;
  decisions: string[];
  is_work_related: boolean;
}

interface KeyMomentsFlowProps {
  // Assegurem que key_moments pot ser 'any' (JSONB)
  moments: AudioJob['key_moments']; 
}

// Icona per a cada tipus de moment
const MomentIcon = ({ moment }: { moment: KeyMoment }) => {
  if (moment.decisions && moment.decisions.length > 0) {
    return <CheckSquare className="h-5 w-5 text-primary" />;
  }
  return <FileText className="h-5 w-5 text-muted-foreground" />;
}

export function KeyMomentsFlow({ moments }: KeyMomentsFlowProps) {
  const t = useTranslations('Transcripcio');
  
  // 1. Validar i filtrar les dades
  if (!moments || !Array.isArray(moments) || moments.length === 0) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>{t('keyMomentsTitle')}</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-muted-foreground">{t('keyMomentsEmpty')}</p>
        </CardContent>
      </Card>
    );
  }

  // 2. Filtrem el soroll (el que no Ã©s 'is_work_related')
  const workMoments = (moments as KeyMoment[]).filter(m => m.is_work_related);

  if (workMoments.length === 0) {
     return (
      <Card>
        <CardHeader>
          <CardTitle>{t('keyMomentsTitle')}</CardTitle>
        </CardHeader>
        <CardContent className="flex items-center gap-4 text-muted-foreground">
          <MessageSquareWarning className="h-8 w-8" />
          <p>{t('keyMomentsNoWork')}</p>
        </CardContent>
      </Card>
    );
  }

  // 3. Renderitzem el flux (timeline)
  return (
    <Card>
      <CardHeader>
        <CardTitle>{t('keyMomentsTitle')}</CardTitle>
      </CardHeader>
      <CardContent>
        {/* 'relative' Ã©s clau per a la lÃ­nia de la timeline */}
        <div className="relative space-y-8 pl-8">
          {/* La lÃ­nia vertical de la timeline */}
          <div className="absolute left-4 top-2 bottom-2 w-0.5 bg-border" />
          
          {workMoments.map((moment, index) => (
            <div key={index} className="relative">
              {/* El cercle de la timeline */}
              <div className="absolute -left-8 top-1 flex h-8 w-8 items-center justify-center rounded-full bg-background border-2">
                <MomentIcon moment={moment} />
              </div>
              
              <div className="space-y-2">
                <h4 className="font-semibold text-lg">{moment.topic}</h4>
                <p className="text-muted-foreground">{moment.details}</p>
                
                {moment.decisions && moment.decisions.length > 0 && (
                  <div className="space-y-1 pt-2">
                    <h5 className="font-medium text-sm">{t('keyMomentsDecisions')}</h5>
                    <ul className="list-disc list-inside space-y-1">
                      {moment.decisions.map((decision, dIndex) => (
                        <li key={dIndex} className="text-sm">{decision}</li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/app/[locale]/(app)/comunicacio/transcripcio/_components/ParticipantsList.tsx ===================

"use client";

import React from 'react';
import { Avatar, AvatarFallback} from '@/components/ui/avatar';
import type { AudioJob } from '@/types/db';
// Helpers per generar inicials i colors Ãºnics per als avatars
const getInitials = (name: string) => {
  const names = name.split(' ');
  if (names.length === 1) return names[0][0]?.toUpperCase() || '?';
  return (names[0][0] + (names[names.length - 1][0] || '')).toUpperCase();
};

const generateAvatarColor = (name: string) => {
  let hash = 0;
  for (let i = 0; i < name.length; i++) {
    hash = name.charCodeAt(i) + ((hash << 5) - hash);
  }
  const h = hash % 360;
  // Retornem colors pastel HSL (saturaciÃ³ 70%, lluminositat 80%)
  return `hsl(${h}, 70%, 80%)`;
};

const generateTextColor = (name: string) => {
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    const h = hash % 360;
    // Retornem colors foscos HSL (saturaciÃ³ 70%, lluminositat 30%)
    return `hsl(${h}, 70%, 30%)`;
}

// El tipus 'participants' Ã©s un Json, el definim basat en la Edge Function
type Participant = {
  contact_id: number;
  name: string;
  role: string;
}

interface ParticipantsListProps {
  participants: AudioJob['participants'];
}

export function ParticipantsList({ participants }: ParticipantsListProps) {
  if (!Array.isArray(participants) || participants.length === 0) {
    return <p className="text-sm text-muted-foreground">No s'han assignat participants.</p>;
  }

  // Assegurem el tipat de les dades JSON
  const typedParticipants = participants as Participant[];

  return (
    <ul className="space-y-4">
      {typedParticipants.map((p) => (
        <li key={p.contact_id || p.name} className="flex items-center gap-3">
          <Avatar>
            {/* <AvatarImage src={p.avatarUrl} /> */}
            <AvatarFallback 
              style={{ 
                backgroundColor: generateAvatarColor(p.name), 
                color: generateTextColor(p.name),
                fontWeight: 600 
              }}
            >
              {getInitials(p.name)}
            </AvatarFallback>
          </Avatar>
          <div className="flex-1">
            <p className="font-medium">{p.name}</p>
            <p className="text-sm text-muted-foreground">{p.role}</p>
          </div>
        </li>
      ))}
    </ul>
  );
}

// =================== FILE: src/app/[locale]/(app)/crm/activitats/page.tsx ===================

import type { Metadata } from 'next';
import { Suspense } from 'react';

// Importem els nostres nous components d'orquestraciÃ³
import { ActivitiesData } from './_components/ActivitiesData';
import { ActivitiesSkeleton } from './_components/ActivitiesSkeleton';

export const metadata: Metadata = {
  title: 'Historial d\'Activitats | Ribot',
};

// Ja no necessitem definir el tipus 'Activity' aquÃ­,
// ja que el gestionem dins de 'ActivitiesData' i 'activitats-client',
// que l'importen des del fitxer central 'src/types/crm.ts'.

// La pÃ gina principal ja no Ã©s 'async'. Es renderitza a l'instant.
export default function ActivitatsPage() {
  return (
    <Suspense fallback={<ActivitiesSkeleton />}>
      {/* Suspense mostrarÃ  l'esquelet a l'instant, eliminant la "congelaciÃ³".
        Mentrestant, <ActivitiesData /> carregarÃ  les dades en segon pla.
      */}
      <ActivitiesData />
    </Suspense>
  );
}

// =================== FILE: src/app/[locale]/(app)/crm/activitats/_components/activitats-client.tsx ===================

// /app/[locale]/(app)/crm/activitats/_components/activitats-client.tsx

"use client";

import React from 'react';
import { motion } from 'framer-motion';
import Link from 'next/link';
import { AlertTriangle, CheckCircle } from 'lucide-react';
import { format } from 'date-fns';
import { ca, es, enUS } from 'date-fns/locale';
import { useLocale, useTranslations } from 'next-intl';

// âœ… PAS 3: Importem el tipus directament del nostre component de dades del servidor.
import { type ActivityWithContact } from './ActivitiesData';

/**
 * @summary Sub-component reutilitzable per mostrar un Ãºnic element de l'historial d'activitats.
 */
const HistoricActivityItem: React.FC<{ activity: ActivityWithContact }> = ({ activity }) => {
    const t = useTranslations('ActivitiesClient');
    const locale = useLocale();
    
    const getDateLocale = () => {
        switch (locale) {
            case 'es': return es;
            case 'en': return enUS;
            default: return ca;
        }
    };

    const isRead = activity.is_read;
    const Icon = isRead ? CheckCircle : AlertTriangle;
    const iconColor = isRead ? 'text-green-400' : 'text-yellow-400';

    const activityContent = (
        <div className="flex items-start gap-4">
            <div className="mt-1">
                <Icon className={`w-5 h-5 ${iconColor}`} />
            </div>
            <div className="flex-1">
                <div className="flex justify-between items-center">
                    {/* âœ… Adaptem l'accÃ©s a les dades: 'activity.contacts.nom' */}
                    <p className="font-semibold">{activity.type} - <span className="font-normal">{activity.contacts?.nom || t('deletedContact')}</span></p>
                    {/* âœ… Ens assegurem de gestionar el possible null de 'created_at' */}
                    <p className="text-xs text-muted-foreground">{activity.created_at ? format(new Date(activity.created_at), t('dateFormat'), { locale: getDateLocale() }) : ''}</p>
                </div>
                <p className="text-sm text-muted-foreground mt-1 italic">"{activity.content}"</p>
            </div>
        </div>
    );

    // âœ… La lÃ²gica ara utilitza 'activity.contact_id' (que Ã©s un number)
    if (activity.contact_id && activity.contacts) {
        return (
            <Link
                href={`/${locale}/crm/contactes/${activity.contact_id}`}
                className="block p-4 hover:bg-white/10 transition-colors"
            >
                {activityContent}
            </Link>
        );
    }

    return (
        <div className="block p-4">
            {activityContent}
        </div>
    );
};

interface ActivitatsClientProps {
    initialActivities: ActivityWithContact[];
}

/**
 * @summary Component de Client principal per a la pÃ gina d'historial d'activitats.
 */
export const ActivitatsClient: React.FC<ActivitatsClientProps> = ({ initialActivities }) => {
    const t = useTranslations('ActivitiesClient');

    return (
        <motion.div initial={{ opacity: 0, y: -20 }} animate={{ opacity: 1, y: 0 }}>
            <div className="flex justify-between items-center mb-8">
                <h1 className="text-3xl font-bold">{t('title')}</h1>
            </div>

            <div className="glass-card overflow-hidden">
                {initialActivities.length > 0 ? (
                    <div className="divide-y divide-white/10">
                        {initialActivities.map(activity => (
                            // âœ… 'activity.id' ara Ã©s un number, que Ã©s una key vÃ lida.
                            <HistoricActivityItem key={activity.id} activity={activity} />
                        ))}
                    </div>
                ) : (
                    <div className="text-center p-12">
                        <p className="text-muted-foreground">{t('noActivities')}</p>
                    </div>
                )}
            </div>
        </motion.div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/activitats/_components/ActivitiesData.tsx ===================

// âœ… 1. Importem la validaciÃ³ de sessiÃ³ i el nou servei
import { validatePageSession } from '@/lib/supabase/session';
import { getActivities, type ActivityWithContact } from '@/lib/services/crm/activities/activities.service';

import { ActivitatsClient } from './activitats-client';

// âœ… 2. Re-exportem el tipus per al component client
export type { ActivityWithContact };

export async function ActivitiesData() {
  // âœ… 3. Obtenim sessiÃ³ i 'activeTeamId'
  const session = await validatePageSession();
  if ('error' in session) {
    console.error(
      "ActivitiesData: SessiÃ³ invÃ lida.",
      typeof session.error === 'object' && session.error !== null && 'message' in session.error
        ? (session.error as { message?: string }).message
        : session.error
    );
    return <ActivitatsClient initialActivities={[]} />;
  }
  
  const { supabase, activeTeamId } = session;
  
  // âœ… 4. Cridem al servei
  const { data: activities, error } = await getActivities(supabase, activeTeamId);

  if (error) {
    console.error("Error en obtenir les activitats (Component):", error.message);
    return <ActivitatsClient initialActivities={[]} />;
  }

  // âœ… 5. Passem les dades al client
  return <ActivitatsClient initialActivities={activities || []} />;
}

// =================== FILE: src/app/[locale]/(app)/crm/activitats/_components/ActivitiesSkeleton.tsx ===================

"use client";


// Aquest component mostra un esquelet per a la pÃ gina d'activitats
export function ActivitiesSkeleton() {
  return (
    <div className="animate-pulse">
      {/* Esquelet de la capÃ§alera */}
      <div className="flex justify-between items-center mb-8">
        <div className="h-9 w-64 bg-gray-700/50 rounded-md"></div>
      </div>

      {/* Esquelet de la llista d'activitats */}
      <div className="glass-card divide-y divide-white/10">
        {[...Array(7)].map((_, i) => (
          <div key={i} className="p-4 flex items-start gap-4">
            <div className="mt-1">
              <div className="w-5 h-5 bg-gray-700/50 rounded-full"></div>
            </div>
            <div className="flex-1 space-y-2">
              <div className="flex justify-between items-center">
                <div className="h-5 w-1/3 bg-gray-700/50 rounded-md"></div>
                <div className="h-3 w-1/4 bg-gray-700/50 rounded-md"></div>
              </div>
              <div className="h-4 w-4/5 bg-gray-700/50 rounded-md"></div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/crm/calendari/actions.ts ===================

// src/app/[locale]/(app)/crm/calendari/actions.ts
'use server';

import { validatePageSession } from '@/lib/supabase/session';
import { getCalendarEvents } from '@/lib/services/crm/calendar/calendar.service';
import type { 
Â  Â  EnrichedTaskForCalendar, 
Â  Â  EnrichedQuoteForCalendar, 
Â  Â  EnrichedEmailForCalendar 
} from '@/lib/services/crm/calendar/calendar.service';
import type { ActiveSources } from '@/types/crm/calendar';

// ---
// Definim els tipus de retorn que el CLIENT espera
// ---
type CalendarDataPayload = {
    tasks: EnrichedTaskForCalendar[];
    quotes: EnrichedQuoteForCalendar[];
    sentEmails: EnrichedEmailForCalendar[];
    receivedEmails: EnrichedEmailForCalendar[];
    error?: undefined; // âœ… El client espera 'error' opcional (undefined) en cas d'Ã¨xit
}

type CalendarErrorPayload = {
    tasks: null;
    quotes: null;
    sentEmails: null;
    receivedEmails: null;
    error: string;
}

type GetCalendarDataResult = Promise<CalendarDataPayload | CalendarErrorPayload>;

/**
Â * ACCIÃ“: ObtÃ© les dades del calendari (per a recÃ rregues del client).
Â */
export async function getCalendarData(
Â  Â  startDate: string, 
Â  Â  endDate: string, 
Â  Â  activeSources?: ActiveSources
): GetCalendarDataResult { // âœ… Tipus de retorn aplicat
Â  Â  
Â  Â  const sessionResult = await validatePageSession();
Â  Â  if ('error' in sessionResult) {
Â  Â  Â  Â  return { 
Â  Â  Â  Â  Â  Â  tasks: null, quotes: null, sentEmails: null, receivedEmails: null, 
Â  Â  Â  Â  Â  Â  error: 'Error de sessiÃ³. Torna a iniciar la sessiÃ³.' 
Â  Â  Â  Â  };
Â  Â  }
Â  Â  const { supabase, activeTeamId } = sessionResult;

Â  Â  const { data, error } = await getCalendarEvents(
Â  Â  Â  Â  supabase, activeTeamId, startDate, endDate, activeSources
Â  Â  );

Â  Â  if (error || !data) { // Comprovem error O si no hi ha dades
Â  Â  Â  Â  console.error("Error fetching calendar data (action):", error);
Â  Â  Â  Â  
Â  Â  Â  Â  const errorMessage = error?.validationError ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â error?.tasksError, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â error?.quotesError, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â error?.sentEmailsError, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â error?.receivedEmailsError, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â error?.membersError
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ]
                     
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â .find(e => typeof e === 'object' && e !== null && e.message)?.message ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 'Error desconegut al carregar les dades.';
Â  Â  Â  Â  
Â  Â  Â  Â  return { 
Â  Â  Â  Â  Â  Â  tasks: null, quotes: null, sentEmails: null, receivedEmails: null, 
Â  Â  Â  Â  Â  Â  error: errorMessage 
Â  Â  Â  Â  };
Â  Â  }

Â  Â  // âœ… CORRECCIÃ“: Retornem l'objecte sense la propietat 'error' (Ã©s undefined)
Â  Â  return {
Â  Â  Â  Â  tasks: data.tasks ?? [],
Â  Â  Â  Â  quotes: data.quotes ?? [],
Â  Â  Â  Â  sentEmails: data.sentEmails ?? [],
Â  Â  Â  Â  receivedEmails: data.receivedEmails ?? [],
Â  Â  };
}

// =================== FILE: src/app/[locale]/(app)/crm/calendari/page.tsx ===================

import { Suspense } from 'react';
import CalendarData from './_components/CalendarData';
import CalendarSkeleton from './_components/CalendarSkeleton';

export default function CalendarPage() {
  return (
    // Utilitzem un contenidor que no afegeix marges o paddings verticals innecessaris
    <div className="h-full w-full">
      <Suspense fallback={<CalendarSkeleton />}>
        <CalendarData />
      </Suspense>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/crm/calendari/_components/calendar-custom.css ===================

/* * Assegura que el contenidor de la columna de dia tingui posiciÃ³ relativa
 * perquÃ¨ els esdeveniments posicionats de forma absoluta es mantinguin dins.
*/
.rbc-day-slot .rbc-event-content {
    white-space: normal !important;
    word-wrap: break-word !important;
}
.rbc-day-slot .rbc-event,
.rbc-day-slot .rbc-background-event {
    position: relative !important;
    width: 95% !important;
    margin-bottom: 5px !important;
    left: 2.5% !important;
    right: 2.5% !important;
    top: auto !important;
    height: auto !important;
    min-height: 25px; /* Una alÃ§ada mÃ­nima per a esdeveniments curts */
}

/* * Elimina l'alÃ§ada fixa de les files de temps per permetre que creixin 
 * verticalment segons el contingut.
*/
.rbc-time-content > .rbc-time-slot,
.rbc-time-slot {
    height: auto !important;
    min-height: 40px; /* Mantenim una alÃ§ada mÃ­nima per a les hores buides */
}



/* * Ajusta l'estil de l'indicador "now" (la lÃ­nia de l'hora actual)
 * per assegurar que es mostri correctament amb la nova estructura flexible.
*/
.rbc-time-view .rbc-current-time-indicator {
    z-index: 1;
}

// =================== FILE: src/app/[locale]/(app)/crm/calendari/_components/CalendarClient.tsx ===================

'use client';

import { useMemo, useCallback } from 'react';
import { Calendar, dateFnsLocalizer, EventPropGetter, CalendarProps, View, NavigateAction } from 'react-big-calendar';
import { format, parse, startOfWeek, getDay } from 'date-fns';
import { es } from 'date-fns/locale';
import withDragAndDrop from 'react-big-calendar/lib/addons/dragAndDrop';
import { useTranslations } from 'next-intl';
import 'react-big-calendar/lib/css/react-big-calendar.css';
import 'react-big-calendar/lib/addons/dragAndDrop/styles.css';

// NOU: Importem el nou fitxer de estils personalitzats
import './calendar-custom.css';

import { CalendarEvent } from '@/types/crm';
import { fetchCalendarData } from '../_hooks/calendarFetch';
import { ActiveSources } from '@/types/crm/calendar';
import { EnrichedTaskForCalendar, EnrichedQuoteForCalendar, EnrichedEmailForCalendar } from './CalendarData';
import { EnrichedTask, TaskDialogManager } from '@/components/features/tasks/TaskDialogManager';
import { Tables } from '@/types/supabase';
import CalendarToolbar from './CalendarToolbar';
import useCalendar from '../_hooks/useCalendar';
import { QuoteDetailDialog } from './QuoteDetailDialog';
import { EmailDetailDialog } from './EmailDetailDialog';
import { cn } from '@/lib/utils/utils';
import { useCalendarController } from '../_hooks/useCalendarController';
import { useCalendarDialogs } from '../_hooks/useCalendarDialog';
import CalendarSkeletonEvent from './CalendarSkeletonEvent';

export type EventSourcesState = ActiveSources;

const locales = { es };
const localizer = dateFnsLocalizer({ format, parse, startOfWeek, getDay, locales });
const DragAndDropCalendar = withDragAndDrop(Calendar as React.ComponentType<CalendarProps<CalendarEvent>>);
const CALENDAR_VIEWS: View[] = ['month', 'week', 'day', 'agenda'];

// ğŸ¨ DEFINICIONS D'ESTILS
const eventStyles = {
    task: {
        Baixa: { backgroundColor: '#3498db', color: 'white' },
        Mitjana: { backgroundColor: '#f1c40f', color: 'black' },
        Alta: { backgroundColor: '#e74c3c', color: 'white' },
    },
    quote: { backgroundColor: '#2ecc71', color: 'white' },
    email: { backgroundColor: '#9b59b6', color: 'white' },
    receivedEmail: { backgroundColor: '#34495e', color: 'white' },
    default: { backgroundColor: '#95a5a6', color: 'white' },
};

const eventStyleGetter: EventPropGetter<CalendarEvent> = (event) => {
    const { eventType, resource } = event;
    let style = { ...eventStyles.default };

    if (eventType === 'task' && resource && typeof resource === 'object' && 'priority' in resource) {
        const priority = (resource as { priority: string }).priority as keyof typeof eventStyles.task;
        style = eventStyles.task[priority] || eventStyles.default;
    } else if (eventType === 'quote') {
        style = eventStyles.quote;
    } else if (eventType === 'email') {
        style = eventStyles.email;
    } else if (eventType === 'receivedEmail') {
        style = eventStyles.receivedEmail;
    }

    return { style: { ...style, borderRadius: '5px', opacity: 0.9, border: '0px', display: 'block' } };
};

// ----------------------------------------------------------------------
// ğŸ“¦ INTERFÃCIE DE PROPIETATS
// ----------------------------------------------------------------------
export interface CalendarClientProps {
    initialTasks: EnrichedTaskForCalendar[];
    initialQuotes: EnrichedQuoteForCalendar[];
    initialSentEmails: EnrichedEmailForCalendar[];
    initialReceivedEmails: EnrichedEmailForCalendar[];
    teamUsers: { id: string; full_name: string | null }[];
    contacts: Tables<'contacts'>[];
    departments: Tables<'departments'>[];
    fetchCalendarDataAction: typeof fetchCalendarData;
}

// ----------------------------------------------------------------------
// âš™ï¸ COMPONENT PRINCIPAL
// ----------------------------------------------------------------------
export default function CalendarClient(props: CalendarClientProps) {
    const t = useTranslations('Calendar');

    const {
        tasks,
        filteredEvents,
        view,
        date,
        eventSources,
        handleToolbarNavigation,
        handleViewChange,
        handleDataMutation,
        handleMoveTask,
        setEventSources,
        updateDateAndData,
    } = useCalendarController(props);

    const {
        isTaskDialogOpen,
        isQuoteDialogOpen,
        isEmailDialogOpen,
        setIsTaskDialogOpen,
        setIsQuoteDialogOpen,
        setIsEmailDialogOpen,
        selectedTask,
        selectedQuote,
        selectedEmail,
        initialDate,
        handleSelectEvent,
        handleSelectSlot,
        handleOpenNewTaskDialog,
    } = useCalendarDialogs({ updateDateAndData });

    const { handleMoveEvent } = useCalendar(tasks, handleMoveTask);

    // NOU: LÃ²gica per gestionar el clic a "+X mÃ©s"
    const handleShowMore = useCallback((events: CalendarEvent[], date: Date) => {
        handleViewChange('day');
        handleToolbarNavigation('DATE', date);
    }, [handleViewChange, handleToolbarNavigation]);

    const messages = useMemo(() => ({
        allDay: t('allDay'),
        previous: t('previous'),
        next: t('next'),
        today: t('today'),
        month: t('month'),
        week: t('week'),
        day: t('day'),
        agenda: t('agenda'),
        date: t('date'),
        time: t('time'),
        event: t('event'),
        noEventsInRange: t('noEventsInRange'),
        showMore: (total: number) => `+ ${total} ${t('more')}`,
    }), [t]);

    const formattedLabel = useMemo(() => {
        let dateFormat: string;
        switch (view) {
            case 'month': dateFormat = 'MMMM yyyy'; break;
            case 'week': dateFormat = 'dd MMM yyyy'; break;
            case 'day': dateFormat = 'EEEE, dd MMMM yyyy'; break;
            case 'agenda': dateFormat = 'dd MMMM yyyy'; break;
            default: dateFormat = 'MMMM yyyy';
        }
        return format(date, dateFormat, { locale: es }).replace(/^\w/, c => c.toUpperCase());
    }, [date, view]);

    const handleCalendarNavigate: CalendarProps<CalendarEvent>['onNavigate'] = useCallback((newDate: Date, view: View, action: NavigateAction) => {
        handleToolbarNavigation(action, newDate);
    }, [handleToolbarNavigation]);

    const handleToolbarAction = useCallback((action: NavigateAction) => {
        handleToolbarNavigation(action, undefined);
    }, [handleToolbarNavigation]);


    const toolbarProps = useMemo(() => ({
        label: formattedLabel,
        onNavigate: handleToolbarAction,
        onView: handleViewChange,
        view: view,
        views: CALENDAR_VIEWS,
        date: date,
        localizer: localizer,
        onEventSourcesChange: setEventSources,
        eventSources: eventSources,
        onCreateTask: handleOpenNewTaskDialog,
    }), [formattedLabel, handleViewChange, view, date, eventSources, setEventSources, handleOpenNewTaskDialog, handleToolbarAction]);

    return (
        <div>
            <CalendarToolbar {...toolbarProps} />

            <DragAndDropCalendar
                localizer={localizer}
                events={filteredEvents}
                startAccessor="start"
                endAccessor="end"
                style={{ height: 'calc(100vh - 150px)', borderRadius: '0 0 0.5rem 0.5rem' }}
                selectable
                onSelectSlot={handleSelectSlot}
                onSelectEvent={handleSelectEvent}
                onEventDrop={handleMoveEvent}
                eventPropGetter={eventStyleGetter}
                messages={messages}
                culture="es"
                view={view}
                date={date}
                onView={handleViewChange}
                onNavigate={handleCalendarNavigate}
                // NOU: Afegim el gestor per a la vista de setmana i mes
                onShowMore={handleShowMore}
                className={cn('rbc-calendar-force-light-theme')}
                components={{
                    toolbar: () => null,
                    event: (props) =>
                        props.event.eventType === 'skeleton' ? (
                            <CalendarSkeletonEvent {...props} />
                        ) : (
                            <div className="rbc-event-content">{props.title}</div>
                        ),
                }}
            />

            <TaskDialogManager
                task={selectedTask ? {
                    ...selectedTask,
                    user_id: selectedTask.user_id ?? '',
                    time_tracking_log: selectedTask.time_tracking_log ?? null // <-- AFEGEIX AQUESTA LÃNIA
                } as EnrichedTask : null}
                open={isTaskDialogOpen}
                onOpenChange={setIsTaskDialogOpen}
                contacts={props.contacts}
                initialDepartments={props.departments}
                teamMembers={props.teamUsers}
                onTaskMutation={handleDataMutation}
                initialDate={initialDate}
                activeTeamId='
'
            />

            <QuoteDetailDialog
                quote={selectedQuote}
                open={isQuoteDialogOpen}
                onOpenChange={setIsQuoteDialogOpen}
            />

            <EmailDetailDialog
                email={selectedEmail}
                open={isEmailDialogOpen}
                onOpenChange={setIsEmailDialogOpen}
            />
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/crm/calendari/_components/CalendarData.tsx ===================

import CalendarClient from './CalendarClient';
import { validatePageSession } from '@/lib/supabase/session';
import { startOfWeek, endOfWeek } from 'date-fns';

// âœ… 1. Importem el SERVEI per a la cÃ rrega inicial
import { getCalendarPageData } from '@/lib/services/crm/calendar/calendar.service';
// âœ… 2. Importem l'ACCIÃ“ per passar-la al client (per a recÃ rregues)
import { getCalendarData } from '../actions'; 
// âœ… 3. Importem els tipus des del SERVEI
import { 
  type EnrichedTaskForCalendar,
  type EnrichedQuoteForCalendar,
  type EnrichedEmailForCalendar
} from '@/lib/services/crm/calendar/calendar.service';

// Re-exportem tipus per al client
export type { EnrichedTaskForCalendar, EnrichedQuoteForCalendar, EnrichedEmailForCalendar };

const INITIAL_ACTIVE_SOURCES = {
  tasks: true,
  quotes: false,
  emails: false,
  receivedEmails: false,
};

export default async function CalendarData() {
  // âœ… 4. Validem la sessiÃ³ UNA SOLA VEGADA
  const session = await validatePageSession();
  if ('error' in session) {
      console.error(
        'CalendarData: SessiÃ³ invÃ lida.',
        typeof session.error === 'object' && session.error !== null && 'message' in session.error
          ? (session.error as { message?: string }).message
          : session.error
      );
      // Retornem un estat buit si la sessiÃ³ falla
      return <CalendarClient 
        initialTasks={[]} 
        initialQuotes={[]} 
        initialSentEmails={[]} 
        initialReceivedEmails={[]} 
        teamUsers={[]} 
        contacts={[]} 
        departments={[]} 
        fetchCalendarDataAction={getCalendarData} 
      />;
  }
  const { supabase, activeTeamId } = session;

  const today = new Date();
  const initialStart = startOfWeek(today, { weekStartsOn: 1 as const }).toISOString();
  const initialEnd = endOfWeek(today, { weekStartsOn: 1 as const }).toISOString();
  
  // âœ… 5. Cridem al nostre "Cas d'Ãšs" del servei per obtenir TOTES les dades inicials
  const { data, error } = await getCalendarPageData(
    supabase, 
    activeTeamId, 
    initialStart, 
    initialEnd, 
    INITIAL_ACTIVE_SOURCES
  );

  // âœ… 6. Gestionem errors
  if (error || !data) {
    console.error('Error carregant dades per al calendari (Component):', error);
    return <CalendarClient 
      initialTasks={[]} 
      initialQuotes={[]} 
      initialSentEmails={[]} 
      initialReceivedEmails={[]} 
      teamUsers={[]} 
      contacts={[]} 
      departments={[]} 
      fetchCalendarDataAction={getCalendarData} 
    />;
  }

  // âœ… 7. Desestructurem les dades netes (events i metadata)
  const { events, metadata } = data;

  return (
    <CalendarClient
      initialTasks={events.tasks ?? []}
      initialQuotes={events.quotes ?? []}
      initialSentEmails={events.sentEmails ?? []}
      initialReceivedEmails={events.receivedEmails ?? []}
      teamUsers={metadata.teamUsers ?? []} 
      contacts={metadata.contacts ?? []} 
      departments={metadata.departments ?? []}
      // Passem l'ACCIÃ“ (importada de actions.ts) al client per a les recÃ rregues
      fetchCalendarDataAction={getCalendarData} 
    />
  );
}

// =================== FILE: src/app/[locale]/(app)/crm/calendari/_components/CalendarSkeleton.tsx ===================

// src/app/[locale]/(app)/crm/calendari/_components/CalendarSkeleton.tsx
'use client';

import { Skeleton } from "@/components/ui/skeleton";
import { cn } from "@/lib/utils/utils"; // Assumim que cn estÃ  disponible

const SkeletonCard = () => (
    <Skeleton className="h-6 w-full rounded-sm mb-1 bg-gray-200 dark:bg-gray-700" />
);

export default function CalendarSkeleton() {
    // ğŸ§  Racional: Utilitzem una graella per simular les celÂ·les del calendari
    // Fons blanc forÃ§at per consistÃ¨ncia amb el CalendarClient.tsx
    return (
        <div className={cn("p-2 border rounded-lg bg-white shadow-md")} style={{ height: 'calc(100vh - 150px)' }}>
            
            {/* 1. CapÃ§alera de dies de la setmana (SimulaciÃ³) */}
            <div className="grid grid-cols-7 border-b text-center font-semibold text-sm h-10">
                {['Dl.', 'Dt.', 'Dc.', 'Dj.', 'Dv.', 'Ds.', 'Dg.'].map((day) => (
                    <div key={day} className="py-2 text-foreground">
                        {day}
                    </div>
                ))}
            </div>

            {/* 2. Graella de dies (SimulaciÃ³ del contingut del mes/setmana) */}
            {/* L'altura total es calcula per omplir l'espai restant de la pantalla */}
            <div className="grid grid-cols-7" style={{ height: 'calc(100% - 40px)' }}>
                {/* Creem 5 setmanes de simulaciÃ³ per omplir la vista de mes/setmana */}
                {[...Array(35)].map((_, index) => ( 
                    <div 
                        key={index} 
                        className="p-1 border-r border-b space-y-2 overflow-hidden"
                        // El 28 Ã©s l'Ãºltim dia, evitem la vora dreta
                        style={{ minHeight: '90px' }} 
                    >
                        {/* Indicador de dia */}
                        <Skeleton className="h-4 w-6 mb-2 bg-gray-200 dark:bg-gray-700" />
                        
                        {/* Fins a 3 cards de skeleton per dia */}
                        {index % 7 === 0 && <SkeletonCard />}
                        {index % 7 === 1 && <SkeletonCard />}
                        {index % 7 === 2 && <SkeletonCard />}
                        {index % 7 === 4 && <SkeletonCard />}
                        {index % 7 === 6 && <SkeletonCard />}

                        {/* MÃ©s indicadors de cÃ rrega (opcional) */}
                        {index % 5 === 0 && <SkeletonCard />}
                    </div>
                ))}
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/crm/calendari/_components/CalendarSkeletonEvent.tsx ===================

// src/app/[locale]/(app)/crm/calendari/_components/CalendarSkeletonEvent.tsx
'use client';

import { Skeleton } from "@/components/ui/skeleton";
import { EventProps } from "react-big-calendar";
import { CalendarEvent } from "@/types/crm";
import { cn } from "@/lib/utils/utils"; 
import * as React from "react";


// ğŸ§  Racional: Aquest component simula la "targeta" d'una tasca/quote,
// utilitzant un color neutral i animaciÃ³ de Skeleton.
export default function CalendarSkeletonEvent({ event }: EventProps<CalendarEvent>) {
    // Si Ã©s un esdeveniment d'un dia sencer (month/week view), simulem la card de tasca
    if (event.allDay) {
        // Utilitzem un ampli de classe per simular diferents tipus de tasques
        const widthClass = event.id === 'skeleton-1' ? "w-full" : "w-11/12";
        const heightClass = event.id === 'skeleton-2' ? "h-5" : "h-6";
        
        // El padding-x de 0.5 Ã©s important per l'estil de react-big-calendar
        return (
            <div className="flex items-center space-x-1 p-0.5" style={{ paddingLeft: 0, paddingRight: 0 }}>
                <Skeleton className={cn(heightClass, widthClass, "rounded-sm bg-gray-200 dark:bg-gray-700")} />
            </div>
        );
    }
    
    // Per a la vista de dia/agenda (amb hora), podem fer-lo mÃ©s llarg
    return (
        <div className="absolute inset-0 p-1">
            <Skeleton className="h-full w-full rounded-md bg-gray-200 dark:bg-gray-700" />
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/crm/calendari/_components/CalendarToolbar.tsx ===================

// src/app/[locale]/(app)/crm/calendari/_components/CalendarToolbar.tsx
'use client';

import { ToolbarProps, View } from 'react-big-calendar';
import { useTranslations } from 'next-intl';
import { Button } from '@/components/ui/button';
import { ToggleGroup, ToggleGroupItem } from '@/components/ui/toggle-group';
import {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuCheckboxItem,
  DropdownMenuLabel,
  DropdownMenuSeparator
} from '@/components/ui/dropdown-menu';
import { ChevronLeft, ChevronRight, Filter, PlusCircle } from 'lucide-react';
import { cn } from '@/lib/utils/utils';
import { EventSourcesState } from './CalendarClient';
import { CalendarEvent } from '@/types/crm';
import * as React from 'react';
import * as SeparatorPrimitive from '@radix-ui/react-separator';

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(({ className, orientation = 'horizontal', decorative = true, ...props }, ref) => (
  <SeparatorPrimitive.Root
    ref={ref}
    decorative={decorative}
    orientation={orientation}
    className={cn(
      'shrink-0 bg-gray-200',
      orientation === 'horizontal' ? 'h-[1px] w-full' : 'h-full w-[1px]',
      className
    )}
    {...props}
  />
));
Separator.displayName = SeparatorPrimitive.Root.displayName;

interface CalendarToolbarProps extends ToolbarProps<CalendarEvent> {
  eventSources: EventSourcesState;
  onEventSourcesChange: (newSources: EventSourcesState) => void;
  onCreateTask: () => void;
}

type CalendarViewTranslationKey = 'month' | 'week' | 'day' | 'agenda';

export default function CalendarToolbar({
  label,
  onNavigate,
  onView,
  view,
  views,
  eventSources,
  onEventSourcesChange,
  onCreateTask,
}: CalendarToolbarProps) {
  const t = useTranslations('Calendar');
  const tFilters = useTranslations('Calendar.filters');

  return (
    <div className="flex flex-wrap items-center justify-between gap-4 p-2 pb-2 bg-white rounded-t-md py-6">
      <div className="flex items-center gap-2">
        <Button variant="ghost" size="icon" onClick={() => onNavigate('PREV')} aria-label={t('previous')}>
          <ChevronLeft className="h-4 w-4 text-black" />
        </Button>
        <Button variant="ghost" className="font-semibold text-black" onClick={() => onNavigate('TODAY')}>
          {t('today')}
        </Button>
        <Button variant="ghost" size="icon" onClick={() => onNavigate('NEXT')} aria-label={t('next')}>
          <ChevronRight className="h-4 w-4 text-black" />
        </Button>
        <h2 className="text-2xl font-bold ml-6 text-black">{label}</h2>
      </div>

      <div className="flex items-center gap-3">
        <ToggleGroup
          type="single"
          value={view}
          onValueChange={(newView: View) => { if (newView) onView(newView); }}
          aria-label="Calendar view"
        >
          {(views as View[]).map((viewName) => (
            <ToggleGroupItem key={viewName} value={viewName} aria-label={t(viewName as CalendarViewTranslationKey)} className="capitalize text-black">
              {t(viewName as CalendarViewTranslationKey)}
            </ToggleGroupItem>
          ))}
        </ToggleGroup>

        <Separator orientation="vertical" className="h-8" />

        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" size="icon" aria-label={tFilters('title')}>
              <Filter className="h-4 w-4 text-black" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuLabel className="text-white , bg-gray-800">{tFilters('title')}</DropdownMenuLabel>
            <DropdownMenuSeparator />
            <DropdownMenuCheckboxItem checked={eventSources.tasks} onCheckedChange={(checked) => onEventSourcesChange({ ...eventSources, tasks: !!checked })}>
              {tFilters('tasks')}
            </DropdownMenuCheckboxItem>
            <DropdownMenuCheckboxItem checked={eventSources.quotes} onCheckedChange={(checked) => onEventSourcesChange({ ...eventSources, quotes: !!checked })}>
              {tFilters('quotes')}
            </DropdownMenuCheckboxItem>
            <DropdownMenuCheckboxItem checked={eventSources.emails} onCheckedChange={(checked) => onEventSourcesChange({ ...eventSources, emails: !!checked })}>
              {tFilters('emailsSent')}
            </DropdownMenuCheckboxItem>
            <DropdownMenuCheckboxItem checked={eventSources.receivedEmails} onCheckedChange={(checked) => onEventSourcesChange({ ...eventSources, receivedEmails: !!checked })}>
              {tFilters('emailsReceived')}
            </DropdownMenuCheckboxItem>
          </DropdownMenuContent>
        </DropdownMenu>

        <Button onClick={onCreateTask} className="text-white">
          <PlusCircle className="mr-2 h-4 w-4 text-white" />
          {t('newTask')}
        </Button>
      </div>
    </div>
  );
}


// =================== FILE: src/app/[locale]/(app)/crm/calendari/_components/EmailDetailDialog.tsx ===================

// src/app/[locale]/(app)/crm/calendari/_components/EmailDetailDialog.tsx (AQUEST CODI ERA CORRECTE)
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from '@/components/ui/dialog';
import { EnrichedEmailForCalendar } from './CalendarData';
import { format } from 'date-fns';
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import { ArrowUpRight } from 'lucide-react';

interface Props {
  email: EnrichedEmailForCalendar | null;
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export function EmailDetailDialog({ email, open, onOpenChange }: Props) {
  if (!email) return null;

  // La construcciÃ³ de la URL sempre ha estat correcta.
  const emailUrl = `/comunicacio/inbox?ticketId=${email.id}`;

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Detall del Correu</DialogTitle>
          <DialogDescription>Data: {format(new Date(email.sent_at!), 'PPP p')}</DialogDescription>
        </DialogHeader>
        <div className="space-y-2 py-4">
          <p><strong>{email.type === 'enviat' ? 'Per a:' : 'De:'}</strong> {email.contacts?.nom || email.sender_name}</p>
          <p><strong>Assumpte:</strong> {email.subject}</p>
          <hr/>
          <div className="text-sm text-muted-foreground max-h-48 overflow-y-auto" dangerouslySetInnerHTML={{ __html: email.preview || '' }} />
        </div>
        <DialogFooter>
          <Button variant="outline" asChild>
            <Link href={emailUrl}>
              Anar al Correu
              <ArrowUpRight className="ml-2 h-4 w-4" />
            </Link>
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

// =================== FILE: src/app/[locale]/(app)/crm/calendari/_components/QuoteDetailDialog.tsx ===================

import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from '@/components/ui/dialog';
import { EnrichedQuoteForCalendar } from './CalendarData';
import { format } from 'date-fns';
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import { ArrowUpRight } from 'lucide-react';

interface Props {
  quote: EnrichedQuoteForCalendar | null;
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export function QuoteDetailDialog({ quote, open, onOpenChange }: Props) {
  if (!quote) return null;

  const quoteUrl = `/finances/quotes/${quote.id}`;

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Detall del Pressupost: {quote.quote_number}</DialogTitle>
          <DialogDescription>Venciment: {format(new Date(quote.expiry_date!), 'PPP')}</DialogDescription>
        </DialogHeader>
        <div className="space-y-2 py-4">
          <p><strong>Client:</strong> {quote.contacts?.nom || 'N/A'}</p>
          <p><strong>Total:</strong> {new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(quote.total)}</p>
          <p><strong>Estat:</strong> {quote.status}</p>
        </div>
        {/* âœ… NOU: Peu del diÃ leg amb el botÃ³ de redirecciÃ³ */}
        <DialogFooter>
          <Button variant="outline" asChild>
            <Link href={quoteUrl}>
              Veure Detalls
              <ArrowUpRight className="ml-2 h-4 w-4" />
            </Link>
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

// =================== FILE: src/app/[locale]/(app)/crm/calendari/_hooks/calendarFetch.ts ===================

// src/app/[locale]/(app)/crm/calendari/_hooks/calendarFetch.ts
import { ActiveSources } from '@/types/crm'; // Importem el tipus ActiveSources si Ã©s allÃ  on el tens definit (o hauria de ser al teu types/crm/calendar.ts)
// âš ï¸ IMPORTANT: Importem la funciÃ³ Server Action real, que has anomenat getCalendarData
import { getCalendarData } from '../actions'; 

// El tipus EventSourcesState hauria de ser ActiveSources (per coherÃ¨ncia amb la Server Action)
export const fetchCalendarData = async (
  startDate: string,
  endDate: string,
  eventSources: ActiveSources // ğŸ§  Passem l'estat dels filtres
) => {
  // Crida la Server Action amb tots els parÃ metres necessaris
  const data = await getCalendarData(startDate, endDate, eventSources);

  // ğŸš¨ GestiÃ³ d'errors: L'acciÃ³ del servidor ja retorna un objecte amb 'error', l'hem de propagar o gestionar.
  if (data.error) {
    // AquÃ­ podrÃ­em llenÃ§ar un error o retornar l'estructura d'error
    // PerÃ² pel patrÃ³ actual de useCalendarController que espera null en cas d'error,
    // retornem l'estructura de dades amb nulls.
    return {
      tasks: null,
      quotes: null,
      sentEmails: null,
      receivedEmails: null,
      error: data.error
    };
  }

  // âœ… Retornem les dades obtingudes
  return {
    tasks: data.tasks ?? [],
    quotes: data.quotes ?? [],
    sentEmails: data.sentEmails ?? [],
    receivedEmails: data.receivedEmails ?? [],
  };
};

// âš ï¸ Recordatori: Si ActiveSources no estÃ  definit a ../actions.ts, has de crear un fitxer de tipus
// per a CalendarEvent i ActiveSources (ex: src/types/crm/calendar.ts) i importar-lo allÃ .
// Per ara, assumim que estÃ  correctament importat a travÃ©s de CalendarClient.

// =================== FILE: src/app/[locale]/(app)/crm/calendari/_hooks/calendarHelpers.ts ===================

import { 
    startOfWeek, 
    endOfWeek, 
    startOfMonth, 
    endOfMonth, 
    endOfDay,
    startOfDay // âœ… 1. Importem startOfDay
} from 'date-fns';

export const getDateRange = (date: Date, view: string) => {
  const weekOptions = { weekStartsOn: 1 as const };
  
  switch(view) {
    case 'month': 
      return { 
        start: startOfWeek(startOfMonth(date), weekOptions), 
        end: endOfWeek(endOfMonth(date), weekOptions) 
      };
      
    case 'week': 
    case 'agenda': 
      return { 
        start: startOfWeek(date, weekOptions), 
        end: endOfWeek(date, weekOptions) 
      };
      
    case 'day': 
      // âœ… 2. AQUEST Ã‰S EL FIX:
      // Canviem 'start: date' per 'start: startOfDay(date)'
      // Ara demanarÃ  les dades des de les 00:00 fins a les 23:59 d'aquell dia.
      return { 
        start: startOfDay(date), 
        end: endOfDay(date) 
      };
      
    default: 
      return { 
        start: startOfWeek(date, weekOptions), 
        end: endOfWeek(date, weekOptions) 
      };
  }
};

// =================== FILE: src/app/[locale]/(app)/crm/calendari/_hooks/calendarMapEvents.ts ===================

// src/app/[locale]/(app)/crm/calendari/_hooks/calendarMapEvents.ts

import { CalendarEvent } from '@/types/crm';
import { EventSourcesState } from '../_components/CalendarClient';
import type { 
Â  Â  EnrichedTaskForCalendar, 
Â  Â  EnrichedQuoteForCalendar, 
Â  Â  EnrichedEmailForCalendar 
} from '../_components/CalendarData'; 
// âœ… PAS 1: Importar 'addMinutes'
import { addDays, startOfWeek, addMinutes } from 'date-fns'; 

interface MapEventsParams {
Â  tasks: EnrichedTaskForCalendar[];
Â  quotes: EnrichedQuoteForCalendar[];
Â  sentEmails: EnrichedEmailForCalendar[];
Â  receivedEmails: EnrichedEmailForCalendar[];
Â  eventSources: EventSourcesState;
Â  isLoading: boolean;
Â  date: Date;
}

export const mapEvents = ({
Â  tasks, quotes, sentEmails, receivedEmails, eventSources, isLoading, date
}: MapEventsParams): CalendarEvent[] => {

Â  type EventType = 'skeleton' | 'task' | 'quote' | 'email' | 'receivedEmail';
Â  const EVENT_TYPE_SKELETON: EventType = 'skeleton'; 

Â  const allEvents: (EnrichedTaskForCalendar | EnrichedQuoteForCalendar | EnrichedEmailForCalendar)[] = [];
Â  
Â  if (eventSources.tasks) allEvents.push(...tasks);
Â  if (eventSources.quotes) allEvents.push(...quotes);
Â  if (eventSources.emails) allEvents.push(...sentEmails);
Â  if (eventSources.receivedEmails) allEvents.push(...receivedEmails);

Â  // ... (La teva lÃ²gica de 'isLoading' Ã©s correcta, no la toco) ...
Â  if (isLoading) {
Â  Â  if (allEvents.length === 0) {
Â  Â  Â  const fallbackEvents: CalendarEvent[] = [];
Â  Â  Â  const WEEK_STARTS_ON = 1 as const;
Â  Â  Â  const skeletonsPerDay = 2;
Â  Â  Â  const currentWeekDays = Array.from({ length: 7 }, (_, i) => 
Â  Â  Â  Â  Â  Â  addDays(startOfWeek(date, { weekStartsOn: WEEK_STARTS_ON }), i)
Â  Â  Â  );
Â  Â  Â  let skeletonCounter = 0;
Â  Â  Â  currentWeekDays.forEach((d) => {
Â  Â  Â  Â  Â  Â  for (let i = 0; i < skeletonsPerDay; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  fallbackEvents.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: `skeleton-fallback-${skeletonCounter++}`, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: 'Carregant...', 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  start: d, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  end: d, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allDay: true, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resource: null, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  eventType: EVENT_TYPE_SKELETON
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â  return fallbackEvents;
Â  Â  }
Â  Â  
Â  Â  return allEvents.map((item, index) => {
Â  Â  Â  let d: Date | null = null;
Â  Â  Â  let allDay: boolean = true;
Â  Â  Â  
Â  Â  Â  if ('priority' in item) { d = item.due_date ? new Date(item.due_date) : null; } 
Â  Â  Â  else if ('expiry_date' in item) { d = item.expiry_date ? new Date(item.expiry_date) : null; } 
Â  Â  Â  else if ('sent_at' in item) { 
Â  Â  Â  Â  Â  d = item.sent_at ? new Date(item.sent_at) : null;
Â  Â  Â  Â  Â  allDay = false;
Â  Â  Â  } else {
Â  Â  Â  Â  Â  return { id: `unknown-${index}`, title: 'Carregant...', start: new Date(), end: new Date(), allDay: true, resource: null, eventType: EVENT_TYPE_SKELETON };
Â  Â  Â  }
Â  Â  Â  
Â  Â  Â  const validDate = d || new Date(); 
Â  Â  Â  const endDate = allDay ? validDate : addMinutes(validDate, 30); // Durada per a skeletons

Â  Â  Â  return {
Â  Â  Â  Â  Â  id: `skeleton-predictive-${item.id}-${index}`, 
Â  Â  Â  Â  Â  title: 'Carregant...', 
Â  Â  Â  Â  Â  start: validDate, 
Â  Â  Â  Â  Â  end: endDate, // â¬…ï¸ Usar endDate
Â  Â  Â  Â  Â  allDay: allDay, 
Â  Â  Â  Â  Â  resource: item,
Â  Â  Â  Â  Â  eventType: EVENT_TYPE_SKELETON
Â  Â  Â  };
Â  Â  }).filter(e => e.start);
Â  }

Â  // -------------------------------------------------------------------------
Â  // 2. LÃ’GICA CORREGIDA (SECCIÃ“ CLAU)
Â  // -------------------------------------------------------------------------
Â  const events: CalendarEvent[] = [];
Â  const DEFAULT_EVENT_DURATION_MINUTES = 30; // Durada per defecte

Â  const addEvent = <T extends { id: number | string }>( // Permetem id de string per a emails
Â  Â  source: T[],
Â  Â  type: EventType,
Â  Â  getDate: (item: T) => Date | null,
Â  Â  getTitle: (item: T) => string,
Â  Â  isAllDayOverride?: boolean 
Â  ) => {
Â  Â  source.forEach(item => {
Â  Â  Â  const d = getDate(item);
Â  Â  Â  if (d) {
Â  Â  Â  Â  let isAllDay: boolean;
Â  Â  Â  Â  let endDate: Date;

Â  Â  Â  Â  if (isAllDayOverride !== undefined) {
Â  Â  Â  Â  Â  isAllDay = isAllDayOverride;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  // LÃ’GICA PER A TASQUES:
Â  Â  Â  Â  Â  // Si l'hora Ã©s mitjanit (00:00:00), Ã©s 'allDay'.
Â  Â  Â  Â  Â  isAllDay = d.getHours() === 0 && d.getMinutes() === 0 && d.getSeconds() === 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // âœ… PAS 2: Definir la data de finalitzaciÃ³ (end)
Â  Â  Â  Â  if (isAllDay) {
Â  Â  Â  Â  Â  Â  // Si Ã©s 'allDay', el 'end' Ã©s igual al 'start' (RBC ja ho gestiona)
Â  Â  Â  Â  Â  Â  endDate = d;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Si NO Ã©s 'allDay', li donem una durada per defecte
Â  Â  Â  Â  Â  Â  endDate = addMinutes(d, DEFAULT_EVENT_DURATION_MINUTES);
Â  Â  Â  Â  }

Â  Â  Â  Â  events.push({ 
Â  Â  Â  Â  Â  Â  id: `${type}-${item.id}`, 
Â  Â  Â  Â  Â  Â  title: getTitle(item), 
Â  Â  Â  Â  Â  Â  start: d, 
Â  Â  Â  Â  Â  Â  end: endDate, // â¬…ï¸ AQUESTA Ã‰S LA CORRECCIÃ“
Â  Â  Â  Â  Â  Â  allDay: isAllDay, 
Â  Â  Â  Â  Â  Â  resource: item, 
Â  Â  Â  Â  Â  Â  eventType: type 
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  });
Â  };

Â  // Cridem a la funciÃ³ amb la lÃ²gica correcta
Â  if (eventSources.tasks) {
Â  Â  Â  // Per a les tasques, no passem 'isAllDayOverride'. Deixem que ho calculi.
Â  Â  Â  addEvent(tasks, 'task', t => t.due_date ? new Date(t.due_date) : null, t => t.title);
Â  }
Â  if (eventSources.quotes) {
Â  Â  Â  // Els venciments de pressupostos SÃ“N 'allDay'
Â  Â  Â  addEvent(quotes, 'quote', q => q.expiry_date ? new Date(q.expiry_date) : null, q => `Venciment P.: ${q.contacts?.nom || 'N/A'}`, true);

Â  }
Â  if (eventSources.emails) {
Â  Â  Â  // Els correus NO SÃ“N 'allDay'
Â  Â  Â  addEvent(sentEmails, 'email', e => e.sent_at ? new Date(e.sent_at) : null, e => `Correu a: ${e.contacts?.nom || e.sender_name || 'Destinatari desconegut'}`, false);
}
Â  if (eventSources.receivedEmails) {
Â  Â  Â  // Els correus NO SÃ“N 'allDay'
Â  Â  Â  addEvent(receivedEmails, 'receivedEmail', e => e.sent_at ? new Date(e.sent_at) : null, e => `Correu de: ${e.contacts?.nom || e.sender_name || 'Remitent desconegut'}`, false);
Â  }

Â  return events;
};

// =================== FILE: src/app/[locale]/(app)/crm/calendari/_hooks/useCalendar.tsx ===================

// src/app/[locale]/(app)/crm/calendari/_hooks/useCalendar.tsx
'use client'; 
// ğŸ”¹ Indiquem que Ã©s un component/client hook (necessari per React en entorns Next.js 13+)

// -----------------------------------------------------------------------------
// ğŸ“¦ IMPORTACIONS
// -----------------------------------------------------------------------------
import { useCallback } from 'react';       // Per memoritzar funcions i evitar re-renderitzats innecessaris
import { toast } from 'sonner';            // Llibreria per mostrar notificacions dâ€™usuari
import { updateSimpleTask} from '@/app/actions/tasks/actions'; // AcciÃ³ del servidor per actualitzar la data dâ€™una tasca
import { CalendarEvent } from '@/types/crm'; // Tipus genÃ¨ric dâ€™esdeveniment del calendari
import { EnrichedTaskForCalendar } from '../_components/CalendarData'; // Tipus especÃ­fic per a tasques

// -----------------------------------------------------------------------------
// ğŸ§  DESCRIPCIÃ“ GENERAL
// -----------------------------------------------------------------------------
// Aquest hook encapsula la lÃ²gica de "Drag & Drop" per moure esdeveniments
// (ara mateix nomÃ©s tasques) dins el calendari.
// Quan una tasca es mou de dia, actualitza el seu due_date tant al frontend
// com al backend, gestionant errors i notificacions dâ€™usuari.
// -----------------------------------------------------------------------------

export default function useCalendar(
  tasks: EnrichedTaskForCalendar[],                      // ğŸ”¸ Llista actual de tasques mostrades al calendari
  onTaskMove: (taskId: number, newDueDate: string) => void // ğŸ”¸ Callback per actualitzar el frontend de manera optimista
) {

  // ---------------------------------------------------------------------------
  // ğŸ¯ handleMoveEvent
  // ---------------------------------------------------------------------------
  // Aquesta funciÃ³ es crida quan lâ€™usuari arrossega una tasca a una nova data.
  // Actualitza la data tant al frontend (optimista) com al backend (definitiu).
  // ---------------------------------------------------------------------------

  const handleMoveEvent = useCallback(async ({ event, start }: { event: CalendarEvent, start: string | Date }) => {
    // ğŸ§  NomÃ©s tractem esdeveniments de tipus "tasca"
    if (event.eventType !== 'task') return;
    
    // ğŸ” Extraiem lâ€™ID de la tasca: pot venir amb prefix (â€œtask-â€), aixÃ­ que el netegem
    const taskId = Number(String(event.id).replace('task-', ''));

    // ğŸ•“ Convertim la nova data dâ€™inici a format ISO per coherÃ¨ncia amb el backend
    const newDueDate = new Date(start).toISOString();

    // ğŸ” Busquem la tasca original (per poder fer un revert si falla)
    const originalTask = tasks.find(t => t.id === taskId);
    if (!originalTask) return; // Si no la trobem, parem aquÃ­

    // -------------------------------------------------------------------------
    // ğŸ§© ACTUALITZACIÃ“ OPTIMISTA
    // -------------------------------------------------------------------------
    // Actualitzem el frontend immediatament per donar sensaciÃ³ de fluÃ¯desa.
    // Si desprÃ©s hi ha error de servidor, revertirem la data.
    onTaskMove(taskId, newDueDate);

    // -------------------------------------------------------------------------
    // âš™ï¸ ACTUALITZACIÃ“ REAL AL BACKEND
    // -------------------------------------------------------------------------
    const result = await updateSimpleTask(taskId, { due_date: newDueDate });

    // -------------------------------------------------------------------------
    // ğŸ§¯ GESTIÃ“ D'ERRORS I FEEDBACK A Lâ€™USUARI
    // -------------------------------------------------------------------------
    if (result.error) {
        // âŒ Si el servidor respon amb error, mostrem toast i revertim la data
        toast.error("Error en actualitzar la data.", { description: "Error"});
        onTaskMove(taskId, originalTask.due_date!);
    } else {
        // âœ… Si tot va bÃ©, mostrem confirmaciÃ³ dâ€™Ã¨xit
        toast.success("Tasca actualitzada correctament.");
    }

  // ğŸ§© DependÃ¨ncies: nomÃ©s canvia si canvien les tasques o la funciÃ³ de moviment
  }, [tasks, onTaskMove]);

  // ---------------------------------------------------------------------------
  // ğŸ“¤ RETORN DEL HOOK
  // ---------------------------------------------------------------------------
  // Exposem nomÃ©s la funciÃ³ principal, ja que la resta Ã©s interna.
  // El component que utilitza el calendari (ex: CalendarClient) la rebrÃ 
  // i la passarÃ  al component de calendari com a handler dâ€™â€œonEventDropâ€.
  // ---------------------------------------------------------------------------
  return { handleMoveEvent };
}


// =================== FILE: src/app/[locale]/(app)/crm/calendari/_hooks/useCalendarController.ts ===================

'use client';

import { useState, useMemo, useCallback, useEffect } from 'react';
import { View, NavigateAction } from 'react-big-calendar';
import { toast } from 'sonner';
// ğŸ’¡ Imports NETEJATS: NomÃ©s mantenim les funcions necessÃ ries per al cÃ lcul manual de dates
import { 
    startOfToday, 
    addDays, addWeeks, addMonths 
} from 'date-fns';

import { CalendarEvent } from '@/types/crm';
import { ActiveSources } from '@/types/crm/calendar';
import { EnrichedTaskForCalendar, EnrichedQuoteForCalendar, EnrichedEmailForCalendar } from '../_components/CalendarData';
import { getDateRange } from './calendarHelpers';
import { fetchCalendarData } from './calendarFetch';
import { mapEvents } from './calendarMapEvents';

// Hem eliminat la definiciÃ³ de 'localizer' ja que no s'utilitzava directament.


interface UseCalendarControllerProps {
    initialTasks: EnrichedTaskForCalendar[];
    initialQuotes: EnrichedQuoteForCalendar[];
    initialSentEmails: EnrichedEmailForCalendar[];
    initialReceivedEmails: EnrichedEmailForCalendar[];
    fetchCalendarDataAction: typeof fetchCalendarData;
}

type EventSourcesState = ActiveSources;

export const useCalendarController = ({
    initialTasks, initialQuotes, initialSentEmails, initialReceivedEmails, fetchCalendarDataAction
}: UseCalendarControllerProps) => {

    const [tasks, setTasks] = useState(initialTasks);
    const [quotes, setQuotes] = useState(initialQuotes);
    const [sentEmails, setSentEmails] = useState(initialSentEmails);
    const [receivedEmails, setReceivedEmails] = useState(initialReceivedEmails);
    const [view, setView] = useState<View>('week');
    const [date, setDate] = useState(new Date());
    const [isLoading, setIsLoading] = useState(false);
    const [eventSources, setEventSources] = useState<EventSourcesState>({
        tasks: true, quotes: false, emails: false, receivedEmails: false
    });
    
    // -------------------------------------------------------------------------
    // ğŸ§  handleDataFetch: LÃ²gica AsÃ­ncrona AÃLLADA
    // -------------------------------------------------------------------------
    const handleDataFetch = useCallback(async (currentDate: Date, currentView: View, currentSources: EventSourcesState) => {
        
        console.log('ğŸ”„ [Fetch] Iniciant cÃ rrega de dades. Loading=true');
        setIsLoading(true); 
        
        try {
            const { start, end } = getDateRange(currentDate, currentView);
            const startDateStr = start.toISOString();
            const endDateStr = end.toISOString();

            console.log('   [Fetch] SolÂ·licitant dades per al rang:', startDateStr.slice(0, 10), 'a', endDateStr.slice(0, 10));

            const data = await fetchCalendarDataAction(startDateStr, endDateStr, currentSources);

            if (data.error) {
                console.error('   [Fetch] Error del servidor:', data.error);
                toast.error("Error carregant dades del calendari.", { description: data.error });
                setTasks([]); 
                setQuotes([]);
                setSentEmails([]);
                setReceivedEmails([]);
                return;
            }
            
            setTasks(data.tasks ?? []);
            setQuotes(data.quotes ?? []);
            setSentEmails(data.sentEmails ?? []);
            setReceivedEmails(data.receivedEmails ?? []);
            
        } catch (e) {
            console.error('   [Fetch] Error de xarxa/genÃ¨ric:', e);
            toast.error("Error carregant dades del calendari (error de xarxa).");
        } finally {
            console.log('   [Fetch] Finalitzant cÃ rrega. Loading=false');
            setIsLoading(false);
        }
    }, [fetchCalendarDataAction]); 

    
    // ğŸ’¡ useEffect: SINCRONITZADOR D'ESTAT (Dispara la cÃ rrega quan l'estat canvia)
    useEffect(() => {
        handleDataFetch(date, view, eventSources);
    }, [date, view, eventSources, handleDataFetch]);


    // -------------------------------------------------------------------------
    // ğŸ§­ updateDateAndData: Sols canvia l'estat
    // -------------------------------------------------------------------------
    const updateDateAndData = useCallback((newDate: Date, newView: View) => {
        console.log(`ğŸ§­ [Update] Canviant Data/View: ${newDate.toISOString().slice(0,10)} / ${newView}`);
        setDate(newDate);
        setView(newView);
        
    }, []);

    // -------------------------------------------------------------------------
    // âš™ï¸ handleToolbarNavigation: GestiÃ³ Unificada (FIX CLAU)
    // -------------------------------------------------------------------------
    const handleToolbarNavigation = useCallback((action: NavigateAction, newDate?: Date) => {
        let targetDate: Date;
        
        console.log(`â–¶ï¸ [Nav] Clic a: ${action}. Nova data suggerida: ${newDate ? newDate.toISOString().slice(0,10) : 'CALCULANT...'}`);

        // 1. Check if newDate is provided (Internal R-B-C navigation)
        if (newDate) {
            targetDate = newDate;
        } else {
            // 2. If newDate is NOT provided (External Toolbar navigation), calculate it manually.
            
            const currentDate = date;
            const multiplier = (action === 'NEXT' ? 1 : -1);

            switch (action) {
                case 'TODAY':
                    targetDate = startOfToday();
                    break;
                case 'NEXT':
                case 'PREV':
                    // Utilitzem les funcions primitives de date-fns segons la vista
                    switch (view) {
                        case 'month':
                            targetDate = addMonths(currentDate, multiplier);
                            break;
                        case 'week':
                            targetDate = addWeeks(currentDate, multiplier);
                            break;
                        case 'day':
                            targetDate = addDays(currentDate, multiplier);
                            break;
                        case 'agenda':
                            // Per a l'agenda, utilitzem navegaciÃ³ mensual
                            targetDate = addMonths(currentDate, multiplier);
                            break;
                        default:
                            targetDate = currentDate; 
                    }
                    break;
                default:
                    targetDate = currentDate;
            }
        }
        
        // Finalment, actualitzem la data (targetDate ja Ã©s vÃ lida) i la vista
        updateDateAndData(targetDate, view);
        
    }, [view, updateDateAndData, date]); 


    // -------------------------------------------------------------------------
    // ğŸ”„ handleEventSourcesChange: GestiÃ³ de Filtres
    // -------------------------------------------------------------------------
    const handleEventSourcesChange = useCallback((newSources: EventSourcesState) => {
        console.log('ğŸ”˜ [Filtre] Canviant filtres a:', newSources);

        console.log('   [Filtre] Netejant dades antigues (Wipe)');
        setTasks([]);
        setQuotes([]);
        setSentEmails([]);
        setReceivedEmails([]);
        
        setEventSources(newSources); 
        
    }, []);

    // -------------------------------------------------------------------------
    // ğŸ”„ handleViewChange: GestiÃ³ de Canvi de Vista
    // -------------------------------------------------------------------------
    const handleViewChange = useCallback((newView: View) => {
        setView(newView); 
    }, []);

    const handleMoveTask = useCallback((taskId: number, newDueDate: string) => setTasks(t => t.map(task => task.id === taskId ? { ...task, due_date: newDueDate } : task)), []);
    
    // Per re-carregar dades desprÃ©s d'una acciÃ³ (mutaciÃ³)
    const handleDataMutation = useCallback(() => {
        handleDataFetch(date, view, eventSources);
    }, [date, view, eventSources, handleDataFetch]);

    // -------------------------------------------------------------------------
    // ğŸ§¬ filteredEvents: Llista d'esdeveniments per al Calendari (useMemo)
    // -------------------------------------------------------------------------
    const filteredEvents: CalendarEvent[] = useMemo(() => {
        console.log(`âœ¨ [Memo] Recomputant events...`);
        return mapEvents({ tasks, quotes, sentEmails, receivedEmails, eventSources, isLoading, date });
    }, [tasks, quotes, sentEmails, receivedEmails, eventSources, isLoading, date]);
    
    // -------------------------------------------------------------------------
    // ğŸ“¤ RETORN DEL HOOK
    // -------------------------------------------------------------------------
    return {
        tasks, filteredEvents, view, date, eventSources, isLoading,
        handleToolbarNavigation, handleViewChange, handleDataMutation, handleMoveTask,
        setEventSources: handleEventSourcesChange,
        updateDateAndData,
    };
};

// =================== FILE: src/app/[locale]/(app)/crm/calendari/_hooks/useCalendarDialog.ts ===================

// src/app/[locale]/(app)/crm/calendari/_hooks/useCalendarDialogs.ts
'use client';

// ğŸ”§ React Hooks bÃ sics per a gestiÃ³ dâ€™estats i memÃ²ria de funcions
import { useState, useCallback } from 'react';

// âœ… Importem tipus del calendari (View i SlotInfo) per definir signatures mÃ©s precises
import { SlotInfo, View } from 'react-big-calendar'; 

// ğŸ”¤ Tipus del nostre projecte CRM (perquÃ¨ els diÃ legs sÃ piguen quin tipus dâ€™objecte estan obrint)
import { CalendarEvent } from '@/types/crm';
import { EnrichedTaskForCalendar, EnrichedQuoteForCalendar, EnrichedEmailForCalendar } from '../_components/CalendarData';

// âœ… Definim el tipus de la funciÃ³ que rep del Controller (per actualitzar vista i data)
type UpdateDateAndData = (newDate: Date, newView: View) => void;

interface UseCalendarDialogsProps {
    updateDateAndData: UpdateDateAndData;
}

/**
 * ğŸ¯ Hook personalitzat que centralitza tota la lÃ²gica de gestiÃ³ dels diÃ legs del calendari:
 * - Obrir i tancar diÃ legs per tasques, pressupostos i correus.
 * - Gestionar quin element estÃ  seleccionat.
 * - Obrir el mode â€œcrear nova tascaâ€ o â€œanar a vista de diaâ€.
 */
export const useCalendarDialogs = ({ updateDateAndData }: UseCalendarDialogsProps) => {

    // -------------------------------------------------------------------------
    // ğŸ§© 1. ESTATS DE DIÃ€LEGS
    // -------------------------------------------------------------------------
    // Controlen si els diferents diÃ legs (Task, Quote, Email) estan oberts o tancats.
    const [isTaskDialogOpen, setIsTaskDialogOpen] = useState(false);
    const [isQuoteDialogOpen, setIsQuoteDialogOpen] = useState(false);
    const [isEmailDialogOpen, setIsEmailDialogOpen] = useState(false);
    
    // -------------------------------------------------------------------------
    // ğŸ“Œ 2. ESTATS Dâ€™ELEMENTS SELECCIONATS
    // -------------------------------------------------------------------------
    // Quan lâ€™usuari fa clic en un esdeveniment, guardem quin tipus dâ€™element Ã©s.
    // AixÃ² permet que el diÃ leg mostri la informaciÃ³ especÃ­fica de cada cas.
    const [selectedTask, setSelectedTask] = useState<EnrichedTaskForCalendar | null>(null);
    const [selectedQuote, setSelectedQuote] = useState<EnrichedQuoteForCalendar | null>(null);
    const [selectedEmail, setSelectedEmail] = useState<EnrichedEmailForCalendar | null>(null);
    
    // -------------------------------------------------------------------------
    // ğŸ•’ 3. DATA INICIAL PER A CREACIÃ“
    // -------------------------------------------------------------------------
    // S'utilitza quan lâ€™usuari vol crear una nova tasca manualment.
    const [initialDate, setInitialDate] = useState<Date | undefined>(undefined);

    // -------------------------------------------------------------------------
    // ğŸ¯ 4. HANDLER: Quan lâ€™usuari selecciona un esdeveniment existent
    // -------------------------------------------------------------------------
    const handleSelectEvent = useCallback((event: CalendarEvent) => {
        // ğŸ”„ Reiniciem els estats anteriors (per evitar que quedin oberts diversos diÃ legs)
        setSelectedTask(null);
        setSelectedQuote(null);
        setSelectedEmail(null);

        // ğŸ§  Decidim quin diÃ leg obrir segons el tipus dâ€™esdeveniment seleccionat
        switch (event.eventType) {
            case 'task':
                setSelectedTask(event.resource as EnrichedTaskForCalendar);
                setIsTaskDialogOpen(true);
                break;
            case 'quote':
                setSelectedQuote(event.resource as EnrichedQuoteForCalendar);
                setIsQuoteDialogOpen(true);
                break;
            case 'email':
            case 'receivedEmail':
                setSelectedEmail(event.resource as EnrichedEmailForCalendar);
                setIsEmailDialogOpen(true);
                break;
            default:
                break;
        }
    }, []);

    // -------------------------------------------------------------------------
    // ğŸ—“ï¸ 5. HANDLER: Quan es fa clic a un espai buit del calendari (slot)
    // -------------------------------------------------------------------------
    const handleSelectSlot = useCallback((slotInfo: SlotInfo) => {
        // ğŸ” Fem servir la funciÃ³ del Controller per canviar la vista del calendari a â€œdiaâ€
        // AixÃ² permet mostrar de seguida la data clicada amb els esdeveniments corresponents.
        updateDateAndData(slotInfo.start, 'day');
    }, [updateDateAndData]);

    // -------------------------------------------------------------------------
    // âœ¨ 6. HANDLER: Obrir el diÃ leg per crear una nova tasca
    // -------------------------------------------------------------------------
    const handleOpenNewTaskDialog = useCallback(() => {
        // Assegurem que no hi ha cap tasca seleccionada (nova creaciÃ³)
        setSelectedTask(null);

        // Assignem la data actual com a base per a la nova tasca
        setInitialDate(new Date());

        // Obrim el diÃ leg de creaciÃ³
        setIsTaskDialogOpen(true);
    }, []);

    // -------------------------------------------------------------------------
    // ğŸ“¤ 7. RETORN DEL HOOK
    // -------------------------------------------------------------------------
    // Exposem tant els estats com els handlers perquÃ¨ el component pare (Calendari)
    // pugui controlar i reaccionar davant les interaccions.
    return {
        // Estats dels diÃ legs
        isTaskDialogOpen,
        isQuoteDialogOpen,
        isEmailDialogOpen,
        setIsTaskDialogOpen,
        setIsQuoteDialogOpen,
        setIsEmailDialogOpen,

        // Elements seleccionats
        selectedTask,
        selectedQuote,
        selectedEmail,
        initialDate,

        // Handlers per al calendari
        handleSelectEvent,
        handleSelectSlot,
        handleOpenNewTaskDialog,
    };
};


// =================== FILE: src/app/[locale]/(app)/crm/contactes/actions.ts ===================

// src/app/[locale]/(app)/crm/contactes/actions.ts

"use server";

import { revalidatePath } from "next/cache";
import { validateUserSession } from "@/lib/supabase/session";
import { type ActionResult } from "@/types/shared/index";
import {
Â  PERMISSIONS,
Â  validateSessionAndPermission,
} from "@/lib/permissions/permissions";
import { checkUsageLimit } from "@/lib/subscription/subscription";

// âœ… 1. Importem els tipus de la nostra FONT DE LA VERITAT
import type { Contact } from "@/types/db"; 

// âœ… 2. Importem el nostre servei
import * as contactService from "@/lib/services/crm/contacts/contacts.service";

// ----------------------------------------------------
// ACCIONS DE LLISTA/FETCHING
// ----------------------------------------------------

/**
Â * ACCIÃ“: ObtÃ© tots els contactes/proveÃ¯dors de l'equip actiu.
Â */
export async function fetchContacts(): Promise<Partial<Contact>[]> {
Â  const session = await validateSessionAndPermission(PERMISSIONS.VIEW_CONTACTS);

Â  if ("error" in session) {
Â  Â  console.error("No es pot carregar la sessiÃ³ per obtenir els contactes:", session.error.message);
Â  Â  return [];
Â  }

Â  const { supabase, activeTeamId } = session;

Â  try {
    // âœ… 3. Cridem al servei
Â  Â  return await contactService.fetchContactsList(supabase, activeTeamId);
Â  } catch (error) {
Â  Â  console.error("Error en carregar els contactes (action):", error);
Â  Â  throw new Error("No s'han pogut carregar els contactes.");
Â  }
}

// ----------------------------------------------------
// ACCIONS DE MUTACIÃ“
// ----------------------------------------------------

export async function createContactAction(
Â  formData: FormData,
): Promise<{ data: Contact | null; error: { message: string } | null }> {
Â  // 1. ValidaciÃ³ de PERMÃS
Â  const validation = await validateSessionAndPermission(PERMISSIONS.MANAGE_CONTACTS);
Â  if ("error" in validation) {
Â  Â  return { data: null, error: validation.error };
Â  }
Â  const { supabase, user, activeTeamId, context } = validation;

Â  // 2. ValidaciÃ³ de LÃMIT
Â  const limitCheck = await checkUsageLimit(
Â  Â  supabase,
Â  Â  activeTeamId,
Â  Â  "maxContacts",
Â  Â  context.planId,
Â  );

Â  if (!limitCheck.allowed) {
Â  Â  return {
Â  Â  Â  data: null,
Â  Â  Â  error: {
Â  Â  Â  Â  message: limitCheck.error || "Has assolit el lÃ­mit de contactes del teu pla.",
Â  Â  Â  },
Â  Â  };
Â  }

Â  try {
    // 3. Cridem al servei
Â  Â  const data = await contactService.createContact(
Â  Â  Â  supabase,
Â  Â  Â  formData,
Â  Â  Â  user.id,
Â  Â  Â  activeTeamId
Â  Â  );
Â  Â  
    // 4. Efecte secundari
Â  Â  revalidatePath("/crm/contactes");
Â  Â  return { data, error: null };

Â  } catch (error: unknown) {
    // 5. GestiÃ³ d'errors
Â  Â  const message = (error as Error).message;
Â  Â  console.error("Error en crear el contacte (action):", message);
Â  Â  return { data: null, error: { message } };
Â  }
}

/**
Â * ACCIÃ“: ObtÃ© contactes per a un proveÃ¯dor (VisiÃ³ 360).
Â */
export async function fetchContactsForSupplier(supplierId: string) {
Â  const session = await validateUserSession();
Â  if ("error" in session) {
Â  Â  console.error("Session error in fetchContactsForSupplier:", session.error);
Â  Â  return [];
Â  }
Â  const { supabase, activeTeamId } = session;

Â  try {
    // âœ… Cridem al servei
Â  Â  return await contactService.fetchContactsForSupplier(supabase, supplierId, activeTeamId);
Â  } catch (error) {
Â  Â  console.error("Error fetching contacts for supplier (action):", (error as Error).message);
Â  Â  return [];
Â  }
}

/**
Â * ACCIÃ“: Cerca contactes que NO estan vinculats.
Â */
export async function searchContactsForLinking(
Â  searchTerm: string,
): Promise<Pick<Contact, "id" | "nom" | "email">[]> {
Â  const session = await validateUserSession();
Â  if ("error" in session) return [];
Â  const { supabase, activeTeamId } = session;

Â  // Aquesta crida al servei ja retorna [] en cas d'error.
Â  return await contactService.searchContactsForLinking(supabase, activeTeamId, searchTerm);
}

/**
Â * ACCIÃ“: Vincula un contacte existent a un proveÃ¯dor.
Â */
export async function linkContactToSupplier(
Â  contactId: string, // Rebem string
Â  supplierId: string,
): Promise<ActionResult<Contact>> {
Â  // 1. ValidaciÃ³ de PermÃ­s
Â  const session = await validateSessionAndPermission(PERMISSIONS.MANAGE_CONTACTS);
Â  if ("error" in session) {
Â  Â  return { success: false, message: session.error.message };
Â  }
Â  const { supabase, activeTeamId } = session;

  // âœ… CORRECCIÃ“: Convertim l'ID a nÃºmero abans de passar-lo al servei.
  const contactIdNum = Number(contactId);
  if (isNaN(contactIdNum)) {
      return { success: false, message: "L'ID del contacte no Ã©s vÃ lid." };
  }

Â  try {
    // 2. Cridem al servei amb el tipus correcte (number)
Â  Â  const data = await contactService.linkContactToSupplier(
Â  Â  Â  supabase,
Â  Â  Â  contactIdNum,
Â  Â  Â  supplierId,
Â  Â  Â  activeTeamId
Â  Â  );

    // 3. Efectes secundaris
Â  Â  revalidatePath(`/finances/suppliers/${supplierId}`);
Â  Â  revalidatePath(`/crm/contactes/${contactId}`);

Â  Â  return { success: true, message: "Contacte vinculat.", data: data as Contact };

Â  } catch (error: unknown) {
    // 4. GestiÃ³ d'errors
Â  Â  const message = (error as Error).message;
Â  Â  console.error("Error linking contact (action):", message);
Â  Â  return { success: false, message: `Error en vincular el contacte: ${message}` };
Â  }
}

/**
Â * ACCIÃ“: Desvincula un contacte d'un proveÃ¯dor.
Â */
export async function unlinkContactFromSupplier(
Â  contactId: string, // Rebem string
Â  supplierId: string, // Per revalidar
): Promise<ActionResult> {
Â  // 1. ValidaciÃ³ de PermÃ­s
Â  const session = await validateSessionAndPermission(PERMISSIONS.MANAGE_CONTACTS);
Â  if ("error" in session) {
Â  Â  return { success: false, message: session.error.message };
Â  }
Â  const { supabase, activeTeamId } = session;

  // âœ… CORRECCIÃ“: Convertim l'ID a nÃºmero
  const contactIdNum = Number(contactId);
  if (isNaN(contactIdNum)) {
      return { success: false, message: "L'ID del contacte no Ã©s vÃ lid." };
  }

Â  try {
    // 2. Cridem al servei
Â  Â  await contactService.unlinkContactFromSupplier(supabase, contactIdNum, activeTeamId);

    // 3. Efectes secundaris
Â  Â  revalidatePath(`/finances/suppliers/${supplierId}`);
Â  Â  revalidatePath(`/crm/contactes/${contactId}`);

Â  Â  return { success: true, message: "Contacte desvinculat." };

Â  } catch (error: unknown) {
    // 4. GestiÃ³ d'errors
Â  Â  const message = (error as Error).message;
Â  Â  console.error("Error unlinking contact (action):", error);
Â  Â  return { success: false, message: `Error en desvincular el contacte: ${message}` };
Â  }
}

/**
Â * ACCIÃ“: ObtÃ© una llista de tots els contactes d'un equip.
Â */
export async function getTeamContactsList(): Promise<Contact[]> {
Â  const session = await validateUserSession()
Â  if ('error' in session) {
Â  Â  return []
Â  }
Â  const { supabase, activeTeamId } = session

Â  // âœ… Cridem al servei 'getAllContacts'
Â  const contacts = await contactService.getAllContacts(supabase, activeTeamId);

Â  return contacts as Contact[];
}

// =================== FILE: src/app/[locale]/(app)/crm/contactes/page.tsx ===================

import { Suspense } from 'react';
import type { Metadata } from 'next';
import { ContactsData } from './_components/ContactsData';
import { ContactsSkeleton } from './_components/ContactsSkeleton';

export const metadata: Metadata = { title: 'Contactes | Ribot' };

// âœ… NOU: Definim tots els parÃ metres que podem rebre
interface ContactesPageProps {
    searchParams: Promise<{ 
        page?: string;
        sort?: string;
        status?: string;
        q?: string; // TambÃ© per a la cerca
        view?: 'cards' | 'list'; // âœ… NOU: Afegim el parÃ metre de vista

    }>;
}

export default async function ContactesPage(props: ContactesPageProps) {
    const searchParams = await props.searchParams;
    
    // âœ… NOU: Llegim els valors de la URL o utilitzem valors per defecte
    const page = searchParams?.page || '1';
    const sortBy = searchParams?.sort || 'newest'; // Per defecte, els mÃ©s nous
    const status = searchParams?.status || 'all';   // Per defecte, tots
    const searchTerm = searchParams?.q || '';       // Mantenim la cerca
    const viewMode = searchParams?.view || 'cards'; // âœ… NOU: Llegim la vista o per defecte 'cards'


    // âœ… NOU: Creem una 'key' Ãºnica per a Suspense perquÃ¨ es reiniciÃ¯ amb cada canvi de filtre
    const suspenseKey = `${page}-${sortBy}-${status}-${searchTerm}`;

    return (
        <Suspense key={suspenseKey} fallback={<ContactsSkeleton />}>
            <ContactsData 
                page={page}
                sortBy={sortBy}
                status={status}
                searchTerm={searchTerm}
                viewMode={viewMode} // âœ… NOU: Passem la vista al component de dades

            />
        </Suspense>
    );
}

// =================== FILE: src/app/[locale]/(app)/crm/contactes/[contactId]/actions.ts ===================

// src/app/[locale]/(app)/crm/contactes/[contactId]/actions.ts
"use server";

import { revalidatePath } from "next/cache";
import { validateUserSession } from "@/lib/supabase/session";

// âœ… 1. Importem el servei
import * as contactService from "@/lib/services/crm/contacts/contacts.service";
// âœ… 2. Importem el tipus de detall des del servei
import type { ContactDetail } from "@/lib/services/crm/contacts/contacts.service";

// âŒ 3. ELIMINEM LA RE-EXPORTACIÃ“ DEL TIPUS
// export type { ContactDetail }; // <--- AQUESTA LÃNIA CAUSA EL REFERENCE ERROR

/**
 * ACCIÃ“: Actualitza un contacte a partir de FormData.
 */
export async function updateContactAction(
    contactId: number, 
    formData: FormData
): Promise<{ data: ContactDetail | null; error: { message: string } | null }> {
    // 1. ValidaciÃ³ de sessiÃ³
    const session = await validateUserSession();
    if ('error' in session) return { data: null, error: session.error };
    const { supabase, activeTeamId } = session;

    try {
        // 2. Cridem al servei
        const data = await contactService.updateContact(
            supabase,
            contactId,
            activeTeamId,
            formData
        );

        // 3. Efecte secundari
        revalidatePath(`/crm/contactes/${contactId}`);
        return { data, error: null };

    } catch (error: unknown) {
        // 4. GestiÃ³ d'errors
        const message = (error as Error).message;
        console.error("Error updating contact (action):", message);
        return { data: null, error: { message } };
    }
}

/**
 * ACCIÃ“: Elimina un contacte.
 */
export async function deleteContactAction(
    contactId: number
): Promise<{ success: boolean; message: string }> {
   // 1. ValidaciÃ³ de sessiÃ³
   const session = await validateUserSession();
    if ('error' in session) {
        return { success: false, message: session.error.message };
    }
    const { supabase, activeTeamId } = session;

    try {
        // 2. Cridem al servei
        await contactService.deleteContact(supabase, contactId, activeTeamId);

        // 3. Efecte secundari
        revalidatePath('/crm/contactes');
        return { success: true, message: "Contacte eliminat correctament." };

    } catch (error: unknown) {
        // 4. GestiÃ³ d'errors
        const message = (error as Error).message;
        console.error("Error deleting contact (action):", message);
        return { success: false, message };
    }
}

// =================== FILE: src/app/[locale]/(app)/crm/contactes/[contactId]/page.tsx ===================

import { createClient } from '@/lib/supabase/server';
import { Suspense } from 'react';
import type { Metadata } from 'next';
import { ContactDetailData } from './_components/ContactDetailData';
import { ContactDetailSkeleton } from './_components/ContactDetailSkeleton';

interface ContactDetailPageProps {
    params: Promise<{ contactId: string }>;
}

export async function generateMetadata(props: ContactDetailPageProps): Promise<Metadata> {
    const { contactId } = await props.params;
    const contactIdNumber = Number(contactId);
    const supabase = createClient();
    
    const { data: contact } = await supabase
        .from('contacts')
        .select('nom')
        .eq('id', contactIdNumber)
        .single();

    return { title: `${contact?.nom || 'Contacte'} | Ribot` };
}

export default async function ContactDetailPage(props: ContactDetailPageProps) {
    const { contactId } = await props.params;

    return (
        <Suspense fallback={<ContactDetailSkeleton />}>
            {/* âœ… CORRECCIÃ“: Embolcallem 'contactId' dins d'un objecte 'params'. */}
            <ContactDetailData params={{ contactId: contactId }} />
        </Suspense>
    );
}

// =================== FILE: src/app/[locale]/(app)/crm/contactes/[contactId]/_components/contact-detail-client.tsx ===================

// src/app/[locale]/(app)/crm/contactes/[contactId]/_components/contact-detail-client.tsx
"use client";

import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { useTranslations, useLocale } from 'next-intl';
import { ca, es, enUS } from 'date-fns/locale';
import { useContactDetail } from '../_hooks/useContactDetail';
import { ContactDetailHeader } from './ContactDetailHeader';
import { CONTACT_STATUS_MAP } from '@/config/contacts';

// âœ… 1. Importem els tipus DIRECTAMENT des del SERVEI
import type { ContactDetail, ContactRelatedData } from '@/lib/services/crm/contacts/contacts.service';

// âœ… 2. Importem els components de layout
import { ContactSummaryDashboard } from './tabs/ContactSummaryDashboard';
import { ContactViewSwitcher, type ContactViewKey } from './ContactViewSwitcher';

// âœ… 3. Importem el contingut que abans estava dins les pestanyes
import { ActivitiesTab } from './tabs/ActivitiesTab';
import { RelatedDataTable } from './tabs/RelatedDataTable';
import { DetailsTab } from './tabs/DetailsTab';

interface ContactDetailClientProps {
    initialContact: ContactDetail;
    // âœ… 4. Corregim el nom del tipus (coincidint amb el Server Component)
    initialRelatedData: ContactRelatedData;
}

// Definim les animacions per al canvi de vista
const viewVariants = {
    hidden: { opacity: 0, y: 20 },
    visible: { opacity: 1, y: 0, transition: { duration: 0.3 } },
    exit: { opacity: 0, y: -20, transition: { duration: 0.2 } },
};

export function ContactDetailClient({ initialContact, initialRelatedData }: ContactDetailClientProps) {
    const t = useTranslations('ContactDetailPage');
    const locale = useLocale();
    const dateLocale = { ca, es, en: enUS }[locale] || ca;
    
    const [activeView, setActiveView] = useState<ContactViewKey>('summary');

    const {
        contact,
        isEditing,
        isPending,
        formRef,
        handleSaveChanges,
        handleDelete,
        handleCancelEdit,
        setIsEditing,
    } = useContactDetail(initialContact, t);

    const getStatusLabel = (statusCode?: string | null) => {
        if (!statusCode) return t('details.noData');
        const status = CONTACT_STATUS_MAP.find(s => s.code === statusCode);
        return status ? t(`contactStatuses.${status.key}`) : statusCode;
    };

    useEffect(() => {
        if (isEditing) {
            setActiveView('details');
        }
    }, [isEditing]);

    return (
        <motion.div 
            initial={{ opacity: 0 }} 
            animate={{ opacity: 1 }} 
            className="flex flex-col h-full overflow-y-auto"
        >
            <form action={handleSaveChanges} ref={formRef} className="flex flex-col h-full">
                
                {/* 1. CAPÃ‡ALERA (Sticky) */}
                <ContactDetailHeader
                    contact={contact}
                    isEditing={isEditing}
                    isPending={isPending}
                    onEdit={() => setIsEditing(true)}
                    onCancel={handleCancelEdit}
                    onDelete={handleDelete}
                />

                {/* 2. NAVEGACIÃ“ DE MÃ’DULS (El nou Switcher) */}
                <ContactViewSwitcher
                    relatedData={initialRelatedData}
                    activeView={activeView}
                    onViewChange={setActiveView}
                    disabled={isEditing} // Deshabilitem el selector mentre s'edita
                />

                {/* 3. CONTINGUT ANIMAT */}
                <div className="p-4 md:px-6 flex-1">
                    <AnimatePresence mode="wait">
                        <motion.div
                            key={isEditing ? 'edit' : activeView}
                            variants={viewVariants}
                            initial="hidden"
                            animate="visible"
                            exit="exit"
                        >
                            {/* Cas especial: Mode EdiciÃ³ */}
                            {isEditing ? (
                                <DetailsTab 
                                    contact={contact} 
                                    isEditing={true} 
                                    dateLocale={dateLocale} 
                                    getStatusLabel={getStatusLabel} 
                                />
                            ) : (
                                <>
                                    {/* Vistes normals (Mode VisualitzaciÃ³) */}
                                    {activeView === 'summary' && (
                                        <ContactSummaryDashboard
                                            relatedData={initialRelatedData}
                                        />
                                    )}
                                    {activeView === 'activities' && (
                                        <ActivitiesTab 
                                            activities={initialRelatedData.activities} 
                                            dateLocale={dateLocale} 
                                            emptyMessage={t('activities.empty')}
                                        />
                                    )}
                                    {activeView === 'opportunities' && (
                                        <RelatedDataTable 
                                            data={initialRelatedData.opportunities} 
                                            columns={[
                                                { key: 'name', label: t('opportunities.table.name') }, 
                                                { key: 'stage', label: t('opportunities.table.status') }, 
                                                { key: 'value', label: t('opportunities.table.value') }
                                            ]} 
                                            linkPath="/crm/pipeline" 
                                            emptyMessage={t('opportunities.empty')} 
                                        />
                                    )}
                                    {activeView === 'quotes' && (
                                        <RelatedDataTable 
                                            data={initialRelatedData.quotes} 
                                            columns={[
                                                { key: 'quote_number', label: t('quotes.table.number') }, 
                                                { key: 'status', label: t('quotes.table.status') }, 
                                                { key: 'total_amount', label: t('quotes.table.total') } // Assegura't que 'total_amount' existeix
                                            ]} 
                                            linkPath="/finances/quotes" 
                                            emptyMessage={t('quotes.empty')} 
                                        />
                                    )}
                                    {activeView === 'invoices' && (
                                        <RelatedDataTable 
                                            data={initialRelatedData.invoices} 
                                            columns={[
                                                { key: 'invoice_number', label: t('invoices.table.number') }, 
                                                { key: 'status', label: t('invoices.table.status') }, 
                                                { key: 'total_amount', label: t('invoices.table.total') } // Assegura't que 'total_amount' existeix
                                            ]} 
                                            emptyMessage={t('invoices.empty')} 
                                        />
                                    )}
                                    {activeView === 'details' && (
                                        <DetailsTab 
                                            contact={contact} 
                                            isEditing={false} // Mode vista
                                            dateLocale={dateLocale} 
                                            getStatusLabel={getStatusLabel} 
                                        />
                                    )}
                                </>
                            )}
                        </motion.div>
                    </AnimatePresence>
                </div>
            </form>
        </motion.div>
    );
}

// =================== FILE: src/app/[locale]/(app)/crm/contactes/[contactId]/_components/ContactDetailData.tsx ===================

// /app/[locale]/(app)/crm/contactes/[contactId]/_components/ContactDetailData.tsx
import { notFound } from 'next/navigation';
import { ContactDetailClient } from './contact-detail-client';
import { validatePageSession } from "@/lib/supabase/session";

// âœ… 1. Importem els nostres serveis
import { 
    fetchContactDetail, 
    getContactRelatedData 
} from '@/lib/services/crm/contacts/contacts.service';
// âœ… 2. Importem el tipus des del servei (per passar-lo al client)
import type { ContactDetail, ContactRelatedData } from '@/lib/services/crm/contacts/contacts.service';
export type { ContactDetail, ContactRelatedData }; // Re-exportem

interface ContactDetailDataProps {
Â  Â  params: { contactId: string };
}

export async function ContactDetailData({ params }: ContactDetailDataProps) {
Â  Â  const { supabase, activeTeamId } = await validatePageSession();
Â  Â  const contactId = params.contactId;

Â  Â  const numericContactId = parseInt(contactId, 10);
Â  Â  if (isNaN(numericContactId)) {
Â  Â  Â  Â  notFound();
Â  Â  }

Â  Â  // âœ… 3. Cridem a TOTA la lÃ²gica de dades en paralÂ·lel
Â  Â  const [contactData, relatedData] = await Promise.all([
Â  Â  Â  Â  fetchContactDetail(supabase, numericContactId, activeTeamId),
Â  Â  Â  Â  getContactRelatedData(supabase, numericContactId, activeTeamId)
Â  Â  ]);

Â  Â  // Si el contacte principal no existeix, Ã©s un 404
Â  Â  if (!contactData) {
Â  Â  Â  Â  notFound();
Â  Â  }

Â  Â  // âœ… 4. Passem les dades netes al client
Â  Â  return <ContactDetailClient 
Â  Â  Â  Â  initialContact={contactData} 
Â  Â  Â  Â  initialRelatedData={relatedData} 
Â  Â  />;
}

// =================== FILE: src/app/[locale]/(app)/crm/contactes/[contactId]/_components/ContactDetailHeader.tsx ===================

"use client";

import { useSearchParams, useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { ArrowLeft, Edit, Save, Trash2, X, Loader2 } from 'lucide-react';
import type { ContactDetail} from '@/lib/services/crm/contacts/contacts.service';
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
    AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
// âœ… 1. Importem Input i useTranslations
import { Input } from '@/components/ui/input';
import { useTranslations } from 'next-intl';

interface ContactDetailHeaderProps {
    contact: ContactDetail;
    isEditing: boolean;
    isPending: boolean;
    onEdit: () => void;
    onCancel: () => void;
    onDelete: () => void;
}

export function ContactDetailHeader({
    contact,
    isEditing,
    isPending,
    onEdit,
    onCancel,
    onDelete,
}: ContactDetailHeaderProps) {
    const router = useRouter();
    const searchParams = useSearchParams();
    const fromUrl = searchParams.get('from');
    const t = useTranslations('ContactDetailPage');

    const handleBackOrCancel = () => {
        if (isEditing) {
            onCancel();
        } else if (fromUrl) {
            router.push(fromUrl);
        } else {
            router.push('/crm/contactes');
        }
    };

    return (
        <div className="flex items-center justify-between p-4 border-b bg-background sticky top-0 z-10">
            <div className="flex items-center gap-4 w-full">
                <Button
                    type="button" // âœ… SOLUCIÃ“ 1
                    variant="outline"
                    size="icon"
                    onClick={handleBackOrCancel}
                    disabled={isPending}
                    aria-label={isEditing ? "CancelÂ·lar ediciÃ³" : "Tornar"}
                >
                    {isEditing ? <X className="h-4 w-4" /> : <ArrowLeft className="h-4 w-4" />}
                </Button>

                <div className="flex-1">
                    {isEditing ? (
                        <div>
                            <Input
                                name="nom" // Assegurem que el 'nom' sempre s'enviÃ¯
                                defaultValue={contact.nom || ''}
                                required
                                className="text-2xl font-bold h-auto p-0 border-0 shadow-none focus-visible:ring-0"
                                placeholder={t('details.labels.name')}
                            />
                            <p className="text-sm text-muted-foreground">
                                {contact.suppliers?.nom || contact.email}
                            </p>
                        </div>
                    ) : (
                        <div>
                            <h1 className="text-2xl font-bold">{contact.nom}</h1>
                            <p className="text-sm text-muted-foreground">
                                {contact.suppliers?.nom || contact.email}
                            </p>
                        </div>
                    )}
                </div>
            </div>

            <div className="flex items-center gap-2">
                {isEditing ? (
                    <>
                        <Button type="submit" disabled={isPending}>
                            {isPending ? (
                                <Loader2 className="h-4 w-4 animate-spin mr-2" />
                            ) : (
                                <Save className="h-4 w-4 mr-2" />
                            )}
                            Desar
                        </Button>

                        <Button
                            type="button"
                            variant="outline"
                            onClick={onCancel}
                            disabled={isPending}
                        >
                            CancelÂ·lar
                        </Button>
                    </>
                ) : (
                    <Button
                        type="button"
                        variant="outline"
                        onClick={onEdit}
                        disabled={isPending}
                    >
                        <Edit className="h-4 w-4 mr-2" />
                        Editar
                    </Button>
                )}

                <AlertDialog>
                    <AlertDialogTrigger asChild>
                        <Button
                            type="button" // âœ… SOLUCIÃ“ 3
                            variant="destructive"
                            size="icon"
                            disabled={isPending}
                        >
                            <Trash2 className="h-4 w-4" />
                        </Button>
                    </AlertDialogTrigger>
                    <AlertDialogContent>
                        <AlertDialogHeader>
                            <AlertDialogTitle>EstÃ s segur?</AlertDialogTitle>
                            <AlertDialogDescription>
                                Aquesta acciÃ³ no es pot desfer. S'esborrarÃ  permanentment el contacte
                                <span className="font-medium"> {contact.nom}</span>.
                            </AlertDialogDescription>
                        </AlertDialogHeader>
                        <AlertDialogFooter>
                            <AlertDialogCancel disabled={isPending}>CancelÂ·lar</AlertDialogCancel>
                            <AlertDialogAction
                                className="bg-destructive hover:bg-destructive/90"
                                onClick={onDelete}
                                disabled={isPending}
                            >
                                {isPending ? <Loader2 className="h-4 w-4 animate-spin" /> : "Esborrar"}
                            </AlertDialogAction>
                        </AlertDialogFooter>
                    </AlertDialogContent>
                </AlertDialog>
        </div>
    </div>
    
    );
}

// =================== FILE: src/app/[locale]/(app)/crm/contactes/[contactId]/_components/ContactDetailSkeleton.tsx ===================

"use client";



export function ContactDetailSkeleton() {
  return (
    <div className="space-y-8 animate-pulse">
      {/* Esquelet de la CapÃ§alera */}
      <div>
        <div className="h-9 w-40 bg-gray-700/50 rounded-md mb-4"></div>
        <div className="flex items-center gap-6">
          <div className="w-20 h-20 bg-gray-700/50 rounded-full shrink-0"></div>
          <div>
            <div className="h-10 w-64 bg-gray-700/50 rounded-md"></div>
            <div className="h-6 w-48 bg-gray-700/50 rounded-md mt-2"></div>
          </div>
        </div>
      </div>

      {/* Esquelet de les Pestanyes */}
      <div className="glass-card p-2">
        <div className="flex border-b border-gray-700/50">
          {[...Array(5)].map((_, i) => (
            <div key={i} className="h-10 w-28 bg-gray-700/50 m-1 rounded-md"></div>
          ))}
        </div>
        <div className="p-8">
          <div className="h-8 w-56 bg-gray-700/50 rounded-md mb-6"></div>
          <div className="space-y-4">
            <div className="h-6 w-full bg-gray-700/50 rounded-md"></div>
            <div className="h-6 w-3/4 bg-gray-700/50 rounded-md"></div>
            <div className="h-6 w-5/6 bg-gray-700/50 rounded-md"></div>
          </div>
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/crm/contactes/[contactId]/_components/ContactViewSwitcher.tsx ===================

"use client";

import React from 'react';
import { useTranslations } from 'next-intl';
import { Button } from '@/components/ui/button';
import { Activity, Briefcase, FileText, Receipt, User, LayoutDashboard } from 'lucide-react';
import { motion } from 'framer-motion';
// Assegura't que aquesta ruta sigui correcta per al teu projecte
import { type RelatedData } from './tabs/ContactSummaryDashboard'; 
import { cn } from '@/lib/utils/utils';

export type ContactViewKey = 'summary' | 'activities' | 'opportunities' | 'quotes' | 'invoices' | 'details';

interface ContactViewSwitcherProps {
    relatedData: RelatedData;
    activeView: ContactViewKey;
    onViewChange: (view: ContactViewKey) => void;
    disabled?: boolean;
}

// Component intern per a cada targeta de mÃ²dul
const ModuleCard: React.FC<{
    title: string;
    count: number;
    icon: React.ElementType;
    colorClass: string; 
    isActive: boolean;
    onClick: () => void;
    disabled?: boolean;
}> = ({ title, count, icon: Icon, colorClass, isActive, onClick, disabled }) => (
    <Button 
        // âœ… --- AQUESTA Ã‰S LA CORRECCIÃ“ CLAU ---
        type="button" 
        // âœ… --- FI DE LA CORRECCIÃ“ ---
        variant={isActive ? "secondary" : "outline"} 
        className={cn(
            "h-full w-full flex flex-col items-center justify-center p-4 gap-2 relative transition-all duration-200",
            isActive ? 'shadow-md border-primary' : 'hover:bg-muted/50',
            disabled && 'opacity-50 cursor-not-allowed'
        )}
        onClick={onClick}
        disabled={disabled}
    >
        <div className={cn("p-3 rounded-full", isActive ? colorClass : "bg-muted")}>
            <Icon className={cn("h-6 w-6", isActive ? "text-white" : "text-primary")} />
        </div>
        <span className="font-semibold text-base">{title}</span>
        {count > 0 && (
            <span className="text-muted-foreground text-sm">{count}</span>
        )}
        {isActive && (
            <motion.div 
                layoutId="activeContactModule" 
                className={cn("absolute bottom-0 left-0 right-0 h-1.5 rounded-t-full", colorClass)}
            />
        )}
    </Button>
);

export function ContactViewSwitcher({ relatedData, activeView, onViewChange, disabled }: ContactViewSwitcherProps) {
    const t = useTranslations('ContactDetailPage.tabs');

    const modules = [
        { key: 'summary', title: t('summary'), icon: LayoutDashboard, count: 0, color: 'bg-indigo-500' },
        { key: 'activities', title: t('activities'), icon: Activity, count: relatedData.activities.length, color: 'bg-blue-500' },
        { key: 'opportunities', title: t('opportunities'), icon: Briefcase, count: relatedData.opportunities.length, color: 'bg-green-500' },
        { key: 'quotes', title: t('quotes'), icon: FileText, count: relatedData.quotes.length, color: 'bg-orange-500' },
        { key: 'invoices', title: t('invoices'), icon: Receipt, count: relatedData.invoices.length, color: 'bg-purple-500' },
        { key: 'details', title: t('details'), icon: User, count: 0, color: 'bg-gray-500' },
    ];

    return (
        <div className="px-4 md:px-6 py-6">
            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                {modules.map(mod => (
                    <ModuleCard
                        key={mod.key}
                        title={mod.title}
                        icon={mod.icon}
                        count={mod.count}
                        colorClass={mod.color}
                        isActive={activeView === mod.key}
                        onClick={() => onViewChange(mod.key as ContactViewKey)}
                        disabled={disabled}
                    />
                ))}
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/crm/contactes/[contactId]/_components/EditableField.tsx ===================

// @/app/[locale]/(app)/crm/contactes/[id]/_components/EditableField.tsx
import React from 'react';
import { Label } from '@/components/ui/label';

interface EditableFieldProps {
    label: string;
    isEditing: boolean;
    viewValue: React.ReactNode;
    editComponent: React.ReactNode;
    className?: string;
}

/**
 * Component per mostrar un camp que pot ser visualitzat o editat.
 * Encapsula la lÃ²gica de renderitzar un <p> o un component d'ediciÃ³ (<Input>, <Select>, etc.)
 */
export const EditableField: React.FC<EditableFieldProps> = ({ label, isEditing, viewValue, editComponent, className }) => {
    return (
        <div className={`space-y-2 ${className}`}>
            <Label>{label}</Label>
            {isEditing ? (
                editComponent
            ) : (
                <p className="text-lg pt-2 min-h-[42px] flex items-center text-foreground">
                    {viewValue}
                </p>
            )}
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/contactes/[contactId]/_components/tabs/ActivitiesTab.tsx ===================

// /app/[locale]/(app)/crm/contactes/[contactId]/_components/tabs/ActivitiesTab.tsx (Refactoritzat)

import { FC } from 'react';
import { format } from 'date-fns';
import { type Locale } from 'date-fns';
import { EmptyState } from '@/components/shared/EmptyState';
// âœ… 1. Importem la definiciÃ³ de la base de dades.
import { type Database } from '@/types/supabase';

// âœ… 2. Definim el tipus 'Activity' a partir de la taula corresponent.
type Activity = Database['public']['Tables']['activities']['Row'];

interface Props {
    activities: Activity[];
    dateLocale: Locale;
    emptyMessage: string;
}

export const ActivitiesTab: FC<Props> = ({ activities, dateLocale, emptyMessage }) => {
    if (activities.length === 0) return <EmptyState message={emptyMessage} />;

    return (
        <div className="space-y-4">
            {activities.map(act => (
                <div key={act.id} className="p-4 rounded-lg bg-background/50 border">
                    <div className="flex justify-between items-center text-sm mb-2">
                        <span className="font-bold text-primary">{act.type}</span>
                        {/* âœ… 3. Afegim una comprovaciÃ³ per si 'created_at' Ã©s nul. */}
                        <span className="text-muted-foreground">
                            {act.created_at ? format(new Date(act.created_at), "d MMMM yyyy, HH:mm", { locale: dateLocale }) : ''}
                        </span>
                    </div>
                    <p className="text-foreground italic">"{act.content}"</p>
                </div>
            ))}
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/contactes/[contactId]/_components/tabs/ContactSummaryDashboard.tsx ===================

"use client";

import React, { useMemo } from 'react';
import { useTranslations } from 'next-intl';
// âŒ Ja no necessitem 'Card', 'CardHeader', etc.
// import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { type Database } from '@/types/supabase';
import { DollarSign, BarChart, CheckCircle, Clock } from 'lucide-react';
import { motion } from 'framer-motion';

// âœ… 1. Importem el component 'ModuleCard' que m'has passat
import { ModuleCard } from '@/components/shared/ModuleCard';

// Tipus per a les dades relacionades
type Quote = Database['public']['Tables']['quotes']['Row'];
type Opportunity = Database['public']['Tables']['opportunities']['Row'];
type Invoice = Database['public']['Tables']['invoices']['Row'];
type Activity = Database['public']['Tables']['activities']['Row'];
export type RelatedData = {
    quotes: Quote[];
    opportunities: Opportunity[];
    invoices: Invoice[];
    activities: Activity[];
};

interface ContactSummaryDashboardProps {
    relatedData: RelatedData;
}

// âŒ 2. Eliminem el component intern 'SummaryStatCard'
// const SummaryStatCard: React.FC<{ ... }> = ...

/**
 * El "Dashboard" de resum per a un contacte especÃ­fic.
 * Ara fet amb ModuleCard.
 */
export function ContactSummaryDashboard({ relatedData }: ContactSummaryDashboardProps) {
    const t = useTranslations('ContactDetailPage');

    // âœ… 3. La lÃ²gica de cÃ lcul es mantÃ© exactament igual
    const stats = useMemo(() => {
        // 1. Valor total (Oportunitats guanyades)
        const totalValue = relatedData.opportunities
            .filter(op => op.stage_name === 'Guanyat' && op.value)
            .reduce((sum, op) => sum + (op.value || 0), 0);

        // 2. Oportunitats obertes
        const openOpportunities = relatedData.opportunities
            .filter(op => op.stage_name !== 'Guanyat' && op.stage_name !== 'Perdut');
            
        const openValue = openOpportunities.reduce((sum, op) => sum + (op.value || 0), 0);

        // 3. Total d'Activitats
        const totalActivities = relatedData.activities.length;
            
        // 4. Total Facturat (Pagat) - Utilitzem total_amount (de l'esquema)
        const totalInvoiced = relatedData.invoices
            .filter(inv => inv.status === 'Paid' && inv.total_amount)
            .reduce((sum, inv) => sum + (inv.total_amount || 0), 0);

        return {
            totalValue,
            openOpportunitiesCount: openOpportunities.length,
            openValue,
            totalActivities,
            totalInvoiced,
        };
    }, [relatedData]);

    const formatCurrency = (value: number) => {
        return `â‚¬${value.toLocaleString('ca-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    };

    // âœ… 4. Refactoritzem el JSX per utilitzar ModuleCard
    return (
        <motion.div 
            className="grid gap-4 md:grid-cols-2 lg:grid-cols-4"
            initial={{ opacity: 0, y: -10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.3, delay: 0.1 }}
        >
            <ModuleCard
                title={t('summary.totalValue')}
                icon={DollarSign}
                variant="success" // Variant verd
                isCollapsible={false} // No volem que es pugui tancar
            >
                <div className="text-2xl font-bold">{formatCurrency(stats.totalValue)}</div>
                <p className="text-xs text-muted-foreground">{t('summary.wonOpportunities')}</p>
            </ModuleCard>

            <ModuleCard
                title={t('summary.openOpportunities')}
                icon={BarChart}
                variant="sales" // Variant blau
                isCollapsible={false}
            >
                <div className="text-2xl font-bold">{stats.openOpportunitiesCount}</div>
                <p className="text-xs text-muted-foreground">
                    {`${t('summary.potentialValue')} ${formatCurrency(stats.openValue)}`}
                </p>
            </ModuleCard>

            <ModuleCard
                title={t('summary.totalActivities')}
                icon={Clock}
                variant="activity" // Variant taronja
                isCollapsible={false}
            >
                <div className="text-2xl font-bold">{stats.totalActivities}</div>
                <p className="text-xs text-muted-foreground">{t('summary.totalInteractions')}</p>
            </ModuleCard>
            
            <ModuleCard
                title={t('summary.totalInvoiced')}
                icon={CheckCircle}
                variant="invoices" // Variant vermell/lila
                isCollapsible={false}
            >
                <div className="text-2xl font-bold">{formatCurrency(stats.totalInvoiced)}</div>
                <p className="text-xs text-muted-foreground">{t('summary.paidInvoices')}</p>
            </ModuleCard>

        </motion.div>
    );
}

// =================== FILE: src/app/[locale]/(app)/crm/contactes/[contactId]/_components/tabs/DetailsTab.tsx ===================

// /app/[locale]/(app)/crm/contactes/[contactId]/_components/tabs/DetailsTab.tsx

import { FC } from 'react';
import { useTranslations } from 'next-intl';
import Link from 'next/link';
import { format } from 'date-fns';
import { type Locale } from 'date-fns';
import { type Json } from '@/types/supabase';
import type { ContactDetail} from '@/lib/services/crm/contacts/contacts.service';

// Importem els components necessaris
import { ModuleCard } from '@/components/shared/ModuleCard';
import { EditableField } from '../EditableField';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { SupplierCombobox } from '@/components/shared/SupplierCombobox';

// Importem configuraciÃ³ i icones
import { CONTACT_STATUS_MAP } from '@/config/contacts';
import { User, Info, StickyNote } from 'lucide-react';

interface Props {
    contact: ContactDetail;
    isEditing: boolean;
    dateLocale: Locale;
    getStatusLabel: (code?: string | null) => string;
}

/**
 * Component de pestanya "Detalls" redissenyat.
 * Utilitza ModuleCard per a cada secciÃ³ d'informaciÃ³
 * i encapsula tota la lÃ²gica d'ediciÃ³.
 */
export const DetailsTab: FC<Props> = ({ contact, isEditing, dateLocale, getStatusLabel }) => {
    const t = useTranslations('ContactDetailPage'); // t_contact_detail_page

    // --- LÃ²gica extreta de PersonalInfoSection ---
    const formattedBirthday = contact.birthday 
        ? format(new Date(contact.birthday), 'dd/MM/yyyy', { locale: dateLocale }) 
        : t('details.noData');
    
    // Funcions segures per accedir a camps JSONB
    const getAddressCity = (address: Json) => (address as { city?: string })?.city || '';
    const getSocialMediaLinkedin = (social: Json) => (social as { linkedin?: string })?.linkedin || '';
    const hobbiesString = Array.isArray(contact.hobbies) ? contact.hobbies.join(', ') : '';
    // --- Fi de la lÃ²gica de PersonalInfoSection ---

    return (
        <div className="space-y-6">
            
            {/* ==============================================
                Targeta d'InformaciÃ³ General
            =============================================== */}
            <ModuleCard
                title={t('details.generalInfo')}
                icon={User}
                variant="info" // Pots canviar-ho per 'default' o un altre color
                // NomÃ©s es pot colÂ·lapsar si NO estem editant
                isCollapsible={!isEditing} 
                defaultOpen={true}
            >
                <div className="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-6">
                    <EditableField 
                        label={t('details.labels.email')} 
                        isEditing={isEditing} 
                        viewValue={contact.email || t('details.noData')} 
                        editComponent={<Input name="email" type="email" defaultValue={contact.email || ''} />} 
                    />
                    <EditableField 
                        label={t('details.labels.phone')} 
                        isEditing={isEditing} 
                        viewValue={contact.telefon || t('details.noData')} 
                        editComponent={<Input name="telefon" defaultValue={contact.telefon || ''} />} 
                    />
                    <EditableField 
                        label={t('details.labels.status')} 
                        isEditing={isEditing} 
                        viewValue={getStatusLabel(contact.estat)} 
                        editComponent={
                            <Select name="estat" defaultValue={contact.estat || undefined}>
                                <SelectTrigger><SelectValue /></SelectTrigger>
                                <SelectContent>{CONTACT_STATUS_MAP.map(s => <SelectItem key={s.code} value={s.code}>{t(`contactStatuses.${s.key}`)}</SelectItem>)}</SelectContent>
                            </Select>
                        } 
                    />
                    <EditableField 
                        label={t('details.labels.jobTitle')} 
                        isEditing={isEditing} 
                        viewValue={contact.job_title || t('details.noData')} 
                        editComponent={<Input name="job_title" defaultValue={contact.job_title || ''} />} 
                    />
                    <EditableField
                        label={t('details.labels.company')}
                        isEditing={isEditing}
                        viewValue={
                            contact.suppliers ? (
                                <Link
                                    href={`/finances/suppliers/${contact.suppliers.id}`}
                                    className="font-medium text-blue-600 hover:underline"
                                >
                                    {contact.suppliers.nom}
                                </Link>
                            ) : t('details.noData')
                        }
                        editComponent={
                            <SupplierCombobox
                                name="supplier_id"
                                defaultValue={contact.suppliers ? contact.suppliers.id : undefined}
                                initialSupplier={contact.suppliers ? { id: contact.suppliers.id, nom: contact.suppliers.nom } : null}
                            />
                        }
                    />
                    <EditableField 
                        label={t('details.labels.industry')} 
                        isEditing={isEditing} 
                        viewValue={contact.industry || t('details.noData')} 
                        editComponent={<Input name="industry" defaultValue={contact.industry || ''} />} 
                    />
                    <EditableField 
                        label={t('details.labels.leadSource')} 
                        isEditing={isEditing} 
                        viewValue={contact.lead_source || t('details.noData')} 
                        editComponent={<Input name="lead_source" defaultValue={contact.lead_source || ''} />} 
                    />
                </div>
            </ModuleCard>

            {/* ==============================================
                Targeta d'InformaciÃ³ Personal
            =============================================== */}
            <ModuleCard
                title={t('details.personalInfo')}
                icon={Info}
                variant="sales" // Pots canviar-ho per un altre color
                isCollapsible={!isEditing}
                defaultOpen={true}
            >
                <div className="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-6">
                    <EditableField
                        label={t('details.labels.birthday')}
                        isEditing={isEditing}
                        viewValue={formattedBirthday}
                        editComponent={<Input type="date" name="birthday" defaultValue={contact.birthday || ''} />}
                    />
                    <EditableField
                        label={t('details.labels.city')}
                        isEditing={isEditing}
                        viewValue={getAddressCity(contact.address) || t('details.noData')}
                        editComponent={<Input name="address.city" defaultValue={getAddressCity(contact.address)} />}
                    />
                    <EditableField
                        label={t('details.labels.linkedin')}
                        isEditing={isEditing}
                        viewValue={getSocialMediaLinkedin(contact.social_media) || t('details.noData')}
                        editComponent={<Input name="social_media.linkedin" defaultValue={getSocialMediaLinkedin(contact.social_media)} />}
                    />
                    <EditableField
                        label={t('details.labels.children')}
                        isEditing={isEditing}
                        viewValue={contact.children_count ?? t('details.noData')}
                        editComponent={<Input type="number" name="children_count" defaultValue={contact.children_count ?? ''} />}
                    />
                    <EditableField
                        label={t('details.labels.partnerName')}
                        isEditing={isEditing}
                        viewValue={contact.partner_name || t('details.noData')}
                        editComponent={<Input name="partner_name" defaultValue={contact.partner_name || ''} />}
                    />
                    <EditableField
                        label={t('details.labels.hobbies')}
                        isEditing={isEditing}
                        viewValue={hobbiesString || t('details.noData')}
                        editComponent={<Input name="hobbies" defaultValue={hobbiesString} />}
                    />
                </div>
            </ModuleCard>

            {/* ==============================================
                Targeta de Notes
            =============================================== */}
            <ModuleCard
                title={t('details.notes')}
                icon={StickyNote}
                variant="activity" // Pots canviar-ho per un altre color
                isCollapsible={!isEditing}
                defaultOpen={true}
            >
                {isEditing ? (
                    <Textarea name="notes" defaultValue={contact.notes || ''} rows={6} />
                ) : (
                    <p className="text-base text-muted-foreground whitespace-pre-wrap min-h-[120px]">
                        {contact.notes || t('details.noNotes')}
                    </p>
                )}
            </ModuleCard>

        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/contactes/[contactId]/_components/tabs/GeneralInfoSection.tsx ===================

import { FC } from 'react';
import { EditableField } from '../EditableField';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { useTranslations } from 'next-intl';
import Link from 'next/link';

import type { ContactDetail } from '@/lib/services/crm/contacts/contacts.service';
import { CONTACT_STATUS_MAP } from '@/config/contacts';
import { SupplierCombobox } from '@/components/shared/SupplierCombobox';

interface Props {
    contact: ContactDetail;
    isEditing: boolean;
    getStatusLabel: (code?: string | null) => string;
}

export const GeneralInfoSection: FC<Props> = ({ contact, isEditing, getStatusLabel }) => {
    const t = useTranslations('ContactDetailPage');
    return (
        <div>
            <h3 className="text-2xl font-bold mb-6">{t('details.generalInfo')}</h3>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-6">

                {/* âœ… PAS 2: AFEGIR AQUEST CAMP 'nom' */}
                <EditableField 
                    label={t('details.labels.name')} // Afegeix 'name' a les traduccions
                    isEditing={isEditing} 
                    viewValue={contact.nom || t('details.noData')} 
                    editComponent={
                        <Input 
                            name="nom" // <-- AQUEST Ã‰S EL CAMP QUE FALTAVA
                            defaultValue={contact.nom || ''} 
                            required 
                        />
                    } 
                />

                <EditableField 
                    label={t('details.labels.email')} 
                    isEditing={isEditing} 
                    viewValue={contact.email || t('details.noData')} 
                    editComponent={<Input name="email" type="email" defaultValue={contact.email || ''} />} 
                />
                
                <EditableField 
                    label={t('details.labels.phone')} 
                    isEditing={isEditing} 
                    viewValue={contact.telefon || t('details.noData')} 
                    editComponent={<Input name="telefon" defaultValue={contact.telefon || ''} />} 
                />

                <EditableField 
                    label={t('details.labels.status')} 
                    isEditing={isEditing} 
                    viewValue={getStatusLabel(contact.estat)} 
                    editComponent={
                        <Select name="estat" defaultValue={contact.estat || undefined}>
                            <SelectTrigger><SelectValue /></SelectTrigger>
                            <SelectContent>{CONTACT_STATUS_MAP.map(s => <SelectItem key={s.code} value={s.code}>{t(`contactStatuses.${s.key}`)}</SelectItem>)}</SelectContent>
                        </Select>
                    } 
                />

                <EditableField 
                    label={t('details.labels.jobTitle')} 
                    isEditing={isEditing} 
                    viewValue={contact.job_title || t('details.noData')} 
                    editComponent={<Input name="job_title" defaultValue={contact.job_title || ''} />} 
                />

                <EditableField
                    label={t('details.labels.company')}
                    isEditing={isEditing}
                    viewValue={
                        contact.suppliers ? (
                            <Link
                                href={`/finances/suppliers/${contact.suppliers.id}`}
                                className="font-medium text-blue-600 hover:underline"
                            >
                                {contact.suppliers.nom}
                            </Link>
                        ) : t('details.noData')
                    }
                    editComponent={
                        <SupplierCombobox
                            name="supplier_id"
                            defaultValue={contact.suppliers ? contact.suppliers.id : undefined}
                            initialSupplier={contact.suppliers ? { id: contact.suppliers.id, nom: contact.suppliers.nom } : null}
                        />
                    }
                />

                <EditableField 
                    label={t('details.labels.industry')} 
                    isEditing={isEditing} 
                    viewValue={contact.industry || t('details.noData')} 
                    editComponent={<Input name="industry" defaultValue={contact.industry || ''} />} 
                />

                <EditableField 
                    label={t('details.labels.leadSource')} 
                    isEditing={isEditing} 
                    viewValue={contact.lead_source || t('details.noData')} 
                    editComponent={<Input name="lead_source" defaultValue={contact.lead_source || ''} />} 
                />

            </div>
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/contactes/[contactId]/_components/tabs/RelatedDataTable.tsx ===================

import Link from 'next/link';
import { FC } from 'react';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { StatusBadge } from '@/components/shared/StatusBadge';
import { EmptyState } from '@/components/shared/EmptyState';

// âœ… 1. Tipus de dades mÃ©s flexible
type DataItem = { 
    id: string | number; 
    status?: string | null; 
    stage_name?: string | null; 
    value?: number | null;         // Per Oportunitats
    total_amount?: number | null;  // âœ… Per Factures i Pressupostos
    name?: string | null; 
    quote_number?: string | null; 
    invoice_number?: string | null; 
};

interface Column { 
    key: string; 
    label: string; 
}

interface Props { 
    data: DataItem[]; 
    columns: Column[]; 
    linkPath?: string; 
    emptyMessage: string; 
}

export const RelatedDataTable: FC<Props> = ({ data, columns, linkPath, emptyMessage }) => {
    if (data.length === 0) return <EmptyState message={emptyMessage} />;

    return (
        <Table>
            <TableHeader>
                <TableRow>
                    {columns.map(col => (
                        <TableHead key={col.key} className={col.key.includes('value') || col.key.includes('total') ? 'text-right' : ''}>
                            {col.label}
                        </TableHead>
                    ))}
                </TableRow>
            </TableHeader>
            <TableBody>
                {data.map((item) => (
                    <TableRow key={item.id}>
                        {/* CelÂ·la de Nom/NÃºmero */}
                        <TableCell className="font-medium">
                            {linkPath ? (
                                <Link href={`${linkPath}/${item.id}`} className="text-primary hover:underline">
                                    {item.name || item.quote_number || item.invoice_number}
                                </Link>
                            ) : (
                                item.name || item.invoice_number
                            )}
                        </TableCell>

                        {/* CelÂ·la d'Estat */}
                        <TableCell>
                            <StatusBadge status={item.status || item.stage_name} />
                        </TableCell>

                        {/* âœ… 2. CelÂ·la de Valor (corregida) */}
                        <TableCell className="text-right font-semibold">
                            â‚¬{((item.total_amount || item.value) || 0).toLocaleString('ca-ES')}
                        </TableCell>
                    </TableRow>
                ))}
            </TableBody>
        </Table>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/contactes/[contactId]/_hooks/useContactDetail.ts ===================

// src/app/[locale]/(app)/crm/contactes/[contactId]/_hooks/useContactDetail.ts
"use client";

import { useState, useTransition, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { toast } from 'sonner';
import { type useTranslations } from 'next-intl';

// âœ… 1. Importem NOMÃ‰S les accions des de 'actions'
import { updateContactAction, deleteContactAction } from '../actions';
// âœ… 2. Importem el TIPUS directament des del SERVEI
import type { ContactDetail } from '@/lib/services/crm/contacts/contacts.service';

type TFunction = ReturnType<typeof useTranslations<string>>;

/**
 * Hook per gestionar la lÃ²gica de la pÃ gina de detall d'un contacte.
 */
export function useContactDetail(initialContact: ContactDetail, t: TFunction) {
    const router = useRouter();
    const [isPending, startTransition] = useTransition();
    const [isEditing, setIsEditing] = useState(false);
    
    const [contact, setContact] = useState<ContactDetail>(initialContact);
    const formRef = useRef<HTMLFormElement>(null);

    const handleSaveChanges = (formData: FormData) => {
        startTransition(async () => {
            const { data, error } = await updateContactAction(contact.id, formData);
            
            if (error) {
                console.error("Error updating contact:", error);
                toast.error(t('toast.errorTitle'), { description: error.message });
            } else if (data) {
                toast.success(t('toast.successTitle'), { description: t('toast.updateSuccess') });
                setContact(data);
                setIsEditing(false);
            }
        });
    };

    const handleDelete = () => {
        startTransition(async () => {
            const res = await deleteContactAction(contact.id);
            if (!res.success) {
                toast.error(t('toast.errorTitle'), { description: res.message });
            } else {
                toast.success(t('toast.successTitle'), { description: t('toast.deleteSuccess') });
                router.push('/crm/contactes');
                router.refresh(); 
            }
        });
    };

    const handleCancelEdit = () => {
        setContact(initialContact);
        setIsEditing(false);
        formRef.current?.reset();
    };

    return {
        contact,
        isEditing,
        isPending,
        formRef,
        handleSaveChanges,
        handleDelete,
        handleCancelEdit,
        setIsEditing,
    };
}

// =================== FILE: src/app/[locale]/(app)/crm/contactes/_components/ContactCard.tsx ===================

"use client";

import React from 'react';
// Framer Motion per a animacions fluides.
import { motion } from 'framer-motion';
// Icones de Lucide React.
import { User, Building, Mail, Phone} from 'lucide-react';
// Hook de traduccions.
import { useTranslations } from 'next-intl';

// ğŸ‘‡ PAS 1: Importem la definiciÃ³ de la nostra base de dades
import { type Database } from '@/types/supabase';
// ğŸ‘‡ PAS 2: Importem la constant des de la seva nova llar a /config
import { CONTACT_STATUS_MAP } from '@/config/contacts';

// ğŸ‘‡ PAS 3: Definim el tipus 'Contact' a partir de l'esquema de la base de dades
type Contact = Database['public']['Tables']['contacts']['Row'];

// Definim les propietats (props) que el nostre component espera rebre.
interface ContactCardProps {
    contact: Contact; // L'objecte amb totes les dades d'un contacte.
    onClick: () => void; // Una funciÃ³ que s'executarÃ  quan es faci clic a la targeta.
}

/**
 * @summary Aquest Ã©s un component presentacional reutilitzable i internacionalitzat.
 * La seva Ãºnica responsabilitat Ã©s mostrar les dades d'un contacte en un format de targeta visual.
 * Rep tota la lÃ²gica i les dades del seu component pare.
 */
const ContactCard: React.FC<ContactCardProps> = ({ contact, onClick }) => {
    // Inicialitzem el hook de traduccions.
    const t = useTranslations('ContactsClient');

    /**
     * @summary FunciÃ³ interna per obtenir el text traduÃ¯t de l'estat a partir del seu codi.
     * @param statusCode El codi de l'estat (ex: 'L', 'P', 'C').
     * @returns El text complet i traduÃ¯t (ex: "Lead", "Cliente", "Proveedor").
     */
    const getStatusLabel = (statusCode?: string | null) => {
        if (!statusCode) return ''; // Si no hi ha estat, no retornem res.
        const statusObject = CONTACT_STATUS_MAP.find(s => s.code === statusCode);
        // Si el trobem, utilitzem la seva 'key' per obtenir la traducciÃ³.
        // Si no, retornem el codi original com a fallback.
        return statusObject ? t(`contactStatuses.${statusObject.key}`) : statusCode;
    };

    return (
        // Utilitzem 'motion.div' de Framer Motion per a animacions.
        <motion.div
            layoutId={`contact-card-${contact.id}`}
            initial={{ opacity: 0, scale: 0.9 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.9 }}
            onClick={onClick}
            className="group glass-effect p-6 rounded-xl hover:border-primary/50 border border-transparent transition-all cursor-pointer flex flex-col justify-between h-full"
        >
            <div className="min-w-0">
                <div className="flex items-start justify-between mb-4">
                    <div className="flex items-center gap-4 min-w-0">
                        <div className="w-12 h-12 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center shrink-0">
                            <User className="w-6 h-6 text-white" />
                        </div>
                        <div className="min-w-0">
                            {/* ğŸ“› Nom â€” Corregit a 'contact.name' per coincidir amb la base de dades */}
                            <h3
                                className="font-bold text-lg text-foreground truncate max-w-[200px] group-hover:max-w-[500px] group-hover:whitespace-normal transition-all duration-300"
                            >
                                {contact.nom} 
                            </h3>
                            {/* Empresa â€” Corregit a 'contact.company' */}
                            <p className="text-sm text-muted-foreground flex items-center gap-1.5 truncate max-w-[200px]">
                                <Building className="w-4 h-4 shrink-0" />
                                <span className="truncate">{contact.empresa || t('noCompany')}</span>
                            </p>
                        </div>
                    </div>
                    {/* ğŸ· Estat â€” Corregit a 'contact.status' */}
                    <span
                        className={`status-badge status-${contact.estat?.toLowerCase()} shrink-0 transition-transform duration-300 group-hover:scale-75 group-hover:opacity-80`}
                    >
                        {getStatusLabel(contact.estat)}
                    </span>
                </div>

                {/* Info de contacte */}
                <div className="space-y-2 text-sm min-w-0">
                    <p className="flex items-center gap-2 text-muted-foreground truncate max-w-[250px]">
                        <Mail className="w-4 h-4 text-primary/70 shrink-0" />
                        <span className="truncate">{contact.email}</span>
                    </p>
                    <p className="flex items-center gap-2 text-muted-foreground truncate max-w-[200px]">
                        <Phone className="w-4 h-4 text-primary/70 shrink-0" />
                        {/* Corregit a 'contact.phone' */}
                        <span className="truncate">{contact.telefon || t('notSpecified')}</span>
                    </p>
                </div>
            </div>
        </motion.div>
    );
}

export default ContactCard;

// =================== FILE: src/app/[locale]/(app)/crm/contactes/_components/ContactDialog.tsx ===================

"use client";

import React, { useState, useEffect, useTransition } from 'react';
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger, DialogFooter, DialogClose } from "@/components/ui/dialog";
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Loader2, Lock } from 'lucide-react'; // âœ… Eliminat 'Link' de lucide-react
import Link from 'next/link'; // âœ… Afegit 'Link' de next/link per a la navegaciÃ³
import { createContactAction } from '../actions';
import { toast } from 'sonner';
import { useTranslations } from 'next-intl';
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { CONTACT_STATUS_MAP } from '@/config/contacts';

// Props que el nostre diÃ leg acceptarÃ 
interface ContactDialogProps {
    trigger: React.ReactNode; 
    initialData?: {
        nom?: string | null;
        email?: string | null;
    };
    onContactSaved?: (newContact: unknown) => void;
    isLimitReached?: boolean;
    limitError?: string;
}

export function ContactDialog({ trigger, initialData, onContactSaved, isLimitReached, limitError }: ContactDialogProps) {
    const t = useTranslations('ContactsClient');
    const t_billing = useTranslations('Billing'); // âœ… Afegit per a les traduccions de l'alerta
    const [isOpen, setIsOpen] = useState(false);
    const [isPending, startTransition] = useTransition();
    const formRef = React.useRef<HTMLFormElement>(null);

    useEffect(() => {
        if (isOpen) {
            formRef.current?.reset();
        }
    }, [isOpen]);

    const handleFormAction = (formData: FormData) => {
        startTransition(async () => {
            const result = await createContactAction(formData);
            if (result.error) {
                toast.error(t('toastErrorTitle'), { description: result.error.message });
            } else if (result.data) {
                toast.success(t('toastSuccessTitle'), { description: t('toastSuccessDescription') });
                setIsOpen(false);
                onContactSaved?.(result.data); 
            }
        });
    };

    return (
        <Dialog open={isOpen} onOpenChange={setIsOpen}>
            <DialogTrigger asChild>{trigger}</DialogTrigger>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>{t('dialogTitle')}</DialogTitle>
                    <DialogDescription>{t('dialogDescription')}</DialogDescription>
                </DialogHeader>
                
                {/* Bloc d'Alerta */}
                {isLimitReached && (
                    <Alert variant="destructive" className="mt-2">
                        <Lock className="h-4 w-4" />
                        <AlertTitle>{t_billing('limitReachedTitle')}</AlertTitle>
                        <AlertDescription>
                            {limitError || t_billing('limitReachedDefault')}
                            <Button asChild size="sm" variant="link" className="p-0 h-auto ml-1">
                                <Link href="/settings/billing">{t_billing('upgradePlan')}</Link>
                            </Button>
                        </AlertDescription>
                    </Alert>
                )}
                
                <form ref={formRef} action={handleFormAction} className="space-y-4 pt-4">
                    <Input name="nom" placeholder={t('namePlaceholder')} required defaultValue={initialData?.nom ?? ''} />
                    <Input name="empresa" placeholder={t('companyPlaceholder')} />
                    <Input name="email" type="email" placeholder={t('emailPlaceholder')} required defaultValue={initialData?.email ?? ''} />
                    <Input name="telefon" placeholder={t('phonePlaceholder')} />
                    <Input name="valor" type="number" placeholder={t('valuePlaceholder')} defaultValue={0} />
                    <Select name="estat" defaultValue="Lead">
                        <SelectTrigger><SelectValue /></SelectTrigger>
                        <SelectContent>
                            {CONTACT_STATUS_MAP.map(status => (
                                <SelectItem key={status.code} value={status.code}>
                                    {t(`contactStatuses.${status.key}`)}
                                </SelectItem>
                            ))}
                        </SelectContent>
                    </Select>
                    <DialogFooter>
                        <DialogClose asChild><Button type="button" variant="ghost">{t('cancelButton')}</Button></DialogClose>
                        
                        {/* âœ… SOLUCIÃ“ 1: Canviat 'form.formState.isSubmitting' per 'isPending' */}
                        <Button type="submit" disabled={isPending || isLimitReached}>
                            {isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                            {isPending ? t('savingButton') : t('saveButton')}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

// =================== FILE: src/app/[locale]/(app)/crm/contactes/_components/contacts-client.tsx ===================

// @/app/[locale]/(app)/crm/contactes/_components/ContactsClient.tsx
"use client";

import React, { useState, useMemo, useTransition } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { motion, AnimatePresence } from 'framer-motion';
import { useTranslations } from 'next-intl';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
// âœ… 1. Importem Tooltip i una icona de bloqueig
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import { Plus, Search, LayoutGrid, List, FilePlus2, Upload, Download, Lock } from 'lucide-react';
import { toast } from 'sonner';

import { Database } from '@/types/supabase';
import { type ContactWithOpportunities } from './ContactsData';
import { CONTACT_STATUS_MAP } from '@/config/contacts';
// âœ… 2. Importem el tipus del nostre resultat de lÃ­mit
import { type UsageCheckResult } from '@/lib/subscription/subscription';

import { useContactFilters } from '../_hooks/useContactFilters';

import { ContactDialog } from './ContactDialog';
import ContactCard from './ContactCard';
import ContactTable from './ContactTable';
import ExcelDropdownButton, { DropdownOption } from '@/app/[locale]/(app)/excel/ExcelDropdownButton';
import { exportToExcel, importFromExcel } from '@/app/[locale]/(app)/excel/actions';

type Contact = Database['public']['Tables']['contacts']['Row'];

interface ContactsClientProps {
    initialContacts: ContactWithOpportunities[];
    totalPages: number;
    currentPage: number;
    initialViewMode: 'cards' | 'list';
    limitStatus: UsageCheckResult; // âœ… 3. Afegim la nova prop
}

export function ContactsClient({
    initialContacts,
    totalPages,
    currentPage,
    initialViewMode,
    limitStatus // âœ… 4. Rebem la prop
}: ContactsClientProps) {
    const t = useTranslations('ContactsClient');
    const t2 = useTranslations('excel');
    // âœ… 5. Afegim traduccions de Billing per als missatges de lÃ­mit
    const t_billing = useTranslations('Billing');
    const router = useRouter();
    const searchParams = useSearchParams();
    const [isExporting, startTransition] = useTransition();

    const { sortBy, statusFilter, viewMode, handleFilterChange } = useContactFilters(initialViewMode);

    const [contacts, setContacts] = useState<ContactWithOpportunities[]>(initialContacts);
    const [searchTerm, setSearchTerm] = useState(searchParams.get('q') || '');

    // âœ… 6. Calculem si s'ha assolit el lÃ­mit
    const isLimitReached = !limitStatus.allowed;

    const filteredContacts = useMemo(() => contacts.filter(c =>
        (c.nom?.toLowerCase() || '').includes(searchTerm.toLowerCase()) ||
        (c.empresa?.toLowerCase() || '').includes(searchTerm.toLowerCase()) ||
        (c.email?.toLowerCase() || '').includes(searchTerm.toLowerCase())
    ), [contacts, searchTerm]);

    const handleContactClick = (contact: ContactWithOpportunities) => {
        router.push(`/crm/contactes/${contact.id}`);
    };

    const excelOptions: DropdownOption[] = [
        { value: 'create', label: t2('contacts.create'), icon: FilePlus2 },
        { value: 'load', label: t2('contacts.load'), icon: Upload },
        { value: 'download', label: t2('contacts.download'), icon: Download },
    ];

    // ... (lÃ²gica de handleExportAndDownload i handleImport) ...
    async function handleExportAndDownload(shouldDownload: boolean) {
        toast.info(t2('contacts.startingexport'));
        try {
            const result = await exportToExcel('contacts', shouldDownload);

            if (result.success && result.fileBuffer) {
                const byteCharacters = atob(result.fileBuffer);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = result.fileName || 'export.xlsx';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                toast.success(t2('successexport'));
            } else {
                toast.error(t2('errorexport'), { description: result.message });
            }
        } catch (error) {
            toast.error(t2('unexpectederror'), { description: (error as Error).message });
            console.error(error);
        }
    }

    function handleImport() {
        // âœ… 7. Afegim la comprovaciÃ³ de lÃ­mit ABANS de pujar l'Excel
        if (isLimitReached) {
            toast.error(t_billing('limitReachedTitle'), {
                description: limitStatus.error || t_billing('limitReachedDefault')
            });
            return;
        }

        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx, .xls';

        input.onchange = async (e) => {
            const file = (e.target as HTMLInputElement).files?.[0];
            if (!file) {
                toast.error(t2('nofileselected'));
                return;
            }

            toast.info(t2('processingfile'));

            const formData = new FormData();
            formData.append('file', file);

            startTransition(async () => {
                try {
                    // La Server Action 'importFromExcel' tambÃ© hauria de tenir
                    // la validaciÃ³ de lÃ­mits per a cada fila que importa.
                    const result = await importFromExcel('contacts', formData);

                    if (result.success) {
                        toast.success(result.message);
                        // AquÃ­ haurÃ­em de refrescar les dades per veure els nous contactes
                        // i possiblement el nou estat del lÃ­mit.
                        router.refresh();
                    } else {
                        toast.error(t2('errorloadingdata'), { description: result.message });
                    }
                } catch (error) {
                    toast.error(t2('unexpectederrorloadingfile'), { description: (error as Error).message });
                }
            });
        };

        input.click();
    }

    const handleExcelAction = (option: DropdownOption) => {
        switch (option.value) {
            case 'download':
                startTransition(() => handleExportAndDownload(true));
                break;
            case 'create':
                startTransition(() => handleExportAndDownload(false));
                break;
            case 'load':
                handleImport(); // Aquesta funciÃ³ ara tÃ© la comprovaciÃ³ de lÃ­mit
                break;
            default:
                break;
        }
    };

    return (
        <motion.div initial={{ opacity: 0, y: -20 }} animate={{ opacity: 1, y: 0 }} className="h-full flex flex-col">
            {/* CAPÃ‡ALERA */}
            {/* CAPÃ‡ALERA RESPONSIVE */}
            <div className="flex flex-col gap-3 sm:gap-4 mb-6">
                {/* TÃ­tol */}
                <h1 className="text-2xl sm:text-3xl font-bold text-balance">{t('title')}</h1>

                {/* Controls */}
                <div className="flex flex-wrap gap-2 w-full items-center">
                    {/* ğŸ” Cercador */}
                    <div className="relative flex-grow min-w-[160px]">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground" />
                        <Input
                            placeholder={t('searchPlaceholder')}
                            className="pl-9 w-full"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                    </div>

                    {/* ğŸ”½ Ordenar */}
                    <Select value={sortBy} onValueChange={(value) => handleFilterChange('sort', value)}>
                        <SelectTrigger className="w-full sm:w-[160px]">
                            <SelectValue placeholder={t('filters.sortBy')} />
                        </SelectTrigger>
                        <SelectContent>
                            <SelectItem value="newest">{t('filters.newest')}</SelectItem>
                            <SelectItem value="oldest">{t('filters.oldest')}</SelectItem>
                        </SelectContent>
                    </Select>

                    {/* ğŸ“Š Estat */}
                    <Select value={statusFilter} onValueChange={(value) => handleFilterChange('status', value)}>
                        <SelectTrigger className="w-full sm:w-[160px]">
                            <SelectValue placeholder={t('filters.status')} />
                        </SelectTrigger>
                        <SelectContent>
                            <SelectItem value="all">{t('filters.allStatuses')}</SelectItem>
                            {CONTACT_STATUS_MAP.map(status => (
                                <SelectItem key={status.code} value={status.code}>
                                    {t(`contactStatuses.${status.key}`)}
                                </SelectItem>
                            ))}
                        </SelectContent>
                    </Select>

                    {/* ğŸ‘ï¸ Modes de vista (icones) */}
                    <div className="flex items-center gap-1 bg-muted rounded-lg p-1">
                        <Button
                            variant={viewMode === 'cards' ? 'secondary' : 'ghost'}
                            size="icon"
                            onClick={() => handleFilterChange('view', 'cards')}
                        >
                            <LayoutGrid className="w-4 h-4" />
                        </Button>
                        <Button
                            variant={viewMode === 'list' ? 'secondary' : 'ghost'}
                            size="icon"
                            onClick={() => handleFilterChange('view', 'list')}
                        >
                            <List className="w-4 h-4" />
                        </Button>
                    </div>

                    {/* ğŸ§¾ Excel Dropdown */}
                    <ExcelDropdownButton
                        options={excelOptions}
                        onSelect={handleExcelAction}
                        disabled={isExporting}
                    />

                    {/* â• Nou contacte (amb lÃ­mit) */}
                    <TooltipProvider>
                        <Tooltip>
                            <TooltipTrigger asChild>
                                <span tabIndex={isLimitReached ? 0 : -1}>
                                    <ContactDialog
                                        trigger={
                                            <Button className="flex-shrink-0 w-full sm:w-auto" disabled={isLimitReached}>
                                                {isLimitReached ? (
                                                    <Lock className="w-4 h-4 mr-1" />
                                                ) : (
                                                    <Plus className="w-4 h-4 mr-1" />
                                                )}
                                                <span className="hidden md:inline">{t('newContactButton')}</span>
                                            </Button>
                                        }
                                        onContactSaved={(newContact) => {
                                            setContacts(prev => [
                                                { ...(newContact as Contact), opportunities: [] },
                                                ...prev
                                            ]);
                                            router.refresh();
                                        }}
                                        isLimitReached={isLimitReached}
                                        limitError={limitStatus.error}
                                    />
                                </span>
                            </TooltipTrigger>

                            {isLimitReached && (
                                <TooltipContent className="max-w-xs p-3 shadow-lg rounded-lg border-2 border-yellow-400 bg-yellow-50">
                                    <div className="flex flex-col gap-2">
                                        <div className="flex items-center gap-2">
                                            <Lock className="w-4 h-4 text-yellow-900" />
                                            <h3 className="font-semibold">{t_billing('limitReachedTitle')}</h3>
                                        </div>
                                        <p className="text-sm text-muted-foreground">
                                            {limitStatus.error || t_billing('limitReachedDefault')}
                                        </p>
                                        <Button asChild size="sm" className="mt-1 w-full">
                                            <Link href="/settings/billing">{t_billing('upgradePlan')}</Link>
                                        </Button>
                                    </div>
                                </TooltipContent>
                            )}
                        </Tooltip>
                    </TooltipProvider>
                </div>
            </div>


            {/* LLISTA DE CONTACTES */}
            <div className="flex-1 overflow-y-auto -mr-4 pr-4">
                <AnimatePresence mode="wait">
                    <motion.div key={viewMode} initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}>
                        {filteredContacts.length > 0 ? (
                            viewMode === 'cards' ? (
                                <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
                                    {filteredContacts.map(contact => (
                                        <ContactCard key={contact.id} contact={contact} onClick={() => handleContactClick(contact)} />
                                    ))}
                                </div>
                            ) : (<ContactTable contacts={filteredContacts} onRowClick={handleContactClick} />)
                        ) : (<div className="text-center py-16"><p>{t('noContactsFound')}</p></div>)}
                    </motion.div>
                </AnimatePresence>
            </div>

            {/* PAGINACIÃ“ */}
            {totalPages > 1 && (
                <div className="flex justify-center items-center gap-2 md:gap-4 mt-8 flex-shrink-0">
                    <Button asChild disabled={currentPage <= 1} size="sm" className="px-3">
                        <Link href={`/crm/contactes?page=${currentPage - 1}`}>
                            <span className="hidden md:inline">{t('pagination.previous')}</span>
                            <span className="md:hidden">â†</span>
                        </Link>
                    </Button>
                    <span className="text-sm text-muted-foreground">
                        {t('pagination.page', { currentPage, totalPages })}
                    </span>
                    <Button asChild disabled={currentPage >= totalPages} size="sm" className="px-3">
                        <Link href={`/crm/contactes?page=${currentPage + 1}`}>
                            <span className="hidden md:inline">{t('pagination.next')}</span>
                            <span className="md:hidden">â†’</span>
                        </Link>
                    </Button>
                </div>
            )}
        </motion.div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/contactes/_components/ContactsData.tsx ===================

import { ContactsClient } from './contacts-client';
import { validatePageSession } from "@/lib/supabase/session";
// âœ… 1. Importem el nou servei i el tipus
import { getPaginatedContacts, type ContactWithOpportunities } from '@/lib/services/crm/contacts/contacts.service';
import { getUsageLimitStatus, type UsageCheckResult } from "@/lib/subscription/subscription";
// âœ… 2. Exportem el tipus per al client
export type { ContactWithOpportunities };

interface ContactsDataProps {
    page: string;
    sortBy: string;
    status: string;
    searchTerm: string;
    viewMode: 'cards' | 'list';
}
// âœ… 2. Definim un estat de lÃ­mit per defecte per si la sessiÃ³ falla
const defaultLimit: UsageCheckResult = { allowed: false, current: 0, max: 0, error: "SessiÃ³ no vÃ lida" };

export async function ContactsData({ page, sortBy, status, searchTerm, viewMode }: ContactsDataProps) {

    const session = await validatePageSession(); // â¬…ï¸ 2. Cridem la funciÃ³ correcta

    if ('error' in session) {
        console.error(
            "ContactsData: SessiÃ³ invÃ lida.",
            typeof session.error === "object" && session.error !== null && "message" in session.error
                ? (session.error as { message?: string }).message
                : session.error
        );
        return <ContactsClient initialContacts={[]} totalPages={0} currentPage={1} initialViewMode={viewMode} limitStatus={defaultLimit} // Passa l'estat per defecte 
        />;
    }

    // âœ… 3. Ara aquesta desestructuraciÃ³ Ã©s segura i estÃ  correctament tipada
    // TypeScript sap que 'session' contÃ© 'supabase' i 'activeTeamId'
    // (TambÃ© he eliminat el '_' extra al final, que semblava un error de sintaxi)
    const { supabase, activeTeamId } = session;


    // âœ… 2. Executem tot en paralÂ·lel
    const [limitCheck, { data, error }] = await Promise.all([
        getUsageLimitStatus('maxContacts'), // <-- MÃ©s net i reutilitzable
        getPaginatedContacts(supabase, {
            teamId: activeTeamId,
            page: Number(page) || 1,
            sortBy,
            status,
            searchTerm
        })
    ]);

    // âœ… 5. Gestionem l'error
    if (error || !data) {
        console.error("Error en obtenir contactes (Component):", error);
        return <ContactsClient
            initialContacts={[]}
            totalPages={0}
            currentPage={1}
            initialViewMode={viewMode}
            limitStatus={limitCheck} // Passa l'estat del lÃ­mit fins i tot si falla la llista
        />;
    }

    return (
        <ContactsClient
            initialContacts={data.contacts}
            totalPages={data.totalPages}
            currentPage={data.currentPage}
            initialViewMode={viewMode}
            limitStatus={limitCheck} // âœ… 5. Passem l'estat del lÃ­mit al client
        />
    );
}

// =================== FILE: src/app/[locale]/(app)/crm/contactes/_components/ContactsSkeleton.tsx ===================

"use client";



// Aquest component mostra un esquelet genÃ¨ric per a la pÃ gina de contactes.
export function ContactsSkeleton() {
  return (
    <div className="h-full flex flex-col animate-pulse">
      {/* Esquelet de la capÃ§alera */}
      <div className="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6 flex-shrink-0">
        <div className="h-9 w-48 bg-gray-700/50 rounded-md"></div>
        <div className="flex items-center gap-2">
          <div className="h-10 w-48 bg-gray-700/50 rounded-md"></div>
          <div className="h-10 w-20 bg-gray-700/50 rounded-md"></div>
          <div className="h-10 w-32 bg-gray-700/50 rounded-md"></div>
        </div>
      </div>

      {/* Esquelet de les targetes de contacte */}
      <div className="flex-1 overflow-y-auto">
        <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6">
          {[...Array(8)].map((_, i) => (
            <div key={i} className="h-56 bg-white/5 rounded-xl"></div>
          ))}
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/crm/contactes/_components/ContactTable.tsx ===================

// /app/[locale]/(app)/crm/contactes/_components/ContactTable.tsx (VersiÃ³ Refactoritzada)
"use client";

import React from 'react';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { User, MoreVertical } from 'lucide-react';
import { useTranslations } from 'next-intl';
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from "@/components/ui/dropdown-menu";
import { Button } from '@/components/ui/button';

// âœ… 1. Importem el tipus enriquit des del seu origen correcte.
import { type ContactWithOpportunities } from './ContactsData';
// âœ… 2. Importem la constant des de /config, la seva nova ubicaciÃ³ centralitzada.
import { CONTACT_STATUS_MAP } from '@/config/contacts';

// Definim les propietats que el component espera.
interface ContactTableProps {
    // âœ… 3. Actualitzem la prop per a utilitzar el nou tipus.
    contacts: ContactWithOpportunities[]; 
    onRowClick: (contact: ContactWithOpportunities) => void;
}

/**
 * Component presentacional que renderitza una llista de contactes en format de taula.
 */
const ContactTable: React.FC<ContactTableProps> = ({ contacts, onRowClick }) => {
    const t = useTranslations('ContactsClient');

    const getStatusLabel = (statusCode?: string | null) => { // âœ… Tipat com a string | null per seguretat
        if (!statusCode) return '';
        const statusObject = CONTACT_STATUS_MAP.find(s => s.code === statusCode);
        return statusObject ? t(`contactStatuses.${statusObject.key}`) : statusCode;
    };

    return (
        <div className="glass-card rounded-xl overflow-x-auto">
            <Table>
                <TableHeader>
                    <TableRow className="border-b-border hover:bg-muted/50">
                        <TableHead className="w-[250px]">{t('table.name')}</TableHead>
                        <TableHead>{t('table.status')}</TableHead>
                        <TableHead>{t('table.email')}</TableHead> {/* Aquesta ja era responsive, la deixem */}
                        <TableHead className="hidden md:table-cell">{t('table.phone')}</TableHead>
                        <TableHead className="hidden lg:table-cell">{t('table.company')}</TableHead>
                        <TableHead className="sm:hidden text-right">...</TableHead>
                    </TableRow>
                </TableHeader>
                <TableBody>
                    {contacts.map((contact) => (
                        // âœ… Les propietats com 'id', 'nom', 'estat', etc., continuen funcionant
                        // perquÃ¨ el nostre nou tipus Ã©s un superconjunt del tipus base.
                        <TableRow key={contact.id} onClick={() => onRowClick(contact)} className="border-b-border hover:bg-muted/50 cursor-pointer">
                            <TableCell className="font-medium flex items-center gap-3">
                                <div className="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center shrink-0">
                                    <User className="w-5 h-5 text-white" />
                                </div>
                                {contact.nom}
                            </TableCell>
                            <TableCell>
                                <span className={`status-badge status-${contact.estat?.toLowerCase()} shrink-0`}>
                                    {getStatusLabel(contact.estat)}
                                </span>
                            </TableCell>
                            <TableCell className="text-muted-foreground hidden sm:table-cell">{contact.email}</TableCell>
                            <TableCell className="text-muted-foreground hidden md:table-cell">{contact.telefon || '-'}</TableCell>
                            <TableCell className="hidden lg:table-cell text-muted-foreground">{contact.empresa || '-'}</TableCell>
                            <TableCell className="sm:hidden text-right">
                                <DropdownMenu>
                                    <DropdownMenuTrigger asChild>
                                        <Button variant="ghost" size="icon" onClick={(e) => e.stopPropagation()}>
                                            <MoreVertical className="w-4 h-4" />
                                        </Button>
                                    </DropdownMenuTrigger>
                                    <DropdownMenuContent>
                                        <DropdownMenuItem onSelect={() => onRowClick(contact)}>
                                            {t('table.viewDetails')}
                                        </DropdownMenuItem>
                                    </DropdownMenuContent>
                                </DropdownMenu>
                            </TableCell>
                        </TableRow>
                    ))}
                </TableBody>
            </Table>
        </div>
    );
};

export default ContactTable;

// =================== FILE: src/app/[locale]/(app)/crm/contactes/_hooks/useContactFilters.ts ===================

// @/hooks/useContactFilters.ts
"use client";

import { useState, useTransition } from 'react';
import { usePathname, useRouter, useSearchParams } from 'next/navigation';

type ViewMode = 'cards' | 'list';
type FilterType = 'sort' | 'status' | 'view';

/**
 * Hook personalitzat per gestionar els filtres de la pÃ gina de contactes.
 * Encapsula la lÃ²gica per llegir i escriure a la URL (search params),
 * gestionant l'estat de cÃ rrega i les actualitzacions optimistes de la UI.
 * @param initialViewMode - El mode de vista per defecte ('cards' o 'list').
 */
export function useContactFilters(initialViewMode: ViewMode) {
    const router = useRouter();
    const pathname = usePathname();
    const searchParams = useSearchParams();
    const [isPending, startTransition] = useTransition();

    // Llegeix els valors actuals de la URL o estableix valors per defecte.
    const sortBy = searchParams.get('sort') || 'newest';
    const statusFilter = searchParams.get('status') || 'all';

    // Utilitzem un estat local per al 'viewMode' per tenir una resposta
    // visual immediata, abans que la URL s'actualitzi.
    const [viewMode, setViewMode] = useState<ViewMode>(initialViewMode);

    /**
     * Actualitza un parÃ metre de la URL i navega a la nova ruta.
     * @param type - El tipus de filtre a canviar ('sort', 'status', 'view').
     * @param value - El nou valor per al filtre.
     */
    const handleFilterChange = (type: FilterType, value: string) => {
        const current = new URLSearchParams(Array.from(searchParams.entries()));
        current.set(type, value);

        // Si el filtre no Ã©s un canvi de vista, reiniciem a la primera pÃ gina.
        if (type !== 'view') {
            current.set('page', '1');
        }

        const search = current.toString();
        const query = search ? `?${search}` : "";

        // ActualitzaciÃ³ optimista per a una millor experiÃ¨ncia d'usuari.
        if (type === 'view') {
            setViewMode(value as ViewMode);
        }
        
        // Utilitzem startTransition per evitar bloquejar la UI durant la navegaciÃ³.
        startTransition(() => {
            router.push(`${pathname}${query}`);
        });
    };

    return {
        isPending,
        sortBy,
        statusFilter,
        viewMode,
        handleFilterChange,
    };
}

// =================== FILE: src/app/[locale]/(app)/crm/general/page.tsx ===================

// /app/[locale]/(app)/crm/general/page.tsx (Corregit)

import { Suspense } from 'react';
import type { Metadata } from 'next';
import { CrmDataDashboard } from './_components/CrmData';
import { CrmSkeleton } from './_components/CrmSkeleton';
// â›” Ja no s'importa cap tipus des d'aquÃ­.

export const metadata: Metadata = {
    title: 'CRM General | Ribot',
};

export default function CrmGeneralPage() {
    return (
        <Suspense fallback={<CrmSkeleton />}>
            <CrmDataDashboard />
        </Suspense>
    );
}

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/charts/CampaignPerformanceChart.tsx ===================

// src/app/[locale]/(app)/crm/general/_components/charts/CampaignPerformanceChart.tsx (CORREGIT)

"use client";

import { FC } from 'react';
import { RadialBarChart, RadialBar, Legend, ResponsiveContainer, Tooltip} from 'recharts';
import { type CampaignPerformanceData } from '../CrmData';
import { useTranslations } from 'next-intl';

interface CampaignPerformanceChartProps {
    data: CampaignPerformanceData[];
}

export const CampaignPerformanceChart: FC<CampaignPerformanceChartProps> = ({ data }) => {
    const t = useTranslations('CrmGeneralPage');

    if (!data || data.length === 0) {
        return <p className="text-muted-foreground text-sm text-center p-4">{t('noCampaignData')}</p>;
    }

    return (
        <div className="h-72 w-full">
            <ResponsiveContainer width="100%" height="100%">
                <RadialBarChart 
                    cx="50%" 
                    cy="50%" 
                    innerRadius="10%" 
                    outerRadius="80%" 
                    barSize={10} 
                    data={data}
                    startAngle={180}
                    endAngle={0}
                >
                    <RadialBar
                        background
                        dataKey="roi"
                    />
                    <Legend 
                        iconSize={10} 
                        layout="vertical" 
                        verticalAlign="middle" 
                        wrapperStyle={{ top: '50%', right: 0, transform: 'translate(0, -50%)', lineHeight: '24px' }}
                    />
                    <Tooltip
                        contentStyle={{
                            background: "hsl(var(--card))",
                            borderColor: "hsl(var(--border))",
                            borderRadius: "var(--radius)",
                        }}
                         formatter={(value: number) => [`${value.toFixed(1)}%`, 'ROI']}
                    />
                </RadialBarChart>
            </ResponsiveContainer>
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/charts/DailySummaryWidget.tsx ===================

// src/app/[locale]/(app)/crm/general/_components/charts/DailySummaryWidget.tsx

"use client";

import { FC, ElementType } from 'react';
import { CheckCircle, Mail, FileText, Calendar } from 'lucide-react';
import { useTranslations } from 'next-intl';
import { type DailySummaryData } from '../CrmData';
import { Separator } from '@/components/ui/separator';

interface DailySummaryWidgetProps {
    data: DailySummaryData;
}

const SummaryItem: FC<{ icon: ElementType, label: string, value: number, color: string }> = ({ icon: Icon, label, value, color }) => (
    <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
            <Icon className={`h-5 w-5 ${color}`} />
            <p className="text-sm font-medium text-muted-foreground">{label}</p>
        </div>
        <p className="text-lg font-bold">{value}</p>
    </div>
);


export const DailySummaryWidget: FC<DailySummaryWidgetProps> = ({ data }) => {
    const t = useTranslations('CrmGeneralPage');

    return (
        <div className="p-2 space-y-4">
            <SummaryItem icon={CheckCircle} label={t('dailySummary.tasks')} value={data.tasks_completed} color="text-green-500" />
            <Separator />
            <SummaryItem icon={Mail} label={t('dailySummary.emails')} value={data.emails_sent} color="text-blue-500" />
            <Separator />
            <SummaryItem icon={FileText} label={t('dailySummary.quotes')} value={data.quotes_sent} color="text-purple-500" />
             <Separator />
            <SummaryItem icon={Calendar} label={t('dailySummary.meetings')} value={data.meetings_held} color="text-orange-500" />
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/charts/LeadSourceChart.tsx ===================

// src/app/[locale]/(app)/crm/general/_components/charts/LeadSourceChart.tsx

"use client";

import { FC } from 'react';
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } from 'recharts';

interface LeadSourceChartProps {
    data: { source: string; count: number }[];
}

const COLORS = ['#3b82f6', '#8b5cf6', '#f59e0b', '#10b981', '#ef4444'];

export const LeadSourceChart: FC<LeadSourceChartProps> = ({ data }) => {
    return (
        <div className="h-64 w-full">
            <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                    <Tooltip
                        contentStyle={{
                            background: "hsl(var(--card))",
                            borderColor: "hsl(var(--border))",
                            borderRadius: "var(--radius)",
                        }}
                    />
                     <Legend iconType="circle" />
                    <Pie data={data} dataKey="count" nameKey="source" cx="50%" cy="50%" outerRadius={80} fill="#8884d8" labelLine={false}>
                        {data.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                        ))}
                    </Pie>
                </PieChart>
            </ResponsiveContainer>
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/charts/LeadSourceConversionChart.tsx ===================

// src/app/[locale]/(app)/crm/general/_components/charts/LeadSourceConversionChart.tsx

"use client";

import { FC } from 'react';
import { useTheme } from 'next-themes';
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid, LabelList } from 'recharts';
import { type LeadConversionData } from '../CrmData';
import { useTranslations } from 'next-intl';

interface LeadSourceConversionChartProps {
    data: LeadConversionData[];
}

export const LeadSourceConversionChart: FC<LeadSourceConversionChartProps> = ({ data }) => {
    const { theme } = useTheme();
    const t = useTranslations('CrmGeneralPage');
    const gridColor = theme === 'dark' ? '#374151' : '#e5e7eb';
    const textColor = theme === 'dark' ? '#9ca3af' : '#6b7280';
    
    if (!data || data.length === 0) {
        return <p className="text-muted-foreground text-sm text-center p-4">{t('noLeadSourceData')}</p>;
    }
    
    // Ordenem les dades per taxa de conversiÃ³ per a una millor visualitzaciÃ³
    const sortedData = [...data].sort((a, b) => b.conversion_rate - a.conversion_rate);

    return (
        <div className="h-72 w-full">
            <ResponsiveContainer width="100%" height="100%">
                <BarChart data={sortedData} margin={{ top: 20, right: 30, left: -10, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke={gridColor} vertical={false} />
                    <XAxis 
                        dataKey="source" 
                        stroke={textColor} 
                        fontSize={12}
                        tickLine={false}
                        axisLine={false}
                    />
                    <YAxis 
                        stroke={textColor} 
                        fontSize={12}
                        tickFormatter={(value) => `${value}%`}
                    />
                    <Tooltip
                        cursor={{ fill: 'hsl(var(--muted))' }}
                        contentStyle={{
                            background: "hsl(var(--card))",
                            borderColor: "hsl(var(--border))",
                            borderRadius: "var(--radius)",
                        }}
                        formatter={(value: number, name, props) => [`${value.toFixed(1)}%`, `Taxa de conversiÃ³ (${props.payload.total} leads)`]}
                    />
                    <Bar dataKey="conversion_rate" fill="#8b5cf6" radius={[4, 4, 0, 0]}>
                        <LabelList
                            dataKey="conversion_rate"
                            position="top"
                            fill={textColor}
                            fontSize={12}
                            content={({ value, x, y }) =>
                                typeof value === 'number'
                                    ? (
                                        <text
                                            fill={textColor}
                                            fontSize={12}
                                            x={x}
                                            y={y}
                                            textAnchor="middle"
                                            dy={-6}
                                        >{`${value.toFixed(0)}%`}</text>
                                    )
                                    : null
                            }
                        />
                    </Bar>
                </BarChart>
            </ResponsiveContainer>
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/charts/OpportunityAgingChart.tsx ===================

// src/app/[locale]/(app)/crm/general/_components/charts/OpportunityAgingChart.tsx

"use client";

import { FC } from 'react';
import { useTheme } from 'next-themes';
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid, LabelList, Cell } from 'recharts';
import { type OpportunityAgingData } from '../CrmData';
import { useTranslations } from 'next-intl';

interface OpportunityAgingChartProps {
    data: OpportunityAgingData[];
}

// Un color mÃ©s fosc si el valor Ã©s alt (indica un problema)
const getBarColor = (days: number) => {
    if (days > 30) return '#ef4444'; // red-500
    if (days > 15) return '#f97316'; // orange-500
    return '#3b82f6'; // blue-500
};

export const OpportunityAgingChart: FC<OpportunityAgingChartProps> = ({ data }) => {
    const { theme } = useTheme();
    const t = useTranslations('CrmGeneralPage');
    const gridColor = theme === 'dark' ? '#374151' : '#e5e7eb';
    const textColor = theme === 'dark' ? '#9ca3af' : '#6b7280';

    if (!data || data.length === 0) {
        return <p className="text-muted-foreground text-sm text-center p-4">{t('noOpportunityData')}</p>;
    }

    return (
        <div className="h-72 w-full">
            <ResponsiveContainer width="100%" height="100%">
                <BarChart layout="vertical" data={data} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke={gridColor} horizontal={false} />
                    <XAxis type="number" stroke={textColor} fontSize={12} />
                    <YAxis 
                        type="category" 
                        dataKey="stage_name" 
                        stroke={textColor} 
                        fontSize={12}
                        tickLine={false}
                        axisLine={false}
                        width={100}
                        tickFormatter={(value) => value.length > 15 ? `${value.substring(0, 15)}...` : value}
                    />
                    <Tooltip
                        cursor={{ fill: 'hsl(var(--muted))' }}
                        contentStyle={{
                            background: "hsl(var(--card))",
                            borderColor: "hsl(var(--border))",
                            borderRadius: "var(--radius)",
                        }}
                        formatter={(value: number) => [`${value} dies`, 'Antiguitat mitjana']}
                    />
                    <Bar dataKey="avg_days" background={{ fill: 'hsl(var(--muted))' }} radius={[0, 4, 4, 0]}>
                        {data.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={getBarColor(entry.avg_days)} />
                        ))}
                        <LabelList
                            dataKey="avg_days"
                            position="right"
                            fill={textColor}
                            fontSize={12}
                            formatter={(label) =>
                                typeof label === 'number' ? `${label}d` : label
                            }
                        />
                    </Bar>
                </BarChart>
            </ResponsiveContainer>
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/charts/RevenueForecastChart.tsx ===================

// src/app/[locale]/(app)/crm/general/_components/charts/RevenueForecastChart.tsx

"use client";

import { FC } from 'react';
// import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Legend } from 'recharts';

interface RevenueForecastChartProps {
    data: {
        monthlyForecast: number;
        currentMonthRevenue: number;
    };
}

export const RevenueForecastChart: FC<RevenueForecastChartProps> = ({ data }) => {
    const forecast = data.monthlyForecast || 0;
    const current = data.currentMonthRevenue || 0;
    const percentage = forecast > 0 ? (current / forecast) * 100 : 0;

    return (
        <div className="h-64 w-full p-4 flex flex-col justify-center">
            <div className="text-center mb-4">
                <p className="text-sm text-muted-foreground">Objectiu de FacturaciÃ³ Mensual</p>
                <p className="text-3xl font-bold">â‚¬{forecast.toLocaleString('es-ES', { maximumFractionDigits: 0 })}</p>
            </div>
            <div className="w-full bg-muted rounded-full h-4 mb-2">
                <div 
                    className="bg-blue-500 h-4 rounded-full" 
                    style={{ width: `${Math.min(percentage, 100)}%` }}
                />
            </div>
            <div className="flex justify-between text-sm font-medium">
                <span className="text-blue-500">Facturat: â‚¬{current.toLocaleString('es-ES')}</span>
                <span className="text-muted-foreground">{percentage.toFixed(1)}%</span>
            </div>
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/charts/SalesActivityChart.tsx ===================

// src/app/[locale]/(app)/crm/general/_components/charts/SalesActivityChart.tsx

"use client";

import { FC } from 'react';
import { useTheme } from 'next-themes';
import { BarChart, Bar, XAxis, Tooltip, ResponsiveContainer, CartesianGrid } from 'recharts';

// Dades de mostra per al grÃ fic. En un futur, aixÃ² hauria de venir de la teva base de dades.
const sampleData = [
  { day: 'Dill', Trucades: 4, Emails: 8, Reunions: 2 },
  { day: 'Dim', Trucades: 3, Emails: 5, Reunions: 1 },
  { day: 'Dix', Trucades: 6, Emails: 12, Reunions: 3 },
  { day: 'Dij', Trucades: 5, Emails: 9, Reunions: 4 },
  { day: 'Div', Trucades: 8, Emails: 15, Reunions: 2 },
  { day: 'Dis', Trucades: 1, Emails: 3, Reunions: 0 },
  { day: 'Diu', Trucades: 0, Emails: 1, Reunions: 0 },
];

export const SalesActivityChart: FC = () => {
    const { theme } = useTheme();
    const gridColor = theme === 'dark' ? '#374151' : '#e5e7eb';
    const textColor = theme === 'dark' ? '#9ca3af' : '#6b7280';

    return (
        <div className="h-56 w-full">
            <ResponsiveContainer width="100%" height="100%">
                <BarChart data={sampleData} margin={{ top: 20, right: 10, left: -20, bottom: 5 }}>
                    <CartesianGrid strokeDasharray="3 3" stroke={gridColor} vertical={false} />
                    <XAxis 
                        dataKey="day" 
                        fontSize={12} 
                        tickLine={false} 
                        axisLine={false}
                        stroke={textColor}
                    />
                    <Tooltip
                        cursor={{ fill: 'hsl(var(--muted))' }}
                        contentStyle={{
                            background: "hsl(var(--card))",
                            borderColor: "hsl(var(--border))",
                            borderRadius: "var(--radius)",
                            boxShadow: "var(--shadow-md)",
                        }}
                    />
                    <Bar dataKey="Emails" stackId="a" fill="#3b82f6" name="Emails" radius={[4, 4, 0, 0]} />
                    <Bar dataKey="Trucades" stackId="a" fill="#8b5cf6" name="Trucades" />
                    <Bar dataKey="Reunions" stackId="a" fill="#f59e0b" name="Reunions" />
                </BarChart>
            </ResponsiveContainer>
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/charts/SalesFunnelChart.tsx ===================

// src/app/[locale]/(app)/crm/general/_components/charts/SalesFunnelChart.tsx

"use client";

import { FC } from 'react';
import { FunnelChart, Funnel, Tooltip, ResponsiveContainer, LabelList } from 'recharts';

interface SalesFunnelChartProps {
    data: {
        leads: number;
        quoted: number;
        clients: number;
    };
    t: (key: string) => string;
}

export const SalesFunnelChart: FC<SalesFunnelChartProps> = ({ data, t }) => {
    const funnelData = [
        { name: t('funnel.leads'), value: data.leads, fill: '#8b5cf6' },
        { name: t('funnel.quoted'), value: data.quoted, fill: '#3b82f6' },
        { name: t('funnel.clients'), value: data.clients, fill: '#22c55e' },
    ];

    return (
        <div className="h-64 w-full">
            <ResponsiveContainer width="100%" height="100%">
                <FunnelChart>
                    <Tooltip
                        contentStyle={{
                            background: "hsl(var(--card))",
                            borderColor: "hsl(var(--border))",
                            borderRadius: "var(--radius)",
                        }}
                    />
                    <Funnel dataKey="value" data={funnelData} isAnimationActive>
                         <LabelList position="right" fill="hsl(var(--foreground))" stroke="none" dataKey="name" />
                         <LabelList position="center" fill="#fff" stroke="none" dataKey="value" fontSize={14} fontWeight="bold" />
                    </Funnel>
                </FunnelChart>
            </ResponsiveContainer>
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/ComposeEmailDialog.tsx ===================

// /app/[locale]/(app)/crm/general/_components/ComposeEmailDialog.tsx (CORREGIT)

"use client";

import React, { useState, useEffect, useTransition } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import { Loader2, Send } from 'lucide-react';
import { toast } from 'sonner';
import { sendEmailWithGmailAction } from '@/app/[locale]/(app)/crm/general/_components/send-email-action';
import { useTranslations } from 'next-intl';

// âœ… 1. Definim el tipus correcte per a les dades inicials.
interface ComposeEmailDialogProps {
    open: boolean;
    onOpenChange: (open: boolean) => void;
    // 'contactId' ara Ã©s un 'number', alineat amb la resta de l'aplicaciÃ³.
    initialData: { contactId: number; to: string; subject: string; body: string } | null;
    onEmailSent: () => void;
}

const ComposeEmailDialog: React.FC<ComposeEmailDialogProps> = ({ open, onOpenChange, initialData, onEmailSent }) => {
    const t = useTranslations('ComposeEmailDialog');

    // âœ… 2. L'estat intern ara gestiona 'contactId' com a 'number | null'.
    const [contactId, setContactId] = useState<number | null>(null);
    const [to, setTo] = useState('');
    const [subject, setSubject] = useState('');
    const [body, setBody] = useState('');
    const [isPending, startTransition] = useTransition();

    useEffect(() => {
        if (initialData) {
            setContactId(initialData.contactId ?? null);
            setTo(initialData.to || '');
            setSubject(initialData.subject || '');
            setBody(initialData.body || '');
        }
    }, [initialData]);

    const handleSend = () => {
        startTransition(async () => {
            // âœ… 3. ValidaciÃ³ actualitzada per a un ID numÃ¨ric.
            if (!contactId) {
                toast.error('Error', { description: "Falta l'ID del contacte." });
                return;
            }
            // âœ… 4. Cridem a la Server Action amb el 'contactId' numÃ¨ric.
            const result = await sendEmailWithGmailAction(String(contactId), subject, body);
            if (result.success) {
                toast.success('Ãˆxit!', { description: result.message });
                onEmailSent();
                onOpenChange(false);
            } else {
                toast.error('Error', { description: result.message });
            }
        });
    };

    return (
        <Dialog open={open} onOpenChange={onOpenChange}>
            <DialogContent className="glass-effect">
                <DialogHeader>
                    <DialogTitle>{t('dialogTitle')}</DialogTitle>
                </DialogHeader>
                <div className="py-4 space-y-4">
                    <div className="space-y-2">
                        <Label htmlFor="to">{t('toLabel')}</Label>
                        <Input id="to" value={to} readOnly disabled />
                    </div>
                    <div className="space-y-2">
                        <Label htmlFor="subject">{t('subjectLabel')}</Label>
                        <Input id="subject" value={subject} onChange={(e) => setSubject(e.target.value)} />
                    </div>
                    <div className="space-y-2">
                        <Label htmlFor="body">{t('messageLabel')}</Label>
                        <Textarea id="body" value={body} onChange={(e) => setBody(e.target.value)} rows={10} />
                    </div>
                </div>
                <DialogFooter>
                    <Button variant="ghost" onClick={() => onOpenChange(false)}>{t('cancelButton')}</Button>
                    <Button onClick={handleSend} disabled={isPending}>
                        {isPending ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Send className="w-4 h-4 mr-2" />}
                        {t('sendButton')}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
};

export default ComposeEmailDialog;

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/crm-client.tsx ===================

// src/app/[locale]/(app)/crm/general/_components/crm-client.tsx

"use client";

import React, { useState } from 'react';
import { motion } from 'framer-motion';
import { AlertTriangle, BarChart3, PieChart, Zap, Clock, Megaphone, ListTodo, Crown, ShieldAlert, } from 'lucide-react';
import { useTranslations, useLocale } from 'next-intl';
import { type CrmData, type UnreadActivity, type ComposeEmailData } from './CrmData';
import { ModuleCard } from '@/components/shared/ModuleCard';
import { KpiGrid } from './kip/KipGrid';
import { SalesFunnelChart } from './charts/SalesFunnelChart'; // Corregit
import { LeadSourceChart } from './charts/LeadSourceChart';   // Corregit
import { ActivityList } from './lists/ActivityList'; // Ajusta la ruta si cal
import { TopClientsList } from './lists/TopClientsList'; // Ajusta la ruta si cal
import { HealthRadarList } from './lists/HealtRadarList'; // Ajusta la ruta si cal
import ComposeEmailDialog from './ComposeEmailDialog';
import { OpportunityAgingChart } from './charts/OpportunityAgingChart';
import { LeadSourceConversionChart } from './charts/LeadSourceConversionChart';
import { CampaignPerformanceChart } from './charts/CampaignPerformanceChart';
import { DailySummaryWidget } from './charts/DailySummaryWidget';

export function CrmClient({ initialData }: { initialData: CrmData | null }) {
    const t = useTranslations('CrmGeneralPage');
    const locale = useLocale();
    const [data, setData] = useState(initialData);
    const [composeState, setComposeState] = useState<{ open: boolean; initialData: ComposeEmailData | null; }>({ open: false, initialData: null });

    if (!data) {
        return (
            <div className="flex flex-col justify-center items-center h-full text-center">
                <AlertTriangle className="w-12 h-12 text-red-500 mb-4" />
                <h2 className="text-xl font-bold">{t('toast.errorTitle')}</h2>
                <p className="text-muted-foreground">{t('toast.fetchError')}</p>
            </div>
        );
    }

    const handleMarkAsRead = async (activityId: number) => {
        if (!data) return;
        setData({ ...data, unreadActivities: data.unreadActivities.filter(a => a.id !== activityId) });
        // TODO: Cridar Server Action per actualitzar la BD
    };

    const handleReply = (activity: UnreadActivity) => {
        const date = activity.created_at ? new Date(activity.created_at).toLocaleDateString(locale) : '';
        const content = activity.content.replace(/\n/g, '\n> ');
        const quotedBody = t('replyBody', { date, content });

        setComposeState({
            open: true,
            initialData: {
                contactId: activity.contact_id ?? 0,
                to: activity.contacts?.email ?? '',
                subject: `Re: ${activity.content.substring(0, 30)}...`,
                body: quotedBody
            }
        });
    };



   return (
        <>
            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.5 }} className="space-y-6">
                
                {/* --- FILA SUPERIOR: KPIs (3/4) + Alertes (1/4) --- */}
                <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div className="lg:col-span-3">
                        <ModuleCard title={t('keyMetrics')} icon={Zap} variant="info" defaultOpen={true}>
                            <KpiGrid stats={data.stats} />
                        </ModuleCard>
                    </div>
                    <div className="lg:col-span-1">
                         <ModuleCard title={t('recentAlerts', { count: data.unreadActivities.length })} icon={AlertTriangle} variant="activity">
                            <ActivityList activities={data.unreadActivities} onMarkAsRead={handleMarkAsRead} onReply={handleReply} />
                        </ModuleCard>
                    </div>
                </div>
                
                {/* --- GRAELLA INFERIOR: 2 Files de 4 Targetes Adaptatives --- */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    {/* Fila 1 */}
                    <ModuleCard title={t('dailySummary.title')} icon={ListTodo} variant="agenda">
                        <DailySummaryWidget data={data.dailySummary} />
                    </ModuleCard>
                    <ModuleCard title={t('opportunityAgingByStage')} icon={Clock} variant="warning">
                        <OpportunityAgingChart data={data.opportunityAging} />
                    </ModuleCard>
                    <ModuleCard title={t('campaignPerformance.title')} icon={Megaphone} variant="inbox">
                        <CampaignPerformanceChart data={data.campaignPerformance} />
                    </ModuleCard>
                    <ModuleCard title={t('topClients')} icon={Crown} variant="success">
                         <TopClientsList topClients={data.topClients} />
                    </ModuleCard>

                    {/* Fila 2 */}
                     <ModuleCard title={t('customerLifecycle')} icon={BarChart3} variant="activity">
                        <SalesFunnelChart data={data.funnel} t={t} />
                    </ModuleCard>
                    <ModuleCard title={t('leadConversionBySource')} icon={PieChart} variant="radar">
                        <LeadSourceConversionChart data={data.leadConversion} />
                    </ModuleCard>
                    <ModuleCard title={t('leadSourceAnalysis')} icon={PieChart}>
                        {data.leadSources && data.leadSources.length > 0 ? (
                            <LeadSourceChart data={data.leadSources} />
                        ) : (
                            <p className="text-muted-foreground text-sm text-center p-4">{t('noLeadSourceData')}</p>
                        )}
                    </ModuleCard>
                    <ModuleCard title={t('healthRadar')} icon={ShieldAlert} variant="radar">
                        <HealthRadarList coldContacts={data.coldContacts} />
                    </ModuleCard>
                </div>

            </motion.div>

            <ComposeEmailDialog
                open={composeState.open}
                onOpenChange={(isOpen) => setComposeState({ open: isOpen, initialData: isOpen ? composeState.initialData : null })}
                initialData={composeState.initialData}
                onEmailSent={() => {}}
            />
        </>
    );
}

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/CrmData.tsx ===================

import { validatePageSession } from "@/lib/supabase/session";
import { CrmClient } from './crm-client';

// âœ… 1. Importem el servei i els tipus principals
import { getCrmDashboardData } from '@/lib/services/crm.service';

// âœ… 2. Re-exportem els tipus que el CrmClient pugui necessitar
export type { 
  CrmData,
  CampaignPerformanceData,
  DailySummaryData,
  KpiData,
  UnreadActivity,
  TopClient,
  ColdContact,
  LeadSource,
  OpportunityAgingData,
  LeadConversionData
} from '@/lib/services/crm.service';

// El tipus ComposeEmailData es mantÃ© si es fa servir localment
export type ComposeEmailData = { contactId: number; to: string; subject: string; body: string; };


export async function CrmDataDashboard() {
  // âœ… 3. ValidaciÃ³ de sessiÃ³
  const session = await validatePageSession();
  if ('error' in session) {
    const errorMessage = typeof session.error === 'object' && session.error && 'message' in session.error
      ? (session.error as { message?: string }).message
      : String(session.error);
    console.error("CrmData: SessiÃ³ invÃ lida.", errorMessage);
    return <CrmClient initialData={null} />;
  }
  const { supabase, activeTeamId } = session;

  // âœ… 4. UNA SOLA CRIDA. Tota la complexitat estÃ  encapsulada.
  const { data, error } = await getCrmDashboardData(supabase, activeTeamId);

  if (error || !data) {
    console.error("Error en carregar CrmData (Component):", error);
    return <CrmClient initialData={null} />;
  }
  
  // âœ… 5. Passem les dades processades al client
  return <CrmClient initialData={data} />;
}

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/CrmSkeleton.tsx ===================

"use client";

import React, { FC } from 'react';

/**
 * @summary Mostra un esquelet de cÃ rrega per a la pÃ gina del Dashboard General del CRM.
 * Aquesta UI es mostra a l'instant grÃ cies a React Suspense.
 */
export const CrmSkeleton: FC = () => (
    <div className="space-y-8 animate-pulse">
        {/* Esquelet per a les targetes de KPI */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {[...Array(4)].map((_, i) => (
                <div key={i} className="h-[150px] bg-white/5 rounded-2xl"></div>
            ))}
        </div>
        
        {/* Esquelet per a l'embut de vendes i les llistes */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div className="lg:col-span-2 h-[300px] bg-white/5 rounded-2xl"></div>
            <div className="space-y-8">
                <div className="h-[150px] bg-white/5 rounded-2xl"></div>
                <div className="h-[150px] bg-white/5 rounded-2xl"></div>
            </div>
        </div>

        {/* Esquelet per a les EstadÃ­stiques Clau */}
        <div className="h-[200px] bg-white/5 rounded-2xl"></div>
    </div>
);

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/kip/KipGrid.tsx ===================

// src/app/[locale]/(app)/crm/general/_components/KpiGrid.tsx

"use client";

import { FC } from 'react';
import { useTranslations } from 'next-intl';
import { type CrmData } from '../CrmData';
import { KpiItem } from './KpiItem'; // <-- Aquest import ara funcionarÃ 

interface KpiGridProps {
  stats: CrmData['stats'];
}

export const KpiGrid: FC<KpiGridProps> = ({ stats }) => {
  const t = useTranslations('CrmGeneralPage');

  return (
    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-6 pt-2">
      <KpiItem 
        title={t('stats.totalContacts')} 
        value={stats.totalContacts.value} 
        trend={stats.totalContacts.trend}
        tooltip={t('tooltips.totalContacts')}
      />
      <KpiItem 
        title={t('stats.newContactsThisMonth')} 
        value={stats.newContactsThisMonth.value} 
        trend={stats.newContactsThisMonth.trend}
        tooltip={t('tooltips.newContactsThisMonth')}
      />
      <KpiItem 
        title={t('stats.conversionRate')} 
        value={stats.conversionRate.value} 
        trend={stats.conversionRate.trend}
        tooltip={t('tooltips.conversionRate')}
      />
      <KpiItem 
        title={t('stats.pipelineValue')} 
        value={stats.pipelineValue.value} 
        trend={stats.pipelineValue.trend}
        tooltip={t('tooltips.pipelineValue')}
      />
      <KpiItem 
        title={t('stats.salesVelocity')} 
        value={stats.salesVelocity.value} 
        trend={stats.salesVelocity.trend}
        tooltip={t('tooltips.salesVelocity')}
      />
      <KpiItem 
        title={t('stats.avgConversionTimeDays')} 
        value={stats.avgConversionTimeDays.value} 
        trend={stats.avgConversionTimeDays.trend}
        tooltip={t('tooltips.avgConversionTimeDays')}
      />
      <KpiItem 
        title={t('stats.opportunities')} 
        value={stats.opportunities.value} 
        trend={stats.opportunities.trend}
        tooltip={t('tooltips.opportunities')}
      />
       <KpiItem 
        title={t('stats.avgRevenuePerClient')} 
        value={stats.avgRevenuePerClient.value} 
        trend={stats.avgRevenuePerClient.trend}
        tooltip={t('tooltips.avgRevenuePerClient')}
      />
    </div>
  );
};

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/kip/KpiItem.tsx ===================

// src/app/[locale]/(app)/crm/general/_components/KpiItem.tsx

"use client";

import { FC } from 'react';
import { ArrowUpRight, ArrowDownRight, Minus } from 'lucide-react';
import { cn } from '@/lib/utils/utils';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";

const TrendIndicator: FC<{ trend: number }> = ({ trend }) => {
    const isPositive = trend > 0;
    const isNeutral = trend === 0 || isNaN(trend);
    const color = isNeutral ? 'text-gray-500' : isPositive ? 'text-green-500' : 'text-red-500';
    const Icon = isNeutral ? Minus : isPositive ? ArrowUpRight : ArrowDownRight;
    const formattedTrend = isNeutral ? '-' : `${isPositive ? '+' : ''}${trend.toFixed(1)}%`;

    return (
        <span className={cn("flex items-center text-xs font-semibold", color)}>
            <Icon className="h-3 w-3 mr-0.5" />
            {formattedTrend}
        </span>
    );
};

interface KpiItemProps {
  title: string;
  value: string | number;
  trend: number;
  tooltip: string;
}

export const KpiItem: FC<KpiItemProps> = ({ title, value, trend, tooltip }) => (
    <TooltipProvider delayDuration={150}>
        <Tooltip>
            <TooltipTrigger asChild>
                <div className="group cursor-pointer">
                    <p className="text-xs text-muted-foreground truncate">{title}</p>
                    <div className="flex items-baseline gap-2 mt-1">
                        <p className="text-xl lg:text-2xl font-bold text-foreground">{value}</p>
                        <TrendIndicator trend={trend} />
                    </div>
                </div>
            </TooltipTrigger>
            <TooltipContent>
                <p>{tooltip}</p>
            </TooltipContent>
        </Tooltip>
    </TooltipProvider>
);

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/lists/ActivityList.tsx ===================

// src/app/[locale]/(app)/crm/general/_components/lists/ActivityList.tsx

"use client";

import { FC } from 'react';
import { useRouter } from 'next/navigation';
import { useLocale, useTranslations } from 'next-intl';
import { formatDistanceToNow } from 'date-fns';
import { ca, es, enUS } from 'date-fns/locale';
import { AlertTriangle, Mail, Check } from 'lucide-react';
import { ModuleCard } from '@/components/shared/ModuleCard';
import { Button } from '@/components/ui/button';
import { type UnreadActivity } from '../CrmData';

// Component intern per a cada Ã­tem
const ActivityItem: FC<{ activity: UnreadActivity; onMarkAsRead: (id: number) => void; onReply: (activity: UnreadActivity) => void; }> = ({ activity, onMarkAsRead, onReply }) => {
    const locale = useLocale();
    const router = useRouter();
    const dateLocale = { ca, es, en: enUS }[locale] || ca;

    const handleClick = () => {
        onMarkAsRead(activity.id);
        if (activity.contact_id) {
            router.push(`/${locale}/crm/contactes/${activity.contact_id}`);
        }
    };

    return (
        <div className="flex items-center gap-4 p-2 -mx-2 rounded-lg hover:bg-muted dark:hover:bg-muted/50 transition-colors group">
            <div className="p-2.5 rounded-lg bg-yellow-500/10 dark:bg-yellow-800/20">
                <AlertTriangle className="w-5 h-5 text-yellow-600 dark:text-yellow-400" />
            </div>
            <div className="flex-1 min-w-0 cursor-pointer" onClick={handleClick}>
                <p className="font-semibold truncate text-foreground">{activity.type} - <span className="font-normal text-muted-foreground">{activity.contacts?.nom}</span></p>
                <p className="text-sm text-muted-foreground truncate italic">"{activity.content}"</p>
            </div>
            <div className="text-xs text-muted-foreground shrink-0 hidden sm:block">
                {activity.created_at ? formatDistanceToNow(new Date(activity.created_at), { addSuffix: true, locale: dateLocale }) : ''}
            </div>
            <div className="flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                <Button variant="ghost" size="icon" className="w-8 h-8 rounded-full" onClick={(e) => { e.stopPropagation(); onReply(activity); }}>
                    <Mail className="w-4 h-4 text-blue-500" />
                </Button>
                <Button variant="ghost" size="icon" className="w-8 h-8 rounded-full" onClick={(e) => { e.stopPropagation(); onMarkAsRead(activity.id); }}>
                    <Check className="w-4 h-4 text-green-500" />
                </Button>
            </div>
        </div>
    );
};


interface ActivityListProps {
    activities: UnreadActivity[];
    onMarkAsRead: (id: number) => void;
    onReply: (activity: UnreadActivity) => void;
}

export const ActivityList: FC<ActivityListProps> = ({ activities, onMarkAsRead, onReply }) => {
    const t = useTranslations('CrmGeneralPage');

    if (!activities || activities.length === 0) {
        return null; // No renderitzem res si no hi ha activitats
    }

    return (
        <ModuleCard title={t('recentAlerts', { count: activities.length })} icon={AlertTriangle} variant="activity">
            <div className="space-y-1 max-h-72 overflow-y-auto pr-2 -mr-4">
                {activities.map(activity => (
                    <ActivityItem key={activity.id} activity={activity} onMarkAsRead={onMarkAsRead} onReply={onReply} />
                ))}
            </div>
        </ModuleCard>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/lists/HealtRadarList.tsx ===================

// src/app/[locale]/(app)/crm/general/_components/lists/HealthRadarList.tsx

"use client";

import { FC } from 'react';
import { useLocale, useTranslations } from 'next-intl';
import { AlertTriangle} from 'lucide-react';
import { ListItem } from './ListItem';
import { type ColdContact } from '../CrmData';

interface HealthRadarListProps {
    coldContacts: ColdContact[];
}

export const HealthRadarList: FC<HealthRadarListProps> = ({ coldContacts }) => {
    const t = useTranslations('CrmGeneralPage');
    const locale = useLocale();

    return (
            <div className="space-y-1">
                {coldContacts.length > 0 ? (
                    coldContacts.map(contact => (
                        <ListItem 
                            key={contact.id} 
                            href={`/${locale}/crm/contactes/${contact.id}`} 
                            icon={AlertTriangle} 
                            iconColor="text-yellow-500" 
                            title={contact.nom || ''} 
                            subtitle={contact.last_interaction_at ? t('lastContactOn', { date: new Date(contact.last_interaction_at).toLocaleDateString(locale) }) : ''} 
                        />
                    ))
                ) : (
                    <p className="text-sm text-muted-foreground text-center py-4">{t('allContactsWarm')}</p>
                )}
            </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/lists/ListItem.tsx ===================

"use client";

import React, { FC, ElementType } from 'react';
import Link from 'next/link';
import { cn } from '@/lib/utils/utils';

interface ListItemProps {
    href: string;
    icon: ElementType;
    iconColor: string;
    title: string;
    subtitle?: string;
    value?: string;
}

export const ListItem: FC<ListItemProps> = ({ href, icon: Icon, iconColor, title, subtitle, value }) => (
    <Link href={href} className="flex items-center gap-4 p-2 -mx-2 rounded-lg hover:bg-muted dark:hover:bg-muted/50 transition-colors">
        <div className={cn("p-2.5 rounded-lg", iconColor.replace('text-', 'bg-') + '/10 dark:' + iconColor.replace('text-', 'bg-') + '/20')}>
            <Icon className={cn("w-5 h-5", iconColor)} />
        </div>
        <div className="flex-1 min-w-0">
            <p className="font-semibold truncate text-foreground">{title}</p>
            {subtitle && <p className="text-xs text-muted-foreground truncate">{subtitle}</p>}
        </div>
        {value && <div className="font-semibold text-right text-foreground">{value}</div>}
    </Link>
);

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/lists/TopClientsList.tsx ===================

// src/app/[locale]/(app)/crm/general/_components/lists/TopClientsList.tsx

"use client";

import { FC } from 'react';
import { useLocale, useTranslations } from 'next-intl';
import { Crown } from 'lucide-react';
import { ListItem } from './ListItem';
import { type TopClient } from '../CrmData';

interface TopClientsListProps {
    topClients: TopClient[];
}

export const TopClientsList: FC<TopClientsListProps> = ({ topClients }) => {
    const t = useTranslations('CrmGeneralPage');
    const locale = useLocale();

    return (
            <div className="space-y-1">
                {topClients.length > 0 ? (
                    topClients.map((client, index) => (
                        <ListItem 
                            key={client.id} 
                            href={`/${locale}/crm/contactes/${client.id}`} 
                            icon={Crown} 
                            iconColor={index === 0 ? 'text-yellow-400' : 'text-gray-400'} 
                            title={client.nom || ''} 
                            value={`â‚¬${(client.total_invoiced).toLocaleString('es-ES')}`} 
                        />
                    ))
                ) : (
                    <p className="text-sm text-muted-foreground text-center py-4">{t('noRevenueData')}</p>
                )}
            </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/general/_components/send-email-action.ts ===================

"use server";

import { validateUserSession } from "@/lib/supabase/session"; // âœ… 1. Importem la nostra funciÃ³ de validaciÃ³

export async function sendEmailWithGmailAction(
  contactId: string,
  subject: string,
  htmlBody: string
): Promise<{ success: boolean; message: string }> {
  
  // âœ… 2. Reutilitzem la validaciÃ³ de sessiÃ³ centralitzada.
  const session = await validateUserSession();
  if ('error' in session) {
    return { success: false, message: session.error.message };
  }
  const { supabase } = session; // Obtenim el client de Supabase ja validat.

  // âœ… 3. La resta de la lÃ²gica es mantÃ© igual, perÃ² ara Ã©s mÃ©s neta.
  const { error } = await supabase.functions.invoke('send-email', {
    body: { contactId, subject, htmlBody },
  });

  if (error) {
    console.error("Error en invocar la funciÃ³ 'send-email':", error);
    return { success: false, message: `Error en enviar el correu: ${error.message}` };
  }

  return { success: true, message: "El correu s'ha enviat correctament." };
}

// =================== FILE: src/app/[locale]/(app)/crm/pipeline/actions.ts ===================

// /app/[locale]/(app)/crm/pipeline/actions.ts
"use server";

import { revalidatePath } from "next/cache";
import { validateUserSession } from "@/lib/supabase/session";

// âœ… 1. Importem el servei d'oportunitats
import * as opportunityService from "@/lib/services/crm/pipeline/opportunities.service";

/**
 * ACCIÃ“: Desa (crea o actualitza) una oportunitat.
 */
export async function saveOpportunityAction(formData: FormData) {
Â  Â  // 1. ValidaciÃ³ de sessiÃ³
Â  Â  const session = await validateUserSession();
Â  Â  if ('error' in session) return { error: session.error };
Â  Â  const { supabase, user, activeTeamId } = session;

Â  Â  try {
        // 2. Cridem al servei
Â  Â  Â  Â  await opportunityService.saveOpportunity(
Â  Â  Â  Â  Â  Â  supabase,
Â  Â  Â  Â  Â  Â  formData,
Â  Â  Â  Â  Â  Â  user.id,
Â  Â  Â  Â  Â  Â  activeTeamId
Â  Â  Â  Â  );

        // 3. Efecte secundari
Â  Â  Â  Â  revalidatePath("/crm/pipeline");
Â  Â  Â  Â  return { success: true };

Â  Â  } catch (error: unknown) {
        // 4. GestiÃ³ d'errors
Â  Â  Â  Â  const message = error instanceof Error ? error.message : "Error desconegut";
Â  Â  Â  Â  return { error: { message } };
Â  Â  }
}
Â 
/**
 * ACCIÃ“: Actualitza l'etapa d'una oportunitat (per Drag-n-Drop).
 */
export async function updateOpportunityStageAction(opportunityId: number, newStage: string) {
Â  Â  // 1. ValidaciÃ³ de sessiÃ³
Â  Â  const session = await validateUserSession();
Â  Â  if ('error' in session) return { error: session.error };
Â  Â  const { supabase, activeTeamId } = session;
Â 
Â  Â  try {
        // 2. Cridem al servei
Â  Â  Â  Â  await opportunityService.updateOpportunityStage(
Â  Â  Â  Â  Â  Â  supabase,
Â  Â  Â  Â  Â  Â  opportunityId,
Â  Â  Â  Â  Â  Â  newStage,
Â  Â  Â  Â  Â  Â  activeTeamId
Â  Â  Â  Â  );
Â 
        // 3. Efecte secundari
Â  Â  Â  Â  revalidatePath("/crm/pipeline");
Â  Â  Â  Â  return { success: true };

Â  Â  } catch (error: unknown) {
        // 4. GestiÃ³ d'errors
Â  Â  Â  Â  const message = error instanceof Error ? error.message : "Error desconegut";
Â  Â  Â  Â  return { error: { message } };
Â  Â  }
}

// =================== FILE: src/app/[locale]/(app)/crm/pipeline/loading.tsx ===================

// /app/[locale]/(app)/crm/pipeline/loading.tsx (Refactoritzat)

import { PipelineSkeleton } from './_components/PipelineSkeleton';
import { createClient } from '@/lib/supabase/server';
// âœ… 1. Importem la definiciÃ³ de la base de dades.
import { type Database } from '@/types/supabase';

// âœ… 2. Definim el tipus Stage a partir de la taula corresponent.
type Stage = Database['public']['Tables']['pipeline_stages']['Row'];

export default async function PipelineLoading() {
    const supabase = createClient();
    
    const { data: stagesData } = await supabase
        .from('pipeline_stages')
        .select('id, name, position');

    // âœ… 3. El cast ara utilitza el tipus correcte.
    const stages = (stagesData as Stage[]) || [];

    return <PipelineSkeleton stages={stages} viewMode="columns" />;
}

// =================== FILE: src/app/[locale]/(app)/crm/pipeline/page.tsx ===================

/**
 * @file src/app/[locale]/(app)/page.tsx (Pipeline Page)
 * @summary Aquest Ã©s el Server Component que carrega les dades inicials (l'esquelet)
 * i les passa al component de client.
 */
import type { Metadata } from 'next';
import { Suspense } from 'react';

// Importem els nous components
import { PipelineData } from './_components/PipelineData'; 
import { PipelineSkeleton } from './_components/PipelineSkeleton';

export const metadata: Metadata = {
  title: 'Pipeline | Ribot',
};
// IMPORTANT: La pÃ gina principal JA NO Ã‰S 'async'
export default function PipelinePage() {
  // Aquest component ara es renderitza a l'instant!
  // No espera cap dada.

  return (
    <Suspense fallback={<PipelineSkeleton stages={[]} viewMode="columns" />}>
      {/* React 'Suspense' intentarÃ  renderitzar <PipelineData />.
        Com que Ã©s un component 'async', se suspendrÃ .
        Mentre estÃ  suspÃ¨s, mostrarÃ  el 'fallback' (el teu Skeleton).
        Quan les dades de PipelineData estiguin llestes, el substituirÃ .
      */}
      <PipelineData />
    </Suspense>
  );
}

// =================== FILE: src/app/[locale]/(app)/crm/pipeline/pipeline-client.tsx ===================

// /app/[locale]/(app)/crm/pipeline/pipeline-client.tsx (Refactoritzat i CORREGIT)
"use client";

import React, { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { DragDropContext } from '@hello-pangea/dnd';
import { useTranslations } from 'next-intl';
import { Plus, LayoutGrid, Rows, Loader2 } from 'lucide-react';
import { Button } from '@/components/ui/button';

// âœ… 1. Importem el tipus 'Row' complet de la base de dades
import { type Database } from '@/types/supabase';
type FullContact = Database['public']['Tables']['contacts']['Row'];

// âœ… 2. Importem els altres tipus
import { type Stage, type OpportunityWithContact } from './_components/PipelineData';
import { usePipeline } from './_hooks/usePipeline';
import { OpportunityDialog } from './_components/OpportunityDialog';
import { ColumnsView } from './_components/ColumnsView';
import { RowsView } from './_components/RowsView';

// â• AFEGIT: Importem el hook per detectar la mida de la pantalla
import { useMediaQuery } from '@/hooks/useMediaQuery';

interface PipelineClientProps {
    initialStages: Stage[];
    // âœ… 3. 'initialContacts' ara utilitza el tipus complet
    initialContacts: FullContact[];
    initialOpportunities: OpportunityWithContact[];
}

export function PipelineClient({ initialStages, initialContacts, initialOpportunities }: PipelineClientProps) {
    const t = useTranslations('PipelinePage');

    const [opportunities, setOpportunities] = useState(initialOpportunities);

    useEffect(() => {
        setOpportunities(initialOpportunities);
    }, [initialOpportunities]);

    const {
        isPending,
        opportunitiesByStage,
        viewMode, // Aquesta Ã©s la vista seleccionada per l'usuari (default: 'columns')
        setViewMode,
        isDialogOpen,
        setIsDialogOpen,
        editingOpportunity,
        onDragEnd,
        handleOpenDialog,
        handleSuccess,
    } = usePipeline({
        initialStages,
        opportunities,
        setOpportunities
    });

    // â• AFEGIT: Detectem si Ã©s mÃ²bil (breakpoint 'md' de Tailwind = 768px)
    // Utilitzem 767px per ser < md
    const isMobile = useMediaQuery("(max-width: 767px)");

    // â— CORREGIT: Decidim quina vista mostrar
    // Si Ã©s mÃ²bil, forcem 'rows'. Si no, respectem la selecciÃ³ de l'usuari.
    const effectiveViewMode = isMobile ? 'rows' : viewMode;

    return (
        <>
            <OpportunityDialog
                open={isDialogOpen}
                onOpenChange={setIsDialogOpen}
                // âœ… 4. Aquesta lÃ­nia ara Ã©s vÃ lida.
                contacts={initialContacts}
                stages={initialStages}
                onSuccess={handleSuccess}
                opportunityToEdit={editingOpportunity}
            />
            <motion.div initial={{ opacity: 0, y: -20 }} animate={{ opacity: 1, y: 0 }} className="h-full flex flex-col">
                <div className="flex justify-between items-center mb-6 flex-shrink-0">
                    <h1 className="text-3xl font-bold">{t('title')}</h1>
                    <div className="flex items-center gap-2">

                        {/* â— CORREGIT: Afegim 'hidden md:flex' per ocultar en mÃ²bil */}
                        <div className="bg-muted p-1 rounded-lg hidden md:flex">
                            <Button variant={viewMode === 'columns' ? 'secondary' : 'ghost'} size="icon" onClick={() => setViewMode('columns')} aria-label={t('columnViewLabel')} disabled={isPending}><LayoutGrid className="w-4 h-4" /></Button>
                            <Button variant={viewMode === 'rows' ? 'secondary' : 'ghost'} size="icon" onClick={() => setViewMode('rows')} aria-label={t('rowViewLabel')} disabled={isPending}><Rows className="w-4 h-4" /></Button>
                        </div>

                        <Button onClick={() => handleOpenDialog()} disabled={isPending}>
                            {isPending ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Plus className="w-4 h-4 mr-2" />}
                            {t('addOpportunity')}
                        </Button>
                    </div>
                </div>

                <DragDropContext onDragEnd={onDragEnd}>

                    {/* â— CORREGIT: Usem 'effectiveViewMode' per decidir el render */}
                    {effectiveViewMode === 'columns' ? (
                        <ColumnsView

                            stages={initialStages}
                            opportunitiesByStage={opportunitiesByStage}
                            onEditOpportunity={(op) => handleOpenDialog(op)}
                            onAddClick={(stage) => handleOpenDialog(undefined, stage)}
                        />
                    ) : (
                        <RowsView
                            stages={initialStages}
                            opportunitiesByStage={opportunitiesByStage}
                            onEditOpportunity={(op) => handleOpenDialog(op)}
                            onAddClick={(stage) => handleOpenDialog(undefined, stage)}
                        />
                    )}
                </DragDropContext>
            </motion.div>
        </>
    );
}

// =================== FILE: src/app/[locale]/(app)/crm/pipeline/_components/ColumnsView.tsx ===================

import React from 'react';
import { type Stage, type OpportunityWithContact } from './PipelineData';
import { StageColumn } from './StageColumn';

interface ColumnsViewProps {
  stages: Stage[];
  opportunitiesByStage: Record<string, OpportunityWithContact[]>;
  onEditOpportunity: (opportunity: OpportunityWithContact) => void;
  onAddClick: (stageName: string) => void;
}

export const ColumnsView: React.FC<ColumnsViewProps> = ({ stages, opportunitiesByStage, onEditOpportunity, onAddClick }) => {
    return (
        //console.log("Renderitzant ColumnsView amb etapes:", stages),
        <div className="flex-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 min-h-0">
            {stages.map(stage => (
                <StageColumn
                    key={stage.id}
                    stage={stage}
                    opportunities={opportunitiesByStage[stage.name] || []}
                    onEditOpportunity={onEditOpportunity}
                    onAddClick={() => onAddClick(stage.name)}
                />
            ))}
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/pipeline/_components/OportunityCard.tsx ===================

// /app/[locale]/(app)/crm/pipeline/_components/OportunityCard.tsx

"use client";

import React from 'react';
import { Draggable } from '@hello-pangea/dnd';
import { cn } from '@/lib/utils/utils';
import { User, Euro, Calendar } from 'lucide-react';
import { useTranslations, useLocale } from 'next-intl';
import { type OpportunityWithContact } from './PipelineData';

interface OpportunityCardProps {
    opportunity: OpportunityWithContact;
    index: number;
}

export const OpportunityCard: React.FC<OpportunityCardProps> = ({ opportunity, index }) => {
    const t = useTranslations('PipelinePage');
    const locale = useLocale();

    return (
        <Draggable draggableId={opportunity.id.toString()} index={index}>
            {(provided, snapshot) => (
                <div
                    ref={provided.innerRef}
                    {...provided.draggableProps}
                    {...provided.dragHandleProps}
                    className={cn(
                        // âœ… Estils Base (Mode Clar): Fons sÃ²lid, ombra lleugera
                        'bg-card p-3 rounded-lg mb-3 border border-border shadow-sm',
                        // âœ… Estils Hover (Mode Clar): Ombra mÃ©s pronunciada, vora accentuada
                        'hover:shadow-md hover:border-primary/30',
                        // âœ… Estils Mode Fosc: Mantenim el fons semi-transparent original
                        'dark:bg-background/80 dark:backdrop-blur-sm dark:border-transparent dark:shadow-none',
                        // âœ… Estils Hover (Mode Fosc)
                        'dark:hover:border-primary/50',
                        // Estils Draggable (Comuns)
                        'border-l-4 transition-all duration-300 cursor-pointer',
                        snapshot.isDragging
                            ? 'border-primary shadow-2xl dark:shadow-primary/20 scale-105' // Ombra mÃ©s forta en dark mode
                            : 'border-transparent' // La vora hover ja estÃ  gestionada
                    )}
                >
                    <h4 className="font-semibold text-foreground mb-2 text-sm">{opportunity.name}</h4>
                    {opportunity.description && (
                        <p className="text-xs text-muted-foreground mb-3 line-clamp-2">{opportunity.description}</p>
                    )}
                    <p className="text-xs text-muted-foreground flex items-center gap-2 mb-2">
                        <User className="w-4 h-4 text-primary/80" /> {opportunity.contacts?.nom || t('noContact')}
                    </p>
                    {/* âœ… Vora inferior adaptada a light/dark */}
                    <div className="flex justify-between items-center mt-3 pt-2 border-t border-border dark:border-white/10 text-xs">
                        {/* âœ… Color verd mÃ©s fosc per a millor contrast en light mode */}
                        <span className="font-semibold text-emerald-600 dark:text-green-400 flex items-center gap-1">
                            <Euro className="w-3 h-3" /> {opportunity.value?.toLocaleString(locale) || '0'}
                        </span>
                        <span className="text-muted-foreground flex items-center gap-1">
                            <Calendar className="w-3 h-3" />{' '}
                            {opportunity.close_date ? new Date(opportunity.close_date).toLocaleDateString(locale, { day: '2-digit', month: '2-digit' }) : '-'}
                        </span>
                    </div>
                </div>
            )}
        </Draggable>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/pipeline/_components/OportunityRowCard.tsx ===================

// /app/[locale]/(app)/crm/pipeline/_components/OportunityRowCard.tsx

import React from 'react';
import { Draggable } from '@hello-pangea/dnd';
import { cn } from '@/lib/utils/utils';
import { User, Euro, Calendar } from 'lucide-react';
import { useTranslations, useLocale } from 'next-intl';
import { type OpportunityWithContact } from './PipelineData';

interface OpportunityRowCardProps {
    op: OpportunityWithContact;
    index: number;
    onEdit: (op: OpportunityWithContact) => void;
}

export const OpportunityRowCard: React.FC<OpportunityRowCardProps> = ({ op, index, onEdit }) => {
    const t = useTranslations('PipelinePage');
    const locale = useLocale();

    return (
        <Draggable draggableId={op.id.toString()} index={index}>
            {(provided, snapshot) => (
                <div
                    ref={provided.innerRef}
                    {...provided.draggableProps}
                    {...provided.dragHandleProps}
                    onDoubleClick={() => onEdit(op)}
                    className={cn(
                        // âœ… Estils Base: bg-card ja funciona bÃ© en ambdÃ³s modes. Afegim vora subtil per a light.
                        "grid grid-cols-2 md:grid-cols-5 gap-4 px-4 py-3 items-center rounded-lg bg-card shadow-sm border border-border dark:border-transparent", // Afegit border i ajustat dark
                        // âœ… Estils Hover: Lleuger canvi de fons amb 'muted' per a light mode
                        "hover:shadow-lg hover:bg-muted/50 dark:hover:bg-muted/20 hover:scale-[1.01]", // Ajustat hover per a light/dark
                        // Estils Draggable (Comuns)
                        "transition-all cursor-pointer",
                        snapshot.isDragging ? "border-l-4 border-primary shadow-xl scale-[1.03]" : "border-l-4 border-transparent" // Augmentat lleugerament scale en drag
                    )}
                >
                    <div className="font-semibold text-base text-foreground col-span-2">{op.name}</div>
                    <div className="flex items-center text-sm text-foreground">
                        <User className="w-4 h-4 mr-2 text-primary" />
                        {op.contacts?.nom || t('noContact')}
                    </div>
                    {/* âœ… Color verd mÃ©s fosc per a mode clar */}
                    <div className="flex items-center text-sm font-medium text-emerald-700 dark:text-green-500">
                        <Euro className="w-4 h-4 mr-2" />
                        {op.value?.toLocaleString(locale) || "0"} â‚¬
                    </div>
                    <div className="flex justify-end items-center text-xs text-muted-foreground gap-2">
                        <Calendar className="w-3 h-3" />
                        {op.close_date ? new Date(op.close_date).toLocaleDateString(locale, { day: "2-digit", month: "2-digit" }) : "-"}
                    </div>
                </div>
            )}
        </Draggable>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/pipeline/_components/OpportunityDialog.tsx ===================

// /app/[locale]/(app)/crm/pipeline/_components/OpportunityDialog.tsx (Refactoritzat)
import React from 'react';
import { useLocale, useTranslations } from 'next-intl';
import { ca, es, enUS } from "date-fns/locale";
import { format } from "date-fns";

// âœ… 1. Importem el tipus 'Row' complet de la base de dades
import { type Database } from '@/types/supabase';
type Contact = Database['public']['Tables']['contacts']['Row'];

// âœ… 2. Renomenem la importaciÃ³ local que creava conflicte
import { type Stage, type OpportunityWithContact } from './PipelineData';
import { PIPELINE_STAGES_MAP } from '@/config/pipeline'; 

import { Button } from '@/components/ui/button';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { Calendar } from "@/components/ui/calendar";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Calendar as CalendarIcon, Loader2 } from 'lucide-react';
import { cn } from "@/lib/utils/utils";
import { useOpportunityForm } from '../_hooks/useOpportunityForm';
import { ContactSelector } from '@/components/features/contactes/ContactSelector';

interface Props {
    open: boolean;
    onOpenChange: (open: boolean) => void;
    contacts: Contact[]; // âœ… 3. Ara 'contacts' utilitza el tipus complet
    stages: Stage[];
    onSuccess: () => void;
    opportunityToEdit: Partial<OpportunityWithContact> | null;
}

export function OpportunityDialog({ open, onOpenChange, contacts, stages, onSuccess, opportunityToEdit }: Props) {
    const t = useTranslations('OpportunityDialog');
    const statePipline = useTranslations('PipelinePage');
    const locale = useLocale();
    
    const { isPending, selectedContactId, setSelectedContactId, closeDate, setCloseDate, handleSubmit } = useOpportunityForm({
        opportunityToEdit,
        onSuccess,
        onOpenChange
    });

    const dateLocale = { ca, es, en: enUS }[locale] || ca;

    return (
        <Dialog open={open} onOpenChange={onOpenChange}>
            <DialogContent>
                <DialogHeader><DialogTitle>{opportunityToEdit?.id ? t('editTitle') : t('newTitle')}</DialogTitle></DialogHeader>
                <form action={handleSubmit} className="grid gap-4 pt-4">
                    <Input name="name" placeholder={t('namePlaceholder')} defaultValue={opportunityToEdit?.name || ''} required />
                    
                    {/* âœ… 4. Aquesta lÃ­nia ara Ã©s vÃ lida perquÃ¨ els tipus coincideixen */}
                    <ContactSelector contacts={contacts} selectedId={selectedContactId} onSelect={setSelectedContactId} />
                    
                    <Select name="stage_name" defaultValue={opportunityToEdit?.stage_name || stages[0]?.name}>
                        <SelectTrigger><SelectValue placeholder={t('selectStagePlaceholder')} /></SelectTrigger>
                        <SelectContent>
                            {PIPELINE_STAGES_MAP.map(stage => (
                                <SelectItem key={stage.key} value={stage.name}>
                                    {statePipline(`stageNames.${stage.key}`)}
                                </SelectItem>
                            ))}
                        </SelectContent>
                    </Select>
                    
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <Label htmlFor="value">{t('valueLabel')}</Label>
                            <Input id="value" name="value" type="number" step="0.01" placeholder="0.00" defaultValue={opportunityToEdit?.value || ''} />
                        </div>
                        <div>
                            <Label>{t('closeDateLabel')}</Label>
                            <Popover>
                                <PopoverTrigger asChild>
                                    <Button variant="outline" className={cn("w-full justify-start text-left font-normal", !closeDate && "text-muted-foreground")}>
                                        <CalendarIcon className="mr-2 h-4 w-4" />
                                        {closeDate ? format(closeDate, "PPP", { locale: dateLocale }) : <span>{t('pickDate')}</span>}
                                    </Button>
                                </PopoverTrigger>
                                <PopoverContent className="w-auto p-0"><Calendar mode="single" selected={closeDate} onSelect={setCloseDate} /></PopoverContent>
                            </Popover>
                        </div>
                    </div>
                    
                    <Textarea name="description" placeholder={t('descriptionPlaceholder')} defaultValue={opportunityToEdit?.description || ''} />
                    
                    <DialogFooter className="pt-4">
                        <Button type="button" variant="ghost" onClick={() => onOpenChange(false)}>{t('cancelButton')}</Button>
                        <Button type="submit" disabled={isPending}>
                            {isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />} {t('saveButton')}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

// =================== FILE: src/app/[locale]/(app)/crm/pipeline/_components/PipelineData.tsx ===================

// /app/[locale]/(app)/crm/pipeline/_components/PipelineData.tsx
import { PipelineClient } from '../pipeline-client';
import { validatePageSession } from "@/lib/supabase/session";

// âœ… 1. Importem el tipus 'Row' complet de la base de dades
// âœ… 2. Importem el tipus COMPLET des de la nostra font de la veritat (db.ts)
import type { Contact } from '@/types/db';

import { 
Â  getPipelineData, 
Â  type Stage, 
Â  type OpportunityWithContact 
} from '@/lib/services/crm/pipeline/pipline.service';

// âœ… 3. Exportem els tipus correctes. 
export type { Stage, OpportunityWithContact, Contact }; // Exportem el 'Contact' complet

export async function PipelineData() {
Â  const { supabase, activeTeamId } = await validatePageSession();
Â  
Â  const { data, error } = await getPipelineData(supabase, activeTeamId);

Â  if (error || !data) {
Â  Â  console.error("Error en carregar les dades del pipeline (Component):", error);
Â  Â  return (
Â  Â  Â  <PipelineClient 
Â  Â  Â  Â  initialStages={[]}
Â  Â  Â  Â  initialContacts={[]}
Â  Â  Â  Â  initialOpportunities={[]}
Â  Â  Â  />
Â  Â  );
Â  }

Â  // âœ… 4. Ja no cal fer un "cast" forÃ§at. 
// 'data.contacts' ara Ã©s realment el tipus 'Contact[]' complet.
Â  return (
Â  Â  <PipelineClient 
Â  Â  Â  initialStages={data.stages}
Â  Â  Â  initialContacts={data.contacts} 
Â  Â  Â  initialOpportunities={data.opportunities}
Â  Â  />
Â  );
}

// =================== FILE: src/app/[locale]/(app)/crm/pipeline/_components/PipelineSkeleton.tsx ===================

// /app/[locale]/(app)/crm/pipeline/_components/PipelineSkeleton.tsx (Refactoritzat)
"use client";

import React from 'react';
// âœ… 1. Importem la definiciÃ³ de la base de dades.
import { type Database } from '@/types/supabase';

// âœ… 2. Definim el tipus Stage a partir de la taula corresponent.
type Stage = Database['public']['Tables']['pipeline_stages']['Row'];

interface PipelineSkeletonProps {
    stages: Stage[];
    viewMode: 'columns' | 'rows';
}

export const PipelineSkeleton: React.FC<PipelineSkeletonProps> = ({ stages, viewMode }) => {
    // La resta del JSX no canvia, ja que nomÃ©s depÃ¨n de propietats que no han canviat de nom ('id', 'name').
    if (viewMode === 'rows') {
        return (
            <div className="flex-1 overflow-y-auto pr-2 -mr-4 space-y-4">
                {stages.map(stage => (
                    <div key={stage.id} className="bg-muted/20 rounded-xl overflow-hidden border-l-4 border-gray-700">
                        <div className="flex justify-between items-center w-full px-4 py-3">
                            <div>
                                <div className="bg-gray-700/50 h-6 w-32 rounded-md animate-pulse"></div>
                                <div className="bg-gray-700/50 h-4 w-48 rounded-md mt-2 animate-pulse"></div>
                            </div>
                            <div className="bg-gray-700/50 h-9 w-24 rounded-md animate-pulse"></div>
                        </div>
                    </div>
                ))}
            </div>
        );
    }

    return (
        <div className="flex-1 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 min-h-0">
            {stages.map(stage => (
                <div key={stage.id} className="flex flex-col h-full bg-muted/20 rounded-xl overflow-hidden">
                    <div className="p-4 border-t-4 border-gray-700">
                        <div className="flex justify-between items-center">
                            <div className="bg-gray-700/50 h-6 w-3/4 rounded-md animate-pulse"></div>
                            <div className="bg-gray-700/50 h-7 w-7 rounded-md animate-pulse"></div>
                        </div>
                        <div className="bg-gray-700/50 h-4 w-1/2 rounded-md mt-2 animate-pulse"></div>
                    </div>
                    <div className="flex-1 px-2 pt-2 space-y-3">
                        <div className="bg-background/80 h-24 rounded-lg animate-pulse"></div>
                        <div className="bg-background/80 h-20 rounded-lg animate-pulse"></div>
                    </div>
                </div>
            ))}
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/pipeline/_components/RowsView.tsx ===================

import React from 'react';
import { Droppable } from '@hello-pangea/dnd';
import { Button } from '@/components/ui/button';
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from "@/components/ui/accordion";
import { Plus } from 'lucide-react';
import { cn } from '@/lib/utils/utils';
import { useTranslations, useLocale } from 'next-intl';
import { type Stage, type OpportunityWithContact } from './PipelineData';
import { PIPELINE_STAGES_MAP } from '@/config/pipeline';
import { OpportunityRowCard } from './OportunityRowCard';

interface RowsViewProps {
  stages: Stage[];
  opportunitiesByStage: Record<string, OpportunityWithContact[]>;
  onEditOpportunity: (opportunity: OpportunityWithContact) => void;
  onAddClick: (stageName: string) => void;
}

export const RowsView: React.FC<RowsViewProps> = ({ stages, opportunitiesByStage, onEditOpportunity, onAddClick }) => {
    const t = useTranslations('PipelinePage');
    const locale = useLocale();
    const stageColors: Record<string, string> = { 'Prospecte': 'border-blue-500', 'Contactat': 'border-cyan-500', 'Proposta Enviada': 'border-purple-500', 'NegociaciÃ³': 'border-yellow-500', 'Guanyat': 'border-green-500', 'Perdut': 'border-red-500' };

    return (
        <div className="flex-1 overflow-y-auto pr-2 -mr-4">
            <Accordion type="multiple" defaultValue={stages.map(s => s.id.toString())} className="w-full space-y-4">
                {stages.map(stage => {
                    const stageKey = PIPELINE_STAGES_MAP.find(s => s.name === stage.name)?.key;
                    const opportunities = opportunitiesByStage[stage.name] || [];
                    const totalValue = opportunities.reduce((sum, op) => sum + (op.value || 0), 0);
                    return (
                        <AccordionItem key={stage.id} value={stage.id.toString()} className={cn("bg-muted/20 rounded-xl overflow-hidden border-l-4", stageColors[stage.name] || "border-gray-500")}>
                            <div className="flex justify-between items-center w-full px-4">
                                <AccordionTrigger className="flex-1 text-left py-3 hover:no-underline">
                                    <div>
                                        <h3 className="font-bold text-lg text-foreground">{stageKey ? t(`stageNames.${stageKey}`) : stage.name}</h3>
                                        <p className="text-xs text-muted-foreground text-left">
                                            {t('opportunityCount', { count: opportunities.length })} â€¢ â‚¬{totalValue.toLocaleString(locale)}
                                        </p>
                                    </div>
                                </AccordionTrigger>
                                <Button size="sm" variant="ghost" onClick={() => onAddClick(stage.name)} className="ml-4">
                                    <Plus className="w-4 h-4 mr-2" />{t('addOpportunity')}
                                </Button>
                            </div>
                            <AccordionContent className="px-2 pb-2">
                                <Droppable droppableId={stage.name}>
                                    {(provided, snapshot) => (
                                        <div ref={provided.innerRef} {...provided.droppableProps} className={cn("space-y-2 p-2 rounded-md transition-colors", snapshot.isDraggingOver ? "bg-primary/5" : "")}>
                                            {opportunities.length > 0 ? (
                                                opportunities.map((op, index) => (
                                                    <OpportunityRowCard key={op.id} op={op} index={index} onEdit={onEditOpportunity} />
                                                ))
                                            ) : (
                                                <p className="text-center text-sm text-muted-foreground p-4">{t('noOpportunitiesInStage')}</p>
                                            )}
                                            {provided.placeholder}
                                        </div>
                                    )}
                                </Droppable>
                            </AccordionContent>
                        </AccordionItem>
                    );
                })}
            </Accordion>
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/pipeline/_components/StageColumn.tsx ===================

import React from 'react';
import { Droppable } from '@hello-pangea/dnd';
import { Button } from '@/components/ui/button';
import { cn } from '@/lib/utils/utils';
import { Plus } from 'lucide-react';
import { useTranslations, useLocale } from 'next-intl';
import { type Stage, type OpportunityWithContact } from './PipelineData';
import { PIPELINE_STAGES_MAP } from '@/config/pipeline';
import { OpportunityCard } from './OportunityCard';

interface StageColumnProps {
    stage: Stage;
    opportunities: OpportunityWithContact[];
    onEditOpportunity: (opportunity: OpportunityWithContact) => void;
    onAddClick: () => void;
}

export const StageColumn: React.FC<StageColumnProps> = ({ stage, opportunities, onEditOpportunity, onAddClick }) => {
    const t = useTranslations('PipelinePage');
    const locale = useLocale();
    const totalValue = opportunities.reduce((sum, op) => sum + (op.value || 0), 0);
    const stageKey = PIPELINE_STAGES_MAP.find(s => s.name === stage.name)?.key;
    const stageColors: Record<string, string> = { 'Prospecte': 'border-blue-500', 'Contactat': 'border-cyan-500', 'Proposta Enviada': 'border-purple-500', 'NegociaciÃ³': 'border-yellow-500', 'Guanyat': 'border-green-500', 'Perdut': 'border-red-500' };

    return (
        // âœ…âœ… CANVI PRINCIPAL: Ajustem fons i vores per light/dark âœ…âœ…
        <div className={cn(
            "flex flex-col h-full rounded-xl overflow-hidden",
            // Mode Clar: Fons 'card' (blanc/quasi blanc) amb vora
            "bg-card border border-border",
            // Mode Fosc: Mantenim el fons semi-transparent original, sense vora extra
            "dark:bg-muted/20 dark:border-transparent"
        )}>
            <div className={cn('p-4 border-t-4', stageColors[stage.name] || 'border-gray-500')}>
                <div className="flex justify-between items-center">
                    <h3 className="font-bold text-lg text-foreground mb-1">{stageKey ? t(`stageNames.${stageKey}`) : stage.name}</h3>
                    <Button variant="ghost" size="icon" onClick={onAddClick} className="w-7 h-7">
                        <Plus className="w-4 h-4" />
                    </Button>
                </div>
                <p className="text-xs text-muted-foreground">
                    {t('opportunityCount', { count: opportunities.length })} â€¢ â‚¬{totalValue.toLocaleString(locale)}
                </p>
            </div>
            <Droppable droppableId={stage.name}>
                {(provided, snapshot) => (
                    <div
                        ref={provided.innerRef}
                        {...provided.droppableProps}
                        className={cn('flex-1 px-2 pt-2 overflow-y-auto transition-colors', snapshot.isDraggingOver ? 'bg-primary/10' : '')}
                    >
                        {opportunities.map((op, index) => (
                            <div key={op.id} onDoubleClick={() => onEditOpportunity(op)}>
                                <OpportunityCard opportunity={op} index={index} />
                            </div>
                        ))}
                        {provided.placeholder}
                    </div>
                )}
            </Droppable>
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/crm/pipeline/_hooks/useOpportunityForm.ts ===================

// /app/[locale]/(app)/crm/pipeline/_hooks/useOpportunityForm.ts (Refactoritzat)

import { useState, useEffect, useTransition } from 'react';
import { toast } from 'sonner';
import { useTranslations } from 'next-intl';
import { saveOpportunityAction } from '../actions';
// âœ… Importem el tipus enriquit.
import { type OpportunityWithContact } from '../_components/PipelineData';

interface HookProps {
    opportunityToEdit: Partial<OpportunityWithContact> | null;
    onSuccess: () => void;
    onOpenChange: (open: boolean) => void;
}

export function useOpportunityForm({ opportunityToEdit, onSuccess, onOpenChange }: HookProps) {
    const t = useTranslations('OpportunityDialog');
    const [isPending, startTransition] = useTransition();
    // âœ… L'estat ara gestiona un nÃºmero o null.
    const [selectedContactId, setSelectedContactId] = useState<number | null>(null);
    const [closeDate, setCloseDate] = useState<Date | undefined>();

    useEffect(() => {
        setSelectedContactId(opportunityToEdit?.contact_id || null);
        setCloseDate(opportunityToEdit?.close_date ? new Date(opportunityToEdit.close_date) : undefined);
    }, [opportunityToEdit]);

    const handleSubmit = (formData: FormData) => {
        // âœ… Si estem editant, afegim l'ID com a string (FormData nomÃ©s accepta strings).
        if (opportunityToEdit?.id) formData.set('id', opportunityToEdit.id.toString());
        if (selectedContactId) formData.set('contact_id', selectedContactId.toString());
        if (closeDate) formData.set('close_date', closeDate.toISOString());

        startTransition(async () => {
            const result = await saveOpportunityAction(formData);
            if (result.error) {
                toast.error(t('toastErrorTitle'), { description: result.error.message });
            } else {
                toast.success(t('toastSuccessTitle'), { description: t('toastSuccessDescription') });
                onSuccess();
                onOpenChange(false);
            }
        });
    };

    return {
        isPending,
        selectedContactId,
        setSelectedContactId,
        closeDate,
        setCloseDate,
        handleSubmit,
    };
}

// =================== FILE: src/app/[locale]/(app)/crm/pipeline/_hooks/usePipeline.ts ===================

// /app/[locale]/(app)/crm/pipeline/_hooks/usePipeline.ts (Refactoritzat)

import { useState, useMemo, useTransition, useCallback } from 'react'; 
import { useRouter } from 'next/navigation';
import { toast } from 'sonner';
import { type DropResult } from '@hello-pangea/dnd';
import { updateOpportunityStageAction } from '../actions';
// âœ… Importem els nous tipus.
import { type Stage, type OpportunityWithContact } from '../_components/PipelineData';

interface UsePipelineProps {
    initialStages: Stage[];
    opportunities: OpportunityWithContact[];
    setOpportunities: React.Dispatch<React.SetStateAction<OpportunityWithContact[]>>;
}

export function usePipeline({ initialStages, opportunities, setOpportunities }: UsePipelineProps) {
    const router = useRouter();
    const [isDndPending, startDndTransition] = useTransition();

    const [isDialogOpen, setIsDialogOpen] = useState(false);
    // âœ… El tipus ara Ã©s el correcte, amb l'ID numÃ¨ric.
    const [editingOpportunity, setEditingOpportunity] = useState<Partial<OpportunityWithContact> | null>(null);
    const [viewMode, setViewMode] = useState<'columns' | 'rows'>('columns');

    const opportunitiesByStage = useMemo(() => {
        const grouped = initialStages.reduce((acc, stage) => {
            acc[stage.name] = [];
            return acc;
        }, {} as Record<string, OpportunityWithContact[]>);

        opportunities.forEach(op => {
            if (op.stage_name && grouped[op.stage_name]) {
                grouped[op.stage_name].push(op);
            }
        });
        Object.values(grouped).forEach(ops => ops.sort((a, b) => (a.value ?? 0) - (b.value ?? 0)));
        return grouped;
    }, [opportunities, initialStages]);

    const onDragEnd = useCallback((result: DropResult) => {
        const { source, destination, draggableId } = result;
        if (!destination || (source.droppableId === destination.droppableId && source.index === destination.index)) return;

        const newStage = destination.droppableId;
        const opportunityId = parseInt(draggableId, 10);
        const originalOpportunities = [...opportunities];

        setOpportunities(prev => prev.map(op => 
            op.id === opportunityId ? { ...op, stage_name: newStage } : op
        ));

        startDndTransition(async () => {
            // âœ… Passem l'ID com a nÃºmero.
            const updateResult = await updateOpportunityStageAction(opportunityId, newStage);
            if (updateResult.error) {
                setOpportunities(originalOpportunities);
                toast.error("Error", { description: updateResult.error.message });
            } else {
                toast.success("Oportunitat moguda amb Ã¨xit.");
                router.refresh();
            }
        });
    }, [opportunities, setOpportunities, router]);

    const handleOpenDialog = useCallback((opportunity?: OpportunityWithContact, stageName?: string) => {
        if (opportunity) {
            setEditingOpportunity(opportunity);
        } else {
            setEditingOpportunity(stageName ? { stage_name: stageName } : {});
        }
        setIsDialogOpen(true);
    }, []);

    const handleSuccess = useCallback(() => {
        setIsDialogOpen(false);
        router.refresh();
    }, [router]);

    return {
        isPending: isDndPending,
        opportunitiesByStage,
        viewMode,
        setViewMode,
        isDialogOpen,
        setIsDialogOpen,
        editingOpportunity,
        onDragEnd,
        handleOpenDialog,
        handleSuccess,
    };
}

// =================== FILE: src/app/[locale]/(app)/dashboard/actions.ts ===================

'use server';

import { revalidatePath } from "next/cache";
import { validateUserSession } from "@/lib/supabase/session";
import { NewTaskPayload } from "@/types/dashboard/types"; 
import type { Tables } from "@/types/supabase";
import type { Department } from "@/types/db"; // Importem el tipus correcte

// âœ… 1. Importem el nostre servei
import * as dashboardService from "@/lib/services/dashboard/dashboard.service";
import { type ActionResult } from "@/types/shared/index"; // Resultat genÃ¨ric


/**
 * ACCIÃ“: Afegeix una nova tasca.
 */
export async function addTask(taskData: NewTaskPayload): Promise<ActionResult> {
Â  // 1. Validar SessiÃ³
Â  const session = await validateUserSession();
Â  if ('error' in session) return { success: false, message: session.error.message };
Â  const { supabase, user, activeTeamId } = session;

Â  try {
    // 2. Cridar al Servei
Â  Â  await dashboardService.addTask(supabase, taskData, user.id, activeTeamId);
    
    // 3. Efecte secundari
Â  Â  revalidatePath('/dashboard');
Â  Â  return { success: true };

Â  } catch (error: unknown) {
    // 4. GestiÃ³ d'errors
Â  Â  const message = (error as Error).message;
Â  Â  console.error('Error creating task (action):', message);
Â  Â  return { success: false, message };
Â  }
}

/**
 * ACCIÃ“: Elimina una tasca.
 */
export async function deleteTask(taskId: number): Promise<ActionResult> {
Â  // 1. Validar SessiÃ³
Â  const session = await validateUserSession();
Â  if ('error' in session) return { success: false, message: session.error.message };
Â  const { supabase } = session;

Â  try {
    // 2. Cridar al Servei
Â  Â  await dashboardService.deleteTask(supabase, taskId);
    
    // 3. Efecte secundari
Â  Â  revalidatePath('/dashboard');
Â  Â  return { success: true };

Â  } catch (error: unknown) {
    // 4. GestiÃ³ d'errors
Â  Â  const message = (error as Error).message;
Â  Â  console.error('Error en eliminar la tasca (action):', message);
Â  Â  return { success: false, message };
Â  }
}

/**
 * ACCIÃ“: Afegeix un nou departament.
 */
export async function addDepartment(name: string): Promise<ActionResult<Department>> {
Â  // 1. Validar SessiÃ³
Â  const session = await validateUserSession();
Â  if ('error' in session) return { success: false, message: session.error.message };
Â  const { supabase, activeTeamId } = session;

Â  try {
    // 2. Cridar al Servei
Â  Â  const data = await dashboardService.addDepartment(supabase, name, activeTeamId);

    // 3. Efecte secundari
Â  Â  revalidatePath('/dashboard');
Â  Â  return { success: true, data };

Â  } catch (error: unknown) {
    // 4. GestiÃ³ d'errors (incloent duplicats)
Â  Â  const message = (error as Error).message;
Â  Â  console.error('Error en crear el departament (action):', message);
Â  Â  return { success: false, message };
Â  }
}

/**
 * ACCIÃ“: Actualitza una tasca.
 */
export async function updateTaskAction(taskId: number, updatedData: Partial<Tables<'tasks'>>): Promise<ActionResult> {
Â  // 1. Validar SessiÃ³
Â  const session = await validateUserSession();
Â  if ('error' in session) return { success: false, message: session.error.message };
Â  const { supabase } = session;

Â  try {
    // 2. Cridar al Servei
Â  Â  await dashboardService.updateTask(supabase, taskId, updatedData);

    // 3. Efecte secundari
Â  Â  revalidatePath('/dashboard');
Â  Â  return { success: true };

Â  } catch (error: unknown) {
    // 4. GestiÃ³ d'errors
Â  Â  const message = (error as Error).message;
Â  Â  console.error('Error en actualitzar la tasca (action):', message);
Â  Â  return { success: false, message };
Â  }
}

// =================== FILE: src/app/[locale]/(app)/dashboard/dashboard-client.tsx ===================

// src/app/[locale]/(app)/dashboard/dashboard-client.tsx (COMPLET I CORREGIT)

"use client";

import React, { useState, useMemo, useCallback, useEffect, startTransition } from "react";
import { useRouter } from "next/navigation";
import { useTranslations } from "next-intl";
import Link from 'next/link';
import { toast } from "sonner";
import { motion } from "framer-motion";
import {
  BarChart2,
  Activity,
  ListChecks,
  Radar as RadarIcon,
  Plus,
  Calendar,
  Quote,
  Mail,
  MoreVertical // â• AFEGIT: Icona per al menÃº mÃ²bil
} from "lucide-react";

import { ModuleCard } from "@/components/shared/ModuleCard";
import { SalesPerformance } from "./_components/SalesPerformance";
import { RecentActivities } from "./_components/RecentActivities";
import { Radar } from "./_components/Radar";
import { Agenda, TaskFilterStatus } from "./_components/agenda/Agenda";

import { TaskDialogManager, EnrichedTask } from '@/components/features/tasks/TaskDialogManager';
import { updateSimpleTask } from '@/app/actions/tasks/actions';

import { Tables } from "@/types/supabase";
import { Button } from "@/components/ui/button";
import { Switch } from "@/components/ui/switch";
import { Label } from "@/components/ui/label";
import { ServerActivityItem } from "@/lib/data/dashboard";
import { RecentQuotes, EnrichedQuote } from "./_components/RecentQuotes";
import { RecentEmails, EnrichedEmail } from "./_components/RecentEmails";

// â• AFEGIT: Imports per al DropdownMenu
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";

const MONTHLY_GOAL = 50_000;

interface DashboardClientProps {
  initialData: {
    stats: {
      totalContacts: number;
      activeClients: number;
      opportunities: number;
      invoiced: number;
      pending: number;
      expenses: number;
      invoicedChange: string;
      expensesChange: string;
      invoicedIsPositive: boolean;
      expensesIsPositive: boolean;
    };
    tasks: EnrichedTask[];
    departments: Tables<'departments'>[];
    contacts: Tables<'contacts'>[];
    overdueInvoices: (Tables<'invoices'> & { contacts: { nom: string } | null })[];
    attentionContacts: Tables<'contacts'>[];
    notifications: Tables<'notifications'>[];
    recentActivities: ServerActivityItem[];
    recentQuotes: EnrichedQuote[];
    recentEmails: EnrichedEmail[];
  };
  teamMembers: Tables<'team_members_with_profiles'>[];
  children: React.ReactNode;
  userId: string;
  activeTeamId: string;
}

export function DashboardClient({
  initialData,
  teamMembers,
  children,
  userId,
  activeTeamId
}: DashboardClientProps) {
  const t = useTranslations('DashboardClient');
  const router = useRouter();

  const [tasks, setTasks] = useState(initialData.tasks);
  const [taskToManage, setTaskToManage] = useState<EnrichedTask | null>(null);
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [taskFilter, setTaskFilter] = useState<TaskFilterStatus>('pendents');
  const [departmentFilter, setDepartmentFilter] = useState<number | 'all'>('all');
  const [searchTerm, setSearchTerm] = useState('');
  const [showAllTeamTasks, setShowAllTeamTasks] = useState(false);

  useEffect(() => {
    setTasks(initialData.tasks);
  }, [initialData.tasks]);

  const pendingCount = useMemo(() => tasks.filter(t => !t.is_completed && !t.user_asign_id).length, [tasks]);

  const assignedCount = useMemo(() => {
    const baseFilter = (t: EnrichedTask) => t.user_asign_id !== null && !t.is_completed;
    if (showAllTeamTasks) return tasks.filter(baseFilter).length;
    return tasks.filter(t => baseFilter(t) && t.user_asign_id === userId).length;
  }, [tasks, userId, showAllTeamTasks]);

  const completedCount = useMemo(() => {
    const baseFilter = (t: EnrichedTask) => t.is_completed;
    if (showAllTeamTasks) return tasks.filter(baseFilter).length;
    return tasks.filter(t => baseFilter(t) && t.user_asign_id === userId).length;
  }, [tasks, userId, showAllTeamTasks]);

  const handleTaskMutation = useCallback((options: { closeDialog?: boolean } = {}) => {
    const { closeDialog = true } = options;
    router.refresh();
    if (closeDialog) {
      setIsDialogOpen(false);
    }
  }, [router]);

  const handleToggleTask = useCallback((task: EnrichedTask) => {
    const previousTasks = tasks;
    let updateData: Partial<Tables<'tasks'>> = {};
    let successMessage = "";

    if (task.is_completed) {
      updateData = {
        is_completed: false,
        finish_date: null
      };
      successMessage = "Tasca reoberta.";
    } else if (task.user_asign_id) {
      updateData = {
        is_completed: true,
        finish_date: new Date().toISOString()
      };
      successMessage = "Tasca completada!";
    } else {
      updateData = {
        user_asign_id: userId,
        asigned_date: new Date().toISOString()
      };
      successMessage = `T'has assignat la tasca.`;
    }

    setTasks(prev =>
      prev.map(t =>
        t.id === task.id
          ? { ...t, ...updateData } as EnrichedTask
          : t
      )
    );

    startTransition(async () => {
      const { error } = await updateSimpleTask(task.id, updateData);
      if (error) {
        toast.error("No s'ha pogut actualitzar l'estat de la tasca.");
        setTasks(previousTasks);
      } else {
        toast.success(successMessage);
        handleTaskMutation({ closeDialog: false });
      }
    });
  }, [tasks, userId, handleTaskMutation]);

  const filteredTasks = useMemo(() => {
    let result = tasks;

    if (taskFilter === 'pendents') {
      result = result.filter(t => !t.is_completed && !t.user_asign_id);
    } else if (taskFilter === 'assignades') {
      result = result.filter(t => t.user_asign_id !== null && !t.is_completed);
      if (!showAllTeamTasks) {
        result = result.filter(t => t.user_asign_id === userId);
      }
    } else {
      result = result.filter(t => t.is_completed);
      if (!showAllTeamTasks) {
        result = result.filter(t => t.user_asign_id === userId);
      }
    }

    if (departmentFilter !== 'all') {
      result = result.filter(t => t.department_id === departmentFilter);
    }

    if (searchTerm.trim() !== '') {
      result = result.filter(t =>
        t.title.toLowerCase().includes(searchTerm.toLowerCase())
      );
    }

    return result;
  }, [tasks, taskFilter, departmentFilter, searchTerm, userId, showAllTeamTasks]);

  const openNewTaskDialog = () => {
    setTaskToManage(null);
    setIsDialogOpen(true);
  };

  const openViewTaskDialog = (task: EnrichedTask) => {
    setTaskToManage(task);
    setIsDialogOpen(true);
  };

  {/* â— CORREGIT: L'alÃ§ada ara Ã©s automÃ tica en mÃ²bil (h-auto) i fixa en escriptori (md:h-96) */ }
  const midaCardsSuperiors = "h-auto md:h-96";

  return (
    <div className="relative w-full ">
      <div className="absolute inset-0 -z-10 bg-background bg-[radial-gradient(theme(colors.gray.300)_1px,transparent_1px)] dark:bg-[radial-gradient(theme(colors.slate.800)_1px,transparent_1px)] [background-size:16px_16px]" />

      <motion.div
        className="flex flex-col gap-6"
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.5 }}
      >
        <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6">
          <ModuleCard title={t('recentQuotes')} icon={Quote} variant="quotes" className={midaCardsSuperiors}>
            <RecentQuotes quotes={initialData.recentQuotes} />
          </ModuleCard>
          <ModuleCard title={t('inbox.title')} icon={Mail} variant="inbox" className={midaCardsSuperiors}>
            <RecentEmails emails={initialData.recentEmails} />
          </ModuleCard>
          <ModuleCard title={t('recentActivities')} icon={Activity} variant="activity" className={midaCardsSuperiors}>
            <RecentActivities activities={initialData.recentActivities} />
          </ModuleCard>
          <ModuleCard title={t('radar')} icon={RadarIcon} variant="radar" className={midaCardsSuperiors}>
            <Radar
              attentionContacts={initialData.attentionContacts}
              overdueInvoices={initialData.overdueInvoices}
              notifications={initialData.notifications}
            />
          </ModuleCard>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-5 gap-6">
          <div className="lg:col-span-2">
            <ModuleCard title={t('salesPerformance')} icon={BarChart2} variant="sales">
              <SalesPerformance
                stats={initialData.stats}
                percentGoal={Math.round((initialData.stats.invoiced / MONTHLY_GOAL) * 100)}
                monthlyGoal={MONTHLY_GOAL}
              />
            </ModuleCard>
          </div>
          <div className="lg:col-span-3">
            <ModuleCard
              title={t('agenda.title')}
              icon={ListChecks}
              variant="agenda"
              className=""
              actions={
                // â— --- INICI CORRECCIÃ“ MOBIL ---
                <>
                  {/* Vista Escriptori (md i amunt) */}
                  <div className="hidden md:flex items-center space-x-4">
                    <Button asChild variant="outline" size="icon" className="flex-shrink-0 bg-primary-foreground/20 hover:bg-primary-foreground/70 border-primary/10">
                      <Link href="/crm/calendari" aria-label={"Calendar"}> <Calendar className="h-5 w-5" /> </Link>
                    </Button>
                    <div className="flex items-center space-x-2">
                      {/* IDs Ãºnics per a accessibilitat */}
                      <Switch id="show-all-tasks-desktop" checked={showAllTeamTasks} onCheckedChange={setShowAllTeamTasks} aria-label={t('agenda.viewAll')} />
                      <Label htmlFor="show-all-tasks-desktop" className="text-xm font-normal cursor-pointer text-primary-foreground">{t('agenda.viewAll')}</Label>
                    </div>
                    <Button variant="ghost" onClick={openNewTaskDialog} className="flex-shrink-0 bg-primary-foreground/20 hover:bg-primary-foreground/70 border-primary/10">
                      <Plus className="w-4 h-4" />
                      {t('agenda.newTask')}
                    </Button>
                  </div>

                  {/* Vista MÃ²bil (sota md) */}
                  <div className="flex md:hidden items-center">
                    <DropdownMenu>
                      <DropdownMenuTrigger asChild>
                        <Button variant="ghost" size="icon" className="bg-primary-foreground/20 hover:bg-primary-foreground/70 border-primary/10">
                          <MoreVertical className="h-5 w-5" />
                          <span className="sr-only">Obrir menÃº d'accions</span>
                        </Button>
                      </DropdownMenuTrigger>
                      <DropdownMenuContent align="end">
                        <DropdownMenuLabel>{t('agenda.title')}</DropdownMenuLabel>
                        <DropdownMenuItem onClick={openNewTaskDialog}>
                          <Plus className="mr-2 h-4 w-4" />
                          <span>{t('agenda.newTask')}</span>
                        </DropdownMenuItem>
                        <DropdownMenuItem asChild>
                          <Link href="/crm/calendari">
                            <Calendar className="mr-2 h-4 w-4" />
                            <span>Anar al Calendari</span>
                          </Link>
                        </DropdownMenuItem>
                        <DropdownMenuSeparator />
                        <div className="px-2 py-1.5 text-sm">
                          <div className="flex items-center justify-between space-x-2">
                            <Label htmlFor="show-all-tasks-mobile" className="font-normal cursor-pointer text-foreground">{t('agenda.viewAll')}</Label>
                            <Switch id="show-all-tasks-mobile" checked={showAllTeamTasks} onCheckedChange={setShowAllTeamTasks} aria-label={t('agenda.viewAll')} />
                          </div>
                        </div>
                      </DropdownMenuContent>
                    </DropdownMenu>
                  </div>
                </>
                // â— --- FI CORRECCIÃ“ MOBIL ---
              }
            >
              <Agenda
                tasks={filteredTasks}
                activeFilter={taskFilter} onFilterChange={setTaskFilter}
                departmentFilter={departmentFilter} onDepartmentFilterChange={setDepartmentFilter}
                onViewTask={openViewTaskDialog}
                pendingCount={pendingCount} assignedCount={assignedCount} completedCount={completedCount}
                departments={initialData.departments}
                searchTerm={searchTerm} onSearchChange={setSearchTerm}
                onToggleTask={handleToggleTask}
                onTaskMutation={handleTaskMutation}
              />
            </ModuleCard>
          </div>
        </div>

        {children}
      </motion.div>

      <TaskDialogManager
        task={taskToManage}
        open={isDialogOpen}
        onOpenChange={setIsDialogOpen}
        contacts={initialData.contacts}
        initialDepartments={initialData.departments}
        teamMembers={teamMembers
          .filter(m => m.user_id)
          .map(m => ({ id: m.user_id!, full_name: m.full_name }))
        }
        onTaskMutation={handleTaskMutation}
        activeTeamId={activeTeamId}
      />
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/dashboard/page.tsx ===================

import { Suspense } from 'react';
import type { Metadata } from 'next';
import { DashboardData } from './_components/DashboardData';
import { DashboardSkeleton } from './_components/DashboardSkeleton';
import { AIOracleSkeleton } from './_components/AIOracleSkeleton';


export const metadata: Metadata = {
  title: 'Tauler Principal | Ribot',
};



/**
 * @summary La pÃ gina principal del Dashboard.
 */
export default function DashboardPage() {
  return (
    <Suspense fallback={<DashboardSkeleton />}>
      {/* âœ… CORRECCIÃ“: Passem l'Oracle com a fill (children) de DashboardData */}
      <DashboardData>
        <Suspense fallback={<AIOracleSkeleton />}>
          {/* <AIOracle /> */}
        </Suspense>
      </DashboardData>
    </Suspense>
  );
}


// =================== FILE: src/app/[locale]/(app)/dashboard/_components/agenda/Agenda.tsx ===================

// src/app/[locale]/(app)/dashboard/_components/agenda/Agenda.tsx (COMPLET I CORREGIT)

"use client";

import React from 'react';
import { useTranslations } from 'next-intl';
import { LayoutGrid, Search, ClipboardCheck } from 'lucide-react';
import { motion, AnimatePresence, Variants } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Input } from '@/components/ui/input';
import { TaskCard } from './TaskCard';
import { EnrichedTask } from '@/components/features/tasks/TaskDialogManager';
import { Tables } from '@/types/supabase';
import { cn } from '@/lib/utils/utils';

export type TaskFilterStatus = 'pendents' | 'assignades' | 'completes';

interface AgendaProps {
  tasks: EnrichedTask[];
  activeFilter: TaskFilterStatus;
  onFilterChange: (filter: TaskFilterStatus) => void;
  onViewTask: (task: EnrichedTask) => void;
  pendingCount: number;
  assignedCount: number;
  completedCount: number;
  departments: Tables<'departments'>[];
  departmentFilter: number | 'all';
  onDepartmentFilterChange: (filter: number | 'all') => void;
  searchTerm: string;
  onSearchChange: (term: string) => void;
  onToggleTask: (task: EnrichedTask) => void;
  onTaskMutation: () => void;
}

const filterOptions: { value: TaskFilterStatus; labelKey: string; count: (props: AgendaProps) => number }[] = [
  { value: 'pendents', labelKey: 'pending', count: (props) => props.pendingCount },
  { value: 'assignades', labelKey: 'assigned', count: (props) => props.assignedCount },
  { value: 'completes', labelKey: 'completed', count: (props) => props.completedCount },
];

const itemVariants: Variants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: { type: "spring", stiffness: 100 },
  },
  exit: {
    y: -20,
    opacity: 0,
    transition: { duration: 0.2 }
  }
};

export function Agenda(props: AgendaProps) {
  const {
    tasks,
    activeFilter,
    onFilterChange,
    onViewTask,
    departments,
    departmentFilter,
    onDepartmentFilterChange,
    searchTerm,
    onSearchChange,
    onToggleTask,
    onTaskMutation
  } = props;
  const t = useTranslations('DashboardClient.agenda');

  return (
    <div className="flex flex-col h-full max-h-[70vh]">
      {/* --- SECCIÃ“ DE FILTRES I CERCA (Contingut fix) --- */}
      <div className="flex-shrink-0 space-y-4">
        {/* Aquesta estructura flex-col sm:flex-row Ã©s perfectament responsive */}
        <div className="flex flex-col sm:flex-row gap-2">

          {/* FILTRE ESTAT â€” Responsive: icones o dropdown en mÃ²bil */}
          <div className="w-full sm:w-auto">
            {/* Desktop */}
            <div className="hidden sm:grid grid-cols-3 gap-1 bg-green-300/10 rounded-lg border border-green-500/20">
              {filterOptions.map(option => (
                <Button
                  key={option.value}
                  variant={activeFilter === option.value ? 'default' : 'ghost'}
                  onClick={() => onFilterChange(option.value)}
                  className={cn(
                    "w-full justify-center transition-all duration-200",
                    activeFilter === option.value
                      ? 'bg-green-600 text-white shadow hover:bg-green-700'
                      : 'text-green-800 hover:bg-green-500/20 dark:text-green-300'
                  )}
                >
                  {t(option.labelKey)}
                  <span className={cn(
                    "ml-2 text-xs font-semibold rounded-full px-2 py-0.5",
                    activeFilter === option.value
                      ? "bg-white/20 text-white"
                      : "bg-green-600/10 text-green-700 dark:bg-green-300/10 dark:text-green-300"
                  )}>
                    {option.count(props)}
                  </span>
                </Button>
              ))}
            </div>

            {/* MÃ²bil */}
            <div className="sm:hidden">
              <Select
                value={activeFilter}
                onValueChange={(value: TaskFilterStatus) => onFilterChange(value)}
              >
                <SelectTrigger className="w-full bg-green-300/10 border-green-500/20">
                  <SelectValue placeholder={t('filter.statusPlaceholder')} />
                </SelectTrigger>
                <SelectContent>
                  {filterOptions.map(option => (
                    <SelectItem key={option.value} value={option.value}>
                      {t(option.labelKey)} ({option.count(props)})
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </div>


          <Select
            value={String(departmentFilter)}
            onValueChange={(value) => onDepartmentFilterChange(value === 'all' ? 'all' : Number(value))}
          >
            {/* Aquestes classes w-full sm:w-[180px] sÃ³n correctes per responsive */}
            <SelectTrigger className="w-full sm:w-[180px] bg-green-300/10 border-green-500/20 focus:ring-green-500">
              {/* Amagar la icona en mÃ²bil (hidden sm:block) Ã©s una bona prÃ ctica */}
              <LayoutGrid className="w-4 h-4 mr-2 text-muted-foreground hidden sm:block" />
              <SelectValue placeholder={t('filter.departmentPlaceholder')} />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">{t('filter.allDepartments')}</SelectItem>
              {departments.map(dep => (
                <SelectItem key={dep.id} value={String(dep.id)}>{dep.name}</SelectItem>
              ))}
            </SelectContent>
          </Select>
          <div className="relative">
            <Search className="absolute left-3.5 top-1/2 -translate-y-1/2 h-5 w-5 text-green-800/50 dark:text-green-300/50" />
            <Input
              type="search"
              placeholder={t('searchPlaceholder')}
              value={searchTerm}
              onChange={(e) => onSearchChange(e.target.value)}
              className="pl-11 w-full bg-green-500/10 border-green-00/20 focus-visible:ring-2 focus-visible:ring-green-500 focus-visible:ring-offset-2"
            />
          </div>
        </div>
      </div>

      {/* Aquest contenidor de scroll Ã©s clau i funciona perfectament */}
      <div className="flex-1 overflow-y-auto pr-2 -mr-2 mt-4 min-h-0 space-y-3">
        <AnimatePresence>
          {tasks.length > 0 ? (
            tasks.map((task) => (
              <motion.div
                key={task.id}
                variants={itemVariants}
                initial="hidden"
                animate="visible"
                exit="exit"
                layout
              >
                <TaskCard
                  task={task}
                  onViewTask={onViewTask}
                  onToggleTask={onToggleTask}
                  onTaskMutation={onTaskMutation}
                />
              </motion.div>
            ))
          ) : (
            <motion.div
              key="empty-state"
              initial={{ opacity: 0, scale: 0.95 }}
              animate={{ opacity: 1, scale: 1 }}
              exit={{ opacity: 0, scale: 0.95 }}
              transition={{ duration: 0.3 }}
              className="flex flex-col items-center justify-center h-full pt-10 text-center"
            >
              <ClipboardCheck className="w-16 h-16 text-green-500/30 mb-4" />
              <h4 className="font-semibold text-lg text-foreground">Tot en ordre!</h4>
              <p className="text-sm text-muted-foreground mt-1">
                {t('noTasksFound')}
              </p>
            </motion.div>
          )}
        </AnimatePresence>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/dashboard/_components/agenda/TaskCard.tsx ===================

// src/app/[locale]/(app)/dashboard/_components/agenda/TaskCard.tsx (COMPLET I CORREGIT)

"use client";

import { useState, useEffect, useCallback } from "react";
import { Checkbox } from "@/components/ui/checkbox";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from "@/components/ui/collapsible";
import { Button } from "@/components/ui/button";
import { cn } from "@/lib/utils/utils";
import { format, isPast, isToday } from "date-fns";
import { es } from "date-fns/locale";
import { Calendar, Contact as ContactIcon, User as UserIcon, Building, ChevronDown, CheckSquare } from "lucide-react";
import { EnrichedTask } from '@/components/features/tasks/TaskDialogManager';
import { TaskPriority } from '@/config/styles/task';
import { Badge } from "@/components/ui/badge";
import parse, { domToReact, Element, DOMNode } from 'html-react-parser';
import { updateSimpleTask, getSignedUrlForFile } from "@/app/actions/tasks/actions"; // âœ… AFEGEIX 'getSignedUrlForFile'
import { toast } from "sonner";
import { Tables, Json } from '@/types/supabase';
import { Skeleton } from "@/components/ui/skeleton"; // âœ… AFEGEIX AQUEST
// --- Helpers ---

// Tipus explÃ­cit per a les entrades del log
type TimeTrackingLogEntry = { status?: 'active' | 'inactive'; action?: 'actiu' | 'inactiu'; timestamp: string; user_id?: string };

const calculateElapsedTime = (startTime: string): number => new Date().getTime() - new Date(startTime).getTime();

const formatDuration = (ms: number): string => {
    const totalSeconds = Math.floor(ms / 1000);
    const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
    const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
    const seconds = (totalSeconds % 60).toString().padStart(2, '0');
    return `${hours}:${minutes}:${seconds}`;
};

// Hook del temporitzador
const useTaskTimer = (task: EnrichedTask): string => {
    const [elapsedTime, setElapsedTime] = useState<number>(0);

    useEffect(() => {
        let intervalId: NodeJS.Timeout | null = null;
        if (task.is_active && task.time_tracking_log && Array.isArray(task.time_tracking_log)) {
            const logArray: TimeTrackingLogEntry[] = task.time_tracking_log as unknown as TimeTrackingLogEntry[];

            const lastActiveLog = [...logArray]
                .sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime())
                .find(log => log.status === 'active' || log.action === 'actiu');

            if (lastActiveLog) {
                const startTime = lastActiveLog.timestamp;
                const updateElapsedTime = () => setElapsedTime(calculateElapsedTime(startTime));
                updateElapsedTime();
                intervalId = setInterval(updateElapsedTime, 1000);
            } else {
                setElapsedTime(0);
            }
        } else {
            setElapsedTime(0);
        }

        return () => {
            if (intervalId) clearInterval(intervalId);
        };
    }, [task.is_active, task.time_tracking_log]);

    return formatDuration(elapsedTime);
};


const generateHslColorFromString = (str: string | null | undefined) => {
    if (!str) return null;
    let hash = 0;
    for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
    const h = hash % 360;
    return {
        main: `hsl(${h}, 70%, 50%)`,
        soft: `hsl(${h}, 80%, 95%)`,
        darkSoft: `hsl(${h}, 80%, 10%)`
    };
};

// --- Components UI ---
function MetaItem({ icon: Icon, text, className }: { icon: React.ElementType, text: React.ReactNode, className?: string }) {
    if (!text) return null;
    return (
        <div className={cn("flex items-center gap-2 text-sm text-muted-foreground", className)}>
            <Icon className="w-4 h-4 flex-shrink-0" />
            <span className="truncate">{text}</span>
        </div>
    );
}
const PriorityDot = ({ priority }: { priority: TaskPriority | null }) => {
    const colorClass = {
        'Alta': 'bg-red-500',
        'Mitjana': 'bg-yellow-500',
        'Baixa': 'bg-blue-500',
    }[priority || 'Baixa'];
    return <div className={cn("w-3 h-3 rounded-full flex-shrink-0", colorClass)} />;
}
// âœ… AFEGEIX AQUEST COMPONENT SENCER
function PrivateImage({ src, alt }: { src: string; alt: string }) {
    const [imageUrl, setImageUrl] = useState<string | null>(null);

    useEffect(() => {
        // NomÃ©s actuem si el 'src' Ã©s un filePath (no una URL http)
        if (src && src.includes('task-uploads/')) { // Usem 'includes' per ser flexibles

            // Tallem el src per si tÃ© una barra al davant
            const cleanSrc = src.startsWith('/') ? src.substring(1) : src;

            const fetchUrl = async () => {
                const result = await getSignedUrlForFile(cleanSrc); // Crida a la Server Action
                if (result.success && result.data) {
                    setImageUrl(result.data);
                }
            };
            fetchUrl();
        }
    }, [src]);

    if (!imageUrl) {
        return <Skeleton className="w-full h-32 rounded-md my-2" />;
    }

    return <img src={imageUrl} alt={alt} className="rounded-md" />;
}
// --- FunciÃ³ Helper per Comptar Checkboxes ---
function countCheckboxesFromHtml(html: string): { total: number; completed: number } {
    if (!html) return { total: 0, completed: 0 };
    try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const taskItems = doc.querySelectorAll('li[data-type="taskItem"]');
        const total = taskItems.length;
        let completed = 0;
        taskItems.forEach(item => {
            if (item.getAttribute('data-checked') === 'true') {
                completed++;
            }
        });
        return { total, completed };
    } catch (error) {
        console.error("Error counting checkboxes from HTML:", error);
        return { total: 0, completed: 0 };
    }
}

// --- Component Principal ---
interface TaskCardProps {
    task: EnrichedTask;
    onViewTask: (task: EnrichedTask) => void;
    // âœ… Canvi: Passem la tasca sencera per tenir mÃ©s context
    onToggleTask: (task: EnrichedTask) => void;
    onTaskMutation: () => void;
}

export function TaskCard({ task, onViewTask, onToggleTask, onTaskMutation }: TaskCardProps) {
    const [isOpen, setIsOpen] = useState(false);
    const [currentDescription, setCurrentDescription] = useState(task.description || '');

    const dueDate = task.due_date ? new Date(task.due_date) : null;
    const isOverdue = dueDate && isPast(dueDate) && !isToday(dueDate);
    const formattedTimer = useTaskTimer(task);
    const userColor = generateHslColorFromString(task.user_asign_id);
    const cardStyle: React.CSSProperties = userColor ? {
        '--user-color-main': userColor.main,
        '--user-color-soft': userColor.soft,
        '--user-color-dark-soft': userColor.darkSoft
    } as React.CSSProperties : {};
    const progress = task.checklist_progress;
    const showProgress = progress && progress.total > 0;

    useEffect(() => {
        setCurrentDescription(task.description || '');
    }, [task.description]);

    const handleToggleTaskItem = useCallback(async (itemIndex: number) => {
        if (!currentDescription) return;

        const parser = new DOMParser();
        const doc = parser.parseFromString(currentDescription, 'text/html');
        const taskItems = doc.querySelectorAll('li[data-type="taskItem"]');

        if (itemIndex < taskItems.length) {
            const item = taskItems[itemIndex];
            const isChecked = item.getAttribute('data-checked') === 'true';
            item.setAttribute('data-checked', isChecked ? 'false' : 'true');

            const newHtml = doc.body.innerHTML;
            const originalHtml = currentDescription;
            setCurrentDescription(newHtml);

            const newProgress = countCheckboxesFromHtml(newHtml);

            const updateData: Partial<Tables<'tasks'>> = {
                description: newHtml,
                checklist_progress: newProgress as unknown as Json
            };

            const result = await updateSimpleTask(task.id, updateData);

            if (result.error) {
                toast.error("No s'ha pogut actualitzar el checkbox.");
                setCurrentDescription(originalHtml);
            } else {
                onTaskMutation();
            }
        }
    }, [task.id, currentDescription, onTaskMutation]);

    let taskItemIndex = -1;
    // âŒ EL TEU CODI ACTUAL
    /*
    const options = {
        replace: (domNode: DOMNode) => {
            if (domNode instanceof Element && domNode.attribs && domNode.attribs['data-type'] === 'taskItem') {
                // ... lÃ²gica de 'taskItem' ...
            }
            return undefined;
        }
    };
    */

    // âœ… CODI CORREGIT (fusionant 'img' i 'taskItem')
    const options = {
        replace: (domNode: DOMNode) => {

            // LÃ’GICA PER A IMATGES (copiada de TaskDetailView)
            if (domNode instanceof Element && domNode.name === 'img') {
                const src = domNode.attribs.src;
                const alt = domNode.attribs.alt;

                if (src && src.includes('task-uploads/')) {
                    return <PrivateImage src={src} alt={alt || 'Imatge de la tasca'} />;
                }
            }

            // LÃ’GICA EXISTENT PER A CHECKBOXES
            if (domNode instanceof Element && domNode.attribs && domNode.attribs['data-type'] === 'taskItem') {
                taskItemIndex++;
                const currentIndex = taskItemIndex;
                const isChecked = domNode.attribs['data-checked'] === 'true';
                const contentDiv = domNode.children.find((child): child is Element => child instanceof Element && child.name === 'div');

                return (
                    <div onClick={(e) => e.stopPropagation()} className="flex items-start gap-3 my-2 first:mt-0 last:mb-0">
                        <Checkbox
                            id={`task-${task.id}-item-${currentIndex}`}
                            checked={isChecked}
                            onCheckedChange={() => handleToggleTaskItem(currentIndex)}
                            className="w-5 h-5 mt-1 flex-shrink-0"
                        />
                        <div className={cn("prose-sm max-w-none", isChecked && "line-through text-muted-foreground")}>
                            {contentDiv && domToReact(contentDiv.children as DOMNode[], options)}
                        </div>
                    </div>
                );
            }

            // No cal `return undefined;`, 'html-react-parser' ho gestiona
        }
    };

    return (
        <Collapsible
            open={isOpen}
            onOpenChange={setIsOpen}
            className={cn(
                "relative rounded-lg border-l-4 shadow-md transition-all duration-300 group",
                "bg-[var(--user-color-soft)] border-[var(--user-color-main)] dark:bg-[var(--user-color-dark-soft)]",
                task.is_completed && 'bg-gray-100 dark:bg-gray-800/50 opacity-70'
            )}
            style={cardStyle}
        >
            <div className="flex items-center gap-3 p-3" onClick={() => !isOpen && onViewTask(task)}>
                <Checkbox
                    id={`task-${task.id}`}
                    // L'estat `checked` depÃ¨n de si la tasca estÃ  completada o si estÃ  assignada (pas intermedi)
                    checked={task.is_completed || !!task.user_asign_id}
                    // âœ… Canvi: Passem la tasca sencera a la funciÃ³ onToggleTask
                    onCheckedChange={() => onToggleTask(task)}
                    onClick={(e) => e.stopPropagation()}
                    className="w-5 h-5"
                />
                <div className="flex-1 min-w-0 cursor-pointer" onClick={(e) => { e.stopPropagation(); onViewTask(task); }}>
                    <div className="flex items-center gap-2">
                        <PriorityDot priority={task.priority} />
                        <h3 className={cn("text-md font-semibold leading-tight truncate", task.is_completed && "line-through text-muted-foreground")}>
                            {task.title}
                        </h3>
                    </div>
                </div>
                {showProgress && (
                    <div className="mt-1 flex-shrink-0">
                        <Badge variant="secondary" className="text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 flex items-center">
                            <CheckSquare className="w-3 h-3 mr-1" />
                            {progress.completed} / {progress.total}
                        </Badge>
                    </div>
                )}
                {task.is_active && (
                    <div className="flex items-center gap-1.5 text-green-600 dark:text-green-400 flex-shrink-0">
                        <span className="relative flex h-2.5 w-2.5"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span className="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span></span>
                        <span className="font-mono text-sm font-semibold">{formattedTimer}</span>                    </div>
                )}
                <TooltipProvider delayDuration={150}>
                    <Tooltip>
                        <TooltipTrigger onClick={(e) => e.stopPropagation()}><Avatar className="w-8 h-8 border-2 border-white dark:border-slate-800"><AvatarImage src={task.profiles?.avatar_url || undefined} /><AvatarFallback className="text-xs font-bold">{task.profiles ? task.profiles.full_name?.charAt(0) : <UserIcon className="w-4 h-4" />}</AvatarFallback></Avatar></TooltipTrigger>
                        <TooltipContent><p>{task.profiles ? `Assignat a ${task.profiles.full_name}` : 'Sense assignar'}</p></TooltipContent>
                    </Tooltip>
                </TooltipProvider>
                <CollapsibleTrigger asChild onClick={(e) => e.stopPropagation()}>
                    <Button variant="ghost" size="icon" className="w-8 h-8">
                        <ChevronDown className={cn("w-5 h-5 transition-transform", isOpen && "rotate-180")} />
                    </Button>
                </CollapsibleTrigger>
            </div>

            <CollapsibleContent>
                <div className="border-t-2 border-black/5 dark:border-white/5 p-4 space-y-3">
                    {currentDescription && (
                        <div className="prose dark:prose-invert prose-sm max-w-none text-muted-foreground">
                            {(() => { taskItemIndex = -1; return parse(currentDescription, options); })()}
                        </div>
                    )}
                    <div className="flex items-center justify-between mt-3 border-t pt-3">
                        <div className="flex items-center gap-4 flex-wrap">
                            {task.contacts && <MetaItem icon={ContactIcon} text={task.contacts.nom} />}
                            {task.departments && <MetaItem icon={Building} text={task.departments.name} />}
                        </div>
                        {dueDate && (
                            <MetaItem
                                icon={Calendar}
                                text={format(dueDate, "d MMM", { locale: es })}
                                className={cn('font-semibold flex-shrink-0', { 'text-red-600 dark:text-red-400': isOverdue, 'text-orange-600 dark:text-orange-400': isToday(dueDate) })}
                            />
                        )}
                    </div>
                </div>
            </CollapsibleContent>
        </Collapsible>
    );
}

// =================== FILE: src/app/[locale]/(app)/dashboard/_components/AIOracle.tsx ===================

/**
 * @file AIOracle.tsx
 * @summary Component de servidor aÃ¯llat que carrega i mostra les dades de la IA,
 * ara amb disseny adaptable i traduccions.
 */
import { createClient } from '@/lib/supabase/server';
import { Button } from '@/components/ui/button';
import { getTranslations } from 'next-intl/server'; // âœ… Importem la funciÃ³ de traducciÃ³ del servidor

export async function AIOracle() {
  // âœ… Obtenim les traduccions per a aquest component
  const t = await getTranslations('DashboardClient.aiOracle');
  const supabase = createClient()
;

  try {
    const { data: aiInsights, error } = await supabase.functions.invoke('generate-ai-summary');

    if (error) throw error;

    const summary = aiInsights?.summary || t('noSummary');
    const suggestion = aiInsights?.suggestion || t('noSuggestion');

    return (
      // âœ… CORRECCIÃ“: Usem 'bg-card' i 'ring-border' per adaptar-se al tema.
      <div className="rounded-2xl p-6 ring-1 ring-border bg-card">
        <h2 className="text-xl font-bold text-foreground mb-3">{t('title')}</h2>
        <div className="space-y-3">
          {/* âœ… CORRECCIÃ“: Usem 'bg-muted' i colors de text semÃ ntics. */}
          <div className="p-3 rounded-lg bg-muted ring-1 ring-border">
            <p className="text-sm font-semibold text-foreground mb-1">{t('summary')}</p>
            <p className="text-sm text-muted-foreground">{summary}</p>
          </div>
          <div className="p-3 rounded-lg bg-muted ring-1 ring-border">
            <p className="text-sm font-semibold text-foreground mb-1">{t('suggestion')}</p>
            <p className="text-sm text-muted-foreground">{suggestion}</p>
          </div>
          <Button variant="outline" className="w-full">{t('button')}</Button>
        </div>
      </div>
    );
  } catch (error) {
    console.error("Error al invocar la funciÃ³ de IA:", error);
    
    return (
      // âœ… CORRECCIÃ“: Usem colors de 'destructive' per a l'estat d'error.
      <div className="rounded-2xl p-6 ring-1 ring-destructive/30 bg-destructive/10">
        <h2 className="text-xl font-bold text-destructive-foreground mb-3">{t('title')}</h2>
        <div className="p-3 rounded-lg bg-destructive/10">
          <p className="text-sm font-semibold text-destructive-foreground mb-1">{t('errorTitle')}</p>
          <p className="text-sm text-destructive-foreground/80">{t('loadError')}</p>
        </div>
      </div>
    );
  }
}

// =================== FILE: src/app/[locale]/(app)/dashboard/_components/AIOracleSkeleton.tsx ===================

"use client";
import { Button } from '@/components/ui/button';

/**
 * @summary Esquelet de cÃ rrega per a l'Oracle d'IA.
 */
export function AIOracleSkeleton() {
  return (
    <div className="rounded-2xl p-6 ring-1 ring-white/10 bg-gradient-to-br from-white/10 to-white/5 animate-pulse">
      <h2 className="text-xl font-bold text-white mb-3">Oracle dâ€™IA</h2>
      <div className="space-y-3">
        <div className="p-3 rounded-lg bg-white/5 ring-1 ring-white/10">
          <p className="text-sm font-semibold text-white/90 mb-1">Resum</p>
          <div className="h-4 w-3/4 rounded bg-white/10"></div>
        </div>
        <div className="p-3 rounded-lg bg-white/5 ring-1 ring-white/10">
          <p className="text-sm font-semibold text-white/90 mb-1">Suggeriment</p>
          <div className="h-4 w-full rounded bg-white/10 mb-1"></div>
          <div className="h-4 w-1/2 rounded bg-white/10"></div>
        </div>
        <Button variant="outline" className="w-full" disabled>Parlar amb lâ€™assistent</Button>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/dashboard/_components/DashboardData.tsx ===================

// src/app/[locale]/(app)/dashboard/_components/DashboardData.tsx

import React from 'react';
import { validatePageSession } from '@/lib/supabase/session';
import { DashboardClient } from '../dashboard-client';

// âœ… 1. Importem el nostre SERVEI principal
import { getDashboardInitialData } from '@/lib/services/dashboard/dashboard.service';

// âœ… 2. Importem els tipus que el CLIENT necessitarÃ  (ara sÃ­ que s'exporten)
import type { 
    DashboardInitialData, 
    EnrichedTask, 
    EnrichedQuote, 
    EnrichedEmail 
} from '@/lib/services/dashboard/dashboard.service';
import type { Tables } from '@/types/supabase';

// âœ… 3. Re-exportem els tipus per al DashboardClient
export type { 
    DashboardInitialData, 
    EnrichedTask, 
    EnrichedQuote, 
    EnrichedEmail 
};
export type TeamMember = Tables<'team_members_with_profiles'>;

// âœ… 4. CORRECCIÃ“: Creem un objecte de dades buit per als casos d'error
// AixÃ² satisfÃ  el 'DashboardClient' que no accepta 'null'.
const defaultEmptyData: DashboardInitialData = {
    stats: {
        totalContacts: 0, activeClients: 0, opportunities: 0, invoiced: 0,
        pending: 0, expenses: 0, invoicedChange: '0%', expensesChange: '0%',
        invoicedIsPositive: true, expensesIsPositive: true,
    },
    tasks: [],
    departments: [],
    contacts: [],
    overdueInvoices: [],
    attentionContacts: [],
    notifications: [],
    recentActivities: [],
    recentQuotes: [],
    recentEmails: [],
    teamMembers: [],
};


export async function DashboardData({ children }: { children: React.ReactNode }) {
Â  Â  // 1. ValidaciÃ³ de sessiÃ³
Â  Â  const session = await validatePageSession();
Â  Â  if ('error' in session) {
Â  Â  Â  Â  console.error("DashboardData: SessiÃ³ invÃ lida.");
Â  Â  Â  Â  return <DashboardClient 
Â  Â  Â  Â  Â  Â  initialData={defaultEmptyData} // âœ… Passem dades buides
Â  Â  Â  Â  Â  Â  teamMembers={[]} 
Â  Â  Â  Â  Â  Â  userId="" 
Â  Â  Â  Â  Â  Â  activeTeamId=""
Â  Â  Â  Â  >
            {children}
        </DashboardClient>;
Â  Â  }
Â  Â  const { supabase, user, activeTeamId } = session;

Â  Â  // 2. UNA SOLA CRIDA al nostre "Cas d'Ãšs"
Â  Â  const { data, error } = await getDashboardInitialData(
Â  Â  Â  Â  supabase,
Â  Â  Â  Â  user,
Â  Â  Â  Â  activeTeamId
Â  Â  );

    // 3. GestiÃ³ d'errors
Â  Â  if (error || !data) {
Â  Â  Â  Â  console.error("Error en carregar DashboardData (Component):", error);
Â  Â  Â  Â  return <DashboardClient 
Â  Â  Â  Â  Â  Â  initialData={defaultEmptyData} // âœ… Passem dades buides
Â  Â  Â  Â  Â  Â  teamMembers={[]} 
Â  Â  Â  Â  Â  Â  userId={user.id} 
Â  Â  Â  Â  Â  Â  activeTeamId={activeTeamId}
Â  Â  Â  Â  >
            {children}
        </DashboardClient>;
Â  Â  }
Â  Â  
Â  Â  // 4. Passem les dades netes al client
Â  Â  return (
Â  Â  Â  Â  <DashboardClient
Â  Â  Â  Â  Â  Â  initialData={data} // El servei ja retorna les dades processades
Â  Â  Â  Â  Â  Â  teamMembers={data.teamMembers} // El servei ja inclou 'teamMembers'
Â  Â  Â  Â  Â  Â  userId={user.id}
Â  Â  Â  Â  Â  Â  activeTeamId={activeTeamId}
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  {children}
Â  Â  Â  Â  </DashboardClient>
Â  Â  );
}

// =================== FILE: src/app/[locale]/(app)/dashboard/_components/DashboardMainGrid.tsx ===================

"use client";

import React, { memo } from "react";
import { SalesPerformance } from "./SalesPerformance";
import { RecentActivities } from "./RecentActivities";
import { Tables } from "@/types/supabase";
// âœ… 1. Importem la funciÃ³ que ja sap com transformar les dades.
import { getRecentActivities } from '@/lib/data/dashboard'; 
// âœ… 2. Importem el tipus de tasca correcte que retorna la funciÃ³ getTasks.
import { EnrichedTask } from '@/components/features/tasks/TaskDialogManager';

interface DashboardMainGridProps {
  stats: {
    invoiced: number;
    expenses: number;
    invoicedChange: string;
    expensesChange: string;
    invoicedIsPositive: boolean;
    expensesIsPositive: boolean;
  };
  percentGoal: number;
  monthlyGoal: number;
  overdueInvoices: (Tables<'invoices'> & { contacts: { nom: string } | null })[];
  // âœ… 3. Assegurem que el tipus de 'tasks' sigui el correcte.
  tasks: EnrichedTask[];
  contacts: Tables<'contacts'>[];
}

export const DashboardMainGrid = memo(
  ({
    stats,
    percentGoal,
    monthlyGoal,
    overdueInvoices,
    tasks,
    contacts,
  }: DashboardMainGridProps) => {

    // âœ… 4. Utilitzem la funciÃ³ importada per generar l'array d'activitats.
    // Aquesta funciÃ³ ja gestiona correctament els tipus, noms de propietats i valors nuls.
    const activities = getRecentActivities(overdueInvoices, tasks, contacts);

    return (
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* ğŸ§­ Rendiment de vendes */}
        <SalesPerformance
          stats={stats}
          percentGoal={percentGoal}
          monthlyGoal={monthlyGoal}
        />

        {/* ğŸ•’ Activitats recents */}
        {/* âœ… 5. Passem l'array 'activities' ja formatat i correctament tipat. */}
        <RecentActivities activities={activities} />
      </div>
    );
  }
);

DashboardMainGrid.displayName = "DashboardMainGrid";

// =================== FILE: src/app/[locale]/(app)/dashboard/_components/DashboardSkeleton.tsx ===================

"use client";

import { cn } from "@/lib/utils/utils";

/**
 * @summary Mostra un esquelet de cÃ rrega que imita el disseny final del Dashboard (4+2).
 */
export function DashboardSkeleton() {
  // Component intern per a reutilitzar la targeta de cÃ rrega
  const SkeletonCard = ({ className, children }: { className?: string, children?: React.ReactNode }) => (
    <div className={cn("rounded-xl border bg-card shadow-lg overflow-hidden", className)}>
      <div className="h-14 p-4 bg-muted animate-pulse" />
      <div className="p-6">{children}</div>
    </div>
  );

  // Component intern per a les lÃ­nies de text
  const SkeletonLine = ({ className }: { className?: string }) => (
    <div className={cn("h-4 bg-muted rounded-md animate-pulse", className)} />
  );

  return (
    <div className="relative w-full p-4 lg:p-6">
      <div className="absolute inset-0 -z-10 bg-background bg-[radial-gradient(theme(colors.gray.300)_1px,transparent_1px)] dark:bg-[radial-gradient(theme(colors.slate.800)_1px,transparent_1px)] [background-size:16px_16px]" />

      <div className="flex flex-col gap-6">
        
        {/* --- FILA SUPERIOR: ESQUELET DE LES 4 TARGETES D'INFORMACIÃ“ --- */}
        <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6">
          
          {/* Esquelet per a Pressupostos / Safata / Activitats / Radar */}
          <SkeletonCard className="h-96">
            <div className="space-y-3">
              <SkeletonLine className="h-10 w-full" />
              <SkeletonLine className="h-10 w-full" />
              <SkeletonLine className="h-10 w-full" />
              <SkeletonLine className="h-10 w-full" />
              <SkeletonLine className="h-10 w-full" />
            </div>
          </SkeletonCard>
          <SkeletonCard className="h-96">
            <div className="space-y-3">
              <SkeletonLine className="h-10 w-full" />
              <SkeletonLine className="h-10 w-full" />
              <SkeletonLine className="h-10 w-full" />
              <SkeletonLine className="h-10 w-full" />
              <SkeletonLine className="h-10 w-full" />
            </div>
          </SkeletonCard>
          <SkeletonCard className="h-96">
            <div className="space-y-3">
              <SkeletonLine className="h-10 w-full" />
              <SkeletonLine className="h-10 w-full" />
              <SkeletonLine className="h-10 w-full" />
              <SkeletonLine className="h-10 w-full" />
              <SkeletonLine className="h-10 w-full" />
            </div>
          </SkeletonCard>
          <SkeletonCard className="h-96">
            <div className="space-y-3">
              <SkeletonLine className="h-10 w-full" />
              <SkeletonLine className="h-10 w-full" />
              <SkeletonLine className="h-10 w-full" />
              <SkeletonLine className="h-10 w-full" />
              <SkeletonLine className="h-10 w-full" />
            </div>
          </SkeletonCard>

        </div>

        {/* --- FILA INFERIOR: ESQUELET DE LES 2 TARGETES DE TREBALL --- */}
        <div className="grid grid-cols-1 lg:grid-cols-5 gap-6">
          
          {/* Esquelet per a SalesPerformance */}
          <div className="lg:col-span-2">
            <SkeletonCard>
              <div className="space-y-4">
                <div className="grid grid-cols-3 gap-4">
                    <div className="h-20 col-span-1 bg-muted rounded-lg"></div>
                    <div className="h-20 col-span-2 bg-muted rounded-lg"></div>
                </div>
                <SkeletonLine className="w-full h-3" />
              </div>
            </SkeletonCard>
          </div>

          {/* Esquelet per a l'Agenda */}
          <div className="lg:col-span-3">
            <SkeletonCard>
              <div className="space-y-4">
                <div className="flex gap-2">
                  <SkeletonLine className="w-1/3 h-8" />
                  <SkeletonLine className="w-1/3 h-8" />
                  <SkeletonLine className="w-1/3 h-8" />
                </div>
                <SkeletonLine className="h-8" />
                <div className="pt-4 space-y-3">
                  <SkeletonLine className="h-12" />
                  <SkeletonLine className="h-12" />
                  <SkeletonLine className="h-12" />
                </div>
              </div>
            </SkeletonCard>
          </div>
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/dashboard/_components/QuickAccess.tsx ===================

/**
 * @file QuickAccess.tsx
 * @summary Renderitza la secciÃ³ d'accÃ©s rÃ pid amb scroll horitzontal.
 */
"use client";

import React, { useRef, useState, useEffect, FC, ElementType } from 'react';
import Link from 'next/link';
import { useTranslations } from 'next-intl';
import { Button } from '@/components/ui/button';
import { Sparkles, Users, Workflow, FileText, FolderOpen, Mail, BookOpen, ChevronLeft, ChevronRight } from 'lucide-react';

/**
 * @summary Targeta petita per a un enllaÃ§ d'accÃ©s rÃ pid.
 */
const QuickTile: FC<{ href: string; icon: ElementType; label: string; desc: string; }> = ({ href, icon: Icon, label, desc }) => (
  <Link href={href} className="group flex-shrink-0 w-1/2 sm:w-1/3 md:w-1/4 lg:w-1/6">
    {/* âœ… CORRECCIÃ“: Usem 'bg-muted/50' y 'hover:bg-muted' que funcionen en ambos temas */}
    <div className="rounded-2xl px-4 py-5 bg-muted/50 hover:bg-muted transition ring-1 ring-border h-full">
      <div className="flex items-center gap-3">
        <div className="rounded-xl bg-gradient-to-br from-primary/20 to-transparent p-2.5">
          <Icon className="w-5 h-5 text-primary" />
        </div>
        <div>
          <div className="font-semibold text-card-foreground">{label}</div>
          <div className="text-xs text-muted-foreground">{desc}</div>
        </div>
      </div>
    </div>
  </Link>
);

export function QuickAccess() {
  const t = useTranslations('DashboardClient');
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const [canScrollLeft, setCanScrollLeft] = useState(false);
  const [canScrollRight, setCanScrollRight] = useState(true);

  const checkScrollability = () => {
    const el = scrollContainerRef.current;
    if (el) {
      setCanScrollLeft(el.scrollLeft > 5);
      setCanScrollRight(el.scrollLeft < el.scrollWidth - el.clientWidth - 5);
    }
  };

  const handleScroll = (direction: 'left' | 'right') => {
    const el = scrollContainerRef.current;
    if (el) {
      const scrollAmount = el.clientWidth * 0.8;
      el.scrollBy({ left: direction === 'left' ? -scrollAmount : scrollAmount, behavior: 'smooth' });
    }
  };

  useEffect(() => {
    const el = scrollContainerRef.current;
    if (el) {
      checkScrollability();
      el.addEventListener('scroll', checkScrollability);
      window.addEventListener('resize', checkScrollability);
      return () => {
        el.removeEventListener('scroll', checkScrollability);
        window.removeEventListener('resize', checkScrollability);
      };
    }
  }, []);
  
  return (
    <div className="rounded-2xl p-6 ring-1 ring-border bg-card">
    <div className="flex items-center justify-between gap-2 mb-4">
      <div className='flex items-center gap-2'>
        <Sparkles className="w-5 h-5 text-pink-400" />
        <h2 className="text-xl font-bold text-foreground">{t('quickAccess')}</h2>
      </div>
        <div className="hidden md:flex items-center gap-2">
          <Button variant="ghost" size="icon" onClick={() => handleScroll('left')} disabled={!canScrollLeft} className="h-8 w-8 rounded-full disabled:opacity-30"><ChevronLeft className="w-5 h-5" /></Button>
          <Button variant="ghost" size="icon" onClick={() => handleScroll('right')} disabled={!canScrollRight} className="h-8 w-8 rounded-full disabled:opacity-30"><ChevronRight className="w-5 h-5" /></Button>
        </div>
      </div>
      <div ref={scrollContainerRef} className="flex gap-4 overflow-x-auto pb-4 -mb-4 scroll-smooth [scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden">
        <QuickTile href="/crm/contactes" icon={Users} label={t('contacts')} desc={t('crm')} />
        <QuickTile href="/crm/pipeline" icon={Workflow} label={t('pipeline')} desc={t('opportunities')} />
        <QuickTile href="/finances/facturacio" icon={FileText} label={t('invoicing')} desc={t('invoices')} />
        <QuickTile href="/finances/despeses" icon={FolderOpen} label={t('expenses')} desc={t('costs')} />
        <QuickTile href="/comunicacio/inbox" icon={Mail} label={t('inbox')} desc={t('communication')} />
        <QuickTile href="/crm/quotes" icon={BookOpen} label={t('quotes')} desc={t('quotes')} />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/dashboard/_components/Radar.tsx ===================

"use client";

import React from 'react';
import { useTranslations } from 'next-intl';
import { FileWarning, MessageSquare, Send, AlertTriangle } from 'lucide-react';
import { ActivityItem } from '@/components/shared/ActivityItem';
import { Tables } from "@/types/supabase";

interface RadarProps {
  attentionContacts: Tables<"contacts">[];
  overdueInvoices: (Tables<'invoices'> & { contacts: { nom: string } | null })[];
  notifications: Tables<"notifications">[];
}

type TranslationFunction = (key: string, values?: Record<string, string | number>) => string;

function formatRelativeTime(dateString: string | null, t: TranslationFunction): string {
  if (!dateString) return '';
  const date = new Date(dateString);
  const now = new Date();
  const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);

  if (diffInSeconds < 60) return t('time.now');
  const diffInMinutes = Math.floor(diffInSeconds / 60);
  if (diffInMinutes < 60) return t('time.minutesAgo', { count: diffInMinutes });
  const diffInHours = Math.floor(diffInMinutes / 60);
  if (diffInHours < 24) return t('time.hoursAgo', { count: diffInHours });
  const diffInDays = Math.floor(diffInHours / 24);
  if (diffInDays === 1) return t('time.yesterday');
  if (diffInDays < 7) return t('time.daysAgo', { count: diffInDays });
  return date.toLocaleDateString();
}

export function Radar({ attentionContacts, overdueInvoices, notifications }: RadarProps) {
  const t = useTranslations('DashboardClient');

  const allItems = [
    ...notifications.map(item => ({ ...item, itemType: 'notification', date: new Date(item.created_at) })),
    ...overdueInvoices.map(item => ({ ...item, itemType: 'invoice', date: new Date(item.due_date ?? 0) })),
    ...attentionContacts.map(item => ({ ...item, itemType: 'contact', date: new Date(item.last_interaction_at || 0) }))
  ];

  allItems.sort((a, b) => b.date.getTime() - a.date.getTime());

  // âœ… CORRECCIÃ“: Eliminem la lÃ­nia que tallava la llista.
  // const visibleItems = allItems.slice(0, 6); 

  const hasItems = allItems.length > 0;

  return (
    <div className="space-y-3 -mr-2 pr-2 overflow-y-auto max-h-[480px]">
      {!hasItems ? (
        <div className="flex items-center justify-center h-48">
          <p className="text-sm text-muted-foreground text-center">{t('allInOrder')}</p>
        </div>
      ) : (
        // âœ… CORRECCIÃ“: Iterem sobre la llista COMPLETA ('allItems').
        allItems.map((item) => {
          if (item.itemType === 'notification') {
            const notif = item as Tables<"notifications">;
            const isError = notif.type === 'post_failed' || notif.type === 'integration_expired';
            return (
              <ActivityItem
                key={`notif-${notif.id}`}
                href={notif.type?.includes('integration') ? "/settings/integrations" : "/comunicacio/planificador"}
                icon={isError ? AlertTriangle : Send}
                variant={isError ? "danger" : "success"}
                title={notif.message}
                meta={formatRelativeTime(notif.created_at, t as TranslationFunction)}
              />
            );
          }
          if (item.itemType === 'invoice') {
            const inv = item as Tables<'invoices'> & { contacts: { nom: string } | null };
            return (
              <ActivityItem
                key={`inv-${inv.id}`}
                href="/finances/facturacio"
                icon={FileWarning}
                variant="danger"
                title={t('overdueInvoice', { clientName: inv.contacts?.nom ?? 'client' })}
                meta={t('dueDate', { dueDate: inv.due_date ? new Date(inv.due_date).toLocaleDateString() : t('unknownDueDate') })}
              />
            );
          }
          if (item.itemType === 'contact') {
            const c = item as Tables<"contacts">;
            return (
              <ActivityItem
                key={`contact-${c.id}`}
                href="/crm/contactes"
                icon={MessageSquare}
                variant="info"
                title={t('coolingContact', { contactName: c.nom })}
                meta={t('noInteraction7Days')}
              />
            );
          }
          return null;
        })
      )}
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/dashboard/_components/RecentActivities.tsx ===================

// src/app/[locale]/(app)/dashboard/_components/RecentActivities.tsx

"use client";

import React from 'react';
import { useTranslations } from 'next-intl';
import { ActivityItem } from '@/components/shared/ActivityItem';
import { ServerActivityItem, ServerActivityIcon, ServerActivityVariant } from '@/lib/data/dashboard';import { FileWarning, CheckCircle2, Clock3, Users, LucideIcon } from 'lucide-react';

const iconMap: Record<ServerActivityIcon, LucideIcon> = {
  fileWarning: FileWarning,
  checkCircle: CheckCircle2,
  clock: Clock3,
  users: Users,
};

interface RecentActivitiesProps {
  activities: (ServerActivityItem & { variant?: ServerActivityVariant })[]; // Afegim variant opcional
}

export function RecentActivities({ activities }: RecentActivitiesProps) {
  const t = useTranslations('DashboardClient');

  return (
    // âœ… CORRECCIÃ“: Apliquem una alÃ§ada mÃ xima i activem l'overflow per al scroll.
    // Els valors de padding (pr) i marge (mr) negatiu sÃ³n per amagar la barra de scroll
    // i que nomÃ©s aparegui en fer hover, un truc visual comÃº.
    <div className="space-y-4 max-h-[380px] overflow-y-auto pr-2 -mr-2">
      {activities.length > 0
        ? activities.map((act, idx) => {
          const IconComponent = iconMap[act.icon];
          return <ActivityItem
            key={idx}
            icon={IconComponent}
            title={act.title}
            meta={act.meta}
            href={act.href}
            variant={act.variant || 'default'} // Passem la variant
          />;
        })
        : <p className="text-sm text-muted-foreground">{t('noActivities')}</p>
      }
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/dashboard/_components/RecentEmails.tsx ===================

"use client";

import React from 'react';
import { useTranslations } from 'next-intl';
import { ActivityItem } from '@/components/shared/ActivityItem';
import { Tables } from '@/types/supabase';
import { Inbox, Mail, MailOpen } from 'lucide-react';
import { cn } from '@/lib/utils/utils';

export type EnrichedEmail = Tables<'tickets'> & {
  contacts: { nom: string } | null;
  last_message_at: string; 
};

interface RecentEmailsProps {
  emails: EnrichedEmail[];
}

export function RecentEmails({ emails }: RecentEmailsProps) {
  const t = useTranslations('DashboardClient');

  if (emails.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center h-full text-center">
        <Inbox className="w-12 h-12 text-muted-foreground/50 mb-2" />
        <p className="font-semibold">{t('inbox.emptyTitle')}</p>
        <p className="text-sm text-muted-foreground">{t('inbox.emptySubtitle')}</p>
      </div>
    );
  }

  return (
    // âœ… SOLUCIÃ“ FINAL: Estructura simple que imita 'RecentActivities'.
    // 'h-full' funciona perquÃ¨ el pare ('DashboardCard') tÃ© una alÃ§ada fixa.
    <div className="space-y-4 max-h-[380px] overflow-y-auto pr-2 -mr-2">
      {emails.slice(0, 10).map(email => {
        const messageTime = new Date(email.last_message_at).toLocaleTimeString('ca-ES', {
          hour: '2-digit',
          minute: '2-digit',
        });
        
        const IconComponent = email.status === 'Llegit' ? MailOpen : Mail;

        return (
          <div key={email.id} className={cn(email.status === 'Llegit' && 'opacity-70')}>
            <ActivityItem
              href={`/comunicacio/inbox?ticketId=${email.id}`}
              icon={IconComponent}
              variant="info"
              title={email.subject || '(Sense assumpte)'}
              meta={`${email.contacts?.nom || 'Desconegut'} Â· ${messageTime}`}
            />
          </div>
        );
      })}
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/dashboard/_components/RecentQuotes.tsx ===================

"use client";

import React from 'react';
import { useTranslations } from 'next-intl';
import { cn } from '@/lib/utils/utils';
import Link from 'next/link';
import { Tables } from '@/types/supabase';
import { ArrowUpRight, Check, X, Send } from 'lucide-react';

// Tipus enriquit per als pressupostos amb la informaciÃ³ del contacte
export type EnrichedQuote = Tables<'quotes'> & {
  contacts: { nom: string } | null;
};

interface RecentQuotesProps {
  quotes: EnrichedQuote[];
}

// Sub-component per a les targetes de mÃ¨triques
const QuoteStat = ({ title, value, className }: { title: string, value: number, className: string }) => (
  <div className="flex-1 text-center bg-muted/50 dark:bg-muted/20 p-2 rounded-md">
    <p className="text-2xl font-bold">{value}</p>
    <p className={cn("text-xs font-semibold", className)}>{title}</p>
  </div>
);

// Sub-component per a cada Ã­tem de la llista
const QuoteItem = ({ quote }: { quote: EnrichedQuote }) => {
  const statusConfig = {
    Accepted: { icon: Check, className: "text-green-600 dark:text-green-400" },
    Sent: { icon: Send, className: "text-blue-600 dark:text-blue-400" },
    Declined: { icon: X, className: "text-red-600 dark:text-red-400" },
    Draft: { icon: Send, className: "text-muted-foreground" },
    Invoiced: { icon: Check, className: "text-purple-600 dark:text-purple-400" },
  };
  
  const currentStatus = quote.status as keyof typeof statusConfig;
  const Icon = statusConfig[currentStatus]?.icon || Send;

  return (
    <Link href={`/crm/quotes/${quote.id}`} className="block p-3 -mx-3 rounded-lg hover:bg-muted/50 dark:hover:bg-muted/30 transition-colors">
      <div className="flex items-center justify-between">
        <div>
          <p className="font-semibold text-sm">{quote.contacts?.nom || 'Client desconegut'}</p>
          <p className="text-xs text-muted-foreground">
            # {quote.id} Â· {quote.created_at ? new Date(quote.created_at).toLocaleDateString() : 'Data desconeguda'}
          </p>
        </div>
        <div className="text-right">
          <p className="font-bold text-sm">â‚¬{quote.total?.toLocaleString('es-ES') || '0'}</p>
          <div className={cn("flex items-center justify-end gap-1 text-xs font-semibold", statusConfig[currentStatus]?.className)}>
            <Icon className="w-3 h-3" />
            <span>{quote.status}</span>
          </div>
        </div>
      </div>
    </Link>
  );
};


export function RecentQuotes({ quotes }: RecentQuotesProps) {
  const t = useTranslations('DashboardClient');

  const sentCount = quotes.filter(q => q.status === 'Sent').length;
  const acceptedCount = quotes.filter(q => q.status === 'Accepted').length;
  const declinedCount = quotes.filter(q => q.status === 'Declined').length;

  return (
    <div className="space-y-4">
      <div className="flex gap-2">
        <QuoteStat title="Enviats" value={sentCount} className="text-blue-600 dark:text-blue-400" />
        <QuoteStat title="Acceptats" value={acceptedCount} className="text-green-600 dark:text-green-400" />
        <QuoteStat title="Declinats" value={declinedCount} className="text-red-600 dark:text-red-400" />
      </div>

      <div className="space-y-1">
        {quotes.slice(0, 3).map(quote => (
          <QuoteItem key={quote.id} quote={quote} />
        ))}
      </div>

      {quotes.length > 3 && (
        <Link href="/finances/quotes" className="flex items-center justify-center gap-1 text-sm font-semibold text-primary hover:underline">
          {t('viewAll')} <ArrowUpRight className="w-4 h-4" />
        </Link>
      )}
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/dashboard/_components/SalesPerformance.tsx ===================

"use client";

import { useTranslations } from 'next-intl';
import { cn } from '@/lib/utils/utils';
import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid } from 'recharts';
import { ArrowUp, ArrowDown, Target, Handshake } from 'lucide-react';

// Dades de mostra per la grÃ fica. A la prÃ ctica, vindrien de les teves dades.
const monthlyData = [
  { month: 'Jul', facturat: 28000 },
  { month: 'Ago', facturat: 35000 },
  { month: 'Set', facturat: 41000 },
  { month: 'Oct', facturat: 52000 },
];

interface SalesPerformanceProps {
  stats: {
    invoiced: number;
    expenses: number;
    invoicedChange: string;
    expensesChange: string;
    invoicedIsPositive: boolean;
    expensesIsPositive: boolean;
    opportunities?: number; // KPI afegit
    activeClients?: number; // KPI afegit
  };
  percentGoal: number;
  monthlyGoal: number;
}

interface KPICardProps {
  title: string;
  value: string | number;
  change?: string;
  isPositive?: boolean;
  icon: React.ComponentType<React.SVGProps<SVGSVGElement>>;
}

const KPICard = ({ title, value, change, isPositive, icon: Icon }: KPICardProps) => (
  <div className="rounded-lg p-4 bg-background/50 border flex flex-col justify-between">
    <div>
      <div className="flex items-center text-xs text-muted-foreground"><Icon className="w-4 h-4 mr-2" /><span>{title}</span></div>
      <div className="text-2xl font-bold text-foreground mt-2">{value}</div>
    </div>
    {change && (
       <div className={cn(
         "text-xs font-medium mt-1 flex items-center",
         // âœ… CORRECCIÃ“ DARK MODE
         isPositive ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'
       )}>
         {isPositive ? <ArrowUp className="w-3 h-3 mr-1" /> : <ArrowDown className="w-3 h-3 mr-1" />}
         {change}
       </div>
    )}
  </div>
);

export function SalesPerformance({ stats, percentGoal, monthlyGoal }: SalesPerformanceProps) {
  const t = useTranslations('DashboardClient');

  return (
    <div className="flex flex-col gap-8">
      {/* SecciÃ³ Superior: Objectiu i KPIs principals */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="md:col-span-1 flex flex-col gap-4">
          <KPICard title={t('invoicedMonth')} value={`â‚¬${stats.invoiced.toLocaleString()}`} change={stats.invoicedChange} isPositive={stats.invoicedIsPositive} icon={Target} />
          <KPICard title={t('netProfit')} value={`â‚¬${(stats.invoiced - stats.expenses).toLocaleString()}`} icon={Handshake} />
        </div>
        <div className="md:col-span-2 rounded-lg p-4 bg-background/50 border">
            <h3 className="text-sm font-medium text-muted-foreground mb-2">{t('monthlyEvolution')}</h3>
            <div style={{ width: '100%', height: 180 }}>
              <ResponsiveContainer>
                <BarChart
                  data={monthlyData}
                  margin={{ top: 10, right: 10, left: -20, bottom: 0 }}
                >
                  <CartesianGrid
                  strokeDasharray="3 3"
                  vertical={false}
                  stroke="hsl(var(--border))"
                  />
                  <XAxis
                  dataKey="month"
                  fontSize={12}
                  tickLine={false}
                  axisLine={false}
                  />
                  <YAxis
                  fontSize={12}
                  tickLine={false}
                  axisLine={false}
                  tickFormatter={(value: number) => `â‚¬${Number(value) / 1000}k`}
                  />
                  <Tooltip
                  cursor={{ fill: 'hsl(var(--muted))' }}
                  contentStyle={{
                    backgroundColor: 'hsl(var(--background))',
                    border: '1px solid hsl(var(--border))',
                    borderRadius: '0.5rem',
                  } as React.CSSProperties}
                  />
                  <Bar
                  dataKey="facturat"
                  fill="hsl(var(--primary))"
                  radius={[4, 4, 0, 0] as [number, number, number, number]}
                  />
                </BarChart>
              </ResponsiveContainer>
            </div>
        </div>
      </div>
      
       {/* Barra de ProgrÃ©s */}
       <div>
        <div className="flex items-center justify-between text-sm text-muted-foreground mb-1">
          <span>{t('goalProgress')}</span>
          <span><strong className="text-foreground">â‚¬{stats.invoiced?.toLocaleString()}</strong> / â‚¬{monthlyGoal.toLocaleString()}</span>
        </div>
        <div className="w-full h-3 rounded-full bg-muted overflow-hidden">
          <div 
            className="h-full rounded-full bg-gradient-to-r from-blue-400 to-blue-600 transition-all duration-700 ease-out" 
            style={{ width: `${percentGoal}%` }} 
          />
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/dashboard/_components/StatCardsGrid.tsx ===================

"use client";

import React, { memo } from "react";
import { useTranslations } from "next-intl";
import { StatCard } from "@/components/shared/StatCard";
import { Users, Target, Euro, BadgePercent } from "lucide-react";

interface StatCardsGridProps {
  stats: {
    totalContacts: number;
    opportunities: number;
    invoiced: number;
    pending: number;
  };
}

export const StatCardsGrid = memo(({ stats }: StatCardsGridProps) => {
  const t = useTranslations("DashboardClient");

  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6">
      <StatCard
        href="/crm/contactes"
        icon={Users}
        title={t("totalContacts")}
        value={stats.totalContacts.toLocaleString()}
        // âœ… CANVI: Passem classes de text
        color="text-blue-500"
        openText={t("openLink")}
      />
      <StatCard
        href="/crm/pipeline"
        icon={Target}
        title={t("activeOpportunities")}
        value={stats.opportunities.toLocaleString()}
        color="text-green-500"
        openText={t("openLink")}
      />
      <StatCard
        href="/finances/facturacio"
        icon={Euro}
        title={t("monthlyInvoicing")}
        value={`â‚¬${stats.invoiced.toLocaleString()}`}
        color="text-violet-500"
        openText={t("openLink")}
      />
      <StatCard
        href="/finances/facturacio"
        icon={BadgePercent}
        title={t("pendingVAT")}
        value={`â‚¬${stats.pending.toLocaleString()}`}
        color="text-orange-500"
        openText={t("openLink")}
      />
    </div>
  );
});

StatCardsGrid.displayName = "StatCardsGrid";

// =================== FILE: src/app/[locale]/(app)/excel/actions.ts ===================

"use server";
import { SupabaseClient } from "@supabase/supabase-js";
import { validateUserSession } from "@/lib/supabase/session";
import ExcelJS from 'exceljs';
import { getTranslations } from 'next-intl/server';

// --- TIPUS COMPARTITS ---
export interface ColumnInfo {
  column_name: string;
  data_type: string;
}

export interface TableDataResult<T> {
  success: true;
  columns: ColumnInfo[];
  rows: T[];
}

export interface ErrorResponse {
  success: false;
  message: string;
}

// Defineix el tipus que representa una fila completa per a la inserciÃ³
type RowToInsert<T extends Record<string, unknown>> = T & {
  team_id: string;
  user_id: string;
};

/**
 * FunciÃ³ per obtenir les metadades de les columnes d'una taula de Supabase.
 * Retorna l'array de columnes i el `selectString` per a la consulta.
 */
async function getTableColumns(supabase: SupabaseClient, tableName: string): Promise<{ columns: ColumnInfo[], selectString: string }> {
  const { data: columnInfo, error: columnError } = await supabase.rpc(
    "get_table_columns_info",
    { p_table_name: tableName }
  );

  if (columnError) {
    throw new Error(`Error obtenint columnes: ${columnError.message}`);
  }

  const columns = (columnInfo ?? []) as ColumnInfo[];
  const selectString = columns.map(c => c.column_name).join(",");

  return { columns, selectString };
}

/**
 * FunciÃ³ per consultar dades d'una taula de Supabase, amb l'opciÃ³ de no tornar-ne cap.
 */
async function getTableRecords<T>(supabase: SupabaseClient, tableName: string, activeTeamId: string, selectString: string, withData: boolean): Promise<T[]> {
  // Si withData Ã©s fals, retornem un array buit directament
  if (!withData) {
    return [];
  }

  const { data, error } = await supabase
    .from(tableName)
    .select(selectString)
    .eq('team_id', activeTeamId)
    .order("created_at", { ascending: false })
    .limit(1000);

  if (error) {
    throw new Error(`Error obtenint dades: ${error.message}`);
  }

  return (data ?? []) as T[];
}

// Tipus genÃ¨ric per a la funciÃ³ principal
export async function exportToExcel<T extends Record<string, unknown>>(tableName: string, withData: boolean) {
  try {
    const t = await getTranslations('excel');
    // 1. ValidaciÃ³ de la sessiÃ³ per obtenir l'usuari i l'equip actiu
    const session = await validateUserSession();
    if ('error' in session) {
      return { success: false, message: session.error.message };
    }
    const { supabase, activeTeamId } = session;

    // 2. Cridem a la funciÃ³ per obtenir les columnes
    const { columns, selectString } = await getTableColumns(supabase, tableName);

    // 3. Cridem a la funciÃ³ per obtenir els registres (o un array buit)
    const records = await getTableRecords<T>(supabase, tableName, activeTeamId, selectString, withData);

    // 4. Creem un nou llibre d'Excel i una pestanya
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet(tableName);

    // 5. Definim les columnes de l'Excel a partir de la informaciÃ³ obtinguda
    const excelColumns = columns.map(col => ({
      header: col.column_name.charAt(0) + col.column_name.slice(1),
      key: col.column_name,
      width: 20,
    }));
    worksheet.columns = excelColumns;

    // 6. Afegim les dades a les files (pot ser un array buit si `withData` Ã©s `false`)
    if (records.length > 0) {
      worksheet.addRows(records);
    }

    // 7. Generem el fitxer Excel en memÃ²ria
    const buffer = await workbook.xlsx.writeBuffer();

    // 8. Retornem el buffer i el nom del fitxer
    const now = new Date();
    const pad = (num: number) => num.toString().padStart(2, '0');
    let fileName = "";
    if (withData) {
      fileName = `${tableName}_${now.getFullYear().toString().slice(-2)}${pad(now.getMonth() + 1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.xlsx`;
    } else {
      fileName = `${t('template')}_${tableName}_${now.getFullYear().toString().slice(-2)}${pad(now.getMonth() + 1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.xlsx`;
    }


    return {
      success: true,
      fileBuffer: Buffer.from(buffer).toString('base64'),
      fileName,
    };
  } catch (error) {
    console.error("Error en exportar a Excel:", error);
    const message = error instanceof Error ? error.message : "Error desconegut";
    return { success: false, message };
  }
}

// --- FUNCIONS PER IMPORTAR A EXCEL ---
export async function validateColumns(excelColumns: string[], dbColumns: ColumnInfo[]) {
  // Convertim els noms de les columnes de la BDD a minÃºscules per a la comparaciÃ³
  const dbColumnNamesLower = dbColumns.map(c => c.column_name.toLowerCase());

  // Convertim els noms de les columnes de l'Excel a minÃºscules per a la comparaciÃ³
  const excelColumnNamesLower = excelColumns.map(c => c.toLowerCase());

  // 1. Validar que la quantitat de columnes sigui la mateixa
  if (excelColumnNamesLower.length !== dbColumnNamesLower.length) {
    console.error(`La quantitat de columnes no coincideix. La BDD tÃ© ${dbColumnNamesLower.length} camps, mentre que l'arxiu tÃ© ${excelColumnNamesLower.length}.`);
    console.error("Camps BDD --> " + dbColumnNamesLower.join(", "));
    console.error("Camps fitxer --> " + excelColumnNamesLower.join(", "));
    return false;
  }

  // 2. Comprovar que cada columna de l'Excel coincideix amb la seva homÃ²loga a la BD, respectant l'ordre i sense distinciÃ³ de majÃºscules/minÃºscules
  for (let i = 0; i < excelColumnNamesLower.length; i++) {
    const dbColumnName = dbColumnNamesLower[i];
    const excelColumnName = excelColumnNamesLower[i];

    if (dbColumnName !== excelColumnName) {
      console.error("L'ordre o els noms de les columnes no coincideixen, o no s'han escrit de la mateixa manera (ignorant majÃºscules/minÃºscules).");
      console.error("Camps BDD --> " + dbColumnNamesLower.join(", "));
      console.error("Camps fitxer --> " + excelColumnNamesLower.join(", "));
      return false;
    }
  }

  // Si arriba aquÃ­, vol dir que tot Ã©s correcte
  return true;
}

export async function importFromExcel<T extends Record<string, unknown>>(tableName: string, formData: FormData) {
  try {
    // 1. ValidaciÃ³ de la sessiÃ³ per obtenir l'usuari i l'equip actiu
    const session = await validateUserSession();
    if ('error' in session) {
      return { success: false, message: session.error.message };
    }
    const { supabase, user, activeTeamId } = session;

    // 2. Cridem a la funciÃ³ per obtenir les columnes
    const { columns } = await getTableColumns(supabase, tableName);

    // 3. Obtenim el fitxer de FormData
    const file = formData.get('file');
    if (!file || typeof file === 'string' || !(file instanceof File)) {
      return { success: false, message: "No s'ha trobat el fitxer Excel." };
    }

    // 4. Convertim el ReadableStream a Buffer per a ExcelJS
    const buffer = await file.arrayBuffer();

    // 5. Llegim el fitxer Excel amb ExcelJS
    const workbook = new ExcelJS.Workbook();
    await workbook.xlsx.load(buffer);
    const worksheet = workbook.getWorksheet(1);
    if (!worksheet) {
      return { success: false, message: "No s'ha pogut llegir el full de cÃ lcul." };
    }

    // 6. Obtenim les capÃ§aleres de l'Excel i validem contra les columnes de la BD
    const excelHeaders = worksheet.getRow(1)?.values as string[];
    if (!excelHeaders || excelHeaders.length === 0) {
      return { success: false, message: "El full de cÃ lcul no tÃ© capÃ§aleres." };
    }
    excelHeaders.shift();

    if (!validateColumns(excelHeaders, columns)) {
      return { success: false, message: "Les columnes de l'arxiu Excel no coincideixen amb les de la base de dades." };
    }

    // 7. Processar les dades i preparar-les per a la inserciÃ³
    const dataToInsert: RowToInsert<T>[] = [];
    worksheet.eachRow((row, rowNumber) => {
      if (rowNumber === 1) return;
      const rowData: Partial<T> = {};
      row.eachCell((cell, colNumber) => {
        const header = excelHeaders[colNumber - 1];
        if (header) {
          rowData[header as keyof Partial<T>] = cell.value as T[keyof T];
        }
      });

      // âœ… Creem un objecte que compleix amb el tipus RowToInsert
      const completeRow: RowToInsert<T> = {
        ...rowData,
        team_id: activeTeamId,
        user_id: user.id
      } as RowToInsert<T>; // Utilitzem l'asserciÃ³ amb el tipus correcte

      dataToInsert.push(completeRow);
    });

    // 8. Inserir les dades a Supabase en lots
    const batchSize = 1000;
    let recordsInserted = 0;
    for (let i = 0; i < dataToInsert.length; i += batchSize) {
      const batch = dataToInsert.slice(i, i + batchSize);
      const { error } = await supabase.from(tableName).insert(batch);
      if (error) {
        console.error("Error en la inserciÃ³ del lot:", error);
        return { success: false, message: `Error en la inserciÃ³ de dades: ${error.message}` };
      }
      recordsInserted += batch.length;
    }

    return { success: true, message: `S'han importat ${recordsInserted} registres correctament.` };
  } catch (error) {
    console.error("Error en importar a Excel:", error);
    const message = error instanceof Error ? error.message : "Error desconegut";
    return { success: false, message };
  }
}


// =================== FILE: src/app/[locale]/(app)/excel/ExcelDropdownButton.tsx ===================

import React, { useState, useRef, useEffect } from 'react';
import { FileSpreadsheet } from 'lucide-react';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';

/**
 * Defineix la forma d'una opciÃ³ del desplegable.
 * Ara inclou una icona i un 'label' que actuarÃ  com a tooltip.
 */
export interface DropdownOption {
  value: string;
  label: string;
  icon: React.ElementType;
}

/**
 * Defineix les propietats (props) que rep el component DropdownButton.
 */
interface DropdownButtonProps {
  /** Un array d'opcions per mostrar al menÃº desplegable. */
  options: DropdownOption[];
  /** FunciÃ³ que s'executa quan l'usuari selecciona una opciÃ³. */
  onSelect: (selectedOption: DropdownOption) => void;

  disabled?: boolean; // â¬…ï¸ AFEGEIX AQUESTA LÃNIA

}

/**
 * Un component de UI per a un botÃ³ desplegable que mostra una llista d'opcions.
 */
const DropdownButton: React.FC<DropdownButtonProps> = ({ options, onSelect }) => {
  // Estat per controlar si el menÃº estÃ  obert o tancat.
  const [isOpen, setIsOpen] = useState(false);

  // Ref per al contenidor principal del desplegable.
  const dropdownRef = useRef<HTMLDivElement>(null);

  /**
   * Canvia l'estat d'obertura del menÃº.
   */
  const toggleDropdown = () => {
    setIsOpen(prevIsOpen => !prevIsOpen);
  };

  /**
   * Gestiona el clic en una de les opcions.
   * Crida la funciÃ³ onSelect i tanca el menÃº.
   */
  const handleOptionClick = (option: DropdownOption) => {
    onSelect(option);
    setIsOpen(false);
  };

  // Efecte per tancar el menÃº si l'usuari fa clic fora del component.
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    };

    // Afegim l'event listener quan el component es munta.
    document.addEventListener('mousedown', handleClickOutside);

    // Netegem l'event listener quan el component es desmunta.
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []); // L'array buit assegura que l'efecte nomÃ©s s'executa un cop.

  return (
    <div className="relative inline-block font-sans" ref={dropdownRef}>
      <button
        onClick={toggleDropdown} // Canviem l'estil per a que sigui un botÃ³ d'icona
        className="flex items-center justify-center h-9 px-3 bg-green-700 text-white rounded-md hover:bg-green-800 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500"
        aria-label="Opcions d'Excel"
      >
        <FileSpreadsheet className="h-6 w-6" />
      </button>
      {isOpen && (
        <ul className="absolute block list-none p-1 m-0 mt-2 bg-green-700/25 backdrop-blur-sm border border-green-600 rounded-md shadow-lg z-10">
          <TooltipProvider delayDuration={100}>
            {options.map((option) => (
              <Tooltip key={option.value}>
                <TooltipTrigger asChild>
                  <li
                    className="p-2 rounded-md cursor-pointer hover:bg-white/20"
                    onClick={() => handleOptionClick(option)}
                  >
                    <option.icon className="h-5 w-5 text-white" />
                  </li>
                </TooltipTrigger>
                <TooltipContent side="right" className="bg-green-900/70 text-zinc-50 border-zinc-800">
                  <p>{option.label}</p>
                </TooltipContent>
              </Tooltip>
            ))}
          </TooltipProvider>
        </ul>
      )}
    </div>
  );
};

export default DropdownButton;


// =================== FILE: src/app/[locale]/(app)/finances/expenses/actions.ts ===================

// /app/[locale]/(app)/finances/expenses/actions.ts (FITXER CORREGIT)
'use server';

import {
  type ExpenseWithContact,
} from "@/types/finances/expenses";
import { type ActionResult } from "@/types/shared/index";
import { validateUserSession } from "@/lib/supabase/session";
import { type Expense } from "@/types/finances/expenses";
import { revalidatePath } from "next/cache";
import { 
  type PaginatedActionParams, 
  type PaginatedResponse 
} from '@/hooks/usePaginateResource';

// âœ… 1. Importem ELS DOS NOUS SERVEIS
import * as expensesListService from '@/lib/services/finances/expenses/expenses.service';
import * as expensesDetailService from '@/lib/services/finances/expenses/expenseDetail.service';

// âœ… 2. Importem el tipus NOMÃ‰S PER A ÃšS INTERN
import type { ExpensePageFilters } from '@/lib/services/finances/expenses/expenses.service';

// Definim els tipus que el client necessita
type FetchExpensesParams = PaginatedActionParams<ExpensePageFilters>;
type PaginatedExpensesData = PaginatedResponse<ExpenseWithContact>;
export type ExpenseForSupplier = Partial<Expense>; // Aquest export de tipus local Ã©s correcte

/**
 * ACCIÃ“: ObtÃ© les dades paginades per al client.
 */
export async function fetchPaginatedExpenses(
  params: FetchExpensesParams,
): Promise<PaginatedExpensesData> {
  const session = await validateUserSession();
  if ("error" in session) {
    console.error("Session error in fetchPaginatedExpenses:", session.error);
    return { data: [], count: 0 };
  }
  const { supabase, activeTeamId } = session;

  // ğŸ”´ LOG 6: ParÃ metres rebuts per l'ACCIÃ“ (Consola del Servidor)
  console.log("expenses/actions.ts (fetchPaginatedExpenses): ParÃ metres rebuts:", JSON.stringify(params, null, 2));

  try {
    // âœ… Crida al servei de LLISTA
    const result = await expensesListService.fetchPaginatedExpenses(supabase, activeTeamId, params);
    
    // ğŸ”´ LOG 7: Resultat del SERVEI (Consola del Servidor)
    console.log(`expenses/actions.ts (fetchPaginatedExpenses): Retornant ${result.data.length} files i un count de ${result.count}`);
    return result;

  } catch (error: unknown) {
    // âœ… CORRECCIÃ“: Propaguem l'error a la UI
    const message = (error as Error).message;
    console.error("Error a fetchPaginatedExpenses (action):", message);
    return { data: [], count: 0 };
  }
}

/**
 * ACCIÃ“: Processa un OCR.
 */
export async function processOcrAction(
  formData: FormData,
): Promise<ActionResult<Record<string, unknown>>> {
  const session = await validateUserSession();
  if ("error" in session) {
    return { success: false, message: session.error.message };
  }
  const { supabase } = session;

  try {
    // âœ… Crida al servei de DETALL
    const data = await expensesDetailService.processOcr(supabase, formData);
    return { success: true, message: "Document processat amb Ã¨xit.", data };
  } catch (error: unknown) {
    return { success: false, message: (error as Error).message };
  }
}

/**
 * ACCIÃ“: ObtÃ© despeses per a un proveÃ¯dor.
 */
export async function fetchExpensesForSupplier(supplierId: string) {
  const session = await validateUserSession();
  if ("error" in session) return [];
  const { supabase, activeTeamId } = session;
  
  // âœ… Crida al servei de DETALL
  return await expensesDetailService.fetchExpensesForSupplier(supabase, supplierId, activeTeamId);
}

/**
 * ACCIÃ“: Cerca despeses no vinculades.
 */
export async function searchExpensesForLinking(
  searchTerm: string,
): Promise<
  Pick<Expense, "id" | "description" | "expense_date" | "total_amount">[]
> {
  const session = await validateUserSession();
  if ("error" in session) return [];
  const { supabase, activeTeamId } = session;

  // âœ… Crida al servei de DETALL
  return await expensesDetailService.searchExpensesForLinking(supabase, activeTeamId, searchTerm);
}

/**
 * ACCIÃ“: Vincula una despesa a un proveÃ¯dor.
 */
export async function linkExpenseToSupplier(
  expenseId: number,
  supplierId: string,
): Promise<ActionResult<Expense>> {
  const session = await validateUserSession();
  if ("error" in session) {
    return { success: false, message: session.error.message };
  }
  const { supabase, activeTeamId } = session;

  try {
    // âœ… Crida al servei de DETALL
    const data = await expensesDetailService.linkExpenseToSupplier(supabase, activeTeamId, expenseId, supplierId);
    revalidatePath(`/finances/suppliers/${supplierId}`);
    revalidatePath(`/finances/expenses/${expenseId}`);
    return { success: true, message: "Despesa vinculada.", data };
  } catch (error: unknown) {
    const message = (error as Error).message;
    return { success: false, message };
  }
}

/**
 * ACCIÃ“: Desvincula una despesa d'un proveÃ¯dor.
 */
export async function unlinkExpenseFromSupplier(
  expenseId: number,
  supplierId: string, // Per revalidar
): Promise<ActionResult> {
  const session = await validateUserSession();
  if ("error" in session) {
    return { success: false, message: session.error.message };
  }
  const { supabase, activeTeamId } = session;

  try {
    // âœ… Crida al servei de DETALL
    await expensesDetailService.unlinkExpenseFromSupplier(supabase, activeTeamId, expenseId);
    revalidatePath(`/finances/suppliers/${supplierId}`);
    revalidatePath(`/finances/expenses/${expenseId}`);
    return { success: true, message: "Despesa desvinculada." };
  } catch (error: unknown) {
    const message = (error as Error).message;
    return { success: false, message };
  }
}

/**
 * ACCIÃ“: ObtÃ© categories Ãºniques (gestiona la sessiÃ³).
 */
export async function getUniqueExpenseCategories(): Promise<string[]> {
  const session = await validateUserSession();
  if ("error" in session) {
    console.error("Session error in getUniqueExpenseCategories:", session.error);
    return [];
  }
  const { activeTeamId } = session;

  console.log("expenses/actions.ts (getUniqueExpenseCategories): Cridant al servei...");
  // âœ… Crida al servei de LLISTA
  return await expensesListService.getUniqueExpenseCategories(activeTeamId);
}

// =================== FILE: src/app/[locale]/(app)/finances/expenses/page.tsx ===================

// Exemple a src/app/[locale]/(app)/finances/expenses/page.tsx
import { Suspense } from 'react';
import { ExpensesData } from './_components/ExpensesData';
import { GenericDataTableSkeleton } from '@/components/shared/GenericDataTableSkeleton'; // Importa l'skeleton

export default async function ExpensesPage() {

  // Pots calcular columnCount basant-te en les columnes visibles per defecte o un nombre fix
  const defaultColumnCount = 7; // Ajusta segons les teves columnes + accions

  return (
    <div className="h-full"> {/* Assegura't que el contenidor tÃ© alÃ§ada */}
      <Suspense fallback={<GenericDataTableSkeleton columnCount={defaultColumnCount} rowCount={10} />}>
        {/* ExpensesData farÃ  la crida asÃ­ncrona */}
        <ExpensesData />
      </Suspense>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/expenses/[expenseId]/actions.ts ===================

// /app/[locale]/(app)/finances/expenses/[expenseId]/actions.ts (SENSE CANVIS, JA Ã‰S CORRECTE)
"use server";

import { revalidatePath } from "next/cache";
import {
  type ExpenseDetail,
  type ExpenseFormDataForAction,
  type ExpenseAttachment,
} from "@/types/finances/expenses";
import { type ActionResult } from "@/types/shared/index";
import { validateUserSession } from "@/lib/supabase/session";
import { createAdminClient } from "@/lib/supabase/admin";

// âœ… Aquest fitxer ja importava del servei de detall correcte
import * as expensesService from "@/lib/services/finances/expenses/expenseDetail.service";

// --- Server Actions PÃºbliques ---

/**
 * ACCIÃ“: ObtÃ© el detall d'una despesa.
 */
export async function fetchExpenseDetail(expenseId: number): Promise<ExpenseDetail | null> {
  const session = await validateUserSession();
  if ("error" in session) return null;
  const { supabase, activeTeamId } = session;

  try {
    return await expensesService.fetchExpenseDetail(supabase, expenseId, activeTeamId);
  } catch (error) {
    console.error("Error fetching expense detail (action):", error);
    return null;
  }
}

/**
 * ACCIÃ“: Desa una despesa (crea o actualitza).
 */
export async function saveExpenseAction(
  expenseData: ExpenseFormDataForAction,
  expenseId: string | number | null 
): Promise<ActionResult<{ id: number }>> {
  const session = await validateUserSession();
  if ("error" in session) return { success: false, message: session.error.message };
  const { supabase, user, activeTeamId } = session;

  try {
    const { id: resultingExpenseId } = await expensesService.saveExpense(
        supabase,
        expenseData,
        expenseId,
        user.id,
        activeTeamId
    );

    revalidatePath(`/finances/expenses/${resultingExpenseId}`);
    revalidatePath("/finances/expenses"); 

    return { success: true, message: "Despesa desada.", data: { id: resultingExpenseId } };

  } catch (error: unknown) {
    const message = (error as Error).message;
    console.error("Error saving expense (action):", message);
    return { success: false, message };
  }
}

/**
 * ACCIÃ“: Puja un adjunt.
 */
export async function uploadAttachmentAction(
    expenseId: string | number, 
    formData: FormData
): Promise<ActionResult<{ newAttachment: ExpenseAttachment }>> {
  const session = await validateUserSession();
  if ("error" in session) return { success: false, message: session.error.message };
  const { supabase, user, activeTeamId } = session;

  const numericExpenseId = Number(expenseId);
  if (isNaN(numericExpenseId)) {
      return { success: false, message: "ID de despesa invÃ lid." };
  }

  try {
    const newAttachment = await expensesService.uploadAttachment(
        supabase,
        numericExpenseId,
        formData,
        user.id,
        activeTeamId
    );

    revalidatePath(`/finances/expenses/${numericExpenseId}`);
  
    return { success: true, message: "Adjunt pujat.", data: { newAttachment } };

  } catch (error: unknown) {
    const message = (error as Error).message;
    console.error("Error uploading attachment (action):", message);
    return { success: false, message };
  }
}

/**
 * ACCIÃ“: Elimina una despesa.
 */
export async function deleteExpense(expenseId: number): Promise<ActionResult> {
  const session = await validateUserSession();
  if ("error" in session) return { success: false, message: session.error.message };
  const { supabase, activeTeamId } = session;

  try {
    await expensesService.deleteExpense(supabase, expenseId, activeTeamId);
    revalidatePath("/finances/expenses");
    return { success: true, message: `Despesa eliminada correctament.` };
  } catch (error: unknown) {
    const message = (error as Error).message;
    return { success: false, message };
  }
}

/**
 * ACCIÃ“: ObtÃ© una URL signada per a un adjunt.
 */
export async function getAttachmentSignedUrl(filePath: string): Promise<ActionResult<{ signedUrl: string }>> {
  const session = await validateUserSession();
  if ("error" in session) return { success: false, message: session.error.message };
  const { activeTeamId } = session;

  try {
    const signedUrl = await expensesService.getAttachmentSignedUrl(filePath, activeTeamId);
    return { success: true, message: "URL signada generada.", data: { signedUrl } };
  } catch (error: unknown) {
    const message = (error as Error).message;
    return { success: false, message };
  }
}

/**
 * ACCIÃ“: Elimina un adjunt.
 */
export async function deleteAttachmentAction(
  attachmentId: string, 
  filePath: string
): Promise<ActionResult> {
  const session = await validateUserSession();
  if ("error" in session) return { success: false, message: session.error.message };
  const { supabase, activeTeamId } = session;
  
  const supabaseAdmin = createAdminClient();

  try {
    await expensesService.deleteAttachment(
        supabase,
        supabaseAdmin,
        attachmentId,
        filePath,
        activeTeamId
    );
    return { success: true, message: "Adjunt eliminat correctament." };
  } catch (error: unknown) {
    const message = (error as Error).message;
    return { success: false, message };
  }
}

// =================== FILE: src/app/[locale]/(app)/finances/expenses/[expenseId]/page.tsx ===================

import { Suspense } from 'react';
import { ExpenseDetailData } from './_components/ExpenseDetailData';
import { ExpenseDetailSkeleton } from './_components/ExpenseDetailSkeleton';

// -------------------------------------------------------------------
// âœ… CORRECCIÃ“: Definim la interfÃ­cie localment amb 'params' com a Promise
//    en lloc d'importar un tipus genÃ¨ric que causa conflictes.
// -------------------------------------------------------------------
interface ExpenseDetailPageProps {
  params: Promise<{
    locale: string;
    expenseId: string;
  }>;
}

/**
 * Component de la pÃ gina de detall d'una despesa.
 */
// -------------------------------------------------------------------
// âœ… CORRECCIÃ“: El component esdevÃ© 'async' i espera 'props.params'
// -------------------------------------------------------------------
export default async function ExpenseDetailPage(props: ExpenseDetailPageProps) {
  
  // Resolem la promesa per obtenir els parÃ metres
  const { expenseId } = await props.params;

  return (
    <Suspense fallback={<ExpenseDetailSkeleton />}>
      {/* Passem l'ID ja resolt al component de dades.
        No cal embolcallar-ho en un objecte { params: ... } si el component fill
        nomÃ©s espera l'ID directament. AixÃ² fa el codi mÃ©s net.
        (He ajustat <ExpenseDetailData> per reflectir aixÃ²)
      */}
      <ExpenseDetailData expenseId={expenseId} />
    </Suspense>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/expenses/[expenseId]/_components/AttachmentUploader.tsx ===================

import { useRef, useTransition } from 'react';
import { uploadAttachmentAction } from '../actions'; // La teva acciÃ³ de pujada
import { toast } from 'sonner';
import { useTranslations } from 'next-intl';

export default function AttachmentUploader({ expenseId }: { expenseId: number | string }) {
    const fileInputRef = useRef<HTMLInputElement>(null);
    const [isUploading, startTransition] = useTransition();
    const t = useTranslations('ExpenseDetail.attachments'); // O el context correcte

    const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {
        const file = event.target.files?.[0];
        if (!file) return;

        // Reset input per poder pujar el mateix fitxer de nou
        if (fileInputRef.current) {
            fileInputRef.current.value = '';
        }

        startTransition(async () => {
            const formData = new FormData();
            formData.append('file', file);

            // Cridem l'acciÃ³ de pujada
            const result = await uploadAttachmentAction(String(expenseId), formData);

            if (result.success) {
                toast.success(result.message || t('uploadSuccess'));
                // AquÃ­ hauries de refrescar les dades o actualitzar l'estat local
                // router.refresh(); // O una manera mÃ©s optimitzada
            } else {
                toast.error(result.message || t('uploadError'));
            }
        });
    };

    const triggerFileInput = () => {
        fileInputRef.current?.click();
    };

    return (
        <div>
            {/* Input ocult */}
            <input
                type="file"
                ref={fileInputRef}
                onChange={handleFileSelect}
                style={{ display: 'none' }}
                disabled={isUploading}
            />

            {/* Ã€rea clicable */}
            <div 
                className="border-2 border-dashed p-4 text-center rounded-lg cursor-pointer hover:border-primary"
                onClick={triggerFileInput} // <-- Activa l'input en fer clic
            >
                {isUploading ? (
                    <p>{t('uploading')}</p> 
                ) : (
                    <p className="text-sm text-muted-foreground">{t('upload.dragAndDrop')}</p>
                )}
            </div>
            
            {/* Llista d'adjunts existents (ExpenseAttachmentCard) */}
            {/* ... */}
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/finances/expenses/[expenseId]/_components/ExpenseAttachmentCard.tsx ===================

"use client";

import { type ExpenseAttachment } from '@/types/finances/expenses';
import { Button } from '@/components/ui/button';
import { Download, Trash2, FileText, Loader2 } from 'lucide-react'; // 'AlertTriangle' no s'utilitza aquÃ­, es pot treure
import { useTransition } from 'react';
import { toast } from 'sonner';
import { getAttachmentSignedUrl, deleteAttachmentAction } from '../actions';

// âœ… CORRECCIÃ“: La importaciÃ³ ha de ser 'alert-dialog'
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog"; // <-- Ruta corregida

interface ExpenseAttachmentCardProps {
  attachment: ExpenseAttachment;
  onDeleteSuccess: (attachmentId: string) => void; 
}

export function ExpenseAttachmentCard({ attachment, onDeleteSuccess }: ExpenseAttachmentCardProps) {
  const [isDownloading, startDownloadTransition] = useTransition();
  const [isDeleting, startDeleteTransition] = useTransition();
  
  const handleDownload = () => {
    startDownloadTransition(async () => {
      const result = await getAttachmentSignedUrl(attachment.file_path);
      
      if (result.success && result.data?.signedUrl) {
        // Obrim la URL signada en una nova pestanya
        window.open(result.data.signedUrl, '_blank');
      } else {
        toast.error(result.message || "Error en obtenir l'enllaÃ§ de descÃ rrega.");
      }
    });
  };

  const handleDelete = () => {
    startDeleteTransition(async () => {
      const result = await deleteAttachmentAction(attachment.id, attachment.file_path);
      
      if (result.success) {
        toast.success("Adjunt eliminat correctament.");
        onDeleteSuccess(attachment.id); // Notifiquem al pare
      } else {
        toast.error(result.message || "Error eliminant l'adjunt.");
      }
    });
  };

  return (
    <div className="flex items-center justify-between p-3 border rounded-md bg-muted/50">
      <div className="flex items-center gap-3 overflow-hidden">
        <FileText className="h-6 w-6 text-muted-foreground flex-shrink-0" />
        <div className="flex flex-col overflow-hidden">
          <span className="text-sm font-medium truncate" title={attachment.filename}>
            {attachment.filename}
          </span>
          <span className="text-xs text-muted-foreground">
            {attachment.mime_type}
          </span>
        </div>
      </div>
      <div className="flex items-center gap-2 flex-shrink-0">
        {/* BotÃ³ de DescÃ rrega (amb Server Action) */}
        <Button
          variant="ghost"
          size="icon"
          className="h-8 w-8"
          onClick={handleDownload}
          disabled={isDownloading}
          aria-label={`Descarregar ${attachment.filename}`}
        >
          {isDownloading ? <Loader2 className="h-4 w-4 animate-spin" /> : <Download className="h-4 w-4" />}
        </Button>
        
        {/* BotÃ³ d'Esborrar (amb DiÃ leg de ConfirmaciÃ³) */}
        <AlertDialog>
          <AlertDialogTrigger asChild>
            <Button
              variant="ghost"
              size="icon"
              className="h-8 w-8 text-destructive hover:text-destructive"
              disabled={isDeleting}
              aria-label={`Esborrar ${attachment.filename}`}
            >
              {isDeleting ? <Loader2 className="h-4 w-4 animate-spin" /> : <Trash2 className="h-4 w-4" />}
            </Button>
          </AlertDialogTrigger>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>EstÃ s segur?</AlertDialogTitle>
              <AlertDialogDescription>
                Aquesta acciÃ³ no es pot desfer. S'esborrarÃ  permanentment
                el fitxer <span className="font-medium">{attachment.filename}</span>.
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel>CancelÂ·lar</AlertDialogCancel>
              {/* âœ… Assegurem que el botÃ³ d'esborrar tÃ© l'estil correcte */}
              <AlertDialogAction 
                onClick={handleDelete} 
                className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
              >
                Esborrar
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>

      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/expenses/[expenseId]/_components/ExpenseAttachmentUploader.tsx ===================

"use client";

// âœ… 'useState' ja no Ã©s necessari si no guardem els fitxers a l'estat
import { useTransition } from 'react'; 
import { useDropzone } from 'react-dropzone';
import { Loader2, UploadCloud } from 'lucide-react'; // 'X' no s'utilitzava
// import { Button } from '@/components/ui/button'; // 'Button' no s'utilitzava (estava al codi comentat)
import { toast } from 'sonner';
import { uploadAttachmentAction } from '../actions';
import { type ExpenseAttachment } from '@/types/finances/expenses';

interface ExpenseAttachmentUploaderProps {
  expenseId: number; // L'ID de la despesa (ha d'existir)
  onUploadSuccess: (newAttachment: ExpenseAttachment) => void;
}

export function ExpenseAttachmentUploader({
  expenseId,
  onUploadSuccess,
}: ExpenseAttachmentUploaderProps) {
  // âœ… Eliminem l'estat 'files', ja que no el llegim enlloc.
  // const [files, setFiles] = useState<File[]>([]);
  const [isUploading, startUploadTransition] = useTransition();

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    // âœ… Quan s'accepten fitxers (que ja serÃ  de tipus 'File[]' desprÃ©s d'instalÂ·lar),
    // els passem directament a la funciÃ³ de pujada.
    onDrop: (acceptedFiles: File[]) => { // Podem tipar-ho explÃ­citament o deixar que ho infereixi
      // setFiles(acceptedFiles); // <-- Eliminat
      handleUpload(acceptedFiles);
    },
    multiple: true,
  });

  const handleUpload = (filesToUpload: File[]) => {
    if (filesToUpload.length === 0) {
      toast.error("Selecciona almenys un fitxer.");
      return;
    }

    startUploadTransition(async () => {
      let successCount = 0;

      for (const file of filesToUpload) {
        const formData = new FormData();
        formData.append('file', file);

        const result = await uploadAttachmentAction(expenseId, formData);

        if (result.success && result.data?.newAttachment) {
          onUploadSuccess(result.data.newAttachment); // Notifica al pare
          successCount++;
        } else {
          toast.error(`Error pujant ${file.name}: ${result.message}`);
        }
      }

      if (successCount > 0) {
        toast.success(`${successCount} fitxer(s) pujats correctament.`);
      }
      // âœ… Eliminem la neteja de l'estat, ja que no existeix.
      // if (errorCount === 0) {
      //   setFiles([]); 
      // }
    });
  };

  return (
    <div className="space-y-3">
      <div
        {...getRootProps()}
        className={`border-2 border-dashed p-6 text-center rounded-lg cursor-pointer
          ${isDragActive ? 'border-primary bg-primary/10' : 'border-muted-foreground/50'}
          ${isUploading ? 'opacity-50 pointer-events-none' : ''}`}
      >
        <input {...getInputProps()} />
        {isUploading ? (
          <div className="flex flex-col items-center gap-2">
            <Loader2 className="w-8 h-8 animate-spin text-primary" />
            <p className="text-sm text-muted-foreground">Pujant fitxers...</p>
          </div>
        ) : (
          <div className="flex flex-col items-center gap-2">
            <UploadCloud className="w-8 h-8 text-muted-foreground" />
            <p className="text-sm text-muted-foreground">
              {isDragActive
                ? "Deixa anar els fitxers aquÃ­"
                : "Arrossega fitxers aquÃ­, o fes clic per seleccionar"}
            </p>
          </div>
        )}
      </div>

      {/* Si en el futur vols activar aquesta vista prÃ¨via, 
        haurÃ s de tornar a afegir el 'useState<File[]>' 
        i el 'setFiles(acceptedFiles)' al 'onDrop'. 
        En fer-ho, l'error 'ts(6133)' desapareixerÃ  sol.
      */}
      {/* {files.length > 0 && !isUploading && (
         <div className="space-y-2">
           {files.map(file => (
             <div key={file.name} className="...">...</div>
           ))}
           <Button onClick={() => handleUpload(files)} disabled={isUploading}>
             {isUploading ? 'Pujant...' : `Pujar ${files.length} fitxer(s)`}
           </Button>
         </div>
       )}
      */}
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/expenses/[expenseId]/_components/ExpenseDetailClient.tsx ===================

"use client";

import React, { useState } from 'react';
import { useSearchParams, useRouter } from 'next/navigation'; // âœ… Importem hooks
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Loader2, Plus, Save, FileText, AlertTriangle, ArrowLeft } from 'lucide-react'; // âœ… Afegim ArrowLeft
import { type ExpenseDetail, type ExpenseAttachment } from '@/types/finances/expenses';
import { useExpenseDetail } from '../_hooks/useExpenseDetail';
import { ExpenseItemsEditor } from './ExpenseItemsEditor';
import { ExpenseAttachmentCard } from './ExpenseAttachmentCard';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';
import { SupplierCombobox } from '@/components/shared/SupplierCombobox';
import { ExpenseAttachmentUploader } from './ExpenseAttachmentUploader';
import { AlertDialog, AlertDialogDescription, AlertDialogTitle } from "@/components/ui/alert-dialog";

interface ExpenseDetailClientProps {
    initialData: ExpenseDetail | null;
    isNew: boolean;
}

export function ExpenseDetailClient({ initialData, isNew }: ExpenseDetailClientProps) {
    const router = useRouter(); // âœ… Hook router
    const searchParams = useSearchParams(); // âœ… Hook searchParams
    const fromUrl = searchParams.get('from'); // âœ… Llegim el parÃ metre 'from'

    const {
        isPending,
        formData,
        handleFieldChange,
        handleSubmit,
        handleItemChange,
        handleAddItem,
        handleRemoveItem,
        t,
    } = useExpenseDetail({ initialData, isNew });

    const [attachments, setAttachments] = useState<ExpenseAttachment[]>(
        initialData?.expense_attachments || []
    );

    const isSaving = isPending;
    const expenseTitle = isNew
        ? t('title.new')
        : formData.invoice_number || `Despesa #${initialData?.id}`;

    const locale = 'ca'; 

    const handleUploadSuccess = (newAttachment: ExpenseAttachment) => {
        setAttachments((prev) => [...prev, newAttachment]);
    };

    const handleDeleteSuccess = (attachmentId: string) => {
        setAttachments((prev) => prev.filter(att => att.id !== attachmentId));
    };

    // âœ… Nova funciÃ³ per gestionar el botÃ³ de Tornar/CancelÂ·lar
    const handleBackOrCancel = () => {
        // En aquest formulari, "CancelÂ·lar" simplement significa "Tornar"
        if (fromUrl) {
            router.push(fromUrl); // Si venim de 'from', tornem allÃ 
        } else {
            router.push('/finances/expenses'); // Altrament, tornem al llistat general
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-8">
            {/* CapÃ§alera: TÃ­tol i Accions */}
            <div className="flex justify-between items-center">
                {/* âœ… BotÃ³ de Tornar/CancelÂ·lar actualitzat */}
                <div className="flex items-center gap-4">
                     <Button
                        type="button" // Important que no sigui submit
                        variant="outline"
                        size="icon"
                        onClick={handleBackOrCancel}
                        disabled={isSaving}
                        aria-label={"Tornar"}
                    >
                       <ArrowLeft className="h-4 w-4" />
                    </Button>
                    <h1 className="text-3xl font-bold">{expenseTitle}</h1>
                </div>

                <div className="flex space-x-3">
                    <Button type="submit" disabled={isSaving}>
                        {isSaving ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Save className="w-4 h-4 mr-2" />}
                        {isSaving ? t('button.saving') : t('button.save')}
                    </Button>
                    {/* âŒ Eliminem el botÃ³ de CancelÂ·lar antic, ja tenim el botÃ³ <ArrowLeft /> */}
                </div>
            </div>

            {/* Contingut Principal: Grid (2/3 + 1/3) */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                {/* ... resta del component (sense canvis) ... */}
                 {/* Columna Esquerra (Formulari Principal) - 2/3 */}
                 <div className="lg:col-span-2 space-y-3">
                    {/* Targeta 1: Detalls BÃ sics */}
                    <Card>
                        <CardHeader><CardTitle>{t('card.generalDetails')}</CardTitle></CardHeader>
                        <CardContent className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4"> {/* Gap augmentat */}
                            {/* ProveÃ¯dor (Selector) */}
                            <div className="space-y-2">
                            <Label htmlFor="supplier_id">{t('field.supplier')}</Label>
                            <SupplierCombobox
                                value={formData.supplier_id}
                                onChange={(value) => handleFieldChange('supplier_id', value)}
                                initialSupplier={initialData?.suppliers ? { id: String(initialData.suppliers.id), nom: initialData.suppliers.nom } : null}
                                disabled={isSaving}
                            />
                            </div>
                            {/* Data de la Despesa */}
                            <div className="space-y-2">
                            <Label htmlFor="expense_date">{t('field.expenseDate')}</Label>
                            <Input
                                id="expense_date"
                                type="date"
                                value={formData.expense_date}
                                onChange={(e) => handleFieldChange('expense_date', e.target.value)}
                                disabled={isSaving}
                            />
                            </div>
                        </div>

                        {/* NÃºmero de Factura */}
                        <div className="space-y-2">
                            <Label htmlFor="invoice_number">{t('field.invoiceNumber')}</Label>
                            <Input
                            id="invoice_number"
                            value={formData.invoice_number || ''}
                            onChange={(e) => handleFieldChange('invoice_number', e.target.value)}
                            disabled={isSaving}
                            placeholder={t('placeholder.invoiceNumber')}
                            />
                        </div>

                        {/* DescripciÃ³ (General) */}
                        <div className="space-y-2">
                            <Label htmlFor="description">{t('field.description')}</Label>
                            <Textarea
                            id="description"
                            value={formData.description}
                            onChange={(e) => handleFieldChange('description', e.target.value)}
                            disabled={isSaving}
                            rows={3}
                            placeholder={t('placeholder.description')}
                            />
                        </div>
                        </CardContent>
                    </Card>

                    {/* Targeta 2: Conceptes/LÃ­nies d'Article */}
                    <Card>
                        <CardHeader className='flex-row justify-between items-center'>
                        <CardTitle>{t('card.expenseItems')}</CardTitle>
                        <Button type="button" size="sm" variant="outline" onClick={handleAddItem} disabled={isSaving}>
                            <Plus className="w-4 h-4 mr-2" /> {t('button.addItem')}
                        </Button>
                        </CardHeader>
                        <CardContent>
                        <ExpenseItemsEditor
                            items={formData.expense_items || []}
                            onItemChange={handleItemChange}
                            onRemoveItem={handleRemoveItem}
                            isSaving={isSaving}
                        />
                        </CardContent>
                    </Card>

                    {/* Targeta 3: Notes Adicionals */}
                    <Card>
                        <CardHeader><CardTitle>{t('card.notes')}</CardTitle></CardHeader>
                        <CardContent>
                        <Textarea
                            id="notes"
                            value={formData.notes || ''}
                            onChange={(e) => handleFieldChange('notes', e.target.value)}
                            disabled={isSaving}
                            rows={4}
                            placeholder={t('placeholder.notes')}
                        />
                        </CardContent>
                    </Card>
                    </div>

                    {/* Columna Dreta (Metadades i Totals) - 1/3 */}
                    <div className="lg:col-span-1 space-y-3">
                    {/* Targeta 4: Totals i Impostos */}
                    <Card>
                        <CardHeader><CardTitle>{t('card.totals')}</CardTitle></CardHeader>
                        <CardContent className="space-y-3">
                        {/* Subtotal */}
                        <div className="flex justify-between items-center">
                            <Label>{t('label.subtotal')}</Label>
                            <span className="font-medium">{formatCurrency(formData.subtotal, 'EUR', locale)}</span>
                        </div>

                        {/* Descompte */}
                        <div className="space-y-1">
                            <Label htmlFor="discount_amount">{t('field.discount')}</Label>
                            <Input
                            id="discount_amount"
                            type="number"
                            value={formData.discount_amount || 0}
                            onChange={(e) => handleFieldChange('discount_amount', parseFloat(e.target.value) || 0)}
                            disabled={isSaving}
                            step="0.01"
                            />
                        </div>

                        {/* Impostos (Tax Rate) */}
                        <div className="space-y-1">
                            <Label htmlFor="tax_rate">{t('field.taxRate')}</Label>
                            <div className="flex items-center space-x-2">
                            <Input
                                id="tax_rate"
                                type="number"
                                value={formData.tax_rate || 0}
                                onChange={(e) => handleFieldChange('tax_rate', parseFloat(e.target.value) || 0)}
                                disabled={isSaving}
                                step="0.01"
                            />
                            <span className='font-mono text-sm text-muted-foreground'>({formatCurrency(formData.tax_amount, 'EUR', locale)})</span>
                            </div>
                        </div>

                        {/* Total Final */}
                        <div className="pt-2 border-t mt-4 flex justify-between items-center">
                            <Label className="text-lg font-bold">{t('label.total')}</Label>
                            <span className="text-xl font-extrabold text-primary">{formatCurrency(formData.total_amount, 'EUR', locale)}</span>
                        </div>
                        </CardContent>
                    </Card>

                    {/* Targeta 5: Adjunts (Documents) */}
                    <Card>
                        <CardHeader><CardTitle className="flex items-center gap-2"><FileText className="w-5 h-5" />{t('card.attachments')}</CardTitle></CardHeader>
                        <CardContent className="space-y-3">
                        {/* Llista d'adjunts existents (des de l'estat local) */}
                        {attachments.length > 0 ? (
                            attachments.map(attachment => (
                            <ExpenseAttachmentCard
                                key={attachment.id}
                                attachment={attachment}
                                // âœ… Passem la funciÃ³ per actualitzar l'estat local
                                onDeleteSuccess={handleDeleteSuccess}
                            />
                            ))
                        ) : (
                            !isNew && <p className="text-sm text-muted-foreground">No hi ha adjunts.</p>
                        )}
                        
                        {/* Ã€rea de pujada */}
                        {isNew ? (
                            <AlertDialog> {/*Canviat Alert a AlertDialog per ferlo com la resta */}
                                <AlertTriangle className="h-4 w-4" />
                                <AlertDialogTitle>Desa la despesa</AlertDialogTitle>
                                <AlertDialogDescription>
                                    Primer has de desar la despesa abans de poder pujar adjunts.
                                </AlertDialogDescription>
                            </AlertDialog>
                        ) : (
                            <ExpenseAttachmentUploader
                            expenseId={initialData!.id} // Si no Ã©s 'isNew', initialData.id existeix
                            onUploadSuccess={handleUploadSuccess}
                            />
                        )}
                        </CardContent>
                    </Card>

                    {/* Targeta 6: InformaciÃ³ de CreaciÃ³ (Solo mode EdiciÃ³) */}
                    {!isNew && initialData && (
                        <Card>
                        <CardHeader><CardTitle>{t('card.metadata')}</CardTitle></CardHeader>
                        <CardContent className="space-y-2 text-sm text-muted-foreground">
                            <p><strong>{t('metadata.id')}:</strong> {initialData.id}</p>
                            <p><strong>{t('metadata.createdBy')}:</strong> {initialData.user_id}</p>
                            <p><strong>{t('metadata.createdAt')}:</strong> {formatDate(initialData.created_at, locale)}</p>
                        </CardContent>
                        </Card>
                    )}
                    </div>
            </div>
        </form>
    );
}

// =================== FILE: src/app/[locale]/(app)/finances/expenses/[expenseId]/_components/ExpenseDetailData.tsx ===================

import { notFound } from 'next/navigation';
import { fetchExpenseDetail } from '../actions';
import { ExpenseDetailClient } from './ExpenseDetailClient';
// Asumim que els tipus de dades (com 'ExpenseWithRelations') s'importen des d'un altre lloc si cal
// import type { ExpenseWithRelations } from '@/types/finances';

interface ExpenseDetailDataProps {
  expenseId: string;
}

export async function ExpenseDetailData({ expenseId: expenseIdProp }: ExpenseDetailDataProps) {
  // âœ… CORRECCI- 1: Renombrem la prop a l'entrada per evitar conflictes.
  //    'expenseIdProp' serÃ  sempre el string ('new' o '123').
  
  const isNew = expenseIdProp === 'new';

  let expenseData = null;
  
  // NomÃ©s executem la lÃ²gica de cÃ rrega si NO Ã©s una nova despesa.
  if (!isNew) {
    // âœ… CORRECCIÃ“ 2: Creem una nova variable per a la versiÃ³ numÃ¨rica.
    const numericExpenseId = parseInt(expenseIdProp, 10);

    // âœ… CORRECCIÃ“ 3: La validaciÃ³ ara Ã©s simple i segura, sense 'as number'.
    if (isNaN(numericExpenseId)) {
      console.error("Invalid expense ID:", expenseIdProp);
      notFound();
    }

    // Fem la crida a la base de dades amb l'ID numÃ¨ric validat.
    expenseData = await fetchExpenseDetail(numericExpenseId);

    // Si no trobem la despesa, mostrem un 404.
    if (!expenseData) {
      notFound();
    }
  }

  // Passem les dades inicials (que poden ser 'null' si Ã©s 'new')
  // i l'indicador 'isNew' al component client.
  return (
    <ExpenseDetailClient
      initialData={expenseData}
      isNew={isNew}
    />
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/expenses/[expenseId]/_components/ExpenseDetailSkeleton.tsx ===================

import { Skeleton } from "@/components/ui/skeleton";
import { Card, CardContent, CardHeader } from "@/components/ui/card";
import { Separator } from "@/components/ui/separator";

/**
 * Esquelet de cÃ rrega professional per a la vista de detall de Despesa.
 * * âœ… El Per QuÃ¨: Simula l'estructura visual del formulari d'ediciÃ³/creaciÃ³,
 * orientant l'usuari sobre on es carregarÃ  el contingut.
 */
export function ExpenseDetailSkeleton() {
    return (
        <div className="space-y-8 p-4">
            {/* CapÃ§alera - TÃ­tol i Accions */}
            <div className="flex justify-between items-center mb-8">
                <Skeleton className="h-8 w-64" />
                <div className="flex space-x-2">
                    <Skeleton className="h-10 w-24" />
                    <Skeleton className="h-10 w-24" />
                </div>
            </div>

            {/* Contingut Principal (Grid de 3 columnes tÃ­pic d'editor/detall) */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                {/* Columna Esquerra (Formulari Principal) - 2/3 */}
                <div className="lg:col-span-2 space-y-8">
                    
                    {/* Targeta 1: Detalls BÃ sics */}
                    <Card>
                        <CardHeader><Skeleton className="h-6 w-40" /></CardHeader>
                        <CardContent className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                                {/* Camps de selecciÃ³ (ProveÃ¯dor, Data) */}
                                <div className="space-y-2"><Skeleton className="h-4 w-1/3" /><Skeleton className="h-10 w-full" /></div>
                                <div className="space-y-2"><Skeleton className="h-4 w-1/3" /><Skeleton className="h-10 w-full" /></div>
                            </div>
                            {/* Camp de text (DescripciÃ³/NÃºmero de factura) */}
                            <div className="space-y-2"><Skeleton className="h-4 w-1/4" /><Skeleton className="h-10 w-full" /></div>
                        </CardContent>
                    </Card>

                    {/* Targeta 2: Conceptes/LÃ­nies d'Article */}
                    <Card>
                        <CardHeader><Skeleton className="h-6 w-52" /></CardHeader>
                        <CardContent className="space-y-4">
                            {/* LÃ­nia d'Article de capÃ§alera (simulada) */}
                            <div className="flex space-x-4 border-b pb-2">
                                <Skeleton className="h-4 w-1/2" />
                                <Skeleton className="h-4 w-1/4" />
                                <Skeleton className="h-4 w-1/4" />
                            </div>
                            {/* LÃ­nies d'article */}
                            {Array.from({ length: 3 }).map((_, i) => (
                                <div key={i} className="flex space-x-4">
                                    <Skeleton className="h-10 w-1/2" />
                                    <Skeleton className="h-10 w-1/4" />
                                    <Skeleton className="h-10 w-1/4" />
                                    <Skeleton className="h-10 w-10 rounded-full" />
                                </div>
                            ))}
                        </CardContent>
                    </Card>
                </div>

                {/* Columna Dreta (Metadades) - 1/3 */}
                <div className="lg:col-span-1 space-y-8">
                    {/* Targeta 3: Sumari i Totals */}
                    <Card>
                        <CardHeader><Skeleton className="h-6 w-32" /></CardHeader>
                        <CardContent className="space-y-3">
                            <div className="flex justify-between"><Skeleton className="h-4 w-1/3" /><Skeleton className="h-4 w-1/4" /></div>
                            <div className="flex justify-between"><Skeleton className="h-4 w-1/3" /><Skeleton className="h-4 w-1/4" /></div>
                            <Separator />
                            <div className="flex justify-between"><Skeleton className="h-6 w-1/2" /><Skeleton className="h-6 w-1/3" /></div>
                        </CardContent>
                    </Card>

                    {/* Targeta 4: Adjunts */}
                    <Card>
                        <CardHeader><Skeleton className="h-6 w-32" /></CardHeader>
                        <CardContent className="space-y-3">
                            <Skeleton className="h-12 w-full" />
                            <Skeleton className="h-8 w-24 rounded-lg" />
                        </CardContent>
                    </Card>
                </div>
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/finances/expenses/[expenseId]/_components/ExpenseItemsEditor.tsx ===================

// src/app/[locale]/(app)/finances/despeses/[expenseId]/_components/ExpenseItemsEditor.tsx
import React from 'react';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Trash2 } from 'lucide-react';
import { ExpenseItem } from '@/types/finances/expenses';
import { useTranslations } from 'next-intl';

interface ExpenseItemsEditorProps {
    items: ExpenseItem[];
    onItemChange: (index: number, field: keyof ExpenseItem, value: string | number) => void;
    onRemoveItem: (index: number) => void;
    isSaving: boolean;
}

export function ExpenseItemsEditor({ items, onItemChange, onRemoveItem, isSaving }: ExpenseItemsEditorProps) {
    const t = useTranslations('ExpenseDetailPage.items');
    return (
        <div className="space-y-4">
            {/* Header de la Taula */}
            <div className="grid grid-cols-12 gap-2 text-sm font-medium text-muted-foreground border-b pb-2">
                <span className="col-span-6">{t('description')}</span>
                <span className="col-span-2 text-right">{t('quantity')}</span>
                <span className="col-span-2 text-right">{t('unitPrice')}</span>
                <span className="col-span-2 px-10 text-right">{t('total')}</span>
                <span className="w-8"></span> {/* Columna buida per al botÃ³ d'esborrar */}
            </div>

            {items.map((item, index) => (
                <div key={item.id || index} className="grid grid-cols-12 gap-2 items-center">
                    {/* DescripciÃ³ */}
                    <div className="col-span-6">
                        <Input
                            placeholder={t('placeholder.description')}
                            value={item.description}
                            onChange={(e) => onItemChange(index, 'description', e.target.value)}
                            disabled={isSaving}
                        />
                    </div>

                    {/* Quantitat */}
                    <div className="col-span-2">
                        <Input
                            type="number"
                            placeholder="0"
                            value={item.quantity || 0}
                            onChange={(e) => onItemChange(index, 'quantity', parseFloat(e.target.value) || 0)}
                            disabled={isSaving}
                            className="text-right"
                            step="any"
                        />
                    </div>

                    {/* Preu Unitari */}
                    <div className="col-span-2">
                        <Input
                            type="number"
                            placeholder="0.00"
                            value={item.unit_price || 0}
                            onChange={(e) => onItemChange(index, 'unit_price', parseFloat(e.target.value) || 0)}
                            disabled={isSaving}
                            className="text-right"
                            step="0.01"
                        />
                    </div>

                    {/* Total (Lectura) */}
                    <div className="col-span-2 text-right font-medium">
                        {item.total ? item.total.toFixed(2) : '0.00'}              
                         <Button
                            type="button"
                            variant="ghost"
                            size="icon"
                            onClick={() => onRemoveItem(index)}
                            disabled={isSaving}
                            className="w-8 h-8 text-red-500 hover:bg-red-50"
                        >
                            <Trash2 className="w-4 h-4" />
                        </Button>
                    </div>

                </div>
            ))}

            {items.length === 0 && (
                <p className="text-center text-muted-foreground py-4">{t('emptyState')}</p>
            )}
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/finances/expenses/[expenseId]/_components/SupplierCombobox.tsx ===================

"use client";

import * as React from "react";
import { Check, ChevronsUpDown } from "lucide-react";
import { cn } from "@/lib/utils/utils";
import { Button } from "@/components/ui/button";
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from "@/components/ui/command";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { type Supplier } from '@/types/finances/suppliers';
import { useTranslations } from "next-intl";
import { searchSuppliers } from "@/app/[locale]/(app)/finances/suppliers/actions"; // <-- âœ… Ara funciona

interface SupplierComboboxProps {
    value: string | null;
    onChange: (value: string | null) => void;
    initialSupplier: Pick<Supplier, 'id' | 'nom'> | null;
    disabled?: boolean;
}

export function SupplierCombobox({ value, onChange, initialSupplier, disabled }: SupplierComboboxProps) {
    const t = useTranslations('ExpenseDetailPage');
    const [open, setOpen] = React.useState(false);
    
    // Llista de proveÃ¯dors trobats en la cerca
    const [suppliers, setSuppliers] = React.useState<Pick<Supplier, 'id' | 'nom'>[]>(
        initialSupplier ? [initialSupplier] : []
    );
    
    // El proveÃ¯dor seleccionat (objecte)
    const selectedSupplier = suppliers.find(s => s.id === value) || null;
    
    const [searchTerm, setSearchTerm] = React.useState("");

    // Cerca asÃ­ncrona
    React.useEffect(() => {
        if (!open) return;

        const fetchSuppliers = async () => {
            // Crida a la Server Action
            const results = await searchSuppliers(searchTerm); // âœ… Aquesta acciÃ³ ara existeix
            
            // Assegurem que el proveÃ¯dor inicial (si estÃ  seleccionat) es mantingui a la llista
            // per si la cerca nova no el retorna.
            if (initialSupplier && !results.find(s => s.id === initialSupplier.id)) {
                 setSuppliers([initialSupplier, ...results]);
            } else {
                 setSuppliers(results);
            }
        };
        
        // Un petit debounce
        const timer = setTimeout(fetchSuppliers, 300);
        return () => clearTimeout(timer);

    }, [searchTerm, open, initialSupplier]);

    return (
        <Popover open={open} onOpenChange={setOpen}>
            <PopoverTrigger asChild>
                <Button
                    variant="outline"
                    role="combobox"
                    aria-expanded={open}
                    className="w-full justify-between"
                    disabled={disabled}
                >
                    {selectedSupplier
                        ? selectedSupplier.nom
                        : t('select.selectSupplier')}
                    <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                </Button>
            </PopoverTrigger>
            <PopoverContent className="w-[--radix-popover-trigger-width] p-0">
                <Command>
                    <CommandInput 
                        placeholder={t('select.searchSupplier')}
                        onValueChange={setSearchTerm}
                    />
                    <CommandList>
                        <CommandEmpty>{t('select.noSupplierFound')}</CommandEmpty>
                        <CommandGroup>
                            {/* OpciÃ³ per netejar */}
                            <CommandItem
                                onSelect={() => {
                                    onChange(null);
                                    setOpen(false);
                                }}
                            >
                                {t('select.noSupplier')}
                            </CommandItem>
                            
                            {suppliers.map((supplier) => (
                                <CommandItem
                                    key={supplier.id}
                                    value={supplier.nom} // Cerquem per nom
                                    onSelect={() => {
                                        // âœ… Canvi: .toString() eliminat. 'supplier.id' ja Ã©s string (uuid)
                                        onChange(supplier.id);
                                        setOpen(false);
                                    }}
                                >
                                    <Check
                                        className={cn(
                                            "mr-2 h-4 w-4",
                                            value === supplier.id ? "opacity-100" : "opacity-0"
                                        )}
                                    />
                                    {supplier.nom}
                                </CommandItem>
                            ))}
                        </CommandGroup>
                    </CommandList>
                </Command>
            </PopoverContent>
        </Popover>
    );
}

// =================== FILE: src/app/[locale]/(app)/finances/expenses/[expenseId]/_hooks/useExpenseDetail.ts ===================

import { useState, useEffect, useTransition } from 'react';
import { useTranslations } from 'next-intl';
import { toast } from 'sonner';
import { useRouter } from 'next/navigation';

import { type ExpenseDetail, type ExpenseFormDataForAction, type ExpenseItem } from '@/types/finances/expenses';
// âŒ 'Supplier' ja no Ã©s necessari aquÃ­
import { saveExpenseAction } from '../actions';

interface UseExpenseDetailProps {
    initialData: ExpenseDetail | null;
    isNew: boolean;
    // âŒ 'allSuppliers' eliminat, Ã©s redundant.
    // La informaciÃ³ del proveÃ¯dor inicial ja ve a 'initialData.suppliers'.
}

// âœ… Hem afegit tots els camps que falten segons l'esquema de la BD
const defaultInitialData: Omit<ExpenseFormDataForAction, 'status'> = {
    id: 'new',
    description: '',
    total_amount: 0,
    expense_date: new Date().toISOString().split('T')[0],
    category: null,
    invoice_number: null,
    tax_amount: 0,
    subtotal: 0,
    discount_amount: 0,
    notes: null,
    tax_rate: 21,
    supplier_id: null,
    // âœ… CAMPS AFEGITS PER CORREGIR L'ERROR DE TIPATGE
    payment_method: null,
    payment_date: null,
    is_billable: false,
    project_id: null,
    is_reimbursable: false,
    // ---
    expense_items: [],
};

// âŒ 'allSuppliers' eliminat de la desestructuraciÃ³
export function useExpenseDetail({ initialData, isNew }: UseExpenseDetailProps) {
    const t = useTranslations('ExpenseDetailPage');
    const router = useRouter();
    const [isPending, startTransition] = useTransition();

    // El 'as ExpenseFormDataForAction' Ã©s necessari perquÃ¨ TypeScript sap que a defaultInitialData li falta 'status',
    // perÃ² confiem que la resta de la nostra lÃ²gica ja no el fa servir.
    const [formData, setFormData] = useState<ExpenseFormDataForAction>(
        initialData ? { ...initialData, id: initialData.id.toString() } : defaultInitialData as ExpenseFormDataForAction
    );

    const calculateTotals = (items: ExpenseItem[], discount: number, taxRate: number) => {
        const subtotal = items.reduce((acc, item) => acc + (item.quantity * item.unit_price), 0);
        const effectiveSubtotal = subtotal - discount;
        const taxAmount = effectiveSubtotal > 0 ? effectiveSubtotal * (taxRate / 100) : 0;
        const totalAmount = effectiveSubtotal + taxAmount;
        return { subtotal, taxAmount, totalAmount };
    };

    useEffect(() => {
        const { subtotal, taxAmount, totalAmount } = calculateTotals(
            formData.expense_items || [],
            formData.discount_amount || 0,
            formData.tax_rate || 0
        );
        setFormData(prev => ({
            ...prev,
            subtotal,
            tax_amount: taxAmount,
            total_amount: totalAmount
        }));
    }, [formData.expense_items, formData.discount_amount, formData.tax_rate]);

    const handleFieldChange = <K extends keyof ExpenseFormDataForAction>(field: K, value: ExpenseFormDataForAction[K]) => {
        setFormData(prev => ({ ...prev, [field]: value }));
    };

    const handleItemChange = <K extends keyof ExpenseItem>(index: number, field: K, value: ExpenseItem[K]) => {
        const newItems = [...(formData.expense_items || [])];
        if (!newItems[index]) return;
        newItems[index] = { ...newItems[index], [field]: value };
        if (field === 'quantity' || field === 'unit_price') {
            newItems[index].total = (Number(newItems[index].quantity) || 0) * (Number(newItems[index].unit_price) || 0);
        }
        setFormData(prev => ({ ...prev, expense_items: newItems }));
    };

    const handleAddItem = () => {
        const newItem: ExpenseItem = {
            id: Date.now(),
            expense_id: typeof formData.id === 'string' && formData.id !== 'new' ? Number(formData.id) : 0,
            description: '',
            quantity: 1,
            unit_price: 0,
            total: 0,
        };
        setFormData(prev => ({ ...prev, expense_items: [...(prev.expense_items || []), newItem] }));
    };

    const handleRemoveItem = (index: number) => {
        const newItems = [...(formData.expense_items || [])];
        newItems.splice(index, 1);
        setFormData(prev => ({ ...prev, expense_items: newItems }));
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        startTransition(async () => {
            const result = await saveExpenseAction(formData, isNew ? null : (formData.id ?? null));
            if (result.success) {
                toast.success(t('toast.saveSuccess'));
                router.push('/finances/expenses'); // <-- Canviat a /expenses (despeses)
                router.refresh();
            } else {
                toast.error(result.message || t('toast.saveError'));
            }
        });
    };

    return {
        isPending,
        formData,
        handleFieldChange,
        handleSubmit,
        handleItemChange,
        handleAddItem,
        handleRemoveItem,
        t,
        // âŒ 'allSuppliers' eliminat del return
    };
}

// =================== FILE: src/app/[locale]/(app)/finances/expenses/_components/ExpenseFilters.tsx ===================

'use client';

import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { useTranslations } from 'next-intl';
import { Search } from "lucide-react";

export interface ExpensePageFilters {
  category: string;
  status: string;
}

interface ExpenseFiltersProps {
  searchTerm: string;
  onSearchChange: (value: string) => void;
  filters: ExpensePageFilters;
  onFilterChange: (key: keyof ExpensePageFilters, value: string) => void;
  categories: string[];
}

export function ExpenseFilters({
  searchTerm,
  onSearchChange,
  filters,
  onFilterChange,
  categories,
}: ExpenseFiltersProps) {
  const t = useTranslations('ExpensesPage');
  const statuses = ['pending', 'paid', 'overdue', 'cancelled'];

  return (
    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 w-full mb-2">
      {/* ğŸ”¹ Filtres d'estat i categoria */}
      <div className="flex items-center gap-2 overflow-x-auto scrollbar-none pb-1 sm:overflow-visible">
        {/* Estat */}
        <Select
          value={filters.status}
          onValueChange={(value) => onFilterChange('status', value)}
        >
          <SelectTrigger className="min-w-[120px] sm:w-[150px] h-9 bg-card border border-input text-sm">
            <SelectValue placeholder={t('filter.allStatuses')} />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">{t('filter.allStatuses')}</SelectItem>
            {statuses.map(s => (
              <SelectItem key={s} value={s}>{t(`status.${s}`)}</SelectItem>
            ))}
          </SelectContent>
        </Select>

        {/* Categoria */}
        <Select
          value={filters.category}
          onValueChange={(value) => onFilterChange('category', value)}
        >
          <SelectTrigger className="min-w-[120px] sm:w-[150px] h-9 bg-card border border-input text-sm">
            <SelectValue placeholder={t('filter.allCategories')} />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">{t('filter.allCategories')}</SelectItem>
            {categories.map(c => (
              <SelectItem key={c} value={c}>{c}</SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      {/* ğŸ”¹ Buscador a sota (en mÃ²bil) o al costat (en desktop) */}
      <div className="relative w-full sm:max-w-xs">
        <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
        <Input
          placeholder={t('filter.searchPlaceholder') || "Busca..."}
          value={searchTerm}
          onChange={(e) => onSearchChange(e.target.value)}
          className="
            pl-9 w-full h-9 text-sm bg-card border border-input 
            focus-visible:ring-green-500 focus-visible:ring-1
          "
        />
      </div>
    </div>
  );
}


// =================== FILE: src/app/[locale]/(app)/finances/expenses/_components/ExpensesClient.tsx ===================

"use client";

import { useMemo } from 'react';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Plus, Edit } from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { useLocale, useTranslations } from 'next-intl';
import { GenericDataTable, type ColumnDef } from '@/components/shared/GenericDataTable';
import { ColumnToggleButton } from '@/components/shared/ColumnToggleButton';
import { formatCurrency, formatLocalizedDate } from '@/lib/utils/formatters';
import { deleteExpense } from '../[expenseId]/actions';
import {
  usePaginatedResource,
  type PaginatedResponse,
  type PaginatedActionParams
} from '@/hooks/usePaginateResource';
import { PageHeader } from '@/components/shared/PageHeader';
import { ExpenseFilters } from './ExpenseFilters';
import { fetchPaginatedExpenses } from '../actions';
import type { ExpenseWithContact } from '@/types/finances/expenses';
import type { ExpensePageFilters } from '@/lib/services/finances/expenses/expenses.service';
import { type ActionResult } from '@/types/shared/actionResult';

interface ExpensesClientProps {
  initialData: PaginatedExpensesResponse;
  filterOptions: { categories: string[] };
}

type PaginatedExpensesResponse = PaginatedResponse<ExpenseWithContact>;
type FetchExpensesParams = PaginatedActionParams<ExpensePageFilters>;
const EXPENSE_ROWS_PER_PAGE_OPTIONS = [10, 25, 50, 100];

export function ExpensesClient({ initialData, filterOptions }: ExpensesClientProps) {
  const locale = useLocale();
  const t = useTranslations('ExpensesPage');
  const tShared = useTranslations('Shared');

  const allColumns = useMemo<ColumnDef<ExpenseWithContact>[]>(() => [
    {
      accessorKey: "invoice_number",
      header: t('table.number'),
      enableSorting: true,
      cell: (row) => {
        const displayNumber = row.invoice_number || `EXP-${String(row.id).substring(0, 6)}`;
        return (
          <Link
            href={`/${locale}/finances/expenses/${row.id}`}
            className="text-green-600 hover:underline font-medium"
            title={`${tShared('actions.view')}: ${displayNumber}`}
          >
            {displayNumber}
          </Link>
        );
      },
    },
    {
      accessorKey: "suppliers.nom",
      header: t('table.supplier'),
      enableSorting: true,
      cell: (row) => {
        if (row.suppliers) {
          return (
            <Link
              href={`/${locale}/finances/suppliers/${row.suppliers.id}`}
              className="text-primary hover:underline font-medium"
              title={`${tShared('actions.view')}: ${row.suppliers.nom}`}
            >
              {row.suppliers.nom}
            </Link>
          );
        }
        return <span className="text-muted-foreground italic">{t('noSupplier')}</span>;
      },
    },
    {
      accessorKey: "description",
      header: t('table.description'),
      enableSorting: false,
      cell: (row) => <span className="max-w-[150px] truncate">{row.description}</span>,
    },
    {
      accessorKey: "expense_date",
      header: t('table.date'),
      enableSorting: true,
      cell: (row) => formatLocalizedDate(row.expense_date, "PPP", locale),
    },
    {
      accessorKey: "total_amount",
      header: t('table.total'),
      enableSorting: true,
      cell: (row) => formatCurrency(row.total_amount),
    },
    {
      accessorKey: "category",
      header: t('table.category'),
      enableSorting: true,
      cell: (row) => row.category || t('noCategory'),
    },
    {
      accessorKey: 'status',
      header: t('table.status'),
      enableSorting: true,
      cell: (row) => (
        <Badge
          variant={row.status === 'paid'
            ? 'success'
            : row.status === 'overdue'
              ? 'destructive'
              : 'secondary'} className={undefined}        >
          {t(`status.${row.status}`)}
        </Badge>
      ),
    },
    {
      accessorKey: "actions_edit",
      header: "",
      enableSorting: false,
      cell: (row) => (
        <Link href={`/${locale}/finances/expenses/${row.id}`} title={tShared('actions.edit')}>
          <Button variant="ghost" size="icon">
            <Edit className="w-4 h-4" />
          </Button>
        </Link>
      ),
    },
  ], [locale, t, tShared]);

  const {
    isPending,
    data: expenses,
    itemToDelete: expenseToDelete,
    setItemToDelete: setExpenseToDelete,
    handleDelete,
    handleSort,
    currentSortColumn,
    currentSortOrder,
    searchTerm,
    handleSearchChange,
    filters,
    handleFilterChange,
    columnVisibility,
    toggleColumnVisibility,
    page,
    totalPages,
    handlePageChange,
    rowsPerPage,
    handleRowsPerPageChange,
  } = usePaginatedResource<ExpenseWithContact, ExpensePageFilters>({
    initialData,
    initialFilters: { category: 'all', status: 'all' },
    initialSort: { column: 'expense_date', order: 'desc' },
    allColumns,
    fetchAction: fetchPaginatedExpenses as (params: FetchExpensesParams) => Promise<PaginatedExpensesResponse>,
    deleteAction: async (id: string | number): Promise<ActionResult> => {
      if (typeof id !== 'number') {
        return { success: false, message: tShared('errors.invalidId') };
      }
      return deleteExpense(id);
    },
    initialRowsPerPage: EXPENSE_ROWS_PER_PAGE_OPTIONS[0],
    rowsPerPageOptions: EXPENSE_ROWS_PER_PAGE_OPTIONS,
    toastMessages: { deleteSuccess: t('toast.deleteSuccess') },
  });

  const visibleColumns = useMemo(
    () => allColumns.filter(col => columnVisibility[col.accessorKey.toString()] ?? true),
    [allColumns, columnVisibility]
  );

  const deleteDescription = (
    <>
      {tShared('deleteDialog.description1')}{' '}
      <span className="font-bold">{expenseToDelete?.invoice_number || expenseToDelete?.id}</span>.
      <br />
      {tShared('deleteDialog.description2')}
    </>
  );

  return (
    <div className="h-full flex flex-col gap-3 md:gap-4">

      {/* ğŸ§¾ Header compacte i responsive */}
      <div className="sticky top-0 z-10 bg-background border-b shadow-sm py-3 px-4 sm:px-0">
        <PageHeader title={t('title')}>
          <Button asChild className="w-full sm:w-auto">
            <Link href={`/${locale}/finances/expenses/new`}>
              <Plus className="w-4 h-4 mr-1" /> {t('newExpenseButton')}
            </Link>
          </Button>
        </PageHeader>
      </div>

      {/* ğŸ” Filtres i columnes responsive */}
      <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 sm:gap-4 px-2 sm:px-0">
        <ExpenseFilters
          searchTerm={searchTerm}
          onSearchChange={handleSearchChange}
          filters={filters}
          onFilterChange={handleFilterChange}
          categories={filterOptions.categories}
        />
        <ColumnToggleButton
          allColumns={allColumns}
          columnVisibility={columnVisibility}
          toggleColumnVisibility={toggleColumnVisibility}
        />
      </div>

      {/* ğŸ“Š Taula amb scroll suau */}
      <div className="flex-grow overflow-x-auto">
        <GenericDataTable
          data={expenses}
          columns={visibleColumns}
          onSort={handleSort}
          currentSortColumn={currentSortColumn}
          currentSortOrder={currentSortOrder as 'asc' | 'desc' | null}
          isPending={isPending}
          onDelete={handleDelete}
          deleteItem={expenseToDelete}
          setDeleteItem={setExpenseToDelete}
          deleteTitleKey="ExpensesPage.deleteDialog.title"
          deleteDescription={deleteDescription}
          emptyStateMessage={t('emptyState')}
          page={page}
          totalPages={totalPages}
          onPageChange={handlePageChange}
          rowsPerPage={rowsPerPage}
          onRowsPerPageChange={handleRowsPerPageChange}
          rowsPerPageOptions={EXPENSE_ROWS_PER_PAGE_OPTIONS}
        />
      </div>
    </div>
  );
}


// =================== FILE: src/app/[locale]/(app)/finances/expenses/_components/ExpensesData.tsx ===================

// src/app/[locale]/(app)/finances/expenses/_components/ExpensesData.tsx (FITXER CORREGIT)
import { redirect } from 'next/navigation';
import { ExpensesClient } from './ExpensesClient';
import { fetchPaginatedExpenses, getUniqueExpenseCategories } from '../actions';
import { getTranslations } from 'next-intl/server';
import { createClient as createServerActionClient } from '@/lib/supabase/server';

// âœ… CORRECCIÃ“: Importem el tipus directament des del SERVEI DE LLISTA
import type { ExpensePageFilters } from '@/lib/services/finances/expenses/expenses.service';

const INITIAL_PAGE_LIMIT = 15; // Nota: El teu servei tÃ© un fallback de 50, assegura't que 'limit' s'estÃ  aplicant correctament.

export async function ExpensesData() {
    const supabase = createServerActionClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
        redirect('/login');
    }

    const t = await getTranslations('ExpensesPage');

    try {
        // ğŸ”´ LOG 8: Iniciant cÃ rrega de dades (Consola del Servidor)
        console.log("ExpensesData.tsx: Iniciant Promise.allSettled per dades inicials i categories...");

        const [initialDataResult, categoriesResult] = await Promise.allSettled([
            fetchPaginatedExpenses({
                searchTerm: '',
                filters: {
                    category: 'all',
                    status: 'all',
                } as ExpensePageFilters, // âœ… Ara 'ExpensePageFilters' es troba
                sortBy: 'expense_date',
                sortOrder: 'desc',
                limit: INITIAL_PAGE_LIMIT,
                offset: 0,
            }),
            getUniqueExpenseCategories()
        ]);

        if (initialDataResult.status === 'rejected') {
            console.error("Error fetching initial expenses data:", initialDataResult.reason);
            throw new Error(t('errors.loadDataFailed') || "Error en carregar les dades inicials de despeses.");
        }
        if (categoriesResult.status === 'rejected') {
            console.error("Error fetching expense categories:", categoriesResult.reason);
            console.warn("No s'han pogut carregar les categories per filtrar.");
        }

        const initialData = initialDataResult.value;
        const categories = categoriesResult.status === 'fulfilled' ? categoriesResult.value : [];
        
        // ğŸ”´ LOG 9: Dades que es passen al ExpensesClient (Consola del Servidor)
        console.log("ExpensesData.tsx: Dades inicials obtingudes:", JSON.stringify(initialData, null, 2));
        console.log("ExpensesData.tsx: Categories obtingudes:", JSON.stringify(categories, null, 2));


        return (
            <ExpensesClient
                initialData={initialData}
                filterOptions={{ categories }}
            />
        );

    } catch (error) {
        console.error("Unhandled error during ExpensesData loading:", error);
        if (error instanceof Error) {
            throw error;
        }
        throw new Error(t('errors.loadDataFailed') || "No s'han pogut carregar les dades de la pÃ gina de despeses. Si us plau, intenta-ho de nou mÃ©s tard.");
    }
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/actions.ts ===================

"use server";

import { validateUserSession } from "@/lib/supabase/session";
import { type InvoiceListRow } from '@/types/finances/invoices';
import { type InvoiceStatus } from '@/types/db'; // âœ… Importem des de db.ts
import { type PaginatedActionParams, type PaginatedResponse } from '@/hooks/usePaginateResource';
import { revalidatePath } from 'next/cache';
import { type ActionResult } from "@/types/shared/actionResult";

// âœ… Importem el nostre servei (i el tipus RpcInvoiceRow que EXPORTA)
import { 
  getPaginatedInvoices, 
  getClientsForFilterService,
  // type RpcInvoiceRow // â— Ja no cal importar RpcInvoiceRow aquÃ­
} from '@/lib/services/finances/invoices/invoices.service';

// --- Tipus EspecÃ­fics (Aquests es queden aquÃ­, sÃ³n per la UI) ---

export interface InvoicePageFilters {
  status: InvoiceStatus | 'all';
  contactId: string | 'all';
}

type FetchInvoicesParams = PaginatedActionParams<InvoicePageFilters>;
type PaginatedInvoicesData = PaginatedResponse<InvoiceListRow>;


// --- AcciÃ³ Principal (Orquestrador + Traductor) ---
export async function fetchPaginatedInvoices(
  params: FetchInvoicesParams
): Promise<PaginatedInvoicesData> {

  const { searchTerm, filters, sortBy, sortOrder, limit, offset } = params;

  // 1. Validar SessiÃ³
  const session = await validateUserSession();
  if ("error" in session) return { data: [], count: 0 };
  const { supabase, activeTeamId } = session;

  // âœ… CORRECCIÃ“: L'AcciÃ³ fa la "traducciÃ³" de la lÃ²gica de la UI
  // Converteix els valors 'all' en 'null' o '0' que el servei espera.
  const statusParam = (filters.status === 'all' || !filters.status) ? null : filters.status;
  const contactIdParam = (filters.contactId === 'all' || !filters.contactId) ? 0 : Number(filters.contactId); // O null si 0 no Ã©s vÃ lid

  try {
    // 2. Orquestrar la crida al servei amb parÃ metres simples
    const result = await getPaginatedInvoices({
      teamId: activeTeamId,
      supabase: supabase,
      searchTerm,
      statusParam, // âœ… Passa el valor traduÃ¯t
      contactIdParam, // âœ… Passa el valor traduÃ¯t
      sortBy: sortBy || 'issue_date',
      sortOrder: sortOrder || 'desc',
      limit,
      offset,
    });

    // 3. Retornar les dades
    return result;

  } catch (error) {
    console.error("Error in fetchPaginatedInvoices action:", error);
    return { data: [], count: 0 };
  }
}

// --- AcciÃ³ per als Filtres (Correcta) ---
export async function getClientsForFilter(): Promise<{ id: number; nom: string | null }[]> {
  const session = await validateUserSession();
  if ("error" in session) {
    console.error("Session error in getClientsForFilter:", session.error);
    return [];
  }
  return getClientsForFilterService(session.activeTeamId);
}

// --- AcciÃ³ per Esborrar (Correcta) ---
export async function deleteInvoiceAction(invoiceId: number): Promise<ActionResult> {
    const session = await validateUserSession();
    if ("error" in session) {
      return { success: false, message: session.error.message };
    }
    const { supabase, activeTeamId } = session;

    // Aquesta lÃ²gica Ã©s simple i pot quedar aquÃ­.
    // Si es compliquÃ©s (p.ex. comprovar estats abans d'esborrar),
    // la mourÃ­em a un 'deleteInvoiceService'.
    const { error } = await supabase
        .from('invoices')
        .delete()
        .eq('id', invoiceId)
        .eq('team_id', activeTeamId);

    if (error) {
      console.error("Error deleting invoice:", error);
      return { success: false, message: "Error en eliminar la factura." };
    }

    revalidatePath('/finances/invoices');
    return { success: true, message: "Factura eliminada correctament." };
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/page.tsx ===================

// src/app/[locale]/(app)/finances/invoices/page.tsx
import { Suspense } from 'react';
import { InvoicesData } from './_components/InvoicesData';
// â— Canvia InvoicesSkeleton per GenericDataTableSkeleton si vols usar el genÃ¨ric
import { GenericDataTableSkeleton } from '@/components/shared/GenericDataTableSkeleton';

// Ja no necessitem rebre 'searchParams' aquÃ­ directament
export default async function InvoicesListPage() {

  // Definim el nombre de columnes per a l'skeleton (ajusta segons les teves columnes visibles per defecte)
  const defaultColumnCount = 7; // invoice_number, client_name, issue_date, total_amount, status, edit action + delete action (implÃ­cit)

  return (
    // La 'key' ja no Ã©s necessÃ ria si la lÃ²gica de parÃ metres Ã©s interna al hook
    <Suspense fallback={<GenericDataTableSkeleton columnCount={defaultColumnCount} rowCount={10} />}>
      {/* InvoicesData ara gestiona la cÃ rrega inicial */}
      <InvoicesData />
    </Suspense>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/[invoiceId]/actions.ts ===================

"use server";

import { revalidatePath } from "next/cache";
import { validateUserSession } from "@/lib/supabase/session";
import { type ActionResult } from "@/types/shared/index";
import {
    type InvoiceItem,
    type InvoiceAttachment,
    type InvoiceFormDataForAction,
} from '@/types/finances/invoices';

// âœ… PAS 1: Importem el nostre nou servei
import * as invoiceService from '@/lib/services/finances/invoices/invoicesDetail.service';

/**
 * ACCIÃ“: Desa una factura (capÃ§alera, lÃ­nies i totals).
 */
export async function saveInvoiceAction(
  formData: InvoiceFormDataForAction & { invoice_items?: InvoiceItem[] },
  invoiceId: number | null
): Promise<ActionResult<{ id: number }>> {
  
  // 1. ValidaciÃ³
  const session = await validateUserSession();
  if ("error" in session) return { success: false, message: session.error.message };
  const { supabase, user, activeTeamId } = session;

  // 2. DelegaciÃ³ (crida al servei)
  const result = await invoiceService.saveInvoice(
    supabase,
    formData,
    invoiceId,
    user.id,
    activeTeamId
  );

  // 3. RevalidaciÃ³ (si Ã¨xit)
  if (result.success && result.data?.id) {
    revalidatePath('/finances/invoices');
    revalidatePath(`/finances/invoices/${result.data.id}`);
  }

  return result;
}

/**
 * ACCIÃ“: Esborra una factura (nomÃ©s si Ã©s 'Draft').
 */
export async function deleteInvoiceAction(invoiceId: number): Promise<ActionResult> {
  // 1. ValidaciÃ³
  const session = await validateUserSession();
  if ("error" in session) return { success: false, message: session.error.message };
  const { supabase, activeTeamId } = session;

  // 2. DelegaciÃ³
  const result = await invoiceService.deleteInvoice(supabase, invoiceId, activeTeamId);

  // 3. RevalidaciÃ³
  if (result.success) {
    revalidatePath('/finances/invoices');
  }

  return result;
}

/**
 * ACCIÃ“: Puja un adjunt.
 */
export async function uploadInvoiceAttachmentAction(
    invoiceId: number,
    formData: FormData
): Promise<ActionResult<{ newAttachment: InvoiceAttachment }>> {
  
  // 1. ValidaciÃ³
  const session = await validateUserSession();
  if ("error" in session) return { success: false, message: session.error.message };
  const { supabase, activeTeamId } = session;

  // 2. DelegaciÃ³
  const result = await invoiceService.uploadAttachment(supabase, invoiceId, activeTeamId, formData);

  // 3. RevalidaciÃ³
  if (result.success) {
    revalidatePath(`/finances/invoices/${invoiceId}`);
  }
  
  return result;
}

/**
 * ACCIÃ“: ObtÃ© una URL signada per a un adjunt.
 */
export async function getInvoiceAttachmentSignedUrl(filePath: string): Promise<ActionResult<{ signedUrl: string }>> {
  // 1. ValidaciÃ³
  const session = await validateUserSession();
  if ("error" in session) return { success: false, message: session.error.message };
  const { activeTeamId } = session;

  // 2. DelegaciÃ³
  // Aquesta acciÃ³ no necessita el client 'supabase' de sessiÃ³, nomÃ©s 'teamId' per seguretat
  return invoiceService.getAttachmentSignedUrl(activeTeamId, filePath);
}

/**
 * ACCIÃ“: Esborra un adjunt.
 */
export async function deleteInvoiceAttachmentAction(
    attachmentId: string,
    filePath: string | null
): Promise<ActionResult> {

  // 1. ValidaciÃ³
  const session = await validateUserSession();
  if ("error" in session) return { success: false, message: session.error.message };
  const { supabase, activeTeamId } = session;

  // 2. DelegaciÃ³
  const result = await invoiceService.deleteAttachment(supabase, activeTeamId, attachmentId, filePath);

  // 3. RevalidaciÃ³ (El camÃ­ es revalida dins del servei si Ã©s necessari)
  // Per coherÃ¨ncia, ho fem aquÃ­:
  if (result.success) {
      // NecessitarÃ­em l'invoiceId de tornada, perÃ² per ara revalidem la llista
      revalidatePath('/finances/invoices');
      // Idealment, el servei retornaria l'invoiceId per revalidar especÃ­ficament
  }

  return result;
}

/**
 * ACCIÃ“: Finalitza una factura (VeriFactu).
 */
export async function finalizeInvoiceAction(
  invoiceId: number,
): Promise<ActionResult<{ signature: string }>> {

  // 1. ValidaciÃ³
  const session = await validateUserSession();
  if ('error' in session) return { success: false, message: session.error.message };
  const { supabase, activeTeamId } = session;

  // 2. DelegaciÃ³
  const result = await invoiceService.finalizeInvoice(supabase, invoiceId, activeTeamId);

  // 3. RevalidaciÃ³
  if (result.success) {
    revalidatePath('/finances/invoices');
    revalidatePath(`/finances/invoices/${invoiceId}`);
  }

  return result;
}

/**
 * ACCIÃ“: Envia la factura per email (PDF + Resend).
 */
export async function sendInvoiceByEmailAction(
  invoiceId: number,
  recipientEmail: string,
): Promise<ActionResult> {

  // 1. ValidaciÃ³
  const session = await validateUserSession();
  if ('error' in session) return { success: false, message: session.error.message };
  const { supabase, activeTeamId } = session;

  // 2. DelegaciÃ³
  const result = await invoiceService.sendInvoiceByEmail(
    supabase,
    invoiceId,
    activeTeamId,
    recipientEmail
  );

  // 3. RevalidaciÃ³ (Opcional, potser registrar una activitat)
  if (result.success) {
      revalidatePath(`/finances/invoices/${invoiceId}`); // Per veure l'activitat d'enviament
  }

  return result;
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/[invoiceId]/page.tsx ===================

import { Suspense } from 'react';
import { InvoiceDetailData } from './_components/InvoiceDetailData';
import { InvoiceDetailSkeleton } from './_components/InvoiceDetailSkeleton';

// âŒ Eliminem la importaciÃ³ del tipus genÃ¨ric que causa el conflicte.
// import { type PageProps } from '@/types/shared/next-page-props';

// âœ… Definim la interfÃ­cie localment amb 'params' com a Promise.
interface InvoiceDetailPageProps {
  params: Promise<{
    locale: string;
    invoiceId: string;
  }>;
}

/**
 * Component de pÃ gina per al detall d'una factura.
 */
export default async function InvoiceDetailPage(props: InvoiceDetailPageProps) {
  
  // âœ… Resolem la promesa per obtenir l'ID.
  const { invoiceId } = await props.params;

  return (
    <Suspense fallback={<InvoiceDetailSkeleton />}>
      {/* âœ… Simplifiquem: Passem nomÃ©s l'string 'invoiceId' com a prop.
          La 'key' aquÃ­ Ã©s una bona prÃ ctica per forÃ§ar el re-renderitzat. */}
      <InvoiceDetailData key={invoiceId} invoiceId={invoiceId} />
    </Suspense>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/[invoiceId]/_components/client/InvoiceDetailHeader.tsx ===================

"use client";

import React from 'react';
import dynamic from 'next/dynamic';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import {
  Loader2, Save, Settings2, Eye, ArrowLeft, Lock, CheckCircle,
} from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { type InvoiceDetail } from '@/types/finances'; // Encara el necessitem per 'initialData'
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import {
  Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger,
  DialogFooter, DialogClose
} from "@/components/ui/dialog";
import { ScrollArea } from '@/components/ui/scroll-area';
import { InvoicePreview } from '../InvoicePreview'; // Ajusta la ruta si 'InvoicePreview' no estÃ  al mateix directori
import { type CompanyProfile } from '@/types/settings/team';
import { type Database } from '@/types/supabase';

// âœ… Importem el hook per agafar-ne els tipus
import { useInvoiceDetail } from '../../_hooks/useInvoiceDetail';

type Contact = Database['public']['Tables']['contacts']['Row'];

// âœ… Extraiem els tipus de retorn del hook
type UseInvoiceDetailReturn = ReturnType<typeof useInvoiceDetail>;

const InvoiceDownloadButton = dynamic(
  () => import('../PDF/InvoiceDownloadButton').then(mod => mod.InvoiceDownloadButton), // Ajusta la ruta
  {
    ssr: false,
    loading: () => (
      <Button type="button" variant="outline" disabled className='bg-card'>
        <Loader2 className="w-4 h-4 mr-2 animate-spin" />
        Carregant PDF...
      </Button>
    )
  }
);

interface InvoiceDetailHeaderProps {
  handleBack: () => void;
  title: string;
  description: string;
  t: UseInvoiceDetailReturn['t']; // âœ… Tipus corregit
  formIsDisabled: boolean;
  formData: UseInvoiceDetailReturn['formData']; // âœ… Tipus corregit
  handleFieldChange: UseInvoiceDetailReturn['handleFieldChange']; // âœ… Tipus corregit
  isPreviewOpen: boolean;
  setIsPreviewOpen: (isOpen: boolean) => void;
  isSaving: boolean;
  initialData: InvoiceDetail | null;
  company: CompanyProfile | null;
  contact: Contact | null;
  isLocked: boolean;
  isPending: boolean;
  isNew: boolean;
  handleFinalize: () => void;
  isFinalizing: boolean;
}

export function InvoiceDetailHeader({
  handleBack,
  title,
  description,
  t,
  formIsDisabled,
  formData,
  handleFieldChange,
  isPreviewOpen,
  setIsPreviewOpen,
  isSaving,
  initialData,
  company,
  contact,
  isLocked,
  isPending,
  isNew,
  handleFinalize,
  isFinalizing,
}: InvoiceDetailHeaderProps) {
  return (
    <header
      className="
      sticky top-[--header-height] z-30 border-b bg-background/90 backdrop-blur-sm 
      px-3 sm:px-6 py-2 sm:py-3 shadow-sm
      flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3
    "
    >
      {/* --- Esquerra: TÃ­tol + Back --- */}
      <div className="flex items-center gap-2 sm:gap-3">
        <Button
          type="button"
          variant="ghost"
          size="icon"
          onClick={handleBack}
          aria-label={t('button.goBack')}
          className="shrink-0"
        >
          <ArrowLeft className="h-5 w-5" />
        </Button>

        <div>
          <h1 className="text-lg sm:text-xl font-semibold leading-tight">
            {title}
          </h1>
          {description && (
            <p className="text-xs sm:text-sm text-muted-foreground">
              {description}
            </p>
          )}
        </div>
      </div>

      {/* --- Dreta: Accions --- */}
      <div className="flex flex-wrap items-center justify-end gap-2 sm:gap-3">
        {/* âš™ï¸ ConfiguraciÃ³ */}
        <Popover>
          <PopoverTrigger asChild>
            <Button
              variant="outline"
              size="sm"
              disabled={formIsDisabled}
              className="flex items-center gap-1"
            >
              <Settings2 className="h-4 w-4" />
              <span className="hidden sm:inline">{t('button.options')}</span>
            </Button>
          </PopoverTrigger>
          <PopoverContent className="w-64 p-4 space-y-4">
            <div className="space-y-2">
              <Label htmlFor="currency">{t('field.currency')}</Label>
              <Input
                id="currency"
                value={formData.currency || 'EUR'}
                onChange={(e) =>
                  handleFieldChange('currency', e.target.value.toUpperCase())
                }
                disabled={formIsDisabled}
                maxLength={3}
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="language">{t('field.language')}</Label>
              <Input
                id="language"
                value={formData.language || 'ca'}
                onChange={(e) => handleFieldChange('language', e.target.value)}
                disabled={formIsDisabled}
                maxLength={5}
              />
            </div>
          </PopoverContent>
        </Popover>

        {/* ğŸ‘ï¸ PrevisualitzaciÃ³ */}
        <Dialog open={isPreviewOpen} onOpenChange={setIsPreviewOpen}>
          <DialogTrigger asChild>
            <Button
              type="button"
              variant="outline"
              size="sm"
              disabled={isSaving}
              className="flex items-center gap-1"
            >
              <Eye className="w-4 h-4" />
              <span className="hidden sm:inline">{t('button.preview')}</span>
            </Button>
          </DialogTrigger>
          <DialogContent className="max-w-4xl h-[90vh] flex flex-col">
            <DialogHeader>
              <DialogTitle>{t('preview.title')}</DialogTitle>
            </DialogHeader>
            <ScrollArea className="flex-grow py-4 pr-6 -mr-6">
              <InvoicePreview formData={formData} />
            </ScrollArea>
            <DialogFooter className="mt-4">
              <DialogClose asChild>
                <Button type="button" variant="outline">
                  {t('button.close')}
                </Button>
              </DialogClose>
            </DialogFooter>
          </DialogContent>
        </Dialog>

        {/* â¬‡ï¸ Descarregar PDF */}
        {formData.status !== 'Draft' && initialData && company && contact && (
          <InvoiceDownloadButton
            invoice={initialData}
            company={company}
            contact={contact}
          />
        )}

        {/* ğŸ’¾ Desa / ğŸ§¾ EmissiÃ³ */}
        {!isLocked && (
          <Button
            type="submit"
            disabled={isSaving}
            size="sm"
            className="flex items-center gap-1 min-w-[100px]"
          >
            {isPending ? (
              <Loader2 className="w-4 h-4 animate-spin" />
            ) : (
              <Save className="w-4 h-4" />
            )}
            <span className="hidden sm:inline">
              {isPending ? t('button.saving') : t('button.saveDraft')}
            </span>
          </Button>
        )}

        {!isNew && !isLocked && (
          <Button
            type="button"
            variant="default"
            onClick={handleFinalize}
            disabled={isSaving}
            size="sm"
            className="flex items-center gap-1 min-w-[110px]"
          >
            {isFinalizing ? (
              <Loader2 className="w-4 h-4 animate-spin" />
            ) : (
              <CheckCircle className="w-4 h-4" />
            )}
            <span className="hidden sm:inline">
              {isFinalizing ? t('button.issuing') : t('button.issueInvoice')}
            </span>
          </Button>
        )}

        {/* ğŸ”’ Estat enviat */}
        {isLocked && (
          <Badge
            variant="outline"
            className="text-muted-foreground border-green-500 text-green-600"
          >
            <Lock className="w-4 h-4 mr-1" />
            {t('status.Sent')}
          </Badge>
        )}
      </div>
    </header>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/[invoiceId]/_components/client/InvoiceMainContent.tsx ===================

// /app/[locale]/(app)/finances/invoices/[id]/_components/InvoiceMainContent.tsx (MODIFICAT)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { Label } from '@/components/ui/label';
import { Input } from '@/components/ui/input';
import {
  // Plus, // Ja no s'usa
  ListChecks,
  Calculator,
  BookPlus, // âœ… Importem la icona pel nou botÃ³
} from 'lucide-react';

// âœ… Importem el component reutilitzable
import { ProductSelector } from '@/components/shared/ProductSelector';

// âœ… Importem els tipus necessaris
import { type InvoiceItem } from '@/types/finances';
import { type Database } from '@/types/supabase';
type Product = Database['public']['Tables']['products']['Row'];

import { InvoiceItemsEditor } from '../InvoiceItemsEditor';
import { ModuleCard } from '@/components/shared/ModuleCard';
import { formatCurrency } from '@/lib/utils/formatters';

// Importem el hook per agafar-ne els tipus
import { useInvoiceDetail } from '../../_hooks/useInvoiceDetail';
type UseInvoiceDetailReturn = ReturnType<typeof useInvoiceDetail>;

interface InvoiceMainContentProps {
  formData: UseInvoiceDetailReturn['formData'];
  handleFieldChange: UseInvoiceDetailReturn['handleFieldChange'];
  formIsDisabled: boolean;
  t: UseInvoiceDetailReturn['t'];
  products: Product[]; // âœ… Hem d'afegir els productes

  // Handlers d'items
  handleAddItem: () => void; // Aquest Ã©s per 'onManualAdd'
  handleAddProductFromLibrary: (product: Product) => void; // âœ… Nou handler
  handleItemChange: <K extends keyof InvoiceItem>(index: number, field: K, value: InvoiceItem[K]) => void;
  handleRemoveItem: (index: number) => void;
}

export function InvoiceMainContent({
  formData,
  handleFieldChange,
  formIsDisabled,
  t,
  products, // âœ… Rebem els productes
  handleAddItem,
  handleAddProductFromLibrary, // âœ… Rebem el nou handler
  handleItemChange,
  handleRemoveItem,
}: InvoiceMainContentProps) {

  // âœ… Definim les traduccions per al selector.
  // Assegura't que tens un objecte "productSelector" al teu JSON de "InvoiceDetailPage"
  // Ex: "InvoiceDetailPage.productSelector.addButton"
  const t_selector = (key: string) => t(`productSelector.${key}`);

  return (
    <div className="grid grid-cols-1 lg:grid-cols-4 gap-6 lg:gap-8 px-4 md:px-0">

      {/* 1. LÃNIES DE FACTURA */}
      <ModuleCard
        title={t('card.invoiceItems')}
        icon={ListChecks}
        variant="invoices"
        isCollapsible={false}
        className="lg:col-span-3"
        actions={
          // âœ… SubstituÃ¯m el botÃ³ antic pel 'ProductSelector'
          <ProductSelector
            products={products}
            onProductSelect={handleAddProductFromLibrary}
            onManualAdd={handleAddItem}
            t={t_selector}
            // Personalitzem el trigger per al header del ModuleCard
            triggerButton={
              <Button
                type="button"
                size="sm"
                variant="ghost"
                disabled={formIsDisabled}
                className="text-primary-foreground/80 hover:text-primary-foreground hover:bg-white/10"
              >
                {/* âœ… Usem la icona 'BookPlus' i un text adequat */}
                <BookPlus className="w-4 h-4 mr-2" /> {t('button.addFromLibrary')}
              </Button>
            }
          />
        }
      >
        <InvoiceItemsEditor
          items={formData.invoice_items || []}
          onItemChange={handleItemChange}
          onRemoveItem={handleRemoveItem}
          isSaving={formIsDisabled}
          currency={formData.currency || 'EUR'}
          locale={formData.language || 'ca'}
        />
      </ModuleCard>

      {/* 2. TOTALS (Sense canvis) */}
      <ModuleCard
        title={t('card.totals')}
        icon={Calculator}
        variant="invoices"
        isCollapsible={false}
        className="lg:col-span-1"
      >
        <div className="space-y-3">
          {/* ... (Contingut de la targeta de totals idÃ¨ntic) ... */}
          <div className="flex justify-between items-center">
            <Label htmlFor="discount_amount">{t('label.discount')}</Label>
            <Input
              id="discount_amount"
              type="number"
              value={formData.discount_amount ?? 0}
              onChange={(e) => handleFieldChange('discount_amount', parseFloat(e.target.value) || 0)}
              className="w-24 text-right"
              step="0.01"
              min="0"
              disabled={formIsDisabled}
            />
          </div>
          <div className="flex justify-between items-center">
            <Label htmlFor="tax_rate">{t('label.taxRate')} (%)</Label>
            <Input
              id="tax_rate"
              type="number"
              value={formData.tax_rate ?? 0}
              onChange={(e) => handleFieldChange('tax_rate', parseFloat(e.target.value) || 0)}
              className="w-20 text-right"
              step="any"
              min="0"
              disabled={formIsDisabled}
            />
          </div>
          <div className="flex justify-between items-center">
            <Label htmlFor="shipping_cost">{t('label.shipping')}</Label>
            <Input
              id="shipping_cost"
              type="number"
              value={formData.shipping_cost ?? 0}
              onChange={(e) => handleFieldChange('shipping_cost', parseFloat(e.target.value) || 0)}
              className="w-24 text-right"
              step="0.01"
              min="0"
              disabled={formIsDisabled}
            />
          </div>
          <hr className="my-3" />
          <div className="flex justify-between text-sm"><p>{t('label.subtotal')}</p><p>{formatCurrency(formData.subtotal, formData.currency, formData.language)}</p></div>
          {(formData.discount_amount ?? 0) > 0 && (
            <div className="flex justify-between text-sm text-muted-foreground"><p>{t('label.discountApplied')}</p><p>-{formatCurrency(formData.discount_amount ?? 0, formData.currency, formData.language)}</p></div>
          )}
          <div className="flex justify-between text-sm"><p>{t('label.tax')} ({formData.tax_rate ?? 0}%)</p><p>{formatCurrency(formData.tax_amount, formData.currency, formData.language)}</p></div>
          {(formData.shipping_cost ?? 0) > 0 && (
            <div className="flex justify-between text-sm"><p>{t('label.shippingApplied')}</p><p>{formatCurrency(formData.shipping_cost ?? 0, formData.currency, formData.language)}</p></div>
          )}
          <div className="flex justify-between font-bold text-lg border-t pt-3 mt-3"><p>{t('label.total')}</p><p>{formatCurrency(formData.total_amount, formData.currency, formData.language)}</p></div>
        </div>
      </ModuleCard>

    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/[invoiceId]/_components/client/InvoiceMetaGrid.tsx ===================

"use client";

import React from 'react';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea'; // âœ… Afegit
import {
  FileText,
  User,
  ShieldCheck,
  Mail,
  Phone,
  Banknote,     // âœ… Afegit
  NotebookText, // âœ… Afegit
} from 'lucide-react';
import { type InvoiceDetail, type InvoiceStatus } from '@/types/finances';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { INVOICE_STATUS_MAP } from '@/config/invoices';
import { ModuleCard } from '@/components/shared/ModuleCard';
import { ContactSelector } from '@/components/features/contactes/ContactSelector';
import { type Database } from '@/types/supabase';

// Importem el hook per agafar-ne els tipus
import { useInvoiceDetail } from '../../_hooks/useInvoiceDetail';

type Contact = Database['public']['Tables']['contacts']['Row'];

// Extraiem els tipus de retorn del hook
type UseInvoiceDetailReturn = ReturnType<typeof useInvoiceDetail>;

interface InvoiceMetaGridProps {
  formData: UseInvoiceDetailReturn['formData'];
  handleFieldChange: UseInvoiceDetailReturn['handleFieldChange'];
  formIsDisabled: boolean;
  t: UseInvoiceDetailReturn['t'];
  contacts: Contact[];
  selectedContact: Contact | null;
  handleContactIdChange: (contactId: number | null) => void;
  initialData: InvoiceDetail | null;
  isNew: boolean;
}

export function InvoiceMetaGrid({
  formData,
  handleFieldChange,
  formIsDisabled,
  t,
  contacts,
  selectedContact,
  handleContactIdChange,
  initialData,
  isNew,
}: InvoiceMetaGridProps) {
  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 px-4 md:px-0">

      {/* 1. TERMES I PAGAMENT + NOTES (Mogut aquÃ­ des de MainContent) */}
      <ModuleCard
        title={t('card.paymentTerms')}
        icon={Banknote}
        variant="invoices"
        isCollapsible={false}
      >
        <div className="grid grid-cols-1 gap-6">
          
          {/* Aquesta secciÃ³ ara Ã©s una sola columna per encaixar millor a la fila superior */}
          <div className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="terms">{t('field.terms')}</Label>
              <Textarea
                id="terms"
                value={formData.terms || ''}
                onChange={(e) => handleFieldChange('terms', e.target.value)}
                placeholder={t('placeholder.terms')}
                rows={3} // ReduÃ¯m l'alÃ§ada
                disabled={formIsDisabled}
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="payment_details">{t('field.paymentDetails')}</Label>
              <Textarea
                id="payment_details"
                value={formData.payment_details || ''}
                onChange={(e) => handleFieldChange('payment_details', e.target.value)}
                placeholder={t('placeholder.paymentDetails')}
                rows={3} // ReduÃ¯m l'alÃ§ada
                disabled={formIsDisabled}
              />
            </div>
          </div>

          <div className="space-y-2">
            <Label htmlFor="notes">
              <NotebookText className="w-4 h-4 mr-2 inline-block" />
              {t('card.notes')}
            </Label>
            <Textarea
              id="notes"
              value={formData.notes || ''}
              onChange={(e) => handleFieldChange('notes', e.target.value)}
              disabled={formIsDisabled}
              rows={4} // ReduÃ¯m l'alÃ§ada
              placeholder={t('placeholder.notes')}
            />
          </div>

        </div>
      </ModuleCard>

      {/* 2. DETALLS DE LA FACTURA (Original) */}
      <ModuleCard
        title={t('card.invoiceMeta')}
        icon={FileText}
        variant="invoices"
        isCollapsible={false}
      >
        <div className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="invoice_number">{t('field.invoiceNumber')}</Label>
            <Input id="invoice_number" value={formData.invoice_number || ''} disabled placeholder={t('placeholder.autoGenerated')} />
          </div>
          <div className="space-y-2">
            <Label htmlFor="issue_date">{t('field.invoiceDate')}</Label>
            <Input
              type="date"
              id="issue_date"
              value={formData.issue_date || ''}
              onChange={(e) => handleFieldChange('issue_date', e.target.value)}
              disabled={formIsDisabled}
            />
          </div>
          <div className="space-y-2">
            <Label htmlFor="due_date">{t('field.dueDate')}</Label>
            <Input
              type="date"
              id="due_date"
              value={formData.due_date || ''}
              onChange={(e) => handleFieldChange('due_date', e.target.value)}
              disabled={formIsDisabled}
            />
          </div>
          <div className="space-y-2">
            <Label htmlFor="status">{t('field.status')}</Label>
            <Select
              value={formData.status}
              onValueChange={(v) => handleFieldChange('status', v as InvoiceStatus)}
              disabled={formIsDisabled || !isNew}
            >
              <SelectTrigger id="status">
                <SelectValue placeholder={t('placeholder.selectStatus')} />
              </SelectTrigger>
              <SelectContent>
                {INVOICE_STATUS_MAP.map(s => (
                  <SelectItem key={s.dbValue} value={s.dbValue}>
                    {t(`status.${s.key}`)}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        </div>
      </ModuleCard>

      {/* 3. DADES CLIENT (Original) */}
      <ModuleCard
        title={t('card.customerDetails')}
        icon={User}
        variant="invoices"
        isCollapsible={false}
      >
        <div className="space-y-4">

          <div className="space-y-2">
            <Label htmlFor="contact_selector">{t('field.selectCustomer')}</Label>
            <ContactSelector
              contacts={contacts}
              selectedId={formData.contact_id ?? null}
              onSelect={handleContactIdChange}
              disabled={formIsDisabled}
            />
          </div>

          {selectedContact && (
            <div className="space-y-3 pt-3 mt-3 border-t">
              <div className="space-y-2">
                <Label htmlFor="client_name">{t('field.clientName') || 'Nom'}</Label>
                <Input
                  id="client_name"
                  value={selectedContact.nom || ''}
                  disabled
                  readOnly
                  className="opacity-100"
                />
              </div>
              <div className="space-y-2">
                <Label htmlFor="client_email">{t('field.email')}</Label>
                <div className="relative">
                  <Mail className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
                  <Input
                    id="client_email"
                    type="email"
                    value={selectedContact.email || ''}
                    disabled
                    readOnly
                    className="pl-8 opacity-100"
                  />
                </div>
              </div>
              <div className="space-y-2">
                <Label htmlFor="client_phone">{t('field.phone')}</Label>
                <div className="relative">
                  <Phone className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
                  <Input
                    id="client_phone"
                    value={selectedContact.telefon || ''}
                    disabled
                    readOnly
                    className="pl-8 opacity-100"
                  />
                </div>
              </div>
            </div>
          )}

          <div className="space-y-2">
            <Label htmlFor="client_reference">{t('field.clientReference')}</Label>
            <Input
              id="client_reference"
              value={formData.client_reference || ''}
              onChange={(e) => handleFieldChange('client_reference', e.target.value)}
              placeholder={t('placeholder.clientReference')}
              disabled={formIsDisabled}
            />
          </div>
        </div>
      </ModuleCard>

      {/* 4. INFORMACIÃ“ ADDICIONAL (Original) */}
      <ModuleCard
        title={t('card.additionalInfo') || t('card.metadata')}
        icon={ShieldCheck}
        variant="invoices"
        isCollapsible={false}
        isVisible={!isNew && !!initialData?.verifactu_uuid}
      >
        <div className="space-y-2 text-sm text-muted-foreground break-all">
          <p><strong>ID:</strong> {initialData?.id}</p>
          {initialData?.verifactu_uuid && (
            <>
              <p><strong>VeriFactu ID:</strong> <span className='text-xs'>{initialData.verifactu_uuid}</span></p>
              <p><strong>Signatura:</strong> <span className='text-xs'>{initialData.verifactu_signature}</span></p>
              <p><strong>Ant:</strong> <span className='text-xs'>{initialData.verifactu_previous_signature || 'N/A'}</span></p>
            </>
          )}
        </div>
      </ModuleCard>

    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/[invoiceId]/_components/InvoiceDetailClient.tsx ===================

"use client";

import React, { useState } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import { type InvoiceDetail } from '@/types/finances';
import { useInvoiceDetail } from '../_hooks/useInvoiceDetail';
import { type CompanyProfile } from '@/types/settings/team';
import { type Database } from '@/types/supabase';

// Nous components fills importats
import { InvoiceDetailHeader } from './client/InvoiceDetailHeader';
import { InvoiceMetaGrid } from './client/InvoiceMetaGrid';
import { InvoiceMainContent } from './client/InvoiceMainContent';

// Definim el tipus 'Contact' correcte
type Contact = Database['public']['Tables']['contacts']['Row'];
// âœ… 1. Importem el tipus 'Product'
type Product = Database['public']['Tables']['products']['Row'];

interface InvoiceDetailClientProps {
Â  initialData: InvoiceDetail | null;
Â  company: CompanyProfile | null;
Â  contact: Contact | null;
Â  contacts: Contact[];
Â  products: Product[]; // âœ… 2. Acceptem la llista de productes
Â  userId: string;      // âœ… 3. Acceptem el userId
Â  teamId: string;      // âœ… 4. Acceptem el teamId
Â  isNew: boolean;
Â  title: string;
Â  description: string;
}

export function InvoiceDetailClient({
Â  initialData,
Â  company,
Â  contact,
Â  contacts = [],
Â  products,     // âœ… 5. Rebem la llista de productes
Â  userId,       // âœ… 6. Rebem el userId
Â  teamId,       // âœ… 7. Rebem el teamId
Â  isNew,
Â  title,
Â  description,
}: InvoiceDetailClientProps) {

Â  const router = useRouter();
Â  const searchParams = useSearchParams();
Â  const fromUrl = searchParams.get('from');

Â  const {
Â  Â  formData,
Â  Â  isPending,
Â  Â  isFinalizing,
Â  Â  isLocked,
Â  Â  handleFieldChange,
Â  Â  handleItemChange,
Â  Â  handleAddItem,
Â  Â  handleAddProductFromLibrary, // âœ… 8. Rebem el nou handler del hook
Â  Â  handleRemoveItem,
Â  Â  handleSubmit,
Â  Â  handleFinalize,
Â  Â  t,
Â  } = useInvoiceDetail({ 
        initialData, 
        isNew, 
        userId, // âœ… 9. Passem userId al hook
        teamId  // âœ… 10. Passem teamId al hook
    });

Â  const isSaving = isPending || isFinalizing;
Â  const formIsDisabled = isSaving || isLocked;

Â  const [isPreviewOpen, setIsPreviewOpen] = useState(false);
Â  const [selectedContact, setSelectedContact] = useState<Contact | null>(contact);

Â  const handleBack = () => {
Â  Â  if (fromUrl) {
Â  Â  Â  router.push(fromUrl);
Â  Â  } else {
Â  Â  Â  router.push('/finances/invoices');
Â  Â  }
Â  };

Â  const handleContactIdChange = (contactId: number | null) => {
Â  Â  if (contactId === null) {
Â  Â  Â  setSelectedContact(null);
Â  Â  Â  handleFieldChange('contact_id', null);
Â  Â  } else {
Â  Â  Â  const newContact = contacts.find(c => c.id === contactId);
Â  Â  Â  if (newContact) {
Â  Â  Â  Â  setSelectedContact(newContact);
Â  Â  Â  Â  handleFieldChange('contact_id', newContact.id);
Â  Â  Â  } else {
Â  Â  Â  Â  setSelectedContact(null);
Â  Â  Â  Â  handleFieldChange('contact_id', null);
Â  Â  Â  }
Â  Â  }
Â  };

Â  return (
Â  Â  <div className="">
Â  Â  Â  <form onSubmit={handleSubmit} className="space-y-3">
Â  Â  Â  Â  
Â  Â  Â  Â  {/* --- 1. Barra d'Accions Sticky --- */}
Â  Â  Â  Â  <InvoiceDetailHeader
Â  Â  Â  Â  Â  handleBack={handleBack}
Â  Â  Â  Â  Â  title={title}
Â  Â  Â  Â  Â  description={description}
Â  Â  Â  Â  Â  t={t}
Â  Â  Â  Â  Â  formIsDisabled={formIsDisabled}
Â  Â  Â  Â  Â  formData={formData} 
Â  Â  Â  Â  Â  handleFieldChange={handleFieldChange} 
Â  Â  Â  Â  Â  isPreviewOpen={isPreviewOpen}
Â  Â  Â  Â  Â  setIsPreviewOpen={setIsPreviewOpen}
Â  Â  Â  Â  Â  isSaving={isSaving}
Â  Â  Â  Â  Â  initialData={initialData}
Â  Â  Â  Â  Â  company={company}
Â  Â  Â  Â  Â  contact={selectedContact}
Â  Â  Â  Â  Â  isLocked={isLocked}
Â  Â  Â  Â  Â  isPending={isPending}
Â  Â  Â  Â  Â  isNew={isNew}
Â  Â  Â  Â  Â  handleFinalize={handleFinalize}
Â  Â  Â  Â  Â  isFinalizing={isFinalizing}
Â  Â  Â  Â  />

Â  Â  Â  Â  {/* --- 2. FILA SUPERIOR (4 Targetes) --- */}
Â  Â  Â  Â  <InvoiceMetaGrid
Â  Â  Â  Â  Â  formData={formData} 
Â  Â  Â  Â  Â  handleFieldChange={handleFieldChange} 
Â  Â  Â  Â  Â  formIsDisabled={formIsDisabled}
Â  Â  Â  Â  Â  t={t}
Â  Â  Â  Â  Â  contacts={contacts}
Â  Â  Â  Â  Â  selectedContact={selectedContact}
Â  Â  Â  Â  Â  handleContactIdChange={handleContactIdChange}
Â  Â  Â  Â  Â  initialData={initialData}
Â  Â  Â  Â  Â  isNew={isNew}
Â  Â  Â  Â  />

Â  Â  Â  Â  {/* --- 3. SECCIÃ“ D'EDICIÃ“ (Contingut Principal) --- */}
Â  Â  Â  Â  <InvoiceMainContent
Â  Â  Â  Â  Â  formData={formData} 
Â  Â  Â  Â  Â  handleFieldChange={handleFieldChange} 
Â  Â  Â  Â  Â  formIsDisabled={formIsDisabled}
Â  Â  Â  Â  Â  t={t}
Â  Â  Â  Â  Â  products={products} // âœ… 11. Passem els productes al component fill
Â  Â  Â  Â  Â  handleAddItem={handleAddItem} // Per afegir manualment
Â  Â  Â  Â  Â  handleAddProductFromLibrary={handleAddProductFromLibrary} // âœ… 12. Passem el handler de productes
Â  Â  Â  Â  Â  handleItemChange={handleItemChange}
Â  Â  Â  Â  Â  handleRemoveItem={handleRemoveItem}
Â  Â  Â  Â  />
Â  Â  Â  Â  
Â  Â  Â  </form>
Â  Â  </div>
Â  );
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/[invoiceId]/_components/InvoiceDetailData.tsx ===================

// /app/[locale]/(app)/finances/invoices/[invoiceId]/_components/InvoiceDetailData.tsx (COMPLET I REFACTORITZAT)
import { notFound } from 'next/navigation'
import { fetchInvoiceDetail } from '../_hooks/fetchInvoiceDetail'
import { InvoiceDetailClient } from './InvoiceDetailClient'
import { getTranslations } from 'next-intl/server'
import { validateUserSession } from '@/lib/supabase/session'

// âœ… Importem els tipus de DB
import { type Contact } from '@/types/db' 

// âœ… PAS 1: Importem els NOUS SERVEIS
import { getActiveContacts, getContactById } from '@/lib/services/crm/contacts/contacts.service'
import { getActiveProducts } from '@/lib/services/finances/products/products.service'
import { getCompanyProfile } from '@/lib/services/settings/team/team.service'

interface InvoiceDetailDataProps {
  invoiceId: string
}

export async function InvoiceDetailData({
  invoiceId: invoiceIdProp,
}: InvoiceDetailDataProps) {
  const t = await getTranslations('InvoiceDetailPage')
  const isNew = invoiceIdProp === 'new'

  const session = await validateUserSession()
  if ('error' in session) {
    notFound()
  }
  const { supabase, user, activeTeamId } = session

  // --- CÃ rregues Comunes (per a 'new' i 'edit') ---
  // âœ… PAS 2: Cridem als serveis en lloc de crides directes
  const [contacts, products] = await Promise.all([
    getActiveContacts(supabase, activeTeamId),
    getActiveProducts(supabase, activeTeamId)
  ])
  
  // --- LÃ²gica per a una nova factura ---
  if (isNew) {
    // âœ… PAS 3: Cridem al servei
    const company = await getCompanyProfile(supabase, activeTeamId)

    return (
      <InvoiceDetailClient
        initialData={null}
        company={company || null}
        contact={null}
        contacts={contacts}
        products={products}
        userId={user.id}
        teamId={activeTeamId}
        isNew={true}
        title={t('createTitle')}
        description={t('createDescription')}
      />
    )
  }

  // --- LÃ²gica de cÃ rrega per a una factura existent ---

  const numericInvoiceId = parseInt(invoiceIdProp, 10)
  if (isNaN(numericInvoiceId)) {
    console.error('Invalid invoice ID:', invoiceIdProp)
    notFound()
  }

  // âœ… PAS 4: Cridem als serveis en paralÂ·lel
  const [invoiceData, company] = await Promise.all([
    fetchInvoiceDetail(numericInvoiceId), // Aquest ja era un hook/fetcher, estÃ  bÃ©
    getCompanyProfile(supabase, activeTeamId),
  ])

  // Validem la factura
  if (!invoiceData || invoiceData.team_id !== activeTeamId) {
    notFound()
  }

  // Validem l'empresa
  if (!company) {
    console.error("Error carregant el perfil de l'empresa")
    // Podem fer notFound() o continuar amb 'null' si el client ho gestiona
    notFound()
  }

  // âœ… PAS 5: Cridem al servei per obtenir el contacte
  let contact: Contact | null = null
  if (invoiceData.contact_id) {
    contact = await getContactById(supabase, activeTeamId, invoiceData.contact_id)
  }

  // Calculem tÃ­tol i descripciÃ³
  const title = t('editTitle', {
    number: invoiceData?.invoice_number ?? invoiceIdProp,
  })
  const description = t('editDescription')

  return (
    <InvoiceDetailClient
      initialData={invoiceData}
      company={company}
      contact={contact}
      contacts={contacts} // Llista de tots els contactes
      products={products} // Llista de productes
      userId={user.id} 
      teamId={activeTeamId}
      isNew={isNew}
      title={title}
      description={description}
    />
  )
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/[invoiceId]/_components/InvoiceDetailSkeleton.tsx ===================

// src/app/[locale]/(app)/finances/invoices/[invoiceId]/_components/InvoiceDetailSkeleton.tsx
import { Skeleton } from "@/components/ui/skeleton";
import { Card, CardContent, CardHeader } from "@/components/ui/card";

export function InvoiceDetailSkeleton() {
  return (
    <div className="flex flex-col gap-6">
      {/* Skeleton del PageHeader */}
      <div className="flex items-center justify-between">
        <div className="space-y-2">
          <Skeleton className="h-8 w-48" />
          <Skeleton className="h-4 w-64" />
        </div>
        <Skeleton className="h-10 w-24" /> {/* BotÃ³ Desa */}
      </div>

      {/* Skeleton del Formulari (Grid) */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        {/* Columna Esquerra */}
        <div className="lg:col-span-2 space-y-6">
          <Card>
            <CardHeader><Skeleton className="h-6 w-1/4" /></CardHeader>
            <CardContent><Skeleton className="h-10 w-full" /></CardContent>
          </Card>
          <Card>
            <CardHeader><Skeleton className="h-6 w-1/3" /></CardHeader>
            <CardContent className="space-y-2">
              <Skeleton className="h-8 w-full" />
              <Skeleton className="h-8 w-full" />
            </CardContent>
          </Card>
        </div>
        {/* Columna Dreta */}
        <div className="lg:col-span-1 space-y-6">
          <Card>
             <CardHeader><Skeleton className="h-6 w-1/2" /></CardHeader>
             <CardContent className="space-y-4">
               <Skeleton className="h-10 w-full" />
               <Skeleton className="h-10 w-full" />
               <Skeleton className="h-10 w-full" />
             </CardContent>
          </Card>
           <Card>
             <CardHeader><Skeleton className="h-6 w-1/3" /></CardHeader>
             <CardContent>
               <Skeleton className="h-20 w-full" />
             </CardContent>
          </Card>
          <Card>
             <CardHeader><Skeleton className="h-6 w-1/4" /></CardHeader>
             <CardContent className="space-y-2">
               <Skeleton className="h-6 w-full" />
                <Skeleton className="h-6 w-full" />
                <Skeleton className="h-8 w-full mt-4 border-t pt-2" />
             </CardContent>
          </Card>
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/[invoiceId]/_components/InvoiceItemsEditor.tsx ===================

// src/app/[locale]/(app)/finances/invoices/[invoiceId]/_components/InvoiceItemsEditor.tsx
"use client";

import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Trash2 } from 'lucide-react';
import { type InvoiceItem } from '@/types/finances/invoices'; // Ajusta la ruta
import { formatCurrency } from '@/lib/utils/formatters'; // Per mostrar totals
// Opcional: Si vols un selector de productes
// import { ProductCombobox } from '@/components/shared/ProductCombobox';

interface InvoiceItemsEditorProps {
    items: InvoiceItem[];
    onItemChange: <K extends keyof InvoiceItem>(index: number, field: K, value: InvoiceItem[K]) => void;
    onRemoveItem: (index: number) => void;
    isSaving: boolean;
    // Opcional: Passa productes si tens un selector
    // products: { id: number | string; name: string; price: number }[];
    currency?: string;
    locale?: string;
}

export function InvoiceItemsEditor({
    items,
    onItemChange,
    onRemoveItem,
    isSaving,
    // products,
    currency = 'EUR',
    locale = 'ca',
}: InvoiceItemsEditorProps) {

    // FunciÃ³ auxiliar per gestionar canvis numÃ¨rics
    const handleNumericChange = (index: number, field: 'quantity' | 'unit_price', value: string) => {
        const numericValue = parseFloat(value);
        // Permetem 0 perÃ² no NaN o negatius (ajusta segons necessitats)
        if (!isNaN(numericValue) && numericValue >= 0) {
            onItemChange(index, field, numericValue);
        } else if (value === '') {
             onItemChange(index, field, 0); // O null si prefereixes
        }
        // Si no Ã©s vÃ lid, no fem res (mantenim valor anterior)
    };

    return (
        <div className="overflow-x-auto">
            <Table>
                <TableHeader>
                    <TableRow>
                        {/* Opcional: CapÃ§alera per a selector de Producte */}
                        {/* <TableHead className="w-[200px]">Producte</TableHead> */}
                        <TableHead>DescripciÃ³</TableHead>
                        <TableHead className="w-[100px] text-right">Quantitat</TableHead>
                        <TableHead className="w-[120px] text-right">Preu Unitari</TableHead>
                        <TableHead className="w-[120px] text-right">Total</TableHead>
                        <TableHead className="w-[50px]"><span className="sr-only">Esborrar</span></TableHead>
                    </TableRow>
                </TableHeader>
                <TableBody>
                    {items.map((item, index) => (
                        // âœ… CORRECCIÃ“: Els comentaris s'han tret d'aquÃ­
                        <TableRow key={item.id}> 
                            {/* Opcional: CelÂ·la per a selector de Producte */}
                            {/* <TableCell>
                                <ProductCombobox
                                    value={item.product_id}
                                    onChange={(productId, product) => {
                                        // Omple automÃ ticament descripciÃ³ i preu
                                        onItemChange(index, 'product_id', productId);
                                        onItemChange(index, 'description', product?.name || item.description);
                                        onItemChange(index, 'unit_price', product?.price || item.unit_price);
                                    }}
                                    products={products}
                                    disabled={isSaving}
                                />
                            </TableCell> 
                            */}
                            <TableCell>
                                <Input
                                    value={item.description || ''}
                                    onChange={(e) => onItemChange(index, 'description', e.target.value)}
                                    placeholder="DescripciÃ³ del servei o producte"
                                    disabled={isSaving}
                                    className="min-w-[200px]" // Amplada mÃ­nima per a descripciÃ³
                                />
                            </TableCell>
                            <TableCell className="text-right">
                                <Input
                                    type="number"
                                    value={item.quantity}
                                    onChange={(e) => handleNumericChange(index, 'quantity', e.target.value)}
                                    disabled={isSaving}
                                    className="text-right"
                                    step="any" // Permet decimals si cal
                                    min="0"
                                />
                            </TableCell>
                            <TableCell className="text-right">
                                <Input
                                    type="number"
                                    value={item.unit_price}
                                    onChange={(e) => handleNumericChange(index, 'unit_price', e.target.value)}
                                    disabled={isSaving}
                                    className="text-right"
                                    step="0.01" // PrecisiÃ³ de cÃ¨ntims
                                    min="0"
                                />
                            </TableCell>
                            <TableCell className="text-right font-medium">
                                {formatCurrency(item.quantity * item.unit_price, currency, locale)}
                            </TableCell>
                            <TableCell>
                                <Button
                                    type="button"
                                    variant="ghost"
                                    size="icon"
                                    onClick={() => onRemoveItem(index)}
                                    disabled={isSaving}
                                    className="text-muted-foreground hover:text-destructive h-8 w-8"
                                >
                                    <Trash2 className="h-4 w-4" />
                                    <span className="sr-only">Esborrar lÃ­nia</span>
                                </Button>
                            </TableCell>
                        </TableRow>
                    ))}
                </TableBody>
            </Table>
            {items.length === 0 && (
                 <p className="text-center text-sm text-muted-foreground py-4">
                    No hi ha cap lÃ­nia afegida. Fes clic a "+ Afegir LÃ­nia" per comenÃ§ar.
                 </p>
            )}
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/[invoiceId]/_components/InvoicePreview.tsx ===================

"use client";

import React from 'react';
import Image from 'next/image'; // âœ… 1. Importa Image
import { useTranslations } from 'next-intl';
import { type InvoiceFormData } from '@/types/finances/invoices';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Separator } from '@/components/ui/separator';

interface InvoicePreviewProps {
    formData: InvoiceFormData;
    companyProfile?: {
        name: string | null;
        tax_id: string | null;
        address: string | null;
        email: string | null;
        logo_url?: string | null;
    } | null;
}

export function InvoicePreview({ formData, companyProfile }: InvoicePreviewProps) {
    const t = useTranslations('InvoiceDetailPage');

    const company = companyProfile ?? {
        name: formData.company_name,
        tax_id: formData.company_tax_id,
        address: formData.company_address,
        email: formData.company_email,
        logo_url: formData.company_logo_url,
    };

    const client = {
        name: formData.client_name,
        tax_id: formData.client_tax_id,
        address: formData.client_address,
        email: formData.client_email,
    };

    const currency = formData.currency || 'EUR';
    const locale = formData.language || 'ca';

    return (
        <div className="bg-white p-6 sm:p-8 rounded-lg shadow-lg max-w-4xl mx-auto border print:shadow-none print:border-none text-sm">
            {/* CapÃ§alera */}
            <header className="flex flex-col sm:flex-row justify-between items-start mb-6 gap-4">
                {/* Dades Empresa */}
                <div className="flex-1">
                    {company.logo_url && (
                        // âœ… 2. Substitueix img per Image i afegeix width/height
                        <Image
                            src={company.logo_url}
                            alt="Logo Empresa"
                            width={150} // ğŸ‘ˆ 3. Afegeix ample (ajusta segons necessitis)
                            height={64} // ğŸ‘ˆ 3. Afegeix alÃ§ada (ajusta per mantenir relaciÃ³ aspecte)
                            className="h-12 sm:h-16 w-auto mb-3 object-contain" // MantÃ© alÃ§ada visual i evita deformaciÃ³
                        />
                    )}
                    <h1 className="text-xl sm:text-2xl font-bold mb-1">{company.name || t('preview.defaultCompanyName')}</h1>
                    {company.address && <p className="text-xs text-gray-600 whitespace-pre-line">{company.address}</p>}
                    {company.tax_id && <p className="text-xs text-gray-600">NIF: {company.tax_id}</p>}
                    {company.email && <p className="text-xs text-gray-600">{company.email}</p>}
                </div>
                {/* ... resta del component ... */}
                 {/* Dades Factura */}
                <div className="text-left sm:text-right w-full sm:w-auto mt-4 sm:mt-0">
                    <h2 className="text-2xl sm:text-3xl font-bold uppercase text-gray-700 mb-2">{t('preview.invoiceTitle')}</h2>
                    <p><strong className="font-semibold">{t('field.invoiceNumber')}:</strong> {formData.invoice_number || t('preview.pending')}</p>
                    <p><strong className="font-semibold">{t('field.invoiceDate')}:</strong> {formData.issue_date ? formatDate(new Date(formData.issue_date), locale) : ''}</p>
                    <p><strong className="font-semibold">{t('field.dueDate')}:</strong> {formData.due_date ? formatDate(new Date(formData.due_date), locale) : t('preview.notApplicable')}</p>
                    <p><strong className="font-semibold">{t('field.status')}:</strong> {t(`status.${formData.status.toLowerCase()}`)}</p>
                </div>
            </header>

            <Separator className="my-4" />

            {/* Dades del Client */}
            <section className="mb-6">
                <h3 className="text-xs font-semibold uppercase text-gray-500 mb-1">{t('preview.billTo')}</h3>
                <p className="font-semibold">{client.name || t('preview.noClient')}</p>
                {client.address && <p className="text-xs text-gray-600 whitespace-pre-line">{client.address}</p>}
                {client.tax_id && <p className="text-xs text-gray-600">NIF: {client.tax_id}</p>}
                {client.email && <p className="text-xs text-gray-600">{client.email}</p>}
            </section>

            {/* Taula de LÃ­nies */}
            <section className="mb-6">
                <Table>
                    <TableHeader className="bg-gray-50 text-xs uppercase">
                        <TableRow>
                            <TableHead className="w-[50%] px-2 py-2">{t('preview.itemDescription')}</TableHead>
                            <TableHead className="text-right px-2 py-2">{t('preview.itemQuantity')}</TableHead>
                            <TableHead className="text-right px-2 py-2">{t('preview.itemUnitPrice')}</TableHead>
                            {formData.invoice_items?.some(it => (it.discount_percentage ?? 0) > 0 || (it.discount_amount ?? 0) > 0) && (
                                <TableHead className="text-right px-2 py-2">{t('preview.itemDiscount')}</TableHead>
                            )}
                            <TableHead className="text-right px-2 py-2">{t('preview.itemTotal')}</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody className="text-sm">
                        {(formData.invoice_items || []).map((item, index) => {
                             const quantity = Number(item.quantity) || 0;
                             const unitPrice = Number(item.unit_price) || 0;
                             const lineTotalBeforeDiscount = quantity * unitPrice;
                             let lineDiscountDisplay = "-";
                             let lineDiscountAmount = 0;
                             const discountAmount = Number(item.discount_amount) || 0;
                             const discountPercentage = Number(item.discount_percentage) || 0;
                             if (discountAmount > 0) {
                                 lineDiscountAmount = discountAmount;
                                 lineDiscountDisplay = formatCurrency(lineDiscountAmount, currency, locale);
                             } else if (discountPercentage > 0) {
                                 lineDiscountAmount = lineTotalBeforeDiscount * (discountPercentage / 100);
                                 lineDiscountDisplay = `${discountPercentage}%`;
                             }
                             const lineTotalAfterDiscount = lineTotalBeforeDiscount - lineDiscountAmount;

                             return (
                                <TableRow key={item.id ?? index} className="border-b">
                                    <TableCell className="font-medium py-1.5 px-2">{item.description || '(Sense descripciÃ³)'}</TableCell>
                                    <TableCell className="text-right py-1.5 px-2">{quantity}</TableCell>
                                    <TableCell className="text-right py-1.5 px-2">{formatCurrency(unitPrice, currency, locale)}</TableCell>
                                    {formData.invoice_items?.some(it => (it.discount_percentage ?? 0) > 0 || (it.discount_amount ?? 0) > 0) && (
                                        <TableCell className="text-right py-1.5 px-2 text-muted-foreground">{lineDiscountDisplay}</TableCell>
                                    )}
                                    <TableCell className="text-right py-1.5 px-2">{formatCurrency(lineTotalAfterDiscount, currency, locale)}</TableCell>
                                </TableRow>
                             );
                        })}
                         {formData.invoice_items.length === 0 && (
                             <TableRow>
                                 <TableCell colSpan={formData.invoice_items?.some(it => (it.discount_percentage ?? 0) > 0 || (it.discount_amount ?? 0) > 0) ? 5 : 4} className="text-center text-gray-500 py-4">{t('preview.noItems')}</TableCell>
                             </TableRow>
                         )}
                    </TableBody>
                </Table>
            </section>

            {/* Totals i Peu */}
            <section className="flex flex-col sm:flex-row justify-between items-start gap-6 mb-6">
                 <div className="flex-1 text-xs text-gray-600 space-y-3">
                     {formData.terms && (
                         <div>
                             <h4 className="font-semibold mb-1 uppercase text-gray-500">{t('field.terms')}:</h4>
                             <p className="whitespace-pre-line">{formData.terms}</p>
                         </div>
                     )}
                     {formData.payment_details && (
                          <div>
                              <h4 className="font-semibold mb-1 uppercase text-gray-500">{t('field.paymentDetails')}:</h4>
                              <p className="whitespace-pre-line">{formData.payment_details}</p>
                          </div>
                     )}
                 </div>
                <div className="w-full sm:w-auto sm:max-w-xs space-y-1 text-sm self-end">
                    <div className="flex justify-between">
                        <span className="text-gray-600">{t('label.subtotal')}:</span>
                        <span className="font-medium text-right">{formatCurrency(formData.subtotal, currency, locale)}</span>
                    </div>
                    {(formData.discount_amount ?? 0) > 0 && (
                        <div className="flex justify-between">
                            <span className="text-gray-600">{t('label.discountApplied')}:</span>
                            <span className="font-medium text-right">-{formatCurrency(formData.discount_amount ?? 0, currency, locale)}</span>
                        </div>
                    )}
                    <div className="flex justify-between">
                        <span className="text-gray-600">{t('label.tax')} ({formData.tax_rate ?? 0}%):</span>
                        <span className="font-medium text-right">{formatCurrency(formData.tax_amount, currency, locale)}</span>
                    </div>
                    {(formData.shipping_cost ?? 0) > 0 && (
                        <div className="flex justify-between">
                            <span className="text-gray-600">{t('label.shippingApplied')}:</span>
                            <span className="font-medium text-right">{formatCurrency(formData.shipping_cost ?? 0, currency, locale)}</span>
                        </div>
                    )}
                    <Separator className="my-1.5" />
                    <div className="flex justify-between font-bold text-base">
                        <span>{t('label.total')}:</span>
                        <span className="text-right">{formatCurrency(formData.total_amount, currency, locale)}</span>
                    </div>
                </div>
            </section>
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/[invoiceId]/_components/PDF/InvoiceDownloadButton.tsx ===================

'use client'

import { PDFDownloadLink } from '@react-pdf/renderer'
import { Button } from '@/components/ui/button'
import { Download, Loader2 } from 'lucide-react'
import { InvoicePDF } from './InvoicePDF'
import { type InvoiceDetail } from '@/types/finances/invoices'
import { type CompanyProfile } from '@/types/settings/team' 
// âŒ Eliminem la importaciÃ³ incorrecta que defineix 'id' com a 'string'
// import { type Contact } from '@/types/crm/contacts' 
import { type Database } from '@/types/supabase' // âœ… 1. Importem el tipus base de Supabase

// âœ… 2. Definim el tipus 'Contact' correcte basat en la BD (on 'id' Ã©s 'number')
type Contact = Database['public']['Tables']['contacts']['Row']

interface InvoiceDownloadButtonProps {
  invoice: InvoiceDetail
  company: CompanyProfile 
  // âœ… 3. L'interface ara espera el tipus 'Contact' correcte (amb id: number)
  contact: Contact | null 
  className?: string
}

export function InvoiceDownloadButton({
  invoice,
  company, 
  contact, 
  className,
}: InvoiceDownloadButtonProps) {
  const fileName = `factura-${invoice.invoice_number || invoice.id}.pdf`

  return (
    <PDFDownloadLink
      // Passem les noves props al component InvoicePDF
      document={
        // â„¹ï¸ ATENCIÃ“: Ara l'error es mourÃ  aquÃ­.
        // HaurÃ s de fer aquest mateix canvi de tipus a 'InvoicePDF.tsx'
        <InvoicePDF invoice={invoice} company={company} contact={contact} />
      }
      fileName={fileName}
      className={className}
    >
      {({ loading, error }) => {
        if (error) {
          console.error('Error generant el PDF per descarregar:', error)
        }

        return (
          <Button type="button" variant="outline" disabled={loading} className='bg-card'>
            {loading ? (
              <Loader2 className="w-4 h-4 mr-2 animate-spin" />
            ) : (
              <Download className="w-4 h-4 mr-2" />
            )}
            Descarregar PDF
          </Button>
        )
      }}
    </PDFDownloadLink>
  )
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/[invoiceId]/_components/PDF/InvoicePDF.tsx ===================

'use client'

import { useState, useEffect } from 'react'
import qrcode from 'qrcode'
import { type InvoiceDetail } from '@/types/finances/invoices'
import { InvoicePdfDocument } from './InvoicePdfDocument'
import { type CompanyProfile } from '@/types/settings/team' 
// âŒ Eliminem la importaciÃ³ incorrecta
// import { type Contact } from '@/types/crm/contacts' 
import { type Database } from '@/types/supabase' // âœ… 1. Importem el tipus base de Supabase

// âœ… 2. Definim el tipus 'Contact' correcte basat en la BD
type Contact = Database['public']['Tables']['contacts']['Row']

/**
 * Hook per generar el QR (nomÃ©s s'usa al client)
 */
function useVerifactuQR(qrData: string | null): string | null {
  const [dataUrl, setDataUrl] = useState<string | null>(null)

  useEffect(() => {
    if (!qrData) {
      setDataUrl(null)
      return
    }

    let isMounted = true
    qrcode.toDataURL(qrData, (err, url) => {
      if (isMounted) {
        if (err) {
          console.error('Error generant QR code:', err)
          setDataUrl(null)
        } else {
          setDataUrl(url)
        }
      }
    })

    return () => {
      isMounted = false
    }
  }, [qrData])

  return dataUrl
}

interface InvoicePDFProps {
  invoice: InvoiceDetail
  company: CompanyProfile 
  // âœ… 3. L'interface ara espera el tipus 'Contact' correcte (amb id: number)
  contact: Contact | null 
}

/**
 * AQUEST Ã‰S L'ADAPTADOR DE CLIENT.
 * S'encarrega de la lÃ²gica de client (el hook del QR)
 * i passa TOTES les dades al document "pur".
 */
export function InvoicePDF({ invoice, company, contact }: InvoicePDFProps) {
  const qrCodeDataUrl = useVerifactuQR(invoice.verifactu_qr_data)

  // Passem la factura, les dades "en viu" i la URL del QR
  // al component de document compartit.
  return (
    <InvoicePdfDocument
      invoice={invoice}
      company={company}
      // â„¹ï¸ L'error ara es mourÃ  aquÃ­.
      contact={contact}
      qrCodeDataUrl={qrCodeDataUrl}
    />
  )
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/[invoiceId]/_components/PDF/InvoicePdfDocument.tsx ===================

// /app/[locale]/(app)/finances/invoices/[invoiceId]/_components/PDF/InvoicePdfDocument.tsx

// âŒ NO HA DE SER 'use client'. Els components de react-pdf no sÃ³n components DOM.
// "use client"; 

import {
  Document,
  Page,
  Text,
  View,
  StyleSheet,
  Image,
} from '@react-pdf/renderer'
import { type InvoiceDetail } from '@/types/finances/invoices'
import { type CompanyProfile } from '@/types/settings/team' // ğŸ‘ˆ NOU
import { type Database } from '@/types/supabase' 
type Contact = Database['public']['Tables']['contacts']['Row']

// ... (Els estils 'styles' i les funcions 'formatCurrency', 'formatDate' queden exactament igual)
const styles = StyleSheet.create({
  page: {
    flexDirection: 'column',
    backgroundColor: '#FFFFFF',
    padding: 30,
    fontFamily: 'Helvetica',
    fontSize: 10,
    color: '#333',
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 20,
    paddingBottom: 10,
    borderBottomWidth: 1,
    borderBottomColor: '#EEE',
  },
  companyDetails: {
    flex: 1,
  },
  companyName: {
    fontSize: 16,
    fontFamily: 'Helvetica-Bold',
    marginBottom: 4,
  },
  companyAddress: {
    fontSize: 9,
    color: '#666',
  },
  invoiceDetails: {
    flex: 1,
    alignItems: 'flex-end',
  },
  invoiceTitle: {
    fontSize: 18,
    fontFamily: 'Helvetica-Bold',
    marginBottom: 4,
  },
  invoiceInfo: {
    fontSize: 10,
    textAlign: 'right',
  },
  customerInfo: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 20,
  },
  customerBilling: {
    flex: 1,
  },
  sectionTitle: {
    fontSize: 10,
    fontFamily: 'Helvetica-Bold',
    color: '#666',
    marginBottom: 4,
  },
  table: {
    width: '100%',
    borderStyle: 'solid',
    borderColor: '#EEE',
    borderBottomWidth: 1,
    marginBottom: 20,
  },
  tableHeader: {
    flexDirection: 'row',
    backgroundColor: '#F9F9F9',
    borderTopWidth: 1,
    borderTopColor: '#EEE',
    borderBottomWidth: 1,
    borderBottomColor: '#EEE',
  },
  tableRow: {
    flexDirection: 'row',
    borderBottomWidth: 1,
    borderBottomColor: '#EEE',
  },
  tableColHeader: {
    fontFamily: 'Helvetica-Bold',
    fontSize: 9,
    padding: 6,
  },
  tableCol: {
    padding: 6,
    fontSize: 9,
  },
  colDesc: { width: '50%' },
  colQty: { width: '15%', textAlign: 'right' },
  colPrice: { width: '15%', textAlign: 'right' },
  colTotal: { width: '20%', textAlign: 'right' },
  itemDescription: {
    fontSize: 8,
    color: '#555',
  },
  totalsContainer: {
    flexDirection: 'row',
    justifyContent: 'flex-end',
  },
  totalsBox: {
    width: '35%',
  },
  totalsRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 4,
  },
  totalsLabel: {
    fontSize: 10,
    color: '#555',
  },
  totalsValue: {
    fontSize: 10,
    textAlign: 'right',
  },
  totalsRowBold: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginTop: 6,
    paddingTop: 6,
    borderTopWidth: 1,
    borderTopColor: '#EEE',
  },
  totalsLabelBold: {
    fontFamily: 'Helvetica-Bold',
    fontSize: 12,
  },
  totalsValueBold: {
    fontFamily: 'Helvetica-Bold',
    fontSize: 12,
    textAlign: 'right',
  },
  footer: {
    marginTop: 40,
    paddingTop: 10,
    borderTopWidth: 1,
    borderTopColor: '#EEE',
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'flex-start',
  },
  notes: {
    flex: 1,
    marginRight: 20,
  },
  verifactuContainer: {
    flexDirection: 'column',
    alignItems: 'center',
  },
  qrCode: {
    width: 80,
    height: 80,
  },
  verifactuText: {
    fontSize: 7,
    marginTop: 4,
    color: '#666',
    width: 100,
    textAlign: 'center',
  },
})

const formatCurrency = (value: number | string | null, currency: string) => {
  const num = Number(value || 0)
  return `${num.toFixed(2)} ${currency}`
}

const formatDate = (dateString: string | null) => {
  if (!dateString) return ''
  const date = new Date(dateString)
  // Simple format, ja que no tenim 'Intl'
  return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`
}


// âŒ 1. ELIMINADA la primera definiciÃ³ duplicada de InvoicePdfDocumentProps
// interface InvoicePdfDocumentProps {
// Â  invoice: InvoiceDetail
// Â  qrCodeDataUrl: string | null 
// }

// âœ… 2. AQUESTA Ã‰S LA DEFINICIÃ“ CORRECTA de les props
interface InvoicePdfDocumentProps {
  invoice: InvoiceDetail
  company: CompanyProfile
  contact: Contact | null // Pot ser null si no hi ha contacte assignat
  qrCodeDataUrl: string | null
}

/**
 * AQUEST Ã‰S EL COMPONENT "PUR" REUTILITZABLE.
 */
export function InvoicePdfDocument({
  invoice,
  company,
  contact,
  qrCodeDataUrl,
}: InvoicePdfDocumentProps) {
  // ... (lÃ²gica de cÃ lcul de totals) ...
  const subtotal = Number(invoice.subtotal || 0)
  const discount = Number(invoice.discount_amount || 0)
  const shipping = Number(invoice.shipping_cost || 0)
  const tax = Number(invoice.tax_amount || 0)
  const baseImposable = subtotal - discount

  // --- ğŸ’¡ LÃ’GICA DE FALLBACK (Correcta) ---
  const companyName = invoice.company_name || company.company_name
  const companyAddress = invoice.company_address || company.company_address
  const companyTaxId = invoice.company_tax_id || company.company_tax_id
  const companyEmail = invoice.company_email || company.company_email
  
  const clientName = invoice.client_name || contact?.nom
  //const clientTaxId = invoice.client_tax_id || contact?.nif // Segueix comentat
  const clientEmail = invoice.client_email || contact?.email

  return (
    <Document>
      <Page size="A4" style={styles.page}>
        {/* --- 1. CAPÃ‡ALERA --- */}
        <View style={styles.header}>
          <View style={styles.companyDetails}>
            <Text style={styles.companyName}>
              {companyName || 'La Teva Empresa'}
            </Text>
            <Text style={styles.companyAddress}>
              {companyAddress || 'Carrer, 08000 Ciutat'}
            </Text>
            <Text style={styles.companyAddress}>
              {companyTaxId || 'NIF Emissor'}
            </Text>
            <Text style={styles.companyAddress}>
              {companyEmail || 'email@empresa.com'}
            </Text>
          </View>
          <View style={styles.invoiceDetails}>
            <Text style={styles.invoiceTitle}>FACTURA</Text>
            <Text style={styles.invoiceInfo}>
              NÃºm.: {invoice.invoice_number || `INV-${invoice.id}`}
            </Text>
            <Text style={styles.invoiceInfo}>
              Data: {formatDate(invoice.issue_date)}
            </Text>
            <Text style={styles.invoiceInfo}>
              Venciment: {formatDate(invoice.due_date)}
            </Text>
          </View>
        </View>

        {/* --- 2. INFO CLIENT --- */}
        <View style={styles.customerInfo}>
          <View style={styles.customerBilling}>
            <Text style={styles.sectionTitle}>Facturar A:</Text>
            <Text>{clientName || 'Client no especificat'}</Text>
            {/* <Text style={styles.companyAddress}>
              {clientAddress || 'AdreÃ§a client'}
            </Text>
            <Text style={styles.companyAddress}>
              {clientTaxId || 'NIF Client'}
            </Text> */}
            <Text style={styles.companyAddress}>
              {clientEmail || 'Email client'}
            </Text>
          </View>
        </View>

        {/* --- 3. TAULA D'ÃTEMS --- */}
        <View style={styles.table}>
          <View style={styles.tableHeader}>
            <Text style={[styles.tableColHeader, styles.colDesc]}>
              DescripciÃ³
            </Text>
            <Text style={[styles.tableColHeader, styles.colQty]}>Quant.</Text>
            <Text style={[styles.tableColHeader, styles.colPrice]}>
              Preu Unit.
            </Text>
            <Text style={[styles.tableColHeader, styles.colTotal]}>Total</Text>
          </View>
          {(invoice.invoice_items || []).map((item) => (
            <View key={item.id} style={styles.tableRow}>
              <View style={[styles.tableCol, styles.colDesc]}>
                <Text>{item.description || 'Ãtem de factura'}</Text>
                {item.reference_sku && (
                  <Text style={styles.itemDescription}>
                    REF: {item.reference_sku}
                  </Text>
                )}
              </View>
              <Text style={[styles.tableCol, styles.colQty]}>
                {item.quantity}
              </Text>
              <Text style={[styles.tableCol, styles.colPrice]}>
                {formatCurrency(item.unit_price, invoice.currency || 'EUR')}
              </Text>
              <Text style={[styles.tableCol, styles.colTotal]}>
                {formatCurrency(item.total, invoice.currency || 'EUR')}
              </Text>
            </View>
          ))}
        </View>

        {/* --- 4. TOTALS --- */}
        <View style={styles.totalsContainer}>
          <View style={styles.totalsBox}>
            <View style={styles.totalsRow}>
              <Text style={styles.totalsLabel}>Subtotal</Text>
              <Text style={styles.totalsValue}>
                {formatCurrency(subtotal, invoice.currency || 'EUR')}
              </Text>
            </View>
            {discount > 0 && (
              <View style={styles.totalsRow}>
                <Text style={styles.totalsLabel}>Descompte</Text>
                <Text style={styles.totalsValue}>
                  -{formatCurrency(discount, invoice.currency || 'EUR')}
                </Text>
              </View>
            )}
            <View style={styles.totalsRow}>
              <Text style={styles.totalsLabel}>Base Imposable</Text>
              <Text style={styles.totalsValue}>
                {formatCurrency(baseImposable, invoice.currency || 'EUR')}
              </Text>
            </View>
            <View style={styles.totalsRow}>
              <Text style={styles.totalsLabel}>
                IVA ({invoice.tax_rate || 0}%)
              </Text>
              <Text style={styles.totalsValue}>
                {formatCurrency(tax, invoice.currency || 'EUR')}
              </Text>
            </View>
            {shipping > 0 && (
              <View style={styles.totalsRow}>
                <Text style={styles.totalsLabel}>Enviament</Text>
                <Text style={styles.totalsValue}>
                  {formatCurrency(shipping, invoice.currency || 'EUR')}
                </Text>
              </View>
            )}
            <View style={styles.totalsRowBold}>
              <Text style={styles.totalsLabelBold}>TOTAL</Text>
              <Text style={styles.totalsValueBold}>
                {formatCurrency(
                  invoice.total_amount,
                  invoice.currency || 'EUR',
                )}
              </Text>
            </View>
          </View>
        </View>

        {/* --- 5. PEU DE PÃ€GINA --- */}
        <View style={styles.footer}>
          <View style={styles.notes}>
            {invoice.payment_details && (
              <>
                <Text style={styles.sectionTitle}>Detalls de Pagament:</Text>
                <Text>{invoice.payment_details}</Text>
              </>
            )}
            {invoice.terms && (
              <>
                <Text style={styles.sectionTitle}>Termes i Condicions:</Text>
                <Text>{invoice.terms}</Text>
              </>
            )}
          </View>
          {qrCodeDataUrl && (
            <View style={styles.verifactuContainer}>
              <Image style={styles.qrCode} src={qrCodeDataUrl} />
              {invoice.verifactu_uuid && (
                <Text style={styles.verifactuText}>
                  Factura verificable en la sede electrÃ³nica de la AEAT. ID:{' '}
                  {invoice.verifactu_uuid}
                </Text>
              )}
            </View>
          )}
        </View>
      </Page>
    </Document>
  )
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/[invoiceId]/_hooks/fetchInvoiceDetail.ts ===================

import { validateUserSession } from "@/lib/supabase/session";
import { InvoiceDetail } from "@/types/finances/invoices";


// ... (fetchInvoiceDetail, upsertInvoice, syncInvoiceItems, updateInvoiceTotals, saveInvoiceAction sense canvis) ...
export async function fetchInvoiceDetail(invoiceId: number): Promise<InvoiceDetail | null> {
    // ... codi existent ...
     const session = await validateUserSession();
    if ("error" in session) return null;
    const { supabase, activeTeamId } = session;

    const { data, error } = await supabase
        .from('invoices')
        .select(`
          *,
          invoice_items (*),
          invoice_attachments (*),
          contacts (*)
        `)
        .eq('id', invoiceId)
        .eq('team_id', activeTeamId)
        .single();

    if (error) {
        console.error("Error fetching invoice detail:", error.message);
        return null;
    }
    const resultData = data as InvoiceDetail;
    return {
        ...resultData,
        // Assegurem que els IDs sÃ³n string (UUIDs)
        invoice_items: resultData.invoice_items?.map(item => ({...item, id: String(item.id)})) ?? [],
        invoice_attachments: resultData.invoice_attachments?.map(att => ({...att, id: String(att.id)})) ?? [],
        // project_id tambÃ© Ã©s string (UUID)
        project_id: resultData.project_id ?? null,
    } as InvoiceDetail;
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/[invoiceId]/_hooks/useInvoiceDetail.ts ===================

"use client";

import { useCallback, useEffect, useState, useTransition } from "react";
import { useTranslations } from "next-intl";
import { toast } from "sonner";
import { useRouter } from "next/navigation";

import {
    type InvoiceDetail,
    type InvoiceFormData,
    type InvoiceFormDataForAction,
    type InvoiceItem,
    type InvoiceStatus,
} from "@/types/finances/invoices";
import { finalizeInvoiceAction, saveInvoiceAction } from "../actions"; // âœ… Assegura't que la ruta Ã©s correcta

import { formatDate } from "@/lib/utils/formatters"; // Import formatDate
// âœ… Importem el tipus de Producte
import { type Database } from "@/types/supabase";
type Product = Database["public"]["Tables"]["products"]["Row"];

interface UseInvoiceDetailProps {
    initialData: InvoiceDetail | null;
    isNew: boolean;
    userId: string; // âœ… Necessitem el User ID per als nous items
    teamId: string; // âœ… Necessitem el Team ID per als nous items
}

// Valors per defecte actualitzats
const defaultInitialData: InvoiceFormData = {
    contact_id: null,
    invoice_number: null,
    issue_date: formatDate(new Date()), // YYYY-MM-DD
    due_date: null,
    status: "Draft",
    notes: null,
    terms: null, // Afegit
    payment_details: null, // Afegit
    client_reference: null, // Afegit
    currency: "EUR", // Afegit
    language: "ca", // Afegit
    project_id: null, // Afegit
    budget_id: null,
    quote_id: null,
    tax: null,
    discount: null,
    extra_data: null,
    id: undefined,
    invoice_items: [],
    subtotal: 0,
    discount_amount: 0, // Descompte general
    tax_rate: 21, // Taxa general
    tax_amount: 0, // Impost general
    shipping_cost: 0, // Afegit
    total_amount: 0,
    // Camps denormalitzats o nomÃ©s lectura
    client_name: null,
    client_tax_id: null,
    client_address: null,
    client_email: null,
    company_name: null,
    company_tax_id: null,
    company_address: null,
    company_email: null,
    company_logo_url: null, // Afegit
};

export function useInvoiceDetail({
    initialData,
    isNew,
    userId, // âœ… Rebem el userId
    teamId, // âœ… Rebem el teamId
}: UseInvoiceDetailProps) {
    const t = useTranslations("InvoiceDetailPage");
    const router = useRouter();
    const [isPending, startTransition] = useTransition();
    const [isFinalizing, startFinalizing] = useTransition(); // âœ… Nou estat per a la finalitzaciÃ³

    // âœ… NOU ESTAT: Determina si el formulari ha d'estar bloquejat
    const [isLocked, setIsLocked] = useState(false);
    useEffect(() => {
        // EstÃ  bloquejat si NO Ã©s nou I l'estat NO Ã©s 'Draft'
        setIsLocked(!isNew && initialData?.status !== "Draft");
    }, [initialData, isNew]);

    const [formData, setFormData] = useState<InvoiceFormData>(() => {
        if (initialData) {
            // Mapeig explÃ­cit incloent nous camps
            const mappedData: InvoiceFormData = {
                id: initialData.id,
                contact_id: initialData.contact_id ?? null,
                invoice_number: initialData.invoice_number ?? null,
                issue_date: initialData.issue_date
                    ? formatDate(new Date(initialData.issue_date))
                    : "", // YYYY-MM-DD
                due_date: initialData.due_date
                    ? formatDate(new Date(initialData.due_date))
                    : null, // YYYY-MM-DD
                status: initialData.status as InvoiceStatus, // status a la BD Ã©s 'text', perÃ² el tractem com a enum aquÃ­
                notes: initialData.notes ?? null,
                terms: initialData.terms ?? null, // Nou
                payment_details: initialData.payment_details ?? null, // Nou
                client_reference: initialData.client_reference ?? null, // Nou
                currency: initialData.currency ?? "EUR", // Nou
                language: initialData.language ?? "ca", // Nou
                project_id: initialData.project_id ?? null, // Nou
                budget_id: initialData.budget_id ?? null,
                quote_id: initialData.quote_id ?? null,
                tax: initialData.tax ?? null,
                discount: initialData.discount ?? null,
                extra_data: initialData.extra_data ?? null,
                client_name: initialData.client_name ?? null,
                client_tax_id: initialData.client_tax_id ?? null,
                client_address: initialData.client_address ?? null,
                client_email: initialData.client_email ?? null,
                company_name: initialData.company_name ?? null,
                company_tax_id: initialData.company_tax_id ?? null,
                company_address: initialData.company_address ?? null,
                company_email: initialData.company_email ?? null,
                company_logo_url: initialData.company_logo_url ?? null, // Nou
                invoice_items: initialData.invoice_items?.map((item) => ({
                    ...item,
                    id: String(item.id), // L'ID de item Ã©s UUID (string)
                    // Assegurem tipus numÃ¨rics per als nous camps d'item si sÃ³n nulls
                    discount_percentage: item.discount_percentage ?? null,
                    discount_amount: item.discount_amount ?? null,
                })) || [],
                subtotal: initialData.subtotal ?? 0,
                discount_amount: initialData.discount_amount ?? 0, // Descompte general
                tax_rate: initialData.tax_rate ?? 21, // Taxa general
                tax_amount: initialData.tax_amount ?? 0, // Impost general
                shipping_cost: initialData.shipping_cost ?? 0, // Nou
                total_amount: initialData.total_amount ?? 0,
            };
            return mappedData;
        }
        return defaultInitialData;
    });

    // --- CÃ lcul de Totals ---
    // Ara inclou el cost d'enviament i considera descomptes per lÃ­nia si vols
    const calculateTotals = useCallback((
        items: InvoiceItem[],
        generalDiscountAmount: number = 0,
        generalTaxRate: number = 0,
        shippingCost: number = 0,
    ) => {
        let subtotalBeforeLineDiscounts = 0;
        let totalLineDiscountAmount = 0;

        items.forEach((item) => {
            const quantity = Number(item.quantity) || 0;
            const unitPrice = Number(item.unit_price) || 0;
            const lineTotal = quantity * unitPrice;
            subtotalBeforeLineDiscounts += lineTotal;

            // Calcula descompte per lÃ­nia (prioritza amount si existeix, sinÃ³ percentage)
            let lineDiscount = 0;
            if (item.discount_amount && item.discount_amount > 0) {
                lineDiscount = Number(item.discount_amount);
            } else if (
                item.discount_percentage && item.discount_percentage > 0
            ) {
                lineDiscount = lineTotal *
                    (Number(item.discount_percentage) / 100);
            }
            totalLineDiscountAmount += lineDiscount;
        });

        const subtotalAfterLineDiscounts = subtotalBeforeLineDiscounts -
            totalLineDiscountAmount;
        // Aplica descompte general DESPRÃ‰S dels descomptes de lÃ­nia
        const effectiveSubtotal = subtotalAfterLineDiscounts -
            generalDiscountAmount;

        const taxAmount = effectiveSubtotal > 0
            ? effectiveSubtotal * (generalTaxRate / 100)
            : 0;
        // Suma l'enviament DESPRÃ‰S d'impostos
        const totalAmount = effectiveSubtotal + taxAmount + shippingCost;

        return {
            subtotal: subtotalBeforeLineDiscounts, // Subtotal abans de cap descompte
            taxAmount, // Impost calculat sobre subtotal efectiu
            totalAmount, // Total final
            // Podries retornar mÃ©s valors si els necessites mostrar (totalLineDiscountAmount, etc.)
        };
    }, []);

    useEffect(() => {
        const currentGeneralDiscount = Number(formData.discount_amount) || 0;
        const currentGeneralTaxRate = Number(formData.tax_rate) || 0;
        const currentShippingCost = Number(formData.shipping_cost) || 0;

        const { subtotal, taxAmount, totalAmount } = calculateTotals(
            formData.invoice_items || [],
            currentGeneralDiscount,
            currentGeneralTaxRate,
            currentShippingCost,
        );

        if (
            subtotal !== formData.subtotal ||
            taxAmount !== formData.tax_amount ||
            totalAmount !== formData.total_amount
        ) {
            setFormData((prev) => ({
                ...prev,
                subtotal, // Actualitza subtotal (abans de descomptes)
                tax_amount: taxAmount,
                total_amount: totalAmount,
                // discount_amount i shipping_cost ja estan a l'estat, no cal actualitzar-los aquÃ­
            }));
        }
        // Incloem shipping_cost a les dependÃ¨ncies
    }, [
        formData.invoice_items,
        formData.discount_amount,
        formData.tax_rate,
        formData.shipping_cost,
        formData.subtotal,
        formData.tax_amount,
        formData.total_amount,
        calculateTotals,
    ]);

    // --- Handlers (handleFieldChange no canvia) ---
    const handleFieldChange = useCallback(<K extends keyof InvoiceFormData>(
        field: K,
        value: InvoiceFormData[K],
    ) => {
        setFormData((prev) => ({ ...prev, [field]: value }));
    }, []);

    // --- Handler per a LÃ­nies (Gestiona nous camps) ---
    const handleItemChange = useCallback(<K extends keyof InvoiceItem>(
        index: number,
        field: K,
        value: InvoiceItem[K],
    ) => {
        setFormData((prev) => {
            const currentItems = Array.isArray(prev.invoice_items)
                ? [...prev.invoice_items]
                : [];
            if (!currentItems[index]) return prev;

            const updatedItem = { ...currentItems[index], [field]: value };

            // Recalcular total i possiblement descompte si canvien camps rellevants
            if (
                field === "quantity" || field === "unit_price" ||
                field === "discount_percentage" || field === "discount_amount"
            ) {
                const quantity = Number(updatedItem.quantity) || 0;
                const unitPrice = Number(updatedItem.unit_price) || 0;
                const lineTotal = quantity * unitPrice;
                updatedItem.total = lineTotal; // Total base de la lÃ­nia

                // âœ…âœ…âœ… CORRECCIÃ“ COMPARACIÃ“ âœ…âœ…âœ…
                // Comprovem si NO Ã©s null ABANS de comparar amb 0
                const numericValue = Number(value); // Convertim a nÃºmero per comparar

                if (
                    field === "discount_percentage" && value !== null &&
                    numericValue > 0
                ) {
                    updatedItem.discount_amount = null;
                } else if (
                    field === "discount_amount" && value !== null &&
                    numericValue > 0
                ) {
                    updatedItem.discount_percentage = null;
                }
            }

            currentItems[index] = updatedItem;
            return { ...prev, invoice_items: currentItems };
        });
    }, []);

    // --- Afegir Item (Inclou nous camps per defecte) ---
    const handleAddItem = useCallback(() => {
        const newItem: InvoiceItem = {
            id: `temp-${Date.now()}-${Math.random()}`,
            invoice_id: typeof formData.id === "number" ? formData.id : 0,
            description: "",
            quantity: 1,
            unit_price: 0,
            total: 0,
            created_at: new Date().toISOString(),
            tax_rate: null, // Taxa per lÃ­nia (si la implementes)
            user_id: userId, // âœ… Assignem el user ID
            team_id: teamId, // âœ… Assignem el team ID
            product_id: null,
            // Nous camps
            discount_percentage: null, // O 0
            discount_amount: null, // O 0
            reference_sku: null,
        };
        setFormData((prev) => ({
            ...prev,
            invoice_items: [...(prev.invoice_items || []), newItem],
        }));
    }, [formData.id, userId, teamId]); // âœ… Afegim dependÃ¨ncies
    // --- Esborrar Item (sense canvis) ---
    const handleRemoveItem = useCallback((index: number) => {
        setFormData((prev) => {
            const newItems = [...(prev.invoice_items || [])];
            if (index >= 0 && index < newItems.length) {
                newItems.splice(index, 1);
                return { ...prev, invoice_items: newItems };
            }
            return prev;
        });
    }, []);
    // âœ… --- NOU HANDLER: Afegir des de la Llibreria (Cridat per ProductSelector -> onProductSelect) ---
    const handleAddProductFromLibrary = useCallback((product: Product) => {
        const newItem: InvoiceItem = {
            id: `temp-${Date.now()}-${Math.random()}`,
            invoice_id: typeof formData.id === "number" ? formData.id : 0,
            description: product.name || product.description || "",
            quantity: 1,
            unit_price: product.price || 0,
            total: product.price || 0,
            created_at: new Date().toISOString(),
            tax_rate: null,
            user_id: userId, // âœ… Assignem el user ID
            team_id: teamId, // âœ… Assignem el team ID
            product_id: product.id, // âœ… Assignem el product ID
            discount_percentage: null,
            discount_amount: null,
            reference_sku: null, // Podries afegir 'product.sku' si existeix
        };
        setFormData((prev) => ({
            ...prev,
            invoice_items: [...(prev.invoice_items || []), newItem],
        }));
    }, [formData.id, userId, teamId]); // âœ… Afegim dependÃ¨ncies
    // --- Submit Handler (Inclou nous camps a enviar) ---
    const handleSubmit = useCallback(async (e: React.FormEvent) => {
        e.preventDefault();
        // Validation...
        // âœ… ComprovaciÃ³ de seguretat al client
        if (isLocked) {
            toast.error(t("toast.cannotEditSentInvoice")); // Afegeix aquesta traducciÃ³
            return;
        }
        const {
            invoice_items,
            ...invoiceData // La resta queda aquÃ­
        } = formData;

        const itemsForAction = (invoice_items || []).map((item) => {
            // Excloem camps interns o no editables de l'item
            const { ...restOfItem } = item;
            return {
                ...restOfItem,
                id: typeof item.id === "string" && item.id.startsWith("temp-")
                    ? undefined
                    : item.id,
                quantity: Number(item.quantity) || 0,
                unit_price: Number(item.unit_price) || 0,
                tax_rate: item.tax_rate ? Number(item.tax_rate) : null,
                product_id: item.product_id ? Number(item.product_id) : null,
                // Assegurem tipus per als nous camps
                discount_percentage: item.discount_percentage
                    ? Number(item.discount_percentage)
                    : null,
                discount_amount: item.discount_amount
                    ? Number(item.discount_amount)
                    : null,
                reference_sku: item.reference_sku || null,
                // El 'total' de la lÃ­nia es recalcularÃ  al servidor amb els descomptes/impostos correctes
            };
        });

        // ConstruÃ¯m l'objecte final per a l'acciÃ³
        // ConstruÃ¯m l'objecte final per a l'acciÃ³
        const dataForAction: InvoiceFormDataForAction & {
            invoice_items?: InvoiceItem[];
        } = {
            // Usem directament invoiceData (desprÃ©s d'excloure items/id)
            // Fem un cast per assegurar que compleix amb InvoiceFormDataForAction
            ...(invoiceData as InvoiceFormDataForAction),
            // Assegurem tipus per als camps clau que s'envien
            contact_id: invoiceData.contact_id
                ? Number(invoiceData.contact_id)
                : null,
            budget_id: invoiceData.budget_id
                ? Number(invoiceData.budget_id)
                : null,
            quote_id: invoiceData.quote_id
                ? Number(invoiceData.quote_id)
                : null,
            // âœ…âœ…âœ… CORRECCIÃ“ project_id âœ…âœ…âœ…
            project_id: invoiceData.project_id || null, // Ja Ã©s string | null, nomÃ©s assegurem null si Ã©s buit
            discount_amount: Number(invoiceData.discount_amount) || 0,
            tax_rate: Number(invoiceData.tax_rate) ?? 0,
            shipping_cost: Number(invoiceData.shipping_cost) || 0,
            tax: invoiceData.tax ? Number(invoiceData.tax) : null,
            discount: invoiceData.discount
                ? Number(invoiceData.discount)
                : null,
            currency: invoiceData.currency || "EUR",
            language: invoiceData.language || "ca",
            // Afegim els items
            invoice_items: itemsForAction as InvoiceItem[],
        };

        startTransition(async () => {
            const currentInvoiceId = typeof formData.id === "number"
                ? formData.id
                : null;
            const result = await saveInvoiceAction(
                dataForAction,
                currentInvoiceId,
            );

            if (result.success && result.data?.id) {
                toast.success(result.message || t("toast.saveSuccess"));
                if (isNew || !currentInvoiceId) {
                    router.replace(`/finances/invoices/${result.data.id}`);
                } else {
                    router.refresh(); // Refresca dades si era ediciÃ³
                }
            } else {
                toast.error(result.message || t("toast.saveError"));
            }
        });
    }, [formData, isNew, router, t, startTransition, isLocked]); // âœ… Afegeix isLocked
    // âœ… NOVA ACCIÃ“: Handler per Finalitzar/Emetre la factura
    const handleFinalize = useCallback(async () => {
        const currentInvoiceId = typeof formData.id === "number"
            ? formData.id
            : null;

        if (isNew || !currentInvoiceId) {
            toast.error(t("toast.mustSaveDraftFirst")); // Afegeix aquesta traducciÃ³
            return;
        }

        if (isLocked) {
            toast.error(t("toast.alreadySent")); // Afegeix aquesta traducciÃ³
            return;
        }

        startFinalizing(async () => {
            const result = await finalizeInvoiceAction(currentInvoiceId);

            if (result.success) {
                toast.success(result.message || t("toast.finalizeSuccess")); // Afegeix traducciÃ³
                router.refresh(); // Refresca les dades per bloquejar el formulari
            } else {
                toast.error(result.message || t("toast.finalizeError")); // Afegeix traducciÃ³
            }
        });
    }, [formData.id, isNew, isLocked, router, t, startFinalizing]);

    return {
        formData,
        isPending,
        isFinalizing, // âœ… Retorna el nou estat
        isLocked, // âœ… Retorna l'estat de bloqueig
        handleFieldChange,
        handleItemChange,
        handleAddItem,
        handleAddProductFromLibrary, // âœ… Retornem el nou handler per 'onProductSelect'
        handleRemoveItem,
        handleSubmit,
        handleFinalize, // âœ… Retorna el nou handler
        t,
    };
}


// =================== FILE: src/app/[locale]/(app)/finances/invoices/_components/InvoiceClient.tsx ===================

// src/app/[locale]/(app)/finances/invoices/_components/InvoicesClient.tsx
"use client";

import { useMemo } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation'; // Mantenim router si s'usa en columnes
import { useLocale, useTranslations } from 'next-intl';
import { PlusCircle, Edit } from 'lucide-react'; // Importem Edit per a l'acciÃ³
import { usePathname } from 'next/navigation'; // âœ… 1. Importar usePathname

// Tipus i Accions
import { type InvoiceListRow, type InvoiceStatus } from '@/types/finances/invoices';
import { type ActionResult } from '@/types/shared/actionResult';
import { fetchPaginatedInvoices, type InvoicePageFilters } from '../actions';
// â— IMPORTANT: Importa deleteInvoiceAction des del seu lloc correcte!
import { deleteInvoiceAction } from '../[invoiceId]/actions'; // Ajusta la ruta si cal

// Components Compartits
import { PageHeader } from '@/components/shared/PageHeader';
import { Button } from '@/components/ui/button';
import { GenericDataTable, type ColumnDef } from '@/components/shared/GenericDataTable';
import { ColumnToggleButton } from '@/components/shared/ColumnToggleButton';
import { StatusBadge } from '@/components/shared/StatusBadge'; // Badge per a estats

// Components EspecÃ­fics
import { InvoiceFilters } from './InvoicesFilters'; // El nostre nou component

// Hook GenÃ¨ric
import { usePaginatedResource, type PaginatedResponse, type PaginatedActionParams } from '@/hooks/usePaginateResource'; // <-- Corregit 'usePaginateResource' a 'usePaginatedResource'
// Utilitats
import { formatDate, formatCurrency } from '@/lib/utils/formatters';

// Alias per claredat
type PaginatedInvoicesResponse = PaginatedResponse<InvoiceListRow>;
type FetchInvoicesParams = PaginatedActionParams<InvoicePageFilters>;

// Opcions de files per pÃ gina
const INVOICE_ROWS_PER_PAGE_OPTIONS = [10, 25, 50];

// InterfÃ­cie de Props (Opcional: afegim clients per filtrar)
interface InvoicesClientProps {
  initialData: PaginatedInvoicesResponse;
  clientsForFilter?: { id: number; nom: string | null }[]; // Llista de clients
}

export function InvoicesClient({ initialData, clientsForFilter = [] }: InvoicesClientProps) {
  const t = useTranslations('InvoicesPage');
  const tShared = useTranslations('Shared');
  const router = useRouter(); // Per al botÃ³ 'Nova' i potser columnes
  const locale = useLocale(); // Per a enllaÃ§os
  const pathname = usePathname(); // âœ… 2. Obtenir la ruta actual 
  // --- DefiniciÃ³ de Columnes ---
  const allColumns = useMemo<ColumnDef<InvoiceListRow>[]>(() => [
    {
      accessorKey: 'invoice_number',
      header: t('table.number'),
      enableSorting: true,
      cell: (invoice) => (
        <Link
          href={`/${locale}/finances/invoices/${invoice.id}`}
          className="text-primary hover:underline font-medium"
        >
          {invoice.invoice_number || `INV-${invoice.id}`}
        </Link>
      ),
    },
    {
      // Usem 'client_name' que ve del RPC per ordenar
      accessorKey: 'client_name',
      header: t('table.client'),
      enableSorting: true,
      cell: (invoice) => {
        const clientDisplayName = invoice.client_name ?? invoice.contacts?.nom ?? '-';
        if (invoice.contact_id) {
          return (
            <Link
              href={`/${locale}/crm/contactes/${invoice.contact_id}?from=${pathname}`}
              className="text-primary hover:underline font-medium"
            >
              {clientDisplayName}
            </Link>
          );
        }
        return clientDisplayName;
      },
    },
    {
      accessorKey: 'issue_date',
      header: t('table.invoiceDate'),
      enableSorting: true,
      cell: (invoice) => formatDate(invoice.issue_date),
    },
    {
      accessorKey: 'due_date',
      header: t('table.dueDate'),
      enableSorting: true,
      cell: (invoice) => invoice.due_date ? formatDate(invoice.due_date) : '-',
    },
    {
      accessorKey: 'total_amount',
      header: t('table.total'),
      enableSorting: true,
      cell: (invoice) => formatCurrency(invoice.total_amount),
    },
    {
      accessorKey: 'status',
      header: t('table.status'),
      enableSorting: true,
      cell: (invoice) => (
        <StatusBadge status={invoice.status as InvoiceStatus} />
      ),
    },
    // Afegim columna d'acciÃ³ EDITAR explÃ­cita
    {
      accessorKey: "actions_edit",
      header: "", // Sense text
      enableSorting: false,
      cell: (invoice) => (
        <Link href={`/${locale}/finances/invoices/${invoice.id}`} title={tShared('actions.edit')}>
          <Button variant="ghost" size="icon"><Edit className="w-4 h-4" /></Button>
        </Link>
      ),
    }
  ], [t, locale, tShared, pathname]); // Afegim locale, tShared i pathname si s'usen

  // --- Hook GenÃ¨ric ---
  const {
    isPending,
    data: invoices, // Renombrem
    itemToDelete: invoiceToDelete, // Renombrem
    setItemToDelete: setInvoiceToDelete,
    handleDelete,
    handleSort,
    currentSortColumn,
    currentSortOrder,
    searchTerm,
    handleSearchChange,
    filters,
    handleFilterChange,
    columnVisibility,
    toggleColumnVisibility,
    page,
    totalPages,
    handlePageChange,
    rowsPerPage,
    handleRowsPerPageChange,
  } = usePaginatedResource<InvoiceListRow, InvoicePageFilters>({
    initialData,
    initialFilters: { status: 'all', contactId: 'all' }, // Filtres inicials
    initialSort: { column: 'issue_date', order: 'desc' }, // OrdenaciÃ³ inicial
    allColumns,
    fetchAction: fetchPaginatedInvoices as (params: FetchInvoicesParams) => Promise<PaginatedInvoicesResponse>,
    deleteAction: async (id: string | number): Promise<ActionResult> => { // Adaptador
      if (typeof id !== 'number') {
        const msg = tShared('errors.invalidId');
        console.error(msg, { id });
        return { success: false, message: msg };
      }
      return deleteInvoiceAction(id); // FunciÃ³ d'eliminaciÃ³ real
    },
    initialRowsPerPage: INVOICE_ROWS_PER_PAGE_OPTIONS[0],
    rowsPerPageOptions: INVOICE_ROWS_PER_PAGE_OPTIONS,
    toastMessages: {
      deleteSuccess: t('toast.deleteSuccess'), // Assegura't que existeix
    }
  });

  // --- Columnes Visibles i DescripciÃ³ Esborrat ---
  const visibleColumns = useMemo(
    () => allColumns.filter(col => columnVisibility[col.accessorKey.toString()] ?? true),
    [allColumns, columnVisibility]
  );

  const deleteDescription = (
    <>
      {tShared('deleteDialog.description1')}{' '}
      <span className="font-bold">{invoiceToDelete?.invoice_number || `INV-${invoiceToDelete?.id}`}</span>.
      <br />
      {tShared('deleteDialog.description2')}
    </>
  );

  // --- RenderitzaciÃ³ ---
  return (
    <div className="flex flex-col gap-4 h-full"> {/* Ajustat gap i h-full */}
      <PageHeader title={t('title')}>
        <Button onClick={() => router.push(`/${locale}/finances/invoices/new`)}>
          <PlusCircle className="mr-2 h-4 w-4" /> {t('newButton')}
        </Button>
      </PageHeader>

      {/* Barra de Filtres / Accions */}
      <div className="flex justify-between items-center">
        {/* La crida aquÃ­ ja estÃ  preparada per a la versiÃ³ corregida de InvoiceFilters */}
        <InvoiceFilters
          searchTerm={searchTerm}
          onSearchChange={handleSearchChange}
          filters={filters} // <-- Passa l'objecte de filtres
          onFilterChange={handleFilterChange} // <-- Passa el gestor genÃ¨ric
          clients={clientsForFilter}
        />
        <ColumnToggleButton
          allColumns={allColumns}
          columnVisibility={columnVisibility}
          toggleColumnVisibility={toggleColumnVisibility}
        />
      </div>

      {/* Taula GenÃ¨rica */}
      <GenericDataTable<InvoiceListRow>
        className="flex-grow overflow-hidden" // Ocupa espai restant
        columns={visibleColumns}
        data={invoices}
        isPending={isPending}
        onSort={handleSort}
        currentSortColumn={currentSortColumn}
        currentSortOrder={currentSortOrder as 'asc' | 'desc' | null}
        page={page}
        totalPages={totalPages}
        onPageChange={handlePageChange}
        rowsPerPage={rowsPerPage}
        onRowsPerPageChange={handleRowsPerPageChange}
        rowsPerPageOptions={INVOICE_ROWS_PER_PAGE_OPTIONS}
        deleteItem={invoiceToDelete}
        setDeleteItem={setInvoiceToDelete}
        onDelete={handleDelete}
        // Assegura't que aquesta clau existeix, sinÃ³ usa una de Shared
        deleteTitleKey="InvoicesPage.deleteDialog.title"
        deleteDescription={deleteDescription}
        emptyStateMessage={t('emptyState')}
      />
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/_components/InvoicesData.tsx ===================

// src/app/[locale]/(app)/finances/invoices/_components/InvoicesData.tsx
import { redirect } from 'next/navigation'; // Per si cal redirigir
import { InvoicesClient } from './InvoiceClient'; // El client refactoritzat
import { fetchPaginatedInvoices, getClientsForFilter, type InvoicePageFilters } from '../actions'; // Accions actualitzades
import { createClient as createServerActionClient } from '@/lib/supabase/server'; // Per validar sessiÃ³
import { getTranslations } from 'next-intl/server'; // Per traduccions d'error

// âœ… CORRECCIÃ“: Les props ara sÃ³n els parÃ metres individuals
interface InvoicesDataProps {
  page?: string;
  perPage?: string;
  sort?: string;
  status?: string;
  search?: string;
}
// Opcions inicials (han de coincidir amb el hook)
const INITIAL_ROWS_PER_PAGE = 10;
const INITIAL_SORT_COLUMN = 'issue_date';
const INITIAL_SORT_ORDER = 'desc';
/**
 * Component ASYNC que carrega les dades inicials per a InvoicesClient.
 */
export async function InvoicesData({}: InvoicesDataProps) { // Ja no necessitem searchParams directament
  const supabase = createServerActionClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    redirect('/login'); // O la teva pÃ gina de login
  }

  const t = await getTranslations('InvoicesPage'); // Per missatges d'error

  try {
    // Obtenim dades inicials i clients en paralÂ·lel
    const [initialDataResult, clientsResult] = await Promise.allSettled([
      fetchPaginatedInvoices({
        searchTerm: '', // O llegir de searchParams si ho prefereixes
        filters: { status: 'all', contactId: 'all' } as InvoicePageFilters,
        sortBy: INITIAL_SORT_COLUMN,
        sortOrder: INITIAL_SORT_ORDER,
        limit: INITIAL_ROWS_PER_PAGE,
        offset: 0,
      }),
      getClientsForFilter() // Obtenim els clients per al filtre
    ]);

    // Gestionem errors
    if (initialDataResult.status === 'rejected') {
      console.error("Error fetching initial invoices data:", initialDataResult.reason);
      throw new Error(t('errors.loadDataFailed') || "Error en carregar les dades inicials de factures.");
    }
    if (clientsResult.status === 'rejected') {
      console.error("Error fetching clients for filter:", clientsResult.reason);
      // Podem continuar sense el filtre de clients
    }

    const initialData = initialDataResult.value;
    const clientsForFilter = clientsResult.status === 'fulfilled' ? clientsResult.value : [];

    // Passem les dades i opcions de filtre al client
    return (
      <InvoicesClient
        initialData={initialData}
        clientsForFilter={clientsForFilter}
      />
    );

  } catch (error) {
    console.error("Unhandled error during InvoicesData loading:", error);
    if (error instanceof Error) {
       throw error;
    }
    throw new Error(t('errors.loadDataFailed') || "No s'han pogut carregar les dades de la pÃ gina de factures.");
  }
}

// =================== FILE: src/app/[locale]/(app)/finances/invoices/_components/InvoicesFilters.tsx ===================

// src/app/[locale]/(app)/finances/invoices/_components/InvoiceFilters.tsx
"use client";

import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
// â— Eliminem Label si ja no s'usa directament per embolcallar
// import { Label } from "@/components/ui/label";
import { useTranslations } from "next-intl";
import { type InvoiceStatus } from "@/types/finances/invoices"; // MantÃ© l'import de tipus
import { type InvoicePageFilters } from '../actions'; // MantÃ© l'import de tipus

// Opcions d'estat
const statusOptions: { value: InvoiceStatus | 'all', labelKey: string }[] = [
    { value: 'all', labelKey: 'allStatuses' },
    { value: 'Draft', labelKey: 'status.Draft' },
    { value: 'Sent', labelKey: 'status.Sent' },
    { value: 'Paid', labelKey: 'status.Paid' },
    { value: 'Overdue', labelKey: 'status.Overdue' },
    { value: 'Cancelled', labelKey: 'status.Cancelled' },
];

// âœ… CORRECCIÃ“: InterfÃ­cie de Props Actualitzada
interface InvoiceFiltersProps {
  searchTerm: string;
  onSearchChange: (value: string) => void;
  // Ara rep l'objecte 'filters'
  filters: InvoicePageFilters;
  // Ara rep el gestor genÃ¨ric 'onFilterChange'
  onFilterChange: (key: keyof InvoicePageFilters, value: string) => void;
  clients?: { id: number; nom: string | null }[];
}

export function InvoiceFilters({
  searchTerm,
  onSearchChange,
  // âœ… Rebem les noves props
  filters,
  onFilterChange,
  clients = [],
}: InvoiceFiltersProps) {
  const t = useTranslations('InvoicesPage.filters');
  const tStatus = useTranslations('Shared.InvoicesPage'); // Ajusta si cal

  return (
    // âœ… Tornem a l'estil simple com a ExpensesFilters
    <div className="flex items-center gap-2">
      <Input
        placeholder={t('searchPlaceholder') || "Busca nÂº o client..."}
        value={searchTerm}
        onChange={(e) => onSearchChange(e.target.value)}
        className="max-w-xs h-9 bg-card border border-input" // Estil unificat
      />

      {/* Filtre per Estat */}
      <Select
        // âœ… Llegim el valor de l'objecte 'filters'
        value={filters.status}
        // âœ… Cridem el gestor genÃ¨ric amb la clau 'status'
        onValueChange={(value) => onFilterChange('status', value)}
      >
        <SelectTrigger className="w-[160px] h-9 bg-card border border-input"> {/* Estil unificat */}
          <SelectValue placeholder={t('statusPlaceholder')} />
        </SelectTrigger>
        <SelectContent>
          {statusOptions.map((option) => (
            <SelectItem key={option.value} value={option.value}>
              {tStatus(option.labelKey, {})}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>

      {/* Filtre per Client (Opcional) */}
      {clients.length > 0 && (
          <Select
              // âœ… Llegim el valor de l'objecte 'filters'
              value={filters.contactId}
              // âœ… Cridem el gestor genÃ¨ric amb la clau 'contactId'
              onValueChange={(value) => onFilterChange('contactId', value)}
          >
              <SelectTrigger className="w-[180px] h-9 bg-card border border-input"> {/* Estil unificat */}
                  <SelectValue placeholder={t('clientPlaceholder') || "Tots els clients"} />
              </SelectTrigger>
              <SelectContent>
                  <SelectItem value="all">{t('allClients') || "Tots els clients"}</SelectItem>
                  {clients.map((client) => (
                      <SelectItem key={client.id} value={String(client.id)}>
                          {client.nom || `Client #${client.id}`}
                      </SelectItem>
                  ))}
              </SelectContent>
          </Select>
      )}
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/products/actions.ts ===================

// /app/[locale]/(app)/crm/products/actions.ts (FITXER CORREGIT I NET)
"use server";

import { revalidatePath } from "next/cache";
import { validateUserSession } from "@/lib/supabase/session";
import { type PaginatedActionParams } from '@/hooks/usePaginateResource';

// âœ… 1. Importem el NOU servei
import * as productService from '@/lib/services/finances/products/products.service';
import { redirect } from 'next/navigation'; // ğŸ‘ˆ 1. Importar redirect
// âœ… 2. Importem els tipus NOMÃ‰S PER A ÃšS INTERN
import type { 
  ProductPageFilters, 
  FormState, 
  PaginatedProductsData,

} from '@/lib/services/finances/products/products.service';

// âŒ TOTS ELS 'export type' S'HAN ELIMINAT

// --- AcciÃ³ per Obtenir Dades Paginades ---
export async function fetchPaginatedProducts(
  params: PaginatedActionParams<ProductPageFilters>
): Promise<PaginatedProductsData> {

  const session = await validateUserSession();
  if ("error" in session) {
    return { data: [], count: 0 };
  }
  const { supabase, activeTeamId } = session;

  return await productService.getPaginatedProducts(supabase, activeTeamId, params);
}

// --- AcciÃ³ per Obtenir Categories Ãšniques (Cache) ---
export async function getUniqueProductCategories(): Promise<string[]> {
  const session = await validateUserSession();
  if ("error" in session) return [];
  
  return productService.getUniqueProductCategories(session.activeTeamId);
}

// --- Funcions CRUD (per a useFormState) ---

export async function createProduct(
  prevState: FormState,
  formData: FormData
): Promise<FormState> {
  const session = await validateUserSession();
  if ('error' in session) {
    return { success: false, message: session.error.message };
  }
  const { supabase, user, activeTeamId } = session;

  const result = await productService.createProduct(supabase, user.id, activeTeamId, formData);

  if (result.success) {
    revalidatePath('/crm/products');
  }

  return result;
}

/**
 * ACCIÃ“: Elimina un producte.
 * Aquesta Ã©s la versiÃ³ corregida.
 */
export async function deleteProduct(productId: number): Promise<FormState> {
  const session = await validateUserSession();
  if ('error' in session) {
    return { success: false, message: session.error.message };
  }
  
  // 1. Obtenim el client 'supabase' autenticat.
  // No necessitem 'activeTeamId' per a la crida.
  const { supabase } = session;

  // 2. âœ… CRIDA CORREGIDA: Cridem al servei nomÃ©s amb (supabase, id)
  const result = await productService.deleteProduct(supabase, productId);

  if (result.success) {
    // 3. Si tÃ© Ã¨xit, revalidem la memÃ²ria cau de la PÃ€GINA DE LLISTA.
    revalidatePath('/finances/products'); 
    
    // 4. Important: NO revalidem la pÃ gina de detall [productId]
    //    perquÃ¨ ja no existeix.

  } else {
    // Si el servei retorna un error, el passem al client
    return { success: false, message: result.message };
  }

  // 5. REDIRECCIÃ“ DES DEL SERVIDOR:
  // Un cop eliminat i revalidat, redirigim l'usuari a la llista.
  // AixÃ² evita la "cursa" (race condition) i el 404.
  redirect(`/finances/products`);
}

// =================== FILE: src/app/[locale]/(app)/finances/products/page.tsx ===================

// /app/[locale]/(app)/crm/products/page.tsx
import { Suspense } from 'react';
import type { Metadata } from 'next';
import { ProductsData } from './_components/ProductsData';
// Importem l'skeleton genÃ¨ric
import { GenericDataTableSkeleton } from '@/components/shared/GenericDataTableSkeleton';

export const metadata: Metadata = {
  title: 'Conceptes | Ribot', // O 'Productes | Ribot'
};

export default function ProductsPage() {
  // Ajusta el nombre de columnes segons la teva taula
  const defaultColumnCount = 7; // name, category, price, vat, unit, active, actions

  return (
    // Ajustem padding si cal, o deixem que el Client ho gestioni
    <div className="h-full"> {/* Assegura't que el contenidor tÃ© alÃ§ada */}
      <Suspense fallback={<GenericDataTableSkeleton columnCount={defaultColumnCount} rowCount={15} />}>
        <ProductsData />
      </Suspense>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/products/schemas.ts ===================

// src/app/[locale]/(app)/crm/products/schemas.ts
import { z } from "zod";
import type { Database } from '@/types/supabase';

// Copiem el tipus Product aquÃ­ si nomÃ©s s'usa relacionat amb l'schema
export type Product = Database['public']['Tables']['products']['Row'];

// Esquema de Zod per al formulari
export const productSchema = z.object({
  name: z.string().min(3, 'El nom ha de tenir almenys 3 carÃ cters.'),
  price: z.coerce.number().positive('El preu ha de ser un nÃºmero positiu.'),
  iva: z.coerce.number().min(0).optional().nullable(),
  discount: z.coerce.number().min(0).max(100).optional().nullable(),
  description: z.string().optional().nullable(),
  category: z.string().optional().nullable(),
  unit: z.string().optional().nullable(),
  is_active: z.boolean().default(true),
});

// Tipus per a l'estat de retorn de les accions de formulari
// Pots moure'l a /types/shared/actionResult.ts si Ã©s mÃ©s genÃ¨ric
export type FormState = {
  success: boolean;
  message: string;
  errors?: Record<string, string[] | undefined>;
  data?: Product | null; // Product del formulari
};

// Pots definir tambÃ© el tipus inferit de l'schema si el necessites sovint
export type ProductFormValues = z.infer<typeof productSchema>;

// =================== FILE: src/app/[locale]/(app)/finances/products/[productId]/actions.ts ===================

// /app/[locale]/(app)/crm/products/[productId]/actions.ts (FITXER CORREGIT)
"use server";

import { revalidatePath } from "next/cache";
import { validateUserSession } from "@/lib/supabase/session";

// âœ… 1. Importem el NOU servei
import * as productService from '@/lib/services/finances/products/products.service';

// âœ… 2. Importem els tipus NOMÃ‰S PER A ÃšS INTERN
import type { 
  Product,
  FormState
} from '@/lib/services/finances/products/products.service';

// âŒ TOTS ELS 'export type' I IMPORTS DE 'schemas' S'HAN ELIMINAT

/**
 * ACCIÃ“: ObtÃ© les dades d'un producte especÃ­fic per ID.
 */
export async function fetchProductDetail(productId: number): Promise<Product> {
    const session = await validateUserSession();
    if ('error' in session) { 
        throw new Error(session.error.message); 
    }
    const { supabase, activeTeamId } = session;

    // Crida al servei
    return await productService.fetchProductDetail(supabase, activeTeamId, productId);
}

/**
 * ACCIÃ“: Actualitza un producte existent.
 */
export async function updateProduct(
  id: number, // L'ID es passa com a primer argument (bind)
  prevState: FormState,
  formData: FormData
): Promise<FormState> {
    const session = await validateUserSession();
    if ('error' in session) {
        return { success: false, message: session.error.message };
    }
    const { supabase } = session;

    // Crida al servei
    const result = await productService.updateProduct(supabase, id, formData);

    // La revalidaciÃ³ es queda a l'acciÃ³
    if (result.success) {
        revalidatePath('/crm/products');
        revalidatePath(`/crm/products/${id}`);
    }
    
    return result;
}

// =================== FILE: src/app/[locale]/(app)/finances/products/[productId]/page.tsx ===================

// src/app/[locale]/(app)/finances/products/[productId]/page.tsx

import { Suspense } from 'react';
import { type Metadata } from 'next';
// âœ… Assegura't que la ruta d'importaciÃ³ de 'actions' Ã©s correcta.
// Si 'actions.ts' Ã©s a 'finances/products', ha de ser '../actions'.
import { fetchProductDetail } from './actions'; 
import { ProductDetailData } from './_components/ProductDetailData';
import { Skeleton } from '@/components/ui/skeleton';

// -------------------------------------------------------------------
// âœ… 1. UNIFICACIÃ“ DE PROPS:
// Definim UNA Ãºnica interfÃ­cie amb 'params' com a Promise.
// -------------------------------------------------------------------
interface ProductDetailPageProps {
  params: Promise<{
    productId: string;
    locale: string; // Incloem 'locale' ja que Ã©s part de la ruta
  }>;
}

// -------------------------------------------------------------------
// âœ… 2. generateMetadata (UTILITZANT LA PROMESA)
// Utilitzem la mateixa interfÃ­cie 'ProductDetailPageProps'.
// -------------------------------------------------------------------
export async function generateMetadata(props: ProductDetailPageProps): Promise<Metadata> {
  
  // âœ… Fem 'await' dels parÃ metres, igual que a la pÃ gina.
  const { productId: productIdString } = await props.params; 
  const productId = parseInt(productIdString, 10);
  
  if (isNaN(productId)) {
    return { title: 'Producte | Ribot' };
  }

  try {
    const product = await fetchProductDetail(productId); 
    if (!product) {
       return { title: 'Producte no trobat | Ribot' };
    }
    return { title: `${product.name} | Productes | Ribot` };
  } catch {
    // Si fetchProductDetail llanÃ§a 'notFound()', Next.js ho gestionarÃ .
    return { title: 'Producte no trobat | Ribot' };
  }
}

// Skeleton simple per a la pÃ gina de detall
function ProductDetailSkeleton() {
    return (
        <div className="space-y-6">
            <Skeleton className="h-9 w-24 mb-4" /> {/* BotÃ³ tornar */}
            <div className="border rounded-lg p-6 space-y-4">
                <div className="flex justify-between items-start">
                    <div className="space-y-1">
                        <Skeleton className="h-7 w-48" /> {/* TÃ­tol */}
                        <Skeleton className="h-4 w-32" /> {/* Categoria */}
                    </div>
                    <Skeleton className="h-6 w-16 rounded-full" /> {/* Badge */}
                </div>
                 <div className="grid gap-4 md:grid-cols-2">
                    <div className="space-y-4">
                        <Skeleton className="h-10 w-full" />
                        <Skeleton className="h-10 w-full" />
                         <Skeleton className="h-10 w-full" />
                    </div>
                     <div className="space-y-4">
                         <Skeleton className="h-16 w-full" />
                         <Skeleton className="h-10 w-full" />
                    </div>
                 </div>
            </div>
        </div>
    );
}

// -------------------------------------------------------------------
// âœ… 3. Component de PÃ gina (UTILITZANT LA PROMESA)
// Aquesta part ja era correcta.
// -------------------------------------------------------------------
export default async function ProductDetailPage(props: ProductDetailPageProps) {
  
  // Resolem la promesa per obtenir els parÃ metres
  const { productId: productIdString } = await props.params;

  const productId = parseInt(productIdString, 10);

  if (isNaN(productId)) {
    const { notFound } = await import('next/navigation');
    notFound();
  }

  return (
    <div className="p-4 md:p-6 lg:p-8 h-full">
      <Suspense fallback={<ProductDetailSkeleton />}>
        {/* Passem el productId validat */}
        <ProductDetailData productId={productId} />
      </Suspense>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/products/[productId]/_components/ProductDetailClient.tsx ===================

// /app/[locale]/(app)/crm/products/[productId]/_components/ProductDetailClient.tsx (FITXER CORREGIT)
"use client";

// âœ… CORRECCIÃ“: Importem 'useActionState' des de 'react'
import { useState, useTransition, useEffect, useActionState } from 'react';
// âŒ ELIMINEM: import { useFormState } from 'react-dom';
import { useTranslations } from 'next-intl';
import { useRouter } from 'next/navigation';
import { toast } from 'sonner';

import { ProductDetailView } from './ProductDetailView';

// âœ… 1. Importem ACCIONS de LLISTA
import { deleteProduct } from '../../actions';
// âœ… 2. Importem ACCIONS de DETALL
import { updateProduct } from '../actions';
// âœ… 3. Importem TIPUS des del SERVEI (Soluciona ts(2459))
import type { FormState, Product } from '@/lib/services/finances/products/products.service';

import { 
  AlertDialog, 
  AlertDialogAction, 
  AlertDialogCancel, 
  AlertDialogContent, 
  AlertDialogDescription, 
  AlertDialogFooter, 
  AlertDialogHeader, 
  AlertDialogTitle 
} from '@/components/ui/alert-dialog';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { ArrowLeft } from 'lucide-react';

interface ProductDetailClientProps {
  product: Product;
}

const initialState: FormState = { success: false, message: "" };

export function ProductDetailClient({ product }: ProductDetailClientProps) {
  const t = useTranslations('ProductsPage');
  const tGlobal = useTranslations('Global');
  const router = useRouter();

  const [isEditing, setIsEditing] = useState(false);
  const [isAlertOpen, setIsAlertOpen] = useState(false);
  const [currentProduct, setCurrentProduct] = useState(product);
  const [isDeletePending, startDeleteTransition] = useTransition();

  // âœ… CORRECCIÃ“: Canviem 'useFormState' per 'useActionState'
  const updateProductWithId = updateProduct.bind(null, currentProduct.id);
  const [formState, formAction] = useActionState(updateProductWithId, initialState);

  // Efecte per gestionar la resposta del formulari
  useEffect(() => {
    if (formState.success) {
      toast.success(formState.message);
      setIsEditing(false); 
      if (formState.data) {
        setCurrentProduct(formState.data);
      }
    } else if (formState.message && !formState.success && !formState.errors) {
       toast.error(formState.message);
    }
  }, [formState]);

  // Gestor per a l'ELIMINACIÃ“
  const handleDelete = () => {
    startDeleteTransition(async () => {
      const result = await deleteProduct(currentProduct.id); // Aquesta crida estÃ  bÃ©
      if (result.success) {
        toast.success(result.message);
        router.push('/crm/products'); 
      } else {
        toast.error(result.message);
      }
      setIsAlertOpen(false);
    });
  };

  if (isEditing) {
    // --- VISTA D'EDICIÃ“ ---
    return (
      <div className="space-y-6">
        <Button variant="outline" onClick={() => router.back()} className="mb-4">
          <ArrowLeft className="w-4 h-4 mr-2" />
          {t('backToList')}
        </Button>
        <Card>
          <CardHeader>
            <CardTitle>{t('editDialog.title')}</CardTitle>
          </CardHeader>
          <CardContent>
            
            {/* AquÃ­ hauries d'inserir el teu component ProductForm */}
            {/* <ProductForm 
                action={formAction} 
                initialState={formState} 
                defaultValues={currentProduct}
                onCancel={() => setIsEditing(false)} 
            /> 
            */}

            {/* Placeholder si encara no tens el formulari */}
            <form action={formAction} className="space-y-4">
              <p>AquÃ­ aniria el teu formulari d'ediciÃ³ (ProductForm).</p>
              {formState.errors && (
                  <div className="text-red-500 text-sm">
                      {Object.values(formState.errors).map(errs => errs.join(', ')).join('; ')}
                  </div>
              )}
              <div className="flex justify-end gap-2 mt-4">
                <Button 
                  type="button"
                  variant="outline" 
                  onClick={() => setIsEditing(false)}
                >
                  {tGlobal('cancel')}
                </Button>
                <Button type="submit">
                  {tGlobal('save')}
                </Button>
              </div>
            </form>
            
          </CardContent>
        </Card>
      </div>
    );
  }

  // --- VISTA DE DETALL (PER DEFECTE) ---
  return (
    <>
      <ProductDetailView 
        product={currentProduct} 
        onEdit={() => setIsEditing(true)}
        onDelete={() => setIsAlertOpen(true)}
      />

      <AlertDialog open={isAlertOpen} onOpenChange={setIsAlertOpen}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>{t('deleteDialog.title')}</AlertDialogTitle>
            <AlertDialogDescription>
              {t('deleteDialog.description')}
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={isDeletePending}>
              {tGlobal('cancel')}
            </AlertDialogCancel>
            <AlertDialogAction 
              onClick={handleDelete} 
              disabled={isDeletePending}
              className="bg-destructive hover:bg-destructive/90"
            >
              {isDeletePending ? tGlobal('deleting') : tGlobal('delete')}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/products/[productId]/_components/ProductDetailData.tsx ===================

// /app/[locale]/(app)/finances/products/[productId]/_components/ProductDetailData.tsx (CORREGIT)

import { notFound } from 'next/navigation'; // ğŸ‘ˆ 1. Importar notFound
import { fetchProductDetail } from '../actions';
import { ProductDetailClient } from './ProductDetailClient';

interface ProductDetailDataProps {
  productId: number;
}

export async function ProductDetailData({ productId }: ProductDetailDataProps) {
  // Nota: Si 'fetchProductDetail' necessita 't', haurÃ s de crear-lo abans
  // const t = await getTranslations('ProductsPage');

  let product;
  try {
    // 2. Cridem l'acciÃ³ per obtenir les dades
    product = await fetchProductDetail(productId);

  } catch (error: unknown) {
    // 3. Si l'acciÃ³ llanÃ§a un error (ex: error de base de dades),
    // el capturem i mostrem la pÃ gina 404.
    if (error instanceof Error) {
      console.error(`[ProductDetailData] Error en carregar el producte ${productId}:`, error.message);
    } else {
      console.error(`[ProductDetailData] Error en carregar el producte ${productId}:`, error);
    }
    return notFound(); 
  }

  // 4. ComprovaciÃ³ addicional per si l'acciÃ³ retorna 'null' en lloc de llanÃ§ar un error
  if (!product) {
    // Si el producte no es troba (null o undefined), mostrem 404
    return notFound();
  }

  // 5. Si tot va bÃ©, renderitzem el component client amb les dades
  return (
    <ProductDetailClient product={product} />
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/products/[productId]/_components/ProductDetailView.tsx ===================

// /app/[locale]/(app)/crm/products/[productId]/_components/ProductDetailView.tsx (FITXER CORREGIT)
"use client";

import { useTranslations } from 'next-intl';
// âœ… CORRECCIÃ“: Importem el tipus des del SERVEI
import type { Product } from '@/lib/services/finances/products/products.service'; 
import { 
  Card, 
  CardContent, 
  CardHeader, 
  CardTitle, 
  CardDescription 
} from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { ArrowLeft, Edit, Trash2 } from 'lucide-react';
import { useRouter } from 'next/navigation';
import { formatCurrency, formatDate } from '@/lib/utils/formatters';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator'; 

interface ProductDetailViewProps {
  product: Product;
  onEdit: () => void;
  onDelete: () => void;
}

// ... (component LabelText es mantÃ© igual) ...
function LabelText({ label, children }: { label: string; children: React.ReactNode }) {
  return (
    <div>
      <p className="text-sm font-medium text-muted-foreground">{label}</p>
      <p className="text-base break-words">{children || '-'}</p>
    </div>
  );
}

export function ProductDetailView({ product, onEdit, onDelete }: ProductDetailViewProps) {
  const t = useTranslations('ProductDetalilPage'); // Canviat a 'ProductDetailPage' (detall)
  const router = useRouter();

  return (
    <div className="space-y-6">
      <Button variant="outline" onClick={() => router.back()} className="mb-4">
        <ArrowLeft className="w-4 h-4 mr-2" />
        {t('backToList')}
      </Button>

      <Card>
        <CardHeader>
          <div className="flex flex-col md:flex-row md:justify-between md:items-start gap-4">
            
            <div className="space-y-2">
              <CardTitle>{product.name}</CardTitle>
              <div className="flex flex-wrap items-center gap-2">
                {product.category && (
                  <CardDescription>{product.category}</CardDescription>
                )}
                <Badge variant={product.is_active ? "default" : "destructive"} className={undefined}>
                  {product.is_active ? t('active') : t('inactive')}
                </Badge>
              </div>
            </div>
            
            <div className="flex-shrink-0 flex gap-2">
              <Button variant="destructive" onClick={onDelete}>
                <Trash2 className="w-4 h-4 mr-2" />
                {t('actions.delete')}
              </Button>
              <Button onClick={onEdit}>
                <Edit className="w-4 h-4 mr-2" />
                {t('actions.edit')}
              </Button>
            </div>
          </div>
        </CardHeader>

        <CardContent className="space-y-6">
          {product.description && (
            <>
              <div>
                <LabelText label={t('form.descriptionLabel')}>{product.description}</LabelText>
              </div>
              <Separator />
            </>
          )}

          <div className="grid gap-6 grid-cols-2 md:grid-cols-3">
            <LabelText label={t('table.price')}>{formatCurrency(product.price ?? 0)}</LabelText>
            <LabelText label={t('table.vat')}>{product.iva !== null ? `${product.iva}%` : '-'}</LabelText>
            <LabelText label={t('form.discountLabel')}>{product.discount !== null ? `${product.discount}%` : '-'}</LabelText>
            <LabelText label={t('table.unit')}>{product.unit}</LabelText>
            <LabelText label={t('table.created')}>{product.created_at ? formatDate(product.created_at) : '-'}</LabelText>
          </div>

        </CardContent>
      </Card>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/products/_components/ProductsClient.tsx ===================

// /app/[locale]/(app)/crm/products/_components/ProductsClient.tsx
"use client";

import { useMemo } from 'react'; // Keep useState for creation dialog
import Link from 'next/link';
import { useLocale, useTranslations } from 'next-intl';
import { Plus, Edit } from 'lucide-react'; // Keep Edit for link, Plus for button

// Tipus i Accions
import { type Product } from "./ProductsData";
import { type ActionResult } from '@/types/shared/actionResult';
import { fetchPaginatedProducts, deleteProduct} from '../actions';
// createProduct/updateProduct actions are used within ProductForm
import type { ProductPageFilters } from '@/lib/services/finances/products/products.service';

// Components Compartits
import { Button } from "@/components/ui/button";
import { GenericDataTable, type ColumnDef } from '@/components/shared/GenericDataTable';
import { ColumnToggleButton } from '@/components/shared/ColumnToggleButton';
import { PageHeader } from '@/components/shared/PageHeader';

// Components EspecÃ­fics
import { ProductsFilters } from './ProductsFilters';

// Hook GenÃ¨ric
import { usePaginatedResource, type PaginatedResponse, type PaginatedActionParams } from '@/hooks/usePaginateResource'; // Corrected path

// Utilitats
import { formatCurrency } from '@/lib/utils/formatters';

// Alias i Constants
type PaginatedProductsResponse = PaginatedResponse<Product>;
type FetchProductsParams = PaginatedActionParams<ProductPageFilters>;
const PRODUCT_ROWS_PER_PAGE_OPTIONS = [15, 30, 50];

// Props del Component
interface ProductsClientProps {
  initialData: PaginatedProductsResponse;
  categoriesForFilter: string[];
}

export function ProductsClient({ initialData, categoriesForFilter }: ProductsClientProps) {
  const t = useTranslations('ProductsPage');
  const tShared = useTranslations('Shared');
  const locale = useLocale();



  // --- Column Definitions ---
  const allColumns = useMemo<ColumnDef<Product>[]>(() => [
    {
      accessorKey: 'name',
      header: t('table.name'),
      enableSorting: true,
      cell: (product) => (
        <Link
          // âœ… Corrected Route: crm/products/
          href={`/${locale}/finances/products/${product.id}`}
          className="font-medium cursor-pointer hover:underline"
          title={`${tShared('actions.view')}: ${product.name}`}
        >
          {product.name}
        </Link>
      ),
    },
    {
      accessorKey: 'category',
      header: t('table.category'),

      enableSorting: true,
      cell: (product) => product.category || '-',

    },
    {
      accessorKey: 'price',
      header: t('table.price'),
      enableSorting: true,
      cell: (product) => formatCurrency(product.price ?? 0),
    },
    {
      accessorKey: 'iva',
      header: t('table.vat'),
      enableSorting: false,
      cell: (product) => (product.iva !== null ? `${product.iva}%` : '-'),
    },
    {
      accessorKey: 'unit',
      header: t('table.unit'),
      enableSorting: false,
      cell: (product) => product.unit || '-',
    },
    {
      accessorKey: 'is_active',
      header: t('table.active'),
      enableSorting: true,
      cell: (product) => (
        <span className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${product.is_active
          ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300'
          : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300'
          }`}>
          {product.is_active ? t('active') : t('inactive')}
        </span>
      ),
    },
    // Action column now only links to detail view (where edit/delete happens)
    {
      accessorKey: "actions_view_edit", // Renamed for clarity
      header: "", // Could add tShared('table.actions') if desired
      enableSorting: false,
      cell: (product) => (
        <Link
          // âœ… Corrected Route: crm/products/
          href={`/${locale}/finances/products/${product.id}`}
          title={tShared('actions.edit')} // Or view/edit
        >
          <Button variant="ghost" size="icon">
            <Edit className="w-4 h-4" />
          </Button>
        </Link>
      ),
      cellClassName: "text-right",
    }
  ], [t, tShared, locale]);

  // --- Generic Hook ---
  const {
    isPending,
    data: products,
    itemToDelete: productToDelete,
    setItemToDelete: setProductToDelete,
    handleDelete,
    handleSort,
    currentSortColumn,
    currentSortOrder,
    searchTerm,
    handleSearchChange,
    filters,
    handleFilterChange,
    columnVisibility,
    toggleColumnVisibility,
    page,
    totalPages,
    handlePageChange,
    rowsPerPage,
    handleRowsPerPageChange,
    // Add forceRefetch if implemented in the hook
    // forceRefetch,
  } = usePaginatedResource<Product, ProductPageFilters>({
    initialData,
    initialFilters: { category: 'all' },
    initialSort: { column: 'name', order: 'asc' },
    allColumns,
    fetchAction: fetchPaginatedProducts as (params: FetchProductsParams) => Promise<PaginatedProductsResponse>,
    // âœ… Adapter for deleteProduct (Product ID is number)
    deleteAction: async (id: string | number): Promise<ActionResult> => {
      if (typeof id !== 'number') {
        const msg = tShared('errors.invalidId') + " (expected number)";
        console.error(msg, { id });
        return { success: false, message: msg };
      }
      // Assuming deleteProduct expects number and returns ActionResult
      return deleteProduct(id);
    },
    initialRowsPerPage: PRODUCT_ROWS_PER_PAGE_OPTIONS[0],
    rowsPerPageOptions: PRODUCT_ROWS_PER_PAGE_OPTIONS,
    toastMessages: {
      deleteSuccess: t('toast.deleteSuccess'),
    }
  });



  // --- Visible Columns & Delete Description ---
  const visibleColumns = useMemo(
    () => allColumns.filter(col => {
      const key = ('id' in col && col.id)
        ? col.id.toString()
        : col.accessorKey?.toString();
      return key ? (columnVisibility[key] ?? true) : true;
    }),
    [allColumns, columnVisibility]
  );

  const deleteDescription = (
    <>
      {tShared('deleteDialog.description1')}{' '}
      <span className="font-bold">{productToDelete?.name}</span>.
      <br />
      {tShared('deleteDialog.description2')}
    </>
  );

  // --- Rendering ---
  return (
    <div className="h-full flex flex-col gap-4">
      {/* Page Header with Create Button triggering Dialog */}
      {/* CapÃ§alera i Botons */}
      {/* âœ… SubstituÃ¯m la capÃ§alera manual per PageHeader */}
      <PageHeader title={t('title')}>
        {/* El botÃ³ "Nou Producte" va com a 'children' */}
        <Button asChild>
          <Link href={`/${locale}/finances/products/new`}>
            <Plus className="w-4 h-4 mr-1" /> {t('newProductButton')}
          </Link>
        </Button>
      </PageHeader>

      {/* Filters Bar */}
      <div className="flex justify-between items-center">
        <ProductsFilters
          searchTerm={searchTerm}
          onSearchChange={handleSearchChange}
          filters={filters}
          onFilterChange={handleFilterChange}
          categories={categoriesForFilter}
        />
        <ColumnToggleButton
          allColumns={allColumns}
          columnVisibility={columnVisibility}
          toggleColumnVisibility={toggleColumnVisibility}
        />
      </div>

      {/* Data Table */}
      <GenericDataTable<Product>
        className="flex-grow overflow-hidden"
        columns={visibleColumns}
        data={products}
        isPending={isPending}
        onSort={handleSort}
        currentSortColumn={currentSortColumn}
        currentSortOrder={currentSortOrder as 'asc' | 'desc' | null}
        page={page}
        totalPages={totalPages}
        onPageChange={handlePageChange}
        rowsPerPage={rowsPerPage}
        onRowsPerPageChange={handleRowsPerPageChange}
        rowsPerPageOptions={PRODUCT_ROWS_PER_PAGE_OPTIONS}
        deleteItem={productToDelete}
        setDeleteItem={setProductToDelete}
        onDelete={handleDelete} // Delete confirmation handled by GenericDataTable
        deleteTitleKey="deleteDialog.title" // Use shared key
        deleteDescription={deleteDescription}
        emptyStateMessage={t('noProductsFound')}
      />
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/products/_components/ProductsData.tsx ===================

// /app/[locale]/(app)/crm/products/_components/ProductsData.tsx (FITXER CORREGIT)
import { ProductsClient } from "./ProductsClient";
import { type Database } from '@/types/supabase';
import { getTranslations } from 'next-intl/server';

// âœ… 1. Importem les ACCIONS des d'../actions
import { fetchPaginatedProducts, getUniqueProductCategories } from '../actions';

// âœ… 2. Importem els TIPUS des del SERVEI
import type { ProductPageFilters } from '@/lib/services/finances/products/products.service';
export type Product = Database['public']['Tables']['products']['Row'];

// Constants inicials
const INITIAL_ROWS_PER_PAGE = 15; 
const INITIAL_SORT_COLUMN = 'name';
const INITIAL_SORT_ORDER = 'asc';

export async function ProductsData() {
    const t = await getTranslations('ProductsPage'); 

    try {
        const [initialDataResult, categoriesResult] = await Promise.allSettled([
            fetchPaginatedProducts({
                searchTerm: '',
                filters: { category: 'all' } as ProductPageFilters, // âœ… Aquest tipus ara es troba
                sortBy: INITIAL_SORT_COLUMN,
                sortOrder: INITIAL_SORT_ORDER,
                limit: INITIAL_ROWS_PER_PAGE,
                offset: 0,
            }),
            getUniqueProductCategories()
        ]);

        // Gestionem errors
        if (initialDataResult.status === 'rejected') {
            console.error("Error fetching initial products data:", initialDataResult.reason);
            throw new Error(t('errors.loadDataFailed') || "Error en carregar les dades inicials de productes.");
        }
        if (categoriesResult.status === 'rejected') {
            console.error("Error fetching product categories:", categoriesResult.reason);
        }

        const initialData = initialDataResult.value;
        const categoriesForFilter = categoriesResult.status === 'fulfilled' ? categoriesResult.value : [];

        return (
            <ProductsClient
                initialData={initialData}
                categoriesForFilter={categoriesForFilter}
            />
        );

    } catch (error) {
        console.error("Unhandled error during ProductsData loading:", error);
        if (error instanceof Error) {
           throw error;
        }
        throw new Error(t('errors.loadDataFailed') || "No s'han pogut carregar les dades.");
    }
}

// =================== FILE: src/app/[locale]/(app)/finances/products/_components/ProductsFilters.tsx ===================

// /app/[locale]/(app)/crm/products/_components/ProductsFilters.tsx
'use client';

import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { useTranslations } from "next-intl";
import type { ProductPageFilters } from '@/lib/services/finances/products/products.service';

interface ProductsFiltersProps {
  searchTerm: string;
  onSearchChange: (value: string) => void;
  filters: ProductPageFilters;
  onFilterChange: (key: keyof ProductPageFilters, value: string) => void;
  categories: string[];
}

export function ProductsFilters({
  searchTerm,
  onSearchChange,
  filters,
  onFilterChange,
  categories,
}: ProductsFiltersProps) {
  const t = useTranslations('ProductsPage'); // O un namespace especÃ­fic de filtres

  return (
    <div className="flex items-center gap-2">
      <Input
        placeholder={t('searchPlaceholder') || "Busca per nom..."}
        value={searchTerm}
        onChange={(e) => onSearchChange(e.target.value)}
        className="max-w-xs h-9 bg-card border border-input"
      />
      <Select
        value={filters.category}
        onValueChange={(value) => onFilterChange('category', value)}
      >
        <SelectTrigger className="w-[180px] h-9 bg-card border border-input">
          <SelectValue placeholder={t('categoryFilterPlaceholder') || "Totes les categories"} />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="all">{t('allCategories') || "Totes les categories"}</SelectItem>
          {categories.map(cat => (
            <SelectItem key={cat} value={cat}>
              {cat}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/quotes/actions.ts ===================

// /app/[locale]/(app)/finances/quotes/actions.ts (FITXER CORREGIT)
"use server";

import { revalidatePath } from "next/cache";
import { validateUserSession } from "@/lib/supabase/session";
import { type ActionResult } from "@/types/shared/actionResult";
import { type PaginatedActionParams } from "@/hooks/usePaginateResource";

// Importem les funcions del servei
import {
  getPaginatedQuotes,
  deleteQuote,
} from "@/lib/services/finances/quotes/quotes.service"; // Assegura't que la ruta al servei Ã©s correcta

// Importem els tipus centralitzats (NOMÃ‰S PER A ÃšS INTERN)
import {
  type QuotePageFilters,
  type PaginatedQuotesData,
  type QuoteId,
} from "@/types/finances/quotes";

// âŒ ELIMINEM LA LÃNIA QUE CAUSA L'ERROR
// export * from "@/types/finances/quotes";

// Definim el tipus d'entrada per a l'acciÃ³
type FetchQuotesParams = PaginatedActionParams<QuotePageFilters>;

/**
 * ACCIÃ“: ObtÃ© les dades paginades.
 */
export async function fetchPaginatedQuotes(
  params: FetchQuotesParams,
): Promise<PaginatedQuotesData> {
  const session = await validateUserSession();
  if ("error" in session) return { data: [], count: 0 };
  
  const { supabase, activeTeamId } = session;

  return await getPaginatedQuotes(supabase, activeTeamId, params);
}

/**
 * ACCIÃ“: Esborra un pressupost.
 */
export async function deleteQuoteAction(
  quoteId: QuoteId,
): Promise<ActionResult> {
  const session = await validateUserSession();
  if ("error" in session) {
    return { success: false, message: session.error.message };
  }
  const { supabase } = session;

  if (!quoteId) {
    return { success: false, message: "ID de pressupost invÃ lid." };
  }

  const { error } = await deleteQuote(supabase, quoteId);

  if (error) {
    console.error("Error deleting quote (action):", error);
    return {
      success: false,
      message: `No s'ha pogut eliminar el pressupost: ${error.message}`,
    };
  }

  // âœ… CORRECCIÃ“: Revalidem la ruta de finances
  revalidatePath("/finances/quotes"); 
  return { success: true, message: "Pressupost eliminat correctament." };
}

// =================== FILE: src/app/[locale]/(app)/finances/quotes/page.tsx ===================

// /app/[locale]/(app)/crm/quotes/page.tsx
import { Suspense } from 'react';
import type { Metadata } from 'next';
import { QuotesData } from './_components/QuotesData'; // Component de dades refactoritzat
import { GenericDataTableSkeleton } from '@/components/shared/GenericDataTableSkeleton'; // Skeleton genÃ¨ric

export const metadata: Metadata = {
  title: 'Pressupostos | Ribot',
};

// Ja no necessitem rebre props aquÃ­
export default async function QuotesPage() {

  // Ajusta el nombre de columnes
  const defaultColumnCount = 6; // number, client, issue_date, total, status, actions

  return (
    // Ajustem padding/alÃ§ada
    <div className="h-full">
      <Suspense fallback={<GenericDataTableSkeleton columnCount={defaultColumnCount} rowCount={10} />}>
        {/* QuotesData gestiona la cÃ rrega inicial */}
        <QuotesData />
      </Suspense>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/quotes/[id]/actions.ts ===================

// /app/[locale]/(app)/finances/quotes/[id]/actions.ts (FITXER CORREGIT)
"use server";

import { revalidatePath } from "next/cache";
import { validateUserSession } from "@/lib/supabase/session";
import { type ActionResult } from "@/types/shared/index";

// âœ… NOU: Importem els serveis
import {
  saveQuote,
  deleteQuote,
  createProduct,
  sendQuote,
  updateTeamProfile,
} from "@/lib/services/finances/quotes/quote-editor.service"; // Assegura't que la ruta al servei Ã©s correcta

// âœ… NOU: Importem els tipus NOMÃ‰S PER A ÃšS INTERN (ja no s'exporten)
import { type QuotePayload, type Product, type Team } from "@/types/finances/quotes";

// âŒ LÃNIA ELIMINADA QUE CAUSAVA L'ERROR:
// export * from "@/types/finances/quotes";

/**
 * ACCIÃ“: Desa (crea o actualitza) un pressupost.
 */
export async function saveQuoteAction(
  quoteData: QuotePayload,
): Promise<ActionResult<number>> {
  const session = await validateUserSession();
  if ("error" in session)
    return { success: false, message: session.error.message };
  const { supabase, activeTeamId } = session;

  const result = await saveQuote(supabase, quoteData, activeTeamId);

  if (result.success && result.data) {
    const finalQuoteId = result.data;
    revalidatePath("/finances/quotes"); 
    revalidatePath(`/finances/quotes/${finalQuoteId}`); 
  }
  
  return result;
}

/**
 * ACCIÃ“: Esborra un pressupost.
 */
export async function deleteQuoteAction(quoteId: number): Promise<ActionResult> {
  const session = await validateUserSession();
  if ("error" in session)
    return { success: false, message: session.error.message };
  const { supabase } = session;

  const { error } = await deleteQuote(supabase, quoteId);

  if (error) {
    return { success: false, message: error.message || "Error en eliminar el pressupost." };
  }

  revalidatePath("/finances/quotes"); 
  return { success: true, message: "Pressupost eliminat." };
}

/**
 * ACCIÃ“: Crea un nou producte.
 */
export async function createProductAction(newProduct: {
  name: string;
  price: number;
}): Promise<ActionResult<Product>> {
  const session = await validateUserSession();
  if ("error" in session)
    return { success: false, message: session.error.message };
  const { supabase, user, activeTeamId } = session;

  const result = await createProduct(supabase, newProduct, user.id, activeTeamId);

  if (result.success) {
    revalidatePath(`/finances/quotes`, "layout"); 
  }
  
  return result;
}


/**
 * ACCIÃ“: Envia el pressupost per email.
 */
export async function sendQuoteAction(quoteId: number): Promise<ActionResult> {
  const session = await validateUserSession();
  if ("error" in session)
    return { success: false, message: session.error.message };

  // âœ… CORRECCIÃ“ CLAU: Ara passem l'objecte 'user' complet
  const { supabase, user } = session;

  // âœ… El nostre servei 'sendQuote' ara necessita 'supabase', 'user', i 'quoteId'
  const result = await sendQuote(supabase, user, quoteId);

  if (result.success) {
    revalidatePath(`/finances/quotes/${quoteId}`);
  }

  return result;
}

/**
 * ACCIÃ“: Actualitza el perfil de l'equip.
 */
export async function updateTeamProfileAction(
  teamData: Partial<Team>,
): Promise<ActionResult<Team>> {
  const session = await validateUserSession();
  if ("error" in session)
    return { success: false, message: session.error.message };
  const { supabase, activeTeamId } = session;

  const result = await updateTeamProfile(supabase, teamData, activeTeamId);
  
  if (result.success) {
    revalidatePath(`/finances/quotes/[id]`, "page"); 
  }
  
  return result;
}

// =================== FILE: src/app/[locale]/(app)/finances/quotes/[id]/page.tsx ===================

import { Suspense } from 'react';
import { type Metadata } from 'next';
import { QuoteEditorData } from './_components/QuoteEditorData';
import { QuoteEditorSkeleton } from './_components/QuoteEditorSkeleton';

// -------------------------------------------------------------------
// âœ… CORRECCIÃ“: Definim el tipus de les props amb 'params' com una Promise
// -------------------------------------------------------------------
interface QuoteEditorPageProps {
    params: Promise<{ id: string; locale: string }>;
}

/**
 * FunciÃ³ per generar metadades dinÃ miques.
 */
export async function generateMetadata(props: QuoteEditorPageProps): Promise<Metadata> {
    // Resolem la promesa per accedir als parÃ metres
    const { id } = await props.params;

    if (id === 'new') {
        return { title: 'Nou Pressupost | Ribot' };
    }
    return { title: `Editar Pressupost | Ribot` };
}

/**
 * Component de la pÃ gina per editar o crear un pressupost.
 */
// -------------------------------------------------------------------
// âœ… CORRECCIÃ“: El component de pÃ gina esdevÃ© 'async' i espera 'props.params'
// -------------------------------------------------------------------
export default async function QuoteEditorPage(props: QuoteEditorPageProps) {
    // Resolem la promesa per obtenir els valors de 'id' i 'locale'
    const { id, locale } = await props.params;

    return (
        <div className="h-full">
            <Suspense fallback={<QuoteEditorSkeleton />}>
                {/* Passem les variables ja resoltes al component de dades */}
                <QuoteEditorData quoteId={id} locale={locale} />
            </Suspense>
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/finances/quotes/[id]/_components/CompanyProfileDialog.tsx ===================

// /app/[locale]/(app)/finances/quotes/[id]/_components/CompanyProfileDialog.tsx (FITXER CORREGIT)
"use client";

import React, { useState, useEffect, useTransition } from 'react';
import { toast } from "sonner";
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from '@/components/ui/dialog';
import { Loader2, Upload } from 'lucide-react';
import { createClient } from '@/lib/supabase/client';
import Image from 'next/image';
import { useTranslations } from 'next-intl';

// âœ… CORRECCIÃ“: Importem l'ACCIÃ“ des del fitxer d'accions
import { updateTeamProfileAction } from '../actions';
// âœ… CORRECCIÃ“: Importem el TIPUS directament des del fitxer de tipus
import { type Team } from '@/types/finances/quotes';


export function CompanyProfileDialog({ open, onOpenChange, profile, onProfileUpdate }: {
    open: boolean;
    onOpenChange: (isOpen: boolean) => void;
    profile: Team | null;
    onProfileUpdate: (newProfile: Team) => void;
}) {
    const t = useTranslations('QuoteEditor');
    const [localProfile, setLocalProfile] = useState<Partial<Team>>({});
    const [isSaving, startSaveTransition] = useTransition();
    const [isUploading, setIsUploading] = useState(false);
    const supabase = createClient();

    useEffect(() => {
        if (profile) {
            setLocalProfile(profile);
        }
    }, [profile]);

    const handleLogoUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
        const file = event.target.files?.[0];
        if (!file || !profile?.id) return;

        setIsUploading(true);
        const filePath = `${profile.id}/logo-${Date.now()}`;
        const { error } = await supabase.storage.from('logos').upload(filePath, file, { upsert: true });

        if (error) {
            toast.error(t('toast.errorTitle'), { description: t('toast.logoUploadError') });
        } else {
            const { data } = supabase.storage.from('logos').getPublicUrl(filePath);
            setLocalProfile(p => ({ ...p, logo_url: data.publicUrl }));
        }
        setIsUploading(false);
    };

    const handleSaveProfile = () => {
        startSaveTransition(async () => {
            const result = await updateTeamProfileAction(localProfile);

            if (result.success && result.data) {
                toast.success(t('toast.successTitle'), { description: result.message });
                onProfileUpdate(result.data);
                onOpenChange(false);
            } else {
                toast.error(t('toast.errorTitle'), { description: result.message });
            }
        });
    };

    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const { name, value } = e.target;
        setLocalProfile(prev => ({ ...prev, [name]: value }));
    };

    return (
        <Dialog open={open} onOpenChange={onOpenChange}>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>{t('companyProfileDialog.title')}</DialogTitle>
                    <DialogDescription>{t('companyProfileDialog.description')}</DialogDescription>
                </DialogHeader>
                <div className="space-y-4 py-4 max-h-[60vh] overflow-y-auto">
                    <div>
                        <Label>{t('companyProfileDialog.logoLabel')}</Label>
                        <div className="mt-1 flex items-center gap-4">
                            {localProfile.logo_url ? (
                                <Image src={localProfile.logo_url} alt={t('companyProfileDialog.logoAlt')} width={64} height={64} className="object-contain rounded-lg bg-muted p-1" />
                            ) : <div className="h-16 w-16 bg-muted rounded-lg" />}
                            <Button asChild variant="outline">
                                <label htmlFor="logo-upload" className="cursor-pointer flex items-center gap-2">
                                    {isUploading ? <Loader2 className="animate-spin" /> : <Upload className="w-4 h-4" />}
                                    {t('companyProfileDialog.uploadButton')}
                                </label>
                            </Button>
                            <input id="logo-upload" type="file" accept="image/*" className="hidden" onChange={handleLogoUpload} disabled={isUploading} />
                        </div>
                    </div>
                    {/* Camps del perfil */}
                    <div><Label htmlFor="name">{t('companyProfileDialog.nameLabel')}</Label><Input id="name" name="name" value={localProfile.name || ''} onChange={handleInputChange} /></div>
                    <div><Label htmlFor="tax_id">{t('companyProfileDialog.taxIdLabel')}</Label><Input id="tax_id" name="tax_id" value={localProfile.tax_id || ''} onChange={handleInputChange} /></div>
                    <div><Label htmlFor="address">{t('companyProfileDialog.addressLabel')}</Label><Input id="address" name="address" value={localProfile.address || ''} onChange={handleInputChange} /></div>
                    <div><Label htmlFor="email">{t('companyProfileDialog.emailLabel')}</Label><Input id="email" name="email" type="email" value={localProfile.email || ''} onChange={handleInputChange} /></div>
                    <div><Label htmlFor="phone">{t('companyProfileDialog.phoneLabel')}</Label><Input id="phone" name="phone" value={localProfile.phone || ''} onChange={handleInputChange} /></div>
                </div>
                <DialogFooter>
                    <Button onClick={() => onOpenChange(false)} variant="ghost">{t('buttons.cancel')}</Button>
                    <Button onClick={handleSaveProfile} disabled={isSaving}>
                        {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                        {t('companyProfileDialog.saveButton')}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
};

// =================== FILE: src/app/[locale]/(app)/finances/quotes/[id]/_components/PDF/QuoteDownloadButton.tsx ===================

'use client'

import React, { useState } from 'react'
// âœ… 1. Importem 'pdf' en lloc de 'PDFDownloadLink'
import { pdf } from '@react-pdf/renderer'
import { Button } from '@/components/ui/button'
import { Download, Loader2 } from 'lucide-react'
import { QuotePdfDocument } from './QuotePdfDocument' // El teu document PDF
import { type EditableQuote } from '../../_hooks/useQuoteEditor'
import { type Database } from '@/types/supabase'
// âœ… 2. Importem 'saveAs' per gestionar la descÃ rrega
import { saveAs } from 'file-saver'

// --- Tipus (es mantenen igual) ---
type Contact = Database['public']['Tables']['contacts']['Row']
type Team = Database['public']['Tables']['teams']['Row']

interface QuoteDownloadButtonProps {
  quote: EditableQuote
  company: Team | null
  contact: Contact | null
  totals: {
    subtotal: number
    discountAmount: number
    tax: number
    total: number
  }
  className?: string
  t: (key: string) => string
}

export function QuoteDownloadButton({
  quote,
  company,
  contact,
  totals,
  className,
  t,
}: QuoteDownloadButtonProps) {
  // âœ… 3. Afegim un estat local per controlar la generaciÃ³
  const [isGenerating, setIsGenerating] = useState(false)

  const fileName = `pressupost-${quote.quote_number || quote.id}.pdf`

  // âœ… 4. Creem la funciÃ³ de descÃ rrega imperativa
  const handleDownload = async () => {
    setIsGenerating(true)

    // ValidaciÃ³ important: No intentis generar un PDF sense dades clau
    if (!contact || !company) {
      console.error('Falten dades de contacte o empresa per generar el PDF.')
      // AquÃ­ podries mostrar un toast d'error
      setIsGenerating(false)
      return
    }

    try {
      // Pas 1: Defineix l'element del document
      const doc = (
        <QuotePdfDocument
          quote={quote}
          company={company}
          contact={contact}
          // Passem els totals desestructurats (com ja feies)
          {...totals}
        />
      )

      // Pas 2: Genera el PDF com a Blob
      // Aquest Ã©s el moment on pot fallar si 'QuotePdfDocument' tÃ©
      // el problema de tipus (Number vs String)
      const blob = await pdf(doc).toBlob()

      // Pas 3: Inicia la descÃ rrega amb file-saver
      saveAs(blob, fileName)
    } catch (error) {
      console.error('Error generant el PDF on-demand:', error)
      // AquÃ­ Ã©s on veuries l'error si 'QuotePdfDocument' segueix incorrecte
      // Mostra un toast a l'usuari informant de l'error
    } finally {
      setIsGenerating(false)
    }
  }

  // âœ… 5. El JSX ara Ã©s un simple botÃ³ que crida 'handleDownload'
  return (
    <Button
      type="button"
      variant="outline"
      disabled={isGenerating} // Desactivat mentre es genera
      size="icon"
      title={t('quoteEditor.downloadPDF')}
      className={className}
      onClick={handleDownload} // El 'onClick' ara Ã©s la nostra funciÃ³
    >
      {isGenerating ? (
        <Loader2 className="w-4 h-4 animate-spin" />
      ) : (
        <Download className="w-4 h-4" />
      )}
    </Button>
  )
}

// =================== FILE: src/app/[locale]/(app)/finances/quotes/[id]/_components/PDF/QuotePdfDocument.tsx ===================

// /src/app/[locale]/(app)/finances/quotes/[id]/_components/PDF/QuotePdfDocument.tsx (CORREGIT)
// NO 'use client'
import {
  Document,
  Page,
  Text,
  View,
  StyleSheet,
  Image,
} from '@react-pdf/renderer'
import { type EditableQuote } from '../../_hooks/useQuoteEditor'
import { type Database } from '@/types/supabase'

// Defineix els tipus com ho fas a InvoicePdfDocument
type Contact = Database['public']['Tables']['contacts']['Row']
type Team = Database['public']['Tables']['teams']['Row']

// --- Helpers de Format ---
const formatCurrency = (value: number | null) => {
  const num = Number(value || 0)
  return `${num.toFixed(2)} â‚¬`
}

const formatDate = (dateString: string | null) => {
  if (!dateString) return 'N/A'
  try {
    const date = new Date(dateString)
    const day = String(date.getUTCDate()).padStart(2, '0')
    const month = String(date.getUTCMonth() + 1).padStart(2, '0')
    const year = date.getUTCFullYear()
    return `${day}/${month}/${year}`
  } catch (e) {
    return 'Data invÃ lida'
  }
}

// --- Estils (TraducciÃ³ de Tailwind) ---
const styles = StyleSheet.create({
  page: {
    padding: 30,
    fontFamily: 'Helvetica',
    fontSize: 10,
    color: '#333',
    backgroundColor: '#ffffff',
  },
  header: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    borderBottomWidth: 2,
    borderBottomColor: '#e5e7eb',
    paddingBottom: 8,
  },
  logo: {
    maxWidth: 100,
    height: 70,
    objectFit: 'contain',
  },
  logoPlaceholder: {
    height: 48,
    width: 112,
    backgroundColor: '#f3f4f6',
    alignItems: 'center',
    justifyContent: 'center',
  },
  logoPlaceholderText: {
    color: '#9ca3af',
    fontSize: 9,
  },
  headerRight: {
    textAlign: 'right',
    marginLeft: 8,
  },
  companyName: {
    fontFamily: 'Helvetica-Bold',
    fontSize: 16,
  },
  quoteNumber: {
    color: '#6b7280',
    fontSize: 14,
    marginTop: 2,
  },
  section: {
    flexDirection: 'row',
    gap: 32,
    marginVertical: 16,
  },
  sectionColumn: {
    flex: 1,
  },
  sectionColumnRight: {
    flex: 1,
    textAlign: 'right',
  },
  textBold: {
    fontFamily: 'Helvetica-Bold',
  },
  textGray: {
    color: '#4b5563',
  },
  sectionDates: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginVertical: 20,
  },
  dateBox: {
    textAlign: 'left',
  },
  dateBoxRight: {
    textAlign: 'right',
  },
  dateLabel: {
    fontSize: 9,
    color: '#6b7280',
    fontFamily: 'Helvetica-Bold',
    textTransform: 'uppercase',
  },
  table: {
    width: '100%',
  },
  tableHeader: {
    backgroundColor: '#f3f4f6',
    flexDirection: 'row',
  },
  tableHeaderCell: {
    padding: 6,
    fontSize: 9,
    fontFamily: 'Helvetica-Bold',
    textTransform: 'uppercase',
  },
  tableRow: {
    flexDirection: 'row',
    borderBottomWidth: 1,
    borderBottomColor: '#e5e7eb',
  },
  tableCell: {
    padding: 6,
    fontSize: 10,
  },
  colDesc: {
    width: '50%',
  },
  colQty: {
    width: '15%',
    textAlign: 'center',
  },
  colPrice: {
    width: '15%',
    textAlign: 'right',
  },
  colTotal: {
    width: '20%',
    textAlign: 'right',
  },
  colDescNoQty: {
    width: '80%',
  },
  colTotalNoQty: {
    width: '20%',
    textAlign: 'right',
  },
  textMedium: {
    fontFamily: 'Helvetica-Bold',
  },
  totalsContainer: {
    flexDirection: 'row',
    justifyContent: 'flex-end',
    marginTop: 24,
  },
  totalsBox: {
    width: '35%',
  },
  totalsRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: 3,
  },
  totalsRowGreen: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    color: '#059669',
    marginBottom: 3,
  },
  totalsFinal: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    fontFamily: 'Helvetica-Bold',
    fontSize: 16,
    marginTop: 8,
    paddingTop: 8,
    borderTopWidth: 2,
    borderTopColor: '#111827',
  },
  footer: {
    marginTop: 40,
    paddingTop: 24,
    borderTopWidth: 1,
    borderTopColor: '#e5e7eb',
  },
  footerTitle: {
    fontFamily: 'Helvetica-Bold',
    marginBottom: 8,
  },
  footerNotes: {
    fontSize: 10,
    color: '#4b5563',
  },
})

// --- Props del Document ---
interface QuotePdfDocumentProps {
  quote: EditableQuote
  company: Team | null
  contact: Contact | null
  subtotal: number
  discountAmount: number
  tax: number
  total: number
}

// --- Component Pur del PDF ---
export function QuotePdfDocument({
  quote,
  company,
  contact,
  subtotal,
  discountAmount,
  tax,
  total,
}: QuotePdfDocumentProps) {
  const base = subtotal - discountAmount
  const showQuantity = quote.show_quantity ?? true

  return (
    <Document>
      <Page size="A4" style={styles.page}>
        {/* --- CAPÃ‡ALERA --- */}
        <View style={styles.header}>
          {company?.logo_url ? (
            <Image
              src={company.logo_url} // Passem la URL pÃºblica directament
              style={styles.logo}
            />
          ) : (
            <View style={styles.logoPlaceholder}>
              <Text style={styles.logoPlaceholderText}>Logo</Text>
            </View>
          )}
          <View style={styles.headerRight}>
            <Text style={styles.companyName}>
              {company?.name || 'La Teva Empresa'}
            </Text>
            <Text style={styles.quoteNumber}>
              # {quote.quote_number || 'Pendent'}
            </Text>
          </View>
        </View>

        {/* --- INFO EMPRESA / CLIENT --- */}
        <View style={styles.section}>
          <View style={styles.sectionColumn}>
            <Text style={styles.textBold}>
              {company?.name || 'La Teva Empresa'}
            </Text>
            <Text style={styles.textGray}>{company?.address}</Text>
            <Text style={styles.textGray}>{company?.tax_id}</Text>
            <Text style={styles.textGray}>{company?.email}</Text>
          </View>
          <View style={styles.sectionColumnRight}>
            <Text style={styles.textBold}>
              {contact?.nom || 'Client no seleccionat'}
            </Text>
            <Text style={styles.textGray}>{contact?.empresa}</Text>
            <Text style={styles.textGray}>{contact?.email}</Text>
          </View>
        </View>

        {/* --- DATES --- */}
        <View style={styles.sectionDates}>
          <View style={styles.dateBox}>
            <Text style={styles.dateLabel}>Data d'emissiÃ³</Text>
            <Text>{formatDate(quote.issue_date)}</Text>
          </View>
          <View style={styles.dateBoxRight}>
            <Text style={styles.dateLabel}>Data de venciment</Text>
            <Text>{formatDate(quote.expiry_date)}</Text>
          </View>
        </View>

        {/* --- TAULA D'ÃTEMS --- */}
        <View style={styles.table}>
          <View style={styles.tableHeader}>
            <Text
              style={[
                styles.tableHeaderCell,
                showQuantity ? styles.colDesc : styles.colDescNoQty,
              ]}
            >
              Ãtem
            </Text>
            {showQuantity && (
              <>
                <Text style={[styles.tableHeaderCell, styles.colQty]}>
                  Quant.
                </Text>
                <Text style={[styles.tableHeaderCell, styles.colPrice]}>
                  Preu
                </Text>
              </>
            )}
            <Text
              style={[
                styles.tableHeaderCell,
                showQuantity ? styles.colTotal : styles.colTotalNoQty,
              ]}
            >
              Total
            </Text>
          </View>

          {/* Body */}
          {(quote.items || []).map((item, index) => (
            <View key={item.id || index} style={styles.tableRow}>
              <Text
                style={[
                  styles.tableCell,
                  showQuantity ? styles.colDesc : styles.colDescNoQty,
                ]}
              >
                {item.description}
              </Text>
              {showQuantity && (
                <>
                  {/* âœ… CORRECCIÃ“ 1: Convertim a String */}
                  <Text style={[styles.tableCell, styles.colQty]}>
                    {String(item.quantity ?? 1)}
                  </Text>
                  <Text style={[styles.tableCell, styles.colPrice]}>
                    {formatCurrency(item.unit_price ?? 0)}
                  </Text>
                </>
              )}
              <Text
                style={[
                  styles.tableCell,
                  styles.textMedium,
                  showQuantity ? styles.colTotal : styles.colTotalNoQty,
                ]}
              >
                {formatCurrency((item.quantity || 0) * (item.unit_price || 0))}
              </Text>
            </View>
          ))}
        </View>

        {/* --- TOTALS --- */}
        <View style={styles.totalsContainer}>
          <View style={styles.totalsBox}>
            <View style={styles.totalsRow}>
              <Text style={styles.textGray}>Subtotal:</Text>
              <Text>{formatCurrency(subtotal)}</Text>
            </View>

            {quote.discount && quote.discount > 0 && (
              <View style={styles.totalsRowGreen}>
                {/* âœ… CORRECCIÃ“ 2: Convertim a String */}
                <Text>Descompte ({String(quote.discount)}%)</Text>
                <Text>-{formatCurrency(discountAmount)}</Text>
              </View>
            )}

            <View style={styles.totalsRow}>
              <Text style={styles.textGray}>Base Imposable:</Text>
              <Text>{formatCurrency(base)}</Text>
            </View>

            <View style={styles.totalsRow}>
              {/* âœ… CORRECCIÃ“ 3: Convertim a String */}
              <Text style={styles.textGray}>
                IVA ({String(quote.tax_percent ?? 21)}%)
              </Text>
              <Text>{formatCurrency(tax)}</Text>
            </View>

            <View style={styles.totalsFinal}>
              <Text>TOTAL:</Text>
              <Text>{formatCurrency(total)}</Text>
            </View>
          </View>
        </View>

        {/* --- PEU DE PÃ€GINA (NOTES) --- */}
        {quote.notes && (
          <View style={styles.footer}>
            <Text style={styles.footerTitle}>Notes i Condicions</Text>
            <Text style={styles.footerNotes}>{quote.notes}</Text>
          </View>
        )}
      </Page>
    </Document>
  )
}

// =================== FILE: src/app/[locale]/(app)/finances/quotes/[id]/_components/QuoteEditorClient.tsx ===================

// /app/[locale]/(app)/crm/quotes/[id]/_components/QuoteEditorClient.tsx (Refactoritzat per al Disseny)
"use client";

import React from 'react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Loader2, ArrowLeft, Send, Trash2, Building, Download } from 'lucide-react';

import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";

import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from '@/components/ui/alert-dialog';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Switch } from "@/components/ui/switch";
import { type Database } from '@/types/supabase';
import { useQuoteEditor, type EditableQuote } from '../_hooks/useQuoteEditor';
import { CompanyProfileDialog } from './CompanyProfileDialog';
import { QuoteMeta } from './QuoteMeta';
import { QuoteItems } from './QuoteItems';
import { QuoteTotals } from './QuoteTotals';
import { QuotePreview } from './QuotePreview';
import { Separator } from '@/components/ui/separator'; // Importem el separador
import { QuoteDownloadButton } from './PDF/QuoteDownloadButton'; // Importem el botÃ³ de descÃ rrega


// --- Tipus Derivats de la Base de Dades ---
type Contact = Database['public']['Tables']['contacts']['Row'];
type Product = Database['public']['Tables']['products']['Row'];
type Opportunity = Database['public']['Tables']['opportunities']['Row'];
type Team = Database['public']['Tables']['teams']['Row'];

interface QuoteEditorClientProps {
    initialQuote: EditableQuote;
    contacts: Contact[];
    products: Product[];
    companyProfile: Team | null;
    initialOpportunities: Opportunity[];
    userId: string;
    locale: string;
}

export function QuoteEditorClient(props: QuoteEditorClientProps) { // âŒ 'pdfUrl' eliminat de les props    

    const router = useRouter();

    const {
        state,
        quote,
        onQuoteChange,
        onItemsChange,
        setCurrentTeamData,
        setIsDeleteDialogOpen,
        setIsProfileDialogOpen,
        subtotal, discountAmount, tax, total,
        handleSave, handleDelete, handleSend,
        isSaving, isSending,
        t
    } = useQuoteEditor(props); // Passem la resta de props al hook

    // FunciÃ³ per a la navegaciÃ³ enrere
    const handleBack = () => router.push(`/${props.locale}/finances/quotes`);

    // -------------------------------------------------------------
    // FunciÃ³ de Renderitzat per a l'Estat d'Enviament (Card)
    // -------------------------------------------------------------
    const SentStatusCard = () => {
        if (!quote.sent_at) return null;

        const sentDate = new Date(quote.sent_at).toLocaleDateString(props.locale, {
            day: '2-digit',
            month: 'short', // 'short' per a estalviar espai a la capÃ§alera
            year: 'numeric'
        });

        return (
            <div
                // âœ… Ãšs de fons 'success' per indicar estat positiu, amb text negre.
                className="inline-flex items-center px-3 py-1 bg-green-100 text-green-800 rounded-lg text-sm font-medium whitespace-nowrap"
            >
                {t('quoteEditor.sentOn', { date: sentDate })}
            </div>
        );
    };

    return (
        <>
            <CompanyProfileDialog
                open={state.isProfileDialogOpen}
                onOpenChange={setIsProfileDialogOpen}
                profile={state.currentTeamData}
                onProfileUpdate={setCurrentTeamData}
            />
            <AlertDialog open={state.isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>
                <AlertDialogContent>
                    <AlertDialogHeader>
                        <AlertDialogTitle>{t('quoteEditor.deleteDialogTitle')}</AlertDialogTitle>
                        <AlertDialogDescription>{t('quoteEditor.deleteDialogDescription')}</AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                        <AlertDialogCancel disabled={isSaving}>CancelÂ·lar</AlertDialogCancel>
                        <AlertDialogAction onClick={handleDelete} className="bg-destructive hover:bg-destructive/90" disabled={isSaving}>
                            {isSaving && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
                            Confirmar EliminaciÃ³
                        </AlertDialogAction>
                    </AlertDialogFooter>
                </AlertDialogContent>
            </AlertDialog>

            <div className="flex flex-col h-full">
                {/* ------------------------------------------------------------- */}
                {/* âœ… NOVA CAPÃ‡ALERA RESPONSIVE PER A MÃ’BIL I ESCRIPTORI */}
                {/* ------------------------------------------------------------- */}
                <header className="flex flex-col gap-3 sm:flex-row sm:justify-between sm:items-center mb-6 flex-shrink-0">
                    {/* Esquerra: botÃ³ enrere + estat */}
                    <div className="flex flex-wrap items-center gap-2">
                        <Button variant="outline" onClick={handleBack} className="flex-shrink-0">
                            <ArrowLeft className="w-4 h-4 mr-2" />
                            {t('quoteEditor.backButton')}
                        </Button>
                        <SentStatusCard />
                    </div>

                    {/* Dreta: accions */}
                    <div className="flex flex-wrap justify-start sm:justify-end items-center gap-2 w-full sm:w-auto">
                        {/* DescÃ rrega PDF */}
                        {typeof quote.id === 'number' ? (
                            <QuoteDownloadButton
                                quote={quote}
                                company={state.currentTeamData}
                                contact={props.contacts.find(c => c.id === quote.contact_id) || null}
                                totals={{ subtotal, discountAmount, tax, total }}
                                t={t}
                            />
                        ) : (
                            <TooltipProvider>
                                <Tooltip>
                                    <TooltipTrigger asChild>
                                        <span>
                                            <Button variant="outline" size="icon" disabled>
                                                <Download className="h-4 w-4" />
                                            </Button>
                                        </span>
                                    </TooltipTrigger>
                                    <TooltipContent>
                                        <p>{t('quoteEditor.pdfNotAvailableYet')}</p>
                                    </TooltipContent>
                                </Tooltip>
                            </TooltipProvider>
                        )}

                        {/* Dades empresa */}
                        <Button
                            variant="ghost"
                            size="icon"
                            onClick={() => setIsProfileDialogOpen(true)}
                            title={t('quoteEditor.companyDataTooltip')}
                        >
                            <Building className="w-4 h-4" />
                        </Button>

                        {/* Eliminar (si no Ã©s nou) */}
                        {quote.id !== 'new' && (
                            <Button
                                variant="outline"
                                size="icon"
                                onClick={() => setIsDeleteDialogOpen(true)}
                                title={t('quoteEditor.deleteTooltip')}
                            >
                                <Trash2 className="w-4 h-4 text-destructive" />
                            </Button>
                        )}

                        {/* Guardar */}
                        <Button
                            onClick={handleSave}
                            disabled={isSaving || isSending}
                            className="min-w-[110px] w-full sm:w-auto"
                        >
                            {isSaving && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
                            {quote.id === 'new'
                                ? t('quoteEditor.createButton')
                                : t('quoteEditor.saveButton')}
                        </Button>

                        {/* Enviar */}
                        {quote.id !== 'new' && (
                            <Button
                                onClick={handleSend}
                                disabled={isSaving || isSending}
                                className="min-w-[120px] w-full sm:w-auto"
                            >
                                {isSending ? (
                                    <>
                                        <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                        {state.sendingStatus === 'generating' && t('quoteEditor.generatingPDF')}
                                        {state.sendingStatus === 'uploading' && t('quoteEditor.uploadingFile')}
                                        {state.sendingStatus === 'sending' && t('quoteEditor.sending')}
                                    </>
                                ) : (
                                    <>
                                        <Send className="mr-2 h-4 w-4" />
                                        {quote.sent_at
                                            ? t('quoteEditor.resendButton')
                                            : t('quoteEditor.sendButton')}
                                    </>
                                )}
                            </Button>
                        )}
                    </div>
                </header>

                {/* âŒ Eliminem l'anterior div de sent_at, ja no Ã©s necessari */}

                <main className="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-8 min-h-0">
                    <section className="flex flex-col gap-4 overflow-y-auto pr-4">

                        {/* ------------------------------------------------------------- */}
                        {/* âœ… Ãšs de Card per sortir del fons gris ('glass-card' a 'Card') */}
                        {/* ------------------------------------------------------------- */}
                        <Card className="p-4">
                            <QuoteMeta
                                contact_id={quote.contact_id !== null && quote.contact_id !== undefined ? String(quote.contact_id) : null}
                                quote_number={quote.quote_number}
                                issue_date={quote.issue_date}
                                expiry_date={quote.expiry_date ?? null}
                                onMetaChange={onQuoteChange}
                                contacts={props.contacts}
                            />
                        </Card>

                        <Card className="p-4">
                            <Label>{t('quoteEditor.clientOpportunitiesLabel')}</Label>
                            {state.contactOpportunities.length > 0 ? (
                                <Select
                                    value={quote.opportunity_id ? String(quote.opportunity_id) : ''}
                                    onValueChange={(value) => onQuoteChange('opportunity_id', value ? Number(value) : null)}
                                    disabled={!quote.contact_id}
                                >
                                    <SelectTrigger className="w-full text-foreground">
                                        <SelectValue placeholder="Selecciona una oportunitat" />
                                    </SelectTrigger>
                                    <SelectContent>
                                        {state.contactOpportunities.map(o => (
                                            <SelectItem key={o.id} value={String(o.id)}>
                                                {o.name} ({o.stage_name})
                                            </SelectItem>
                                        ))}
                                    </SelectContent>
                                </Select>
                            ) : (
                                <p className="mt-2 text-sm text-muted-foreground">{t('quoteEditor.noOpenOpportunities')}</p>
                            )}
                        </Card>

                        <Card className="p-2">
                            <QuoteItems
                                items={quote.items || []}
                                onItemsChange={onItemsChange}
                                products={props.products}
                                userId={props.userId}
                            />
                            <Separator className="my-4" />
                            <QuoteTotals
                                subtotal={subtotal}
                                discount={quote.discount}
                                setDiscount={(d) => onQuoteChange('discount', d)}
                                discountAmount={discountAmount}
                                tax={tax}
                                total={total}
                                tax_percent={quote.tax_percent}
                                setTaxPercent={(p) => onQuoteChange('tax_percent', p)}
                            />
                        </Card>

                        <Card>
                            <CardHeader><CardTitle>{t('options.title')}</CardTitle></CardHeader>
                            <CardContent>
                                <div className="flex items-center space-x-2">
                                    <Switch
                                        id="show-quantity"
                                        checked={quote.show_quantity ?? true}
                                        onCheckedChange={(checked) => onQuoteChange('show_quantity', checked)}
                                    />
                                    <Label htmlFor="show-quantity">{t('options.showQuantitiesLabel')}</Label>
                                </div>
                                <p className="text-sm text-muted-foreground mt-2">{t('options.showQuantitiesDescription')}</p>
                            </CardContent>
                        </Card>

                        <Card className="p-4">
                            <Label>Notes Addicionals</Label>
                            <Textarea
                                value={quote.notes ?? ''}
                                onChange={(e) => onQuoteChange('notes', e.target.value)}
                                className="mt-2 min-h-[220px]"
                            />
                        </Card>
                    </section>

                    <aside id="quote-preview-for-pdf-wrapper" className="hidden lg:block glass-card p-4 overflow-y-auto">
                        <QuotePreview
                            quote={quote}
                            contacts={props.contacts}
                            companyProfile={state.currentTeamData}
                            subtotal={subtotal}
                            discountAmount={discountAmount}
                            tax={tax}
                            total={total}
                        />
                    </aside>
                </main>
            </div>
        </>
    );
}

// =================== FILE: src/app/[locale]/(app)/finances/quotes/[id]/_components/QuoteEditorData.tsx ===================

// /app/[locale]/(app)/crm/quotes/[id]/_components/QuoteEditorData.tsx (CORREGIT)

import { redirect } from 'next/navigation'
import { QuoteEditorClient } from './QuoteEditorClient'
import { validatePageSession } from '@/lib/supabase/session'
import type { Database } from '@/types/supabase'
import crypto from 'crypto' // Per al randomUUID del newQuote

// --- Tipus Derivats ---
type Quote = Database['public']['Tables']['quotes']['Row']
type QuoteItem = Database['public']['Tables']['quote_items']['Row']
type Opportunity = Database['public']['Tables']['opportunities']['Row']
type Team = Database['public']['Tables']['teams']['Row']
type QuoteDetailsResponse = {
  quote: Quote & { items: QuoteItem[] }
  opportunities: Opportunity[]
}

interface QuoteEditorDataProps {
  quoteId: string
  locale: string
}

type NewQuote = Omit<Quote, 'id' | 'created_at'> & {
  id: 'new'
  items: Partial<QuoteItem>[]
  created_at: string
}
type InitialQuoteType = (Quote & { items: QuoteItem[] }) | NewQuote

export async function QuoteEditorData({
  quoteId,
  locale,
}: QuoteEditorDataProps) {
  const { supabase, user, activeTeamId } = await validatePageSession()

  // --- LÃ’GICA PER A UN PRESSUPOST NOU ---
  if (quoteId === 'new') {
    const [contactsRes, productsRes, teamRes, lastQuoteRes] = await Promise.all([
      supabase.from('contacts').select('*').eq('team_id', activeTeamId), // Afegit filtre team_id
      supabase
        .from('products')
        .select('*')
        .eq('is_active', true)
        .eq('team_id', activeTeamId),
      supabase.from('teams').select('*').eq('id', activeTeamId).single(),
      supabase
        .from('quotes')
        .select('sequence_number')
        .eq('team_id', activeTeamId)
        .order('sequence_number', { ascending: false })
        .limit(1)
        .maybeSingle(),
    ])

    if (
      contactsRes.error ||
      productsRes.error ||
      teamRes.error ||
      lastQuoteRes.error
    ) {
      console.error('Error en carregar les dades per a un nou pressupost:', {
        contacts: contactsRes.error,
        products: productsRes.error,
        team: teamRes.error,
        lastQuote: lastQuoteRes.error,
      })
      return <div>Error en carregar les dades de l'editor.</div>
    }

    const lastSequence = lastQuoteRes.data?.sequence_number || 0
    const nextSequence = lastSequence + 1
    const year = new Date().getFullYear()
    const formattedQuoteNumber = `PRE-${year}-${String(
      nextSequence
    ).padStart(4, '0')}`

    const initialQuote: NewQuote = {
      id: 'new',
      team_id: activeTeamId,
      user_id: user.id,
      contact_id: null,
      opportunity_id: null,
      quote_number: formattedQuoteNumber,
      sequence_number: nextSequence,
      issue_date: new Date().toISOString().slice(0, 10),
      expiry_date: null,
      status: 'Draft',
      notes: 'GrÃ cies pel vostre interÃ¨s en els nostres serveis.',
      subtotal: 0,
      discount: 0,
      tax: 0,
      tax_percent: 21,
      total: 0,
      show_quantity: true,
      created_at: new Date().toISOString(),
      sent_at: null,
      rejection_reason: null,
      send_at: null,
      theme_color: null,
      secure_id: crypto.randomUUID(),
      items: [
        {
          description: '',
          quantity: 1,
          unit_price: 0,
          total: 0,
        },
      ],
    }

    return (
      <QuoteEditorClient
        initialQuote={initialQuote as InitialQuoteType}
        contacts={contactsRes.data || []}
        products={productsRes.data || []}
        companyProfile={teamRes.data as Team | null}
        initialOpportunities={[]}
        userId={user.id}
        locale={locale}
        // âŒ Prop 'pdfUrl' eliminada. Ja no Ã©s necessÃ ria.
      />
    )
  }

  // --- LÃ’GICA PER A EDITAR UN PRESSUPOST EXISTENT ---
  const [contactsRes, productsRes, teamRes, quoteDetailsRes] = await Promise.all([
    supabase.from('contacts').select('*').eq('team_id', activeTeamId), // Afegit filtre
    supabase
      .from('products')
      .select('*')
      .eq('is_active', true)
      .eq('team_id', activeTeamId),
    supabase.from('teams').select('*').eq('id', activeTeamId).single(),
    supabase
      .rpc('get_quote_details', { p_quote_id: Number(quoteId) })
      .single<QuoteDetailsResponse>(),
  ])

  if (
    contactsRes.error ||
    productsRes.error ||
    teamRes.error ||
    quoteDetailsRes.error
  ) {
    console.error("Error en carregar les dades d'un pressupost existent:", {
      /* ... errors ... */
    })
    return <div>Error en carregar les dades de l'editor.</div>
  }

  const quoteDetails = quoteDetailsRes.data

  if (!quoteDetails?.quote) {
    redirect(`/${locale}/finances/quotes`) // Canviat de 'crm/quotes' a 'finances/quotes'
  }

  // âŒ LÃ’GICA ELIMINADA: Ja no busquem 'createSignedUrl'.
  // El PDF es genera al client.

  return (
    <QuoteEditorClient
      initialQuote={quoteDetails.quote}
      contacts={contactsRes.data || []}
      products={productsRes.data || []}
      companyProfile={teamRes.data as Team | null}
      initialOpportunities={quoteDetails.opportunities || []}
      userId={user.id}
      locale={locale}
      // âŒ Prop 'pdfUrl' eliminada. Ja no Ã©s necessÃ ria.
    />
  )
}

// =================== FILE: src/app/[locale]/(app)/finances/quotes/[id]/_components/QuoteEditorSkeleton.tsx ===================

"use client";



/**
 * @summary Mostra un esquelet de cÃ rrega per a la pÃ gina de l'Editor de Pressupostos.
 */
export function QuoteEditorSkeleton() {
  return (
    <div className="animate-pulse h-full">
      {/* Esquelet de la CapÃ§alera */}
      <header className="flex justify-between items-center mb-6 flex-shrink-0">
        <div className="h-9 w-36 bg-gray-700/50 rounded-md"></div>
        <div className="flex items-center gap-2">
          <div className="h-10 w-10 bg-gray-700/50 rounded-md"></div>
          <div className="h-10 w-10 bg-gray-700/50 rounded-md"></div>
          <div className="h-10 w-32 bg-gray-700/50 rounded-md"></div>
        </div>
      </header>

      {/* Esquelet del Contingut Principal */}
      <main className="grid grid-cols-1 lg:grid-cols-2 gap-8 min-h-0">
        {/* Columna Esquerra (Formulari) */}
        <section className="flex flex-col gap-6 overflow-y-auto">
          <div className="glass-card p-6 h-48"></div>
          <div className="glass-card p-6 h-96"></div>
          <div className="glass-card p-6 h-32"></div>
        </section>
        {/* Columna Dreta (PrevisualitzaciÃ³) */}
        <aside className="hidden lg:block glass-card p-4 h-[80vh]"></aside>
      </main>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/quotes/[id]/_components/QuoteItems.tsx ===================

// /app/[locale]/(app)/crm/quotes/[id]/_components/QuoteItems.tsx (REFACTORITZAT)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Trash2 } from 'lucide-react';
import TextareaAutosize from 'react-textarea-autosize';
import { useTranslations } from 'next-intl';
import { type Database } from '@/types/supabase';
import { useQuoteItems } from '../_hooks/useQuoteItems';

// âœ… Importem el component reutilitzable
import { ProductSelector } from '@/components/shared/ProductSelector';

// --- Tipus Derivats de la Base de Dades ---
type QuoteItem = Database['public']['Tables']['quote_items']['Row'];
type Product = Database['public']['Tables']['products']['Row'];

interface QuoteItemsProps {
    items: Partial<QuoteItem>[];
    onItemsChange: (newItems: Partial<QuoteItem>[]) => void;
    products: Product[];
    userId: string;
}

export const QuoteItems: React.FC<QuoteItemsProps> = (props) => {
    const t = useTranslations('QuoteEditor.items');

    // âœ… Creem una funciÃ³ 't' especÃ­fica per al selector.
    // AixÃ² assumeix que les teves traduccions estan a "QuoteEditor.items.productSelector.*"
    // Ex: "QuoteEditor.items.productSelector.addButton"
    const t_selector = (key: string) => t(`productSelector.${key}`);

    const {
        // â›” Aquests estats/handlers ja no existeixen aquÃ­
        // isSavingProduct, isCreating, setIsCreating,
        // newProduct, setNewProduct, isPopoverOpen, setIsPopoverOpen,
        // handleSaveNewProduct,

        // âœ… Aquests sÃ³n els handlers que utilitzarem
        handleItemChange,
        handleAddProduct, // Callback per ProductSelector
        handleRemoveItem,
        handleManualItem    // Callback per ProductSelector
    } = useQuoteItems({
        items: props.items,
        onItemsChange: props.onItemsChange,
        userId: props.userId
    });

    return (
        <div className="p-4">
            <h3 className="font-semibold text-lg mb-4">{t('title')}</h3>
            <div className="space-y-2">
                {props.items.length === 0 && (
                    <div className="text-center text-sm text-muted-foreground py-4 border border-dashed rounded-lg">
                        {t('empty')}
                    </div>
                )}
                {props.items.map((item, index) => (
                    <div key={index} className="flex items-start gap-2">
                        <TextareaAutosize
                            placeholder={t('placeholderDescription')}
                            value={item.description || ''}
                            onChange={(e) => handleItemChange(index, 'description', e.target.value)}
                            minRows={1}
                            className="flex w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 min-w-[300px]"
                        />
                        <Input type="number" value={item.quantity ?? 1} onChange={(e) => handleItemChange(index, 'quantity', parseFloat(e.target.value) || 1)} className="w-20" />
                        <Input type="number" value={item.unit_price ?? 0} onChange={(e) => handleItemChange(index, 'unit_price', parseFloat(e.target.value) || 0)} className="w-24" />
                        <div className="w-24 text-right font-mono pt-2">â‚¬{((item.quantity || 0) * (item.unit_price || 0)).toFixed(2)}</div>
                        <Button variant="ghost" size="icon" onClick={() => handleRemoveItem(index)}><Trash2 className="w-4 h-4 text-destructive" /></Button>
                    </div>
                ))}
            </div>

            {/* âœ… AquÃ­ substituÃ¯m tot el Popover/Command/Form pel nou component */}
            <ProductSelector
                products={props.products}
                onProductSelect={handleAddProduct}
                onManualAdd={handleManualItem}
                t={t_selector}
            />
            {/* â›” Tot el codi antic de <Popover>...</Popover> s'ha eliminat */}
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/finances/quotes/[id]/_components/QuoteMeta.tsx ===================

// /app/[locale]/(app)/crm/quotes/[id]/_components/QuoteMeta.tsx (Refactoritzat per al Disseny)
"use client";

import React from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from "@/components/ui/command";
import { Check, ChevronsUpDown } from 'lucide-react';
import { cn } from '@/lib/utils/utils';
import { useTranslations } from 'next-intl';
import type { Database } from '@/types/supabase';
import type { EditableQuote } from '../_hooks/useQuoteEditor';

// --- Tipus Derivats de la Base de Dades ---
type ContactSelection = Pick<Database['public']['Tables']['contacts']['Row'], 'id' | 'nom' | 'empresa'>;

/**
 * Component per gestionar les metadades d'un pressupost.
 */

interface QuoteMetaProps {
    contact_id: string | null;
    quote_number: string;
    issue_date: string;
    expiry_date: string | null;
    onMetaChange: <K extends keyof EditableQuote>(field: K, value: EditableQuote[K]) => void;
    contacts: ContactSelection[];
}

export const QuoteMeta = ({
    contact_id,
    quote_number,
    issue_date,
    expiry_date,
    onMetaChange,
    contacts
}: QuoteMetaProps) => {
    const [isContactPopoverOpen, setIsContactPopoverOpen] = React.useState(false);
    const selectedContact = contacts.find(c => c.id === (contact_id !== null ? Number(contact_id) : null));
    const t = useTranslations('QuoteEditor.meta');

    const formatDateForInput = (dateString: string | null) => {
        if (!dateString) return '';
        try {
            return dateString.split('T')[0];
        } catch {
            return '';
        }
    };

    return (
        // âŒ Eliminem el 'glass-card p-2' ja que s'ha mogut a la Card pare
        <div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <Label>{t('clientLabel')}</Label>
                    <Popover
                        open={isContactPopoverOpen}
                        onOpenChange={setIsContactPopoverOpen}
                    >                        <PopoverTrigger asChild>
                            {/* âœ… CORRECCIÃ“: Afegim 'text-foreground' (negre/fosc) al botÃ³ per visibilitat */}
                            <Button variant="outline" role="combobox" className="w-full justify-between search-input text-left font-normal mt-1 text-foreground">
                                {selectedContact ? (
                                    // âœ… Ãšs de text-foreground per al text principal.
                                    <span className="text-foreground">
                                        {`${selectedContact.nom} `}
                                        <span className="text-muted-foreground text-xs">
                                            ({selectedContact.empresa || ''})
                                        </span>
                                    </span>
                                ) : t('selectClientPlaceholder')}
                                <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                            </Button>
                        </PopoverTrigger>
                        <PopoverContent className="w-[--radix-popover-trigger-width] p-0 glass-effect">
                            <Command>
                                <CommandInput placeholder={t('searchClientPlaceholder')} />
                                <CommandList>
                                    <CommandEmpty>{t('noClientFound')}</CommandEmpty>
                                    <CommandGroup>
                                        {contacts.map((c) => (
                                            <CommandItem
                                                key={c.id}
                                                value={`${c.nom} ${c.empresa}`}
                                                // âœ… MILLORA 3: A l'onSelect, actualitzem el valor I tanquem el Popover.
                                                onSelect={() => {
                                                    onMetaChange("contact_id", c.id);
                                                    setIsContactPopoverOpen(false); // Tanquem el popover
                                                }}
                                            >
                                                <Check
                                                    className={cn(
                                                        "mr-2 h-4 w-4",
                                                        contact_id !== null && Number(contact_id) === c.id
                                                            ? "opacity-100"
                                                            : "opacity-0",
                                                    )}
                                                />
                                                <span className="text-foreground">{c.nom}</span>
                                                <span className="text-xs text-muted-foreground ml-2">
                                                    {c.empresa}
                                                </span>
                                            </CommandItem>
                                        ))}
                                    </CommandGroup>
                                </CommandList>
                            </Command>
                        </PopoverContent>
                    </Popover>
                </div>
                <div className="flex flex-col">
                    <Label htmlFor="quote_number" className="mb-1">{t('quoteNumberLabel')}</Label>
                    <Input
                        id="quote_number"
                        type="text"
                        value={quote_number || ''}
                        onChange={(e) => onMetaChange('quote_number', e.target.value)}
                    />
                </div>
                <div className="flex flex-col">
                    <Label htmlFor="issue_date" className="mb-1">{t('issueDateLabel')}</Label>
                    <Input
                        id="issue_date"
                        type="date"
                        value={formatDateForInput(issue_date)}
                        onChange={(e) => onMetaChange('issue_date', e.target.value)}
                    />
                </div>
                <div className="flex flex-col">
                    <Label htmlFor="expiry_date" className="mb-1">{t('expiryDateLabel')}</Label>
                    <Input
                        id="expiry_date"
                        type="date"
                        value={formatDateForInput(expiry_date)}
                        onChange={(e) => onMetaChange('expiry_date', e.target.value || null)}
                    />
                </div>
            </div>
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/finances/quotes/[id]/_components/QuotePreview.tsx ===================

// /app/[locale]/(app)/crm/quotes/[id]/_components/QuotePreview.tsx (Refactoritzat)
"use client";

import React from 'react';
import { useTranslations } from 'next-intl';
// âœ… 1. Importem els tipus correctes des de la BD i el hook.
import { type Database } from '@/types/supabase';
import { type EditableQuote } from '../_hooks/useQuoteEditor';

// âœ… 2. Definim els tipus locals a partir de la BD.
type Contact = Database['public']['Tables']['contacts']['Row'];
type Team = Database['public']['Tables']['teams']['Row'];

interface QuotePreviewProps {
    quote: EditableQuote;
    contacts: Contact[];
    companyProfile: Team | null; // <-- Ara Ã©s de tipus 'Team'
    subtotal: number;
    discountAmount: number;
    tax: number;
    total: number;
}

export const QuotePreview = ({
    quote,
    contacts,
    companyProfile, // <-- Ja no es diu 'displayProfile', rep el 'team' directament
    subtotal,
    discountAmount,
    tax,
    total
}: QuotePreviewProps) => {
    const contact = contacts.find(c => c.id === quote.contact_id);
    const base = subtotal - discountAmount;
    const t = useTranslations('QuoteEditor');

    // â›” La funciÃ³ 'mapTeamDataToProfile' i el tipus 'CompanyProfile' ja no sÃ³n necessaris.

    return (
        <aside className="hidden lg:block glass-card overflow-y-auto">
            <div id="quote-preview-for-pdf">
                <div className="bg-white text-gray-900 px-8 py-2 font-sans text-sm">
                    <header className="flex justify-between items-center border-b-2 border-gray-200">
                        {companyProfile?.logo_url ? (
                            // eslint-disable-next-line @next/next/no-img-element
                            <img
                                src={companyProfile.logo_url}
                                alt="Logo"
                                style={{ maxWidth: '100px', height: '70px', objectFit: 'contain' }}
                                crossOrigin="anonymous"
                            />
                        ) : (
                            <div className="h-12 w-28 flex items-center justify-center bg-gray-100 text-gray-400 text-xs rounded">
                                {t('preview.logoPlaceholder')}
                            </div>
                        )}
                        <div className="text-right ml-2">
                            {/* âœ… 3. Accedim a les propietats del tipus 'Team'. */}
                            <p className="font-bold text-lg">{companyProfile?.name || t('preview.yourCompany')}</p>
                            <p className="text-gray-500 text-base mt-0"># {quote.quote_number || t('preview.pending')}</p>
                        </div>
                    </header>

                    <section className="grid grid-cols-2 gap-8 my-4">
                        <div>
                            <p className="font-semibold">{companyProfile?.name || t('preview.yourCompany')}</p>
                            <p className="text-gray-600">{companyProfile?.address}</p>
                            <p className="text-gray-600">{companyProfile?.tax_id}</p>
                            <p className="text-gray-600">{companyProfile?.email}</p>
                        </div>
                        <div className="text-right">
                            <p className="font-semibold">{contact?.nom || t('preview.unselectedClient')}</p>
                            <p className="text-gray-600">{contact?.empresa}</p>
                            <p className="text-gray-600">{contact?.email}</p>
                        </div>
                    </section>

                    {/* ---------------- DATES ---------------- */}
                    <section className="grid grid-cols-2 gap-8 my-6">
                        <div>
                            <p className="text-xs text-gray-500 font-bold">{t('preview.issueDate')}</p>
                            <p>
                                {quote.issue_date
                                    ? new Date(quote.issue_date).toLocaleDateString('ca-ES', { timeZone: 'UTC' })
                                    : ''}
                            </p>
                        </div>

                        <div className="text-right">
                            <p className="text-xs text-gray-500 font-bold">{t('preview.expiryDate')}</p>
                            <p>
                                {quote.expiry_date
                                    ? new Date(quote.expiry_date).toLocaleDateString('ca-ES', { timeZone: 'UTC' })
                                    : 'N/A'}
                            </p>
                        </div>
                    </section>

                    {/* ---------------- TAULA D'ITEMS ---------------- */}
                    {/* ---------------- TAULA D'ITEMS (AMB LÃ’GICA CONDICIONAL) ---------------- */}
                    <section>
                        <table className="w-full">
                            <thead className="bg-gray-100">
                                <tr>
                                    <th className="p-2 text-left font-bold text-xs uppercase w-[60%]">
                                        {t('preview.itemHeader')}
                                    </th>

                                    {/* âœ… Mostrem/amaguem les columnes segons la preferÃ¨ncia */}
                                    {(quote.show_quantity ?? true) && (
                                        <>
                                            <th className="p-2 text-center font-bold text-xs uppercase">
                                                {t('preview.quantityHeader')}
                                            </th>
                                            <th className="p-2 text-right font-bold text-xs uppercase">
                                                {t('preview.priceHeader')}
                                            </th>
                                        </>
                                    )}

                                    <th className="p-2 text-right font-bold text-xs uppercase">
                                        {t('preview.totalHeader')}
                                    </th>
                                </tr>
                            </thead>

                            <tbody>
                                {quote.items?.map((item, index) => (
                                    <tr key={index} className="border-b border-gray-200">
                                        <td className="p-2 pr-2">
                                            {/* âœ… CORRECCIÃ“ 2: El 'p' amb la quantitat extra s'ha eliminat. */}
                                            {item.description}
                                        </td>
                                        
                                        {/* Mostrem/amaguem les celÂ·les corresponents */}
                                        {(quote.show_quantity ?? true) && (
                                            <>
                                                <td className="text-center p-2">{item.quantity}</td>
                                                <td className="text-right p-2">{item.unit_price?.toFixed(2)} â‚¬</td>
                                            </>
                                        )}

                                        <td className="text-right p-2 font-medium">
                                            {((item.quantity || 0) * (item.unit_price || 0)).toFixed(2)} â‚¬
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </section>

                    {/* ---------------- TOTALS ---------------- */}
                    <section className="flex justify-end mt-6">
                        <div className="w-full max-w-xs space-y-2">

                            {/* Subtotal */}
                            <div className="flex justify-between">
                                <p className="text-gray-600">{t('totals.subtotal')}:</p>
                                <p>{subtotal.toFixed(2)} â‚¬</p>
                            </div>

                            {/* Descompte */}
                            {quote.discount && quote.discount > 0 && (
                                <div className="flex justify-between text-green-600">
                                    <p>{t('preview.discountLine')} ({quote.discount}%)</p>
                                    <p>-{discountAmount.toFixed(2)} â‚¬</p>
                                </div>
                            )}

                            {/* Base imposable */}
                            <div className="flex justify-between">
                                <p className="text-gray-600">{t('totals.taxableBase')}:</p>
                                <p>{base.toFixed(2)} â‚¬</p>
                            </div>

                            {/* IVA */}
                            <div className="flex justify-between">
                                <p className="text-gray-600">
                                    {t('preview.taxesLine')} ({quote.tax_percent ?? 21}%)
                                </p>
                                <p>{tax.toFixed(2)} â‚¬</p>
                            </div>

                            {/* TOTAL FINAL */}
                            <div className="flex justify-between font-bold text-xl mt-2 pt-2 border-t-2 border-gray-800">
                                <p>{t('preview.totalHeader')}:</p>
                                <p>{total.toFixed(2)} â‚¬</p>
                            </div>
                        </div>
                    </section>

                    {/* ---------------- NOTES I CONDICIONS ---------------- */}
                    <footer className="mt-10 pt-6 border-t border-gray-200">
                        <h3 className="font-bold mb-2">{t('preview.notesAndTerms')}</h3>
                        {/* âœ… CANVI: Hem canviat 'text-xs' per 'text-sm' i 'text-gray-500' per 'text-gray-600' */}
                        <p className="text-sm text-gray-600 whitespace-pre-wrap">
                            {quote.notes}
                        </p>
                    </footer>

                </div>
            </div>
        </aside>
    );
};


// =================== FILE: src/app/[locale]/(app)/finances/quotes/[id]/_components/QuoteTotals.tsx ===================

"use client";

import React from 'react';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { useTranslations } from 'next-intl';

interface QuoteTotalsProps {
    subtotal: number;
    discount: number | null;
    setDiscount: (discount: number) => void;
    discountAmount: number;
    tax: number;
    total: number;
    tax_percent: number | null;
    setTaxPercent: (value: number) => void;
}

export const QuoteTotals: React.FC<QuoteTotalsProps> = ({ 
    subtotal, 
    discount, 
    setDiscount, 
    discountAmount, 
    tax, 
    total,
    tax_percent,
    setTaxPercent
}) => {
    const t = useTranslations('QuoteEditor.totals');
    
    return (
        <div className="mt-6 ml-auto w-full max-w-sm space-y-2 px-4 py-2">
            <div className="flex justify-between">
                <span className="text-muted-foreground">{t('subtotal')}</span>
                <span className="font-medium">â‚¬{subtotal.toFixed(2)}</span>
            </div>
            
            <div className="flex justify-between items-center">
                <Label htmlFor="discount" className="text-muted-foreground">{t('discount')}</Label>
                <div className="flex items-center gap-1">
                    <Input 
                        id="discount"
                        type="number" 
                        value={discount ?? 0} 
                        onChange={(e) => setDiscount(parseFloat(e.target.value) || 0)} 
                        className="w-16 h-8 text-right bg-transparent" 
                        placeholder="0" 
                    />
                    <span className="text-muted-foreground">%</span>
                </div>
            </div>

            {discountAmount > 0 && (
                <div className="flex justify-between text-muted-foreground">
                    <span>{t('discountAmount')}</span>
                    <span>-â‚¬{discountAmount.toFixed(2)}</span>
                </div>
            )}

            <div className="flex justify-between">
                <span className="text-muted-foreground">{t('taxableBase')}</span>
                <span>â‚¬{(subtotal - discountAmount).toFixed(2)}</span>
            </div>
            
            {/* âœ… AQUESTA Ã‰S LA LÃ’GICA COMPLETADA PER A L'IVA */}
            <div className="flex justify-between items-center">
                <Label htmlFor="tax_percent" className="text-muted-foreground">{t('taxes')}</Label>
                <div className="flex items-center gap-1">
                    <Input
                        id="tax_percent"
                        type="number"
                        value={tax_percent ?? 21}
                        onChange={(e) => setTaxPercent(parseFloat(e.target.value) || 0)}
                        className="w-16 h-8 text-right bg-transparent"
                    />
                    <span className="text-muted-foreground">%</span>
                </div>
                <span className="font-medium">â‚¬{tax.toFixed(2)}</span>
            </div>

            <div className="flex justify-between text-lg font-bold border-t border-border pt-2">
                <span>{t('total')}</span>
                <span>â‚¬{total.toFixed(2)}</span>
            </div>
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/finances/quotes/[id]/_hooks/useQuoteEditor.ts ===================

// /app/crm/quotes/[id]/_hooks/useQuoteEditor.ts (COMPLET I CORREGIT)
"use client";

import {
    useCallback,
    useEffect,
    useMemo,
    useReducer,
    useTransition,
} from "react";
import { useRouter } from "next/navigation";
import { toast } from "sonner";
import { createClient } from "@/lib/supabase/client";
import {
    deleteQuoteAction,
    saveQuoteAction,
    sendQuoteAction,
} from "../actions";
import { type Database } from "@/types/supabase";
// âœ… 1. CORRECCIÃ“: Importem 'useTranslations' com a valor.
import { useTranslations } from "next-intl";

// Definicions de tipus basades en la BD
type Quote = Database["public"]["Tables"]["quotes"]["Row"];
type Opportunity = Database["public"]["Tables"]["opportunities"]["Row"];
type QuoteItem = Database["public"]["Tables"]["quote_items"]["Row"];
type Team = Database["public"]["Tables"]["teams"]["Row"];

// Aquest tipus representa un pressupost que pot ser nou ('id: "new"') o existent ('id: number')
export type EditableQuote = Omit<Quote, "id"> & {
    id: "new" | number;
    items: Partial<QuoteItem>[];
};

// Props que espera el hook
interface UseQuoteEditorProps {
    initialQuote: EditableQuote;
    initialOpportunities: Opportunity[];
    companyProfile: Team | null;
    userId: string;
}

// ... (Estat i accions per al Reducer es mantenen igual)
type EditorState = {
    quote: EditableQuote;
    currentTeamData: Team | null;
    contactOpportunities: Opportunity[];
    isDeleteDialogOpen: boolean;
    isProfileDialogOpen: boolean;
    sendingStatus: "idle" | "generating" | "uploading" | "sending";
};

type EditorAction =
    | { type: "SET_QUOTE"; payload: EditableQuote }
    | {
        type: "UPDATE_QUOTE_FIELD";
        payload: {
            field: keyof EditableQuote;
            value: EditableQuote[keyof EditableQuote];
        };
    }
    | { type: "SET_TEAM_DATA"; payload: Team | null }
    | { type: "SET_OPPORTUNITIES"; payload: Opportunity[] }
    | { type: "SET_DELETE_DIALOG"; payload: boolean }
    | { type: "SET_PROFILE_DIALOG"; payload: boolean }
    | { type: "SET_SENDING_STATUS"; payload: EditorState["sendingStatus"] };

function editorReducer(state: EditorState, action: EditorAction): EditorState {
    switch (action.type) {
        case "SET_QUOTE":
            return { ...state, quote: action.payload };
        case "UPDATE_QUOTE_FIELD":
            return {
                ...state,
                quote: {
                    ...state.quote,
                    [action.payload.field]: action.payload.value,
                },
            };
        case "SET_TEAM_DATA":
            return { ...state, currentTeamData: action.payload };
        case "SET_OPPORTUNITIES":
            return { ...state, contactOpportunities: action.payload };
        case "SET_DELETE_DIALOG":
            return { ...state, isDeleteDialogOpen: action.payload };
        case "SET_PROFILE_DIALOG":
            return { ...state, isProfileDialogOpen: action.payload };
        case "SET_SENDING_STATUS":
            return { ...state, sendingStatus: action.payload };
        default:
            throw new Error("Unhandled action type");
    }
}

export function useQuoteEditor({
    initialQuote,
    initialOpportunities,
    companyProfile,
}: UseQuoteEditorProps) {
    const router = useRouter();
    const supabase = createClient();
    const t = useTranslations("QuoteEditor");

    const initialState: EditorState = {
        // âœ… MILLORA 1: Corregim l'estat inicial.
        // Si Ã©s un pressupost nou, forcem 'items' a ser un array buit,
        // evitant el "concepte per defecte" que es pugui haver injectat
        // a la 'page.tsx' (que Ã©s on s'hauria d'evitar, perÃ² ho blindem aquÃ­).
        quote: {
            ...initialQuote,
            items: initialQuote.id === "new" ? [] : initialQuote.items,
        },
        currentTeamData: companyProfile,
        contactOpportunities: initialOpportunities,
        isDeleteDialogOpen: false,
        isProfileDialogOpen: false,
        sendingStatus: "idle",
    };

    const [state, dispatch] = useReducer(editorReducer, initialState);
    const [isSaving, startSaveTransition] = useTransition();
    const [isSending, startSendTransition] = useTransition();

    const { subtotal, discountAmount, tax, total } = useMemo(() => {
        const { items, discount, tax_percent } = state.quote;
        const sub = items.reduce(
            (acc, item) => acc + (item.quantity || 0) * (item.unit_price || 0),
            0,
        );
        const calculatedDiscountAmount = sub * ((discount || 0) / 100);
        const subAfterDiscount = sub - calculatedDiscountAmount;
        const taxAmount = subAfterDiscount * ((tax_percent ?? 21) / 100);
        return {
            subtotal: sub,
            discountAmount: calculatedDiscountAmount,
            tax: taxAmount,
            total: subAfterDiscount + taxAmount,
        };
    }, [state.quote]);

    const onQuoteChange = useCallback(
        <K extends keyof EditableQuote>(field: K, value: EditableQuote[K]) => {
            dispatch({ type: "UPDATE_QUOTE_FIELD", payload: { field, value } });
        },
        [],
    );

    const onItemsChange = useCallback((items: Partial<QuoteItem>[]) => {
        dispatch({
            type: "UPDATE_QUOTE_FIELD",
            payload: { field: "items", value: items },
        });
    }, []);

    const handleSave = useCallback(() => {
        // âœ… MILLORA 2: ValidaciÃ³ robusta al client abans d'enviar.
        // (Nota: Afegeix aquestes claus al teu arxiu de traduccions 'ca.json')
        if (!state.quote.contact_id) {
            toast.error(t("toast.errorTitle"), {
                description: t("toast.validation.missingContact"), // "Cal seleccionar un client."
            });
            return;
        }
        if (state.quote.items.length === 0) {
            toast.error(t("toast.errorTitle"), {
                description: t("toast.validation.minOneItem"), // "El pressupost ha de tenir almenys un concepte."
            });
            return;
        }
        const hasInvalidItem = state.quote.items.some(
            (item) =>
                !item.description?.trim() || // DescripciÃ³ no pot ser buida
                (item.quantity ?? 1) <= 0, // Quantitat ha de ser positiva
        );
        if (hasInvalidItem) {
            toast.error(t("toast.errorTitle"), {
                description: t("toast.validation.invalidItem"), // "Un o mÃ©s conceptes tenen dades invÃ lides (descripciÃ³ buida o quantitat 0)."
            });
            return;
        }

        startSaveTransition(async () => {
            const result = await saveQuoteAction({
                ...state.quote,
                subtotal,
                tax,
                total,
            });
            if (result.success && typeof result.data === "number") {
                toast.success(result.message);
                if (state.quote.id === "new") {
                    router.replace(`/finances/quotes/${result.data}`);
                }
            } else {
                toast.error(t("toast.errorTitle"), {
                    description: result.message, // Aquest missatge ara serÃ  especÃ­fic
                });
            }
        });
    }, [state.quote, subtotal, tax, total, router, t]);
    const handleDelete = useCallback(() => {
        // âœ… 3. GUARD: Aquesta comprovaciÃ³ assegura que nomÃ©s passem un 'number' a l'acciÃ³.
        if (typeof state.quote.id !== "number") return;
        startSaveTransition(async () => {
            if (typeof state.quote.id !== "number") return;
            const result = await deleteQuoteAction(state.quote.id);
            if (result.success) {
                toast.success(result.message);
                router.push("/finances/quotes");
            } else {
                toast.error(t("toast.errorTitle"), {
                    description: result.message,
                });
            }
        });
    }, [state.quote.id, router, t]);

    const handleSend = useCallback(() => {
        if (typeof state.quote.id !== "number" || !state.quote.team_id) { // âœ… Assegura't de tenir team_id
            toast.error(t("toast.errorTitle"), {
                description: t("toast.saveFirst"),
            }); // Missatge mÃ©s clar
            return;
        }

        startSendTransition(async () => {
            const element = document.getElementById("quote-preview-for-pdf");
            if (!element) return;

            try {
                dispatch({ type: "SET_SENDING_STATUS", payload: "generating" });
                toast.info(t("quoteEditor.generatingPDF"));

                const { default: html2pdf } = await import("html2pdf.js");
                const PDF_OPTIONS = {
                    margin: 10,
                    filename: `pressupost-${
                        state.quote.quote_number || "esborrany"
                    }.pdf`,
                    image: { type: "jpeg", quality: 0.98 } as const,
                    html2canvas: { scale: 3, useCORS: true },
                    jsPDF: {
                        unit: "mm",
                        format: "a4",
                        orientation: "portrait" as const,
                    },
                    pagebreak: {
                        mode: "css" as const,
                        before: ".page-break-before",
                    },
                };
                const pdfBlob = await html2pdf().from(element).set(PDF_OPTIONS)
                    .output("blob");

                dispatch({ type: "SET_SENDING_STATUS", payload: "uploading" });

                // âœ… --- CORRECCIÃ“ CLAU ---
                // ConstruÃ¯m el path correcte per al bucket privat
                const correctFilePath =
                    `quotes/${state.quote.team_id}/${state.quote.id}.pdf`;

                const { error: uploadError } = await supabase.storage
                    .from("fitxers-privats") // Pujem al bucket PRIVAT
                    .upload(correctFilePath, pdfBlob, { upsert: true }); // Usem el path CORRECTE
                // âœ… --- FI CORRECCIÃ“ ---

                if (uploadError) {
                    console.error("Error pujant PDF:", uploadError);
                    throw new Error(
                        `Error en pujar el PDF: ${uploadError.message}`,
                    ); // LlenÃ§a un error mÃ©s descriptiu
                }

                dispatch({ type: "SET_SENDING_STATUS", payload: "sending" });
                const result = await sendQuoteAction(state.quote.id as number); // Crida a l'Edge Function
                if (!result.success) throw new Error(result.message);

                // ... (actualitzaciÃ³ d'estat i toasts d'Ã¨xit)
                dispatch({
                    type: "UPDATE_QUOTE_FIELD",
                    payload: { field: "status", value: "Sent" },
                });
                dispatch({
                    type: "UPDATE_QUOTE_FIELD",
                    payload: {
                        field: "sent_at",
                        value: new Date().toISOString(),
                    },
                });
                toast.success("Ãˆxit!", { description: result.message });
            } catch (error) {
                // ... (gestiÃ³ d'errors)
                const e = error instanceof Error
                    ? error
                    : new Error(t("toast.sendError"));
                toast.error(t("toast.errorTitle"), { description: e.message });
            } finally {
                dispatch({ type: "SET_SENDING_STATUS", payload: "idle" });
            }
        });
    }, [state.quote, supabase, t]); //

    useEffect(() => {
        // âœ… RE-APLICACIÃ“ DE LA MILLORA 1:
        // Assegurem que si el 'initialQuote' canvia (p.ex. navegaciÃ³ client),
        // tambÃ© es netegi si Ã©s 'new'.
        const quoteToSet = initialQuote.id === "new"
            ? { ...initialQuote, items: [] }
            : initialQuote;
        dispatch({ type: "SET_QUOTE", payload: quoteToSet });
    }, [initialQuote]);

    useEffect(() => {
        const fetchOpportunities = async () => {
            if (!state.quote.contact_id) {
                dispatch({ type: "SET_OPPORTUNITIES", payload: [] });
                return;
            }
            const { data } = await supabase.from("opportunities").select("*")
                .eq("contact_id", state.quote.contact_id);
            dispatch({ type: "SET_OPPORTUNITIES", payload: data || [] });
        };
        fetchOpportunities();
    }, [state.quote.contact_id, supabase]);

    return {
        state,
        quote: state.quote,
        dispatch,
        onQuoteChange,
        onItemsChange,
        setQuote: (newQuote: EditableQuote) =>
            dispatch({ type: "SET_QUOTE", payload: newQuote }),
        setIsDeleteDialogOpen: (isOpen: boolean) =>
            dispatch({ type: "SET_DELETE_DIALOG", payload: isOpen }),
        setIsProfileDialogOpen: (isOpen: boolean) =>
            dispatch({ type: "SET_PROFILE_DIALOG", payload: isOpen }),
        setCurrentTeamData: (data: Team | null) =>
            dispatch({ type: "SET_TEAM_DATA", payload: data }),
        subtotal,
        discountAmount,
        tax,
        total,
        handleSave,
        handleDelete,
        handleSend,
        isSaving,
        isSending,
        t,
    };
}


// =================== FILE: src/app/[locale]/(app)/finances/quotes/[id]/_hooks/useQuoteItems.ts ===================

// /app/[locale]/(app)/crm/quotes/[id]/_hooks/useQuoteItems.ts (REFACTORITZAT)
"use client";

import { useCallback } from "react";
import { type Database } from '@/types/supabase';

// Definim els tipus a partir de la BD.
type QuoteItem = Database['public']['Tables']['quote_items']['Row'];
type Product = Database['public']['Tables']['products']['Row'];

interface UseQuoteItemsProps {
Â  Â  items: Partial<QuoteItem>[];
Â  Â  onItemsChange: (newItems: Partial<QuoteItem>[]) => void;
Â  Â  userId: string;
Â  Â  // â›” 't' ja no Ã©s necessari aquÃ­, es passa directament al ProductSelector
};

export function useQuoteItems({ items, onItemsChange, userId }: UseQuoteItemsProps) {
Â  Â  // â›” Tota la lÃ²gica de 'isSavingProduct', 'isCreating', 'newProduct', 'isPopoverOpen'
Â  Â  // i 'handleSaveNewProduct' s'ha mogut al component reutilitzable 'ProductSelector'.

Â  Â  const handleItemChange = useCallback(<K extends keyof QuoteItem>(index: number, field: K, value: QuoteItem[K]) => {
Â  Â  Â  Â  const newItems = [...items];
Â  Â  Â  Â  newItems[index] = { ...newItems[index], [field]: value };
Â  Â  Â  Â  onItemsChange(newItems);
Â  Â  }, [items, onItemsChange]);

    /**
     * Afegeix un producte de la llibreria a la llista d'Ã­tems.
     * Aquesta funciÃ³ es passa com a callback 'onProductSelect' a ProductSelector.
     */
Â  Â  const handleAddProduct = useCallback((product: Product) => {
Â  Â  Â  Â  const newItem: Partial<QuoteItem> = {
Â  Â  Â  Â  Â  Â  description: product.name || product.description || '',
Â  Â  Â  Â  Â  Â  quantity: 1,
Â  Â  Â  Â  Â  Â  unit_price: product.price || 0,
Â  Â  Â  Â  Â  Â  product_id: product.id,
Â  Â  Â  Â  Â  Â  user_id: userId,
Â  Â  Â  Â  Â  Â  total: product.price || 0 
Â  Â  Â  Â  };
Â  Â  Â  Â  onItemsChange([...items, newItem]);
Â  Â  }, [items, onItemsChange, userId]);

Â  Â  const handleRemoveItem = useCallback((index: number) => {
Â  Â  Â  Â  onItemsChange(items.filter((_, i) => i !== index));
Â  Â  }, [items, onItemsChange]);
Â  Â  
    /**
     * Afegeix un Ã­tem manual buit a la llista.
     * Aquesta funciÃ³ es passa com a callback 'onManualAdd' a ProductSelector.
     */
Â  Â  const handleManualItem = useCallback(() => {
Â  Â  Â  Â  const newItem: Partial<QuoteItem> = {
Â  Â  Â  Â  Â  Â  product_id: null,
Â  Â  Â  Â  Â  Â  description: '',
Â  Â  Â  Â  Â  Â  quantity: 1,
Â  Â  Â  Â  Â  Â  unit_price: 0,
Â  Â  Â  Â  Â  Â  user_id: userId,
Â  Â  Â  Â  Â  Â  total: 0
Â  Â  Â  Â  };
Â  Â  Â  Â  onItemsChange([...items, newItem]);
Â  Â  }, [items, onItemsChange, userId]);

Â  Â  return {
        // Estats i handlers moguts:
Â  Â  Â  Â  // isSavingProduct, isCreating, setIsCreating, newProduct, setNewProduct,
Â  Â  Â  Â  // isPopoverOpen, setIsPopoverOpen, handleSaveNewProduct

        // Handlers que es mantenen:
Â  Â  Â  Â  handleItemChange, 
        handleAddProduct,
Â  Â  Â  Â  handleRemoveItem, 
        handleManualItem,
Â  Â  };
}

// =================== FILE: src/app/[locale]/(app)/finances/quotes/_components/QuotesClient.tsx ===================

// /app/[locale]/(app)/finances/quotes/_components/QuotesClient.tsx (FITXER CORREGIT)
"use client";

import { useMemo } from 'react';
import Link from 'next/link';
import { useLocale, useTranslations } from 'next-intl';
import { Plus, Edit } from 'lucide-react';
import { PageHeader } from '@/components/shared/PageHeader';

// âœ… CORRECCIÃ“: Importem les ACCIONS des d'../actions
import { fetchPaginatedQuotes, deleteQuoteAction } from '../actions';
// âœ… CORRECCIÃ“: Importem els TIPUS des del fitxer de tipus
import { type QuoteWithContact, type QuotePageFilters } from '@/types/finances/quotes';

import { type ActionResult } from '@/types/shared/actionResult';
import { usePathname } from 'next/navigation';
// ... (la resta d'imports de components UI) ...
import { Button } from '@/components/ui/button';
import { GenericDataTable, type ColumnDef } from '@/components/shared/GenericDataTable';
import { ColumnToggleButton } from '@/components/shared/ColumnToggleButton';
import { Badge } from '@/components/ui/badge';
import { QuotesFilters } from './QuotesFilters';
import { usePaginatedResource, type PaginatedResponse, type PaginatedActionParams } from '@/hooks/usePaginateResource';
import { formatDate, formatCurrency } from '@/lib/utils/formatters';
import { cn } from '@/lib/utils/utils';
import { QUOTE_STATUS_MAP } from '@/config/styles/quotes';

// ... (la resta del component es mantÃ© igual) ...
// ... (Alias i Constants) ...
type PaginatedQuotesResponse = PaginatedResponse<QuoteWithContact>;
type FetchQuotesParams = PaginatedActionParams<QuotePageFilters>;
const QUOTE_ROWS_PER_PAGE_OPTIONS = [10, 25, 50];

interface QuotesClientProps {
  initialData: PaginatedQuotesResponse;
}

export function QuotesClient({ initialData }: QuotesClientProps) {
  const t = useTranslations('QuotesPage');
  const tShared = useTranslations('Shared');
  const locale = useLocale();
  const pathname = usePathname(); 

  const allColumns = useMemo<ColumnDef<QuoteWithContact>[]>(() => [
    {
      accessorKey: 'quote_number',
      header: t('table.number'),
      enableSorting: true,
      cell: (quote) => (
        <Link
          href={`/${locale}/finances/quotes/${quote.id}`}
          className="text-green-600 hover:underline font-medium"
        >
          {quote.quote_number || `PRE-${String(quote.id).substring(0, 6)}`}
        </Link>
      ),
    },
    {
      accessorKey: 'contacts.nom',
      id: 'client_name',
      header: t('table.client'),
      enableSorting: true,
      cell: (quote) => {
        const contact = quote.contacts;
        if (contact && contact.id) {
          return (
            <Link
              href={`/${locale}/crm/contactes/${contact.id}?from=${pathname}`}
              className="text-primary hover:underline font-medium"
            >
              {contact.nom}
            </Link>
          );
        }
        return t('noClient', { defaultValue: 'Sense Client' });
      },
    },
    {
      accessorKey: 'issue_date',
      header: t('table.issueDate'),
      enableSorting: true,
      cell: (quote) => formatDate(quote.issue_date),
    },
    {
      accessorKey: 'total',
      header: t('table.total'),
      enableSorting: true,
      cell: (quote) => formatCurrency(quote.total ?? 0),
    },
    {
      accessorKey: 'status',
      header: t('table.status'),
      enableSorting: true,
      cell: (quote) => {
        const statusInfo = QUOTE_STATUS_MAP.find(s => s.dbValue === quote.status) || { key: 'unknown', colorClass: 'bg-gray-100 dark:bg-gray-800', textColorClass: 'text-gray-800 dark:text-gray-300' };
        return (
          <Badge
            variant="outline"
            className={cn("text-xs", statusInfo.colorClass)}
          >
            {t(`status.${statusInfo.key}`)}
          </Badge>
        );
      },
    },
    {
      accessorKey: "actions_edit",
      header: "",
      enableSorting: false,
      cellClassName: "text-right",
      cell: (quote) => (
        <Link href={`/${locale}/crm/quotes/${quote.id}`} title={tShared('actions.edit')}>
          <Button variant="ghost" size="icon"><Edit className="w-4 h-4" /></Button>
        </Link>
      ),
    }
  ], [t, tShared, locale, pathname]);
  
  const {
    isPending,
    data: quotes,
    itemToDelete: quoteToDelete,
    setItemToDelete: setQuoteToDelete,
    handleDelete,
    handleSort,
    currentSortColumn,
    currentSortOrder,
    searchTerm,
    handleSearchChange,
    filters,
    handleFilterChange,
    columnVisibility,
    toggleColumnVisibility,
    page,
    totalPages,
    handlePageChange,
    rowsPerPage,
    handleRowsPerPageChange,
  } = usePaginatedResource<QuoteWithContact, QuotePageFilters>({
    initialData,
    initialFilters: { status: 'all' },
    initialSort: { column: 'issue_date', order: 'desc' },
    allColumns,
    fetchAction: fetchPaginatedQuotes as (params: FetchQuotesParams) => Promise<PaginatedQuotesResponse>,
    deleteAction: async (id: string | number): Promise<ActionResult> => {
      if (typeof id !== 'number') {
        const msg = tShared('errors.invalidId') + " (expected number)";
        console.error(msg, { id });
        return { success: false, message: msg };
      }
      return deleteQuoteAction(id);
    },
    initialRowsPerPage: QUOTE_ROWS_PER_PAGE_OPTIONS[0],
    rowsPerPageOptions: QUOTE_ROWS_PER_PAGE_OPTIONS,
    toastMessages: {
      deleteSuccess: t('toast.deleteSuccess'),
    }
  });

  const visibleColumns = useMemo(
    () => allColumns.filter(col => {
      const key = ('id' in col && col.id)
        ? col.id.toString()
        : col.accessorKey?.toString();
      return key ? (columnVisibility[key] ?? true) : true;
    }),
    [allColumns, columnVisibility]
  );

  const deleteDescription = (
    <>
      {tShared('deleteDialog.description1')}{' '}
      <span className="font-bold">{quoteToDelete?.quote_number || `PRE-${quoteToDelete?.id}`}</span>.
      <br />
      {tShared('deleteDialog.description2')}
    </>
  );

  return (
    <div className="flex flex-col gap-4 h-full">
      <PageHeader title={t('title')}>
        <Button asChild>
          <Link href={`/${locale}/finances/quotes/new`}>
            <Plus className="w-4 h-4 mr-1" /> {t('newQuoteButton')}
          </Link>
        </Button>
      </PageHeader>

      <div className="flex justify-between items-center">
        <QuotesFilters
          searchTerm={searchTerm}
          onSearchChange={handleSearchChange}
          filters={filters}
          onFilterChange={handleFilterChange}
        />
        <ColumnToggleButton
          allColumns={allColumns}
          columnVisibility={columnVisibility}
          toggleColumnVisibility={toggleColumnVisibility}
        />
      </div>

      <GenericDataTable<QuoteWithContact>
        className="flex-grow overflow-hidden"
        columns={visibleColumns}
        data={quotes}
        isPending={isPending}
        onSort={handleSort}
        currentSortColumn={currentSortColumn}
        currentSortOrder={currentSortOrder as 'asc' | 'desc' | null}
        page={page}
        totalPages={totalPages}
        onPageChange={handlePageChange}
        rowsPerPage={rowsPerPage}
        onRowsPerPageChange={handleRowsPerPageChange}
        rowsPerPageOptions={QUOTE_ROWS_PER_PAGE_OPTIONS}
        deleteItem={quoteToDelete}
        setDeleteItem={setQuoteToDelete}
        onDelete={handleDelete}
        deleteTitleKey="QuotesPage.deleteDialog.title"
        deleteDescription={deleteDescription}
        emptyStateMessage={t('emptyState')}
      />
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/quotes/_components/QuotesData.tsx ===================

// /app/[locale]/(app)/finances/quotes/_components/QuotesData.tsx (FITXER CORREGIT)
import { redirect } from 'next/navigation';
import { QuotesClient } from './QuotesClient';

// âœ… CORRECCIÃ“: Importem l'acciÃ³ des d'../actions
import { fetchPaginatedQuotes } from '../actions';
// âœ… CORRECCIÃ“: Importem el tipus des del fitxer de tipus
import type { QuotePageFilters } from '@/types/finances/quotes';

import { createClient as createServerActionClient } from '@/lib/supabase/server';
import { getTranslations } from 'next-intl/server';

// Constants inicials
const INITIAL_ROWS_PER_PAGE = 10;
const INITIAL_SORT_COLUMN = 'issue_date';
const INITIAL_SORT_ORDER = 'desc';

export async function QuotesData() {
    const supabase = createServerActionClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
        redirect('/login');
    }
    const t = await getTranslations('QuotesPage');

    try {
        const initialData = await fetchPaginatedQuotes({
            searchTerm: '',
            filters: { status: 'all' } as QuotePageFilters, 
            sortBy: INITIAL_SORT_COLUMN,
            sortOrder: INITIAL_SORT_ORDER,
            limit: INITIAL_ROWS_PER_PAGE,
            offset: 0,
        });

        return (
            <QuotesClient
                initialData={initialData}
            />
        );

    } catch (error) {
        console.error("Error during QuotesData loading:", error);
        throw new Error(t('errors.loadDataFailed') || "No s'han pogut carregar les dades.");
    }
}

// =================== FILE: src/app/[locale]/(app)/finances/quotes/_components/QuotesFilters.tsx ===================

// /app/[locale]/(app)/crm/quotes/_components/QuotesFilters.tsx
'use client';

import { Input } from "@/components/ui/input";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { useTranslations } from "next-intl";
// âœ… Importem QuoteStatus aquÃ­, ja que sÃ­ s'usa per al tipus de filtre
import { type QuoteWithContact, type QuotePageFilters } from '@/types/finances/quotes';
// âœ… CORRECCIÃ“: Valors amb majÃºscula inicial per coincidir amb l'enum
const statusOptions: { value: QuoteWithContact['status'] | 'all', labelKey: string }[] = [
   { value: 'all', labelKey: 'allStatuses' },
   { value: 'Draft', labelKey: 'status.Draft' }, // <-- MajÃºscula
   { value: 'Sent', labelKey: 'status.Sent' },   // <-- MajÃºscula
   { value: 'Accepted', labelKey: 'status.Accepted' }, // <-- MajÃºscula
   { value: 'Declined', labelKey: 'status.Declined' }, // <-- MajÃºscula
   { value: 'Invoiced', labelKey: 'status.Invoiced' }, // <-- MajÃºscula
];

// âœ… CORRECCIÃ“ TS: Ajustem el tipus de 'onFilterChange'
interface QuotesFiltersProps {
  searchTerm: string;
  onSearchChange: (value: string) => void;
  filters: QuotePageFilters;
  // Ara espera el tipus exacte que provÃ© del hook usePaginatedResource
  onFilterChange: <K extends keyof QuotePageFilters>(key: K, value: QuotePageFilters[K]) => void;
  // clients?: { id: number; nom: string | null }[];
}

export function QuotesFilters({
  searchTerm,
  onSearchChange,
  filters,
  onFilterChange,
  // clients = [],
}: QuotesFiltersProps) {
  const t = useTranslations('QuotesPage.filters');
  const tStatus = useTranslations('QuotesPage'); // Ajusta si cal

  return (
    <div className="flex items-center gap-2">
      <Input
        placeholder={t('searchPlaceholder') || "Busca nÂº o client..."}
        value={searchTerm}
        onChange={(e) => onSearchChange(e.target.value)}
        className="max-w-xs h-9 bg-card border border-input"
      />

      <Select
        value={filters.status}
        // Passem el valor directament. L'assertion 'as' assegura la compatibilitat
        onValueChange={(value) => onFilterChange('status', value as QuoteWithContact['status'] | 'all')} // <-- Assertion de tipus aquÃ­
      >
        <SelectTrigger className="w-[160px] h-9 bg-card border border-input">
          <SelectValue placeholder={t('statusPlaceholder')} />
        </SelectTrigger>
        <SelectContent>
          {statusOptions.map((option) => (
            <SelectItem key={option.value} value={option.value}>
              {/* Ajusta el namespace si les traduccions d'estat estan a Shared */}
              {tStatus(`status.${option.value}`, {})}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>

      {/* AquÃ­ aniria el filtre per client si l'implementes */}
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/suppliers/actions.ts ===================

// /app/[locale]/(app)/finances/suppliers/actions.ts (FITXER CORREGIT)
"use server";

import { revalidatePath } from "next/cache";
import { validateUserSession } from "@/lib/supabase/session";
import { type ActionResult } from "@/types/shared/actionResult";
import { type PaginatedActionParams } from '@/hooks/usePaginateResource';

// âœ… 1. Importem el NOU servei
import * as supplierService from '@/lib/services/finances/suppliers/suppliers.service';

// âœ… 2. Importem els tipus NOMÃ‰S PER A ÃšS INTERN
import type { 
  Supplier, 
  SupplierFormData,
  SupplierPageFilters,
  PaginatedSuppliersData // âœ… Importem el tipus actualitzat
} from '@/lib/services/finances/suppliers/suppliers.service';

// âŒ TOTS ELS 'export type' S'HAN ELIMINAT

// --- AcciÃ³ per Obtenir Dades Paginades ---
export async function fetchPaginatedSuppliers(
    params: PaginatedActionParams<SupplierPageFilters>
): Promise<PaginatedSuppliersData> {
    const session = await validateUserSession();
    if ("error" in session) {
        console.error("Session error fetching suppliers:", session.error);
        return { data: [], count: 0 };
    }
    const { supabase, activeTeamId } = session;

    try {
        // El servei ja retorna el tipus correcte (amb o sense error de BD)
        return await supplierService.getPaginatedSuppliers(supabase, activeTeamId, params);
    } catch (error: unknown) {
        // Captura d'errors de xarxa o altres errors inesperats
        const message = (error as Error).message;
        console.error("Unhandled error in fetchPaginatedSuppliers action:", message);
        return { data: [], count: 0 };
    }
}

/**
 * ACCIÃ“: Esborra un proveÃ¯dor.
 */
export async function deleteSupplierAction(supplierId: string): Promise<ActionResult> {
    const session = await validateUserSession();
    if ("error" in session) return { success: false, message: session.error.message };
    const { supabase, activeTeamId } = session;

    const result = await supplierService.deleteSupplier(supabase, activeTeamId, supplierId);

    if (result.success) {
        revalidatePath('/finances/suppliers');
    }
    return result;
}

/**
 * ACCIÃ“: ObtÃ© el detall d'un Ãºnic proveÃ¯dor.
 */
export async function fetchSupplierDetail(id: string): Promise<Supplier> {
    const session = await validateUserSession();
    if ("error" in session) {
        console.error("Session error fetching supplier detail:", session.error);
        throw new Error(session.error.message);
    }
    const { supabase, activeTeamId } = session;

    return await supplierService.fetchSupplierDetail(supabase, activeTeamId, id);
}

/**
 * ACCIÃ“: Desa (crea o actualitza) un proveÃ¯dor.
 */
export async function saveSupplierAction(
    formData: SupplierFormData,
    supplierId: string | null
): Promise<ActionResult<Supplier>> {
    const session = await validateUserSession();
    if ("error" in session) return { success: false, message: session.error.message };
    const { supabase, user, activeTeamId } = session;

    const result = await supplierService.saveSupplier(
        supabase, 
        user.id, 
        activeTeamId, 
        formData, 
        supplierId
    );
    
    if (result.success) {
        revalidatePath('/finances/suppliers');
        if (supplierId && supplierId !== 'new') {
            revalidatePath(`/finances/suppliers/${supplierId}`);
        }
    }
    
    return result;
}

/**
 * ACCIÃ“: ObtÃ© la llista completa de proveÃ¯dors (per a selectors, etc.).
 */
export async function fetchSuppliers(): Promise<Pick<Supplier, 'id' | 'nom'>[]> {
    const session = await validateUserSession();
    if ("error" in session) return [];
    const { supabase, activeTeamId } = session;
    
    return await supplierService.fetchSuppliers(supabase, activeTeamId);
}

/**
 * ACCIÃ“: Cerca proveÃ¯dors per nom per al combobox asÃ­ncron.
 */
export async function searchSuppliers(searchTerm: string): Promise<Pick<Supplier, 'id' | 'nom'>[]> {
    const session = await validateUserSession();
    if ("error" in session) return [];
    const { supabase, activeTeamId } = session;

    return await supplierService.searchSuppliers(supabase, activeTeamId, searchTerm);
}

// =================== FILE: src/app/[locale]/(app)/finances/suppliers/page.tsx ===================

// src/app/[locale]/(app)/finances/suppliers/page.tsx
import { Suspense } from 'react';
import { SuppliersData } from './_components/SuppliersData';
import { GenericDataTableSkeleton } from '@/components/shared/GenericDataTableSkeleton'; // Skeleton genÃ¨ric

// Ja no necessitem rebre 'searchParams'
export default async function SuppliersListPage() {

  // Ajusta el nombre de columnes
  const defaultColumnCount = 5; // nom, email, telefon, created_at, actions

  return (
    // Ajustem padding/alÃ§ada si cal
    <div className="h-full">
      <Suspense fallback={<GenericDataTableSkeleton columnCount={defaultColumnCount} rowCount={10} showFiltersSkeleton={false} />}>
        {/* SuppliersData gestiona la cÃ rrega */}
        <SuppliersData />
      </Suspense>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/suppliers/[supplierId]/actions.ts ===================

// /app/[locale]/(app)/finances/suppliers/[supplierId]/actions.ts (FITXER NOU)
"use server";

import { revalidatePath } from "next/cache";
import { validateUserSession } from "@/lib/supabase/session";
import { type ActionResult } from "@/types/shared/actionResult";

// âœ… 1. Importem el servei consolidat
import * as supplierService from '@/lib/services/finances/suppliers/suppliers.service';

// âœ… 2. Importem tipus per a Ãºs intern
import type { 
  Supplier, 
  SupplierFormData
} from '@/lib/services/finances/suppliers/suppliers.service';

/**
 * ACCIÃ“: ObtÃ© el detall d'un Ãºnic proveÃ¯dor.
 */
export async function fetchSupplierDetail(id: string): Promise<Supplier> {
    const session = await validateUserSession();
    if ("error" in session) {
        console.error("Session error fetching supplier detail:", session.error);
        throw new Error(session.error.message); // LlanÃ§a error que 'ProductDetailData' capturarÃ 
    }
    const { supabase, activeTeamId } = session;

    // El servei ja gestiona el notFound()
    return await supplierService.fetchSupplierDetail(supabase, activeTeamId, id);
}

/**
 * ACCIÃ“: Desa (crea o actualitza) un proveÃ¯dor.
 */
export async function saveSupplierAction(
    formData: SupplierFormData,
    supplierId: string | null
): Promise<ActionResult<Supplier>> {
    const session = await validateUserSession();
    if ("error" in session) return { success: false, message: session.error.message };
    const { supabase, user, activeTeamId } = session;

    const result = await supplierService.saveSupplier(
        supabase, 
        user.id, 
        activeTeamId, 
        formData, 
        supplierId
    );
    
    // Gestionem la revalidaciÃ³
    if (result.success) {
        revalidatePath('/finances/suppliers');
        // Revalidem la pÃ gina de detall nomÃ©s si estÃ vem editant
        if (supplierId && supplierId !== 'new') {
            revalidatePath(`/finances/suppliers/${supplierId}`);
        }
    }
    
    return result;
}

// =================== FILE: src/app/[locale]/(app)/finances/suppliers/[supplierId]/page.tsx ===================

import { Suspense } from 'react';
import { Skeleton } from '@/components/ui/skeleton';
import { SupplierDetailData } from './_components/SupplierDetailData';

// âœ… Definim la interfÃ­cie localment amb 'params' com a Promise.
interface SupplierDetailPageProps {
  params: Promise<{
    locale: string;
    supplierId: string;
  }>;
}

/**
 * Component de pÃ gina per al detall d'un proveÃ¯dor.
 */
export default async function SupplierDetailPage(props: SupplierDetailPageProps) {
  
  // âœ… Resolem la promesa per obtenir l'ID del proveÃ¯dor.
  const { supplierId } = await props.params;

  return (
    <Suspense fallback={<SupplierDetailSkeleton />}>
      {/* âœ… Simplifiquem: Passem nomÃ©s l'string 'supplierId' com a prop. */}
      <SupplierDetailData key={supplierId} supplierId={supplierId} />
    </Suspense>
  );
}

// El Skeleton es queda igual, no cal tocar-lo.
function SupplierDetailSkeleton() {
  return (
    <div className="space-y-6 p-4 bg-card rounded-lg border">
      <div className="space-y-2"><Skeleton className="h-4 w-1/6" /><Skeleton className="h-10 w-1/2" /></div>
      <div className="space-y-2"><Skeleton className="h-4 w-1/6" /><Skeleton className="h-10 w-1/2" /></div>
      <div className="space-y-2"><Skeleton className="h-4 w-1/6" /><Skeleton className="h-10 w-1/3" /></div>
      <Skeleton className="h-10 w-24" />
    </div>
  )
}

// =================== FILE: src/app/[locale]/(app)/finances/suppliers/[supplierId]/schemas.ts ===================

import { z } from 'zod';

// Esquema de validaciÃ³ per al formulari de proveÃ¯dors
export const supplierFormSchema = z.object({
  nom: z.string().min(2, { message: "El nom ha de tenir almenys 2 carÃ cters." }),
  nif: z.string().optional().nullable(),
  email: z.string().email({ message: "Introdueix un email vÃ lid." }).optional().nullable(),
  telefon: z.string().optional().nullable(),
  // Pots afegir mÃ©s camps aquÃ­ (adreÃ§a, compte bancari, etc.)
  // address: z.string().optional().nullable(),
  // bank_iban: z.string().optional().nullable(),
});

// Tipus inferit de l'esquema
export type SupplierFormValues = z.infer<typeof supplierFormSchema>;

// =================== FILE: src/app/[locale]/(app)/finances/suppliers/[supplierId]/_components/LinkContactDialog.tsx ===================

"use client";

import { useState, useTransition } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter
} from '@/components/ui/dialog';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Loader2, UserPlus, Search } from 'lucide-react';
import { useDebouncedCallback } from 'use-debounce';
import { toast } from 'sonner';

import { 
  searchContactsForLinking, 
  linkContactToSupplier 
} from '@/app/[locale]/(app)/crm/contactes/actions';
import type { Contact } from "@/types/db"; 

type SearchResult = Pick<Contact, 'id' | 'nom' | 'email'>;

interface LinkContactDialogProps {
  supplierId: string;
  isOpen: boolean;
  onOpenChange: (open: boolean) => void;
  onLinkSuccess: (newlyLinkedContact: Contact) => void;
  t: (key: string) => string;
}

export function LinkContactDialog({
  supplierId,
  isOpen,
  onOpenChange,
  onLinkSuccess,
  t
}: LinkContactDialogProps) {
  const [searchTerm, setSearchTerm] = useState('');
  const [results, setResults] = useState<SearchResult[]>([]);
  const [isSearching, startSearchTransition] = useTransition();
  const [isLinking, startLinkTransition] = useTransition();

  const handleSearch = useDebouncedCallback((term: string) => {
    if (term.length < 2) {
      setResults([]);
      return;
    }
    startSearchTransition(async () => {
      const data = await searchContactsForLinking(term);
      setResults(data);
    });
  }, 300);

  const handleLinkClick = (contactId: string) => {
    startLinkTransition(async () => {
      const result = await linkContactToSupplier(contactId, supplierId);
      if (result.success && result.data) {
        toast.success(t('contactsCard.linkDialog.toastSuccess'));
        onLinkSuccess(result.data); 
        onOpenChange(false); 
        setSearchTerm('');
        setResults([]);
      } else {
        toast.error(result.message || t('contactsCard.linkDialog.toastError'));
      }
    });
  };
  
  // Reseteja l'estat en tancar el diÃ leg
  const handleOpenChange = (open: boolean) => {
    if (!open) {
      setSearchTerm('');
      setResults([]);
    }
    onOpenChange(open);
  };

  return (
    <Dialog open={isOpen} onOpenChange={handleOpenChange}>
      <DialogContent className="sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle>{t('contactsCard.linkDialog.title')}</DialogTitle>
          <DialogDescription>
            {t('contactsCard.linkDialog.description')}
          </DialogDescription>
        </DialogHeader>
        
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
          <Input
            placeholder={t('contactsCard.linkDialog.searchPlaceholder')}
            className="pl-9"
            value={searchTerm}
            onChange={(e) => {
              setSearchTerm(e.target.value);
              handleSearch(e.target.value);
            }}
          />
        </div>

        <div className="mt-4 space-y-2 max-h-[300px] overflow-y-auto">
          {isSearching && (
            <div className="flex justify-center items-center py-4">
              <Loader2 className="h-5 w-5 animate-spin" />
            </div>
          )}
          {!isSearching && results.length === 0 && searchTerm.length > 1 && (
            <p className="text-sm text-center text-muted-foreground">
              {t('contactsCard.linkDialog.noResults')}
            </p>
          )}
          {results.map((contact) => (
            <div
              key={contact.id}
              className="flex items-center justify-between p-2 border rounded-md"
            >
              <div>
                <p className="font-medium">{contact.nom}</p>
                <p className="text-sm text-muted-foreground">{contact.email}</p>
              </div>
              <Button
                size="sm"
                variant="outline"
                onClick={() => handleLinkClick(String(contact.id))}
                disabled={isLinking}
              >
                <UserPlus className="h-4 w-4 mr-2" />
                {t('contactsCard.linkDialog.linkButton')}
              </Button>
            </div>
          ))}
        </div>
        
        <DialogFooter>
          <Button variant="ghost" onClick={() => handleOpenChange(false)}>
            {t('contactsCard.linkDialog.cancelButton')}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/suppliers/[supplierId]/_components/LinkExpenseDialog.tsx ===================

// src/app/[locale]/(app)/finances/suppliers/[supplierId]/_components/LinkExpenseDialog.tsx
"use client";

import { useState, useTransition } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
  DialogFooter
} from '@/components/ui/dialog';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Loader2, Link2 as LinkIcon, Search, CreditCard } from 'lucide-react'; // Canviat nom Link2
import { useDebouncedCallback } from 'use-debounce';
import { toast } from 'sonner';

// Importa les noves accions i tipus
import {
  searchExpensesForLinking,
  linkExpenseToSupplier
} from '@/app/[locale]/(app)/finances/expenses/actions';
import { type Expense } from '@/types/finances/expenses'; // Ajusta la ruta/tipus si cal
import { formatDate, formatCurrency } from '@/lib/utils/formatters';

// Tipus per als resultats de la cerca
type SearchResult = Pick<Expense, 'id' | 'description' | 'expense_date' | 'total_amount'>;

interface LinkExpenseDialogProps {
  supplierId: string;
  isOpen: boolean;
  onOpenChange: (open: boolean) => void;
  // FunciÃ³ per notificar al pare (ExpensesTabContent) que s'ha vinculat una despesa
  onLinkSuccess: (newlyLinkedExpense: Expense) => void;
  t: (key: string) => string;
}

export function LinkExpenseDialog({
  supplierId,
  isOpen,
  onOpenChange,
  onLinkSuccess,
  t
}: LinkExpenseDialogProps) {
  const [searchTerm, setSearchTerm] = useState('');
  const [results, setResults] = useState<SearchResult[]>([]);
  const [isSearching, startSearchTransition] = useTransition();
  const [isLinking, startLinkTransition] = useTransition();

  const handleSearch = useDebouncedCallback((term: string) => {
    if (term.length < 2) {
      setResults([]);
      return;
    }
    startSearchTransition(async () => {
      const data = await searchExpensesForLinking(term);
      setResults(data);
    });
  }, 300);

  const handleLinkClick = (expenseId: number) => {
    startLinkTransition(async () => {
      const result = await linkExpenseToSupplier(expenseId, supplierId);
      if (result.success && result.data) {
        toast.success(t('expensesCard.linkDialog.toastSuccess'));
        onLinkSuccess(result.data); // Notifica al pare
        onOpenChange(false); // Tanca el diÃ leg
        setSearchTerm('');
        setResults([]);
      } else {
        toast.error(result.message || t('expensesCard.linkDialog.toastError'));
      }
    });
  };

  // Reseteja l'estat en tancar el diÃ leg
  const handleOpenChange = (open: boolean) => {
    if (!open) {
      setSearchTerm('');
      setResults([]);
    }
    onOpenChange(open);
  };

  return (
    <Dialog open={isOpen} onOpenChange={handleOpenChange}>
      <DialogContent className="sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle>{t('expensesCard.linkDialog.title')}</DialogTitle>
          <DialogDescription>
            {t('expensesCard.linkDialog.description')}
          </DialogDescription>
        </DialogHeader>

        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
          <Input
            placeholder={t('expensesCard.linkDialog.searchPlaceholder')}
            className="pl-9"
            value={searchTerm}
            onChange={(e) => {
              setSearchTerm(e.target.value);
              handleSearch(e.target.value);
            }}
          />
        </div>

        <div className="mt-4 space-y-2 max-h-[300px] overflow-y-auto">
          {isSearching && (
            <div className="flex justify-center items-center py-4">
              <Loader2 className="h-5 w-5 animate-spin" />
            </div>
          )}
          {!isSearching && results.length === 0 && searchTerm.length >= 2 && (
            <p className="text-sm text-center text-muted-foreground">
              {t('expensesCard.linkDialog.noResults')}
            </p>
          )}
          {results.map((expense) => (
            <div
              key={expense.id}
              className="flex items-center justify-between p-2 border rounded-md"
            >
              <div className="flex items-center gap-2">
                 <CreditCard className="h-4 w-4 text-muted-foreground flex-shrink-0" />
                 <div className="flex flex-col">
                    <p className="text-sm font-medium truncate" title={expense.description || ''}>
                      {expense.description || "Sense descripciÃ³"}
                    </p>
                    <p className="text-xs text-muted-foreground">
                      {formatDate(expense.expense_date)} - {formatCurrency(expense.total_amount)}
                    </p>
                 </div>
              </div>
              <Button
                size="sm"
                variant="outline"
                onClick={() => handleLinkClick(expense.id)}
                disabled={isLinking}
              >
                <LinkIcon className="h-4 w-4 mr-2" />
                {t('expensesCard.linkDialog.linkButton')}
              </Button>
            </div>
          ))}
        </div>

        <DialogFooter>
          <Button variant="ghost" onClick={() => handleOpenChange(false)}>
            {t('expensesCard.linkDialog.cancelButton')}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/suppliers/[supplierId]/_components/SupplierDetailClient.tsx ===================

// /app/[locale]/(app)/finances/suppliers/[supplierId]/_components/SupplierDetailClient.tsx (FITXER CORREGIT)
"use client";

// Import tipus
// âœ… 1. Importem el tipus Supplier des del SERVEI
import { type Supplier } from '@/lib/services/finances/suppliers/suppliers.service';
// âœ… 2. Importem els tipus de dades relacionades des dels seus SERVEIS/TIPUS
import { type ContactForSupplier } from '@/types/db'; // Assumint que aquest Ã©s el teu tipus
import { type ExpenseForSupplier } from '@/app/[locale]/(app)/finances/expenses/actions'; // Aquest encara ve de 'actions'
import { type TicketForSupplier } from '@/types/db';
// Import hooks i components
import { useSupplierForm } from '../_hooks/useSupplierForm';
import { SupplierForm } from './SupplierForm'; 
import { RelatedDataTabs } from './tabs/RelateDataTabs'; 

interface SupplierDetailClientProps {
  initialData: Supplier | null;
  supplierId: string | null;
  contacts: ContactForSupplier[];
  expenses: ExpenseForSupplier[];
  tickets: TicketForSupplier[];
}

export function SupplierDetailClient({ 
  initialData, 
  supplierId, 
  contacts, 
  expenses, 
  tickets 
}: SupplierDetailClientProps) {
  
  const formProps = useSupplierForm({ initialData, supplierId });
  const isNew = supplierId === null;

  return (
    <div className="flex flex-col gap-6">
      <SupplierForm {...formProps} />

      {!isNew && supplierId && ( // âœ… Assegurem que supplierId no Ã©s null
        <RelatedDataTabs 
          contacts={contacts}
          expenses={expenses}
          tickets={tickets}
          supplierId={supplierId} 
          supplierEmail={formProps.formData.email} 
          t={formProps.t} 
        />
      )}
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/suppliers/[supplierId]/_components/SupplierDetailData.tsx ===================

// /app/[locale]/(app)/finances/suppliers/[supplierId]/_components/SupplierDetailData.tsx (FITXER CORREGIT)
import { fetchSupplierDetail } from '../actions';
import { SupplierDetailClient } from './SupplierDetailClient';
import { fetchContactsForSupplier } from '@/app/[locale]/(app)/crm/contactes/actions';
import { fetchExpensesForSupplier } from '@/app/[locale]/(app)/finances/expenses/actions';
import { fetchTicketsForSupplierContacts } from '@/app/[locale]/(app)/comunicacio/inbox/actions';
import { PageHeader } from '@/components/shared/PageHeader';
import { getTranslations } from 'next-intl/server';

// âœ… 1. Importem el tipus que falta
import { type TicketForSupplier } from '@/types/db';

interface SupplierDetailDataProps {
  supplierId: string;
}

export async function SupplierDetailData({ supplierId }: SupplierDetailDataProps) {
  const isNew = supplierId === 'new';

  const t = await getTranslations('SupplierDetailPage');
  const title = isNew ? t('createTitle') : t('editTitle');
  const description = isNew ? t('createDescription') : t('editDescription');

  if (isNew) {
    return (
      <div className="flex flex-col gap-6">
        <PageHeader
          title={title}
          description={description}
          showBackButton={true}
        />
        <SupplierDetailClient
          initialData={null}
          supplierId={null} // Passem null per a 'new'
          contacts={[]}
          expenses={[]}
          tickets={[]}
        />
      </div>
    );
  }

  // 1. CÃ rrega de dades principals en paralÂ·lel
  const [
    supplierData,
    contactsData,
    expensesData
  ] = await Promise.all([
    fetchSupplierDetail(supplierId),
    fetchContactsForSupplier(supplierId),
    fetchExpensesForSupplier(supplierId)
  ]);

  // 2. CÃ rrega de dades dependents (Tiquets)
  
  // âœ… 2. Donem el tipus explÃ­cit a la variable
  let ticketsData: TicketForSupplier[] = []; // Inicialitzem a buit
  
  if (contactsData && contactsData.length > 0) {
    try {
      // NomÃ©s busquem tiquets si el proveÃ¯dor tÃ© contactes
      ticketsData = await fetchTicketsForSupplierContacts(supplierId);
    } catch (error) {
      console.error("Error en fetchTicketsForSupplierContacts (SupplierDetailData):", error);
      // No aturem la cÃ rrega de la pÃ gina, simplement no hi haurÃ  tiquets.
      ticketsData = []; 
    }
  }

  // 'fetchSupplierDetail' ja llanÃ§a notFound() si no troba dades
  // (Ho hem definit al servei)

  return (
    <div className="flex flex-col gap-6">
      <PageHeader
        title={title}
        description={description}
        showBackButton={true}
      />
      <SupplierDetailClient
        initialData={supplierData}
        supplierId={supplierId}
        contacts={contactsData || []}
        expenses={expensesData || []}
        tickets={ticketsData || []} // Passem les dades (plenes o buides)
      />
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/suppliers/[supplierId]/_components/SupplierForm.tsx ===================

"use client";

import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { type useSupplierForm } from '../_hooks/useSupplierForm';

// Tipus per a les props que rep del hook
type SupplierFormProps = ReturnType<typeof useSupplierForm>;

export function SupplierForm({
  isPending,
  formData,
  errors,
  handleFieldChange,
  handleSubmit,
  t // FunciÃ³ de traducciÃ³
}: SupplierFormProps) {

  // âŒ Eliminem la variable 'isNew' que no s'utilitzava
  // const isNew = !('id' in formData) || !formData.id;

  return (
    <form onSubmit={handleSubmit}>
      <Card>
        <CardHeader>
           {/* âœ… Eliminem el segon argument (fallback string) */}
           {/* Assegura't que 'detailsCardTitle' existeix a SupplierDetailPage */}
           <CardTitle>{t('detailsCardTitle')}</CardTitle>
           {/* Assegura't que 'detailsCardDescription' existeix a SupplierDetailPage */}
           <CardDescription>{t('detailsCardDescription')}</CardDescription>
        </CardHeader>
        <CardContent className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div className="space-y-2">
            <Label htmlFor="nom">{t('form.name')}</Label>
            <Input id="nom" value={formData.nom || ''} onChange={(e) => handleFieldChange('nom', e.target.value)} disabled={isPending}/>
            {errors.nom && <p className="text-sm text-red-500">{errors.nom}</p>}
          </div>
          <div className="space-y-2">
            <Label htmlFor="nif">{t('form.nif')}</Label>
            <Input id="nif" value={formData.nif || ''} onChange={(e) => handleFieldChange('nif', e.target.value)} disabled={isPending}/>
          </div>
          <div className="space-y-2">
            <Label htmlFor="email">{t('form.email')}</Label>
            <Input id="email" type="email" value={formData.email || ''} onChange={(e) => handleFieldChange('email', e.target.value)} disabled={isPending}/>
          </div>
          <div className="space-y-2">
            <Label htmlFor="telefon">{t('form.phone')}</Label>
            <Input id="telefon" value={formData.telefon || ''} onChange={(e) => handleFieldChange('telefon', e.target.value)} disabled={isPending}/>
          </div>
          <div className="md:col-span-2 flex justify-end">
            <Button type="submit" disabled={isPending}>
              {isPending ? t('form.saving') : t('form.save')}
            </Button>
          </div>
        </CardContent>
      </Card>
    </form>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/suppliers/[supplierId]/_components/tabs/ContactsTabContent.tsx ===================

// /app/[locale]/(app)/finances/suppliers/[supplierId]/_components/tabs/ContactsTabContent.tsx (MILLORAT PER A MÃ’BIL)
"use client";

import { useState, useTransition } from 'react'; 
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import {
  PlusCircle, Users, Mail, Phone, Link2,
  Trash2, Loader2 
} from 'lucide-react';
import { unlinkContactFromSupplier } from '@/app/[locale]/(app)/crm/contactes/actions';
import { LinkContactDialog } from '../LinkContactDialog';
import type { Contact , ContactForSupplier } from "@/types/db";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog"; 
import { toast } from 'sonner';

interface ContactsTabContentProps {
  contacts: ContactForSupplier[];
  supplierId: string;
  t: (key: string, values?: Record<string, unknown>) => string; 
}

export function ContactsTabContent({ contacts: initialContactsProp, supplierId, t }: ContactsTabContentProps) {
  const router = useRouter();

  const [contacts, setContacts] = useState(initialContactsProp || []);
  const [isLinkDialogOpen, setIsLinkDialogOpen] = useState(false);
  const [isUnlinking, startUnlinkTransition] = useTransition();

  const handleLinkSuccess = (newlyLinkedContact: Contact) => {
    setContacts(prevContacts => [
      ...prevContacts,
      {
        id: newlyLinkedContact.id,
        nom: newlyLinkedContact.nom,
        job_title: newlyLinkedContact.job_title || null,
        email: newlyLinkedContact.email || null,
        telefon: newlyLinkedContact.telefon || null,
      } as ContactForSupplier
    ]);
  };

  const handleUnlink = (contactId: number) => {
    startUnlinkTransition(async () => {
      const result = await unlinkContactFromSupplier(String(contactId), supplierId);
      if (result.success) {
        toast.success(result.message);
        setContacts(prev => prev.filter(c => c.id !== contactId));
      } else {
        toast.error(result.message || "Error en desvincular.");
      }
    });
  };

  return (
    <>
      <Card>
        {/* âœ… MILLORA MÃ’BIL: CapÃ§alera apilable */}
        <CardHeader className="flex flex-col sm:flex-row items-start sm:items-center sm:justify-between gap-4">
          <div>
            <CardTitle className="flex items-center gap-2"><Users className="h-5 w-5" />{t('contactsCard.title')}</CardTitle>
            <CardDescription>{t('contactsCard.description')}</CardDescription>
          </div>
           {/* âœ… MILLORA MÃ’BIL: Botons apilables i amplada completa en mÃ²bil */}
          <div className="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
            <Button
              variant="outline"
              size="sm"
              onClick={() => setIsLinkDialogOpen(true)}
              className="w-full sm:w-auto" // Amplada adaptativa
            >
              <Link2 className="h-4 w-4 mr-2" />
              {t('contactsCard.linkButton')}
            </Button>

            <Button
              variant="default"
              size="sm"
              onClick={() => router.push(`/crm/contactes/new?supplierId=${supplierId}`)}
              className="w-full sm:w-auto" // Amplada adaptativa
            >
              <PlusCircle className="h-4 w-4 mr-2" />
              {t('contactsCard.newButton')}
            </Button>
          </div>
        </CardHeader>
        <CardContent>
          {contacts.length > 0 ? (
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead>{t('contactsCard.table.name')}</TableHead>
                  {/* âœ… MILLORA MÃ’BIL: Amaguem Email en pantalles mitjanes/petites */}
                  <TableHead className="hidden md:table-cell">{t('contactsCard.table.email')}</TableHead>
                  {/* âœ… MILLORA MÃ’BIL: Amaguem TelÃ¨fon en pantalles petites */}
                  <TableHead className="hidden sm:table-cell">{t('contactsCard.table.phone')}</TableHead>
                  <TableHead className="w-[50px]">
                    <span className="sr-only">Accions</span>
                  </TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {contacts.map((contact) => (
                  <TableRow key={contact.id}>
                    <TableCell>
                      <Link
                        href={`/crm/contactes/${contact.id}?from=/finances/suppliers/${supplierId}`}
                        className="font-medium text-blue-600 hover:underline"
                      >
                        {contact.nom}
                      </Link>
                    </TableCell>
                    {/* âœ… MILLORA MÃ’BIL: Amaguem Email */}
                    <TableCell className="hidden md:table-cell">{contact.email ? (<a href={`mailto:${contact.email}`} className="flex items-center gap-2 hover:underline"><Mail className="h-3 w-3" /> {contact.email}</a>) : '-'}</TableCell>
                    {/* âœ… MILLORA MÃ’BIL: Amaguem TelÃ¨fon */}
                    <TableCell className="hidden sm:table-cell">{contact.telefon ? (<a href={`tel:${contact.telefon}`} className="flex items-center gap-2 hover:underline"><Phone className="h-3 w-3" /> {contact.telefon}</a>) : '-'}</TableCell>

                    <TableCell>
                      <AlertDialog>
                        <AlertDialogTrigger asChild>
                          <Button
                            variant="ghost"
                            size="icon"
                            className="h-8 w-8 text-muted-foreground hover:text-destructive"
                            disabled={isUnlinking}
                          >
                            <span className="sr-only">Desvincular contacte</span>
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </AlertDialogTrigger>
                        <AlertDialogContent>
                          <AlertDialogHeader>
                            <AlertDialogTitle>{t('contactsCard.unlinkDialog.title')}</AlertDialogTitle>
                            <AlertDialogDescription>
                              {t('contactsCard.unlinkDialog.description', { contactName: contact.nom })}
                            </AlertDialogDescription>
                          </AlertDialogHeader>
                          <AlertDialogFooter>
                            <AlertDialogCancel>CancelÂ·lar</AlertDialogCancel>
                            <AlertDialogAction
                              className="bg-destructive hover:bg-destructive/90"
                              onClick={() => handleUnlink(contact.id)}
                              disabled={isUnlinking}
                            >
                              {isUnlinking ? <Loader2 className="h-4 w-4 animate-spin" /> : "Desvincular"}
                            </AlertDialogAction>
                          </AlertDialogFooter>
                        </AlertDialogContent>
                      </AlertDialog>
                    </TableCell>

                  </TableRow>
                ))}
              </TableBody>
            </Table>
          ) : (
            <p className="text-sm text-muted-foreground">{t('contactsCard.empty')}</p>
          )}
        </CardContent>
      </Card>

      <LinkContactDialog
        supplierId={supplierId}
        isOpen={isLinkDialogOpen}
        onOpenChange={setIsLinkDialogOpen}
        t={t}
        onLinkSuccess={handleLinkSuccess}
      />
    </>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/suppliers/[supplierId]/_components/tabs/ExpensesTabContent.tsx ===================

// /app/[locale]/(app)/finances/suppliers/[supplierId]/_components/tabs/ExpensesTabContent.tsx (MILLORAT PER A MÃ’BIL)
"use client";

import { useState, useTransition } from 'react'; 
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { type Expense } from '@/types/finances';
import {
  PlusCircle, CreditCard, Link2 as LinkIcon, 
  Trash2, Loader2 
} from 'lucide-react';
import {
  type ExpenseForSupplier,
  unlinkExpenseFromSupplier, 

} from '@/app/[locale]/(app)/finances/expenses/actions';

import { formatDate, formatCurrency } from '@/lib/utils/formatters';
import { StatusBadge } from '@/components/shared/StatusBadge';
import { LinkExpenseDialog } from '../LinkExpenseDialog'; 
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog"; 
import { toast } from 'sonner';

interface ExpensesTabContentProps {
  expenses: ExpenseForSupplier[];
  supplierId: string;
  t: (key: string) => string;
}

export function ExpensesTabContent({ expenses: initialExpensesProp, supplierId, t }: ExpensesTabContentProps) {
  const router = useRouter();

  const [expenses, setExpenses] = useState(initialExpensesProp || []);
  const [isLinkDialogOpen, setIsLinkDialogOpen] = useState(false);
  const [isUnlinking, startUnlinkTransition] = useTransition();

  const handleLinkSuccess = (newlyLinkedExpense: Expense) => {
    setExpenses(prevExpenses => [
      ...prevExpenses,
      {
        id: newlyLinkedExpense.id,
        expense_date: newlyLinkedExpense.expense_date,
        description: newlyLinkedExpense.description,
        total_amount: newlyLinkedExpense.total_amount,
        status: newlyLinkedExpense.status, 
      } as ExpenseForSupplier
    ].sort((a, b) => new Date(b.expense_date || 0).getTime() - new Date(a.expense_date || 0).getTime())); 
  };

  const handleUnlink = (expenseId: number) => {
    startUnlinkTransition(async () => {
      const result = await unlinkExpenseFromSupplier(expenseId, supplierId);
      if (result.success) {
        toast.success(result.message);
        setExpenses(prev => prev.filter(e => e.id !== expenseId));
      } else {
        toast.error(result.message || "Error en desvincular.");
      }
    });
  };

  return (
    <>
      <Card>
        {/* âœ… MILLORA MÃ’BIL: CapÃ§alera apilable */}
        <CardHeader className="flex flex-col sm:flex-row items-start sm:items-center sm:justify-between gap-4">
          <div>
            <CardTitle className="flex items-center gap-2"><CreditCard className="h-5 w-5" />{t('expensesCard.title')}</CardTitle>
            <CardDescription>{t('expensesCard.description')}</CardDescription>
          </div>
          {/* âœ… MILLORA MÃ’BIL: Botons apilables i amplada completa en mÃ²bil */}
          <div className="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
            <Button
              variant="outline"
              size="sm"
              onClick={() => setIsLinkDialogOpen(true)}
              className="w-full sm:w-auto" // Amplada adaptativa
            >
              <LinkIcon className="h-4 w-4 mr-2" />
              {t('expensesCard.linkButton')}
            </Button>

            <Button
              variant="default"
              size="sm"
              onClick={() => router.push(`/finances/expenses/new?supplierId=${supplierId}`)}
              className="w-full sm:w-auto" // Amplada adaptativa
            >
              <PlusCircle className="h-4 w-4 mr-2" />
              {t('expensesCard.newButton')}
            </Button>
          </div>
        </CardHeader>
        <CardContent>
          {expenses.length > 0 ? (
            <Table>
              <TableHeader>
                <TableRow>
                  {/* âœ… MILLORA MÃ’BIL: Amaguem Data en pantalles petites */}
                  <TableHead className="hidden md:table-cell">{t('expensesCard.table.date')}</TableHead>
                  <TableHead>{t('expensesCard.table.description')}</TableHead>
                  <TableHead className="text-right">{t('expensesCard.table.amount')}</TableHead>
                  {/* âœ… MILLORA MÃ’BIL: Amaguem Estat en pantalles petites */}
                  <TableHead className="hidden sm:table-cell">{t('expensesCard.table.status')}</TableHead>
                  <TableHead className="w-[50px]"> 
                    <span className="sr-only">Accions</span>
                  </TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {expenses.map((expense) => (
                  <TableRow key={expense.id}>
                    {/* âœ… MILLORA MÃ’BIL: Amaguem Data en pantalles petites */}
                    <TableCell className="hidden md:table-cell">{formatDate(expense.expense_date ?? "")}</TableCell>
                    <TableCell>
                      <Link
                        href={`/finances/expenses/${expense.id}?from=/finances/suppliers/${supplierId}`}
                        className="hover:underline"
                      >
                        {expense.description || `Despesa #${expense.id}`}
                      </Link>
                    </TableCell>
                    <TableCell className="text-right">{formatCurrency(expense.total_amount)}</TableCell>
                    {/* âœ… MILLORA MÃ’BIL: Amaguem Estat en pantalles petites */}
                    <TableCell className="hidden sm:table-cell"><StatusBadge status={expense.status} /></TableCell>

                    <TableCell>
                      <AlertDialog>
                        <AlertDialogTrigger asChild>
                          <Button
                            variant="ghost"
                            size="icon"
                            className="h-8 w-8 text-muted-foreground hover:text-destructive"
                            disabled={isUnlinking}
                          >
                            <span className="sr-only">Desvincular despesa</span>
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </AlertDialogTrigger>
                        <AlertDialogContent>
                          <AlertDialogHeader>
                            <AlertDialogTitle>{t('expensesCard.unlinkDialog.title')}</AlertDialogTitle>
                            <AlertDialogDescription>
                              {t('expensesCard.unlinkDialog.description') + ' ' + (expense.description || `Despesa #${expense.id}`)}
                            </AlertDialogDescription>
                          </AlertDialogHeader>
                          <AlertDialogFooter>
                            <AlertDialogCancel disabled={isUnlinking}>CancelÂ·lar</AlertDialogCancel>
                            <AlertDialogAction
                              className="bg-destructive hover:bg-destructive/90"
                              onClick={() => expense.id !== undefined && handleUnlink(expense.id)}
                              disabled={isUnlinking}
                            >
                              {isUnlinking ? <Loader2 className="h-4 w-4 animate-spin" /> : "Desvincular"}
                            </AlertDialogAction>
                          </AlertDialogFooter>
                        </AlertDialogContent>
                      </AlertDialog>
                    </TableCell>

                  </TableRow>
                ))}
              </TableBody>
            </Table>
          ) : (
            <p className="text-sm text-muted-foreground">{t('expensesCard.empty')}</p>
          )}
        </CardContent>
      </Card>

      <LinkExpenseDialog
        supplierId={supplierId}
        isOpen={isLinkDialogOpen}
        onOpenChange={setIsLinkDialogOpen}
        onLinkSuccess={handleLinkSuccess}
        t={t}
      />
    </>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/suppliers/[supplierId]/_components/tabs/RelateDataTabs.tsx ===================

// /app/[locale]/(app)/finances/suppliers/[supplierId]/_components/tabs/RelateDataTabs.tsx (MILLORAT PER A MÃ’BIL)
"use client";

import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Users, CreditCard, Inbox } from 'lucide-react';

// Importa els tipus de dades
import { type ContactForSupplier } from '@/types/db';
import { type ExpenseForSupplier } from '@/app/[locale]/(app)/finances/expenses/actions';
import { type TicketForSupplier } from '@/types/db';

// Importa els components de contingut de cada pestanya
import { ContactsTabContent } from './ContactsTabContent';
import { ExpensesTabContent } from './ExpensesTabContent';
import { TicketsTabContent } from './TicketsTabContent';

interface RelatedDataTabsProps {
  contacts: ContactForSupplier[];
  expenses: ExpenseForSupplier[];
  tickets: TicketForSupplier[];
  supplierId: string | null; // ID per als botons "Nou"
  supplierEmail: string | null | undefined; // Email per al botÃ³ "Cercar Inbox"
  t: (key: string) => string; 
}

export function RelatedDataTabs({
  contacts,
  expenses,
  tickets,
  supplierId,
  supplierEmail,
  t
}: RelatedDataTabsProps) {

  // Assegura't que supplierId no sigui null abans de passar-lo als fills
  const validSupplierId = supplierId ?? ''; 

  return (
    <Tabs defaultValue="contacts" className="w-full">
      
      {/* âœ… SOLUCIÃ“: 
        Mantenim el teu 'grid-cols-3' perquÃ¨ les pestanyes ocupin tot l'ample,
        perÃ² fem que el contingut s'adapti.
      */}
      <TabsList className="grid w-full grid-cols-3 mb-4">
        
        <TabsTrigger value="contacts">
          {/* L'icona sempre Ã©s visible. El marge dret (mr-2) nomÃ©s s'aplica en 'sm' (desktop) */}
          <Users className="h-4 w-4 sm:mr-2"/> 
          {/* El text s'amaga per defecte (mÃ²bil) i es mostra com 'inline' a partir de 'sm' (desktop) */}
          <span className="hidden sm:inline">
            {t('contactsCard.title')} ({contacts.length})
          </span>
        </TabsTrigger>
        
        <TabsTrigger value="expenses">
          <CreditCard className="h-4 w-4 sm:mr-2"/> 
          <span className="hidden sm:inline">
            {t('expensesCard.title')} ({expenses.length})
          </span>
        </TabsTrigger>
        
        <TabsTrigger value="tickets">
          <Inbox className="h-4 w-4 sm:mr-2"/> 
          <span className="hidden sm:inline">
            {t('ticketsCard.title')} ({tickets.length})
          </span>
        </TabsTrigger>
      </TabsList>

      <TabsContent value="contacts">
        <ContactsTabContent 
            contacts={contacts} 
            supplierId={validSupplierId} 
            t={t} 
        />
      </TabsContent>

      <TabsContent value="expenses">
        <ExpensesTabContent 
            expenses={expenses} 
            supplierId={validSupplierId} 
            t={t} 
        />
      </TabsContent>

      <TabsContent value="tickets">
        <TicketsTabContent 
            tickets={tickets} 
            supplierEmail={supplierEmail} 
            t={t} 
        />
      </TabsContent>
    </Tabs>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/suppliers/[supplierId]/_components/tabs/TicketsTabContent.tsx ===================

// /app/[locale]/(app)/finances/suppliers/[supplierId]/_components/tabs/TicketsTabContent.tsx (MILLORAT PER A MÃ’BIL)
"use client";

import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Search, Inbox } from 'lucide-react';
import { type TicketForSupplier } from '@/types/db';
import { formatDate } from '@/lib/utils/formatters';
import { StatusBadge } from '@/components/shared/StatusBadge';

interface TicketsTabContentProps {
  tickets: TicketForSupplier[];
  supplierEmail: string | null | undefined;
  t: (key: string) => string;
}

export function TicketsTabContent({ tickets, supplierEmail, t }: TicketsTabContentProps) {
  const router = useRouter();

  return (
    <Card>
      {/* âœ… MILLORA MÃ’BIL: CapÃ§alera apilable */}
      <CardHeader className="flex flex-col sm:flex-row items-start sm:items-center sm:justify-between gap-4">
        <div>
          <CardTitle className="flex items-center gap-2"><Inbox className="h-5 w-5" />{t('ticketsCard.title')}</CardTitle>
          <CardDescription>{t('ticketsCard.description')}</CardDescription>
        </div>
        {supplierEmail && (
          <Button 
            variant="outline" 
            size="sm" 
            onClick={() => router.push(`/comunicacio/inbox?search=${encodeURIComponent(supplierEmail)}`)}
            className="w-full sm:w-auto" // Amplada adaptativa
          >
            <Search className="h-4 w-4 mr-2" />
            {t('ticketsCard.searchInboxButton')}
          </Button>
        )}
      </CardHeader>
      <CardContent>
        {tickets.length > 0 ? (
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>{t('ticketsCard.table.subject')}</TableHead>
                {/* âœ… MILLORA MÃ’BIL: Amaguem Ãšltima Activitat */}
                <TableHead className="hidden sm:table-cell">{t('ticketsCard.table.lastActivity')}</TableHead>
                <TableHead>{t('ticketsCard.table.status')}</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {tickets.map((ticket) => (
                <TableRow key={ticket.id}>
                  <TableCell>
                    {ticket.subject || t('ticketsCard.noSubject')}
                  </TableCell>
                  {/* âœ… MILLORA MÃ’BIL: Amaguem Ãšltima Activitat */}
                  <TableCell className="hidden sm:table-cell">
                    {ticket.sent_at 
                      ? formatDate(ticket.sent_at, "true") 
                      : 'N/A'}
                  </TableCell>
                  <TableCell><StatusBadge status={ticket.status} /></TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        ) : (
          <p className="text-sm text-muted-foreground">{t('ticketsCard.empty')}</p>
        )}
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/suppliers/[supplierId]/_hooks/useSupplierForm.ts ===================

// /app/[locale]/(app)/finances/suppliers/[supplierId]/_hooks/useSupplierForm.ts (FITXER CORREGIT)
"use client";

import { useState, useTransition } from 'react';
import { useRouter } from 'next/navigation';
import { useTranslations } from 'next-intl';
import { toast } from 'sonner';
import { type z } from 'zod';

// âœ… 1. Importem l'acciÃ³ de detall
import { saveSupplierAction } from '../actions';
// âœ… 2. Importem els tipus des del SERVEI
import { type Supplier, type SupplierFormData } from '@/lib/services/finances/suppliers/suppliers.service';
// âœ… 3. Importem el schema
import { type supplierFormSchema } from '../schemas';

type SupplierFormValues = z.infer<typeof supplierFormSchema>;

interface UseSupplierFormProps {
  initialData: Supplier | null;
  supplierId: string | null;
}

const defaultValues: SupplierFormData = { nom: '', nif: null, email: null, telefon: null };

export function useSupplierForm({ initialData, supplierId }: UseSupplierFormProps) {
  const t = useTranslations('SupplierDetailPage');
  const router = useRouter();
  const [isPending, startTransition] = useTransition();
  const [formData, setFormData] = useState<SupplierFormData>(
    initialData
      ? {
          nom: initialData.nom ?? '',
          nif: initialData.nif ?? null,
          email: initialData.email ?? null,
          telefon: initialData.telefon ?? null,
          // Afegeix aquÃ­ la resta de camps del formulari
      }
      : defaultValues
  );
  // ValidaciÃ³ simple, ja que 'schemas.ts' no l'estÃ s fent servir amb useFormState
  const [errors, setErrors] = useState<Partial<Record<keyof SupplierFormValues, string>>>({});

  const handleFieldChange = (field: keyof SupplierFormData, value: string | null) => {
    setFormData(prev => ({ ...prev, [field]: value }));
    if (errors[field as keyof SupplierFormValues]) {
      setErrors(prev => ({ ...prev, [field]: undefined }));
    }
  };

  const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setErrors({});
    if (!formData.nom || formData.nom.length < 2) {
      setErrors({ nom: t('validation.nameRequired') });
      return;
    }

    startTransition(async () => {
      // âœ… Crida a l'acciÃ³ de detall
      const result = await saveSupplierAction(formData, supplierId);
      
      if (result.success) {
        toast.success(result.message);

        if (supplierId === null && result.data?.id) {
          // EstÃ vem CREANT -> Anem a la nova pÃ gina d'ediciÃ³
          router.replace(`/finances/suppliers/${result.data.id}`);
        } else if (supplierId !== null) {
          // EstÃ vem EDITANT -> Refresquem dades
          router.refresh();
        }
      } else {
        toast.error(result.message || t('toast.saveError'));
      }
    });
  };

  return { isPending, formData, errors, handleFieldChange, handleSubmit, t };
}

// =================== FILE: src/app/[locale]/(app)/finances/suppliers/_components/SuppliersClient.tsx ===================

// /app/[locale]/(app)/finances/suppliers/_components/SuppliersClient.tsx (FITXER CORREGIT)
"use client";

import { useMemo } from 'react';
import Link from 'next/link';
import { useTranslations, useLocale } from 'next-intl';
import { PlusCircle, Edit } from 'lucide-react';
import { useRouter } from 'next/navigation';

// âœ… 1. Importem ACCIONS des d'../actions
import { fetchPaginatedSuppliers, deleteSupplierAction } from '../actions';
// âœ… 2. Importem TIPUS des del SERVEI
import type { Supplier, SupplierPageFilters } from '@/lib/services/finances/suppliers/suppliers.service';
// Importem tipus genÃ¨rics que ja tenÃ­em
import { type ActionResult } from '@/types/shared/actionResult';
import { usePaginatedResource, type PaginatedResponse, type PaginatedActionParams } from '@/hooks/usePaginateResource';

// Components Compartits
import { PageHeader } from '@/components/shared/PageHeader';
import { Button } from '@/components/ui/button';
import { GenericDataTable, type ColumnDef } from '@/components/shared/GenericDataTable';
import { ColumnToggleButton } from '@/components/shared/ColumnToggleButton';
import { SuppliersFilters } from './SuppliersFilters';
import { formatDate } from '@/lib/utils/formatters';

// Alias i Constants
type PaginatedSuppliersResponse = PaginatedResponse<Supplier>;
type FetchSuppliersParams = PaginatedActionParams<SupplierPageFilters>;
const SUPPLIER_ROWS_PER_PAGE_OPTIONS = [10, 25, 50];

// Props del Component
interface SuppliersClientProps {
  initialData: PaginatedSuppliersResponse;
}

export function SuppliersClient({ initialData }: SuppliersClientProps) {
  const t = useTranslations('SuppliersPage');
  const tShared = useTranslations('Shared');
  const router = useRouter();
  const locale = useLocale();

  // --- DefiniciÃ³ de Columnes ---
  const allColumns = useMemo<ColumnDef<Supplier>[]>(() => [
    {
      accessorKey: 'nom',
      header: t('table.name'),
      enableSorting: true,
      cell: (supplier) => (
        <Link
          href={`/${locale}/finances/suppliers/${supplier.id}`}
          className="font-medium cursor-pointer text-primary hover:underline"
        >
          <div className="flex flex-col">
            <span>{supplier.nom}</span>
            {supplier.nif && <span className="text-muted-foreground text-xs">{supplier.nif}</span>}
          </div>
        </Link>
      ),
    },
    {
      accessorKey: 'email',
      header: t('table.email'),
      enableSorting: true,
      cell: (supplier) => supplier.email || '-',
    },
    {
      accessorKey: 'telefon',
      header: t('table.phone'),
      enableSorting: false,
      cell: (supplier) => supplier.telefon || '-',
    },
    {
      accessorKey: 'created_at',
      header: t('table.created'),
      enableSorting: true,
      cell: (supplier) => formatDate(supplier.created_at ?? ""),
    },
    {
      accessorKey: "actions_edit",
      header: "",
      enableSorting: false,
      cellClassName: "text-right",
      cell: (supplier) => (
        <Link href={`/${locale}/finances/suppliers/${supplier.id}`} title={tShared('actions.edit')}>
          <Button variant="ghost" size="icon"><Edit className="w-4 h-4" /></Button>
        </Link>
      ),
    }
  ], [t, tShared, locale]);

  // --- Hook GenÃ¨ric ---
  const {
    isPending,
    data: suppliers,
    itemToDelete: supplierToDelete,
    setItemToDelete: setSupplierToDelete,
    handleDelete,
    handleSort,
    currentSortColumn,
    currentSortOrder,
    searchTerm,
    handleSearchChange,
    columnVisibility,
    toggleColumnVisibility,
    page,
    totalPages,
    handlePageChange,
    rowsPerPage,
    handleRowsPerPageChange,
  } = usePaginatedResource<Supplier, SupplierPageFilters>({
    initialData,
    initialFilters: {}, // âœ… Tipus correcte
    initialSort: { column: 'nom', order: 'asc' },
    allColumns,
    fetchAction: fetchPaginatedSuppliers as (params: FetchSuppliersParams) => Promise<PaginatedSuppliersResponse>,
    deleteAction: async (id: string | number): Promise<ActionResult> => {
      if (typeof id !== 'string') {
        const msg = tShared('errors.invalidId') + " (expected string UUID)";
        console.error(msg, { id });
        return { success: false, message: msg };
      }
      return deleteSupplierAction(id);
    },
    initialRowsPerPage: SUPPLIER_ROWS_PER_PAGE_OPTIONS[0],
    rowsPerPageOptions: SUPPLIER_ROWS_PER_PAGE_OPTIONS,
    toastMessages: {
      deleteSuccess: t('toast.deleteSuccess'),
    }
  });

  // --- Columnes Visibles i DescripciÃ³ Esborrat ---
  // --- Columnes Visibles i DescripciÃ³ Esborrat ---
  const visibleColumns = useMemo(
    () => allColumns.filter(col => {
      // âœ… CORRECCIÃ“: LÃ²gica millorada per obtenir la clau de la columna.
      // Prioritzem 'id' (si existeix) i desprÃ©s 'accessorKey'.
      const key: string | undefined = ('id' in col && col.id)
        ? col.id.toString()
        : ('accessorKey' in col && col.accessorKey)
          ? col.accessorKey.toString()
          : undefined;

      // Si no tenim clau (columna sense id ni accessorKey), la mostrem per defecte.
      // Si tenim clau, comprovem la visibilitat.
      return key ? (columnVisibility[key] ?? true) : true;
    }),
    [allColumns, columnVisibility]
  );

  const deleteDescription = (
    <>
      {tShared('deleteDialog.description1')}{' '}
      <span className="font-bold">{supplierToDelete?.nom}</span>.
      <br />
      {tShared('deleteDialog.description2')}
    </>
  );

  // --- RenderitzaciÃ³ ---
  return (
    <div className="flex flex-col gap-4 h-full">
      <PageHeader
        title={t('title')}
      >
        <Button onClick={() => router.push(`/${locale}/finances/suppliers/new`)}>
          <PlusCircle className="mr-2 h-4 w-4" />
          {t('newButton')}
        </Button>
      </PageHeader>

      <div className="flex justify-between items-center">
        <SuppliersFilters
          searchTerm={searchTerm}
          onSearchChange={handleSearchChange}
        />
        <ColumnToggleButton
          allColumns={allColumns}
          columnVisibility={columnVisibility}
          toggleColumnVisibility={toggleColumnVisibility}
        />
      </div>

      <GenericDataTable<Supplier>
        className="flex-grow overflow-hidden"
        columns={visibleColumns}
        data={suppliers}
        isPending={isPending}
        onSort={handleSort}
        currentSortColumn={currentSortColumn}
        currentSortOrder={currentSortOrder as 'asc' | 'desc' | null}
        page={page}
        totalPages={totalPages}
        onPageChange={handlePageChange}
        rowsPerPage={rowsPerPage}
        onRowsPerPageChange={handleRowsPerPageChange}
        rowsPerPageOptions={SUPPLIER_ROWS_PER_PAGE_OPTIONS}
        deleteItem={supplierToDelete}
        setDeleteItem={setSupplierToDelete}
        onDelete={handleDelete}
        deleteTitleKey="SuppliersPage.deleteDialog.title"
        deleteDescription={deleteDescription}
        emptyStateMessage={t('emptyState')}
      />
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/finances/suppliers/_components/SuppliersData.tsx ===================

// /app/[locale]/(app)/finances/suppliers/_components/SuppliersData.tsx (FITXER CORREGIT)
import { redirect } from 'next/navigation';
import { SuppliersClient } from './SuppliersClient';
import { createClient as createServerActionClient } from '@/lib/supabase/server';
import { getTranslations } from 'next-intl/server';

// âœ… 1. Importem les ACCIONS des d'../actions
import { fetchPaginatedSuppliers } from '../actions'; 
// âœ… 2. Importem els TIPUS des del SERVEI
import type { SupplierPageFilters } from '@/lib/services/finances/suppliers/suppliers.service';

// Constants inicials
const INITIAL_ROWS_PER_PAGE = 10;
const INITIAL_SORT_COLUMN = 'nom';
const INITIAL_SORT_ORDER = 'asc';

export async function SuppliersData() {
    const supabase = createServerActionClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
        redirect('/login');
    }
    const t = await getTranslations('SuppliersPage'); 

    try {
        const initialData = await fetchPaginatedSuppliers({
            searchTerm: '',
            filters: {} as SupplierPageFilters, 
            sortBy: INITIAL_SORT_COLUMN,
            sortOrder: INITIAL_SORT_ORDER,
            limit: INITIAL_ROWS_PER_PAGE,
            offset: 0,
        });

        // âœ… ComprovaciÃ³ d'errors eliminada: la funciÃ³ ja llenÃ§a excepcions si hi ha error

        return (
            <SuppliersClient initialData={initialData} />
        );

    } catch (error) {
        console.error("Error during SuppliersData loading:", error);
        throw new Error(t('errors.loadDataFailed') || "No s'han pogut carregar les dades.");
    }
}

// =================== FILE: src/app/[locale]/(app)/finances/suppliers/_components/SuppliersFilters.tsx ===================

// src/app/[locale]/(app)/finances/suppliers/_components/SuppliersFilters.tsx
'use client';

import { Input } from "@/components/ui/input";
import { useTranslations } from "next-intl";
// â— Eliminem import innecessari: import { type SupplierPageFilters } from '../actions';

// âœ… CORRECCIÃ“ TS: Eliminem 'filters' i 'onFilterChange' de les props
interface SuppliersFiltersProps {
  searchTerm: string;
  onSearchChange: (value: string) => void;
  // categories?: string[]; // Si tinguessis categories
}

export function SuppliersFilters({
  searchTerm,
  onSearchChange,
}: SuppliersFiltersProps) {
  const t = useTranslations('SuppliersPage');

  return (
    <div className="flex items-center gap-2">
      <Input
        placeholder={t('searchPlaceholder') || "Busca per nom, NIF o email..."}
        value={searchTerm}
        onChange={(e) => onSearchChange(e.target.value)}
        className="max-w-xs h-9 bg-card border border-input"
      />
      {/* AquÃ­ anirien Selects si tinguessis filtres addicionals */}
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/layout.tsx ===================

import { ReactNode } from 'react';
import { NextIntlClientProvider } from 'next-intl';
import { getMessages } from 'next-intl/server';
import { AppClientLayout } from './_components/AppClientLayout';

// âœ… CORRECCIÃ“ 1: Definim el tipus de les propietats
// indicant que 'params' pot ser una promesa.
interface AppLayoutProps {
  children: ReactNode;
  params: Promise<{ locale: string }>;
};

/**
 * @summary Layout de servidor que embolcalla la part principal de l'aplicaciÃ³.
 */
export default async function AppLayout(props: AppLayoutProps) {
  // âœ… CORRECCIÃ“ 2: Fem 'await' per resoldre la promesa i obtenir els parÃ metres.
  const { locale } = await props.params;
  const { children } = props;

  // Carreguem els missatges necessaris per als components de client dins d'aquest layout.
  const messages = await getMessages({ locale });

  return (
    <NextIntlClientProvider locale={locale} messages={messages}>
      <AppClientLayout locale={locale}>{children}</AppClientLayout>
    </NextIntlClientProvider>
  );
}

// =================== FILE: src/app/[locale]/(app)/loading.tsx ===================

import { Loader2 } from "lucide-react";

/**
 * 'loading.tsx' Ã©s un arxiu especial de Next.js.
 * El component que s'exporta aquÃ­ s'utilitzarÃ  automÃ ticament com a 'fallback'
 * per al component <Suspense> del layout que l'envolta ('app/(app)/layout.tsx').
 * * AixÃ² permet mostrar una interfÃ­cie de cÃ rrega a l'instant mentre Next.js
 * carrega les dades de la nova pÃ gina al servidor, millorant molt l'experiÃ¨ncia
 * d'usuari durant la navegaciÃ³.
 */
export default function Loading() {
  return (
    <div className="flex h-full w-full items-center justify-center">
      <Loader2 className="h-10 w-10 animate-spin text-primary" />
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/network/actions.ts ===================

// /app/[locale]/network/actions.ts (FITXER REFACTORITZAT)
"use server";

import { validateUserSession } from "@/lib/supabase/session";
import { revalidatePath } from 'next/cache'; // Importem revalidatePath

// âœ… 1. Importem el NOU servei
import * as networkService from '@/lib/services/network/network.service';
// âœ… 2. Importem el NOU schema de Zod
import { CreateJobPostingSchema } from './schemas';
// âœ… 3. Importem els tipus de DADES (View Models)
import type { PublicProfileDetail, PublicJobPostingDetail } from './types'; 

/**
 * ACCIÃ“: ObtÃ© les dades detallades d'un sol equip.
 */
export async function getTeamDetailsAction(teamId: string): Promise<{ 
  success: boolean; 
  data?: PublicProfileDetail; 
  message?: string; 
}> {
  if (!teamId) {
    return { success: false, message: "Falta l'ID de l'equip." };
  }
  
  const session = await validateUserSession();
  if ('error' in session) {
    return { success: false, message: session.error.message };
  }
  const { supabase } = session;

  try {
    const data = await networkService.getTeamDetails(supabase, teamId);
    return { success: true, data: data };
  } catch (error: unknown) {
    const message = error instanceof Error ? error.message : "Error desconegut.";
    console.error("Error a getTeamDetailsAction:", message);
    return { success: false, message };
  }
}

/**
 * ACCIÃ“: ObtÃ© les dades detallades d'un sol projecte (job_posting).
 */
export async function getJobPostingDetailsAction(jobId: string): Promise<{
  success: boolean;
  data?: PublicJobPostingDetail;
  message?: string;
}> {
  if (!jobId) {
    return { success: false, message: "Falta l'ID del projecte." };
  }

  const session = await validateUserSession();
  if ('error' in session) {
    return { success: false, message: session.error.message };
  }
  const { supabase } = session;

  try {
    const data = await networkService.getJobPostingDetails(supabase, jobId);
    return { success: true, data: data };
  } catch (error: unknown) {
    const message = error instanceof Error ? error.message : "Error desconegut.";
    console.error("Error a getJobPostingDetailsAction:", message);
    return { success: false, message };
  }
}

/**
 * ACCIÃ“: Crea un nou projecte (job_posting).
 */
export async function createJobPostingAction(formData: FormData) {
  const session = await validateUserSession();
  if ('error' in session) {
    return { success: false, message: "AccÃ©s denegat. Has d'iniciar sessiÃ³." };
  }
  const { supabase } = session;

  // 1. ValidaciÃ³ de dades (es queda a l'acciÃ³/controlador)
  const formObject = Object.fromEntries(formData.entries());
  const validatedFields = CreateJobPostingSchema.safeParse({
    ...formObject,
    latitude: formObject.latitude ? parseFloat(formObject.latitude as string) : null,
    longitude: formObject.longitude ? parseFloat(formObject.longitude as string) : null,
    budget: formObject.budget ? parseFloat(formObject.budget as string) : null,
  });

  if (!validatedFields.success) {
    console.warn("ValidaciÃ³ de Zod fallida:", validatedFields.error.flatten());
    return { 
      success: false, 
      message: "Dades del formulari invÃ lides.", 
      errors: validatedFields.error.flatten().fieldErrors 
    };
  }
  
  try {
    // 2. Crida al servei
    const data = await networkService.createJobPosting(supabase, validatedFields.data);

    // 3. Efectes secundaris (RevalidaciÃ³)
    revalidatePath('/network'); // Revalidem la pÃ gina del network per veure el nou projecte

    return { success: true, data };

  } catch (error: unknown) {
    // 4. GestiÃ³ d'errors
    const message = error instanceof Error ? error.message : "Error desconegut en crear el projecte.";
    console.error("Error a createJobPostingAction:", message);
    return { success: false, message };
  }
}

// =================== FILE: src/app/[locale]/(app)/network/loading.tsx ===================

"use client";

/**
 * @summary Esquelet de cÃ rrega per a la pÃ gina de Network.
 */
export default function Loading() {
  return (
    <div className="h-full grid grid-cols-1 lg:grid-cols-3 gap-8 animate-pulse">
      {/* Esquelet de la llista de perfils */}
      <div className="lg:col-span-1 h-full bg-gray-800/50 rounded-lg p-4 space-y-4 overflow-y-hidden">
        {[...Array(5)].map((_, i) => (
          <div key={i} className="flex items-center gap-4">
            <div className="w-12 h-12 bg-gray-700/50 rounded-full shrink-0"></div>
            <div className="flex-1 space-y-2">
              <div className="h-4 w-3/4 bg-gray-700/50 rounded"></div>
              <div className="h-3 w-1/2 bg-gray-700/50 rounded"></div>
            </div>
          </div>
        ))}
      </div>
      {/* Esquelet del mapa */}
      <div className="lg:col-span-2 h-full bg-gray-800/50 rounded-lg"></div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/network/page.tsx ===================

/**
 * @file page.tsx (Network)
 * @summary Punto de entrada de la pÃ¡gina, implementando React Suspense.
 */

import { Suspense } from 'react';
import { NetworkData } from './_components/NetworkData';
import { NetworkSkeleton } from './_components/NetworkSkeleton';

// La revalidaciÃ³n cada hora es una buena prÃ¡ctica.
export const revalidate = 3600;

export default function NetworkPage() {
  return (
    <Suspense fallback={<NetworkSkeleton />}>
      <NetworkData />
    </Suspense>
  );
}

// =================== FILE: src/app/[locale]/(app)/network/schemas.ts ===================

// /app/[locale]/network/schemas.ts (FITXER NOU)
import { z } from "zod";

export const CreateJobPostingSchema = z.object({
  team_id: z.string().uuid("ID d'equip invÃ lid"),
  title: z.string().min(5, "El tÃ­tol ha de tenir almenys 5 carÃ cters"),
  description: z.string().optional().nullable(),
  latitude: z.number().optional().nullable(),
  longitude: z.number().optional().nullable(),
  address_text: z.string().optional().nullable(),
  city: z.string().optional().nullable(),
  region: z.string().optional().nullable(),
  postcode: z.string().optional().nullable(),
  country: z.string().optional().nullable(),
  required_skills: z.preprocess(
    (val) => (typeof val === 'string' ? val.split(',').map(s => s.trim()).filter(Boolean) : val),
    z.array(z.string()).optional()
  ),
  budget: z.coerce.number().optional().nullable(),
  expires_at: z.string().optional().nullable(),
});

// Tipus inferit per al formulari
export type CreateJobPostingData = z.infer<typeof CreateJobPostingSchema>;

// =================== FILE: src/app/[locale]/(app)/network/types.ts ===================

// /app/[locale]/network/types.ts

/**
 * Representa les dades MÃNIMES d'una empresa (team) que es mostren a la llista inicial.
 */
export type PublicProfileListItem = {
    id: string;
    name: string;
    sector: string | null;
    logo_url: string | null;
    latitude: number | null;
    longitude: number | null;
};

/**
 * Representa les dades COMPLETES d'una empresa, incloent el nom del propietari.
 * Aquestes dades es carreguen quan l'usuari fa clic.
 */
export type PublicProfileDetail = PublicProfileListItem & {
    summary: string | null;
    services: string[] | null;
    website: string | null;
    address: string | null;
    phone: string | null;
    email: string | null;
    owner: {
        full_name: string | null;
    } | null;
};

// --- NOVES ADDICIONS ---

/**
 * Representa les dades d'un projecte (job_posting) tal com es reben
 * del servidor, incloent la informaciÃ³ bÃ sica de l'equip que el publica.
 */
export type JobPostingListItem = {
    id: string;
    title: string;
    latitude: number | null;
    longitude: number | null;
    address_text: string | null;
    team_id: string;
    // Dades de l'equip obtingudes mitjanÃ§ant JOIN
    teams: {
        name: string | null;
        logo_url: string | null;
    } | null;
};

/**
 * Representa les dades completes d'un projecte quan es demanen
 * individualment (per exemple, en un Popup o Dialog).
 */
export type JobPostingDetail = JobPostingListItem & {
    created_at: string;
    description: string | null;
    required_skills: string[] | null;
    budget: number | null;
    expires_at: string | null;
};

// âœ… NOU TIPUS: Afegeix els detalls que falten per al popup
export interface PublicJobPostingDetail extends JobPostingListItem {
    description: string | null;
    required_skills: string[] | null;
    budget: number | null;
}

// =================== FILE: src/app/[locale]/(app)/network/_components/AddressAutocomplete.tsx ===================

"use client";

import React, { useState, useCallback, useEffect, ChangeEvent } from 'react';
import { useTranslations } from 'next-intl';
import { useDebounce } from 'use-debounce';
import { Input } from '@/components/ui/input';
import { Loader2, MapPin } from 'lucide-react';
import type { DetailedAddress } from '@/types/shared/index';

// Aquestes sÃ³n les props que rep de react-hook-form (via <FormField>)
interface AddressAutocompleteProps {
Â  value: string;
Â  onChange: (e: ChangeEvent<HTMLInputElement>) => void;
Â  onAddressSelect: (address: DetailedAddress) => void;
}

interface MapboxSuggestion {
Â  name: string;
Â  mapbox_id: string;
Â  full_address: string;
}

// AQUEST COMPONENT JA NO UTILITZA '@mapbox/search-js-react'
export default function AddressAutocomplete({ value, onChange, onAddressSelect }: AddressAutocompleteProps) {
Â  // Reutilitzem traduccions, ja que sÃ³n les mateixes
Â  const t = useTranslations('OnboardingPage.step2'); 
Â  
Â  // Necessitem un estat local per al text de l'input per al 'debounce'
Â  // El 'value' de les props (react-hook-form) no s'actualitza a temps
Â  const [localQuery, setLocalQuery] = useState(value);
Â  const [suggestions, setSuggestions] = useState<MapboxSuggestion[]>([]);
Â  const [isLoading, setIsLoading] = useState(false);
Â  const [debouncedQuery] = useDebounce(localQuery, 500);

Â  const fetchSuggestions = useCallback(async (searchTerm: string) => {
Â  Â  if (searchTerm.length < 3) {
Â  Â  Â  setSuggestions([]);
Â  Â  Â  return;
Â  Â  }
Â  Â  setIsLoading(true);
Â  Â  const accessToken = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;
Â  Â  // Utilitzem el mateix session_token per consistÃ¨ncia
Â  Â  const endpoint = `https://api.mapbox.com/search/searchbox/v1/suggest?q=${encodeURIComponent(searchTerm)}&language=ca,es&session_token=08a700a8-1423-4c99-800a-471238634710&access_token=${accessToken}`;
Â  Â  
Â  Â  try {
Â  Â  Â  const response = await fetch(endpoint);
Â  Â  Â  const data = await response.json();
Â  Â  Â  setSuggestions(data.suggestions || []);
Â  Â  } catch (error) {
Â  Â  Â  console.error(t('errorFetchingSuggestions'), error);
Â  Â  } finally {
Â  Â  Â  setIsLoading(false);
Â  Â  }
Â  }, [t]);

Â  useEffect(() => {
Â  Â  fetchSuggestions(debouncedQuery);
Â  }, [debouncedQuery, fetchSuggestions]);

Â  const handleSelectSuggestion = async (suggestion: MapboxSuggestion) => {
Â  Â  setIsLoading(true);
Â  Â  setLocalQuery(suggestion.name);
Â  Â  setSuggestions([]);

Â  Â  const accessToken = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;
Â  Â  const endpoint = `https://api.mapbox.com/search/searchbox/v1/retrieve/${suggestion.mapbox_id}?session_token=08a700a8-1423-4c99-800a-471238634710&access_token=${accessToken}`;
Â  Â  
Â  Â  try {
Â  Â  Â  Â  const response = await fetch(endpoint);
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  const feature = data.features[0];
Â  Â  Â  Â  if (!feature) return;

Â  Â  Â  Â  const context = feature.properties.context;
Â  Â  Â  Â  const street = feature.properties.address || '';
Â  Â  Â  Â  const city = context?.place?.name || '';
Â  Â  Â  Â  const postcode = context?.postcode?.name || '';
Â  Â  Â  Â  const region = context?.region?.name || '';
Â  Â  Â  Â  const country = context?.country?.name || '';
Â  Â  Â  Â  
Â  Â  Â  Â  const detailedAddress: DetailedAddress = {
Â  Â  Â  Â  Â  Â  street, 
Â  Â  Â  Â  Â  Â  city, 
Â  Â  Â  Â  Â  Â  postcode, 
Â  Â  Â  Â  Â  Â  region, 
Â  Â  Â  Â  Â  Â  country, 
Â  Â  Â  Â  Â  Â  latitude: feature.geometry.coordinates[1], 
Â  Â  Â  Â  Â  Â  longitude: feature.geometry.coordinates[0], 
Â  Â  Â  Â  };

Â  Â  Â  Â  // 1. Passem l'objecte sencer al 'Dialog' (que omplirÃ  tots els camps)
Â  Â  Â  Â  onAddressSelect(detailedAddress);
Â  Â  Â  Â  
Â  Â  Â  Â  // 2. Actualitzem el camp 'address_text' de react-hook-form amb el carrer
Â  Â  Â  Â  // Simulem un 'event' perquÃ¨ 'onChange' de react-hook-form funcioni
Â  Â  Â  Â  onChange({ target: { value: street } } as ChangeEvent<HTMLInputElement>);
Â  Â  Â  Â  setLocalQuery(street); // Sincronitzem l'estat local

Â  Â  } catch (error) {
Â  Â  Â  Â  console.error(t('errorRetrievingAddress'), error);
Â  Â  } finally {
Â  Â  Â  Â  setIsLoading(false);
Â  Â  }
Â  };

Â  // Aquesta funciÃ³ actualitza l'estat local (per al debounce)
Â  // i el de react-hook-form (via 'onChange' de les props)
Â  const handleInputChange = (e: ChangeEvent<HTMLInputElement>) => {
Â  Â  onChange(e); // Actualitza RHF
Â  Â  setLocalQuery(e.target.value); // Actualitza l'estat local per al 'debounce'
Â  };

Â  // Sincronitzem l'estat local si el formulari es reseteja
Â  useEffect(() => {
Â  Â  setLocalQuery(value);
Â  }, [value]);

Â  return (
Â  Â  <div className="relative">
Â  Â  Â  <div className="relative">
Â  Â  Â  Â  <MapPin className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" />
Â  Â  Â  Â  <Input
Â  Â  Â  Â  Â  placeholder={t('addressPlaceholder')}
Â  Â  Â  Â  Â  value={localQuery} // L'input mostra l'estat local per a rapidesa
Â  Â  Â  Â  Â  onChange={handleInputChange}
Â  Â  Â  Â  Â  className="pl-10"
Â  Â  Â  Â  Â  autoComplete="off" // Desactivem l'autocompletat natiu
Â  Â  Â  Â  />
Â  Â  Â  Â  {isLoading && <Loader2 className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 animate-spin" />}
Â  Â  Â  </div>

Â  Â  Â  {/* Aquesta llista <ul> es renderitza dins del Dialog, evitant conflictes de z-index */}
Â  Â  Â  {suggestions.length > 0 && (
Â  Â  Â  Â  <ul className="absolute z-50 w-full mt-2 bg-card border rounded-md shadow-lg max-h-60 overflow-y-auto">
Â  Â  Â  Â  Â  {suggestions.map((s) => (
Â  Â  Â  Â  Â  Â  <li 
Â  Â  Â  Â  Â  Â  Â  key={s.mapbox_id}
Â  Â  Â  Â  Â  Â  Â  onClick={() => handleSelectSuggestion(s)}
Â  Â  Â  Â  Â  Â  Â  className="px-4 py-2 hover:bg-muted cursor-pointer"
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  <p className="font-semibold">{s.name}</p>
Â  Â  Â  Â  Â  Â  Â  <p className="text-sm text-muted-foreground">{s.full_address}</p>
Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  ))}
Â  Â  Â  Â  </ul>
Â  Â  Â  )}
Â  Â  </div>
Â  );
}

// =================== FILE: src/app/[locale]/(app)/network/_components/CreateProjectDialog.tsx ===================

"use client";

import { useTransition } from 'react';
import { useRouter } from 'next/navigation';
// âœ… 1. JA NO NECESSITEM 'dynamic' ni 'Skeleton'
import {
    Dialog,
    DialogContent,
    DialogHeader,
    DialogTitle,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import {
    Form,
    FormControl,
    FormField,
    FormItem,
    FormLabel,
    FormMessage,
} from "@/components/ui/form";
import { useForm} from "react-hook-form";
import { z } from "zod";
import { zodResolver } from "@hookform/resolvers/zod";
import { Loader2 } from "lucide-react";
import type { DetailedAddress } from '@/types/shared/index';
import { createJobPostingAction } from '../actions';
import { toast } from 'sonner';
// âœ… 2. Importem el nou component directament
import AddressAutocomplete from './AddressAutocomplete';

// Esquema de validaciÃ³ amb Zod (local)
const projectFormSchema = z.object({
    title: z.string().min(5, "El tÃ­tol ha de tenir almenys 5 carÃ cters"),
    description: z.string().optional(),
    address_text: z.string().min(5, "L'adreÃ§a Ã©s obligatÃ²ria"),
    latitude: z.number().nullable(),
    longitude: z.number().nullable(),
    city: z.string().optional().nullable(),
    region: z.string().optional().nullable(),
    postcode: z.string().optional().nullable(),
    country: z.string().optional().nullable(),
    required_skills: z.string().optional(),
    budget: z.number().nullable().optional(),
});
type ProjectFormValues = z.infer<typeof projectFormSchema>;

interface CreateProjectDialogProps {
    open: boolean;
    onOpenChange: (open: boolean) => void;
    teamId: string;
}

export default function CreateProjectDialog({ open, onOpenChange, teamId }: CreateProjectDialogProps) {
    const router = useRouter();
    const [isPending, startTransition] = useTransition();

    const form = useForm<ProjectFormValues>({
        resolver: zodResolver(projectFormSchema),
        defaultValues: {
            title: '',
            description: '',
            address_text: '',
            latitude: null,
            longitude: null,
            city: '',
            region: '',
            postcode: '',
            country: '',
            required_skills: '',
            budget: null,
        },
    });

    const handleAddressSelect = (address: DetailedAddress) => {
        form.setValue('address_text', address.street, { shouldValidate: true });
        form.setValue('latitude', address.latitude);
        form.setValue('longitude', address.longitude);
        form.setValue('city', address.city || '');
        form.setValue('region', address.region || '');
        form.setValue('postcode', address.postcode || '');
        form.setValue('country', address.country || '');
    };

    const onSubmit = (values: ProjectFormValues) => {
        if (!values.latitude || !values.longitude) {
            toast.error("AdreÃ§a invÃ lida", { description: "Si us plau, selecciona una adreÃ§a vÃ lida del cercador." });
            return;
        }

        startTransition(async () => {
            const formData = new FormData();
            formData.append('team_id', teamId);
            formData.append('title', values.title);
            formData.append('description', values.description || '');
            formData.append('address_text', values.address_text);
            formData.append('latitude', values.latitude!.toString());
            formData.append('longitude', values.longitude!.toString());
            if (values.city) formData.append('city', values.city);
            if (values.region) formData.append('region', values.region);
            if (values.postcode) formData.append('postcode', values.postcode);
            if (values.country) formData.append('country', values.country);
            if (values.required_skills) formData.append('required_skills', values.required_skills);
            if (values.budget) formData.append('budget', values.budget.toString());

            const result = await createJobPostingAction(formData);

            if (result.success) {
                toast.success('Projecte publicat correctament!');
                onOpenChange(false);
                form.reset();
                router.refresh();
            } else {
                toast.error('Error al publicar el projecte', { description: result.message });
            }
        });
    };

    return (
        <Dialog open={open} onOpenChange={onOpenChange}>
            <DialogContent className="sm:max-w-lg">
                <DialogHeader>
                    <DialogTitle>Crear un nou projecte</DialogTitle>
                </DialogHeader>

                <Form {...form}>
                    <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
                        <FormField
                            control={form.control}
                            name="title"
                            render={({ field }) => (
                                <FormItem>
                                    <FormLabel>TÃ­tol</FormLabel>
                                    <FormControl>
                                        <Input placeholder="Nom del projecte" {...field} />
                                    </FormControl>
                                    <FormMessage />
                                </FormItem>
                            )}
                        />

                        <FormField
                            control={form.control}
                            name="description"
                            render={({ field }) => (
                                <FormItem>
                                    <FormLabel>DescripciÃ³</FormLabel>
                                    <FormControl>
                                        <Textarea
                                            placeholder="DescripciÃ³ del projecte"
                                            {...field}
                                        />
                                    </FormControl>
                                    <FormMessage />
                                </FormItem>
                            )}
                        />

                        <FormField
                            control={form.control}
                            name="address_text"
                            render={({ field }) => (
                                <FormItem>
                                    <FormLabel>Carrer (amb cercador)</FormLabel>
                                    <FormControl>
                                        <AddressAutocomplete
                                            value={field.value}
                                            onChange={field.onChange}
                                            onAddressSelect={handleAddressSelect}
                                        />
                                    </FormControl>
                                    <FormMessage />
                                </FormItem>
                            )}
                        />

                        <div className="grid grid-cols-2 gap-4">
                            <FormField
                                control={form.control}
                                name="city"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>PoblaciÃ³</FormLabel>
                                        <FormControl>
                                            <Input placeholder="PoblaciÃ³" {...field} value={field.value ?? ''} />
                                        </FormControl>
                                    </FormItem>
                                )}
                            />
                            <FormField
                                control={form.control}
                                name="postcode"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Codi Postal</FormLabel>
                                        <FormControl>
                                            <Input placeholder="Codi Postal" {...field} value={field.value ?? ''} />
                                        </FormControl>
                                    </FormItem>
                                )}
                            />
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <FormField
                                control={form.control}
                                name="region"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>ProvÃ­ncia</FormLabel>
                                        <FormControl>
                                            <Input placeholder="ProvÃ­ncia" {...field} value={field.value ?? ''} />
                                        </FormControl>
                                    </FormItem>
                                )}
                            />
                            <FormField
                                control={form.control}
                                name="country"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>PaÃ­s</FormLabel>
                                        <FormControl>
                                            <Input placeholder="PaÃ­s" {...field} value={field.value ?? ''} />
                                        </FormControl>
                                    </FormItem>
                                )}
                            />
                        </div>

                        <FormField
                            control={form.control}
                            name="required_skills"
                            render={({ field }) => (
                                <FormItem>
                                    <FormLabel>Habilitats necessÃ ries</FormLabel>
                                    {/* âœ… CORRECCIÃ“: Eliminats carÃ cters 'nbsp;' i 'F' */}
                                    <FormControl>
                                        <Input placeholder="Ex: Fusteria, Electricitat..." {...field} />
                                    </FormControl>
                                    <FormMessage />
                                {/* âœ… CORRECCIÃ“: Afegit </FormItem> que faltava */}
                                </FormItem>
                                // âœ… Codi corrupte eliminat
                            )}
                        />

                        <FormField
                            control={form.control}
                            name="budget"
                            render={({ field }) => (
                                <FormItem>
                                    <FormLabel>Pressupost (â‚¬)</FormLabel>
                                    <FormControl>
                                        <Input
                                            type="number"
                                            placeholder="Opcional"
                                            {...field}
                                            value={field.value ?? ""}
                                            onChange={(e) =>
                                                field.onChange(
                                                    e.target.value === ""
                                                        ? null
                                                        : Number(e.target.value)
                                                )
                                            }
                                        />
                                    </FormControl>
                                    <FormMessage /> 
                                </FormItem>
                            )}
                        />

                        <div className="flex justify-end pt-4">
                            <Button type="submit" disabled={isPending}>
                                {isPending && (
                                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                )}
                                Crear Projecte
                            </Button>
                        </div>
                    </form>
                </Form>
            </DialogContent>
        </Dialog>
    );
}

// =================== FILE: src/app/[locale]/(app)/network/_components/MapContainer.tsx ===================

// /app/[locale]/network/_components/MapContainer.tsx
"use client";

import 'mapbox-gl/dist/mapbox-gl.css';
import { useRef, useEffect } from 'react';
import Map, { Marker, Popup, NavigationControl, MapRef } from 'react-map-gl';
import type { PublicProfileListItem, PublicProfileDetail, JobPostingListItem, PublicJobPostingDetail } from '../types';
import { Building2, Globe, Briefcase, Loader2, Mail, Phone, MapPin, DollarSign, Wrench } from 'lucide-react';
import Image from 'next/image';
import { useTranslations } from 'next-intl';

interface MapContainerProps {
    profiles: PublicProfileListItem[];
    jobPostings: JobPostingListItem[];
    displayMode: 'all' | 'profiles' | 'projects';
    
    selectedProfile: PublicProfileListItem | null;
    detailedProfile: PublicProfileDetail | null;
    isLoading: boolean;
    onSelectProfile: (profile: PublicProfileListItem | null) => void;
    
    selectedProject: JobPostingListItem | null;
    detailedProject: PublicJobPostingDetail | null;
    isProjectLoading: boolean;
    onSelectProject: (project: JobPostingListItem | null) => void;
}

// âœ… 1. Aquesta funciÃ³ ara SÃ s'utilitza
const formatWebsiteUrl = (url: string | null | undefined): string => {
    if (!url) return '';
    if (url.startsWith('http://') || url.startsWith('https://')) {
        return url;
    }
    return `https://${url}`;
};

export default function MapContainer({ 
    profiles, 
    jobPostings, 
    displayMode,
    selectedProfile, 
    detailedProfile, 
    isLoading,
    onSelectProfile,
    selectedProject,
    detailedProject,
    isProjectLoading,
    onSelectProject
}: MapContainerProps) {
    const mapRef = useRef<MapRef>(null);
    const t = useTranslations('NetworkPage');
    const mapboxToken = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;

    // ... (Efectes i handleDragStart sense canvis) ...
    useEffect(() => {
        if (selectedProfile && selectedProfile.latitude != null && selectedProfile.longitude != null && mapRef.current) {
            mapRef.current.flyTo({ center: [selectedProfile.longitude, selectedProfile.latitude], zoom: 14, duration: 1500 });
        }
    }, [selectedProfile]);

    useEffect(() => {
        if (selectedProject && selectedProject.latitude != null && selectedProject.longitude != null && mapRef.current) {
            mapRef.current.flyTo({ center: [selectedProject.longitude, selectedProject.latitude], zoom: 14, duration: 1500 });
        }
    }, [selectedProject]);

    const handleDragStart = () => {
        onSelectProfile(null);
        onSelectProject(null);
    };

    if (!mapboxToken) {
        return <div className="w-full h-full flex items-center justify-center bg-gray-800 text-red-400 p-4">{t('mapboxError')}</div>;
    }

    return (
        <Map 
            ref={mapRef} 
            initialViewState={{ longitude: 2.1734, latitude: 41.3851, zoom: 7 }} 
            style={{ width: '100%', height: '100%' }} 
            mapStyle="mapbox://styles/mapbox/dark-v11" 
            mapboxAccessToken={mapboxToken} 
            onDragStart={handleDragStart}
        >
            <NavigationControl position="top-right" />
            
            {/* ... (Marcadors de perfil i projecte sense canvis) ... */}
            {(displayMode === 'all' || displayMode === 'profiles') && profiles.filter(p => p.latitude != null && p.longitude != null).map((profile) => (
                <Marker 
                    key={`profile-${profile.id}`} 
                    longitude={profile.longitude!} 
                    latitude={profile.latitude!} 
                    onClick={(e) => { 
                        e.originalEvent.stopPropagation(); 
                        onSelectProfile(profile);
                    }}
                >
                    <div className="transform transition-transform duration-200 hover:scale-125">
                        {profile.logo_url 
                            ? <Image src={profile.logo_url} alt={t('logoAltText', { companyName: profile.name })} width={32} height={32} className="rounded-full border-2 border-purple-500 object-cover" /> 
                            : <div className="w-8 h-8 rounded-full bg-gray-800 border-2 border-purple-500 flex items-center justify-center"><Building2 className="w-4 h-4 text-purple-300" /></div>
                        }
                    </div>
                </Marker>
            ))}
            {(displayMode === 'all' || displayMode === 'projects') && jobPostings.filter(p => p.latitude != null && p.longitude != null).map((project) => (
                <Marker 
                    key={`job-${project.id}`} 
                    longitude={project.longitude!} 
                    latitude={project.latitude!} 
                    onClick={(e) => { 
                        e.originalEvent.stopPropagation(); 
                        onSelectProject(project);
                    }}
                >
                    <div className="transform transition-transform duration-200 hover:scale-125">
                        <div className="w-8 h-8 rounded-full bg-gray-800 border-2 border-orange-500 flex items-center justify-center">
                            <Briefcase className="w-4 h-4 text-orange-300" />
                        </div>
                    </div>
                </Marker>
            ))}
            
            {/* âœ… 2. Popup de Perfil (CODI RESTAURAT) */}
            {selectedProfile && selectedProfile.latitude != null && selectedProfile.longitude != null && (
                <Popup 
                    longitude={selectedProfile.longitude} 
                    latitude={selectedProfile.latitude} 
                    onClose={() => onSelectProfile(null)}
                    closeOnClick={false} 
                    anchor="bottom" 
                    className="popup-dark"
                >
                    {isLoading && <div className="p-4 flex justify-center"><Loader2 className="animate-spin text-white" /></div>}
                    {detailedProfile && !isLoading && (
                        <div className="max-w-xs p-1 text-white space-y-2">
                            <div className="flex items-center gap-3">
                                {detailedProfile.logo_url 
                                    ? <Image src={detailedProfile.logo_url} alt={`Logo de ${detailedProfile.name}`} width={40} height={40} className="rounded-full object-cover bg-gray-700" /> 
                                    : <div className="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center flex-shrink-0"><Building2 className="w-5 h-5 text-gray-400" /></div>
                                }
                                <div>
                                    <h3 className="font-bold">{detailedProfile.name}</h3>
                                    {detailedProfile.owner?.full_name && <p className="text-xs text-gray-400">de {detailedProfile.owner.full_name}</p>}
                                </div>
                            </div>

                            {detailedProfile.summary && <p className="text-sm text-gray-300">{detailedProfile.summary}</p>}
                            
                            <div className="text-xs space-y-1 pt-2 border-t border-gray-700">
                                {detailedProfile.phone && (
                                    <a href={`tel:${detailedProfile.phone}`} className="flex items-center gap-2 text-gray-300 hover:text-white">
                                        <Phone className="w-3 h-3" /> {detailedProfile.phone}
                                    </a>
                                )}
                                {detailedProfile.email && (
                                    <a href={`mailto:${detailedProfile.email}`} className="flex items-center gap-2 text-gray-300 hover:text-white">
                                        <Mail className="w-3 h-3" /> {detailedProfile.email}
                                    </a>
                                )}
                                {detailedProfile.website && (
                                    <a href={formatWebsiteUrl(detailedProfile.website)} target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 text-purple-400 hover:underline">
                                        <Globe className="w-3 h-3" /> Visitar web
                                    </a>
                                )}
                            </div>

                            {detailedProfile.services && detailedProfile.services.length > 0 && (
                                <div className="pt-2 border-t border-gray-700">
                                    <h4 className="text-xs font-semibold uppercase text-gray-500 mb-1 flex items-center gap-2"><Briefcase className="w-3 h-3"/> Serveis</h4>
                                    <div className="flex flex-wrap gap-1">
                                        {detailedProfile.services.map((s) => (<span key={s} className="bg-gray-700 text-xs px-2 py-1 rounded-full">{s}</span>))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </Popup>
            )}

            {/* ... (Popup de Projecte (sense canvis) ... */}
            {selectedProject && selectedProject.latitude != null && selectedProject.longitude != null && (
                <Popup 
                    longitude={selectedProject.longitude} 
                    latitude={selectedProject.latitude} 
                    onClose={() => onSelectProject(null)}
                    closeOnClick={false} 
                    anchor="bottom" 
                    className="popup-dark"
                >
                    {isProjectLoading && (
                        <div className="p-4 flex justify-center"><Loader2 className="animate-spin text-white" /></div>
                    )}
                    {detailedProject && !isProjectLoading && (
                        <div className="max-w-xs p-1 text-white space-y-3">
                            <div className="flex items-center gap-3">
                                {detailedProject.teams?.logo_url 
                                    ? <Image src={detailedProject.teams.logo_url} alt={`Logo de ${detailedProject.teams.name}`} width={40} height={40} className="rounded-full object-cover bg-gray-700" /> 
                                    : <div className="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center flex-shrink-0"><Briefcase className="w-5 h-5 text-gray-400" /></div>
                                }
                                <div>
                                    <h3 className="font-bold">{detailedProject.title}</h3>
                                    {detailedProject.teams?.name && <p className="text-xs text-gray-400">Publicat per {detailedProject.teams.name}</p>}
                                </div>
                            </div>
                            {detailedProject.description && (
                                <p className="text-sm text-gray-300 max-h-24 overflow-y-auto">{detailedProject.description}</p>
                            )}
                            <div className="text-xs space-y-1 pt-2 border-t border-gray-700">
                                {detailedProject.address_text && (
                                    <p className="flex items-center gap-2 text-gray-300">
                                        <MapPin className="w-3 h-3 flex-shrink-0" /> {detailedProject.address_text}
                                    </p>
                                )}
                                {detailedProject.budget != null && (
                                    <p className="flex items-center gap-2 text-gray-300">
                                        <DollarSign className="w-3 h-3 flex-shrink-0" /> {detailedProject.budget.toLocaleString('ca-ES')} â‚¬
                                    </p>
                                )}
                            </div>
                            {detailedProject.required_skills && detailedProject.required_skills.length > 0 && (
                                <div className="pt-2 border-t border-gray-700">
                                    <h4 className="text-xs font-semibold uppercase text-gray-500 mb-1 flex items-center gap-2"><Wrench className="w-3 h-3"/> Habilitats</h4>
                                    <div className="flex flex-wrap gap-1">
                                        {detailedProject.required_skills.map((s) => (<span key={s} className="bg-gray-700 text-xs px-2 py-1 rounded-full">{s}</span>))}
                                    </div>
                                </div>
                            )}
                            <div className="pt-2 border-t border-gray-700">
                                <a 
                                    href={`/comunicacio/inbox?to=${detailedProject.team_id}&projectId=${detailedProject.id}`}
                                    className="text-sm text-purple-400 hover:underline"
                                >
                                    Contactar
                                </a>
                            </div>
                        </div>
                    )}
                </Popup>
            )}

        </Map>
    );
}

// =================== FILE: src/app/[locale]/(app)/network/_components/NetworkClient.tsx ===================

"use client";

import React, { useState, useMemo, useTransition } from 'react';
import dynamic from 'next/dynamic';
import { motion, AnimatePresence } from 'framer-motion';
import ProfileList from './profiles/ProfileList';
import ProjectList from './projects/ProjecteList';
// âœ… 1. Importem els nous tipus
import type { PublicProfileListItem, PublicProfileDetail, JobPostingListItem, PublicJobPostingDetail } from '../types';
import { useTranslations } from 'next-intl';
import { List, Map as MapIcon, Building2, Briefcase, PlusCircle, Search, Users } from 'lucide-react';
import { cn } from '@/lib/utils/utils';
import { Button } from '@/components/ui/button';
// âœ… 2. Importem la nova acciÃ³
import { getTeamDetailsAction, getJobPostingDetailsAction } from '../actions';
import { toast } from 'sonner';
import CreateProjectDialog from './CreateProjectDialog'; 
import { useNavigationStore } from '@/stores/navigationStore';

const MapLoadingSkeleton = () => {
    const t = useTranslations('NetworkPage');
    return <div className="w-full h-full bg-muted flex items-center justify-center"><p className="text-muted-foreground">{t('loadingMap')}</p></div>;
};

const DynamicMapContainer = dynamic(() => import('./MapContainer'), { loading: () => <MapLoadingSkeleton />, ssr: false });

const MOBILE_HEADER_HEIGHT_PX = 64;

type DisplayMode = 'all' | 'profiles' | 'projects';

export function NetworkClient({
    profiles,
    jobPostings,
    errorMessage
}: {
    profiles: PublicProfileListItem[];
    jobPostings: JobPostingListItem[];
    errorMessage?: string;
}) {
    // Estats de perfil
    const [selectedProfile, setSelectedProfile] = useState<PublicProfileListItem | null>(null);
    const [detailedProfile, setDetailedProfile] = useState<PublicProfileDetail | null>(null);
    const [isDetailsLoading, startDetailsTransition] = useTransition();
    
    // âœ… 3. Afegim estats per als detalls del projecte
    const [selectedProject, setSelectedProject] = useState<JobPostingListItem | null>(null);
    const [detailedProject, setDetailedProject] = useState<PublicJobPostingDetail | null>(null);
    const [isProjectDetailsLoading, startProjectDetailsTransition] = useTransition();

    const [searchTerm, setSearchTerm] = useState('');
    const [viewMode, setViewMode] = useState<'list' | 'map'>('list');
    const [displayMode, setDisplayMode] = useState<DisplayMode>('all');
    
    const t = useTranslations('NetworkPage');
    const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);
    const { activeTeam } = useNavigationStore();

    const filteredProfiles = useMemo(() => {
        if (!searchTerm) return profiles;
        return profiles.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
    }, [profiles, searchTerm]);

    const filteredJobPostings = useMemo(() => {
        if (!searchTerm) return jobPostings;
        return jobPostings.filter(j =>
            j.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
            j.teams?.name?.toLowerCase().includes(searchTerm.toLowerCase())
        );
    }, [jobPostings, searchTerm]);

    // Gestor de selecciÃ³ de Perfil (sense canvis)
    const handleSelectProfile = (profile: PublicProfileListItem | null) => {
        setSelectedProject(null);
        setDetailedProject(null);
        setSelectedProfile(profile);
        setDetailedProfile(null);
        if (profile) {
            startDetailsTransition(async () => {
                const result = await getTeamDetailsAction(profile.id);
                if (result.success) {
                    setDetailedProfile(result.data as PublicProfileDetail);
                    setViewMode('map');
                    setDisplayMode('profiles'); 
                } else {
                    toast.error("Error en carregar els detalls", { description: result.message });
                    setSelectedProfile(null);
                }
            });
        }
    };

    // âœ… 4. Actualitzem el gestor de selecciÃ³ de Projecte
    const handleSelectProject = (project: JobPostingListItem | null) => {
        setSelectedProfile(null);
        setDetailedProfile(null);
        setSelectedProject(project);
        setDetailedProject(null); // Reseteja el detall
        if (project) {
            setViewMode('map');
            setDisplayMode('projects');
            // Iniciem la transiciÃ³ per carregar els detalls del projecte
            startProjectDetailsTransition(async () => {
                const result = await getJobPostingDetailsAction(project.id);
                if (result.success) {
                    setDetailedProject(result.data as PublicJobPostingDetail);
                } else {
                    toast.error("Error en carregar detalls del projecte", { description: result.message });
                    setSelectedProject(null); // Deseleccionem si falla
                }
            });
        }
    };

    const handleMapDeselect = () => {
        setSelectedProfile(null);
        setDetailedProfile(null);
        setSelectedProject(null);
        setDetailedProject(null); // Reseteja el detall
    }

    const handleChangeDisplayMode = (mode: DisplayMode) => {
        setSearchTerm('');
        handleMapDeselect();
        setDisplayMode(mode);
    }

    if (errorMessage) {
        return <div className="p-8 text-destructive text-center">{errorMessage}</div>;
    }

    return (
        <div className="h-full w-full flex flex-col bg-background overflow-hidden">
            {/* ... CapÃ§alera mÃ²bil (sense canvis) ... */}
            <div
                className="p-2 border-b bg-background/95 backdrop-blur-sm lg:hidden flex-shrink-0"
                style={{ height: `${MOBILE_HEADER_HEIGHT_PX}px` }}
            >
                <div className="flex w-full bg-muted p-1 rounded-md h-full">
                    <Button variant={viewMode === 'list' ? 'secondary' : 'ghost'} className="flex-1 h-full" onClick={() => setViewMode('list')}>
                        <List className="mr-2 h-5 w-5" /> {t('listView')}
                    </Button>
                    <Button variant={viewMode === 'map' ? 'secondary' : 'ghost'} className="flex-1 h-full" onClick={() => setViewMode('map')}>
                        <MapIcon className="mr-2 h-5 w-5" /> {t('mapView')}
                    </Button>
                </div>
            </div>

            <div className="flex-1 relative overflow-hidden min-h-0 p-4 sm:p-6 md:p-8 lg:p-4 lg:grid lg:grid-cols-3 lg:gap-8">
                {/* --- LAYOUT DESKTOP (lg:) --- */}
                <div className="hidden lg:flex lg:flex-col glass-effect rounded-lg overflow-hidden">
                    {/* ... Filtres de llista i cerca (sense canvis) ... */}
                    <div className="p-4 border-b border-border flex-shrink-0">
                        <div className="flex w-full bg-muted p-1 rounded-md mb-4">
                            <Button variant={displayMode === 'all' ? 'secondary' : 'ghost'} className="flex-1" onClick={() => handleChangeDisplayMode('all')}>
                                <Users className="mr-2 h-5 w-5" /> Tots
                            </Button>
                            <Button variant={displayMode === 'profiles' ? 'secondary' : 'ghost'} className="flex-1" onClick={() => handleChangeDisplayMode('profiles')}>
                                <Building2 className="mr-2 h-5 w-5" /> Professionals
                            </Button>
                            <Button variant={displayMode === 'projects' ? 'secondary' : 'ghost'} className="flex-1" onClick={() => handleChangeDisplayMode('projects')}>
                                <Briefcase className="mr-2 h-5 w-5" /> Projectes
                            </Button>
                        </div>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold">
                                {displayMode === 'projects' ? "Projectes Oberts" : t('networkTitle')}
                            </h2>
                            {displayMode === 'projects' && activeTeam && (
                                <Button size="sm" onClick={() => setIsCreateDialogOpen(true)}>
                                    <PlusCircle className="mr-2 h-4 w-4" />
                                    Publicar
                                </Button>
                            )}
                        </div>
                        <div className="relative">
                            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" />
                            <input
                                type="text"
                                placeholder={displayMode === 'projects' ? "Cercar projectes..." : t('searchPlaceholder')}
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="w-full bg-background border border-border rounded-md pl-10 pr-4 py-2 focus:ring-2 focus:ring-primary focus:outline-none"
                            />
                        </div>
                    </div>
                    
                    {/* ... LÃ²gica de llista (sense canvis) ... */}
                    {displayMode === 'projects' ? (
                        <ProjectList
                            projects={filteredJobPostings}
                            onSelectProject={handleSelectProject}
                            selectedProjectId={selectedProject?.id}
                            className="flex-1"
                        />
                    ) : (
                        <ProfileList
                            profiles={filteredProfiles}
                            searchTerm={searchTerm}
                            onSearchChange={setSearchTerm}
                            onSelectProfile={handleSelectProfile}
                            selectedProfileId={selectedProfile?.id}
                            className="flex-1"
                        />
                    )}
                </div>

                {/* --- MAPA DESKTOP --- */}
                {/* âœ… 5. Passem les noves props del projecte al mapa */}
                <div className="hidden lg:block lg:col-span-2 rounded-lg overflow-hidden">
                    <DynamicMapContainer
                        profiles={filteredProfiles}
                        jobPostings={filteredJobPostings}
                        displayMode={displayMode}
                        selectedProfile={selectedProfile}
                        detailedProfile={detailedProfile}
                        isLoading={isDetailsLoading}
                        selectedProject={selectedProject}
                        detailedProject={detailedProject} // <-- NOU
                        isProjectLoading={isProjectDetailsLoading} // <-- NOU
                        onSelectProfile={handleSelectProfile}
                        onSelectProject={handleSelectProject}
                    />
                </div>

                {/* --- LAYOUT MÃ’BIL (default) --- */}
                {/* âœ… 6. Passem les noves props del projecte al mapa (mÃ²bil) */}
                <div className="absolute inset-0 h-full w-full lg:hidden">
                    <DynamicMapContainer
                        profiles={filteredProfiles}
                        jobPostings={filteredJobPostings}
                        displayMode={displayMode}
                        selectedProfile={selectedProfile}
                        detailedProfile={detailedProfile}
                        isLoading={isDetailsLoading}
                        selectedProject={selectedProject}
                        detailedProject={detailedProject} // <-- NOU
                        isProjectLoading={isProjectDetailsLoading} // <-- NOU
                        onSelectProfile={handleSelectProfile}
                        onSelectProject={handleSelectProject}
                    />
                </div>

                {/* ... Llista MÃ²bil (Panell animat) (sense canvis) ... */}
                <AnimatePresence>
                    {viewMode === 'list' && (
                        <motion.div
                            key="panel-mobile"
                            className={cn(
                                "absolute inset-0 z-10 bg-background shadow-lg",
                                "lg:hidden",
                                "flex flex-col"
                            )}
                            initial={{ y: "100%" }}
                            animate={{ y: 0 }}
                            exit={{ y: "100%" }}
                            transition={{ type: "tween", ease: "easeInOut", duration: 0.3 }}
                        >
                            <div className="p-4 border-b border-border flex-shrink-0">
                                <div className="flex w-full bg-muted p-1 rounded-md mb-4">
                                    <Button variant={displayMode === 'all' ? 'secondary' : 'ghost'} className="flex-1" onClick={() => handleChangeDisplayMode('all')}>
                                        <Users className="mr-2 h-5 w-5" /> Tots
                                    </Button>
                                    <Button variant={displayMode === 'profiles' ? 'secondary' : 'ghost'} className="flex-1" onClick={() => handleChangeDisplayMode('profiles')}>
                                        <Building2 className="mr-2 h-5 w-5" /> Professionals
                                    </Button>
                                    <Button variant={displayMode === 'projects' ? 'secondary' : 'ghost'} className="flex-1" onClick={() => handleChangeDisplayMode('projects')}>
                                        <Briefcase className="mr-2 h-5 w-5" /> Projectes
                                    </Button>
                                </div>
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-xl font-bold">
                                        {displayMode === 'projects' ? "Projectes Oberts" : t('networkTitle')}
                                    </h2>
                                    {displayMode === 'projects' && activeTeam && (
                                        <Button size="sm" onClick={() => setIsCreateDialogOpen(true)}>
                                            <PlusCircle className="mr-2 h-4 w-4" />
                                            Publicar
                                        </Button>
                                    )}
                                </div>
                                <div className="relative">
                                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" />
                                    <input
                                        type="text"
                                        placeholder={displayMode === 'projects' ? "Cercar projectes..." : t('searchPlaceholder')}
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                        className="w-full bg-background border border-border rounded-md pl-10 pr-4 py-2 focus:ring-2 focus:ring-primary focus:outline-none"
                                    />
                                </div>
                            </div>

                            {displayMode === 'projects' ? (
                                <ProjectList
                                    projects={filteredJobPostings}
                                    onSelectProject={handleSelectProject}
                                    selectedProjectId={selectedProject?.id}
                                    className="flex-1"
                                />
                            ) : (
                                <ProfileList
                                    profiles={filteredProfiles}
                                    searchTerm={searchTerm}
                                    onSearchChange={setSearchTerm}
                                    onSelectProfile={handleSelectProfile}
                                    selectedProfileId={selectedProfile?.id}
                                    className="flex-1"
                                />
                            )}
                        </motion.div>
                    )}
                </AnimatePresence>
                
                {activeTeam && (
                    <CreateProjectDialog
                        open={isCreateDialogOpen}
                        onOpenChange={setIsCreateDialogOpen}
                        teamId={activeTeam.id}
                    />
                )}
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/network/_components/NetworkData.tsx ===================

// /app/[locale]/network/_components/NetworkData.tsx

import { createClient } from '@/lib/supabase/server';
import { NetworkClient } from './NetworkClient';
import { getTranslations } from 'next-intl/server';
import type { PublicProfileListItem, JobPostingListItem } from '../types'; // Importem el nou tipus

/**
 * ObtÃ© les dades dels perfils (equips) de la BDD.
 */
async function getProfiles(supabase: ReturnType<typeof createClient>) {
    const { data, error } = await supabase
        .from('teams')
        .select(`
            id,
            name,
            sector,
            logo_url,
            latitude,
            longitude
        `); // Afegeix .eq('is_public', true) si tens aquesta columna

    if (error) {
        console.error('Error al carregar la llista de perfils:', error.message);
        throw new Error('Error al carregar perfils');
    }
    return (data as PublicProfileListItem[]) || [];
}

/**
 * ObtÃ© les dades dels projectes (job_postings) oberts.
 * Aquesta funciÃ³ fa un JOIN amb la taula 'teams' per agafar el nom i el logo.
 */
async function getJobPostings(supabase: ReturnType<typeof createClient>) {
    // La polÃ­tica RLS de SELECT s'aplica automÃ ticament aquÃ­.
    // NomÃ©s retornarÃ  els 'job_postings' amb status = 'open'.
    const { data, error } = await supabase
        .from('job_postings')
        .select(`
            id,
            title,
            latitude,
            longitude,
            address_text,
            team_id,
            teams ( name, logo_url )
        `)
        .eq('status', 'open'); // Doble seguretat (encara que RLS ja ho fa)

    if (error) {
        console.error('Error al carregar la llista de projectes:', error.message);
        throw new Error('Error al carregar projectes');
    }
    return (data as JobPostingListItem[]) || [];
}


export async function NetworkData() {
    const t = await getTranslations('NetworkPage');
    const supabase = createClient();

    try {
        // Carreguem les dues fonts de dades en paralÂ·lel
        const [profiles, jobPostings] = await Promise.all([
            getProfiles(supabase),
            getJobPostings(supabase)
        ]);

        return <NetworkClient profiles={profiles} jobPostings={jobPostings} />;

    } catch (error) {
        console.error('Error a NetworkData:', (error as Error).message);
        return <NetworkClient profiles={[]} jobPostings={[]} errorMessage={t('errorLoading')} />;
    }
}

// =================== FILE: src/app/[locale]/(app)/network/_components/NetworkSkeleton.tsx ===================

/**
 * @file NetworkSkeleton.tsx
 * @summary Muestra un esqueleto de carga para la pÃ¡gina de Network.
 */
"use client";

import React from 'react';
import { Skeleton } from '@/components/ui/skeleton';

export const NetworkSkeleton: React.FC = () => (
  <div className="h-full grid grid-cols-1 lg:grid-cols-3 gap-8 animate-pulse">
    {/* Esqueleto para la lista de perfiles */}
    <div className="lg:col-span-1 h-full flex flex-col glass-effect rounded-lg p-4 space-y-4">
      <Skeleton className="h-10 w-full" />
      <Skeleton className="h-24 w-full" />
      <Skeleton className="h-24 w-full" />
      <Skeleton className="h-24 w-full" />
      <Skeleton className="h-24 w-full" />
    </div>
    {/* Esqueleto para el mapa */}
    <div className="lg:col-span-2 h-full rounded-lg overflow-hidden">
      <Skeleton className="w-full h-full" />
    </div>
  </div>
);

// =================== FILE: src/app/[locale]/(app)/network/_components/profiles/ProfileCard.tsx ===================

"use client";

import { Building2 } from 'lucide-react';
import type { PublicProfileListItem } from '../../types';
import Image from 'next/image';
import { useTranslations } from 'next-intl';
import { cn } from '@/lib/utils/utils';

interface ProfileCardProps {
    profile: PublicProfileListItem;
    isSelected: boolean;
    onClick: () => void;
}

export default function ProfileCard({ profile, isSelected, onClick }: ProfileCardProps) {
    const t = useTranslations('NetworkPage');
    return (
        <div onClick={onClick} className={cn('p-4 mb-2 rounded-lg cursor-pointer transition-all duration-200', isSelected ? 'bg-primary/20 ring-2 ring-primary' : 'bg-card hover:bg-muted')}>
            <div className="flex items-center gap-4">
                {profile.logo_url ? (
                    <Image src={profile.logo_url} alt={t('logoAltText', { companyName: profile.name })} width={48} height={48} className="rounded-full object-cover bg-muted" />
                ) : (
                    <div className="w-12 h-12 rounded-full bg-muted flex items-center justify-center flex-shrink-0">
                        <Building2 className="w-6 h-6 text-gray-400" />
                    </div>
                )}
                <div className="min-w-0">
                    <h3 className="font-bold truncate">{profile.name}</h3>
                    {profile.sector && <p className="text-sm text-primary font-medium truncate">{profile.sector}</p>}
                </div>
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/network/_components/profiles/ProfileList.tsx ===================

// src/app/[locale]/(app)/network/_components/ProfileList.tsx

import type { PublicProfileListItem } from '../../types';
import ProfileCard from './ProfileCard';
import { useTranslations } from 'next-intl';
import { cn } from '@/lib/utils/utils'; // <-- Importa cn
import type { Dispatch, SetStateAction } from 'react'; // Importem tipus

interface ProfileListProps {
    profiles: PublicProfileListItem[];
    // Aquestes props les rep del NetworkClient (on hi ha la barra de cerca)
    searchTerm: string;
    onSearchChange: Dispatch<SetStateAction<string>>; 
    onSelectProfile: (profile: PublicProfileListItem) => void;
    selectedProfileId?: string;
    className?: string; 
}

export default function ProfileList({
    profiles,
    // No necessitem searchTerm ni onSearchChange aquÃ­ dins,
    // ja que la barra de cerca estÃ  al NetworkClient.
    // Les mantenim (o les podrÃ­em treure) per si decidim moure la cerca aquÃ­.
    // De fet, per netejar, les traurem.
    onSelectProfile,
    selectedProfileId,
    className
}: ProfileListProps) {
    const t = useTranslations('NetworkPage');
    
    return (
        // Aquest component nomÃ©s gestiona la llista i l'scroll
        // La capÃ§alera amb la cerca estÃ  ara al NetworkClient
        <div className={cn(
            "flex-1 overflow-y-auto custom-scrollbar p-2",
            className
        )}>
            {profiles.length > 0 ? (
                profiles.map(profile => (
                    <ProfileCard
                        key={profile.id}
                        profile={profile}
                        isSelected={profile.id === selectedProfileId}
                        onClick={() => onSelectProfile(profile)}
                    />
                ))
            ) : (
                <p className="text-center text-muted-foreground p-4">{t('noResults')}</p>
            )}
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/network/_components/projects/ProjectCard.tsx ===================

// src/app/[locale]/(app)/network/_components/ProjectCard.tsx

"use client";

import { Briefcase } from 'lucide-react';
import type { JobPostingListItem } from '../../types'; // El nostre nou tipus
import Image from 'next/image';
import { useTranslations } from 'next-intl';
import { cn } from '@/lib/utils/utils';

interface ProjectCardProps {
    project: JobPostingListItem;
    isSelected: boolean;
    onClick: () => void;
}

export default function ProjectCard({ project, isSelected, onClick }: ProjectCardProps) {
    const t = useTranslations('NetworkPage');
    
    // Obtenim les dades de l'equip (amb valors per defecte)
    // GrÃ cies al JOIN que vam fer a NetworkData, tenim 'teams'
    const teamName = project.teams?.name ?? t('unknownCompany');
    const teamLogo = project.teams?.logo_url;

    return (
        <div 
            onClick={onClick} 
            className={cn(
                'p-4 mb-2 rounded-lg cursor-pointer transition-all duration-200', 
                isSelected ? 'bg-primary/20 ring-2 ring-primary' : 'bg-card hover:bg-muted'
            )}
        >
            <div className="flex items-center gap-4">
                {/* Logo de l'empresa que publica */}
                {teamLogo ? (
                    <Image 
                        src={teamLogo} 
                        alt={t('logoAltText', { companyName: teamName })} 
                        width={48} 
                        height={48} 
                        className="rounded-full object-cover bg-muted" 
                    />
                ) : (
                    <div className="w-12 h-12 rounded-full bg-muted flex items-center justify-center flex-shrink-0">
                        {/* Icona de maletÃ­ per a projectes */}
                        <Briefcase className="w-6 h-6 text-gray-400" />
                    </div>
                )}
                
                {/* Detalls del projecte */}
                <div className="min-w-0">
                    <h3 className="font-bold truncate" title={project.title}>{project.title}</h3>
                    <p className="text-sm text-primary font-medium truncate">{teamName}</p>
                </div>
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/network/_components/projects/ProjecteList.tsx ===================

// src/app/[locale]/(app)/network/_components/ProjectList.tsx

import type { JobPostingListItem } from '../../types';
// âœ… CORRECCIÃ“: Importem 'ProjectCard', no 'ProfileCard'
import ProjectCard from './ProjectCard'; 
import { useTranslations } from 'next-intl';
import { cn } from '@/lib/utils/utils';

interface ProjectListProps {
    projects: JobPostingListItem[];
    onSelectProject: (project: JobPostingListItem | null) => void;
    selectedProjectId?: string;
    className?: string; 
}

export default function ProjectList({
    projects,
    onSelectProject,
    selectedProjectId,
    className
}: ProjectListProps) {
    const t = useTranslations('NetworkPage');
    
    return (
        // Aquest component nomÃ©s gestiona la llista i l'scroll
        <div className={cn("flex-1 overflow-y-auto custom-scrollbar p-2", className)}>
            {projects.length > 0 ? (
                projects.map(project => (
                    // Ara 'ProjectCard' Ã©s el component correcte
                    <ProjectCard
                        key={project.id}
                        project={project}
                        isSelected={project.id === selectedProjectId}
                        onClick={() => onSelectProject(project)}
                    />
                ))
            ) : (
                <p className="text-center text-muted-foreground p-4">{t('noResults')}</p>
            )}
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/projectStrocture/actions.ts ===================

/**
 * @file actions.ts (Project Structure)
 * @summary Aquesta Server Action actua com a pont segur entre la nostra aplicaciÃ³ i l'API de GitHub.
 * âœ… NOU: Ara inclou accions per obtenir les branques del repositori i carregar l'estructura
 * d'una branca especÃ­fica. S'ha eliminat la lÃ²gica de desar posicions.
 */

"use server";

// --- Tipus de Dades ---
export interface FileTreeNode { path: string; type: 'tree' | 'blob'; }
interface StructureActionResult { data: FileTreeNode[] | null; error: string | null; }
interface ContentActionResult { data: string | null; error: string | null; }
interface Branch { name: string; }
interface BranchesActionResult { data: string[] | null; error: string | null; }

// --- ConfiguraciÃ³ de l'API de GitHub ---
const GITHUB_TOKEN = process.env.GITHUB_PAT;
const REPO_OWNER = process.env.NEXT_PUBLIC_GITHUB_REPO_OWNER;
const REPO_NAME = process.env.NEXT_PUBLIC_GITHUB_REPO_NAME;
// âœ… CORRECCIÃ“: Definim la branca principal com a valor per defecte.
const MAIN_BRANCH = 'main'; 

/**
 * @summary Server Action per obtenir la llista de branques del repositori.
 */
export async function fetchBranchesAction(): Promise<BranchesActionResult> {
    if (!GITHUB_TOKEN || !REPO_OWNER || !REPO_NAME) {
        return { data: null, error: "La configuraciÃ³ de l'API de GitHub no estÃ  completa." };
    }
    const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/branches`;
    try {
        const response = await fetch(apiUrl, {
            headers: { Authorization: `Bearer ${GITHUB_TOKEN}`, 'X-GitHub-Api-Version': '2022-11-28' },
            next: { revalidate: 3600, tags: ['github-repo-branches'] },
        });
        if (!response.ok) throw new Error(`Error de l'API de GitHub: ${(await response.json()).message}`);
        const data: Branch[] = await response.json();
        return { data: data.map(branch => branch.name), error: null };
    } catch (error: unknown) { // âœ… CORRECCIÃ“N: Tipamos el error como 'unknown'
        // Comprobamos si el error es una instancia de Error para acceder a .message de forma segura
        const message = error instanceof Error ? error.message : "Un error desconegut ha ocorregut.";
        return { data: null, error: message };
    }
}

/**
 * @summary ObtÃ© l'estructura de fitxers d'una branca especÃ­fica.
 * âœ… CORRECCIÃ“: Afegim un valor per defecte al parÃ metre 'branch' per evitar l'error.
 */
export async function fetchProjectStructureAction(branch: string = MAIN_BRANCH): Promise<StructureActionResult> {
  if (!GITHUB_TOKEN || !REPO_OWNER || !REPO_NAME) {
    return { data: null, error: "La configuraciÃ³ de l'API de GitHub no estÃ  completa." };
  }
  const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/git/trees/${branch}?recursive=1`;
  try {
    const response = await fetch(apiUrl, {
      headers: { Authorization: `Bearer ${GITHUB_TOKEN}`, 'X-GitHub-Api-Version': '2022-11-28' },
      next: { revalidate: 3600, tags: [`github-repo-structure-${branch}`] },
    });
    if (!response.ok) throw new Error(`Error de l'API de GitHub: ${(await response.json()).message}`);
    const data = await response.json();
    const filteredTree = (data.tree as FileTreeNode[]).filter(node => 
        !node.path.includes('node_modules') && !node.path.includes('.next') && !node.path.includes('.vscode') &&
        !node.path.includes('.DS_Store') && !node.path.includes('package-lock.json') && !node.path.endsWith('.md')
    );
    return { data: filteredTree, error: null };
} catch (error: unknown) { // âœ… CORRECCIÃ“N: Tipamos el error como 'unknown'
    const message = error instanceof Error ? error.message : "Un error desconegut ha ocorregut.";
    return { data: null, error: message };
}
}

/**
 * @summary ObtÃ© el contingut d'un fitxer especÃ­fic.
 */
export async function fetchFileContentAction(filePath: string): Promise<ContentActionResult> {
    if (!GITHUB_TOKEN || !REPO_OWNER || !REPO_NAME) {
        return { data: null, error: "La configuraciÃ³ de l'API de GitHub no estÃ  completa." };
    }
    // âœ… CORRECCIÃ“: Afegim una referÃ¨ncia a la branca per a mÃ©s precisiÃ³.
    const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${filePath}`;
    try {
        const response = await fetch(apiUrl, {
            headers: { Authorization: `Bearer ${GITHUB_TOKEN}`, 'X-GitHub-Api-Version': '2022-11-28' },
            next: { revalidate: 3600 },
        });
        if (!response.ok) throw new Error(`Error de l'API de GitHub: ${(await response.json()).message}`);
        const data = await response.json();
        
        const content = Buffer.from(data.content, 'base64').toString('utf-8');
        return { data: content, error: null };

    } catch (error: unknown) { // âœ… CORRECCIÃ“N: Tipamos el error como 'unknown'
        const message = error instanceof Error ? error.message : "Un error desconegut ha ocorregut.";
        return { data: null, error: message };
    }
}



// =================== FILE: src/app/[locale]/(app)/projectStrocture/page.tsx ===================

/**
 * @file page.tsx (Project Structure)
 * @summary Component de Servidor per a la pÃ gina de l'Arquitectura del Projecte.
 * âœ… VERSIÃ“ SIMPLIFICADA: Ara nomÃ©s renderitza el component de client, sense carregar posicions.
 */


import { ArchitectureVisualizer } from './_components/ArchitectureVisualizer';
import type { Metadata } from 'next';

export const metadata: Metadata = {
Â  title: 'Arquitectura del Projecte | Ribot',
};

// Ja no necessitem carregar cap dada aquÃ­, tota la lÃ²gica es mou al client.
export default async function ProjectStructurePage() {
Â  return (
    <div className="h-full w-full p-4">
        <ArchitectureVisualizer />
    </div>
  );
}



// =================== FILE: src/app/[locale]/(app)/projectStrocture/_components/ArchitectureVisualizer.tsx ===================

/**
 * @file ArchitectureVisualizer.tsx
 * @summary Component de client que renderitza el diagrama interactiu de l'arquitectura.
 * âœ… VERSIÃ“ FINAL: Inclou disseny horitzontal, selector de branques, nodes personalitzats amb colors,
 * cerca, carpetes plegables i visualitzador de codi.
 */

"use client";

import React, { useState, useEffect, useCallback, useTransition, FC } from 'react';
import ReactFlow, { 
    Controls, Background, applyNodeChanges, applyEdgeChanges, Handle, Position, addEdge,
    type Node, type Edge, type OnNodesChange, type OnEdgesChange, type NodeProps, type Connection,
} from 'reactflow';
import 'reactflow/dist/style.css';
import Editor from 'react-simple-code-editor';
import { highlight, languages } from 'prismjs/components/prism-core';
import 'prismjs/components/prism-clike';
import 'prismjs/components/prism-javascript';
import 'prismjs/components/prism-typescript';
import 'prismjs/components/prism-markup';
import 'prismjs/components/prism-jsx';
import 'prismjs/components/prism-tsx';

import { fetchProjectStructureAction, fetchFileContentAction, fetchBranchesAction, type FileTreeNode } from '../actions';
import { Loader2, File, Folder, Database, Server, Component, Settings, FileCode, X, Search, Expand, Shrink, GitBranch } from 'lucide-react';
import { cn } from '@/lib/utils/utils';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";

// --- Tipus de Dades ---
type CustomNodeData = { label: string; type: string; path: string; nodeType: 'tree' | 'blob'; isCollapsed?: boolean; isDimmed?: boolean; };
type CustomNode = Node<CustomNodeData>;

// --- Components de Nodes Personalitzats ---
const nodeIcons: Record<string, React.ElementType> = {
    root: Server, folder: Folder, supabaseFn: Database, serverAction: Server,
    serverPage: FileCode, clientComponent: Component, layout: FileCode,
    config: Settings, default: File,
};
const nodeColors: Record<string, string> = {
    root: 'bg-purple-600 border-purple-400', folder: 'bg-blue-600 border-blue-400',
    supabaseFn: 'bg-green-600 border-green-400', serverAction: 'bg-orange-600 border-orange-400',
    serverPage: 'bg-indigo-600 border-indigo-400', clientComponent: 'bg-pink-600 border-pink-400',
    layout: 'bg-rose-600 border-rose-400', config: 'bg-gray-500 border-gray-300',
    default: 'bg-gray-700 border-gray-500',
};

const CustomNodeComponent: FC<NodeProps<CustomNodeData>> = ({ data }) => {
    const Icon = nodeIcons[data.type] || (data.nodeType === 'tree' ? Folder : File);
    const colors = nodeColors[data.type] || nodeColors.default;
    return (
        <div className={cn("rounded-lg p-4 text-white font-sans shadow-lg flex items-center gap-4 border-2 min-w-[240px] transition-opacity", colors, data.isDimmed && "opacity-30")}>
            <Handle type="target" position={Position.Left} className="!bg-gray-400 opacity-50" />
            <Icon className="w-6 h-6 flex-shrink-0" />
            <div className="flex-grow">
                <div className="text-base font-bold">{data.label}</div>
            </div>
            {data.nodeType === 'tree' && (data.isCollapsed ? <Expand className="w-5 h-5" /> : <Shrink className="w-5 h-5" />)}
            <Handle type="source" position={Position.Right} className="!bg-gray-400 opacity-50" />
        </div>
    );
};
const nodeTypes = { custom: CustomNodeComponent };

// --- FunciÃ³ de TransformaciÃ³ de Dades ---
const transformDataToFlow = (fileTree: FileTreeNode[]): { nodes: CustomNode[], edges: Edge[] } => {
    const nodes: CustomNode[] = [];
    const edges: Edge[] = [];
    const nodeMap = new Map<string, CustomNode>();

    const getNodeType = (path: string): string => {
        if (path.includes('supabase/functions')) return 'supabaseFn';
        if (path.endsWith('actions.ts')) return 'serverAction';
        if (path.endsWith('page.tsx')) return 'serverPage';
        if (path.includes('client.tsx') || path.includes('Client.tsx')) return 'clientComponent';
        if (path.endsWith('layout.tsx')) return 'layout';
        if (path.endsWith('middleware.ts')) return 'config';
        return 'default';
    }

    const rootNode: CustomNode = { id: 'root', data: { label: 'Projecte Ribot', type: 'root', path: '/', nodeType: 'tree' }, position: { x: 0, y: 0 }, type: 'custom' };
    nodes.push(rootNode);
    nodeMap.set('root', rootNode);

    fileTree.forEach(item => {
        const pathParts = item.path.split('/');
        let currentPath = '';
        pathParts.forEach((part, index) => {
            const previousPath = currentPath;
            currentPath = currentPath ? `${currentPath}/${part}` : part;
            if (!nodeMap.has(currentPath)) {
                const isLastPart = index === pathParts.length - 1;
                const newNode: CustomNode = {
                    id: currentPath,
                    data: { label: part, type: isLastPart && item.type === 'blob' ? getNodeType(currentPath) : 'folder', path: currentPath, nodeType: isLastPart ? item.type : 'tree' },
                    position: { x: 0, y: 0 },
                    type: 'custom',
                };
                nodes.push(newNode);
                nodeMap.set(currentPath, newNode);
                const parentNodeId = index === 0 ? 'root' : previousPath;
                edges.push({ id: `e-${parentNodeId}-${currentPath}`, source: parentNodeId, target: currentPath, type: 'smoothstep' });
            }
        });
    });
    
    const levels: Map<number, CustomNode[]> = new Map();
    nodes.forEach(node => {
        const level = node.id === 'root' ? 0 : node.id.split('/').length;
        if (!levels.has(level)) levels.set(level, []);
        levels.get(level)!.push(node);
    });
    levels.forEach((nodesAtLevel, level) => {
        const levelHeight = nodesAtLevel.length * 100;
        nodesAtLevel.forEach((node, index) => {
            node.position = {
                x: level * 350,
                y: index * 100 - (levelHeight / 2)
            };
        });
    });

    return { nodes, edges };
};

// --- Component Principal ---
export function ArchitectureVisualizer() {
    const [allNodes, setAllNodes] = useState<CustomNode[]>([]);
    const [allEdges, setAllEdges] = useState<Edge[]>([]);
    const [nodes, setNodes] = useState<CustomNode[]>([]);
    const [edges, setEdges] = useState<Edge[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [viewingFile, setViewingFile] = useState<{ path: string; content: string } | null>(null);
    const [isCodeLoading, startCodeLoadingTransition] = useTransition();
    const [searchTerm, setSearchTerm] = useState('');
    const [collapsedNodes, setCollapsedNodes] = useState<Record<string, boolean>>({});
    const [branches, setBranches] = useState<string[]>([]);
    const [selectedBranch, setSelectedBranch] = useState<string>('main');

    const onNodesChange: OnNodesChange = useCallback((changes) => setNodes((nds) => applyNodeChanges(changes, nds)), []);
    const onEdgesChange: OnEdgesChange = useCallback((changes) => setEdges((eds) => applyEdgeChanges(changes, eds)), []);
    const onConnect = useCallback((connection: Connection) => setEdges((eds) => addEdge({ ...connection, type: 'smoothstep', animated: true }, eds)), []);

    const handleNodeDoubleClick = useCallback((_: React.MouseEvent, node: CustomNode) => {
        if (node.data.nodeType === 'blob') {
            startCodeLoadingTransition(async () => {
                setViewingFile({ path: node.data.path, content: "Carregant contingut del fitxer..." });
                const result = await fetchFileContentAction(node.data.path);
                setViewingFile({ path: node.data.path, content: result.data || `Error: ${result.error}` });
            });
        }
    }, []);

    const handleNodeClick = useCallback((_: React.MouseEvent, node: CustomNode) => {
        if (node.data.nodeType === 'tree') {
            setCollapsedNodes(prev => ({ ...prev, [node.id]: !prev[node.id] }));
        }
    }, []);

    useEffect(() => {
        const loadStructure = async () => {
            setIsLoading(true);
            const result = await fetchProjectStructureAction(selectedBranch);
            if (result.data) {
                const { nodes: initialNodes, edges: initialEdges } = transformDataToFlow(result.data);
                setAllNodes(initialNodes);
                setAllEdges(initialEdges);
            } else {
                console.error(result.error);
            }
            setIsLoading(false);
        };
        if(selectedBranch) loadStructure();
    }, [selectedBranch]);

    useEffect(() => {
        const loadBranches = async () => {
            const result = await fetchBranchesAction();
            if (result.data) {
                setBranches(result.data);
                if (!result.data.includes('main')) {
                    setSelectedBranch(result.data[0] || '');
                }
            }
        };
        loadBranches();
    }, []);

    useEffect(() => {
        let visibleNodes = [...allNodes];
        if (searchTerm.trim()) {
            const lowerCaseSearch = searchTerm.toLowerCase();
            const matchingNodeIds = new Set<string>();
            allNodes.forEach(n => {
                if (n.data.label.toLowerCase().includes(lowerCaseSearch)) {
                    matchingNodeIds.add(n.id);
                    let parentId = allEdges.find(e => e.target === n.id)?.source;
                    while (parentId) {
                        matchingNodeIds.add(parentId);
                        parentId = allEdges.find(e => e.target === parentId)?.source;
                    }
                }
            });
            visibleNodes = allNodes.map(n => ({...n, data: { ...n.data, isDimmed: !matchingNodeIds.has(n.id) }}));
        } else {
            visibleNodes = allNodes.map(n => ({...n, data: { ...n.data, isDimmed: false }}));
        }

        const hiddenNodeIds = new Set<string>();
        Object.entries(collapsedNodes).forEach(([nodeId, isCollapsed]) => {
            if (isCollapsed) {
                const findDescendants = (id: string) => {
                    allEdges.forEach(edge => {
                        if (edge.source === id) {
                            hiddenNodeIds.add(edge.target);
                            findDescendants(edge.target);
                        }
                    });
                };
                findDescendants(nodeId);
            }
        });
        
        const finalNodes = visibleNodes.map(n => ({ ...n, hidden: hiddenNodeIds.has(n.id), data: {...n.data, isCollapsed: !!collapsedNodes[n.id]} }));
        setNodes(finalNodes);
        setEdges(allEdges.filter(e => !hiddenNodeIds.has(e.source) && !hiddenNodeIds.has(e.target)));

    }, [searchTerm, collapsedNodes, allNodes, allEdges]);

    if (isLoading && nodes.length === 0) {
        return <div className="flex items-center justify-center h-full text-white"><Loader2 className="w-8 h-8 animate-spin" /><p className="ml-4 text-lg">Construint el diagrama des de GitHub...</p></div>;
    }

    return (
        <div className="h-full w-full bg-gray-900 rounded-lg overflow-hidden relative font-sans flex flex-col">
            <div className="absolute top-4 left-4 z-10 text-white bg-black/40 p-3 rounded-lg shadow-lg backdrop-blur-sm flex items-center gap-4">
                <div className="relative">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
                    <Input placeholder="Cerca un fitxer..." className="pl-9 bg-gray-800/50 border-gray-600" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                </div>
                <div className="flex items-center gap-2">
                    <GitBranch className="w-5 h-5 text-gray-400" />
                    <Select value={selectedBranch} onValueChange={setSelectedBranch} disabled={branches.length === 0}>
                        <SelectTrigger className="w-[180px] bg-gray-800/50 border-gray-600">
                            <SelectValue placeholder="Carregant branques..." />
                        </SelectTrigger>
                        <SelectContent>
                            {branches.map(branch => <SelectItem key={branch} value={branch}>{branch}</SelectItem>)}
                        </SelectContent>
                    </Select>
                </div>
            </div>
            <ReactFlow nodes={nodes} edges={edges} onNodesChange={onNodesChange} onEdgesChange={onEdgesChange} onConnect={onConnect}
                onNodeDoubleClick={handleNodeDoubleClick} onNodeClick={handleNodeClick}
                fitView nodeTypes={nodeTypes} proOptions={{ hideAttribution: true }} className="bg-dots">
                <Controls />
                <Background color="#4B5563" />
            </ReactFlow>

            <Dialog open={!!viewingFile} onOpenChange={(isOpen) => !isOpen && setViewingFile(null)}>
                <DialogContent className="max-w-5xl h-[90vh] flex flex-col bg-gray-900/90 backdrop-blur-sm border-gray-700 text-white">
                    <DialogHeader>
                        <DialogTitle className="flex justify-between items-center font-mono text-lg">{viewingFile?.path}<Button variant="ghost" size="icon" onClick={() => setViewingFile(null)}><X className="w-4 h-4" /></Button></DialogTitle>
                    </DialogHeader>
                    <div className="flex-1 overflow-y-auto bg-[#282c34] rounded-md p-1 editor-container-class">
                        {isCodeLoading && !viewingFile?.content.startsWith('Error') ? (
                           <div className="flex items-center justify-center h-full"><Loader2 className="w-6 h-6 animate-spin"/></div>
                        ) : (
                            <Editor value={viewingFile?.content || ''} onValueChange={() => {}} highlight={(code) => highlight(code, languages.tsx, 'tsx')} padding={16} className="font-mono text-sm" style={{ minHeight: '100%'}}/>
                        )}
                    </div>
                </DialogContent>
            </Dialog>
        </div>
    );
}



// =================== FILE: src/app/[locale]/(app)/redirecting/page.tsx ===================

/**
 * @file page.tsx (Redirecting)
 * @summary Aquest fitxer defineix una pÃ gina de transiciÃ³ que es mostra a l'usuari
 * desprÃ©s d'accions importants com completar el formulari d'onboarding.
 * La seva funciÃ³ Ã©s assegurar que la sessiÃ³ del client i del servidor estigui sincronitzada
 * abans de redirigir a l'usuari al seu destÃ­ final (normalment el Dashboard).
 */

"use client"; // Ã‰s un component de client perquÃ¨ necessita utilitzar hooks (useEffect, useRouter).

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import RedirectAnimation from '@/app/[locale]/(app)/_components/ui/redirect-animation';

/**
 * @function RedirectingPage
 * @summary Mostra una animaciÃ³ i gestiona la redirecciÃ³.
 */
export default function RedirectingPage() {
Â  const router = useRouter();

  // Aquest efecte s'executa un sol cop quan el component es munta.
Â  useEffect(() => {
    // Creem un temporitzador per donar temps a l'animaciÃ³ i assegurar que tot es processi correctament.
Â  Â  const timer = setTimeout(() => {
      // --- AQUESTA LÃ’GICA Ã‰S CRUCIAL ---
Â  Â  Â  // 1. router.refresh(): Aquesta funciÃ³ de Next.js forÃ§a una recÃ rrega de les dades del servidor
      // sense perdre l'estat del client. Ã‰s vital per assegurar que el servidor reconeix la nova
      // sessiÃ³ o l'estat de l'usuari (ex: onboarding completat) abans de la navegaciÃ³.
Â  Â  Â  router.refresh(); 

Â  Â  Â  // 2. router.push('/dashboard'): Un cop la sessiÃ³ del servidor estÃ  actualitzada,
      // naveguem de manera segura a la pÃ gina principal de l'aplicaciÃ³.
Â  Â  Â  router.push('/dashboard');
Â  Â  }, 3000); // Esperem 3 segons.

Â  Â  // FunciÃ³ de neteja: si l'usuari navega fora d'aquesta pÃ gina abans que passin els 3 segons,
    // el temporitzador es cancelÂ·la per evitar errors.
Â  Â  return () => clearTimeout(timer);
Â  }, [router]);

Â  return (
    // Mostrem una animaciÃ³ per millorar l'experiÃ¨ncia de l'usuari durant l'espera.
Â  Â  <div className="min-h-screen flex items-center justify-center p-4 bg-background">
Â  Â  Â  <RedirectAnimation />
Â  Â  </div>
Â  );
}


// =================== FILE: src/app/[locale]/(app)/settings/billing/actions.ts ===================

// src/app/[locale]/(app)/settings/billing/actions.ts (FITXER CORREGIT I NET)
"use server";

import { revalidatePath } from "next/cache";
import { validateUserSession } from '@/lib/supabase/session';

// âœ… 1. Importem el NOU servei
import * as billingService from '@/lib/services/settings/billing/billing.service';

// âœ… 2. Importem els tipus NOMÃ‰S PER A ÃšS INTERN
import type { FormState } from '@/lib/services/settings/billing/billing.service';

// --- AcciÃ³ per Subscriure's ---

export async function subscribeToPlanAction(planId: string): Promise<FormState> {
  // 1. ValidaciÃ³ de sessiÃ³
  const session = await validateUserSession();
  if ('error' in session) {
    return { success: false, message: session.error.message };
  }
  const { supabase, user, activeTeamId } = session;

  // 2. Crida al servei
  const result = await billingService.subscribeToPlan(supabase, user, activeTeamId, planId);

  // 3. Efectes (revalidaciÃ³)
  if (result.success) {
    revalidatePath('/settings/billing');
    // Important: TambÃ© revalidem el layout de l'app si el pla canvia,
    // ja que pot afectar la UI (p.ex. un bÃ ner d'actualitzaciÃ³)
    revalidatePath('/[locale]/(app)', 'layout');
  }

  return result;
}

// --- AcciÃ³ per CancelÂ·lar ---

export async function cancelSubscriptionAction(): Promise<FormState> {
  // 1. ValidaciÃ³ de sessiÃ³
  const session = await validateUserSession();
  if ('error' in session) {
    return { success: false, message: session.error.message };
  }
  const { supabase, user, activeTeamId } = session;

  // 2. Crida al servei
  const result = await billingService.cancelSubscription(supabase, user, activeTeamId);

  // 3. Efectes (revalidaciÃ³)
  if (result.success) {
    revalidatePath('/settings/billing');
    revalidatePath('/[locale]/(app)', 'layout');
  }

  return result;
}

// =================== FILE: src/app/[locale]/(app)/settings/billing/page.tsx ===================

import { Suspense } from 'react';
import type { Metadata } from 'next';
import { getTranslations } from 'next-intl/server';
import { BillingData } from './_components/BillingData';
import { BillingSkeleton } from './_components/BillingSkeleton';
import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { hasPermission, PERMISSIONS } from '@/lib/permissions/permissions';
import { AccessDenied } from '@/components/shared/AccessDenied';
// âœ… 1. Importem el tipus 'Role' des del fitxer de configuraciÃ³ de permisos.
import { type Role } from '@/lib/permissions/permissions.config';

export const dynamic = 'force-dynamic';

interface BillingPageProps {
  params: Promise<{ locale: string }>;
}

export async function generateMetadata(props: BillingPageProps): Promise<Metadata> {
  const { locale } = await props.params;
  const t = await getTranslations({ locale, namespace: 'SettingsPage.billing' });
  return { title: `${t('metaTitle')} | Ribot` };
}

export default async function BillingPage() {
  const supabase = createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect('/login');

  const activeTeamId = user.app_metadata?.active_team_id;
  if (!activeTeamId) redirect('/settings/team');

  const { data: member } = await supabase
    .from('team_members')
    .select('role')
    .match({ user_id: user.id, team_id: activeTeamId })
    .single();

  // âœ… 2. Fem una asserciÃ³ de tipus per dir-li a TypeScript que 'member.role' Ã©s un 'Role'.
  if (!hasPermission(member?.role as Role, PERMISSIONS.VIEW_BILLING)) {
    return <AccessDenied />;
  }

  return (
    <Suspense fallback={<BillingSkeleton />}>
      <BillingData />
    </Suspense>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/billing/_components/BillingClient.tsx ===================

// src/app/[locale]/(app)/settings/billing/_components/BillingClient.tsx (FITXER CORREGIT I COMPLET)
"use client";

import { useState, useTransition } from 'react';
import { useRouter } from 'next/navigation';
import { motion } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { Switch } from "@/components/ui/switch";
import { Label } from "@/components/ui/label";
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from "@/components/ui/accordion";
import { Check, Gift, Star, Gem, Settings } from 'lucide-react';
import { cn } from '@/lib/utils/utils';
import { useTranslations, useLocale } from 'next-intl';
import { subscribeToPlanAction, cancelSubscriptionAction } from '../actions';
import type { Subscription, Plan } from '@/types/settings';
// âœ… 1. Importem el tipus 'Role'
import { type Role } from '@/lib/permissions/permissions.config';

const PlanIcon = ({ name, className }: { name: string; className?: string }) => {
  switch (name) {
    case 'Gift': return <Gift className={className} />;
    case 'Star': return <Star className={className} />;
    case 'Gem': return <Gem className={className} />;
    case 'Settings': return <Settings className={className} />;
    default: return null;
  }
};

export function BillingClient({ plans, activeSubscription, currentUserRole }: {
  plans: Plan[];
  activeSubscription: Subscription | null;
  // âœ… 2. Canviem 'string | null' per 'Role | null'
  currentUserRole: Role | null;
}) {
  const t = useTranslations('SettingsPage.billing');
  const locale = useLocale();
  const router = useRouter();
  const [billingCycle, setBillingCycle] = useState<'monthly' | 'yearly'>('monthly');
  const [isPending, startTransition] = useTransition();

  // âœ… 3. Aquesta comprovaciÃ³ ara Ã©s 100% segura a nivell de tipus
  const canManageBilling = currentUserRole === 'owner' || currentUserRole === 'admin';

  const currentPlanDetails = plans.find(p => p.isCurrent);
  const handleSelectPlan = (planId: string) => {
    startTransition(async () => {
      const result = await subscribeToPlanAction(planId);
      if (result.success) {
        toast.success(result.message);
        router.refresh();
      } else {
        toast.error(result.message);
      }
    });
  };

  const handleCancelSubscription = () => {
    startTransition(async () => {
      const result = await cancelSubscriptionAction();
      if (result.success) {
        toast.success(result.message);
        router.refresh();
      } else {
        toast.error(result.message);
      }
    });
  };

  const handleManageBilling = () => { toast.info(t('redirecting'), { description: t('redirectingDesc') }); };

  return (
    <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="space-y-12">
      {/* ... (La resta del JSX Ã©s idÃ¨ntic) ... */}
      <div className="flex items-center justify-center space-x-2 sm:space-x-4">
        <Label htmlFor="billing-cycle" className={cn('transition-colors text-sm sm:text-base', billingCycle === 'monthly' ? 'text-foreground font-semibold' : 'text-muted-foreground')}>
          {t('monthlyBilling')}
        </Label>
        <Switch
          id="billing-cycle"
          checked={billingCycle === 'yearly'}
          onCheckedChange={(checked) => setBillingCycle(checked ? 'yearly' : 'monthly')}
        />
        <Label htmlFor="billing-cycle" className={cn('transition-colors text-sm sm:text-base', billingCycle === 'yearly' ? 'text-foreground font-semibold' : 'text-muted-foreground')}>
          {t('yearlyBilling')} <span className="text-primary font-bold">{t('yearlySave')}</span>
        </Label>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 items-stretch">
        {plans.map((plan) => (
          <div
            key={plan.name}
            className={cn(
              "glass-card p-6 rounded-2xl flex flex-col relative border-2 transition-transform duration-300",
              plan.isPopular ? `${plan.colors.border} shadow-lg shadow-primary/20` : "border-transparent",
              plan.isCurrent ? "ring-2 ring-offset-2 ring-offset-background" : "lg:hover:-translate-y-2",
              plan.isCurrent ? plan.colors.border : ""
            )}
          >
            {plan.isPopular && (
              <div className="absolute top-0 -translate-y-1/2 left-1/2 -translate-x-1/2 bg-primary text-primary-foreground px-3 py-1 text-xs font-bold rounded-full tracking-wider">
                {t('mostPopular')}
              </div>
            )}

            <div className="flex-grow flex flex-col">
              <div className="flex items-center gap-3 mb-4">
                <PlanIcon name={plan.iconName} className={cn("w-6 h-6", plan.colors.text)} />
                <h3 className="text-xl font-bold text-foreground">{plan.name}</h3>
              </div>
              <p className="text-muted-foreground text-sm mb-6 flex-grow">{plan.description}</p>
              <div className="mb-2 min-h-[80px]">
                {plan.priceMonthly !== null ? (
                  <>
                    <span className="text-4xl sm:text-5xl font-extrabold text-foreground">
                      â‚¬{billingCycle === 'monthly' ? plan.priceMonthly : plan.priceYearly ? Math.round(plan.priceYearly / 12) : 0}
                    </span>
                    <span className="text-muted-foreground text-sm sm:text-base">{t('pricePerMonth')}</span>
                    {billingCycle === 'yearly' && plan.priceYearly && (
                      <p className="text-xs text-muted-foreground mt-1">{t('billedAs', { price: plan.priceYearly })}</p>
                    )}
                  </>
                ) : (
                  <span className="text-3xl sm:text-4xl font-extrabold text-foreground">{t('contactUs')}</span>
                )}
              </div>
              <Button
                onClick={() => handleSelectPlan(plan.id)}
                disabled={plan.isCurrent || isPending || !canManageBilling}
                className={cn("w-full font-bold mt-2 mb-10", /* ... */)}
              >
                {plan.isCurrent ? t('yourCurrentPlan') : t('selectPlan')}
              </Button>
              <ul className="space-y-4 text-sm">
                {plan.features.map((feature, index) => (
                  <li key={index} className="flex items-start">
                    <Check className={cn("w-4 h-4 mr-3 mt-0.5 flex-shrink-0", plan.colors.text)} />
                    <span className="text-foreground/80">{feature}</span>
                  </li>
                ))}
              </ul>
            </div>
          </div>
        ))}
      </div>

      {activeSubscription && activeSubscription.status === 'active' && currentPlanDetails && (
        <div className="max-w-2xl mx-auto">
          <Accordion type="single" collapsible className="w-full">
            <AccordionItem value="item-1" className="glass-card rounded-2xl border px-4 sm:px-6">
              <AccordionTrigger className="hover:no-underline text-left">
                <div className="flex items-center gap-3">
                  <PlanIcon name={currentPlanDetails.iconName} className={cn("w-6 h-6", currentPlanDetails.colors.text)} />
                  <div>
                    <p className="font-bold text-lg">{t('currentPlan', { planName: currentPlanDetails.name })}</p>
                    <p className="text-sm text-muted-foreground">{t('renewsOn', { date: new Date(activeSubscription.current_period_end).toLocaleDateString(locale, { day: 'numeric', month: 'long' }) })}. {t('clickForDetails')}</p>
                  </div>
                </div>
              </AccordionTrigger>
              <AccordionContent>
                <div className="space-y-3 text-sm pt-4">
                  <div className="flex justify-between"><span className="text-muted-foreground">{t('planLabel')}</span><span className="font-semibold">{currentPlanDetails.name}</span></div>
                  <div className="flex justify-between"><span className="text-muted-foreground">{t('statusLabel')}</span><span className="font-semibold text-green-500">{t('statusValue')}</span></div>
                  <div className="flex justify-between"><span className="text-muted-foreground">{t('renewalDateLabel')}</span><span className="font-semibold">{new Date(activeSubscription.current_period_end).toLocaleDateString(locale, { day: 'numeric', month: 'long', year: 'numeric' })}</span></div>
                  <div className="border-t mt-6 pt-6 flex flex-col sm:flex-row gap-3">
                    <Button className="w-full" onClick={handleManageBilling}>{t('manageButton')}</Button>
                    {/* âœ… 4. Comprovem 'canManageBilling' per coherÃ¨ncia */}
                    <Button variant="destructive" className="w-full" onClick={handleCancelSubscription} disabled={isPending || !canManageBilling}>{t('cancelButton')}</Button>
                    M'he adonat que al botÃ³ de cancelÂ·lar no hi havia la comprovaciÃ³ de permisos, l'he afegit (`!canManageBilling`).
                  </div>
                </div>
              </AccordionContent>
            </AccordionItem>
          </Accordion>
        </div>



      )};
    </motion.div>
  );

}

// =================== FILE: src/app/[locale]/(app)/settings/billing/_components/BillingData.tsx ===================

// src/app/[locale]/(app)/settings/billing/_components/BillingData.tsx (FITXER CORREGIT I NET)
import { BillingClient } from './BillingClient';
import { getTranslations } from 'next-intl/server';
import { validatePageSession } from '@/lib/supabase/session';
import { plansStructure } from '@/config/billing';

// âœ… 1. Importem el NOU servei i els seus tipus
import * as billingService from '@/lib/services/settings/billing/billing.service';
import type { Plan } from '@/types/settings'; // Aquest tipus 'Plan' Ã©s de UI, estÃ  bÃ© aquÃ­

export async function BillingData() {
  const t = await getTranslations('SettingsPage.billing');
  
  // âœ… 2. ValidaciÃ³ de sessiÃ³ neta
  const { supabase, user, activeTeamId } = await validatePageSession();

  // âœ… 3. Crida al SERVEI per obtenir dades
  // Tota la lÃ²gica de 'Promise.all' i consultes s'ha mogut al servei.
  const { activeSubscription, currentUserRole } = await billingService.getBillingPageData(
    supabase,
    user.id,
    activeTeamId
  );

  // 4. LÃ²gica de presentaciÃ³ (mapa de traduccions)
  // AixÃ² Ã©s correcte que estigui aquÃ­, ja que Ã©s lÃ²gica de la UI (i18n).
  const finalPlansData: Plan[] = plansStructure.map(plan => ({
    ...plan,
    name: plan.id === 'custom' ? t(`plans.${plan.id}.name`) : plan.name,
    description: t(`plans.${plan.id}.description`),
    features: t.raw(`plans.${plan.id}.features`),
    isCurrent: activeSubscription?.status === 'active' && activeSubscription.plan_id === plan.id,
  }));

  // 5. Renderitzat del Client Component
  return (
    <div>
      <h1 className="text-3xl font-bold mb-2">{t('pageTitle')}</h1>
      <p className="text-muted-foreground mb-8">{t('pageDescription')}</p>
      <BillingClient 
        plans={finalPlansData} 
        activeSubscription={activeSubscription} // El tipus ja Ã©s 'Subscription | null'
        currentUserRole={currentUserRole}       // El tipus ja Ã©s 'TeamMemberRole | null'
      />
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/billing/_components/BillingSkeleton.tsx ===================

/**
 * @file BillingSkeleton.tsx
 * @summary Muestra un esqueleto de carga para la pÃ¡gina de FacturaciÃ³n y Planes.
 */
"use client";

import React from 'react';
import { Skeleton } from '@/components/ui/skeleton';

export const BillingSkeleton: React.FC = () => (
  <div className="space-y-12 animate-pulse">
    <div className="space-y-2">
      <Skeleton className="h-9 w-1/3" />
      <Skeleton className="h-5 w-2/3" />
    </div>
    <div className="flex items-center justify-center space-x-4">
      <Skeleton className="h-5 w-32" />
      <Skeleton className="h-6 w-12 rounded-full" />
      <Skeleton className="h-5 w-40" />
    </div>
    <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <Skeleton className="h-96 rounded-2xl" />
      <Skeleton className="h-96 rounded-2xl" />
      <Skeleton className="h-96 rounded-2xl" />
      <Skeleton className="h-96 rounded-2xl" />
    </div>
  </div>
);

// =================== FILE: src/app/[locale]/(app)/settings/billing/_components/UpgradePlanNotice.tsx ===================

"use client";

import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Gem } from 'lucide-react'; // Icona per a funcionalitats premium

interface UpgradePlanNoticeProps {
    featureName: string;
    requiredPlan: string;
    locale: string;
}

export function UpgradePlanNotice({ featureName, requiredPlan, locale }: UpgradePlanNoticeProps) {
    return (
        <div className="flex items-center justify-center h-full">
            <Card className="w-full max-w-lg text-center">
                <CardHeader>
                    <div className="mx-auto bg-primary/10 p-3 rounded-full w-fit">
                        <Gem className="w-8 h-8 text-primary" />
                    </div>
                    <CardTitle className="mt-4">Funcionalitat Premium</CardTitle>
                    <CardDescription>
                        El teu pla actual no inclou accÃ©s a la funcionalitat de <span className="font-semibold">{featureName}</span>.
                    </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                    <p>
                        Per a poder utilitzar aquesta eina, si us plau, millora la teva subscripciÃ³ al pla <span className="font-semibold">{requiredPlan}</span> o superior.
                    </p>
                    <Button asChild size="lg">
                        <Link href={`/${locale}/settings/billing`}>
                            Veure Plans i Preus
                        </Link>
                    </Button>
                </CardContent>
            </Card>
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/settings/blacklist/action.ts ===================

// src/app/[locale]/(app)/settings/blacklist/actions.ts (FITXER CORREGIT I NET)
"use server";

import { revalidatePath } from "next/cache";
import { validateUserSession } from "@/lib/supabase/session";

// âœ… 1. Importem el NOU servei
import * as blacklistService from '@/lib/services/settings/blacklist/blacklist.service';

// âœ… 2. Importem els tipus NOMÃ‰S PER A ÃšS INTERN
import type { FormState } from '@/lib/services/settings/blacklist/blacklist.service';

/**
 * Afegeix una nova regla a la blacklist per a l'equip actiu.
 */
export async function addRuleAction(formData: FormData): Promise<FormState> {
  // 1. ValidaciÃ³ de sessiÃ³
  const session = await validateUserSession();
  if ('error' in session) {
    return { success: false, message: session.error.message };
  }
  const { supabase, user, activeTeamId } = session;

  // 2. Crida al servei
  const result = await blacklistService.addRule(supabase, user, activeTeamId, formData);

  // 3. Efectes (revalidaciÃ³)
  if (result.success) {
    revalidatePath('/settings/blacklist');
  }

  return result;
}

/**
 * Elimina una regla de la blacklist.
 */
export async function deleteRuleAction(id: string): Promise<FormState> {
  // 1. ValidaciÃ³ de sessiÃ³
  const session = await validateUserSession();
  if ('error' in session) {
    return { success: false, message: session.error.message };
  }
  const { supabase, user, activeTeamId } = session;

  // 2. Crida al servei
  const result = await blacklistService.deleteRule(supabase, user, activeTeamId, id);

  // 3. Efectes (revalidaciÃ³)
  if (result.success) {
    revalidatePath('/settings/blacklist');
  }

  return result;
}

// =================== FILE: src/app/[locale]/(app)/settings/blacklist/page.tsx ===================

import { Suspense } from 'react';
import type { Metadata } from 'next';
import { getTranslations } from 'next-intl/server';
import { validatePageSession } from '@/lib/supabase/session';
import { hasPermission, PERMISSIONS, type Role } from '@/lib/permissions/permissions.config';
import { BlacklistData } from './_components/BlacklistData';
import { BlacklistSkeleton } from './_components/BlacklistSkeleton';
import { AccessDenied } from '@/components/shared/AccessDenied';

export const dynamic = 'force-dynamic';

// âœ… CORRECCIÃ“ CLAU: La propietat 'params' es defineix com una Promise.
type BlacklistPageProps = {
  params: Promise<{ locale: string }>; // <-- Ho definim com a Promise
};

export async function generateMetadata(props: BlacklistPageProps): Promise<Metadata> {
  // âœ… L'await Ã©s ara compatible amb el tipus.
  const { locale } = await props.params; 
  const t = await getTranslations({ locale, namespace: 'SettingsPage.blacklist' });
  return { title: `${t('metaTitle')} | Ribot` };
}


export default async function BlacklistPage() {
  // Aquesta funciÃ³ fa la validaciÃ³ i redirigeix si no Ã©s vÃ lid [5]
  const { supabase, user, activeTeamId } = await validatePageSession();

  // ComprovaciÃ³ de permisos (basada en el rol de l'usuari [6])
  const { data: member } = await supabase
    .from('team_members')
    .select('role')
    .match({ user_id: user.id, team_id: activeTeamId })
    .single();

  if (!hasPermission(member?.role as Role, PERMISSIONS.VIEW_BLACKLIST)) {
    // Si no tÃ© permÃ­s, mostrem el component AccessDenied [2, 7]
    return <AccessDenied message="No tens permisos per a veure aquesta secciÃ³." />;
  }

  // Renderitzem el component de dades dins d'un Suspense [2].
  // La cÃ rrega de dades real es farÃ  a BlacklistData [8].
  return (
    <div className="space-y-6">
      <Suspense fallback={<BlacklistSkeleton />}>
        <BlacklistData currentUserRole={(member?.role as Role) || null} />
      </Suspense>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/blacklist/_components/BlacklistClient.tsx ===================

// src/app/[locale]/(app)/settings/blacklist/_components/BlacklistClient.tsx

"use client";

import React, { useState, useTransition, useRef, useMemo } from 'react'; // Afegim useState i useMemo
import { motion } from 'framer-motion';
import { useTranslations } from 'next-intl';
import { toast } from 'sonner';
import { Loader2, Trash2, Search } from 'lucide-react'; // Afegim Search

import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardHeader } from "@/components/ui/card"; // Importem Card
import { EmptyState } from '@/components/shared/EmptyState';
import { addRuleAction, deleteRuleAction } from '../action';
import type { BlacklistRule } from '@/types/settings';
import { hasPermission, PERMISSIONS, type Role } from '@/lib/permissions/permissions.config';

interface BlacklistClientProps {
  initialRules: BlacklistRule[];
  currentUserRole: Role | null;
}

// Variants per a l'animaciÃ³ dels items (opcional, per a mÃ©s dinamisme)
const itemVariants = {
  hidden: { opacity: 0, y: 10 },
  visible: (i: number) => ({
    opacity: 1,
    y: 0,
    transition: {
      delay: i * 0.05, // Delay petit per a cada item
    },
  }),
  exit: { opacity: 0, y: -10 }, // AnimaciÃ³ en eliminar (necessita AnimatePresence)
};


export function BlacklistClient({ initialRules, currentUserRole }: BlacklistClientProps) {
  const t = useTranslations('SettingsPage.blacklist');
  const [isPending, startTransition] = useTransition();
  const formRef = useRef<HTMLFormElement>(null);
  const [searchTerm, setSearchTerm] = useState(''); // âœ… Estat per al cercador

  const canManage = hasPermission(currentUserRole, PERMISSIONS.MANAGE_BLACKLIST);

  // âœ… Filtrem les regles basant-nos en el searchTerm
  const filteredRules = useMemo(() => {
    if (!searchTerm) {
      return initialRules;
    }
    const lowerCaseSearch = searchTerm.toLowerCase();
    return initialRules.filter(rule =>
      rule.value.toLowerCase().includes(lowerCaseSearch) ||
      rule.rule_type.toLowerCase().includes(lowerCaseSearch)
    );
  }, [initialRules, searchTerm]);

  const handleAddSubmit = (formData: FormData) => {
    startTransition(async () => {
      const result = await addRuleAction(formData);
      if (result.success) {
        toast.success(t('toast.addSuccess'), { description: result.message });
        formRef.current?.reset();
      } else {
        toast.error(t('toast.error'), { description: result.message });
      }
    });
  };

  const handleDelete = (id: string) => {
    startTransition(async () => {
      const result = await deleteRuleAction(id);
      if (result.success) {
        toast.success(t('toast.deleteSuccess'), { description: result.message });
        // Nota: L'eliminaciÃ³ visual depÃ¨n de la revalidaciÃ³ del Server Component pare
      } else {
        toast.error(t('toast.error'), { description: result.message });
      }
    });
  };

  return (
    // âœ… Utilitzem Card en lloc de motion.div + glass-card
    <Card>
      <CardHeader>
        {/* Opcional: Podem moure el tÃ­tol/descripciÃ³ aquÃ­ si ho treiem del Server Component */}
        {/* <CardTitle>{t('cardTitle')}</CardTitle> */}
        {/* <CardDescription>{t('cardDescription')}</CardDescription> */}
        <div className="relative">
          {/* Formulari per afegir */}
          <form ref={formRef} action={handleAddSubmit} className="flex flex-col sm:flex-row gap-2 pt-4">
            {/* âœ… Input de Cerca */}

            <Search className="absolute left-3 translate-y-1/2 w-4 h-4 text-muted-foreground" />
            <Input
              type="text"
              placeholder={t('searchPlaceholder')}
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pl-9" // Padding esquerre per a la icona
              disabled={isPending}
            />

            <Input
              name="newRule"
              placeholder={t('placeholder')}
              required
              disabled={isPending || !canManage}
              className="flex-grow"
            />
            <Button type="submit" disabled={isPending || !canManage} className="w-full sm:w-auto">
              {isPending ? <Loader2 className="w-4 h-4 animate-spin" /> : t('addButton')}
            </Button>
          </form>

        </div>
      </CardHeader>
      <CardContent>
        {/* âœ… Llista en 2 columnes (en pantalles mitjanes i grans) */}
        <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-3">
          {filteredRules.length > 0 ? filteredRules.map((rule, index) => (
            // Opcional: Podem animar cada item individualment
            <motion.div
              key={rule.id}
              layout // Anima canvis de posiciÃ³ (requereix AnimatePresence si animem 'exit')
              variants={itemVariants}
              initial="hidden"
              animate="visible"
              exit="exit"
              custom={index} // Passa l'index per al delay escalonat
              className="flex justify-between items-center p-3 bg-muted/50 dark:bg-muted/20 rounded-lg border border-border/50"
            >
              <div className="flex items-center gap-2 overflow-hidden mr-2">
                <Badge variant={rule.rule_type === 'domain' ? 'default' : 'secondary'} className={undefined}>
                  {rule.rule_type}
                </Badge>
                {/* Trunca el text si Ã©s molt llarg */}
                <span className="text-sm truncate" title={rule.value}>{rule.value}</span>
              </div>
              {canManage && (
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => handleDelete(rule.id)}
                  disabled={isPending}
                  className="flex-shrink-0 w-8 h-8" // Mida mÃ©s petita per al botÃ³
                >
                  <Trash2 className="w-4 h-4 text-destructive" />
                </Button>
              )}
            </motion.div>
          )) : (
            // Mostra estat buit si no hi ha resultats *desprÃ©s* de filtrar
            !isPending && (
              <div className="md:col-span-2"> {/* Ocupa les dues columnes */}
                <EmptyState message={searchTerm ? t('emptySearch') : t('emptyTitle')} />
              </div>
            )
          )}
        </div>
        {/* Si la llista original estava buida */}
        {initialRules.length === 0 && !searchTerm && !isPending && (
          <div className="mt-6">
            <EmptyState message={t('emptyTitle')} />
          </div>
        )}
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/blacklist/_components/BlacklistData.tsx ===================

// src/app/[locale]/(app)/settings/blacklist/_components/BlacklistData.tsx (FITXER CORREGIT I NET)
import { getTranslations } from 'next-intl/server';
import { BlacklistClient } from './BlacklistClient';
import { validatePageSession } from '@/lib/supabase/session';
import type { Role } from '@/lib/permissions/permissions.config';

// âœ… 1. Importem el NOU servei i els seus tipus
import * as blacklistService from '@/lib/services/settings/blacklist/blacklist.service';

interface BlacklistDataProps {
  currentUserRole: Role | null;
}

export async function BlacklistData({ currentUserRole }: BlacklistDataProps) {
  const t = await getTranslations('SettingsPage.blacklist');
  
  // âœ… 2. ValidaciÃ³ de sessiÃ³ neta
  const { supabase, activeTeamId } = await validatePageSession();

  // âœ… 3. Crida al SERVEI per obtenir dades
  // Tota la lÃ²gica de 'select', 'filter' i 'map' s'ha mogut al servei.
  const formattedRules = await blacklistService.getBlacklistRules(
    supabase,
    activeTeamId
  );

  // 4. Renderitzat del Client Component
  return (
    <div>
      <h1 className="text-3xl font-bold mb-2">{t('pageTitle')}</h1>
      <p className="text-muted-foreground mb-8">{t('pageDescription')}</p>
      <BlacklistClient 
        initialRules={formattedRules} 
        currentUserRole={currentUserRole}
      />
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/blacklist/_components/BlacklistSkeleton.tsx ===================

"use client";

/**
 * @summary Mostra un esquelet de cÃ rrega per a la pÃ gina de la Blacklist.
 */
export function BlacklistSkeleton() {
  return (
    <div className="glass-card p-6 animate-pulse">
      {/* Esquelet de la descripciÃ³ */}
      <div className="space-y-2 mb-6">
        <div className="h-4 w-full bg-gray-700/50 rounded"></div>
        <div className="h-4 w-3/4 bg-gray-700/50 rounded"></div>
      </div>
      
      {/* Esquelet del formulari */}
      <div className="flex gap-2 mb-6">
        <div className="h-10 flex-1 bg-gray-700/50 rounded-md"></div>
        <div className="h-10 w-24 bg-gray-700/50 rounded-md"></div>
      </div>

      {/* Esquelet de la llista de regles */}
      <div className="space-y-2">
        {[...Array(3)].map((_, i) => (
          <div key={i} className="flex justify-between items-center p-2 h-10 bg-muted rounded-lg">
            <div className="flex items-center gap-2">
              <div className="h-6 w-16 bg-gray-700/50 rounded-full"></div>
              <div className="h-5 w-48 bg-gray-700/50 rounded-md"></div>
            </div>
            <div className="h-8 w-8 bg-gray-700/50 rounded-md"></div>
          </div>
        ))}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/customization/page.tsx ===================

import { Suspense } from 'react';
import type { Metadata } from 'next';
import { CustomizationData } from './_components/CustomizationData';
import { CustomizationSkeleton } from './_components/CustomizationSkeleton';

export const metadata: Metadata = {
  title: 'PersonalitzaciÃ³ | Ribot',
};

// â— Eliminem les definicions de Stage i Tag d'aquÃ­
// export type Stage = { id: string; name: string; };
// export type Tag = { id: string; name: string; color: string; };

export default function CustomizationPage() {
  return (
    <Suspense fallback={<CustomizationSkeleton />}>
      <CustomizationData />
    </Suspense>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/customization/_components/CustomizationClient.tsx ===================

"use client";

import { useState } from 'react';
import { motion } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { Plus, Trash, GripVertical, Settings, Palette, Languages, Network } from 'lucide-react';
import { useTranslations } from 'next-intl';

import { ThemeSwitcher } from '@/app/[locale]/(app)/settings/customization/_components/ThemeSwitcher';
import { LanguageSwitcher } from '@/app/[locale]/(app)/settings/customization/_components/LanguageSwitcher';
import { ModuleCard } from '@/components/shared/ModuleCard'; // Assegura't que la ruta sigui correcta
import { type Database } from '@/types/supabase';


type Stage = Database['public']['Tables']['pipeline_stages']['Row'];
type Tag = Database['public']['Tables']['contact_tags']['Row'];

// --- Sub-component per gestionar les etapes del Pipeline ---
function PipelineStagesManager({ initialStages }: { initialStages: Stage[] }) {
  const t = useTranslations('CustomizationPage');
  const [stages] = useState(initialStages);
  
  const handleNotImplemented = () => toast.info("Funcionalitat no implementada.");

  return (
    <ModuleCard title={t('pipelineTitle')} icon={Network} variant="default">
      <div className="space-y-3">
        {stages.map(stage => (
          <div key={stage.id} className="flex items-center gap-3 p-2 bg-muted dark:bg-muted/50 rounded-lg border">
            <GripVertical className="w-5 h-5 text-muted-foreground cursor-grab" />
            <p className="flex-1 font-medium">{stage.name}</p>
            <Button variant="ghost" size="icon" onClick={handleNotImplemented}>
              <Trash className="w-4 h-4 text-destructive" />
            </Button>
          </div>
        ))}
        <Button onClick={handleNotImplemented} variant="outline" className="w-full mt-4">
          <Plus className="w-4 h-4 mr-2" />{t('newStageButton')}
        </Button>
      </div>
    </ModuleCard>
  );
}

// --- Sub-component per gestionar les etiquetes ---
function ContactTagsManager({ initialTags }: { initialTags: Tag[] }) {
  const t = useTranslations('CustomizationPage');
  const [tags] = useState(initialTags);
  
  const handleNotImplemented = () => toast.info("Funcionalitat no implementada.");

  return (
    <ModuleCard title={t('tagsTitle')} icon={Palette} variant="default">
      <div className="flex flex-wrap gap-3">
        {tags.map(tag => (
          <div key={tag.id} className="flex items-center gap-2 pl-3 pr-2 py-1 rounded-full text-sm border font-medium" style={{ backgroundColor: `${tag.color}20`, borderColor: `${tag.color}40`, color: tag.color || undefined }}>
            <div className="w-2 h-2 rounded-full" style={{ backgroundColor: tag.color || undefined }} />
            <span>{tag.name}</span>
            <button onClick={handleNotImplemented} className="opacity-50 hover:opacity-100 transition-opacity">
              <Trash className="w-3.5 h-3.5" />
            </button>
          </div>
        ))}
      </div>
      <Button onClick={handleNotImplemented} variant="outline" className="w-full mt-6">
          <Plus className="w-4 h-4 mr-2" />{t('newTagButton')}
      </Button>
    </ModuleCard>
  );
}

// --- Component principal ---
export function CustomizationClient({ initialStages, initialTags }: { 
  initialStages: Stage[], 
  initialTags: Tag[] 
}) {
  const t = useTranslations('CustomizationPage');

  return (
    <motion.div 
      initial={{ opacity: 0, y: 20 }} 
      animate={{ opacity: 1, y: 0 }} 
      transition={{ duration: 0.5 }}
      className="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start"
    >
      {/* Columna principal */}
      <div className="lg:col-span-2 space-y-8">
        <PipelineStagesManager initialStages={initialStages} />
        <ContactTagsManager initialTags={initialTags} />
      </div>

      {/* Columna lateral */}
      <div className="lg:col-span-1 space-y-8">
        <ModuleCard title={t('themeTitle')} icon={Settings} variant="default" >
            <p className="text-sm text-muted-foreground mb-4">{t('themeDescription')}</p>
            <ThemeSwitcher />
        </ModuleCard>

        <ModuleCard title={t('languageTitle')} icon={Languages} variant="default">
            <p className="text-sm text-muted-foreground mb-4">{t('languageDescription')}</p>
            <LanguageSwitcher />
        </ModuleCard>
      </div>
    </motion.div>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/customization/_components/CustomizationData.tsx ===================

import { CustomizationClient } from './CustomizationClient';
import { validatePageSession } from '@/lib/supabase/session';
// âœ… 1. Importem els tipus directament de la definiciÃ³ de la BD
import { type Database } from '@/types/supabase';

// âœ… 2. Definim els tipus basats en les taules
type PipelineStageRow = Database['public']['Tables']['pipeline_stages']['Row'];
type ContactTagRow = Database['public']['Tables']['contact_tags']['Row'];


export async function CustomizationData() {
    const { supabase } = await validatePageSession();

    // Consultes (sense canvis)
    const [stagesRes, tagsRes] = await Promise.all([
        supabase.from('pipeline_stages').select('id, name, position').order('position'), // Afegim position si no hi era
        supabase.from('contact_tags').select('id, name, color')
    ]);

    if (stagesRes.error || tagsRes.error) {
        console.error('Error en carregar dades de personalitzaciÃ³:', stagesRes.error || tagsRes.error);
        throw new Error("No s'han pogut carregar les dades de personalitzaciÃ³. Intenta-ho de nou mÃ©s tard.");
    }

    // âœ… 3. Fem servir els tipus Row correctes per al cast
    return <CustomizationClient
        initialStages={(stagesRes.data as PipelineStageRow[]) || []}
        initialTags={(tagsRes.data as ContactTagRow[]) || []}
    />;
}

// =================== FILE: src/app/[locale]/(app)/settings/customization/_components/CustomizationSkeleton.tsx ===================

"use client";

export function CustomizationSkeleton() {
  return (
    <div className="space-y-8 animate-pulse">
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div className="glass-card p-6 h-48"></div>
        <div className="glass-card p-6 h-48"></div>
      </div>
      <div className="glass-card p-8 h-64"></div>
      <div className="glass-card p-8 h-64"></div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/customization/_components/LanguageSwitcher.tsx ===================

"use client";

import * as React from "react";
import { usePathname, useRouter } from "next/navigation";
import { useLocale } from "next-intl";
import { motion } from "framer-motion";
import { cn } from "@/lib/utils/utils";

const locales = [
  { code: "ca", label: "CA" },
  { code: "es", label: "ES" },
  { code: "en", label: "EN" },
];

export function LanguageSwitcher() {
  const router = useRouter();
  const pathname = usePathname();
  const currentLocale = useLocale();

  const onSelectChange = (nextLocale: string) => {
    // Treiem el locale actual del pathname per construir la nova ruta
    const newPath = pathname.startsWith(`/${currentLocale}`)
      ? pathname.substring(`/${currentLocale}`.length) || '/'
      : pathname;
    router.replace(`/${nextLocale}${newPath}`);
  };

  return (
    <div className="relative flex items-center p-1 bg-muted dark:bg-muted/50 rounded-lg">
      {locales.map(({ code, label }) => (
        <button
          key={code}
          onClick={() => onSelectChange(code)}
          className={cn(
            "relative flex-1 px-4 py-2 text-sm font-medium rounded-md z-10 transition-colors",
            currentLocale !== code && "text-muted-foreground hover:text-foreground"
          )}
        >
          {label}
        </button>
      ))}
      {/* Indicador lliscant */}
      <motion.div
        layoutId="language-switcher-active"
        className="absolute inset-0 h-full p-1 z-0"
        initial={{ x: locales.findIndex(l => l.code === currentLocale) * 100 + '%' }}
        animate={{ x: locales.findIndex(l => l.code === currentLocale) * (100 / locales.length) + '%' }}
        transition={{ type: "spring", stiffness: 300, damping: 30 }}
      >
        <div className="w-1/3 h-full bg-background rounded-md shadow-sm" />
      </motion.div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/customization/_components/ThemeSwitcher.tsx ===================

"use client";

import * as React from "react";
import { useTheme } from "next-themes";
import { motion } from "framer-motion";
import { Sun, Moon, Laptop } from "lucide-react";
import { cn } from "@/lib/utils/utils";

const themeOptions = [
  { theme: "light", label: "Clar", Icon: Sun },
  { theme: "dark", label: "Fosc", Icon: Moon },
  { theme: "system", label: "Sistema", Icon: Laptop },
];

export function ThemeSwitcher() {
  const { theme, setTheme } = useTheme();
  const [activeTheme, setActiveTheme] = React.useState(theme);

  React.useEffect(() => {
    setActiveTheme(theme);
  }, [theme]);

  return (
    <div className="relative flex items-center p-1 bg-muted dark:bg-muted/50 rounded-lg">
      {themeOptions.map(({ theme: optionTheme, label, Icon }) => (
        <button
          key={optionTheme}
          onClick={() => setTheme(optionTheme)}
          className={cn(
            "relative flex-1 flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium rounded-md z-10 transition-colors",
            activeTheme !== optionTheme && "text-muted-foreground hover:text-foreground"
          )}
        >
          <Icon className="w-4 h-4" />
          {label}
        </button>
      ))}
      {/* Indicador lliscant */}
      <motion.div
        layoutId="theme-switcher-active"
        className="absolute inset-0 h-full p-1 z-0"
        initial={{ x: themeOptions.findIndex(opt => opt.theme === activeTheme) * 100 + '%' }}
        animate={{ x: themeOptions.findIndex(opt => opt.theme === activeTheme) * (100 / themeOptions.length) + '%' }}
        transition={{ type: "spring", stiffness: 300, damping: 30 }}
      >
        <div className="w-1/3 h-full bg-background rounded-md shadow-sm" />
      </motion.div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/install/page.tsx ===================

import { getTranslations } from 'next-intl/server';
import { InstallationManager } from './_components/InstallationManager';

export default async function InstallPage() {
  const t = await getTranslations('SettingsPage.install');

  return (
    <div className="space-y-6">
      <div>
        <h3 className="text-xl font-medium">{t('title')}</h3>
        <p className="text-xm text-muted-foreground">{t('description')}</p>
      </div>
      <div className="border-t border-border pt-6">
        <InstallationManager
          texts={{
            install_button: t('install_button'),
            desktop_title: t('desktop_title'),
            desktop_instructions: t('desktop_instructions'),
            android_title: t('android_title'),
            android_instructions: t('android_instructions'),
            ios_title: t('ios_title'),
            ios_instructions: t('ios_instructions'),
            already_installed: t('already_installed'),
            connect_device_title: t('manual_install_title'),
          }}
        />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/install/_components/DeviceIcons.tsx ===================

// src/app/[locale]/(app)/settings/install/_components/DeviceIcons.tsx

import { Monitor, type LucideProps } from 'lucide-react';

// Icona per a Apple (iOS)
export const AppleIcon = (props: LucideProps) => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="24"
    height="24"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    strokeWidth="2"
    strokeLinecap="round"
    strokeLinejoin="round"
    {...props}
  >
    <path d="M12 20.94c1.5 0 2.75 1.06 4 1.06 3 0 6-8 6-12.22A4.91 4.91 0 0 0 17 5c-2.22 0-4 1.44-5 2-1-.56-2.78-2-5-2a4.9 4.9 0 0 0-5 4.78C2 14 5 22 8 22c1.25 0 2.5-1.06 4-1.06Z" />
    <path d="M10 2c1 .5 2 2 2 5" />
  </svg>
);

// âœ… ICONA D'ANDROID CORREGIDA: Utilitzem l'icona oficial.
export const AndroidIcon = (props: LucideProps) => (
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="24"
    height="24"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    strokeWidth="2"
    strokeLinecap="round"
    strokeLinejoin="round"
    {...props}
  >
    <path d="M17 9.5a5.5 5.5 0 1 0-10 0" />
    <path d="M12 15H4a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a2 2 0 0 0-2-2h-8" />
    <path d="M6 15V9" />
    <path d="M18 15V9" />
    <path d="M9 6.5l.5-.5" />
    <path d="M14.5 6l.5-.5" />
  </svg>
);

// Re-exportem Monitor per mantenir la consistÃ¨ncia
export const DesktopIcon = Monitor;

// =================== FILE: src/app/[locale]/(app)/settings/install/_components/InstallationManager.tsx ===================

'use client';

import { useState, useEffect, type FC, type ReactNode } from 'react';
import { Button } from '@/components/ui/button';
import { Download, CheckCircle, Star } from 'lucide-react';
import { motion } from 'framer-motion';
import { cn } from '@/lib/utils/utils';
import { ModuleCard } from '@/components/shared/ModuleCard'; // Assegura't que la ruta Ã©s correcta
import { AppleIcon, AndroidIcon, DesktopIcon } from './DeviceIcons';
import Image from 'next/image'; // âœ… Importem el component Image de Next.js


// =================================================================
// NOU: Subcomponent per a la previsualitzaciÃ³ del dispositiu
// =================================================================
const DevicePreview: FC<{ type: 'desktop' | 'mobile' }> = ({ type }) => (
  <div className="relative w-full max-w-[200px] aspect-[16/10] bg-gray-800/80 rounded-lg ring-2 ring-white/10 flex items-center justify-center mb-6">
    {/* Fons simulat */}
    <div className="absolute inset-0 bg-gradient-to-br from-white/50 to-purple-900/50 opacity-40" />

    {/* Icona de l'app */}
    <Image
      src="/apple-touch-icon.png" // Icona de la teva app a la carpeta /public
      alt="Icona de l'aplicaciÃ³"
      width={type === 'desktop' ? 48 : 56}
      height={type === 'desktop' ? 48 : 56}
      className="rounded-lg shadow-2xl"
    />

    {/* Marc del dispositiu */}
    {type === 'mobile' && <div className="absolute top-2 w-16 h-1.5 bg-white/50 rounded-full" />}
  </div>
);
interface InstallationManagerProps {
  texts: {
    install_button: string;
    desktop_title: string;
    desktop_instructions: string;
    android_title: string;
    android_instructions: string;
    ios_title: string;
    ios_instructions: string;
    already_installed: string;
    connect_device_title: string;
  };
}

interface BeforeInstallPromptEvent extends Event {
  readonly platforms: string[];
  readonly userChoice: Promise<{ outcome: 'accepted' | 'dismissed'; platform: string; }>;
  prompt(): Promise<void>;
}

// =================================================================
// Subcomponent per a la targeta d'instruccions
// =================================================================
interface InstructionCardProps {
  icon: ReactNode;
  title: string;
  instructions: string;
  buttonText?: string;
  onButtonClick?: () => void;
  isRecommended: boolean;
  variant: "sales" | "agenda" | "info"; // Reutilitzem variants de color existents, "info" substitueix "iphone"
  deviceType: 'desktop' | 'mobile'; // âœ… Nova prop per al tipus de dispositiu
}

const InstructionCard: FC<InstructionCardProps> = ({ icon, title, instructions, buttonText, onButtonClick, isRecommended, variant, deviceType }) => (<motion.div
  initial={{ opacity: 0, y: 20 }}
  animate={{ opacity: 1, y: 0 }}
  transition={{ duration: 0.5 }}
  className={cn("h-full", isRecommended && "ring-2 ring-offset-2 ring-offset-background ring-primary")}
>
  <ModuleCard title={title} icon={() => icon} variant={variant} className="h-full">
    {isRecommended && (
      <div className="absolute top-2 right-2 flex items-center gap-1 text-xs font-semibold bg-primary-foreground text-primary px-2 py-1 rounded-full">
        <Star className="w-3 h-3" /> Recomanat
      </div>
    )}
    <div className="flex flex-col h-full text-center items-center">
      {/* âœ… AFEGIDA LA PREVISUALITZACIÃ“ */}
      <DevicePreview type={deviceType} />
      <div
        className="prose prose-sm dark:prose-invert text-left text-muted-foreground mt-4"
        dangerouslySetInnerHTML={{ __html: instructions.replace(/\n/g, '<br />') }}
      />
      {buttonText && onButtonClick && (
        <Button onClick={onButtonClick} className="mt-auto font-bold transition-transform hover:scale-105">
          <Download className="mr-2 h-4 w-4" />
          {buttonText}
        </Button>
      )}
    </div>
  </ModuleCard>
</motion.div>
);

// =================================================================
// COMPONENT PRINCIPAL REDISSENYAT
// =================================================================
export function InstallationManager({ texts }: InstallationManagerProps) {
  const [installPrompt, setInstallPrompt] = useState<BeforeInstallPromptEvent | null>(null);
  const [isStandalone, setIsStandalone] = useState(false);
  const [userOS, setUserOS] = useState<'android' | 'ios' | 'desktop' | null>(null);

  useEffect(() => {
    if (window.matchMedia('(display-mode: standalone)').matches) {
      setIsStandalone(true);
    }

    const userAgent = window.navigator.userAgent.toLowerCase();
    if (/android/.test(userAgent)) setUserOS('android');
    else if (/iphone|ipad|ipod/.test(userAgent)) setUserOS('ios');
    else setUserOS('desktop');

    const handleBeforeInstallPrompt = (e: Event) => {
      e.preventDefault();
      setInstallPrompt(e as BeforeInstallPromptEvent);
    };

    window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
    return () => window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
  }, []);

  const handleInstallClick = async () => {
    if (!installPrompt) return;
    installPrompt.prompt();
    const { outcome } = await installPrompt.userChoice;
    if (outcome === 'accepted') {
      console.log('Usuari ha acceptat instalÂ·lar la PWA.');
      setInstallPrompt(null);
    }
  };

  if (isStandalone) {
    return (
      <motion.div
        initial={{ opacity: 0, scale: 0.95 }}
        animate={{ opacity: 1, scale: 1 }}
        className="flex flex-col items-center justify-center gap-4 rounded-lg bg-green-500/10 dark:bg-green-800/20 p-8 text-green-700 dark:text-green-300 ring-2 ring-green-500/20 text-center"
      >
        <CheckCircle className="h-16 w-16" />
        <h3 className="text-2xl font-bold">{texts.already_installed}</h3>
        <p className="text-sm text-green-600 dark:text-green-400/80 max-w-md">Ja estÃ s utilitzant l'aplicaciÃ³ instalÂ·lada. Gaudeix de la millor experiÃ¨ncia de RibotFlow!</p>
      </motion.div>
    );
  }

  const commonIconProps = { size: 24, className: 'text-primary-foreground/80' };

  return (
    <div className="space-y-6">
      <h4 className="text-lg font-semibold">{texts.connect_device_title}</h4>
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <InstructionCard
          icon={<DesktopIcon {...commonIconProps} />}
          title={texts.desktop_title}
          instructions={texts.desktop_instructions}
          buttonText={installPrompt && userOS === 'desktop' ? texts.install_button : undefined}
          onButtonClick={installPrompt && userOS === 'desktop' ? handleInstallClick : undefined}
          isRecommended={userOS === 'desktop'}
          variant="sales" // Blau
          deviceType="desktop" // âœ… Passem el tipus de dispositiu
        />
        <InstructionCard
          icon={<AndroidIcon {...commonIconProps} />}
          title={texts.android_title}
          instructions={texts.android_instructions}
          buttonText={installPrompt && userOS === 'android' ? texts.install_button : undefined}
          onButtonClick={installPrompt && userOS === 'android' ? handleInstallClick : undefined}
          isRecommended={userOS === 'android'}
          variant="agenda" // Verd
          deviceType="mobile" // âœ… Passem el tipus de dispositiu
        />
        <InstructionCard
          icon={<AppleIcon {...commonIconProps} />}
          title={texts.ios_title}
          instructions={texts.ios_instructions}
          isRecommended={userOS === 'ios'}
          variant="info" // SubstituÃ¯m "iphone" per "info"
          deviceType="mobile" // âœ… Passem el tipus de dispositiu
        />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/integrations/actions.ts ===================

// src/app/[locale]/(app)/settings/integrations/actions.ts (FITXER CORREGIT I NET)
"use server";

import { revalidatePath } from "next/cache";
import { redirect } from "next/navigation";
import { cookies } from "next/headers";
import { v4 as uuidv4 } from 'uuid';
import { validatePageSession, validateUserSession } from "@/lib/supabase/session";

// âŒ Eliminem importacions de: nodemailer, imap-simple, AES, ImapSmtpSchema

// âœ… 1. Importem el NOU servei i els seus tipus
import * as integrationsService from '@/lib/services/settings/integrations/integrations.service';
import type { ImapSmtpFormData } from './schemas';
import type { ImapFormState, DisconnectFormState } from '@/lib/services/settings/integrations/integrations.service';


// --- LÃ’GICA DE CONNEXIÃ“ OAUTH ---
// (AQUESTA PART ES MANTÃ‰ IGUAL, JA QUE Ã‰S LÃ’GICA DE FLUX/CONTROLADOR)

type OAuthProvider = 'google_gmail' | 'google_calendar' | 'microsoft' | 'linkedin' | 'facebook';

async function createOAuthRedirectAction(provider: OAuthProvider) {
    await validatePageSession();
    const cookieStore = cookies();
    const state = uuidv4();
    (await cookieStore).set('oauth_state', state, { path: '/', httpOnly: true, secure: process.env.NODE_ENV === 'production' });

    const redirectUri = `${process.env.NEXT_PUBLIC_SITE_URL}/api/oauth/callback/${provider}`;
    let authUrl = '';
    const params = new URLSearchParams({ state, redirect_uri: redirectUri });

    switch (provider) {
        case 'google_gmail':
            params.set('client_id', process.env.GOOGLE_CLIENT_ID!);
            params.set('response_type', 'code');
            params.set('scope', 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/gmail.send https://www.googleapis.com/auth/userinfo.email');
            params.set('access_type', 'offline');
            params.set('prompt', 'consent');
            authUrl = `https://accounts.google.com/o/oauth2/v2/auth?${params.toString()}`;
            break;
        
        case 'google_calendar':
            params.set('client_id', process.env.GOOGLE_CLIENT_ID!);
            params.set('response_type', 'code');
            params.set('scope', 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/userinfo.email');
            params.set('access_type', 'offline');
            params.set('prompt', 'consent');
            authUrl = `https://accounts.google.com/o/oauth2/v2/auth?${params.toString()}`;
            break;

        case 'microsoft':
            params.set('client_id', process.env.AZURE_CLIENT_ID!);
            params.set('response_type', 'code');
            params.set('scope', 'openid email offline_access User.Read Mail.Read Mail.Send');
            authUrl = `https://login.microsoftonline.com/common/oauth2/v2.0/authorize?${params.toString()}`;
            break;
        
        case 'linkedin':
            params.set('client_id', process.env.LINKEDIN_CLIENT_ID!);
            params.set('response_type', 'code');
            params.set('scope', 'openid profile email w_member_social');
            params.set('prompt', 'consent');
            authUrl = `https://www.linkedin.com/oauth/v2/authorization?${params.toString()}`;
            break;

        case 'facebook':
            const scopes = 'pages_show_list,pages_manage_posts,business_management,instagram_basic,instagram_content_publish';
            params.set('client_id', process.env.FACEBOOK_CLIENT_ID!);
            params.set('response_type', 'code');
            params.set('scope', scopes);
            authUrl = `https://www.facebook.com/v19.0/dialog/oauth?${params.toString()}`;
            break;
    }

    redirect(authUrl);
}

// Accions pÃºbliques de connexiÃ³ OAuth (sense canvis)
export async function connectGoogleGmailAction() { return createOAuthRedirectAction('google_gmail'); }
export async function connectGoogleCalendarAction() { return createOAuthRedirectAction('google_calendar'); }
export async function connectMicrosoftAction() { return createOAuthRedirectAction('microsoft'); }
export async function connectLinkedInAction() { return createOAuthRedirectAction('linkedin'); }
export async function connectFacebookAction() { return createOAuthRedirectAction('facebook'); }


// --- LÃ’GICA PER A IMAP/SMTP (REFACTORITZADA) ---

// âŒ Les funcions 'verifyImap' i 'verifySmtp' s'han mogut al servei.

export async function connectImapSmtpAction(formData: ImapSmtpFormData): Promise<ImapFormState> {
    // 1. ValidaciÃ³ de sessiÃ³
    const session = await validateUserSession();
    if ("error" in session) {
        return { success: false, message: "SessiÃ³ no vÃ lida." };
    }
    const { supabase, user } = session;

    // 2. Crida al servei
    // Tota la lÃ²gica de validaciÃ³, verificaciÃ³, encriptaciÃ³ i BBDD estÃ  al servei.
    const result = await integrationsService.connectImapSmtp(supabase, user, formData);
    
    // 3. Efectes (revalidaciÃ³)
    if (result.success) {
        revalidatePath('/settings/integrations');
    }

    return result;
}


// --- ACCIONS DE DESCONNEXIÃ“ (REFACTORITZADES) ---

async function handleDisconnect(provider: string): Promise<DisconnectFormState> {
    // 1. ValidaciÃ³ de sessiÃ³
    const session = await validateUserSession();
    if ("error" in session) {
        return { success: false, message: session.error.message };
    }
    const { supabase, user, activeTeamId } = session;

    // 2. Crida al servei
    const result = await integrationsService.disconnectIntegration(supabase, user, activeTeamId, provider);
    
    // 3. Efectes (revalidaciÃ³)
    if (result.success) {
        revalidatePath('/settings/integrations');
    }

    return result;
}

// Accions pÃºbliques de desconnexiÃ³ (ara criden al 'handleDisconnect' refactoritzat)
export async function disconnectGoogleGmailAction() { return await handleDisconnect('google_gmail'); }
export async function disconnectGoogleCalendarAction() { return await handleDisconnect('google_calendar'); }
export async function disconnectMicrosoftAction() { return await handleDisconnect('microsoft'); }
export async function disconnectLinkedInAction() { return await handleDisconnect('linkedin'); }
export async function disconnectFacebookAction() { return await handleDisconnect('facebook'); }
export async function disconnectCustomEmailAction() { return await handleDisconnect('custom_email'); }

// =================== FILE: src/app/[locale]/(app)/settings/integrations/page.tsx ===================

import { Suspense } from 'react';
import type { Metadata } from 'next';
import { getTranslations } from 'next-intl/server';
import { IntegrationsData } from './_components/IntegrationsData';
import { IntegrationsSkeleton } from './_components/IntegrationsSkeleton';

export async function generateMetadata(): Promise<Metadata> {
    const t = await getTranslations('SettingsPage.integrations');
    return { title: t('pageTitle') };
}

export default function IntegrationsPage() {
    return (
        <Suspense fallback={<IntegrationsSkeleton />}>
            <IntegrationsData />
        </Suspense>
    );
}

// =================== FILE: src/app/[locale]/(app)/settings/integrations/schemas.ts ===================

// src/app/[locale]/(app)/settings/integrations/schemas.ts
import { z } from 'zod';

// Aquest fitxer NO tÃ© "use server" perquÃ¨ s'utilitzarÃ  tant al client com al servidor.

export const ImapSmtpSchema = z.object({
  email: z.string().email({ message: "El correu electrÃ²nic no Ã©s vÃ lid." }),
  password: z.string().min(1, { message: "La contrasenya no pot estar buida." }),
  imapHost: z.string().min(1, { message: "El servidor IMAP Ã©s requerit." }),
  imapPort: z.coerce.number().min(1, { message: "El port IMAP Ã©s requerit." }),
  smtpHost: z.string().min(1, { message: "El servidor SMTP Ã©s requerit." }),
  smtpPort: z.coerce.number().min(1, { message: "El port SMTP Ã©s requerit." }),
});

export type ImapSmtpFormData = z.infer<typeof ImapSmtpSchema>;

// =================== FILE: src/app/[locale]/(app)/settings/integrations/_components/ImapSmtpDialog.tsx ===================

"use client";

import React, { useTransition } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { toast } from 'sonner';
import { useTranslations } from 'next-intl';

import { Button } from '@/components/ui/button';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
  DialogFooter,
  DialogClose
} from '@/components/ui/dialog';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Loader2 } from 'lucide-react';
import { ImapSmtpSchema, type ImapSmtpFormData } from '../schemas';
import { connectImapSmtpAction } from '../actions';

interface ImapSmtpDialogProps {
  children: React.ReactNode;
  onSuccess: () => void;
}

export function ImapSmtpDialog({ children, onSuccess }: ImapSmtpDialogProps) {
  const t = useTranslations('SettingsPage.integrations.customEmailDialog');
  const [isPending, startTransition] = useTransition();
  const [isOpen, setIsOpen] = React.useState(false);

  const form = useForm({
    resolver: zodResolver(ImapSmtpSchema),
    defaultValues: {
      email: '',
      password: '',
      imapHost: '',
      imapPort: 993,
      smtpHost: '',
      smtpPort: 465,
    },
  });


  const { register, handleSubmit, formState: { errors } } = form;

  const onSubmit = (data: ImapSmtpFormData) => {
    startTransition(async () => {
      const result = await connectImapSmtpAction(data);
      if (result.success) {
        toast.success(t('toast.success'), { description: result.message });
        onSuccess();
        setIsOpen(false);
        form.reset();
      } else {
        toast.error(t('toast.error'), { description: result.message || t('toast.genericError') });
      }
    });
  };

  return (
    <Dialog open={isOpen} onOpenChange={setIsOpen}>
      <DialogTrigger asChild>{children}</DialogTrigger>
      <DialogContent className="sm:max-w-[425px]">
        <DialogHeader>
          <DialogTitle>{t('title')}</DialogTitle>
          <DialogDescription>{t('description')}</DialogDescription>
        </DialogHeader>
        <form onSubmit={handleSubmit(onSubmit)}>
          <div className="grid gap-4 py-4">
            <div className="grid grid-cols-4 items-center gap-4">
              <Label htmlFor="email" className="text-right">
                {t('emailLabel')}
              </Label>
              <div className="col-span-3">
                <Input id="email" {...register('email')} />
                {errors.email && <p className="text-sm text-red-500 mt-1">{errors.email.message}</p>}
              </div>
            </div>
            <div className="grid grid-cols-4 items-center gap-4">
              <Label htmlFor="password" className="text-right">
                {t('passwordLabel')}
              </Label>
              <div className="col-span-3">
                <Input id="password" type="password" {...register('password')} />
                {errors.password && <p className="text-sm text-red-500 mt-1">{errors.password.message}</p>}
              </div>
            </div>
            <div className="grid grid-cols-4 items-center gap-4">
              <Label htmlFor="imapHost" className="text-right">
                {t('imapHostLabel')}
              </Label>
              <div className="col-span-3">
                <Input id="imapHost" {...register('imapHost')} placeholder="imap.exemple.com" />
                {errors.imapHost && <p className="text-sm text-red-500 mt-1">{errors.imapHost.message}</p>}
              </div>
            </div>
            <div className="grid grid-cols-4 items-center gap-4">
              <Label htmlFor="imapPort" className="text-right">
                {t('imapPortLabel')}
              </Label>
              <div className="col-span-3">
                <Input id="imapPort" type="number" {...register('imapPort')} />
                {errors.imapPort && <p className="text-sm text-red-500 mt-1">{errors.imapPort.message}</p>}
              </div>
            </div>
            <div className="grid grid-cols-4 items-center gap-4">
              <Label htmlFor="smtpHost" className="text-right">
                {t('smtpHostLabel')}
              </Label>
              <div className="col-span-3">
                <Input id="smtpHost" {...register('smtpHost')} placeholder="smtp.exemple.com" />
                {errors.smtpHost && <p className="text-sm text-red-500 mt-1">{errors.smtpHost.message}</p>}
              </div>
            </div>
            <div className="grid grid-cols-4 items-center gap-4">
              <Label htmlFor="smtpPort" className="text-right">
                {t('smtpPortLabel')}
              </Label>
              <div className="col-span-3">
                <Input id="smtpPort" type="number" {...register('smtpPort')} />
                {errors.smtpPort && <p className="text-sm text-red-500 mt-1">{errors.smtpPort.message}</p>}
              </div>
            </div>
          </div>
          <DialogFooter>
            <DialogClose asChild>
              <Button type="button" variant="secondary">{t('cancelButton')}</Button>
            </DialogClose>
            <Button type="submit" disabled={isPending}>
              {isPending && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
              {t('connectButton')}
            </Button>
          </DialogFooter>
        </form>
      </DialogContent>
    </Dialog>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/integrations/_components/IntegrationsClient.tsx ===================

// src/app/[locale]/(app)/settings/integrations/_components/IntegrationsClient.tsx
"use client";

import React, { useState, useTransition, useEffect } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import { motion } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { toast } from 'sonner';
import { CheckCircle, Loader2, XCircle, Mail } from 'lucide-react'; // âœ… NOU: Importem 'Calendar'
import {
    // âœ… NOU: Importem les accions actualitzades
    connectGoogleGmailAction, disconnectGoogleGmailAction,
    connectGoogleCalendarAction, disconnectGoogleCalendarAction,
    connectMicrosoftAction, disconnectMicrosoftAction,
    connectLinkedInAction, disconnectLinkedInAction,
    connectFacebookAction, disconnectFacebookAction,
    disconnectCustomEmailAction
} from '../actions';
import Image from 'next/image';
import { useTranslations } from 'next-intl';

import { ImapSmtpDialog } from './ImapSmtpDialog';

import instagram from '@/../public/instagram.jpeg';
import facebook from '@/../public/facebook.jpeg';
import linkedin from '@/../public/linkedin.png';
import iconGmail from '@/../public/IconGmail.webp';

interface IntegrationsClientProps {
    initialConnectionStatuses: {
        // âœ… NOU: Tipus actualitzat
        google_gmail: boolean;
        google_calendar: boolean;
        microsoft: boolean;
        linkedin: boolean;
        facebook: boolean;
        instagram: boolean;
        custom_email: boolean;
    };
}

// âœ… NOU: Tipus de Provider actualitzat
type Provider = 'google_gmail' | 'google_calendar' | 'microsoft' | 'linkedin' | 'facebook' | 'custom_email';

export function IntegrationsClient({ initialConnectionStatuses }: IntegrationsClientProps) {
    const t = useTranslations('SettingsPage.integrations');
    const router = useRouter();
    const pathname = usePathname();
    const searchParams = useSearchParams();

    const [connections, setConnections] = useState(initialConnectionStatuses);
    const [isPending, startTransition] = useTransition();

    const width = 34;
    const height = 34;

    useEffect(() => {
        const error = searchParams.get('error');
        const success = searchParams.get('success');

        if (error) {
            toast.error(t('toast.error'), { description: t('toast.genericError') });
        }
        if (success === 'true') {
            toast.success(t('toast.success'), { description: t('toast.connectedSuccess') });
            router.refresh();
        }

        if (error || success) {
            router.replace(pathname, { scroll: false });
        }
    }, [searchParams, router, pathname, t]);

    const handleConnect = (provider: Provider) => {
        startTransition(() => {
            // âœ… NOU: LÃ²gica de connexiÃ³ actualitzada
            if (provider === 'google_gmail') connectGoogleGmailAction();
            if (provider === 'google_calendar') connectGoogleCalendarAction();
            if (provider === 'microsoft') connectMicrosoftAction();
            if (provider === 'linkedin') connectLinkedInAction();
            if (provider === 'facebook') connectFacebookAction();
        });
    };

    const handleDisconnect = (provider: Provider) => {
        startTransition(async () => {
            const actionMap = {
                // âœ… NOU: Mapa d'accions actualitzat
                google_gmail: disconnectGoogleGmailAction,
                google_calendar: disconnectGoogleCalendarAction,
                microsoft: disconnectMicrosoftAction,
                linkedin: disconnectLinkedInAction,
                facebook: disconnectFacebookAction,
                custom_email: disconnectCustomEmailAction,
            };
            const result = await actionMap[provider]();

            if (result.success) {
                toast.success(result.message);
                if (provider === 'facebook') {
                    setConnections(prev => ({ ...prev, facebook: false, instagram: false }));
                } else {
                    setConnections(prev => ({ ...prev, [provider]: false }));
                }
                router.refresh();
            } else {
                toast.error(result.message);
            }
        });
    };

    const integrationList = [
        // âœ… NOU: Llista d'integracions actualitzada
        { name: 'google_gmail', title: t('googleTitle'), description: t('googleDescription'), icon: iconGmail },
        // HaurÃ s d'afegir 'googleCalendar.title' i 'googleCalendar.description' als teus fitxers de traducciÃ³ (p.ex. en.json)
        { name: 'google_calendar', title: t('googleCalendar.title'), description: t('googleCalendar.description'), icon: "https://upload.wikimedia.org/wikipedia/commons/a/a5/Google_Calendar_icon_%282020%29.svg" },
        { name: 'microsoft', title: t('microsoftTitle'), description: t('microsoftDescription'), icon: "https://img.icons8.com/?size=100&id=117562&format=png&color=000000" },
        { name: 'linkedin', title: t('linkedinTitle'), description: t('linkedinDescription'), icon: linkedin },
    ] as const;

    const handleCustomEmailSuccess = () => {
        setConnections(prev => ({ ...prev, custom_email: true }));
        router.refresh();
    }

    return (
        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
            <div className="glass-card p-4 sm:p-6 md:p-8 space-y-4">
                <h2 className="text-xl font-semibold mb-2">{t('title')}</h2>
                {/* IntegraciÃ³ Correu Personalitzat (sense canvis) */}
                <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 p-4 bg-muted/50 rounded-lg">
                    <div className="flex items-center gap-4">
                        <div className="flex-shrink-0 h-[34px] w-[34px] bg-primary/10 rounded-lg flex items-center justify-center">
                            <Mail className="h-5 w-5 text-primary" />
                        </div>
                        <div>
                            <h3 className="font-semibold">{t('customEmail.title')}</h3>
                            <p className="text-sm text-muted-foreground">{t('customEmail.description')}</p>
                        </div>
                    </div>
                    <div className="w-full sm:w-auto flex-shrink-0">
                        {connections.custom_email ? (
                            <div className="flex items-center justify-between w-full sm:gap-4">
                                <span className="flex items-center gap-2 text-green-500 text-sm"><CheckCircle className="w-5 h-5" /> {t('statusConnected')}</span>
                                <Button variant="destructive" size="sm" onClick={() => handleDisconnect('custom_email')} disabled={isPending}>
                                    {isPending && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
                                    <XCircle className="w-4 h-4 sm:mr-2" />
                                    <span className="hidden sm:inline">{t('disconnectButton')}</span>
                                </Button>
                            </div>
                        ) : (
                            <ImapSmtpDialog onSuccess={handleCustomEmailSuccess}>
                                <Button disabled={isPending} className="w-full">
                                    {isPending && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
                                    {t('connectButton')}
                                </Button>
                            </ImapSmtpDialog>
                        )}
                    </div>
                </div>

                {/* Llista d'integracions principals */}
                {integrationList.map((item) => (
                    <div key={item.name} className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 p-4 bg-muted/50 rounded-lg">
                        <div className="flex items-center gap-4">
                            <Image src={item.icon} width={width} height={height} alt={`${item.name} logo`} className="flex-shrink-0" unoptimized />
                            <div>
                                <h3 className="font-semibold">{item.title}</h3>
                                <p className="text-sm text-muted-foreground">{item.description}</p>
                            </div>
                        </div>
                        <div className="w-full sm:w-auto flex-shrink-0">
                            {/* âœ… NOU: LÃ²gica de connexiÃ³ actualitzada */}
                            {connections[item.name] ? (
                                <div className="flex items-center justify-between w-full sm:gap-4">
                                    <span className="flex items-center gap-2 text-green-500 text-sm"><CheckCircle className="w-5 h-5" /> {t('statusConnected')}</span>
                                    <Button variant="destructive" size="sm" onClick={() => handleDisconnect(item.name)} disabled={isPending}>
                                        {isPending && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
                                        <XCircle className="w-4 h-4 sm:mr-2" />
                                        <span className="hidden sm:inline">{t('disconnectButton')}</span>
                                    </Button>
                                </div>
                            ) : (
                                <form action={() => handleConnect(item.name)} className="w-full">
                                    <Button type="submit" disabled={isPending} className="w-full">
                                        {isPending && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
                                        {t('connectButton')}
                                    </Button>
                                </form>
                            )}
                        </div>
                    </div>
                ))}

                {/* SecciÃ³ de Meta (Facebook/Instagram) (sense canvis) */}
                <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 p-4 bg-muted/50 rounded-lg">
                    <div className="flex items-center gap-4">
                        <div className="flex -space-x-2 flex-shrink-0">
                            <Image src={facebook} width={width} height={height} alt="Facebook logo" className="rounded-full ring-2 ring-background" />
                            <Image src={instagram} width={width} height={height} alt="Instagram logo" className="rounded-full ring-2 ring-background" />
                        </div>
                        <div>
                            <h3 className="font-semibold">{t('metaTitle')}</h3>
                            <p className="text-sm text-muted-foreground">{t('metaDescription')}</p>
                        </div>
                    </div>
                    <div className="w-full sm:w-auto flex-shrink-0">
                        {connections.facebook ? (
                            <div className="flex items-center justify-between w-full sm:gap-4">
                                <span className="flex items-center gap-2 text-green-500 text-sm"><CheckCircle className="w-5 h-5" /> {t('statusConnected')}</span>
                                <Button variant="destructive" size="sm" onClick={() => handleDisconnect('facebook')} disabled={isPending}>
                                    {isPending && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
                                    <XCircle className="w-4 h-4 sm:mr-2" />
                                    <span className="hidden sm:inline">{t('disconnectButton')}</span>
                                </Button>
                            </div>
                        ) : (
                            <form action={() => handleConnect('facebook')} className="w-full">
                                <Button type="submit" disabled={isPending} className="w-full">
                                    {isPending && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
                                    {t('connectButton')} Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </Button>
                            </form>)}
                    </div>
                </div>
            </div>
        </motion.div>
    );
}

// =================== FILE: src/app/[locale]/(app)/settings/integrations/_components/IntegrationsData.tsx ===================

// src/app/[locale]/(app)/settings/integrations/_components/IntegrationsData.tsx (FITXER CORREGIT I NET)
import { validatePageSession } from "@/lib/supabase/session"; 
import { IntegrationsClient } from "./IntegrationsClient";
import { getTranslations } from "next-intl/server";

// âœ… 1. Importem el NOU servei
import * as integrationsService from '@/lib/services/settings/integrations/integrations.service';

export async function IntegrationsData() {
    const t = await getTranslations('SettingsPage.integrations');
    
    // âœ… 2. ValidaciÃ³ de sessiÃ³ neta
    const { supabase, user, activeTeamId } = await validatePageSession();

    // âœ… 3. Crida al SERVEI per obtenir dades
    // Tota la lÃ²gica de 'Promise.all', 'map' i 'Set' s'ha mogut al servei.
    const connectionStatuses = await integrationsService.getIntegrationStatuses(
      supabase,
      user.id,
      activeTeamId
    );

    // 4. Renderitzat del Client Component
    return (
        <div>
            <h1 className="text-3xl font-bold mb-8">{t('pageTitle')}</h1>
            <IntegrationsClient initialConnectionStatuses={connectionStatuses} />
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/settings/integrations/_components/IntegrationsSkeleton.tsx ===================

/**
 * @file IntegrationsSkeleton.tsx
 * @summary Mostra un esquelet de cÃ rrega per a la pÃ gina d'Integracions.
 */
"use client";

import { Skeleton } from '@/components/ui/skeleton';

export function IntegrationsSkeleton() {
  return (
    <div>
      {/* Esquelet per a la capÃ§alera */}
      <Skeleton className="h-9 w-1/2 mb-8" />
      
      {/* Esquelet per a la targeta d'integracions */}
      <div className="glass-card p-8 space-y-4 animate-pulse">
        <Skeleton className="h-7 w-1/3 mb-4" />
        {/* Esquelet per a la lÃ­nia de Google */}
        <div className="flex items-center justify-between p-4 bg-muted/50 rounded-lg">
          <div className="flex items-center gap-4">
            <Skeleton className="h-6 w-6 rounded-full" />
            <div className="space-y-2">
              <Skeleton className="h-5 w-24" />
              <Skeleton className="h-4 w-40" />
            </div>
          </div>
          <Skeleton className="h-9 w-28 rounded-md" />
        </div>
        {/* Esquelet per a la lÃ­nia de Microsoft */}
        <div className="flex items-center justify-between p-4 bg-muted/50 rounded-lg">
          <div className="flex items-center gap-4">
            <Skeleton className="h-6 w-6 rounded-full" />
            <div className="space-y-2">
              <Skeleton className="h-5 w-32" />
              <Skeleton className="h-4 w-48" />
            </div>
          </div>
          <Skeleton className="h-9 w-28 rounded-md" />
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/layout.tsx ===================

import React from 'react';

// Aquest layout ja no necessita crear la seva prÃ²pia estructura de columnes,
// ja que el layout principal de l'aplicaciÃ³ ('AppClientLayout') s'encarrega dels sidebars.
export default function SettingsLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  // Simplement retornem el contingut de la pÃ gina. El layout de nivell superior
  // el colÂ·locarÃ  automÃ ticament a l'Ã rea de contingut principal.
  // L'embolcallem en un 'div' per consistÃ¨ncia.
  return <div className="h-full">{children}</div>;
}

// =================== FILE: src/app/[locale]/(app)/settings/page.tsx ===================

// Aquest Ã©s un Server Component que gestiona la ruta arrel '/settings'.

import { redirect } from 'next/navigation';

/**
 * Aquesta pÃ gina no tÃ© contingut visual propi.
 * La seva Ãºnica funciÃ³ Ã©s redirigir l'usuari automÃ ticament
 * a la primera secciÃ³ de la configuraciÃ³, que Ã©s el perfil.
 * AixÃ² millora l'experiÃ¨ncia d'usuari, evitant que arribi a una pÃ gina '/settings' buida.
 */
export default function SettingsRootPage() {
  // 'redirect' Ã©s una funciÃ³ de Next.js que envia l'usuari a una altra URL.
  redirect('/settings/profile');
}

// =================== FILE: src/app/[locale]/(app)/settings/permissions/actions.ts ===================

// src/app/[locale]/(app)/settings/permissions/actions.ts (FITXER CORREGIT I NET)
"use server";

import { revalidatePath } from "next/cache";
import { validateUserSession } from '@/lib/supabase/session';

// âœ… 1. Importem el NOU servei
import * as permissionsService from '@/lib/services/settings/permissions/permissions.service';

// âœ… 2. Importem els tipus del servei
import type { Permission, FormState } from '@/lib/services/settings/permissions/permissions.service';

/**
 * Actualitza tots els permisos d'inbox per a l'equip actiu.
 */
export async function updateInboxPermissionsAction(permissions: Permission[]): Promise<FormState> {
  // 1. ValidaciÃ³ de sessiÃ³
  const session = await validateUserSession();
  if ('error' in session) {
    return { success: false, message: session.error.message };
  }
  const { supabase, user, activeTeamId } = session;

  // 2. Crida al servei
  // Tota la lÃ²gica (comprovaciÃ³ de rol, delete, insert) estÃ  ara al servei.
  const result = await permissionsService.updateInboxPermissions(
    supabase, 
    user, 
    activeTeamId, 
    permissions
  );

  // 3. Efectes (revalidaciÃ³)
  if (result.success) {
    revalidatePath('/settings/permissions');
  }

  return result;
}

// =================== FILE: src/app/[locale]/(app)/settings/permissions/page.tsx ===================

// src/app/[locale]/(app)/settings/permissions/page.tsx (FITXER CORREGIT I NET)
import { Suspense } from 'react';
import { Card, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { TriangleAlert } from "lucide-react";
import { validatePageSession } from '@/lib/supabase/session';
import type { Role } from '@/lib/permissions/permissions.config'; // Assegura't que Role s'exporta

// âœ… 1. Importem els NOUS components
import { PermissionsData } from './_components/PermissionsData';
import { PermissionsSkeleton } from './_components/PermissionsSkeleton';

export default async function PermissionsPage() {
  
  // 1. ValidaciÃ³ de sessiÃ³ i equip
  const { supabase, user, activeTeamId } = await validatePageSession();
  
  // 2. ComprovaciÃ³ de permisos a nivell de pÃ gina
  const { data: currentUserMember } = await supabase
    .from('team_members')
    .select('role')
    .eq('user_id', user.id)
    .eq('team_id', activeTeamId)
    .single();
  
  const userRole = (currentUserMember?.role as Role) || null;
  const canManagePermissions = userRole === 'owner' || userRole === 'admin';

  // 3. Renderitzat d'accÃ©s denegat (si no pot veure la pÃ gina)
  if (!canManagePermissions) {
    return (
      <Card className="max-w-lg mx-auto mt-10">
        <CardHeader className="text-center">
          <div className="mx-auto bg-destructive/10 p-3 rounded-full w-fit">
            <TriangleAlert className="w-8 h-8 text-destructive" />
          </div>
          <CardTitle className="mt-4">AccÃ©s Denegat</CardTitle>
          <CardDescription>
            NomÃ©s els propietaris i administradors de l'equip poden gestionar els permisos de la bÃºstia d'entrada.
          </CardDescription>
        </CardHeader>
      </Card>
    );
  }
  
  // 4. Renderitzat de la pÃ gina (NET)
  // Passem el rol al component de dades perquÃ¨ el client no hagi de tornar-lo a buscar
  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold">Permisos de l'Inbox</h1>
        <p className="text-muted-foreground mt-2">
          Selecciona les caselles per a permetre que un membre de l'equip pugui veure la bÃºstia de correu d'un altre.
        </p>
      </div>
      <div className="mt-8">
        <Suspense fallback={<PermissionsSkeleton />}>
          <PermissionsData currentUserRole={userRole} />
        </Suspense>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/permissions/_components/PermissionsClient.tsx ===================

// src/app/[locale]/(app)/settings/permissions/_components/PermissionsClient.tsx (FITXER CORREGIT)
"use client";

import { useState, useTransition } from 'react';
import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Card, CardContent, CardFooter } from '@/components/ui/card';
import { toast } from 'sonner';
import { updateInboxPermissionsAction } from '../actions';
import { Loader2 } from 'lucide-react';
import type { Role } from '@/lib/permissions/permissions.config'; // âœ… Importem Role

// âœ… 1. Definim tipus de dades clars (extrets del servei)
type Member = { id: string; full_name: string | null; email: string | null; };
type Permission = { grantee_user_id: string; target_user_id: string; };

// âœ… 2. Afegim 'currentUserRole' als props
export function PermissionsClient({ teamMembers, initialPermissions, currentUserRole }: {
  teamMembers: Member[];
  initialPermissions: Permission[];
  currentUserRole: Role | null;
}) {
  const [permissions, setPermissions] = useState<Permission[]>(initialPermissions);
  const [isPending, startTransition] = useTransition();

  // âœ… 3. Definim si es pot gestionar (doble comprovaciÃ³, coherent amb altres clients)
  const canManage = currentUserRole === 'owner' || currentUserRole === 'admin';

  const handlePermissionChange = (granteeId: string, targetId: string, isChecked: boolean) => {
    if (isChecked) {
      setPermissions(prev => [...prev, { grantee_user_id: granteeId, target_user_id: targetId }]);
    } else {
      setPermissions(prev => prev.filter(p => !(p.grantee_user_id === granteeId && p.target_user_id === targetId)));
    }
  };

  const handleSave = () => {
    startTransition(async () => {
      const result = await updateInboxPermissionsAction(permissions);
      if (result.success) {
        toast.success(result.message);
      } else {
        toast.error(result.message);
      }
    });
  };

  return (
    <Card>
      <CardContent className="p-0">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead className="w-[250px]">Membre de l'equip</TableHead>
              {teamMembers.map(targetUser => (
                <TableHead key={targetUser.id} className="text-center">
                  Pot veure la bÃºstia de <br/>
                  <span className="font-semibold">{targetUser.full_name || targetUser.email}</span>
                </TableHead>
              ))}
            </TableRow>
          </TableHeader>
          <TableBody>
            {teamMembers.map(granteeUser => (
              <TableRow key={granteeUser.id}>
                <TableCell className="font-semibold">{granteeUser.full_name || granteeUser.email}</TableCell>
                {teamMembers.map(targetUser => {
                  if (granteeUser.id === targetUser.id) {
                    return <TableCell key={targetUser.id} />;
                  }
                  const isChecked = permissions.some(p => p.grantee_user_id === granteeUser.id && p.target_user_id === targetUser.id);
                  return (
                    <TableCell key={targetUser.id} className="text-center">
                      <Checkbox
                        checked={isChecked}
                        onCheckedChange={(checked) => handlePermissionChange(granteeUser.id, targetUser.id, !!checked)}
                        // âœ… 4. Desactivem si no pot gestionar
                        disabled={!canManage || isPending}
                      />
                    </TableCell>
                  );
                })}
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </CardContent>
      <CardFooter className="flex justify-end p-4 border-t">
        {/* âœ… 5. Desactivem el botÃ³ si no pot gestionar */}
        <Button onClick={handleSave} disabled={isPending || !canManage}>
          {isPending && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
          Desar Permisos
        </Button>
      </CardFooter>
    </Card>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/permissions/_components/PermissionsData.tsx ===================

// src/app/[locale]/(app)/settings/permissions/_components/PermissionsData.tsx (FITXER NOU)
import { validatePageSession } from '@/lib/supabase/session';
import * as permissionsService from '@/lib/services/settings/permissions/permissions.service';
import { PermissionsClient } from './PermissionsClient';
import type { Role } from '@/lib/permissions/permissions.config';

interface PermissionsDataProps {
  currentUserRole: Role | null;
}

export async function PermissionsData({ currentUserRole }: PermissionsDataProps) {
  
  // 1. Obtenim 'supabase' i 'activeTeamId' per a la consulta
  const { supabase, activeTeamId } = await validatePageSession();

  // 2. Cridem al servei per obtenir les dades
  const { teamMembers, initialPermissions } = await permissionsService.getPermissionsPageData(
    supabase,
    activeTeamId
  );

  // 3. Passem les dades i el rol (que ja tenÃ­em) al component client
  return (
    <PermissionsClient
      teamMembers={teamMembers}
      initialPermissions={initialPermissions}
      currentUserRole={currentUserRole} // Passem el rol al client
    />
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/permissions/_components/PermissionsSkeleton.tsx ===================

// src/app/[locale]/(app)/settings/permissions/_components/PermissionsSkeleton.tsx (FITXER NOU)
import { Card, CardContent, CardFooter } from '@/components/ui/card';
import { Skeleton } from '@/components/ui/skeleton';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";

export function PermissionsSkeleton() {
  return (
    <Card>
      <CardContent className="p-0">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead className="w-[250px]"><Skeleton className="h-5 w-32" /></TableHead>
              <TableHead className="text-center"><Skeleton className="h-5 w-48 mx-auto" /></TableHead>
              <TableHead className="text-center"><Skeleton className="h-5 w-48 mx-auto" /></TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {[1, 2].map((granteeRow) => (
              <TableRow key={granteeRow}>
                <TableCell><Skeleton className="h-5 w-40" /></TableCell>
                <TableCell className="text-center"><Skeleton className="h-6 w-6 mx-auto" /></TableCell>
                <TableCell className="text-center"><Skeleton className="h-6 w-6 mx-auto" /></TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </CardContent>
      <CardFooter className="flex justify-end p-4 border-t">
        <Skeleton className="h-10 w-32" />
      </CardFooter>
    </Card>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/profile/actions.ts ===================

// src/app/[locale]/(app)/settings/profile/actions.ts (FITXER CORREGIT I NET)
"use server";

import { revalidatePath } from "next/cache";
import { validateUserSession } from "@/lib/supabase/session";
// âŒ Eliminem Zod i 'hasPermission', ja que ara viuen al servei.

// âœ… 1. Importem el NOU servei i els seus tipus
import * as profileService from '@/lib/services/settings/profile/profile.service';
import type { FormState } from '@/lib/services/settings/profile/profile.service';


/**
 * Actualitza les dades PERSONALS de l'usuari.
 */
export async function updateUserProfileAction(formData: FormData): Promise<FormState> {
  // 1. ValidaciÃ³ de sessiÃ³
  const session = await validateUserSession();
  if ('error' in session) return { success: false, message: session.error.message };
  const { supabase, user } = session;

  // 2. Crida al servei
  const result = await profileService.updateUserProfile(supabase, user, formData);

  // 3. Efectes (revalidaciÃ³)
  if (result.success) {
    revalidatePath('/settings/profile');
  }

  return result;
}

// âŒ Eliminem el 'TeamSchema' d'aquÃ­.

/**
 * Actualitza les dades DE L'EMPRESA de l'equip actiu.
 */
export async function updateTeamAction(formData: FormData): Promise<FormState> {
  // 1. ValidaciÃ³ de sessiÃ³
  const session = await validateUserSession();
  if ('error' in session) return { success: false, message: session.error.message };
  const { supabase, user, activeTeamId } = session;

  // 2. Crida al servei
  // Tota la lÃ²gica de permisos, Zod i BBDD estÃ  al servei.
  const result = await profileService.updateTeamProfile(supabase, user, activeTeamId, formData);

  // 3. Efectes (revalidaciÃ³)
  if (result.success) {
    revalidatePath('/settings/profile');
  }

  return result;
}

// =================== FILE: src/app/[locale]/(app)/settings/profile/page.tsx ===================

import { getTranslations } from "next-intl/server";
import { ProfileData } from "./_components/ProfileData";
import { Suspense } from "react";

// Aquest Ã©s un exemple de com hauria de ser una pÃ gina de contingut
// dins de la secciÃ³ de configuraciÃ³.
export default async function ProfilePage() {
  const t = await getTranslations('SettingsPage.nav');

  return (
    <div className="">
      {/* âœ… NOU: Afegim el tÃ­tol aquÃ­, perÃ² nomÃ©s el mostrem en pantalles petites (lg:hidden)
          perquÃ¨ en escriptori ja apareix al menÃº lateral. */}
      <h1 className="text-3xl font-bold lg:hidden">{t('title')}</h1>
      
      {/* El teu contingut, com el formulari de perfil, va aquÃ­ */}
      <Suspense fallback={<div>Carregant perfil...</div>}>
        <ProfileData />
      </Suspense>
    </div>
  );
}


// =================== FILE: src/app/[locale]/(app)/settings/profile/_components/ProfileData.tsx ===================

// src/app/[locale]/(app)/settings/profile/_components/ProfileData.tsx (FITXER CORREGIT I NET)
import { validatePageSession } from '@/lib/supabase/session';
import { ProfileForm } from "./ProfileForm";
import type { Role } from '@/lib/permissions/permissions.config';

// âœ… 1. Importem el NOU servei i els tipus de domini
import * as profileService from '@/lib/services/settings/profile/profile.service';
import type { Profile, Team } from "@/types/settings"; // Assegurem que importem Profile

export async function ProfileData() {
  
  const { supabase, user } = await validatePageSession();
  const activeTeamId = user.app_metadata.active_team_id || null;

  // 2. Cridem al SERVEI per obtenir dades
  const { profile, team, role } = await profileService.getProfilePageData(
    supabase,
    user,
    activeTeamId
  );

  // âœ… 3. AQUESTA Ã‰S LA CORRECCIÃ“ DE L'ERROR
  // Creem un objecte 'default' que satisfÃ  el tipus 'Profile' complet
  const defaultProfile: Profile = {
    id: user.id,
    full_name: '',
    phone: null,
    job_title: null,
    avatar_url: null,
    onboarding_completed: false,
    // Afegeix aquÃ­ qualsevol altra propietat no-nulÂ·la que 'Profile' pugui requerir
    // per exemple, si 'created_at' fos requerit (tot i que normalment Ã©s opcional):
    // created_at: new Date().toISOString(), 
  };

  // 4. Renderitzat del Client Component
  // Passem el 'profile' real si existeix, o el 'defaultProfile' complet si no.
  return (
    <ProfileForm 
      email={user.email || ''}
      profile={profile || defaultProfile} // âœ… Ara sempre Ã©s un tipus 'Profile' vÃ lid
      team={team as Team | null} // 'team' pot ser null
      role={role}
    />
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/profile/_components/ProfileForm.tsx ===================

"use client";

import React from 'react';
import { motion } from 'framer-motion';
import Image from 'next/image';
import { useTranslations } from 'next-intl';
import { Loader2, Upload, User, Building, Settings } from "lucide-react";

// Imports de UI
import { Button } from "@/components/ui/button";
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { ModuleCard } from '@/components/shared/ModuleCard';
import { LanguageSwitcher } from '../../customization/_components/LanguageSwitcher';
import { ThemeSwitcher } from '../../customization/_components/ThemeSwitcher'; 

// Imports de LÃ²gica
import type { Profile, Team } from '@/types/settings';
import { hasPermission, PERMISSIONS, Role } from '@/lib/permissions/permissions.config';
import { useProfileForm } from '../_hooks/useProfileForm'; // â­ï¸ Importem el nou Hook

interface ProfileFormProps {
  email: string;
  profile: Profile;
  team: Team | null;
  role: Role | null;
}

export function ProfileForm({ email, profile, team, role }: ProfileFormProps) {
  const t = useTranslations('SettingsPage.SettingsProfile');
  
  // â­ï¸ Tota la lÃ²gica complexa ara viu dins d'aquest hook
  const {
    isProfilePending,
    isTeamPending,
    isUploading,
    logoUrl,
    handleLogoUpload,
    handleUpdateProfile,
    handleUpdateTeam
  } = useProfileForm({ team });

  const canManageTeam = hasPermission(role, PERMISSIONS.MANAGE_TEAM_PROFILE);

  return (
    <motion.div 
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      className="grid grid-cols-1 lg:grid-cols-5 gap-8 items-start"
    >
      {/* --- Columna Esquerra --- */}
      <div className="lg:col-span-2 space-y-8">
        <form action={handleUpdateProfile}>
          <ModuleCard title={t('personalProfile.title')} icon={User} isCollapsible={false}>
            <div className="space-y-4">
              <div className="space-y-2">
                <Label>{t('personalProfile.emailLabel')}</Label>
                <Input type="email" value={email} disabled />
              </div>
              <div className="space-y-2">
                <Label htmlFor="full_name">{t('personalProfile.fullNameLabel')}</Label>
                <Input id="full_name" name="full_name" defaultValue={profile?.full_name || ''} />
              </div>
              <div className="space-y-2">
                <Label htmlFor="phone">{t('personalProfile.phoneLabel')}</Label>
                <Input id="phone" name="phone" defaultValue={profile?.phone || ''} />
              </div>
              <div className="space-y-2">
                <Label htmlFor="job_title">{t('personalProfile.jobTitleLabel')}</Label>
                <Input id="job_title" name="job_title" defaultValue={profile?.job_title || ''} placeholder={t('personalProfile.jobTitlePlaceholder')} />
              </div>
            </div>
            <div className="mt-6 flex justify-end">
              <Button type="submit" disabled={isProfilePending}>{isProfilePending ? t('personalProfile.savingButton') : t('personalProfile.saveButton')}</Button>
            </div>
          </ModuleCard>
        </form>

        <ModuleCard title={t('preferences.title')} icon={Settings} isCollapsible={false}>
          {/* âœ… Aquest Ã©s el bloc que es va trencar. Ara Ã©s correcte. */}
          <div className="space-y-6">
            <div>
              <Label className="text-sm font-medium">{t('preferences.themeTitle')}</Label>
              <p className="text-sm text-muted-foreground mb-3">{t('preferences.themeDescription')}</p>
              <ThemeSwitcher />
            </div>
            <div>
              <Label className="text-sm font-medium">{t('preferences.languageTitle')}</Label>
              <p className="text-sm text-muted-foreground mb-3">{t('preferences.languageDescription')}</p>
              <LanguageSwitcher />
            </div>
          </div>
        </ModuleCard>
      </div>

      {/* --- Columna Dreta --- */}
      <div className="lg:col-span-3">
        {canManageTeam && team && (
          <form action={handleUpdateTeam}>
            <ModuleCard title={t('companyProfile.title')} icon={Building} isCollapsible={false}>
              <p className="text-sm text-muted-foreground mb-6">{t('companyProfile.description')}</p>
              
              <div className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {/* ... Tots els altres camps (nom, tax_id, email, etc) ... */}
                  <div className="space-y-2">
                    <Label htmlFor="name">{t('companyProfile.nameLabel')}</Label>
                    <Input id="name" name="name" defaultValue={team.name || ''} />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="tax_id">{t('companyProfile.taxIdLabel')}</Label>
                    <Input id="tax_id" name="tax_id" defaultValue={team.tax_id || ''} />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="company_email">{t('companyProfile.emailLabel')}</Label>
                    <Input id="company_email" name="company_email" type="email" defaultValue={team.email || ''} />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="company_phone">{t('companyProfile.phoneLabel')}</Label>
                    <Input id="company_phone" name="company_phone" defaultValue={team.phone || ''} />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="sector">{t('companyProfile.sectorLabel')}</Label>
                    <Input id="sector" name="sector" defaultValue={team.sector || ''} placeholder={t('companyProfile.sectorPlaceholder')} />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="country">{t('companyProfile.countryLabel')}</Label>
                    <Input id="country" name="country" defaultValue={team.country || ''} />
                  </div>
                  <div className="md:col-span-2 space-y-2">
                    <Label htmlFor="street">{t('companyProfile.addressLabel')}</Label>
                    <Input id="street" name="street" defaultValue={team.street || ''} placeholder={t('companyProfile.addressPlaceholder')} />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="city">{t('companyProfile.cityLabel')}</Label>
                    <Input id="city" name="city" defaultValue={team.city || ''} />
                  </div>
                  <div className="space-y-2">
                    <Label htmlFor="postal_code">{t('companyProfile.postalCodeLabel')}</Label>
                    <Input id="postal_code" name="postal_code" defaultValue={team.postal_code || ''} />
                  </div>
                  <div className="md:col-span-2 space-y-2">
                    <Label htmlFor="website">{t('companyProfile.websiteLabel')}</Label>
                    <Input id="website" name="website" type="url" defaultValue={team.website || ''} placeholder={t('companyProfile.websitePlaceholder')} />
                  </div>
                  <div className="md:col-span-2 space-y-2">
                    <Label htmlFor="summary">{t('companyProfile.summaryLabel')}</Label>
                    <Textarea id="summary" name="summary" defaultValue={team.summary || ''} placeholder={t('companyProfile.summaryPlaceholder')} rows={3} />
                  </div>
                </div>
                <div className="space-y-2">
                  <Label>{t('companyProfile.logoLabel')}</Label>
                  <div className="flex items-center gap-4">
                    {/* Aquest 'Image' ara s'actualitzarÃ  en temps real grÃ cies a l'estat 'logoUrl' del hook */}
                    {logoUrl ? <Image src={logoUrl} alt="Logo" width={56} height={56} className="object-contain rounded-lg border p-1 bg-white" /> : <div className="h-14 w-14 bg-muted rounded-lg flex items-center justify-center text-muted-foreground">Logo</div>}
                    <Button asChild variant="outline">
                      <label htmlFor="logo-upload" className="cursor-pointer">
                        {/* âœ… Aquest Ã©s l'altre bloc que es va trencar. Ara Ã©s correcte. */}
                        {isUploading ? <Loader2 className="animate-spin" /> : <Upload className="w-4 h-4 mr-2" />} {t('companyProfile.changeLogoButton')}
                      </label>
                    </Button>
                    <input id="logo-upload" type="file" accept="image/*" className="hidden" onChange={handleLogoUpload} disabled={isUploading} />
                  </div>
                </div>
              </div>
              <div className="mt-8 flex justify-end">
                <Button type="submit" disabled={isTeamPending}>{isTeamPending ? t('companyProfile.savingButton') : t('companyProfile.saveButton')}</Button>
              </div>
            </ModuleCard>
          </form>
        )}
      </div>
    </motion.div>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/profile/_components/ProfileSkeleton.tsx ===================

"use client";

const SkeletonCard = ({ lines }: { lines: number }) => (
  <div className="border bg-card text-card-foreground shadow-sm rounded-lg animate-pulse">
    <div className="p-6 space-y-2">
      <div className="h-6 w-1/3 bg-gray-700/50 rounded-md"></div>
      <div className="h-4 w-2/3 bg-gray-700/50 rounded-md"></div>
    </div>
    <div className="p-6 pt-0 space-y-6">
      {[...Array(lines)].map((_, i) => (
        <div key={i} className="space-y-2">
          <div className="h-4 w-1/4 bg-gray-700/50 rounded-md"></div>
          <div className="h-10 w-full bg-gray-700/50 rounded-md"></div>
        </div>
      ))}
    </div>
  </div>
);

/**
 * @summary Mostra un esquelet de cÃ rrega per a la pÃ gina d'ediciÃ³ del perfil.
 */
export function ProfileSkeleton() {
  return (
    <div className="space-y-8">
      <SkeletonCard lines={3} />
      <SkeletonCard lines={2} />
      <div className="flex justify-end pt-4">
        <div className="h-10 w-32 bg-gray-700/50 rounded-md"></div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/profile/_hooks/useProfileForm.ts ===================

'use client';

import { useState, useTransition, useCallback } from 'react';
import { toast } from 'sonner';
import { useTranslations } from 'next-intl';

import { createClient } from '@/lib/supabase/client';
import { updateUserProfileAction, updateTeamAction } from '../actions';
import type { Team } from '@/types/settings';

interface UseProfileFormProps {
  team: Team | null;
}

export function useProfileForm({ team }: UseProfileFormProps) {
  const t = useTranslations('SettingsPage.SettingsProfile');
  
  // Estats i Transicions
  const [isProfilePending, startProfileTransition] = useTransition();
  const [isTeamPending, startTeamTransition] = useTransition();
  const [isUploading, setIsUploading] = useState(false);
  
  // Estat local per al logo, inicialitzat amb el valor del 'team'
  const [logoUrl, setLogoUrl] = useState(team?.logo_url || null);
  
  // --- Gestor de CÃ rrega del Logo ---
  const handleLogoUpload = useCallback(async (event: React.ChangeEvent<HTMLInputElement>) => {
    // ğŸ‘ˆ DEBUG 1: Comprovem que la funciÃ³ s'executa
    console.log('[DEBUG] Iniciant handleLogoUpload...');
    
    const file = event.target.files?.[0];
    if (!file || !team) {
      console.warn('[DEBUG] No hi ha fitxer o no hi ha equip.');
      return;
    }

    setIsUploading(true);
    const supabase = createClient();
    
    const bucketName = 'assets-publics'; 
    const newFilePath = `logos/${team.id}/logo-${Date.now()}-${file.name}`;
    const oldLogoUrl = logoUrl; // El 'logoUrl' de l'estat d'aquest hook

    // ğŸ‘ˆ DEBUG 2: Comprovem les dades abans de pujar
    console.log(`[DEBUG] Pujant a Bucket: ${bucketName}`);
    console.log(`[DEBUG] FilePath NOU: ${newFilePath}`);
    console.log(`[DEBUG] FilePath ANTIC (per esborrar): ${oldLogoUrl}`);

    // --- 2. Pujar el fitxer NOU ---
    const { error: uploadError } = await supabase.storage
      .from(bucketName)
      .upload(newFilePath, file, {
        cacheControl: '3600', 
      });

    // ğŸ‘ˆ DEBUG 3: AQUEST Ã‰S EL PUNT MÃ‰S IMPORTANT (PUJADA)
    if (uploadError) {
      console.error('[DEBUG] ERROR en la pujada (uploadError):', uploadError);
      toast.error(t('toasts.logoUploadErrorTitle'), { description: uploadError.message });
      setIsUploading(false);
      return; // La funciÃ³ mor aquÃ­
    }
    
    console.log('[DEBUG] Pujada a Storage completada amb Ã¨xit.');

    // --- 3. Obtenir la URL pÃºblica del NOU fitxer ---
    const { data: publicUrlData } = supabase.storage
      .from(bucketName)
      .getPublicUrl(newFilePath);

    // ğŸ‘ˆ DEBUG 4: Comprovem la URL pÃºblica
    if (!publicUrlData) {
      console.error('[DEBUG] ERROR: No s\'ha pogut obtenir la URL pÃºblica (publicUrlData Ã©s null).');
      toast.error(t('toasts.logoUploadErrorTitle'), { description: "No s'ha pogut obtenir la URL pÃºblica del nou logo." });
      setIsUploading(false);
      return;
    }

    const newLogoUrl = publicUrlData.publicUrl;
    console.log('[DEBUG] URL PÃºblica obtinguda:', newLogoUrl);

    // --- 4. Actualitzar l'estat local i notificar ---
    setLogoUrl(newLogoUrl); // âœ… Actualitzem l'estat local del hook
    console.log('[DEBUG] setLogoUrl cridat amb Ã¨xit.'); // ğŸ‘ˆ DEBUG 5
    toast.success(t('toasts.logoUploadSuccess'));

    // --- 5. Esborrar el fitxer ANTIC (si existia) ---
    if (oldLogoUrl) {
      try {
        const urlParts = oldLogoUrl.split(`/${bucketName}/`);
        if (urlParts.length > 1) {
          const oldFilePath = urlParts[1]; 
          const decodedOldFilePath = decodeURIComponent(oldFilePath);

          console.log("[DEBUG] Esborrant logo antic:", decodedOldFilePath);
          
          supabase.storage
            .from(bucketName)
            .remove([decodedOldFilePath])
            .then(({ error: removeError }) => {
              if (removeError) {
                console.warn("[DEBUG] No s'ha pogut esborrar el logo antic:", removeError.message);
              } else {
                console.log("[DEBUG] Logo antic esborrat amb Ã¨xit.");
              }
            });
        }
      } catch (e) {
        console.warn("[DEBUG] Error en processar l'antiga URL del logo per esborrar:", e);
      }
    }

    setIsUploading(false);
  }, [team, logoUrl, t]); // Afegim dependÃ¨ncies

  // --- Gestor d'actualitzaciÃ³ del Perfil ---
  const handleUpdateProfile = (formData: FormData) => {
    startProfileTransition(async () => {
      const result = await updateUserProfileAction(formData);
      if (result.success) toast.success(result.message);
      else toast.error(result.message);
    });
  };

  // --- Gestor d'actualitzaciÃ³ de l'Equip ---
  const handleUpdateTeam = (formData: FormData) => {
    // ğŸ‘ˆ DEBUG 6: AQUEST Ã‰S EL SEGON PUNT MÃ‰S IMPORTANT (DESAR)
    console.log(`[DEBUG] Enviant al servidor (handleUpdateTeam). Valor de logoUrl:`, logoUrl || 'null o buit');
    
    startTeamTransition(async () => {
      // Agafa la URL de l'estat del hook i l'afegeix al FormData
      formData.set('logo_url', logoUrl || ''); 
      const result = await updateTeamAction(formData);
      if (result.success) toast.success(result.message);
      else toast.error(result.message);
    });
  };

  // Retornem tot el que el component necessita
  return {
    isProfilePending,
    isTeamPending,
    isUploading,
    logoUrl,
    handleLogoUpload,
    handleUpdateProfile,
    handleUpdateTeam
  };
}

// =================== FILE: src/app/[locale]/(app)/settings/team/actions.ts ===================

// /app/[locale]/settings/team/actions.ts (FITXER CORREGIT I NET)
"use server";

import { createClient } from "@/lib/supabase/server";
import { redirect } from "next/navigation";
import { revalidatePath } from "next/cache";
import { validateUserSession } from "@/lib/supabase/session";
import { PERMISSIONS, validateSessionAndPermission, Role } from '@/lib/permissions/permissions';

// âœ… 1. Importem el NOU servei i els seus tipus de retorn
import * as teamService from '@/lib/services/settings/team/team.service';
import type { FormState } from '@/lib/services/settings/team/team.service';

// --- Accions del "Lobby" / Hub ---

export async function createTeamAction(formData: FormData) {
  const teamName = formData.get('teamName') as string;
  if (!teamName || teamName.trim().length < 2) {
    return { success: false, message: "El nom de l'equip Ã©s obligatori." };
  }

  const session = await validateUserSession(); // Necessari per al 'auth.uid()' del RPC
  if ('error' in session) return { success: false, message: session.error.message };
  
  const { supabase } = session;
  const result = await teamService.createTeam(supabase, teamName);

  if (result.success) {
    revalidatePath('/settings/team');
    return redirect('/settings/team'); // El redirect es queda aquÃ­
  }
  return result;
}

export async function resolveInvitationAction(token: string) {
  // Aquesta acciÃ³ Ã©s pÃºblica, no necessita sessiÃ³
  const { redirectUrl } = await teamService.resolveInvitation(token);
  return redirect(redirectUrl);
}

export async function acceptInviteAction(token: string) {
  const supabase = createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return redirect(`/login?invite_token=${token}&message=Has d'iniciar sessiÃ³ per acceptar.`);
  }

  const { redirectUrl } = await teamService.acceptInvite(supabase, user, token);
  return redirect(redirectUrl);
}

export async function switchActiveTeamAction(teamId: string): Promise<FormState> {
  const supabase = createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return { success: false, message: "Usuari no autenticat." };

  const result = await teamService.switchActiveTeam(supabase, user, teamId);
  if (result.success) {
    revalidatePath('/', 'layout');
  }
  return result;
}

export async function clearActiveTeamAction(): Promise<FormState> {
  const session = await validateUserSession();
  if ('error' in session) return { success: false, message: session.error.message };

  const result = await teamService.clearActiveTeam(session.user);
  if (result.success) {
    revalidatePath('/settings/team', 'page');
  }
  return result;
}

export async function acceptPersonalInviteAction(invitationId: string): Promise<FormState> {
  const supabase = createClient();
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return { success: false, message: "Has d'iniciar sessiÃ³ per a acceptar una invitaciÃ³." };
  }

  // L'RPC 'accept_personal_invitation' utilitza auth.uid(), per aixÃ² la sessiÃ³ Ã©s suficient
  const result = await teamService.acceptPersonalInvite(supabase, invitationId);
  if (result.success) {
    revalidatePath('/settings/team');
  }
  return result;
}

export async function declinePersonalInviteAction(invitationId: string): Promise<FormState> {
  const session = await validateUserSession();
  if ('error' in session) return { success: false, message: session.error.message };

  const result = await teamService.declinePersonalInvite(session.supabase, session.user, invitationId);
  if (result.success) {
    revalidatePath('/settings/team');
  }
  return result;
}


// --- Accions del Panell de GestiÃ³ de l'Equip ---

export async function inviteUserAction(formData: FormData): Promise<FormState> {
  const validation = await validateSessionAndPermission(PERMISSIONS.MANAGE_TEAM_MEMBERS);
  if ('error' in validation) return { success: false, message: validation.error.message };
  
  const email = formData.get('email') as string;
  const role = formData.get('role') as Role;
  if (!email || !role) return { success: false, message: "Falten l'email o el rol." };
  
  const { user, activeTeamId, supabase } = validation;
  const result = await teamService.inviteUser(supabase, user, activeTeamId, email, role);
  
  if (result.success) {
    revalidatePath('/settings/team');
  }
  return result;
}

export async function revokeInvitationAction(invitationId: string): Promise<FormState> {
  const validation = await validateSessionAndPermission(PERMISSIONS.MANAGE_TEAM_MEMBERS);
  if ('error' in validation) return { success: false, message: validation.error.message };

  const { activeTeamId, supabase } = validation;
  const result = await teamService.revokeInvitation(supabase, activeTeamId, invitationId);
  
  if (result.success) {
    revalidatePath('/settings/team');
  }
  return result;
}

export async function removeMemberAction(userIdToRemove: string): Promise<FormState> {
  const validation = await validateSessionAndPermission(PERMISSIONS.MANAGE_TEAM_MEMBERS);
  if ('error' in validation) return { success: false, message: validation.error.message };

  const { user: actionUser, activeTeamId, supabase } = validation;
  const result = await teamService.removeMember(supabase, activeTeamId, actionUser, userIdToRemove);

  if (result.success) {
    revalidatePath('/settings/team');
  }
  return result;
}

export async function updateMemberRoleAction(memberUserId: string, newRole: Role): Promise<FormState> {
  const validation = await validateSessionAndPermission(PERMISSIONS.MANAGE_TEAM_ROLES);
  if ('error' in validation) return { success: false, message: validation.error.message };

  const { activeTeamId, supabase } = validation;
  const result = await teamService.updateMemberRole(supabase, activeTeamId, memberUserId, newRole);

  if (result.success) {
    revalidatePath('/settings/team');
  }
  return result;
}

export async function toggleInboxPermissionAction(targetUserId: string): Promise<FormState> {
  const validation = await validateSessionAndPermission(PERMISSIONS.MANAGE_TEAM_ROLES);
  if ('error' in validation) return { success: false, message: validation.error.message };

  const { user: granteeUser, activeTeamId, supabase } = validation;
  const result = await teamService.toggleInboxPermission(supabase, granteeUser, activeTeamId, targetUserId);
  
  if (result.success) {
    revalidatePath('/settings/team');
  }
  return result;
}

// =================== FILE: src/app/[locale]/(app)/settings/team/page.tsx ===================

// /src/app/[locale]/(app)/settings/team/page.tsx

import { validatePageSession } from '@/lib/supabase/session';
import { TeamSelectorData } from './_components/TeamSelectorData';
import { ActiveTeamManagerData } from './_components/ActiveTeamManagerData';

// Mantenim l'ordre a Next.js per assegurar el renderitzat dinÃ mic
export const dynamic = 'force-dynamic';

// Podem mantenir els tipus aquÃ­ o moure'ls a un fitxer types.ts si prefereixes
export type Team = { id: string; name: string; };
export type Invitation = { id: string; email: string; role: string; };
export type UserTeam = { role: string; teams: Team | null; };
export type PersonalInvitation = { id: string; team_name: string; inviter_name: string };
export type ProfileInfo = { id: string; full_name: string | null; email: string | null; avatar_url: string | null; };
export type TeamMember = { role: string; profiles: ProfileInfo | null; };
export type ActiveTeamData = {
    team: Team;
    teamMembers: TeamMember[];
    pendingInvitations: Invitation[];
    currentUserRole: string;
    inboxPermissions: { grantee_user_id: string; target_user_id: string; }[];
};
// âœ… CORRECCIÃ“ CLAU: Definim searchParams com una Promise que contÃ© el tipus esperat.
interface TeamSettingsPageProps {
    searchParams: Promise<{ view?: string }>;
}
export default async function TeamSettingsPage({ searchParams }: TeamSettingsPageProps) {
    // La validaciÃ³ de sessiÃ³ (que inclou la redirecciÃ³ si no hi ha usuari/equip actiu)
    const { user, activeTeamId } = await validatePageSession();

    // âœ… Aquest 'await' Ã©s ara semÃ nticament correcte i tipificat.
    const { view } = await searchParams;

    if (view === 'select' || !activeTeamId) {
        // La vista de selecciÃ³ d'equip/lobby es crida si no hi ha equip actiu o si el parÃ metre 'view=select' estÃ  present.
        return <TeamSelectorData userId={user.id} />;
    }

    // Si hi ha un equip actiu, mostrem el panell de gestiÃ³.
    return <ActiveTeamManagerData user={user} activeTeamId={activeTeamId} />;
}

// =================== FILE: src/app/[locale]/(app)/settings/team/_components/ActiveTeamManagerData.tsx ===================

// /src/app/[locale]/(app)/settings/team/_components/ActiveTeamManagerData.tsx

import { createClient } from "@/lib/supabase/server";
import { TeamData } from "./TeamData"; // Component que ara carrega les dades
import { TeamStateCorrector } from "./TeamStateCorrector";
import type { User } from '@supabase/supabase-js';
// Ja no necessitem importar els altres tipus aquÃ­

interface ActiveTeamManagerDataProps {
  user: User;
  activeTeamId: string;
}

export async function ActiveTeamManagerData({ user, activeTeamId }: ActiveTeamManagerDataProps) {
    const supabase = createClient();

    // 1. L'Ãºnica feina d'aquest component Ã©s verificar si l'usuari Ã©s membre.
    const { data: member, error: memberError } = await supabase
        .from('team_members')
        .select('role')
        .match({ user_id: user.id, team_id: activeTeamId })
        .single();

    if (!member || memberError) {
        return <TeamStateCorrector />;
    }

    // 2. âœ… CORRECCIÃ“ CLAU: Ara nomÃ©s passem les props que 'TeamData' realment espera.
    // Deleguem tota la cÃ rrega de dades a 'TeamData'.
    return (
        <TeamData
            user={user}
            member={member}
            activeTeamId={activeTeamId}
        />
    );
}

// =================== FILE: src/app/[locale]/(app)/settings/team/_components/TeamClient.tsx ===================

"use client";


import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Badge } from "@/components/ui/badge";
import { useRouter } from 'next/navigation';
import { Loader2, UserPlus, Trash2, Plus, ArrowRight, LogOut, Eye, EyeOff } from 'lucide-react';
import { toast } from 'sonner';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { useTransition, useRef, useEffect } from 'react';

// âœ… PAS 1: IMPORTA EL CLIENT CORRECTE I LES ACCIONS
import { createClient } from '@/lib/supabase/client';
import {
    removeMemberAction,
    switchActiveTeamAction,
    clearActiveTeamAction,
    createTeamAction,
    inviteUserAction,
    revokeInvitationAction,
    toggleInboxPermissionAction,
    acceptPersonalInviteAction,
    declinePersonalInviteAction,
    updateMemberRoleAction
} from '../actions';
import type { User } from '@supabase/supabase-js';
import type { UserTeam, ActiveTeamData } from '../page';

type ActionResult = { success: boolean; message?: string; } | void;

// âœ… AÃ±adimos la nueva prop opcional 'invalidTeamState'.
interface TeamClientProps {
    user: User;
    userTeams: UserTeam[];
    activeTeamData: ActiveTeamData | null;
    invalidTeamState?: boolean;
    personalInvitations: { id: string; team_name: string; inviter_name: string }[]; // âœ… Nova prop

}
/**
 * Component de client intelÂ·ligent que renderitza o el HUB o el DASHBOARD de l'equip.
 */
export function TeamClient({ user, userTeams, activeTeamData, invalidTeamState, personalInvitations }: TeamClientProps) {
    const router = useRouter();
    const [isPending, startTransition] = useTransition();
    const supabase = createClient();
    const formRef = useRef<HTMLFormElement>(null);


    // âœ… Este efecto corrige automÃ¡ticamente un estado de equipo invÃ¡lido.
    useEffect(() => {
        if (invalidTeamState) handleClearTeam();
        // eslint-disable-next-line react-hooks/exhaustive-deps
    }, [invalidTeamState]);

    // âœ… Noves funcions per gestionar les invitacions personals
    const handleAccept = (invitationId: string) => {
        startTransition(() => executeActionAndReload(() => acceptPersonalInviteAction(invitationId)));
    };
    // Dins del component TeamClient, al costat dels altres handlers
    const handleRemoveMember = (userId: string) => {
        // Afegim una confirmaciÃ³ per seguretat
        if (!confirm("EstÃ s segur que vols eliminar aquest membre de l'equip? Aquesta acciÃ³ no es pot desfer.")) {
            return;
        }
        startTransition(async () => {
            const result = await removeMemberAction(userId);
            if (result.success) {
                toast.success(result.message);
                router.refresh(); // Refresquem per veure la llista de membres actualitzada
            } else {
                toast.error(result.message);
            }
        });
    };
    const executeActionAndReload = async (action: () => Promise<ActionResult>) => {
        const result = await action();
        if (result && result.success === false) {
            toast.error("Error", { description: result.message });
            return;
        }
        await supabase.auth.refreshSession();
        // Forzamos una recarga completa para garantizar la sincronizaciÃ³n.
        window.location.reload();
    };
    // âœ… La funciÃ³ handler ara nomÃ©s necessita el targetUserId
    const handleTogglePermission = (targetUserId: string) => {
        startTransition(async () => {
            // Passem nomÃ©s un parÃ metre a la nova acciÃ³
            const result = await toggleInboxPermissionAction(targetUserId);
            if (result.success) {
                toast.success(result.message);
                router.refresh();
            } else {
                toast.error(result.message);
            }
        });
    };


    const handleCreateTeam = (formData: FormData) => {
        startTransition(async () => {
            const result = await createTeamAction(formData);
            if (result?.success === false) {
                toast.error(result.message);
            }
        });
    };

    const handleInvite = (formData: FormData) => {
        startTransition(async () => {
            const result = await inviteUserAction(formData);
            if (result.success) {
                toast.success(result.message);
                formRef.current?.reset();
                router.refresh();
            } else {
                toast.error(result.message);
            }
        });
    };
    // âœ… NOU HANDLER: Crida l'acciÃ³ per a canviar el rol
    const handleRoleChange = (memberUserId: string, newRole: 'admin' | 'member') => {
        startTransition(async () => {
            const result = await updateMemberRoleAction(memberUserId, newRole);
            if (result.success) {
                toast.success(result.message);
                router.refresh();
            } else {
                toast.error(result.message);
            }
        });
    };
    const handleDecline = (invitationId: string) => {
        startTransition(async () => {
            await declinePersonalInviteAction(invitationId);
            toast.info("InvitaciÃ³ rebutjada.");
            router.refresh();
        });
    };
    const handleRevoke = (invitationId: string) => {
        startTransition(async () => {
            await revokeInvitationAction(invitationId);
            toast.success("InvitaciÃ³ revocada");
            router.refresh();
        });
    };

    const getInitials = (name: string | null | undefined) => {
        if (!name) return '??';
        return name.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase();
    };

    const handleSwitchTeam = (teamId: string) => {
        startTransition(() => executeActionAndReload(() => switchActiveTeamAction(teamId)));
    };

    const handleClearTeam = () => {
        startTransition(() => executeActionAndReload(() => clearActiveTeamAction()));
    };

    // Si el estado es invÃ¡lido, mostramos un mensaje de carga mientras se corrige.
    if (invalidTeamState) {
        return <div className="flex justify-center items-center h-64">Corrigiendo estado del equipo...</div>;
    }
    // --- VISTA 1: El "vestÃ­bul" o HUB d'equips ---
    if (!activeTeamData) {
        return (
            <div className="max-w-4xl mx-auto space-y-8 p-4">
                {/* âœ… NOU BLOC DE NOTIFICACIÃ“ D'INVITACIONS */}
                {personalInvitations && personalInvitations.length > 0 && (
                    <Card className="bg-primary/5 border-primary/20">
                        <CardHeader>
                            <CardTitle>Tens invitacions pendents!</CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            {personalInvitations.map(invite => (
                                <div key={invite.id} className="flex items-center justify-between p-3 bg-background rounded-lg">
                                    <div>
                                        <p className="font-medium">
                                            <strong>{invite.inviter_name}</strong> t'ha convidat a <strong>{invite.team_name}</strong>.
                                        </p>
                                    </div>
                                    <div className="flex gap-2">
                                        <Button size="sm" onClick={() => handleAccept(invite.id)} disabled={isPending}>
                                            {isPending ? <Loader2 className="animate-spin w-4 h-4" /> : "Acceptar"}
                                        </Button>
                                        <Button size="sm" variant="ghost" onClick={() => handleDecline(invite.id)} disabled={isPending}>Rebutjar</Button>
                                    </div>
                                </div>
                            ))}
                        </CardContent>
                    </Card>
                )}
                <div>
                    <h1 className="text-3xl font-bold">Els Teus Equips</h1>
                    <p className="text-muted-foreground">Selecciona un equip per a comenÃ§ar a treballar o crea'n un de nou.</p>
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                    {userTeams.map(({ teams, role }) => teams && (
                        <Card key={teams.id} className="flex flex-col">
                            <CardHeader>
                                <CardTitle>{teams.name}</CardTitle>
                                <CardDescription>El teu rol: <span className="font-semibold capitalize">{role}</span></CardDescription>
                            </CardHeader>
                            <CardContent className="flex-grow flex items-end">
                                <Button onClick={() => handleSwitchTeam(teams.id)} disabled={isPending} className="w-full">
                                    {isPending ? <Loader2 className="animate-spin w-4 h-4" /> : "Entrar"}
                                    {!isPending && <ArrowRight className="w-4 h-4 ml-2" />}
                                </Button>
                            </CardContent>
                        </Card>
                    ))}
                    <Card className="border-dashed">
                        <CardHeader><CardTitle>Crear un nou equip</CardTitle></CardHeader>
                        <CardContent>
                            <form action={handleCreateTeam} className="space-y-4">
                                <Input name="teamName" placeholder="Nom del nou equip" required disabled={isPending} />
                                <Button type="submit" disabled={isPending} className="w-full">
                                    {isPending ? <Loader2 className="animate-spin w-4 h-4" /> : <Plus className="w-4 h-4 mr-2" />} Crear Equip
                                </Button>
                            </form>
                        </CardContent>
                    </Card>
                </div>
            </div>
        );
    }

    // --- VISTA 2: El panell de control de l'equip actiu ---
    const { team, teamMembers, pendingInvitations, currentUserRole, inboxPermissions } = activeTeamData;
    const canManage = currentUserRole === 'owner' || currentUserRole === 'admin';

    return (
        <div className="space-y-8 max-w-4xl mx-auto">
            <div className="flex justify-between items-center">
                <h1 className="text-3xl font-bold">{team.name}</h1>
                <Button variant="outline" onClick={handleClearTeam} disabled={isPending}>
                    <LogOut className="w-4 h-4 mr-2" /> Canviar d'equip
                </Button>
            </div>

            {canManage && (
                <Card>
                    <CardHeader><CardTitle>Convida nous membres</CardTitle></CardHeader>
                    <CardContent>
                        <form ref={formRef} action={handleInvite} className="flex flex-col sm:flex-row gap-2">
                            <Input name="email" type="email" placeholder="correu@exemple.com" required disabled={isPending} className="flex-grow" />
                            <Select name="role" defaultValue="member" required>
                                <SelectTrigger className="w-full sm:w-[150px]"><SelectValue /></SelectTrigger>
                                <SelectContent>
                                    <SelectItem value="member">Membre</SelectItem>
                                    <SelectItem value="admin">Admin</SelectItem>
                                </SelectContent>
                            </Select>
                            <Button type="submit" disabled={isPending} className="sm:w-auto">
                                {isPending ? <Loader2 className="animate-spin w-4 h-4" /> : <UserPlus className="w-4 h-4" />}
                            </Button>
                        </form>
                    </CardContent>
                </Card>
            )}

            {canManage && pendingInvitations.length > 0 && (
                <Card>
                    <CardHeader><CardTitle>Invitacions Pendents</CardTitle></CardHeader>
                    <CardContent className="divide-y">
                        {pendingInvitations.map(invite => (
                            <div key={invite.id} className="flex items-center justify-between py-3 first:pt-0 last:pb-0">
                                <div>
                                    <p className="font-medium">{invite.email}</p>
                                    <p className="text-sm text-muted-foreground capitalize">{invite.role}</p>
                                </div>
                                <form action={() => handleRevoke(invite.id)}>
                                    <Button type="submit" variant="ghost" size="sm" disabled={isPending}><Trash2 className="w-4 h-4 text-destructive" /></Button>
                                </form>
                            </div>
                        ))}
                    </CardContent>
                </Card>
            )}

            <Card>
                <CardHeader><CardTitle>Membres de l'equip ({teamMembers.length})</CardTitle></CardHeader>
                <CardContent className="divide-y">
                    {teamMembers.map(member => {
                        if (!member.profiles) return null;
                        const isOwner = member.role === 'owner';
                        const isSelf = user.id === member.profiles.id;
                        if (!member.profiles) return null;

                        // Comprovem si l'usuari actual tÃ© permÃ­s per a veure la bÃºstia d'aquest membre
                        const hasPermission = Array.isArray(inboxPermissions) && inboxPermissions.some(
                            p => p.grantee_user_id === user.id && p.target_user_id === member.profiles!.id
                        );
                        return (
                            <div key={member.profiles.id} className="flex items-center justify-between py-4 first:pt-0 last:pb-0">
                                <div className="flex items-center gap-4">
                                    <Avatar>
                                        <AvatarImage src={member.profiles.avatar_url ?? undefined} />
                                        <AvatarFallback>{getInitials(member.profiles.full_name)}</AvatarFallback>
                                    </Avatar>
                                    <div>
                                        <p className="font-semibold">{member.profiles.full_name || 'Usuari sense nom'}</p>
                                        <p className="text-sm text-muted-foreground">{member.profiles.email}</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2 sm:gap-4">
                                    {/* âœ… LÃ’GICA DELS ROLS */}
                                    {isOwner ? (
                                        <Badge variant="default" className="capitalize">{member.role}</Badge>
                                    ) : (
                                        <Select
                                            value={member.role}
                                            onValueChange={(newRole) => handleRoleChange(member.profiles!.id, newRole as 'admin' | 'member')}
                                            // El propietari pot canviar rols, l'admin tambÃ© (excepte altres admins si no vols),
                                            // i ningÃº pot canviar el seu propi rol.
                                            disabled={!canManage || isSelf || isPending}
                                        >
                                            <SelectTrigger className="w-[120px]">
                                                <SelectValue />
                                            </SelectTrigger>
                                            <SelectContent>
                                                <SelectItem value="admin">Admin</SelectItem>
                                                <SelectItem value="member">Membre</SelectItem>
                                            </SelectContent>
                                        </Select>
                                    )}
                                    {/* âœ… NOVA ICONA DE PERMISOS */}
                                    {/* NomÃ©s el propietari la veu, i no per a si mateix */}
                                    {currentUserRole === 'owner' && user.id !== member.profiles.id && (
                                        <TooltipProvider>
                                            <Tooltip>
                                                <TooltipTrigger asChild>
                                                    <Button
                                                        variant="ghost"
                                                        size="icon"
                                                        onClick={() => handleTogglePermission(member.profiles!.id)}
                                                        disabled={isPending}
                                                    >
                                                        {hasPermission ? <Eye className="w-4 h-4 text-primary" /> : <EyeOff className="w-4 h-4 text-muted-foreground" />}
                                                    </Button>
                                                </TooltipTrigger>
                                                <TooltipContent>
                                                    <p>{hasPermission ? `Clica per a deixar de veure la bÃºstia de ${member.profiles.full_name}` : `Clica per a veure la bÃºstia de ${member.profiles.full_name}`}</p>
                                                </TooltipContent>
                                            </Tooltip>
                                        </TooltipProvider>
                                    )}
                                    {canManage && member.role !== 'owner' && user.id !== member.profiles.id && (
                                        // ğŸ‘‡ AQUEST BOTÃ“ Ã‰S EL QUE CANVIEM
                                        <TooltipProvider>
                                            <Tooltip>
                                                <TooltipTrigger asChild>
                                                    <Button
                                                        variant="ghost"
                                                        size="icon"
                                                        disabled={isPending}
                                                        onClick={() => handleRemoveMember(member.profiles!.id)} // âœ… AFEGIM L'ACCIÃ“
                                                    >
                                                        <Trash2 className="w-4 h-4 text-destructive" />
                                                    </Button>
                                                </TooltipTrigger>
                                                <TooltipContent>
                                                    <p>Eliminar {member.profiles.full_name}</p>
                                                </TooltipContent>
                                            </Tooltip>
                                        </TooltipProvider>
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </CardContent>
            </Card>
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/settings/team/_components/TeamDashboard.tsx ===================

"use client";

import type { User } from "@supabase/supabase-js";
import type { ActiveTeamData } from "../page";
import { useTeamManagement } from "../_hooks/useTeamManagement";
import {
  Button,
  Input,
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
  Card,
  CardContent,
  CardHeader,
  CardTitle,
  Avatar,
  AvatarFallback,
  AvatarImage,
  Badge,
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/index";
import { Loader2, UserPlus, Trash2, LogOut, Eye, EyeOff } from "lucide-react";

export function TeamDashboard({ user, activeTeamData }: { user: User; activeTeamData: ActiveTeamData }) {
  const {
    isPending,
    inviteFormRef,
    handleClearTeam,
    handleInvite,
    handleRemoveMember,
    handleRoleChange,
    handleRevokeInvite,
    handleTogglePermission,
  } = useTeamManagement();

  const { team, teamMembers, pendingInvitations, currentUserRole, inboxPermissions } = activeTeamData;
  const canManage = currentUserRole === "owner" || currentUserRole === "admin";

  const getInitials = (name?: string | null) => (name ? name.split(" ").map(n => n[0]).slice(0, 2).join("").toUpperCase() : "??");

  return (
    <div className="space-y-6 max-w-4xl mx-auto px-3 sm:px-6 pb-8">
      {/* ğŸ”¹ Header responsive */}
      <div className="flex flex-col sm:flex-row justify-between gap-3 sm:items-center">
        <h1 className="text-2xl sm:text-3xl font-bold">{team.name}</h1>
        <Button
          variant="outline"
          onClick={handleClearTeam}
          disabled={isPending}
          className="w-full sm:w-auto"
        >
          <LogOut className="w-4 h-4 mr-2" /> Canviar d'equip
        </Button>
      </div>

      {/* ğŸ”¹ Formulari d'invitaciÃ³ */}
      {canManage && (
        <Card>
          <CardHeader>
            <CardTitle>Convida nous membres</CardTitle>
          </CardHeader>
          <CardContent>
            <form
              ref={inviteFormRef}
              action={handleInvite}
              className="flex flex-col sm:flex-row gap-3"
            >
              <Input
                name="email"
                type="email"
                placeholder="correu@exemple.com"
                required
                disabled={isPending}
                className="flex-grow"
              />
              <Select name="role" defaultValue="member" required>
                <SelectTrigger className="w-full sm:w-[150px]">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="member">Membre</SelectItem>
                  <SelectItem value="admin">Admin</SelectItem>
                </SelectContent>
              </Select>
              <Button
                type="submit"
                disabled={isPending}
                className="w-full sm:w-auto"
              >
                {isPending ? (
                  <Loader2 className="animate-spin w-4 h-4" />
                ) : (
                  <UserPlus className="w-4 h-4" />
                )}
              </Button>
            </form>
          </CardContent>
        </Card>
      )}

      {/* ğŸ”¹ Invitacions pendents */}
      {canManage && pendingInvitations.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle>Invitacions Pendents</CardTitle>
          </CardHeader>
          <CardContent className="space-y-3">
            {pendingInvitations.map((invite) => (
              <div
                key={invite.id}
                className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 border rounded-lg p-3"
              >
                <div>
                  <p className="font-medium">{invite.email}</p>
                  <p className="text-sm text-muted-foreground capitalize">{invite.role}</p>
                </div>
                <Button
                  type="button"
                  variant="ghost"
                  size="sm"
                  disabled={isPending}
                  onClick={() => handleRevokeInvite(invite.id)}
                >
                  <Trash2 className="w-4 h-4 text-destructive" />
                </Button>
              </div>
            ))}
          </CardContent>
        </Card>
      )}

      {/* ğŸ”¹ Membres */}
      <Card>
        <CardHeader>
          <CardTitle>Membres de l'equip ({teamMembers.length})</CardTitle>
        </CardHeader>
        <CardContent className="divide-y">
          {teamMembers.map((member) => {
            if (!member.profiles) return null;
            const isOwner = member.role === "owner";
            const isSelf = user.id === member.profiles.id;
            const hasPermission =
              Array.isArray(inboxPermissions) &&
              inboxPermissions.some(
                (p) =>
                  p.grantee_user_id === user.id &&
                  p.target_user_id === member.profiles!.id
              );

            return (
              <div
                key={member.profiles.id}
                className="py-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3"
              >
                {/* Info usuari */}
                <div className="flex items-center gap-3">
                  <Avatar>
                    <AvatarImage src={member.profiles.avatar_url ?? undefined} />
                    <AvatarFallback>{getInitials(member.profiles.full_name)}</AvatarFallback>
                  </Avatar>
                  <div>
                    <p className="font-semibold">{member.profiles.full_name || "Usuari sense nom"}</p>
                    <p className="text-sm text-muted-foreground">{member.profiles.email}</p>
                  </div>
                </div>

                {/* Accions */}
                <div className="flex items-center gap-2 flex-wrap">
                  {isOwner ? (
                    <Badge variant="default" className="capitalize">
                      {member.role}
                    </Badge>
                  ) : (
                    <Select
                      value={member.role}
                      onValueChange={(newRole: "admin" | "member") =>
                        handleRoleChange(member.profiles!.id, newRole)
                      }
                      disabled={!canManage || isSelf || isPending}
                    >
                      <SelectTrigger className="w-[120px]">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="admin">Admin</SelectItem>
                        <SelectItem value="member">Membre</SelectItem>
                      </SelectContent>
                    </Select>
                  )}

                  {currentUserRole === "owner" && !isSelf && (
                    <TooltipProvider>
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <Button
                            variant="ghost"
                            size="icon"
                            onClick={() => handleTogglePermission(member.profiles!.id)}
                            disabled={isPending}
                          >
                            {hasPermission ? (
                              <Eye className="w-4 h-4 text-primary" />
                            ) : (
                              <EyeOff className="w-4 h-4 text-muted-foreground" />
                            )}
                          </Button>
                        </TooltipTrigger>
                        <TooltipContent>
                          <p>
                            {hasPermission
                              ? "Deixar de veure la bÃºstia"
                              : "Veure la bÃºstia"}
                          </p>
                        </TooltipContent>
                      </Tooltip>
                    </TooltipProvider>
                  )}

                  {canManage && !isSelf && (
                    <TooltipProvider>
                      <Tooltip>
                        <TooltipTrigger asChild>
                          <Button
                            variant="ghost"
                            size="icon"
                            disabled={isPending}
                            onClick={() => handleRemoveMember(member.profiles!.id)}
                          >
                            <Trash2 className="w-4 h-4 text-destructive" />
                          </Button>
                        </TooltipTrigger>
                        <TooltipContent>
                          <p>Eliminar membre</p>
                        </TooltipContent>
                      </Tooltip>
                    </TooltipProvider>
                  )}
                </div>
              </div>
            );
          })}
        </CardContent>
      </Card>
    </div>
  );
}


// =================== FILE: src/app/[locale]/(app)/settings/team/_components/TeamData.tsx ===================

// /app/[locale]/settings/team/_components/TeamData.tsx (FITXER CORREGIT I NET)
import { createClient } from "@/lib/supabase/server";
import { TeamDashboard } from "./TeamDashboard";
import type { User } from "@supabase/supabase-js";
// âœ… 1. Importem el NOU servei i els seus tipus
import * as teamService from '@/lib/services/settings/team/team.service';
import type { ActiveTeamData } from '@/lib/services/settings/team/team.service';

interface TeamDataProps {
  user: User;
  member: { role: string };
  activeTeamId: string;
}

export async function TeamData({ user, member, activeTeamId }: TeamDataProps) {
  const supabase = createClient();

  // âœ… 2. Tota la lÃ²gica de 'Promise.all' i mapatge s'ha mogut al servei.
  const activeTeamData: ActiveTeamData = await teamService.getActiveTeamData(
    supabase,
    activeTeamId,
    user.id,
    member.role
  );
  
  // 3. Renderitzem el component de Dashboard (aquest ja estava bÃ©)
  return <TeamDashboard user={user} activeTeamData={activeTeamData} />;
}

// =================== FILE: src/app/[locale]/(app)/settings/team/_components/TeamHub.tsx ===================

// /app/[locale]/settings/team/_components/TeamHub.tsx
"use client";

import type { UserTeam, PersonalInvitation } from '../page';
import { useTeamHub } from '../_hooks/useTeamHub';

// Imports de UI
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Loader2, Plus, ArrowRight } from 'lucide-react';

interface TeamHubProps {
    userTeams: UserTeam[];
    personalInvitations: PersonalInvitation[];
}

export function TeamHub({ userTeams, personalInvitations }: TeamHubProps) {
    // Obtenim tota la lÃ²gica del nostre hook
    const {
        isPending,
        handleCreateTeam,
        handleSwitchTeam,
        handleAcceptInvite,
        handleDeclineInvite,
    } = useTeamHub();

    return (
        <div className="max-w-4xl mx-auto space-y-8 p-4">
            {/* SecciÃ³ d'invitacions pendents */}
            {personalInvitations && personalInvitations.length > 0 && (
                <Card className="bg-primary/5 border-primary/20">
                    <CardHeader>
                        <CardTitle>Tens invitacions pendents!</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        {personalInvitations.map(invite => (
                            <div key={invite.id} className="flex items-center justify-between p-3 bg-background rounded-lg">
                                <div>
                                    <p className="font-medium">
                                        <strong>{invite.inviter_name}</strong> t'ha convidat a <strong>{invite.team_name}</strong>.
                                    </p>
                                </div>
                                <div className="flex gap-2">
                                    <Button size="sm" onClick={() => handleAcceptInvite(invite.id)} disabled={isPending}>
                                        {isPending ? <Loader2 className="animate-spin w-4 h-4" /> : "Acceptar"}
                                    </Button>
                                    <Button size="sm" variant="ghost" onClick={() => handleDeclineInvite(invite.id)} disabled={isPending}>
                                        Rebutjar
                                    </Button>
                                </div>
                            </div>
                        ))}
                    </CardContent>
                </Card>
            )}

            {/* SecciÃ³ principal de selecciÃ³ i creaciÃ³ d'equips */}
            <div>
                <h1 className="text-3xl font-bold">Els Teus Equips</h1>
                <p className="text-muted-foreground">Selecciona un equip per a comenÃ§ar a treballar o crea'n un de nou.</p>
            </div>
            
            <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
                {/* Llista dels equips de l'usuari */}
                {userTeams.map(({ teams, role }) => teams && (
                    <Card key={teams.id} className="flex flex-col">
                        <CardHeader>
                            <CardTitle>{teams.name}</CardTitle>
                            <CardDescription>El teu rol: <span className="font-semibold capitalize">{role}</span></CardDescription>
                        </CardHeader>
                        <CardContent className="flex-grow flex items-end">
                            <Button onClick={() => handleSwitchTeam(teams.id)} disabled={isPending} className="w-full">
                                {isPending ? <Loader2 className="animate-spin w-4 h-4" /> : "Entrar"}
                                {!isPending && <ArrowRight className="w-4 h-4 ml-2" />}
                            </Button>
                        </CardContent>
                    </Card>
                ))}
                
                {/* Targeta per crear un nou equip */}
                <Card className="border-dashed">
                    <CardHeader><CardTitle>Crear un nou equip</CardTitle></CardHeader>
                    <CardContent>
                        <form action={handleCreateTeam} className="space-y-4">
                            <Input name="teamName" placeholder="Nom del nou equip" required disabled={isPending} />
                            <Button type="submit" disabled={isPending} className="w-full">
                                {isPending ? <Loader2 className="animate-spin w-4 h-4" /> : <Plus className="w-4 h-4 mr-2" />} Crear Equip
                            </Button>
                        </form>
                    </CardContent>
                </Card>
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/settings/team/_components/TeamSelectorData.tsx ===================

import { createClient } from "@/lib/supabase/server";
import { TeamHub } from "./TeamHub";
// âœ… 1. Importem els dos tipus per a mÃ©s claredat.
import type { UserTeam, PersonalInvitation } from '../page';

interface TeamSelectorDataProps {
  userId: string;
}

export async function TeamSelectorData({ userId }: TeamSelectorDataProps) {
    const supabase = createClient();

    const [userTeamsRes, invitationsRes] = await Promise.all([
        supabase.from('team_members').select('role, teams!inner(id, name)').eq('user_id', userId),
        supabase.from('invitations').select('id, team_name, inviter_name').eq('user_id', userId).eq('status', 'pending')
    ]);

    if (userTeamsRes.error || invitationsRes.error) {
        console.error("Error loading team selection data:", { teamError: userTeamsRes.error, invError: invitationsRes.error });
        return <div>Error en carregar les dades de l'equip.</div>;
    }

    const userTeams: UserTeam[] = (userTeamsRes.data || []).filter(Boolean).map(m => ({
        role: m.role,
        // Aquesta lÃ²gica per a 'teams' sembla correcta per gestionar relacions
        teams: Array.isArray(m.teams) ? m.teams[0] : m.teams
    }));

    // âœ… 2. Filtrem i transformem les invitacions per assegurar que compleixen el tipus.
    const personalInvitations: PersonalInvitation[] = (invitationsRes.data || [])
        .filter((invite): invite is PersonalInvitation => 
            !!invite.team_name && !!invite.inviter_name
        );

    return (
        <TeamHub 
            userTeams={userTeams} 
            // âœ… 3. Passem l'array ja filtrat i correctament tipat.
            personalInvitations={personalInvitations} 
        />
    );
}

// =================== FILE: src/app/[locale]/(app)/settings/team/_components/TeamSkeleton.tsx ===================

"use client";

/**
 * @summary Esquelet de cÃ rrega per a la pÃ gina de GestiÃ³ d'Equip.
 */
export function TeamSkeleton() {
  return (
    <div className="space-y-8 animate-pulse">
      {/* Esquelet del formulari d'invitaciÃ³ */}
      <div className="glass-card p-6">
        <div className="h-6 w-1/3 bg-gray-700/50 rounded-md mb-2"></div>
        <div className="h-4 w-2/3 bg-gray-700/50 rounded-md mb-4"></div>
        <div className="flex gap-2">
          <div className="h-10 flex-1 bg-gray-800/50 rounded-md"></div>
          <div className="h-10 w-24 bg-gray-800/50 rounded-md"></div>
          <div className="h-10 w-28 bg-gray-800/50 rounded-md"></div>
        </div>
      </div>
      
      {/* Esquelet de la llista de membres */}
      <div className="glass-card p-6">
        <div className="h-6 w-1/4 bg-gray-700/50 rounded-md mb-4"></div>
        <div className="space-y-3">
          {[...Array(3)].map((_, i) => (
            <div key={i} className="flex items-center justify-between p-2 h-12 bg-muted rounded-lg">
              <div className="h-6 w-1/2 bg-gray-800/50 rounded-md"></div>
              <div className="h-6 w-1/4 bg-gray-800/50 rounded-md"></div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/settings/team/_components/TeamStateCorrector.tsx ===================

"use client";

import { useEffect, useState } from 'react'; // Importem useState
import { useTransition } from 'react';
import { toast } from 'sonner';
import { clearActiveTeamAction } from '../actions';
import { Button } from '@/components/ui/button'; // Importem el botÃ³ per a reintentar

export function TeamStateCorrector() {
    const [, startTransition] = useTransition();
    // Afegim un estat per guardar el missatge d'error
    const [errorMessage, setErrorMessage] = useState<string | null>(null);

    const runCorrection = () => {
        setErrorMessage(null); // Resetejem l'error abans de comenÃ§ar
        startTransition(async () => {
            console.log("[CLIENT] Estat invÃ lid detectat. Executant neteja...");
            const result = await clearActiveTeamAction();
            if (result?.success === false) {
                const message = result.message || "Hi ha hagut un error inesperat.";
                toast.error("Error en corregir l'estat de l'equip.", { description: message });
                setErrorMessage(message); // Guardem l'error a l'estat
            } else {
                window.location.reload();
            }
        });
    };

    // Executem la correcciÃ³ nomÃ©s un cop quan el component es munta
    useEffect(() => {
        runCorrection();
    }, []); 

    // Renderitzem condicionalment segons si hi ha error o no
    return (
        <div className="flex flex-col justify-center items-center h-64 gap-4">
            {errorMessage ? (
                <>
                    <p className="text-destructive">No s'ha pogut corregir l'estat de l'equip.</p>
                    <p className="text-sm text-muted-foreground">{errorMessage}</p>
                    <Button onClick={runCorrection}>Reintentar</Button>
                </>
            ) : (
                <p>Corregint estat de l'equip...</p>
            )}
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/settings/team/_hooks/useTeamHub.ts ===================

// /app/[locale]/settings/team/_hooks/useTeamHub.ts
"use client";

import { useTransition } from 'react';
import { useRouter } from 'next/navigation';
import { toast } from 'sonner';
import {
    createTeamAction,
    switchActiveTeamAction,
    acceptPersonalInviteAction,
    declinePersonalInviteAction
} from '../actions';

export function useTeamHub() {
    const [isPending, startTransition] = useTransition();
    const router = useRouter();

    // FunciÃ³ genÃ¨rica per a accions que requereixen una recÃ rrega completa
    // (canviar d'equip o acceptar una invitaciÃ³ canvien el token d'usuari)
    type ActionResult = { success: boolean; message?: string };
    
    const executeActionAndReload = (action: () => Promise<ActionResult>) => {
        startTransition(async () => {
            const result = await action();
            if (result && result.success === false) {
                toast.error(result.message || "Hi ha hagut un error.");
            } else {
                // âœ… Redirigeix a la vista principal de lâ€™equip
                router.replace("/settings/team");
                router.refresh();
            }
        });
    };

    // Handlers que utilitzen la funciÃ³ genÃ¨rica
    const handleCreateTeam = (formData: FormData) => {
        executeActionAndReload(() => createTeamAction(formData));
    };

    const handleSwitchTeam = (teamId: string) => {
        executeActionAndReload(() => switchActiveTeamAction(teamId));
    };

    const handleAcceptInvite = (invitationId: string) => {
        executeActionAndReload(() => acceptPersonalInviteAction(invitationId));
    };

    // Handler per rebutjar, que nomÃ©s necessita un refresc de dades
    const handleDeclineInvite = (invitationId: string) => {
        startTransition(async () => {
            await declinePersonalInviteAction(invitationId);
            toast.info("InvitaciÃ³ rebutjada.");
            router.refresh(); // No cal recarregar tota la pÃ gina, nomÃ©s les dades del servidor.
        });
    };

    // Retornem la nostra caixa d'eines ğŸ§°
    return {
        isPending,
        handleCreateTeam,
        handleSwitchTeam,
        handleAcceptInvite,
        handleDeclineInvite,
    };
}

// =================== FILE: src/app/[locale]/(app)/settings/team/_hooks/useTeamManagement.ts ===================

// /src/app/[locale]/(app)/settings/team/_hooks/useTeamManagement.ts (VERSIÃ“ FINAL)
"use client";

import { useTransition, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { toast } from 'sonner';
import {
    inviteUserAction, removeMemberAction,
    revokeInvitationAction, toggleInboxPermissionAction, updateMemberRoleAction
} from '../actions';
import type { Role } from '@/lib/permissions/permissions.config';

export function useTeamManagement() {
    const [isPending, startTransition] = useTransition();
    const router = useRouter();
    const inviteFormRef = useRef<HTMLFormElement>(null);

    // Define a type for the expected result structure
    type ActionResult = { success: boolean; message?: string };

    // FunciÃ³ genÃ¨rica per a accions que refresquen les dades
    const executeActionAndRefresh = (action: () => Promise<ActionResult>, successMessage?: string) => {
        startTransition(async () => {
            const result = await action();
            if (result?.success === false) {
                toast.error(result.message || "Hi ha hagut un error.");
            } else {
                if (successMessage) toast.success(successMessage);
                router.refresh();
            }
        });
    };

    const handleClearTeam = () => {
        // Simplement naveguem a la pÃ gina d'equips. Res mÃ©s.
        // Com que ja som a la pÃ gina, un 'refresh' Ã©s suficient
        // per a que el 'page.tsx' es torni a executar i ens mostri el lobby.
        router.push('/settings/team?view=select');
    };

    const handleInvite = (formData: FormData) => {
        executeActionAndRefresh(() => inviteUserAction(formData));
        inviteFormRef.current?.reset();
    };

    const handleRemoveMember = (userId: string) => {
        if (!confirm("EstÃ s segur que vols eliminar aquest membre? Aquesta acciÃ³ no es pot desfer.")) return;
        executeActionAndRefresh(() => removeMemberAction(userId));
    };

    const handleRoleChange = (userId: string, newRole: Role) => {
        executeActionAndRefresh(() => updateMemberRoleAction(userId, newRole));
    };

    const handleRevokeInvite = (invitationId: string) => {
        executeActionAndRefresh(() => revokeInvitationAction(invitationId));
    };

    const handleTogglePermission = (targetUserId: string) => {
        executeActionAndRefresh(() => toggleInboxPermissionAction(targetUserId));
    };

    const getInitials = (name: string | null | undefined) => {
        if (!name) return '??';
        return name.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase();
    };

    return {
        isPending, inviteFormRef, handleClearTeam, handleInvite,
        handleRemoveMember, handleRoleChange, handleRevokeInvite,
        handleTogglePermission, getInitials,
    };
}

// =================== FILE: src/app/[locale]/(app)/settings/_components/settings-nav.tsx ===================

/**
 * @file SettingsNav.tsx
 * @summary Component de navegaciÃ³ per a la secciÃ³ de ConfiguraciÃ³,
 * ara adaptable per a escriptori i mÃ²bil.
 */
"use client";

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { useLocale, useTranslations } from 'next-intl';
import { User, CreditCard, Users, Puzzle, Wrench, ShieldOff ,KeyRound, Download} from 'lucide-react';
import { cn, getCleanPathname } from '@/lib/utils/utils';

const settingsNavItems = [
  { id: 'profile', labelKey: 'profile', icon: User, path: '/settings/profile' },
  { id: 'billing', labelKey: 'billing', icon: CreditCard, path: '/settings/billing' },
  { id: 'team', labelKey: 'team', icon: Users, path: '/settings/team' },
  { id: 'integrations', labelKey: 'integrations', icon: Puzzle, path: '/settings/integrations' },
  { id: 'blacklist', labelKey: 'blacklist', icon: ShieldOff, path: '/settings/blacklist' },
  { id: 'customization', labelKey: 'customization', icon: Wrench, path: '/settings/customization' },
  { id: 'install', labelKey: 'install', icon: Download, path: '/settings/install' },
  { id: 'permissions', labelKey: 'permissions', icon: KeyRound, path: '/settings/permissions' },
];

export function SettingsNav() {
  const t = useTranslations('SettingsPage.nav');
  const fullPathname = usePathname();
  const locale = useLocale();
  const cleanPathname = getCleanPathname(fullPathname, locale);

  return (
    // Aquest <nav> Ã©s ara un contenidor flexible.
    <nav className="flex flex-col gap-4">
      {/* El tÃ­tol principal nomÃ©s es mostra en pantalles grans */}
      <h1 className="text-3xl font-bold mb-4 hidden lg:block">{t('title')}</h1>
      
      {/* âœ… DISSENY ADAPTABLE:
        - En mÃ²bil ('flex-row'), Ã©s una fila.
        - En escriptori ('lg:flex-col'), Ã©s una columna.
        - 'overflow-x-auto' permet fer scroll horitzontal en mÃ²bil si no hi caben tots els elements.
      */}
      <ul className="flex flex-row lg:flex-col space-x-2 lg:space-x-0 lg:space-y-1 overflow-x-auto pb-2 -mb-2">
        {settingsNavItems.map(item => {
          // Comprovem si l'enllaÃ§ estÃ  actiu
          const isActive = cleanPathname === item.path;
          return (
            <li key={item.id} className="flex-shrink-0">
              <Link
                href={`/${locale}${item.path}`}
                className={cn(
                  'flex items-center gap-3 px-4 py-2.5 rounded-lg transition-all duration-200 hover:bg-accent text-sm lg:text-base',
                  isActive
                    ? 'bg-primary text-primary-foreground font-semibold shadow-sm'
                    : 'text-muted-foreground hover:text-foreground'
                )}
              >
                <item.icon className="w-5 h-5" />
                <span>{t(item.labelKey as string)}</span>
              </Link>
            </li>
          );
        })}
      </ul>
    </nav>
  );
}


// =================== FILE: src/app/[locale]/(app)/settings/_components/SettingsSkeleton.tsx ===================

/**
 * @file SettingsSkeleton.tsx
 * @summary Esquelet de cÃ rrega per a l'estructura general de la secciÃ³ de ConfiguraciÃ³.
 */
"use client";

import { Skeleton } from '@/components/ui/skeleton';

export function SettingsSkeleton() {
  return (
    <div className="flex flex-col lg:flex-row gap-8 h-full animate-pulse">
      {/* Esquelet per a la navegaciÃ³ lateral */}
      <aside className="flex-shrink-0 lg:w-64">
        <Skeleton className="h-9 w-1/2 mb-8" />
        <div className="space-y-2">
          <Skeleton className="h-12 w-full" />
          <Skeleton className="h-12 w-full" />
          <Skeleton className="h-12 w-full" />
          <Skeleton className="h-12 w-full" />
        </div>
      </aside>
      {/* Esquelet per a l'Ã rea de contingut */}
      <main className="flex-1">
        <div className="space-y-4">
          <Skeleton className="h-9 w-1/3" />
          <Skeleton className="h-5 w-2/3" />
          <Skeleton className="h-64 w-full mt-8" />
        </div>
      </main>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(app)/_components/AppClientLayout.tsx ===================

// UbicaciÃ³: /app/(app)/components/AppClientLayout.tsx

"use client";

import React, { useState, ReactNode } from 'react';
import Image from 'next/image';
import { motion } from 'framer-motion';
import { useTranslations } from 'next-intl';
import { toast } from 'sonner';

// Hooks i Stores
import { useAppNavigation } from '@/hooks/useAppNavigation';
import { useNavigationStore } from '@/stores/navigationStore';

// Components
import { MainSidebar } from './main-sidebar';
import { ModuleSidebar } from './module-sidebar';
import { MobileMenu } from './MobileMenu';
import { Chatbot } from '@/components/chatbot/Chatbot';
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from "@/components/ui/alert-dialog";

// Accions
import { logoutAction } from '@/app/[locale]/(auth)/auth/actions';

// Imatges i tipus
export function AppClientLayout({ children }: { children: ReactNode, locale: string }) {
    const t = useTranslations('Navigation');
    const { isChatbotOpen } = useNavigationStore();
    const [isSignOutDialogOpen, setIsSignOutDialogOpen] = useState(false);

    // âœ… Tota la lÃ²gica complexa ve del nostre hook personalitzat!
    const {
        activeModule,
        isModuleSidebarOpen,
        setIsModuleSidebarOpen,
        handleNavigation,
        handleMainMenuClick,
    } = useAppNavigation();

    const handleSignOut = () => {
        logoutAction();
    };

    const handleNotImplementedClick = (e: React.MouseEvent) => {
        e.preventDefault();
        toast.info(t('comingSoon'), { description: t('featureUnavailable') });
    };

    return (
        <div className="h-screen w-screen flex flex-col lg:flex-row bg-background text-foreground overflow-hidden">
            <MainSidebar
                onModuleSelect={handleMainMenuClick}
                onOpenSignOutDialog={() => setIsSignOutDialogOpen(true)}
                onNotImplemented={handleNotImplementedClick}
            />

            <motion.div
                className="hidden lg:block overflow-hidden flex-shrink-0"
                initial={false}
                animate={{ width: isModuleSidebarOpen && activeModule ? '16rem' : '0rem' }}
                transition={{ type: 'spring', stiffness: 400, damping: 40 }}
            >
                {activeModule && (
                    <ModuleSidebar
                        module={activeModule}
                        onClose={() => setIsModuleSidebarOpen(false)}
                        handleNavigation={handleNavigation}
                    />
                )}
            </motion.div>

            <div className="flex-1 flex flex-col overflow-hidden">
                <header className="lg:hidden flex items-center justify-between border-b p-1 border-border flex-shrink-0">
                    <Image
                        src="/icon0.svg"
                        alt={t('logoAlt')}
                        className="object-cover"
                        priority height={30}
                        width={30}   // Substitueix per l'amplada real de la teva imatge

                    />

                    <span className="font-bold text-lg">{t('brandNameMobile')}</span>
                    <MobileMenu
                        onOpenSignOutDialog={() => setIsSignOutDialogOpen(true)}
                        onNotImplementedClick={handleNotImplementedClick}
                        handleNavigation={handleNavigation}
                    />

                </header>
                <main className="flex-1 overflow-y-auto">
                    <div className="h-full p-4 sm:p-6 md:p-8">{children}</div>
                </main>
                {isChatbotOpen && <Chatbot />}
            </div>

            <AlertDialog open={isSignOutDialogOpen} onOpenChange={setIsSignOutDialogOpen}>
                <AlertDialogContent>
                    <AlertDialogHeader>
                        <AlertDialogTitle>{t('signOutConfirmTitle')}</AlertDialogTitle>
                        <AlertDialogDescription>{t('signOutConfirmDescription')}</AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                        <AlertDialogCancel>{t('cancel')}</AlertDialogCancel>
                        <AlertDialogAction onClick={handleSignOut} className="bg-destructive hover:bg-destructive/90">{t('confirmSignOut')}</AlertDialogAction>
                    </AlertDialogFooter>
                </AlertDialogContent>
            </AlertDialog>
        </div>
    );
}

// =================== FILE: src/app/[locale]/(app)/_components/main-sidebar.tsx ===================

// UbicaciÃ³: src/app/[locale]/(app)/_components/main-sidebar.tsx

"use client";

import React from 'react';
import Image from 'next/image';
import { useTranslations } from 'next-intl';
import { LogOut } from 'lucide-react';
import { cn } from '@/lib/utils/utils'; // <-- Importa cn

import { useNavigationStore } from '@/stores/navigationStore';
import { navModules, bottomItems } from '@/config/navigation';
import type { NavItem as NavItemType } from '@/types/app/navigation';

import { NavItem } from './NavItem';

interface MainSidebarProps {
    onModuleSelect: (module: NavItemType) => void;
    onOpenSignOutDialog: () => void;
    onNotImplemented: (e: React.MouseEvent) => void;
}

export function MainSidebar({ onModuleSelect, onOpenSignOutDialog, onNotImplemented }: MainSidebarProps) {
    const t = useTranslations('Navigation');
    const { isNavigating } = useNavigationStore();
    const { toggleChatbot } = useNavigationStore();

    const handleItemClick = (e: React.MouseEvent<HTMLAnchorElement>, item: NavItemType) => {
        if (item.notImplemented) {
            e.preventDefault();
            onNotImplemented(e);
            return;
        }

        if (item.id === 'ia') {
            e.preventDefault();
            toggleChatbot();
            return;
        }

        if (!item.isSingle) {
            e.preventDefault();
        }
        onModuleSelect(item);
    };

    return (
        // âœ…âœ… CANVI APLICAT AQUÃ âœ…âœ…
        <aside className={cn(
          "hidden lg:flex w-24 h-full border-r border-border p-4 flex-col items-center z-20",
          "bg-slate-50 dark:glass-effect" // Fons clar / Efecte vidre en fosc
        )}>
            {/* Logo a la part superior */}
            <div className="flex items-center justify-center gap-3 mb-8">
                <div className="w-12 h-12 bg-gradient-to-r to-pink-500 rounded-lg flex items-center justify-center overflow-hidden">
                    {isNavigating ? (
                        <video
                            src="/videoLoading.webm"
                            autoPlay muted loop playsInline
                            className="w-full h-full object-cover"
                        />
                    ) : (
                        <Image
                            src="/icon0.svg"
                            alt={t('logoAlt')}
                            className="object-cover"
                            priority
                            width={64}
                            height={64}
                        />
                    )}
                </div>
            </div>

            {/* NavegaciÃ³ principal */}
            <nav className="flex-1 flex flex-col items-center gap-4 z-20">
                {navModules.map(item => (
                    <NavItem key={item.id} item={item} onClick={handleItemClick} t={t} />
                ))}
            </nav>

            {/* Elements de la part inferior */}
            <div className="flex flex-col items-center gap-4 border-t border-border pt-4 mt-4">
                {bottomItems.map(item => (
                    <NavItem key={item.id} item={item} onClick={handleItemClick} t={t} />
                ))}

                {/* BotÃ³ de tancar sessiÃ³ */}
                <div
                    onClick={onOpenSignOutDialog}
                    className="flex items-center justify-center h-12 w-12 rounded-lg text-muted-foreground hover:bg-muted cursor-pointer group relative"
                    role="button"
                    aria-label={t('signOut')}
                >
                    <LogOut className="w-6 h-6" />
                    <span className="absolute left-16 p-2 px-3 text-sm font-medium bg-popover text-popover-foreground rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">{t('signOut')}</span>
                </div>
            </div>
        </aside>
    );
}

// =================== FILE: src/app/[locale]/(app)/_components/MobileMenu.tsx ===================

"use client";

import React, { useState } from 'react';
import { Sheet, SheetContent, SheetHeader, SheetTitle, SheetTrigger } from "@/components/ui/sheet";
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from "@/components/ui/accordion";
import { Button } from '@/components/ui/button';
import { Menu, LogOut } from 'lucide-react';
import { useTranslations } from 'next-intl';
import { navModules, bottomItems } from '@/config/navigation';
import type { NavItem } from '@/types/app/navigation';

export function MobileMenu({ onOpenSignOutDialog, onNotImplementedClick, handleNavigation }: {
    onOpenSignOutDialog: () => void;
    onNotImplementedClick: (e: React.MouseEvent) => void;
    handleNavigation: (item: NavItem) => void;
}) {
    const [isOpen, setIsOpen] = useState(false);
    const t = useTranslations('Navigation');

    const createClickHandler = (item: NavItem) => () => {
        handleNavigation(item);
        if (item.isSingle !== false) {
            setIsOpen(false);
        }
    };

    return (
        <Sheet open={isOpen} onOpenChange={setIsOpen}>
            <SheetTrigger asChild>
                <Button variant="ghost" size="icon" className="md:hidden"><Menu className="h-6 w-6" /></Button>
            </SheetTrigger>
            <SheetContent side="left" className="w-full sm:w-[320px] p-0 flex flex-col">
                <SheetHeader className="p-4 border-b"><SheetTitle>{t('menuTitle')}</SheetTitle></SheetHeader>
                
                {/* Aquesta part es queda igual */}
                <nav className="flex-1 overflow-y-auto p-4 space-y-1">
                    {navModules.map(module => (
                        module.isSingle ? (
                            <Button key={module.id} variant="ghost" className="w-full justify-start gap-3 px-4 text-base font-medium" onClick={createClickHandler(module)}>
                                <module.icon className="w-5 h-5" /> {t(module.labelKey)}
                            </Button>
                        ) : (
                            <Accordion key={module.id} type="single" collapsible className="w-full">
                                <AccordionItem value={module.id} className="border-b-0">
                                    <AccordionTrigger className="px-4 py-3 text-base font-medium hover:no-underline hover:bg-muted rounded-lg">
                                        <div className="flex items-center gap-3"><module.icon className="w-5 h-5" />{t(module.labelKey)}</div>
                                    </AccordionTrigger>
                                    <AccordionContent className="pl-8 pt-2 pb-1">
                                        <div className="flex flex-col gap-1">
                                            {module.children?.map((item: NavItem) => (
                                                <Button key={item.id} variant="ghost" className="w-full justify-start gap-3 px-4 py-2 text-muted-foreground hover:text-foreground" onClick={createClickHandler(item)}>
                                                    <item.icon className="w-4 h-4" />{t(item.labelKey)}
                                                </Button>
                                            ))}
                                        </div>
                                    </AccordionContent>
                                </AccordionItem>
                            </Accordion>
                        )
                    ))}
                </nav>

                {/* âœ… CORRECCIÃ“: Apliquem la mateixa lÃ²gica d'acordiÃ³ als 'bottomItems' */}
                <div className="p-4 border-t mt-auto space-y-1">
                    {bottomItems.map(item => (
                        item.isSingle ? (
                            // Gestiona 'AI' i altres enllaÃ§os simples
                            <Button
                                key={item.id}
                                variant="ghost"
                                className="w-full justify-start gap-3 px-4 py-3 text-base font-medium"
                                onClick={item.notImplemented ? onNotImplementedClick : createClickHandler(item)}
                            >
                                <item.icon className="w-5 h-5" /> {t(item.labelKey)}
                            </Button>
                        ) : (
                            // Gestiona 'Settings', que ara tÃ© fills
                            <Accordion key={item.id} type="single" collapsible className="w-full">
                                <AccordionItem value={item.id} className="border-b-0">
                                    <AccordionTrigger className="px-4 py-3 text-base font-medium hover:no-underline hover:bg-muted rounded-lg">
                                        <div className="flex items-center gap-3"><item.icon className="w-5 h-5" />{t(item.labelKey)}</div>
                                    </AccordionTrigger>
                                    <AccordionContent className="pl-8 pt-2 pb-1">
                                        <div className="flex flex-col gap-1">
                                            {item.children?.map((child: NavItem) => (
                                                <Button key={child.id} variant="ghost" className="w-full justify-start gap-3 px-4 py-2 text-muted-foreground hover:text-foreground" onClick={createClickHandler(child)}>
                                                    <child.icon className="w-4 h-4" />{t(child.labelKey)}
                                                </Button>
                                            ))}
                                        </div>
                                    </AccordionContent>
                                </AccordionItem>
                            </Accordion>
                        )
                    ))}
                    <Button variant="ghost" className="w-full justify-start gap-3 px-4 py-3 text-base font-medium text-red-500 hover:text-red-600" onClick={onOpenSignOutDialog}>
                        <LogOut className="w-5 h-5" /> {t('signOut')}
                    </Button>
                </div>
            </SheetContent>
        </Sheet>
    );
}

// =================== FILE: src/app/[locale]/(app)/_components/module-sidebar.tsx ===================

// UbicaciÃ³: src/app/[locale]/(app)/_components/module-sidebar.tsx

"use client";

import { usePathname } from 'next/navigation';
import { useLocale, useTranslations } from 'next-intl';
import { ChevronLeft } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { cn, getCleanPathname } from '@/lib/utils/utils'; // <-- Importa cn
import type { NavItem } from '@/types/app/navigation';

export function ModuleSidebar({ module, onClose, handleNavigation }: {
    module: NavItem;
    onClose: () => void;
    handleNavigation: (item: NavItem) => void;
}) {
    const locale = useLocale();
    const t = useTranslations('Navigation');
    const fullPathname = usePathname();
    const cleanPathname = getCleanPathname(fullPathname, locale);

    if (!module || !module.children) return null;

    return (
        // âœ…âœ… CANVI APLICAT AQUÃ âœ…âœ…
        <div className={cn(
          "hidden lg:flex w-64 h-full border-r border-border flex-col p-4 flex-shrink-0",
          "bg-slate-100 dark:glass-effect" // Fons clar diferent / Efecte vidre en fosc
        )}>
            <div className="flex items-center justify-between mb-6">
                <h2 className="text-lg font-bold pl-2">{t(module.labelKey)}</h2>
                <Button variant="ghost" size="icon" onClick={onClose}>
                    <ChevronLeft className="h-5 w-5" />
                </Button>
            </div>
            <nav className="flex flex-col gap-2">
                {module.children.map(item => {
                    const isActive = cleanPathname === item.path;
                    return (
                        <Button
                            key={item.id}
                            variant="ghost"
                            onClick={() => handleNavigation(item)}
                            className={cn(
                                'flex items-center justify-start gap-3 px-4 py-2.5 rounded-lg text-sm transition-colors w-full h-auto text-left',
                                isActive
                                    ? 'bg-primary text-primary-foreground font-semibold shadow-sm'
                                    : 'text-muted-foreground hover:bg-muted/50 hover:text-foreground'
                            )}
                        >
                            <item.icon className="w-5 h-5" />
                            <span>{t(item.labelKey)}</span>
                        </Button>
                    );
                })}
            </nav>
        </div>
    );
};

// =================== FILE: src/app/[locale]/(app)/_components/NavItem.tsx ===================

// UbicaciÃ³: /components/layout/NavItem.tsx (o on guardis els teus components)

"use client";

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { useLocale } from 'next-intl';

import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { cn, getCleanPathname } from '@/lib/utils/utils';
import type { NavItem as NavItemType } from '@/types/app/navigation';

// Definim les propietats que rebrÃ  el nostre component
interface NavItemProps {
    item: NavItemType;
    onClick: (e: React.MouseEvent<HTMLAnchorElement>, item: NavItemType) => void;
    t: (key: string) => string; // Passem la funciÃ³ de traducciÃ³ per mantenir el component pur
}

export function NavItem({ item, onClick, t }: NavItemProps) {
    const fullPathname = usePathname();
    const locale = useLocale();
    
    // La lÃ²gica per determinar si l'Ã­tem estÃ  actiu
    const activeCheckPath = item.basePath || item.path;
    const isActive = getCleanPathname(fullPathname, locale).startsWith(activeCheckPath);

    return (
        <TooltipProvider delayDuration={100}>
            <Tooltip>
                <TooltipTrigger asChild>
                    <Link
                        href={`/${locale}${item.path}`}
                        onClick={(e) => onClick(e, item)} // Cridem a la funciÃ³ del pare
                        className={cn(
                            'flex items-center justify-center h-12 w-12 rounded-lg transition-colors relative',
                            isActive 
                                ? 'bg-primary text-primary-foreground' 
                                : 'text-muted-foreground hover:bg-muted'
                        )}
                        aria-label={t(item.labelKey)}
                    >
                        <item.icon className="w-6 h-6" />
                    </Link>
                </TooltipTrigger>
                <TooltipContent side="right" className="ml-2">
                    <p>{t(item.labelKey)}</p>
                </TooltipContent>
            </Tooltip>
        </TooltipProvider>
    );
}

// =================== FILE: src/app/[locale]/(app)/_components/ui/redirect-animation.tsx ===================

// src/app/_components/ui/redirect-animation.tsx
"use client"; // âœ… Indica a Next.js que aquest component s'executa al client (necessari per animacions i estat).

import { motion } from 'framer-motion'; // âœ… Importem Framer Motion per gestionar animacions.
import { Rocket } from 'lucide-react'; // âœ… Icona de coet de la llibreria Lucide.
import { useTranslations } from 'next-intl'; // âœ… Import

export default function RedirectAnimation() {
  const t = useTranslations('RedirectAnimation'); // âœ… Hook

  // âœ… Component que mostra una animaciÃ³ mentre es prepara l'espai de treball.
  return (
    <div className="flex flex-col items-center justify-center gap-6 text-center">
      {/* âœ… AnimaciÃ³ principal del coet */}
      <motion.div
        // Estat inicial del coet: posiciÃ³ vertical y=0, opacitat completa i lleuger gir.
        initial={{ y: 0, opacity: 1, rotate: -45 }}
        // AnimaciÃ³: el coet es mou cap amunt i desapareix (opacitat 0).
        animate={{ y: -150, opacity: 0 }}
        // ConfiguraciÃ³ de la transiciÃ³: durada, suavitzat, repeticiÃ³ infinita amb retard.
        transition={{
          duration: 2,
          ease: "easeInOut",
          repeat: Infinity,
          repeatType: "loop",
          repeatDelay: 1,
        }}
      >
        {/* âœ… Icona del coet estilitzada */}
        <Rocket className="w-24 h-24 text-primary" />
      </motion.div>

      {/* âœ… Text que apareix suaument desprÃ©s dâ€™un retard */}
      <motion.p
        initial={{ opacity: 0 }} // El text comenÃ§a invisible.
        animate={{ opacity: 1 }} // Es fa visible.
        transition={{ delay: 0.5, duration: 1 }} // Apareix desprÃ©s de 0.5s, dura 1s.
        className="text-2xl font-semibold text-muted-foreground"
      >
        {t('loadingWorkspace')} {/* âœ… Text traduÃ¯t */}
        </motion.p>
    </div>
  );
}


// =================== FILE: src/app/[locale]/(auth)/auth/actions.ts ===================

"use server";

import { z } from 'zod';
import { createClient, createAdminClient } from "@/lib/supabase/server";
import { headers } from "next/headers";
import { redirect } from "next/navigation";

// âœ… PRINCIPI DRY: Un helper per a inicialitzar el context de l'acciÃ³
async function createActionContext() {
    const supabase = createClient();
    const headersList = await headers();
    const locale = headersList.get('x-next-intl-locale') || 'ca';
    const origin = headersList.get('origin');
    return { supabase, locale, origin };
}

// --- Esquemes de ValidaciÃ³ amb Zod ---
const LoginSchema = z.object({
    email: z.string().email("L'adreÃ§a d'email no Ã©s vÃ lida."),
    password: z.string().min(1, "La contrasenya Ã©s obligatÃ²ria."),
});

const SignupSchema = z.object({
    email: z.string().email("L'adreÃ§a d'email no Ã©s vÃ lida."),
    fullName: z.string().min(1, "El nom complet Ã©s obligatori.").optional(), 
    password: z.string().min(8, "La contrasenya ha de tenir almenys 8 carÃ cters."),
    invite_token: z.string().optional(),
});

const ForgotPasswordSchema = z.object({
    email: z.string().email("Si us plau, introdueix una adreÃ§a d'email vÃ lida."),
});

const UpdatePasswordSchema = z.object({
    password: z.string().min(8, "La nova contrasenya ha de tenir almenys 8 carÃ cters."),
    code: z.string().min(1, "Falta el token de restabliment."),
});

// --- âœ… CANVI: Definim un tipus de retorn unificat per a les accions d'autenticaciÃ³ ---
// AixÃ² permetrÃ  al client gestionar errors sense recarregar la pÃ gina.
type AuthActionResult = {
  success: boolean;
  message?: string | null;      // Missatge d'error directe
  errorKey?: string | null;     // Clau per a traduccions (i18n)
  email?: string | null;        // Per repoblar el camp email
};


// --- Accions Refactoritzades ---

// âœ… CANVI: La funciÃ³ ara retorna una Promise<AuthActionResult>
export async function loginAction(formData: FormData): Promise<AuthActionResult> {
    const { supabase, locale } = await createActionContext();
    const email = formData.get('email') as string; // Obtenim l'email abans de validar
    const result = LoginSchema.safeParse(Object.fromEntries(formData));

    if (!result.success) {
        // âŒ Abans: return redirect(...)
        // âœ… Ara: Retornem un objecte d'error
        return {
            success: false,
            message: result.error.issues[0].message,
            errorKey: 'validation_failed',
            email: email, // Retornem l'email (fins i tot si Ã©s invÃ lid) per mantenir-lo al camp
        };
    }

    const { error } = await supabase.auth.signInWithPassword(result.data);
    if (error) {
        // âŒ Abans: return redirect(...)
        // âœ… Ara: Retornem un objecte d'error
        return {
            success: false,
            message: "Credencials incorrectes.", // Missatge simple
            errorKey: 'invalid_credentials',    // Clau per a i18n al client
            email: result.data.email,         // Retornem l'email validat
        };
    }

    // âœ… Ãˆxit: La redirecciÃ³ nomÃ©s passa si tot ha anat bÃ©.
    redirect(`/${locale}/dashboard`);
}

// âœ… CANVI: La funciÃ³ ara retorna una Promise<AuthActionResult>
export async function signupAction(formData: FormData): Promise<AuthActionResult> {
    const { supabase, origin } = await createActionContext();
    const supabaseAdmin = createAdminClient();
    const email = formData.get('email') as string; // Obtenim l'email abans de validar
    const result = SignupSchema.safeParse(Object.fromEntries(formData));

    if (!result.success) {
        // âŒ Abans: return redirect(...)
        // âœ… Ara: Retornem un objecte d'error
        return {
            success: false,
            message: result.error.issues[0].message,
            errorKey: 'validation_failed',
            email: email,
        };
    }

    const { password, fullName, invite_token } = result.data;

    const { data: existingUser } = await supabaseAdmin.from('users').select('id').eq('email', email).single();
    if (existingUser) {
        // âŒ Abans: return redirect(...)
        // âœ… Ara: Retornem un objecte d'error
        return {
            success: false,
            message: "Ja existeix un compte amb aquest correu.",
            errorKey: 'user_exists',
            email: email,
        };
    }

    const nextUrl = invite_token ? `/dashboard?token=${invite_token}` : `/onboarding`;

    const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
        email,
        password,
        options: {
            emailRedirectTo: `${origin}/auth/callback?next=${encodeURIComponent(nextUrl)}`,
            ...(fullName && { data: { full_name: fullName } })
        },
    });

    if (signUpError) {
        // âŒ Abans: return redirect(...)
        // âœ… Ara: Retornem un objecte d'error
        return {
            success: false,
            message: signUpError.message,
            errorKey: 'signup_failed',
            email: email,
        };
    }
    if (!signUpData.user) {
        // âŒ Abans: return redirect(...)
        // âœ… Ara: Retornem un objecte d'error
        return {
            success: false,
            message: "No s'ha pogut crear l'usuari.",
            errorKey: 'signup_failed_no_user',
            email: email,
        };
    }

    // âœ… Ãˆxit: Redirigim a la pÃ gina de "comprova el teu email"
    return redirect(`/auth/check-email?email=${encodeURIComponent(email)}`);
}

export async function logoutAction() {
    const { supabase, locale } = await createActionContext();
    await supabase.auth.signOut();
    redirect(`/${locale}/login`);
}

export async function googleAuthAction(inviteToken?: string | null) {
    const { supabase, origin } = await createActionContext();
    if (inviteToken) {
        await supabase.auth.signOut();
    }
    let redirectTo = `${origin}/auth/callback`;
    if (inviteToken) {
        redirectTo += `?next=/dashboard?token=${inviteToken}`;
    }
    const { data, error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo },
    });

    if (error) {
        // Aquesta redirecciÃ³ Ã©s correcta, ja que el flux OAuth Ã©s diferent
        // i no podem retornar un objecte a un formulari que no ha iniciat l'acciÃ³.
        return redirect(`/login?message=${encodeURIComponent("No s'ha pogut iniciar sessiÃ³ amb Google.")}`);
    }
    return redirect(data.url);
}

// âœ… Aquesta funciÃ³ ja seguia el patrÃ³ correcte de retornar un objecte.
export async function forgotPasswordAction(formData: FormData): Promise<{ success: boolean; message: string }> {
    const { supabase, origin, locale } = await createActionContext();
    const result = ForgotPasswordSchema.safeParse(Object.fromEntries(formData));

    if (!result.success) {
        return { success: false, message: result.error.issues[0].message };
    }

    const { error } = await supabase.auth.resetPasswordForEmail(result.data.email, {
        redirectTo: `${origin}/${locale}/auth/reset-password`,
    });

    if (error) {
        console.error("Error en restablir la contrasenya:", error);
        return { success: false, message: "No s'ha pogut iniciar el procÃ©s de restabliment." };
    }

    return { success: true, message: "Si l'email existeix, rebrÃ s un enllaÃ§ per a restablir la teva contrasenya." };
}

export async function updatePasswordAction(formData: FormData) {
    const { supabase, locale } = await createActionContext();
    const result = UpdatePasswordSchema.safeParse(Object.fromEntries(formData));

    if (!result.success) {
        return redirect(`/${locale}/auth/reset-password?message=${encodeURIComponent(result.error.issues[0].message)}`);
    }

    const { code, password } = result.data;

    const { error: exchangeError } = await supabase.auth.exchangeCodeForSession(code);
    if (exchangeError) {
        return redirect(`/${locale}/auth/reset-password?message=L'enllaÃ§ de restabliment Ã©s invÃ lid o ha caducat.`);
    }

    const { error: updateError } = await supabase.auth.updateUser({ password });
    if (updateError) {
        return redirect(`/${locale}/auth/reset-password?message=${encodeURIComponent(updateError.message)}`);
    }

    return redirect(`/${locale}/login?message=La teva contrasenya s'ha actualitzat correctament.`);
}

// =================== FILE: src/app/[locale]/(auth)/auth/callback/route.ts ===================

import { createClient, createAdminClient } from "@/lib/supabase/server";
import { headers } from "next/headers";
import { NextResponse, type NextRequest } from 'next/server';

export async function GET(request: NextRequest) {
    const { searchParams, origin } = new URL(request.url);
    const code = searchParams.get('code');
    const next = searchParams.get('next') ?? '/dashboard'; // Per defecte, anem al dashboard
    const locale = (await headers()).get('x-next-intl-locale') || 'ca';

    if (code) {

        const supabase = createClient();
        const { error, data: { user } } = await supabase.auth.exchangeCodeForSession(code);

        if (!error && user) {
            const inviteToken = new URL(`${origin}${next}`).searchParams.get('token');

            // CAS 1: L'usuari ve amb una invitaciÃ³
            if (inviteToken) {
                const supabaseAdmin = createAdminClient();
                const { data: invitation } = await supabaseAdmin.from('invitations').select('*').eq('token', inviteToken).single();

                if (invitation) {
                    await supabaseAdmin.from('team_members').insert({ team_id: invitation.team_id, user_id: user.id, role: invitation.role });
                    const { data: subscription } = await supabaseAdmin.from('subscriptions').select('plan_id, status').eq('team_id', invitation.team_id).single();
                    const teamPlan = (subscription?.status === 'active') ? subscription.plan_id : 'free';

                    await supabaseAdmin.auth.admin.updateUserById(user.id, { app_metadata: { active_team_id: invitation.team_id, active_team_plan: teamPlan } });
                    await supabaseAdmin.from('profiles').update({ onboarding_completed: true }).eq('id', user.id);
                    await supabaseAdmin.from('invitations').delete().eq('id', invitation.id);
                    // âœ… PAS CRUCIAL: Forcem el refresc de la sessiÃ³ per a actualitzar la cookie

                    await supabase.auth.refreshSession();
                    // DesprÃ©s de gestionar la invitaciÃ³, el portem directament al dashboard
                    return NextResponse.redirect(`${origin}/${locale}/dashboard`);
                }
            }

            // CAS 2: Usuari normal (sense invitaciÃ³)
            const { data: profile } = await supabase.from('profiles').select('onboarding_completed').eq('id', user.id).single();
            if (profile && !profile.onboarding_completed) {
                return NextResponse.redirect(`${origin}/${locale}/onboarding`);
            }

            // Per a la resta de casos, el portem a la seva destinaciÃ³ (normalment, el dashboard)
            return NextResponse.redirect(`${origin}/${locale}${next.split('?')[0]}`);
        }
    }

    return NextResponse.redirect(`${origin}/${locale}/login?error=auth_failed`);
}

// =================== FILE: src/app/[locale]/(auth)/auth/check-email/page.tsx ===================

"use client";

import { Suspense } from 'react';
import { useSearchParams } from 'next/navigation';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { MailCheck } from 'lucide-react';

function CheckEmailMessage() {
    const searchParams = useSearchParams();
    const email = searchParams.get('email');

    if (!email) {
        return (
            <Card className="w-full max-w-md">
                <CardHeader>
                    <CardTitle>Error</CardTitle>
                </CardHeader>
                <CardContent>
                    <p>No s'ha proporcionat cap correu electrÃ²nic.</p>
                </CardContent>
            </Card>
        );
    }


    // AQUEST COMPONENT ARA NOMÃ‰S MOSTRA EL MISSATGE. NO TÃ‰ useEffect NI LÃ’GICA DE REDIRECCIÃ“.
    return (
        <Card className="w-full max-w-md text-center">
            <CardHeader>
                <div className="mx-auto bg-primary/10 text-primary p-3 rounded-full w-fit">
                    <MailCheck className="w-8 h-8" />
                </div>
                <CardTitle className="mt-4 text-2xl">NomÃ©s un pas mÃ©s!</CardTitle>
                <CardDescription>
                    T'hem enviat un enllaÃ§ de confirmaciÃ³ a <br/>
                    <strong className="text-foreground">{email}</strong>
                </CardDescription>
            </CardHeader>
            <CardContent>
                <p className="text-sm text-muted-foreground">
                    Si us plau, fes clic a l'enllaÃ§ per activar el teu compte. Si no el veus, revisa la teva carpeta de correu brossa (spam).
                </p>
                <p className="text-xs text-muted-foreground mt-6">
                    Pots tancar aquesta pestanya un cop hagis confirmat el correu a l'altra.
                </p>
            </CardContent>
        </Card>
    );
}

export default function CheckEmailPage() {
    return (
        <div className="flex items-center justify-center min-h-screen bg-muted/40 p-4">
            <Suspense>
                <CheckEmailMessage />
            </Suspense>
        </div>
    );
}

// =================== FILE: src/app/[locale]/(auth)/auth/reset-password/page.tsx ===================

// /app/[locale]/auth/reset-password/_components/ResetPasswordClient.tsx
"use client";

import { useSearchParams } from 'next/navigation';
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import { updatePasswordAction } from '../actions'; // La mateixa acciÃ³

export default function ResetPasswordClient() {
    // Utilitzem el hook de client per obtenir els parÃ metres de cerca de forma segura.
    const searchParams = useSearchParams();
    
    // Accedim als valors directament sense await
    const message = searchParams.get('message');
    const code = searchParams.get('code');

    // Nota: L'acciÃ³ updatePasswordAction s'espera que gestioni l'absÃ¨ncia de 'code'.
    
    return (
        <div className="flex items-center justify-center min-h-screen">
            <div className="w-full max-w-sm space-y-6">
                <h1 className="text-2xl font-bold">Crea una nova contrasenya</h1>
                
                <form action={updatePasswordAction} className="space-y-4">
                    {/* Utilitzem el valor obtingut del hook */}
                    <input type="hidden" name="code" value={code || ''} /> 
                    <div className="space-y-2">
                        <Label htmlFor="password">Nova Contrasenya</Label>
                        <Input id="password" name="password" type="password" required minLength={8} />
                    </div>
                    <Button type="submit" className="w-full">Actualitzar Contrasenya</Button>
                    
                    {message && (
                        <p className="text-sm text-center text-destructive p-2 bg-destructive/10 rounded-md">
                            {message}
                        </p>
                    )}
                </form>
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/(auth)/login/page.tsx ===================

// /app/[locale]/login/page.tsx

import LoginForm from './_components/LoginClient';
import { Suspense } from 'react';

// This Server Component is now very simple.
export default function LoginPage() {
  return (
    // Suspense is still needed because the child component uses a hook to read params.
    <Suspense>
      <LoginForm />
    </Suspense>
  );
}

// =================== FILE: src/app/[locale]/(auth)/login/_components/ForgotPasswordDialog.tsx ===================

"use client";

import { useState, useTransition } from 'react';
import { toast } from 'sonner';
import { useTranslations } from 'next-intl';
import { forgotPasswordAction } from '@/app/[locale]/(auth)/auth/actions';

// UI Components
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter, DialogTrigger } from '@/components/ui/dialog';
import { Loader2, MailCheck } from 'lucide-react';

export function ForgotPasswordDialog() {
    // âœ… CORRECCIÃ“: Agafem l'espai de noms principal 'LoginPage'.
    const t = useTranslations('LoginPage');
    const [isOpen, setIsOpen] = useState(false);
    const [isPending, startTransition] = useTransition();
    const [emailSent, setEmailSent] = useState(false);
    const [userEmail, setUserEmail] = useState("");

    const handleSubmit = (formData: FormData) => {
        const email = formData.get('email') as string;
        setUserEmail(email);

        startTransition(async () => {
            const result = await forgotPasswordAction(formData);
            if (result.success) {
                setEmailSent(true);
            } else {
                toast.error(t('forgotPassword.errorTitle'), { description: result.message });
            }
        });
    };

    const handleOpenChange = (open: boolean) => {
        setIsOpen(open);
        if (!open) {
            // Reseteja l'estat quan el diÃ leg es tanca
            setTimeout(() => {
                setEmailSent(false);
                setUserEmail("");
            }, 300);
        }
    };

    return (
        <Dialog open={isOpen} onOpenChange={handleOpenChange}>
            <DialogTrigger asChild>
                <button type="button" className="text-sm font-medium text-primary hover:underline">
                    {/* âœ… CORRECCIÃ“: Usem la clau completa i correcta. */}
                    {t('forgotPasswordLink')}
                </button>
            </DialogTrigger>
            <DialogContent className="sm:max-w-md">
                {emailSent ? (
                    <div className="text-center p-8">
                        <MailCheck className="w-16 h-16 text-green-500 mx-auto mb-4" />
                        <h3 className="text-xl font-bold">{t('forgotPassword.successTitle')}</h3>
                        <p className="text-muted-foreground mt-2">
                            {t('forgotPassword.successDescription')} <br />
                            <strong className="text-foreground">{userEmail}</strong>
                        </p>
                        <p className="text-xs text-muted-foreground mt-4">{t('forgotPassword.spamWarning')}</p>
                        <Button onClick={() => setIsOpen(false)} className="mt-6 w-full">{t('forgotPassword.closeButton')}</Button>
                    </div>
                ) : (
                    <>
                        <DialogHeader>
                            <DialogTitle>{t('forgotPassword.title')}</DialogTitle>
                            <DialogDescription>{t('forgotPassword.description')}</DialogDescription>
                        </DialogHeader>
                        <form action={handleSubmit}>
                            <div className="grid gap-4 py-4">
                                {/* âœ… CORRECCIÃ“: Usem la clau del nivell superior. */}
                                <Label htmlFor="email-forgot">{t('emailLabel')}</Label>
                                <Input id="email-forgot" name="email" type="email" placeholder={t('emailPlaceholder')} required disabled={isPending} />
                            </div>
                            <DialogFooter>
                                <Button type="submit" disabled={isPending} className="w-full">
                                    {isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                                    {t('forgotPassword.submitButton')}
                                </Button>
                            </DialogFooter>
                        </form>
                    </>
                )}
            </DialogContent>
        </Dialog>
    );
}



// =================== FILE: src/app/[locale]/(auth)/login/_components/LoginClient.tsx ===================

"use client";

import Image from 'next/image';
import Link from 'next/link';
import dynamic from 'next/dynamic';
import { useTranslations } from 'next-intl';

// UI Components
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Separator } from '@/components/ui/separator';
import { Mail, Lock, Loader2, Check, AlertTriangle, ArrowLeft } from 'lucide-react';

// LÃ²gica i components refactoritzats
import { useLoginForm } from '../_hooks/useLoginForm';
import { ForgotPasswordDialog } from './ForgotPasswordDialog';

// Carrega dinÃ mica per a components pesats nomÃ©s de client
const ParticleBackground = dynamic(() => import('@/app/[locale]/(public)/_components/ParticleBackground').then(mod => mod.ParticleBackground), { ssr: false });

// Component de presentaciÃ³ per a la secciÃ³ de branding
const BrandingSection = () => {
    const t = useTranslations('LoginPage');
    return (
        <div className="hidden lg:flex flex-col items-center justify-center p-12 relative z-10">
            <div className="text-center max-w-md">
                <Image src="/android-chrome-192x192.png" alt="Logo de Ribotflow" width={80} height={80} className="mx-auto mb-6" />
                <h1 className="text-4xl font-bold mb-4">{t('welcomeTitle')}</h1>
                <p className="text-lg text-muted-foreground mb-8">{t('welcomeSubtitle')}</p>
                <ul className="space-y-4 text-lg text-left">
                    <li className="flex items-start"><Check className="w-6 h-6 text-primary mr-3 mt-1 shrink-0" /><span>{t('feature1')}</span></li>
                    <li className="flex items-start"><Check className="w-6 h-6 text-primary mr-3 mt-1 shrink-0" /><span>{t('feature2')}</span></li>
                    <li className="flex items-start"><Check className="w-6 h-6 text-primary mr-3 mt-1 shrink-0" /><span>{t('feature3')}</span></li>
                </ul>
            </div>
        </div>
    );
};

export default function LoginClient() {
    const t = useTranslations('LoginPage');
    
    // âœ… El hook ara retorna l'estat controlat per l'email
    const { 
        isPending, 
        isGoogleLoading, 
        errorMessage, 
        email,      // <-- âœ¨ NOU
        setEmail,   // <-- âœ¨ NOU
        handleEmailLogin, 
        handleGoogleLogin 
    } = useLoginForm();

    return (
        <div className="w-full min-h-screen lg:grid lg:grid-cols-2 relative">
            <ParticleBackground />
            <BrandingSection />

            <div className="flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 bg-background relative z-10">
                <Link
                    href="/"
                    className="absolute top-6 left-6 lg:top-8 lg:right-8 lg:left-auto"
                >
                    <Button
                        variant="ghost"
                        size="icon"
                        className="lg:w-auto lg:h-10 lg:px-4 lg:py-2"
                        aria-label={t('goBackHome')}
                    >
                        <ArrowLeft className="w-5 h-5 lg:mr-2" />
                        <span className="hidden lg:inline">
                            {t('goBackHome')}
                        </span>
                    </Button>
                </Link>
                
                <div className="w-full max-w-md space-y-8">
                    <div className="text-center lg:text-left">
                        <h2 className="text-3xl font-bold tracking-tight">{t('title')}</h2>
                        <p className="mt-2 text-muted-foreground">
                            {t('subtitle')}{" "}
                            <Link href="/signup" className="font-medium text-primary hover:underline">{t('signupLink')}</Link>
                        </p>
                    </div>

                    <div className="space-y-6">
                        <Button variant="outline" className="w-full text-lg py-6 flex items-center justify-center" onClick={handleGoogleLogin} disabled={isGoogleLoading || isPending}>
                            {isGoogleLoading ? <Loader2 className="mr-2 h-5 w-5 animate-spin" /> : <Image className="w-5 h-5 mr-3" alt="Google logo" src="https://fonts.gstatic.com/s/i/productlogos/googleg/v6/24px.svg" width={20} height={20} />}
                            <span>{t('googleButton')}</span>
                        </Button>

                        <div className="relative">
                            <div className="absolute inset-0 flex items-center"><Separator /></div>
                            <div className="relative flex justify-center text-xs uppercase"><span className="bg-background px-2 text-muted-foreground">{t('separator')}</span></div>
                        </div>

                        <form action={handleEmailLogin} className="space-y-6">
                            {errorMessage && (
                                <div className="bg-destructive/10 text-destructive border border-destructive/30 p-3 rounded-md flex items-center gap-3 text-sm">
                                    <AlertTriangle className="w-5 h-5 flex-shrink-0" />
                                    <p>{errorMessage}</p>
                                </div>
                            )}
                            <div className="space-y-2">
                                <Label htmlFor="email">{t('emailLabel')}</Label>
                                <div className="relative">
                                    <Mail className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" />
                                    {/* âœ… CONVERTIM L'INPUT A CONTROLAT */}
                                    <Input 
                                        id="email" 
                                        name="email" 
                                        type="email" 
                                        placeholder={t('emailPlaceholder')} 
                                        required 
                                        className="pl-10"
                                        value={email} // <-- âœ¨ Lligat a l'estat
                                        onChange={(e) => setEmail(e.target.value)} // <-- Actualitza l'estat
                                    />
                                </div>
                            </div>
                            <div className="space-y-2">
                                <div className="flex items-center justify-between">
                                    <Label htmlFor="password">{t('passwordLabel')}</Label>
                                    <ForgotPasswordDialog />
                                </div>
                                <div className="relative">
                                    <Lock className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" />
                                    {/* El password no el volem controlar per seguretat i UX, 
                                        es mantÃ© no controlat i s'esborra, la qual cosa Ã©s correcte. */}
                                    <Input id="password" name="password" type="password" required minLength={6} className="pl-10" />
                                </div>
                            </div>
                            <Button type="submit" className="w-full text-lg py-6" disabled={isPending || isGoogleLoading}>
                                {isPending && <Loader2 className="mr-2 h-5 w-5 animate-spin" />}
                                {t('submitButton')}
                            </Button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/(auth)/login/_hooks/useLoginForm.ts ===================

"use client";

import { useTransition, useMemo, useState } from 'react'; // Importem useState
import { useSearchParams } from 'next/navigation';
import { useTranslations } from 'next-intl';
import { loginAction, googleAuthAction } from '@/app/[locale]/(auth)/auth/actions';

/**
 * Custom hook que encapsula tota la lÃ²gica d'estat i accions per al formulari de login.
 */
export function useLoginForm() {
    const t = useTranslations('LoginPage');
    const searchParams = useSearchParams();
    const [isPending, startTransition] = useTransition();
    const [isGoogleLoading, startGoogleTransition] = useTransition();

    // --- âœ¨ CANVIS CLAU ---
    // 1. Estat local per als errors del formulari
    const [formError, setFormError] = useState<string | null>(null);

    // 2. Llegim l'email dels params (per si venim d'un error de redirect, ex: OAuth)
    const emailFromParams = useMemo(() => {
        return searchParams.get('email');
    }, [searchParams]);

    // 3. Estat controlat per a l'email.
    // L'inicialitzem amb l'email de la URL si existeix.
    const [email, setEmail] = useState<string>(emailFromParams || '');
    // --- FI DELS CANVIS ---


    const handleEmailLogin = (formData: FormData) => {
        startTransition(async () => {
            // Reseteja l'error local abans de comenÃ§ar
            setFormError(null);

            // âœ… Captura el resultat de la Server Action
            const result = await loginAction(formData);

            if (!result.success) {
                // Si hi ha un error, actualitza l'estat local
                // Usem la clau d'error per buscar la traducciÃ³
                const errorKey = result.errorKey || 'authFailed';
         
                setFormError(t(`errors.${errorKey}`));
                
                // âœ… CONSERVA L'EMAIL: Actualitzem l'estat de l'email
                // (Encara que ja el controlem, aixÃ² ho faria mÃ©s robust
                // si l'acciÃ³ retornÃ©s un email normalitzat, per exemple)
                if (result.email) {
                    setEmail(result.email);
                }
            }
            // Si tÃ© Ã¨xit (success: true), la Server Action ja haurÃ  redirigit
            // i aquest component es desmuntarÃ , per la qual cosa no cal fer res aquÃ­.
        });
    };

    const handleGoogleLogin = () => {
        startGoogleTransition(() => {
            googleAuthAction();
        });
    };

    // El missatge d'error ara Ã©s una combinaciÃ³ de l'error local (prioritari)
    // i l'error dels searchParams (fallback, p.ex. per OAuth).
    const errorMessage = useMemo(() => {
        // 1. L'error del formulari local (de 'loginAction') tÃ© prioritat
        if (formError) return formError;

        // 2. Errors de searchParams (p.ex. OAuth, o errors antics)
        const message = searchParams.get('message');
        const error = searchParams.get('error');

        if (error === 'invalid_credentials') return t('errors.invalidCredentials');
        if (error === 'auth_failed') return t('errors.authFailed');
        if (error === 'invite_failed') return message || t('errors.inviteFailed');
        if (message) return message;
        
        return null;
    }, [searchParams, t, formError]); // <-- Afegim formError a les dependÃ¨ncies

    return {
        isPending,
        isGoogleLoading,
        errorMessage,
        email, // <-- Retornem l'email controlat
        setEmail, // <-- Retornem el setter per controlar l'input
        handleEmailLogin,
        handleGoogleLogin,
    };
}

// =================== FILE: src/app/[locale]/(auth)/signup/page.tsx ===================

import { SignupClient } from './_components/SignupClient'
import { getTranslations } from 'next-intl/server'
import { type Metadata } from 'next'

// Importem els components de contingut legal
import { PrivacyPolicyContent } from '@/app/[locale]/(legal)/_components/PrivacyPolicyContent'
import { TermsContent } from '@/app/[locale]/(legal)/_components/TermsContent' 

// âœ… 1. Modifiquem la interfÃ­cie per definir 'params' com una Promise.
//    TambÃ© apliquem el mateix a 'searchParams' per a consistÃ¨ncia i evitar futurs errors.
interface SignupPageProps {
  params: Promise<{ locale: string }>;
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>;
}

/**
 * FunciÃ³ per generar les metadades de la pÃ gina.
 */
export async function generateMetadata(props: SignupPageProps): Promise<Metadata> {
  // âœ… 2. Resolem la promesa per accedir al 'locale'.
  const { locale } = await props.params;
  const t = await getTranslations({ locale, namespace: 'SignupPage' });
  return {
    title: t('metaTitle'),
  };
}

/**
 * Component de la pÃ gina de registre (Server Component).
 */
// âœ… 3. Convertim la pÃ gina a 'async' i resolem la promesa dels parÃ metres.
export default async function SignupPage(props: SignupPageProps) {
  const { locale } = await props.params;

  return (
    <SignupClient
      // Passem els Server Components ja renderitzats amb el 'locale' correcte.
      privacyContent={<PrivacyPolicyContent locale={locale} />}
      termsContent={<TermsContent locale={locale} />}
    />
  );
}

// =================== FILE: src/app/[locale]/(auth)/signup/_components/SignupClient.tsx ===================

"use client"

import Image from 'next/image'
// Importem el NOSTRE nou component modal
import { LegalModalTrigger } from '@/components/ui/LegalModalTrigger'
import dynamic from 'next/dynamic'
import { useTranslations } from 'next-intl'
import Link from 'next/link' // Encara el fem servir per anar a /login

// UI Components
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Separator } from '@/components/ui/separator'
import { Mail, Lock, Loader2, Check, AlertTriangle, ArrowLeft } from 'lucide-react'
import { Checkbox } from '@/components/ui/checkbox' // Importa el Checkbox de shadcn/ui

// LÃ²gica
import { useSignupForm } from '../_hooks/useSignupForm'

const ParticleBackground = dynamic(
  () =>
    import('@/app/[locale]/(public)/_components/ParticleBackground').then(
      (mod) => mod.ParticleBackground,
    ),
  { ssr: false },
)

// Component de presentaciÃ³ per a la secciÃ³ de branding
const BrandingSection = () => {
  const t = useTranslations('SignupPage')
  return (
    <div className="hidden lg:flex flex-col items-center justify-center p-12 relative z-10">
      <div className="text-center max-w-md">
        <Image
          src="/android-chrome-192x192.png"
          alt="Logo de Ribotflow"
          width={60}
          height={60}
          className="mx-auto mb-8"
        />
        <h1 className="text-4xl font-bold mb-6">{t('welcomeTitle')}</h1>
        <p className="text-lg text-muted-foreground mb-8">
          {t('welcomeSubtitle')}
        </p>
        <ul className="space-y-4 text-lg text-left">
          <li className="flex items-start">
            <Check className="w-6 h-6 text-primary mr-3 mt-1 shrink-0" />
            <span>{t('feature1')}</span>
          </li>
          <li className="flex items-start">
            <Check className="w-6 h-6 text-primary mr-3 mt-1 shrink-0" />
            <span>{t('feature2')}</span>
          </li>
          <li className="flex items-start">
            <Check className="w-6 h-6 text-primary mr-3 mt-1 shrink-0" />
            <span>{t('feature3')}</span>
          </li>
        </ul>
      </div>
    </div>
  )
}

// âœ… 1. Definim les props que rebrem del Servidor
interface SignupClientProps {
  privacyContent: React.ReactNode
  termsContent: React.ReactNode
}

export function SignupClient({
  privacyContent,
  termsContent,
}: SignupClientProps) {
  const t = useTranslations('SignupPage')
  const commonLegalT = useTranslations('LegalPages.Common')
  const {
    isPending,
    isGoogleLoading,
    errorMessage,
    handleEmailSignup,
    handleGoogleSignup,
    invitedEmail,
  } = useSignupForm()

  return (
    <div className="w-full min-h-screen lg:grid lg:grid-cols-2 relative">
      <ParticleBackground />
      <BrandingSection />

      <div className="flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 bg-background relative z-10">
        <Link
          href="/"
          // PosiciÃ³ mÃ²bil: dalt a l'esquerra
          // PosiciÃ³ escriptori: dalt a la dreta (i esborra l'esquerra)
          className="absolute top-6 left-6 lg:top-8 lg:right-8 lg:left-auto"
        >
          <Button
            variant="ghost" // "ghost" Ã©s mÃ©s net per a aixÃ² que "outline"
            // Mida mÃ²bil: 'icon' (quadrat)
            // Mida escriptori: automÃ tic amb padding
            size="icon"
            className="lg:w-auto lg:h-10 lg:px-4 lg:py-2"
            aria-label={t('goBackHome')}
          >
            {/* Icona: en escriptori tÃ© marge a la dreta */}
            <ArrowLeft className="w-5 h-5 lg:mr-2" />

            {/* Text: ocult en mÃ²bil, visible en escriptori */}
            <span className="hidden lg:inline">
              {t('goBackHome')}
            </span>
          </Button>
        </Link>
        <div className="w-full max-w-md space-y-8">
          <div className="text-center lg:text-left">
            <h2 className="text-3xl font-bold tracking-tight">{t('title')}</h2>
            <p className="mt-2 text-muted-foreground">
              {t('subtitle')}{' '}
              <Link
                href="/login"
                className="font-medium text-primary hover:underline"
              >
                {t('loginLink')}
              </Link>
            </p>
          </div>

          <div className="space-y-6">
            <Button
              variant="outline"
              className="w-full text-lg py-6"
              onClick={handleGoogleSignup}
              disabled={isGoogleLoading || isPending}
            >
              {isGoogleLoading ? (
                <Loader2 className="mr-2 h-5 w-5 animate-spin" />
              ) : (
                <Image
                  className="w-5 h-5 mr-3"
                  alt="Google logo"
                  src="https://fonts.gstatic.com/s/i/productlogos/googleg/v6/24px.svg"
                  width={20}
                  height={20}
                />
              )}
              <span>{t('googleButton')}</span>
            </Button>

            <div className="relative">
              <div className="absolute inset-0 flex items-center">
                <Separator />
              </div>
              <div className="relative flex justify-center text-xs uppercase">
                <span className="bg-background px-2 text-muted-foreground">
                  {t('separator')}
                </span>
              </div>
            </div>

            <form action={handleEmailSignup} className="space-y-6">
              {errorMessage && (
                <div className="bg-destructive/10 text-destructive border border-destructive/30 p-3 rounded-md flex items-center gap-3 text-sm">
                  <AlertTriangle className="w-5 h-5 flex-shrink-0" />
                  <p>{errorMessage}</p>
                </div>
              )}
              <div className="space-y-2">
                <Label htmlFor="email">{t('emailLabel')}</Label>
                <div className="relative">
                  <Mail className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" />
                  <Input
                    id="email"
                    name="email"
                    type="email"
                    placeholder={t('emailPlaceholder')}
                    required
                    className="pl-10"
                    defaultValue={invitedEmail ?? undefined}
                    readOnly={!!invitedEmail}
                  />
                </div>
                {invitedEmail && (
                  <p className="text-xs text-muted-foreground">
                    Aquesta invitaciÃ³ Ã©s exclusiva per a aquest correu
                    electrÃ²nic.
                  </p>
                )}
              </div>
              <div className="space-y-2">
                <Label htmlFor="password">{t('passwordLabel')}</Label>
                <div className="relative">
                  <Lock className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" />
                  <Input
                    id="password"
                    name="password"
                    type="password"
                    required
                    minLength={6}
                    placeholder={t('passwordPlaceholder')}
                    className="pl-10"
                  />
                </div>
              </div>

              {/* --- Checkboxes Legals AMB MODAL --- */}
              <div className="flex items-start space-x-3">
                <Checkbox
                  id="terms"
                  name="termsAccepted"
                  required
                  disabled={isPending || isGoogleLoading}
                  className="mt-0.5" // Ajusta l'alineaciÃ³
                />
                <Label
                  htmlFor="terms"
                  className="text-sm font-normal leading-snug text-muted-foreground"
                >
                  {t('acceptTermsPrefix')}{' '}
                  {/* âœ… 2. Fem servir el LegalModalTrigger */}
                  <LegalModalTrigger
                    title={commonLegalT('termsConditionsTitle')}
                    triggerText={commonLegalT('termsConditionsTitle')}
                  >
                    {/* âœ… 3. Passem el contingut rebut per props */}
                    {termsContent}
                  </LegalModalTrigger>
                </Label>
              </div>

              <div className="flex items-start space-x-3">
                <Checkbox
                  id="privacy"
                  name="privacyAccepted"
                  required
                  disabled={isPending || isGoogleLoading}
                  className="mt-0.5" // Ajusta l'alineaciÃ³
                />
                <Label
                  htmlFor="privacy"
                  className="text-sm font-normal leading-snug text-muted-foreground"
                >
                  {t('acceptPrivacyPrefix')}{' '}
                  {/* âœ… 2. Fem servir el LegalModalTrigger */}
                  <LegalModalTrigger
                    title={commonLegalT('privacyPolicyTitle')}
                    triggerText={commonLegalT('privacyPolicyTitle')}
                  >
                    {/* âœ… 3. Passem el contingut rebut per props */}
                    {privacyContent}
                  </LegalModalTrigger>
                </Label>
              </div>

              <Button
                type="submit"
                className="w-full text-lg py-6"
                disabled={isPending || isGoogleLoading}
              >
                {isPending && (
                  <Loader2 className="mr-2 h-5 w-5 animate-spin" />
                )}
                {t('submitButton')}
              </Button>
            </form>
          </div>
        </div>
      </div>
    </div>
  )
}

// =================== FILE: src/app/[locale]/(auth)/signup/_hooks/useSignupForm.ts ===================

// /app/[locale]/signup/_hooks/useSignupForm.ts

"use client";

import { useTransition, useMemo } from 'react';
import { useSearchParams } from 'next/navigation';
import { useTranslations } from 'next-intl';
import { signupAction, googleAuthAction } from '@/app/[locale]/(auth)/auth/actions';

/**
 * Hook que encapsula tota la lÃ²gica d'estat i accions per al formulari de registre.
 */
// âœ… JA NO NECESSITA REBRE EL TOKEN COM A ARGUMENT
export function useSignupForm() {
    const t = useTranslations('SignupPage');
    const searchParams = useSearchParams();
    const [isPending, startTransition] = useTransition();
    const [isGoogleLoading, startGoogleTransition] = useTransition();

    // âœ… LLEGIM EL TOKEN I L'EMAIL DIRECTAMENT AQUÃ
    const inviteToken = useMemo(() => searchParams.get('invite_token'), [searchParams]);
    const invitedEmail = useMemo(() => searchParams.get('email'), [searchParams]);

    const handleEmailSignup = (formData: FormData) => {
        if (inviteToken) {
            formData.append('invite_token', inviteToken);
        }
        startTransition(() => {
            signupAction(formData);
        });
    };

    const handleGoogleSignup = () => {
        startGoogleTransition(() => {
            googleAuthAction(inviteToken);
        });
    };

    const errorMessage = useMemo(() => {
        const errorKey = searchParams.get('errorKey');
        const message = searchParams.get('message');

        if (errorKey) {
            // Intenta obtenir la traducciÃ³. Si no existeix, mostra la clau com a fallback.
            return t(`errors.${errorKey}`) || errorKey;
        }
        if (message) {
            return message;
        }
        return null;
    }, [searchParams, t]);


    return {
        isPending,
        isGoogleLoading,
        errorMessage,
        handleEmailSignup,
        handleGoogleSignup,
        inviteToken,    // âœ… RETORNEM ELS VALORS LLEGITS
        invitedEmail,   // âœ… RETORNEM ELS VALORS LLEGITS
    };
}

// =================== FILE: src/app/[locale]/(legal)/avis-legal/page.tsx ===================

import { LegalNoticeContent } from '../_components/LegalNoticeContent'
import { type Metadata } from 'next'
import { getTranslations } from 'next-intl/server'

// âœ… 1. Modifiquem la interfÃ­cie perquÃ¨ 'params' sigui una Promise.
interface PageProps {
  params: Promise<{ locale: string }>;
}

/**
 * FunciÃ³ per generar les metadades de la pÃ gina.
 */
export async function generateMetadata(props: PageProps): Promise<Metadata> {
  // âœ… 2. Resolem la promesa per accedir al 'locale'.
  const { locale } = await props.params;
  const t = await getTranslations({ locale, namespace: 'LegalPages.LegalNotice' });
  return {
    title: t('metaTitle'),
  };
}

/**
 * Component de la pÃ gina, ara renderitza el component de contingut.
 */
// âœ… 3. Modifiquem la signatura per rebre 'props' i resoldre la promesa.
export default async function LegalNoticeFallbackPage(props: PageProps) {
  const { locale } = await props.params;
  return <LegalNoticeContent locale={locale} />;
}

// =================== FILE: src/app/[locale]/(legal)/politica-cookies/page.tsx ===================

import { CookiePolicyContent } from '../_components/CookiePolicyContent' // <-- Importa el nou component
import { type Metadata } from 'next'
import { getTranslations } from 'next-intl/server'

interface PageProps {
  params: Promise<{ locale: string }>;
}

export async function generateMetadata(props: PageProps): Promise<Metadata> {
  const { locale } = await props.params;

  const t = await getTranslations({ locale, namespace: 'LegalPages.CookiePolicy' })
  return {
    title: t('metaTitle'),
  }
}

// Ara la pÃ gina nomÃ©s renderitza el component de contingut
export default async function CookiePolicyFallbackPage(props: PageProps) {
  const { locale } = await props.params;
  return <CookiePolicyContent locale={locale} />
}

// =================== FILE: src/app/[locale]/(legal)/politica-privacitat/page.tsx ===================

import { getTranslations } from 'next-intl/server';
import { type Metadata } from 'next';

// âœ… 1. Definim la interfÃ­cie amb 'params' com a Promise.
interface LegalPageProps {
  params: Promise<{ locale: string }>;
}

export async function generateMetadata(props: LegalPageProps): Promise<Metadata> {
  const { locale } = await props.params; // âœ… 2. Resolem la promesa.
  const t = await getTranslations({ locale, namespace: 'LegalPages.PrivacyPolicy' });
  return {
    title: t('metaTitle'),
  };
}

export default async function PrivacyPolicyPage(props: LegalPageProps) {
  const { locale } = await props.params; // âœ… 3. Resolem la promesa.
  const t = await getTranslations({ locale, namespace: 'LegalPages.PrivacyPolicy' });
  // Pots estructurar el contingut com vulguis (headings, parÃ grafs)
  return (
    <div className="container mx-auto px-4 py-8 max-w-4xl prose dark:prose-invert"> {/* Usa 'prose' per estils bÃ sics */}
      <h1>{t('title')}</h1>
      <p>{t('lastUpdated', { date: new Date().toLocaleDateString(locale) })}</p>

      <section>
        <h2>{t('section1.title')}</h2> {/* 1. Qui som (Responsable) */}
        <p>{t('section1.content.p1', { companyName: 'El Teu Nom/Empresa', companyVat: 'El Teu NIF/CIF', companyAddress: 'La Teva AdreÃ§a', companyEmail: 'El Teu Email de Contacte' })}</p>
      </section>

      <section>
        <h2>{t('section2.title')}</h2> {/* 2. Quines dades tractem i per quÃ¨ */}
        <p>{t('section2.content.p1')}</p>
        <ul>
          <li>{t('section2.content.item1')}</li> {/* Dades d'identificaciÃ³ i contacte */}
          <li>{t('section2.content.item2')}</li> {/* Dades professionals */}
          <li>{t('section2.content.item3')}</li> {/* Dades introduÃ¯des per l'usuari (clients, factures...) -> ROL ENCARREGAT */}
          <li>{t('section2.content.item4')}</li> {/* Dades de navegaciÃ³/Ãºs */}
          <li>{t('section2.content.item5')}</li> {/* Dades de pagament (si aplica) */}
        </ul>
        <p>{t('section2.content.p2')}</p> {/* Finalitats */}
         <ul>
          <li>{t('section2.content.purpose1')}</li> {/* PrestaciÃ³ servei */}
          <li>{t('section2.content.purpose2')}</li> {/* Comunicacions */}
          <li>{t('section2.content.purpose3')}</li> {/* Millores */}
          <li>{t('section2.content.purpose4')}</li> {/* Seguretat */}
          <li>{t('section2.content.purpose5')}</li> {/* Compliment legal */}
        </ul>
      </section>

      <section>
        <h2>{t('section3.title')}</h2> {/* 3. Base Legal */}
         <p>{t('section3.content.p1')}</p>
         <ul>
          <li>{t('section3.content.basis1')}</li> {/* Contracte */}
          <li>{t('section3.content.basis2')}</li> {/* Consentiment (ex: newsletter) */}
          <li>{t('section3.content.basis3')}</li> {/* InterÃ¨s legÃ­tim (ex: seguretat) */}
          <li>{t('section3.content.basis4')}</li> {/* ObligaciÃ³ legal */}
        </ul>
      </section>

      <section>
          <h2>{t('section4.title')}</h2> {/* 4. Rol com a Encarregat del Tractament */}
          <p>{t('section4.content.p1')}</p> {/* ExplicaciÃ³ dades clients/proveÃ¯dors de l'usuari */}
          <p>{t('section4.content.p2')}</p> {/* ReferÃ¨ncia a Termes i Condicions (DPA) */}
      </section>

      <section>
        <h2>{t('section5.title')}</h2> {/* 5. Amb qui compartim les dades */}
        <p>{t('section5.content.p1')}</p>
        <ul>
          <li>{t('section5.content.item1', { provider: 'Supabase' })}</li> {/* ProveÃ¯dor infraestructura */}
          {/* Afegeix altres si cal: PassarelÂ·les pagament, Emailing, Analytics... */}
        </ul>
         <p>{t('section5.content.p2')}</p> {/* TransferÃ¨ncies internacionals */}
      </section>

      <section>
        <h2>{t('section6.title')}</h2> {/* 6. Quant temps guardem les dades */}
        <p>{t('section6.content.p1')}</p>
      </section>

      <section>
        <h2>{t('section7.title')}</h2> {/* 7. Quins sÃ³n els teus drets */}
        <p>{t('section7.content.p1')}</p> {/* Drets ARSLOP */}
        <p>{t('section7.content.p2', { email: 'El Teu Email de Contacte' })}</p> {/* Com exercir-los */}
        <p>{t('section7.content.p3')}</p> {/* Dret a reclamar AEPD */}
      </section>

      <section>
        <h2>{t('section8.title')}</h2> {/* 8. Mesures de Seguretat */}
        <p>{t('section8.content.p1')}</p>
      </section>

       <section>
        <h2>{t('section9.title')}</h2> {/* 9. Canvis a la PolÃ­tica */}
        <p>{t('section9.content.p1')}</p>
      </section>

      {/* ... Afegeix altres seccions necessÃ ries (Cookies, Menors...) */}
    </div>
  );
}

// =================== FILE: src/app/[locale]/(legal)/termes-condicions/page.tsx ===================

import { getTranslations } from 'next-intl/server';
import { type Metadata } from 'next';
import Link from 'next/link';

// âœ… 1. Definim la interfÃ­cie amb 'params' com a Promise.
interface LegalPageProps {
  params: Promise<{ locale: string }>;
}

export async function generateMetadata(props: LegalPageProps): Promise<Metadata> {
  const { locale } = await props.params; // âœ… 2. Resolem la promesa.
  const t = await getTranslations({ locale, namespace: 'LegalPages.TermsAndConditions' });
  return {
    title: t('metaTitle'),
  };
}

export default async function TermsAndConditionsPage(props: LegalPageProps) {
  const { locale } = await props.params; // âœ… 3. Resolem la promesa.
  const t = await getTranslations({ locale, namespace: 'LegalPages.TermsAndConditions' });
  const commonT = await getTranslations({ locale, namespace: 'LegalPages.Common' });
  return (
    <div className="container mx-auto px-4 py-8 max-w-4xl prose dark:prose-invert">
      <h1>{t('title')}</h1>
      <p>{commonT('lastUpdated', { date: new Date().toLocaleDateString(locale) })}</p>

      <section>
        <h2>{t('section1.title')}</h2> {/* 1. AcceptaciÃ³ */}
        <p>{t('section1.content.p1', { appName: commonT('appName'), companyName: commonT('companyData.name') })}</p>
        <p>{t('section1.content.p2')} <Link href={commonT('privacyPolicyLink')}>{commonT('privacyPolicyTitle')}</Link>.</p>
      </section>

      <section>
        <h2>{t('section2.title')}</h2> {/* 2. DescripciÃ³ del Servei */}
        <p>{t('section2.content.p1', { appName: commonT('appName') })}</p>
         {/* Descriu les funcionalitats principals */}
      </section>

      <section>
        <h2>{t('section3.title')}</h2> {/* 3. AccÃ©s i Compte d'Usuari */}
        <p>{t('section3.content.p1')}</p>
        <p>{t('section3.content.p2')}</p>
        <p>{t('section3.content.p3')}</p>
      </section>

      <section>
        <h2>{t('section4.title')}</h2> {/* 4. Obligacions de l'Usuari */}
        <p>{t('section4.content.p1')}</p>
         <ul>
          <li>{t('section4.content.obligation1')}</li>
          <li>{t('section4.content.obligation2')}</li>
          <li>{t('section4.content.obligation3')}</li>
          <li>{t('section4.content.obligation4')}</li>
           {/* ... mÃ©s obligacions */}
        </ul>
      </section>

       <section>
        <h2>{t('section5.title')}</h2> {/* 5. Condicions EconÃ²miques (SI APLICA) */}
        {/* Si Ã©s gratuÃ¯t, indica-ho. Si Ã©s de pagament, detalla plans, preus, pagament, renovaciÃ³, cancelÂ·laciÃ³... */}
        <p>{t('section5.content.p1')}</p>
      </section>

      <section>
        <h2>{t('section6.title')}</h2> {/* 6. Propietat IntelÂ·lectual */}
        <p>{t('section6.content.p1', { appName: commonT('appName'), companyName: commonT('companyData.name') })}</p>
        <p>{t('section6.content.p2')}</p>
      </section>

      <section>
        <h2>{t('section7.title')}</h2> {/* 7. ProtecciÃ³ de Dades (DPA) */}
        <p>{t('section7.content.p1')} <Link href={commonT('privacyPolicyLink')}>{commonT('privacyPolicyTitle')}</Link>.</p>
        <p><strong>{t('section7.content.dpaTitle')}</strong></p>
        <p>{t('section7.content.dpaP1', { appName: commonT('appName') })}</p>
        <p>{t('section7.content.dpaP2')}</p>
        {/* Detalla aquÃ­ o en un annex les obligacions com a Encarregat del Tractament */}
      </section>

      <section>
        <h2>{t('section8.title')}</h2> {/* 8. Garanties i LimitaciÃ³ de Responsabilitat */}
        <p>{t('section8.content.p1')}</p>
        <p>{t('section8.content.p2')}</p>
        {/* ... lÃ­mits especÃ­fics de responsabilitat ... */}
      </section>

       <section>
        <h2>{t('section9.title')}</h2> {/* 9. ModificaciÃ³ dels Termes */}
        <p>{t('section9.content.p1')}</p>
      </section>

       <section>
        <h2>{t('section10.title')}</h2> {/* 10. Durada i TerminaciÃ³ */}
        <p>{t('section10.content.p1')}</p>
        <p>{t('section10.content.p2')}</p>
      </section>

      <section>
        <h2>{t('section11.title')}</h2> {/* 11. Llei Aplicable i JurisdicciÃ³ */}
        <p>{t('section11.content.p1')}</p>
      </section>

    </div>
  );
}

// =================== FILE: src/app/[locale]/(legal)/_components/CookiePolicyContent.tsx ===================

import { getTranslations } from 'next-intl/server'
import Link from 'next/link'
import { Separator } from '@/components/ui/separator'

interface ContentProps {
  locale: string
}

export async function CookiePolicyContent({ locale }: ContentProps) {
  const t = await getTranslations({ locale, namespace: 'LegalPages.CookiePolicy' })
  const commonT = await getTranslations({ locale, namespace: 'LegalPages.Common' })

  // Link helper
  const LegalLink = ({
    href,
    children,
  }: {
    href: string
    children: React.ReactNode
  }) => (
    <Link
      href={href}
      target="_blank"
      rel="noopener noreferrer"
      className="text-primary underline-offset-4 hover:underline"
    >
      {children}
    </Link>
  )
  
  // Link extern per als navegadors
  const ExternalLink = ({ href, children }: { href: string; children: React.ReactNode }) => (
     <a
      href={href}
      target="_blank"
      rel="noopener noreferrer"
      className="text-primary underline-offset-4 hover:underline"
    >
      {children}
    </a>
  )

  return (
    <div className="space-y-8">
      {/* --- TÃ­tol Principal --- */}
      <div className="space-y-2 pb-4 border-b">
        <h1 className="text-3xl font-bold tracking-tight text-primary">
          {t('title')}
        </h1>
        <p className="text-sm text-muted-foreground">
          {commonT('lastUpdated', { date: new Date().toLocaleDateString(locale) })}
        </p>
      </div>

      {/* === Seccions === */}
      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section1.title')}
        </h2>
        <div className="pl-5">
          <p className="text-muted-foreground leading-relaxed">
            {t('section1.content.p1')}
          </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section2.title')}
        </h2>
        <div className="pl-5 space-y-4">
          <p className="text-muted-foreground leading-relaxed">
            {t('section2.content.p1', { appName: commonT('appName') })}
          </p>
          {/* Tipus 1: TÃ¨cniques */}
          <div>
            <p className="font-semibold text-foreground">
              {t('section2.content.type1.name')}
            </p>
            <p className="text-muted-foreground leading-relaxed mt-1">
              {t('section2.content.type1.description')}
            </p>
            <ul className="list-disc pl-6 space-y-2 text-muted-foreground mt-2">
              <li>{t('section2.content.type1.cookie1', { name: 'supabase-auth-token (o similar)'})}</li>
              <li>{t('section2.content.type1.cookie2', { name: 'next-intl-locale'})}</li>
              {/* Llista altres cookies tÃ¨cniques si cal */}
            </ul>
          </div>

          {/* SecciÃ³ Opcional: AnalÃ­tiques (descomenta si les utilitzes) */}
          {/*
          <div className="pt-4">
            <p className="font-semibold text-foreground">
              {t('section2.content.type2.name')}
            </p>
            <p className="text-muted-foreground leading-relaxed mt-1">
              {t('section2.content.type2.description')}
            </p>
            <ul className="list-disc pl-6 space-y-2 text-muted-foreground mt-2">
              <li>{t('section2.content.type2.cookie1', { name: '_ga, _gid (Google Analytics)'})}</li>
            </ul>
             <p className="text-sm text-muted-foreground mt-2">
              {t('section2.content.type2.thirdPartyInfo')}
            </p>
          </div>
          */}

          {/* SecciÃ³ Opcional: Publicitat (descomenta si les utilitzes) */}
          {/* ... */}
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section3.title')}
        </h2>
        <div className="pl-5 space-y-4">
          <p className="text-muted-foreground leading-relaxed">
            {t('section3.content.p1')}
          </p>
          <p className="text-muted-foreground leading-relaxed">
            {t('section3.content.p2')}
          </p>
          <ul className="list-disc pl-6 space-y-2 text-muted-foreground">
             <li><ExternalLink href="https://support.google.com/chrome/answer/95647">Google Chrome</ExternalLink></li>
             <li><ExternalLink href="https://support.mozilla.org/es/kb/habilitar-y-deshabilitar-cookies-sitios-web-rastrear-preferencias">Mozilla Firefox</ExternalLink></li>
             <li><ExternalLink href="https://support.apple.com/es-es/guide/safari/sfri11471/mac">Apple Safari</ExternalLink></li>
             <li><ExternalLink href="https://support.microsoft.com/es-es/windows/eliminar-y-administrar-cookies-168dab11-0753-043d-7c16-ede5947fc64d">Microsoft Edge</ExternalLink></li>
          </ul>
           <p className="text-muted-foreground leading-relaxed">
            {t('section3.content.p3')}
          </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section4.title')}
        </h2>
        <div className="pl-5">
          <p className="text-muted-foreground leading-relaxed">
            {t('section4.content.p1')}{' '}
            <LegalLink href={commonT('privacyPolicyLink')}>{commonT('privacyPolicyTitle')}</LegalLink>.
          </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section5.title')}
        </h2>
        <div className="pl-5">
          <p className="text-muted-foreground leading-relaxed">
            {t('section5.content.p1')}
          </p>
        </div>
      </section>
    </div>
  )
}

// =================== FILE: src/app/[locale]/(legal)/_components/LegalNoticeContent.tsx ===================

import { getTranslations } from 'next-intl/server'
import Link from 'next/link'
import { Separator } from '@/components/ui/separator'

interface ContentProps {
  locale: string
}

export async function LegalNoticeContent({ locale }: ContentProps) {
  const t = await getTranslations({ locale, namespace: 'LegalPages.LegalNotice' })
  const commonT = await getTranslations({ locale, namespace: 'LegalPages.Common' })

  // Link helper (pots moure'l a un fitxer compartit si vols)
  const LegalLink = ({
    href,
    children,
  }: {
    href: string
    children: React.ReactNode
  }) => (
    <Link
      href={href}
      target="_blank" // Obliguem a obrir en nova pestanya des del modal
      rel="noopener noreferrer"
      className="text-primary underline-offset-4 hover:underline"
    >
      {children}
    </Link>
  )

  return (
    <div className="space-y-8">
      {/* --- TÃ­tol Principal --- */}
      <div className="space-y-2 pb-4 border-b">
        <h1 className="text-3xl font-bold tracking-tight text-primary">
          {t('title')}
        </h1>
        <p className="text-sm text-muted-foreground">
          {commonT('lastUpdated', { date: new Date().toLocaleDateString(locale) })}
        </p>
      </div>

      {/* === Seccions === */}
      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section1.title')}
        </h2>
        <div className="pl-5">
          <p className="text-muted-foreground leading-relaxed">
            {t('section1.content.p1', {
              companyName: commonT('companyData.name'),
              companyVat: commonT('companyData.vat'),
              companyAddress: commonT('companyData.address'),
              companyEmail: commonT('companyData.email'),
              // companyRegistry: commonT('companyData.registry'), // Descomenta si cal
            })}
          </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section2.title')}
        </h2>
        <div className="pl-5">
          <p className="text-muted-foreground leading-relaxed">
            {t('section2.content.p1', { appName: commonT('appName') })}
          </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section3.title')}
        </h2>
        <div className="pl-5 space-y-4">
          <p className="text-muted-foreground leading-relaxed">
            {t('section3.content.p1', { appName: commonT('appName'), companyName: commonT('companyData.name') })}
          </p>
          <p className="text-muted-foreground leading-relaxed">
            {t('section3.content.p2')}
          </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section4.title')}
        </h2>
        <div className="pl-5 space-y-4">
          <p className="text-muted-foreground leading-relaxed">
            {t('section4.content.p1')}
          </p>
          <p className="text-muted-foreground leading-relaxed">
            {t('section4.content.p2')}
          </p>
          <ul className="list-disc pl-6 space-y-2 text-muted-foreground">
            <li>{t('section4.content.obligation1')}</li>
            <li>{t('section4.content.obligation2')}</li>
            <li>{t('section4.content.obligation3')}</li>
          </ul>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section5.title')}
        </h2>
        <div className="pl-5 space-y-4">
          <p className="text-muted-foreground leading-relaxed">
            {t('section5.content.p1')}
          </p>
          <p className="text-muted-foreground leading-relaxed">
            {t('section5.content.p2')}
          </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section6.title')}
        </h2>
        <div className="pl-5">
          <p className="text-muted-foreground leading-relaxed">
            {t('section6.content.p1')}
          </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section7.title')}
        </h2>
        <div className="pl-5">
          <p className="text-muted-foreground leading-relaxed">
            {t('section7.content.p1')}{' '}
            <LegalLink href={commonT('privacyPolicyLink')}>{commonT('privacyPolicyTitle')}</LegalLink>
            {' '} {commonT('and')} {' '}
            <LegalLink href={commonT('cookiePolicyLink')}>{commonT('cookiePolicyTitle')}</LegalLink>.
          </p>
        </div>
      </section>

      <Separator className="my-8" />

       <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section8.title')}
        </h2>
        <div className="pl-5">
          <p className="text-muted-foreground leading-relaxed">
            {t('section8.content.p1')}
          </p>
        </div>
      </section>

       <Separator className="my-8" />

       <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section9.title')}
        </h2>
        <div className="pl-5">
          <p className="text-muted-foreground leading-relaxed">
            {t('section9.content.p1')}
          </p>
        </div>
      </section>
    </div>
  )
}

// =================== FILE: src/app/[locale]/(legal)/_components/PrivacyPolicyContent.tsx ===================

import { getTranslations } from 'next-intl/server'
import { Separator } from '@/components/ui/separator' // Importem el Separator

interface ContentProps {
  locale: string
}

export async function PrivacyPolicyContent({ locale }: ContentProps) {
  const t = await getTranslations({
    locale,
    namespace: 'LegalPages.PrivacyPolicy',
  })

  return (
    <div className="space-y-8">
      {/* --- TÃ­tol Principal --- */}
      <div className="space-y-2 pb-4 border-b"> {/* Afegim una lÃ­nia sota el tÃ­tol */}
        <h1 className="text-3xl font-bold tracking-tight text-primary"> {/* TÃ­tol amb color primari */}
          {t('title')}
        </h1>
        <p className="text-sm text-muted-foreground">
          {t('lastUpdated', { date: new Date().toLocaleDateString(locale) })}
        </p>
      </div>

      {/* === Seccions === */}
      <section className="space-y-4">
        {/* âœ… TÃ­tol amb barra lateral i padding */}
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section1.title')}
        </h2>
        <p className="text-muted-foreground leading-relaxed pl-5"> {/* Alineem text amb el tÃ­tol */}
          {t('section1.content.p1', {
            companyName: 'El Teu Nom/Empresa',
            companyVat: 'El Teu NIF/CIF',
            companyAddress: 'La Teva AdreÃ§a',
            companyEmail: 'El Teu Email de Contacte',
          })}
        </p>
      </section>

      {/* âœ… Separador entre seccions */}
      <Separator className="my-8" /> 

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section2.title')}
        </h2>
        <div className="pl-5 space-y-4"> {/* Agrupem i indentem contingut de la secciÃ³ */}
            <p className="text-muted-foreground leading-relaxed">
            {t('section2.content.p1')}
            </p>
            <ul className="list-disc pl-6 space-y-2 text-muted-foreground">
            <li>{t('section2.content.item1')}</li>
            <li>{t('section2.content.item2')}</li>
            <li>{t('section2.content.item3')}</li>
            <li>{t('section2.content.item4')}</li>
            <li>{t('section2.content.item5')}</li>
            </ul>
            <p className="text-muted-foreground leading-relaxed pt-2">
            {t('section2.content.p2')}
            </p>
            <ul className="list-disc pl-6 space-y-2 text-muted-foreground">
            <li>{t('section2.content.purpose1')}</li>
            <li>{t('section2.content.purpose2')}</li>
            <li>{t('section2.content.purpose3')}</li>
            <li>{t('section2.content.purpose4')}</li>
            <li>{t('section2.content.purpose5')}</li>
            </ul>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section3.title')}
        </h2>
         <div className="pl-5 space-y-4">
            <p className="text-muted-foreground leading-relaxed">
            {t('section3.content.p1')}
            </p>
            <ul className="list-disc pl-6 space-y-2 text-muted-foreground">
            <li>{t('section3.content.basis1')}</li>
            <li>{t('section3.content.basis2')}</li>
            <li>{t('section3.content.basis3')}</li>
            <li>{t('section3.content.basis4')}</li>
            </ul>
         </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section4.title')}
        </h2>
        <div className="pl-5 space-y-4">
            <p className="text-muted-foreground leading-relaxed">
            {t('section4.content.p1')}
            </p>
            <p className="text-muted-foreground leading-relaxed">
            {t('section4.content.p2')}
            </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section5.title')}
        </h2>
        <div className="pl-5 space-y-4">
            <p className="text-muted-foreground leading-relaxed">
            {t('section5.content.p1')}
            </p>
            <ul className="list-disc pl-6 space-y-2 text-muted-foreground">
            <li>{t('section5.content.item1', { provider: 'Supabase' })}</li>
            </ul>
            <p className="text-muted-foreground leading-relaxed">
            {t('section5.content.p2')}
            </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section6.title')}
        </h2>
        <div className="pl-5">
            <p className="text-muted-foreground leading-relaxed">
            {t('section6.content.p1')}
            </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section7.title')}
        </h2>
        <div className="pl-5 space-y-4">
            <p className="text-muted-foreground leading-relaxed">
            {t('section7.content.p1')}
            </p>
            <p className="text-muted-foreground leading-relaxed">
            {t('section7.content.p2', { email: 'El Teu Email de Contacte' })}
            </p>
            <p className="text-muted-foreground leading-relaxed">
            {t('section7.content.p3')}
            </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section8.title')}
        </h2>
        <div className="pl-5">
            <p className="text-muted-foreground leading-relaxed">
            {t('section8.content.p1')}
            </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section9.title')}
        </h2>
        <div className="pl-5">
            <p className="text-muted-foreground leading-relaxed">
            {t('section9.content.p1')}
            </p>
        </div>
      </section>
    </div>
  )
}

// =================== FILE: src/app/[locale]/(legal)/_components/TermsContent.tsx ===================

import { getTranslations } from 'next-intl/server'
import Link from 'next/link'
import { Separator } from '@/components/ui/separator' // <-- Importa Separator

interface ContentProps {
  locale: string
}

export async function TermsContent({ locale }: ContentProps) {
  const t = await getTranslations({
    locale,
    namespace: 'LegalPages.TermsAndConditions',
  })
  const commonT =
    await getTranslations({ locale, namespace: 'LegalPages.Common' })
  const companyName = commonT('companyData.name')

  // Component 'helper' per estilitzar els enllaÃ§os de forma consistent
  const LegalLink = ({
    href,
    children,
  }: {
    href: string
    children: React.ReactNode
  }) => (
    <Link
      href={href}
      target="_blank"
      rel="noopener noreferrer"
      className="text-primary underline-offset-4 hover:underline"
    >
      {children}
    </Link>
  )

  return (
    <div className="space-y-8">
      {/* --- TÃ­tol Principal --- */}
      <div className="space-y-2 pb-4 border-b"> {/* LÃ­nia sota el tÃ­tol */}
        <h1 className="text-3xl font-bold tracking-tight text-primary"> {/* Color primari */}
          {t('title')}
        </h1>
        <p className="text-sm text-muted-foreground">
          {commonT('lastUpdated', {
            date: new Date().toLocaleDateString(locale),
          })}
        </p>
      </div>

      {/* === Seccions === */}
      <section className="space-y-4">
        {/* TÃ­tol amb barra lateral */}
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section1.title')}
        </h2>
        {/* Contingut indentat */}
        <div className="pl-5 space-y-4"> 
          <p className="text-muted-foreground leading-relaxed">
            {t('section1.content.p1', {
              appName: commonT('appName'),
              companyName: companyName,
            })}
          </p>
          <p className="text-muted-foreground leading-relaxed">
            {t('section1.content.p2')}{' '}
            <LegalLink href={commonT('privacyPolicyLink')}>
              {commonT('privacyPolicyTitle')}
            </LegalLink>
            .
          </p>
        </div>
      </section>

      <Separator className="my-8" /> {/* Separador */}

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section2.title')}
        </h2>
        <div className="pl-5">
          <p className="text-muted-foreground leading-relaxed">
            {t('section2.content.p1', { appName: commonT('appName') })}
          </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section3.title')}
        </h2>
        <div className="pl-5 space-y-4">
          <p className="text-muted-foreground leading-relaxed">
            {t('section3.content.p1')}
          </p>
          <p className="text-muted-foreground leading-relaxed">
            {t('section3.content.p2')}
          </p>
          <p className="text-muted-foreground leading-relaxed">
            {t('section3.content.p3')}
          </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section4.title')}
        </h2>
        <div className="pl-5 space-y-4">
          <p className="text-muted-foreground leading-relaxed">
            {t('section4.content.p1')}
          </p>
          <ul className="list-disc pl-6 space-y-2 text-muted-foreground">
            <li>{t('section4.content.obligation1')}</li>
            <li>{t('section4.content.obligation2')}</li>
            <li>{t('section4.content.obligation3')}</li>
            <li>
              {t('section4.content.obligation4', { companyName: companyName })}
            </li>
          </ul>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section5.title')}
        </h2>
        <div className="pl-5">
          <p className="text-muted-foreground leading-relaxed">
            {t('section5.content.p1')}
          </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section6.title')}
        </h2>
        <div className="pl-5 space-y-4">
          <p className="text-muted-foreground leading-relaxed">
            {t('section6.content.p1', {
              appName: commonT('appName'),
              companyName: companyName,
            })}
          </p>
          <p className="text-muted-foreground leading-relaxed">
            {t('section6.content.p2')}
          </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section7.title')}
        </h2>
        <div className="pl-5 space-y-4">
          <p className="text-muted-foreground leading-relaxed">
            {t('section7.content.p1')}{' '}
            <LegalLink href={commonT('privacyPolicyLink')}>
              {commonT('privacyPolicyTitle')}
            </LegalLink>
            .
          </p>
          <p className="font-semibold text-foreground pt-2">
            {t('section7.content.dpaTitle')}
          </p>
          <p className="text-muted-foreground leading-relaxed">
            {t('section7.content.dpaP1', { appName: commonT('appName') })}
          </p>
          <p className="text-muted-foreground leading-relaxed">
            {t('section7.content.dpaP2')}
          </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section8.title')}
        </h2>
        <div className="pl-5 space-y-4">
          <p className="text-muted-foreground leading-relaxed">
            {t('section8.content.p1')}
          </p>
          <p className="text-muted-foreground leading-relaxed">
            {t('section8.content.p2', { companyName: companyName })}
          </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section9.title')}
        </h2>
        <div className="pl-5">
          <p className="text-muted-foreground leading-relaxed">
            {t('section9.content.p1')}
          </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section10.title')}
        </h2>
        <div className="pl-5 space-y-4">
          <p className="text-muted-foreground leading-relaxed">
            {t('section10.content.p1')}
          </p>
          <p className="text-muted-foreground leading-relaxed">
            {t('section10.content.p2')}
          </p>
        </div>
      </section>

      <Separator className="my-8" />

      <section className="space-y-4">
        <h2 className="text-xl font-semibold border-l-4 border-primary pl-4 py-1">
          {t('section11.title')}
        </h2>
        <div className="pl-5">
          <p className="text-muted-foreground leading-relaxed">
            {t('section11.content.p1')}
          </p>
        </div>
      </section>
    </div>
  )
}

// =================== FILE: src/app/[locale]/(public)/MainLandingView.tsx ===================

"use client";

import { LandingNav } from './_components/LandingNav';
import { HeroContent } from './_components/HeroContent';
// âœ… NOU: Importem el fons de partÃ­cules
import { ParticleBackground } from './_components/ParticleBackground';
// âœ… NOU: Importem el nou Bento Grid
import { FeatureBentoGrid } from './_components/FeatureBentoGrid';
import { useTranslations } from 'next-intl';
import { motion } from 'framer-motion';
import { IconCloudBackground } from './_components/IconCloudBackground';

export function MainLandingView() {
  const t = useTranslations('MainLandingView.bentoGrid');

  return (
    <div className="bg-background text-foreground min-h-screen overflow-x-hidden relative">
      <LandingNav />

      {/* --- SecciÃ³ 1: HERO --- */}
      <main className="relative z-10">
        {/* âœ… CANVI: SubstituÃ¯m el component de partÃ­cules pel nou d'icones */}
        <div className="absolute inset-0 -z-10 h-screen">
          <IconCloudBackground />
          <ParticleBackground />
        </div>

        {/* âœ… CORRECCIÃ“ MÃ’BIL:
            - Canviat 'h-[80vh] md:h-screen' per 'min-h-[80vh] md:min-h-screen' 
              per asegurar que el contingut hi cap si Ã©s mÃ©s alt.
            - Afegit 'pt-20' (80px) per deixar espai a la LandingNav (que Ã©s 'fixed').
            - Afegit 'pb-10' per a un millor espaiat inferior en mÃ²bil.
        */}
        <section
          className="container mx-auto px-4 
                     min-h-[80vh] md:min-h-screen 
                     flex items-center justify-center 
                     pt-20 pb-10" // <-- CANVI CLAU AQUÃ
        >
          <HeroContent />
        </section>

        {/* --- SecciÃ³ 2: BENTO GRID (Casos d'Ãšs) --- */}
        <section className="container mx-auto px-4 pb-20 md:pb-40">
          <motion.h2
            initial={{ opacity: 0, y: 20 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true, amount: 0.5 }}
            transition={{ duration: 0.5, ease: 'easeOut' }}
            className="text-3xl md:text-5xl font-black tracking-tighter text-center mb-16"
          >
            {t('title')}
          </motion.h2>

          <FeatureBentoGrid />
        </section>

      </main>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(public)/_components/BentoCard.tsx ===================

"use client";

import { motion, type Variants } from 'framer-motion';
import Image from 'next/image';
import { cn } from '@/lib/utils/utils';
import type { LucideIcon } from 'lucide-react';

// Definim i exportem el tipus per reutilitzar-lo
export type BentoFeature = {
  id: string;
  titleKey: string;
  descKey: string;
  imageSrc: string;
  icon: LucideIcon;
  className: string;
};

type BentoCardProps = {
  feature: BentoFeature;
  layoutId: string;
  onClick: () => void;
  isOpen: boolean;
  t: (key: string) => string; // FunciÃ³ de traducciÃ³
  variants?: Variants; // Per l'animaciÃ³ d'entrada
};

/**
 * @summary Component visual per a una targeta del Bento Grid.
 * @description ARQUITECTURA: Imatge com a fons de targeta (`object-cover`)
 * amb contingut superposat i gradient per a llegibilitat.
 */
export function BentoCard({
  feature,
  layoutId,
  onClick,
  isOpen,
  t,
  variants,
}: BentoCardProps) {
  const { icon: Icon, titleKey, descKey, imageSrc, className } = feature;
  const title = t(titleKey);
  const description = t(descKey);

  // LÃ²gica d'alÃ§ada basada en el className original
  const isLargeCard = className?.includes('col-span-2');

  return (
    <motion.div
      layoutId={layoutId} // âœ¨ CLAU: El 'magic link' per l'animaciÃ³
      onClick={onClick}
      variants={variants}
      className={cn(
        'relative group rounded-2xl overflow-hidden shadow-lg',
        // Estils de cursor
        !isOpen && 'cursor-pointer',
        isOpen && 'cursor-default',

        // âœ… CANVI: Fons per al 'letterboxing' quan la imatge estÃ  oberta
        // i en mode 'object-contain'. Fem servir 'bg-background'
        // que s'adapta al tema (clar/fosc).
        isOpen && 'bg-background',

        // âœ… ARQUITECTURA: AlÃ§ada dinÃ mica
        isOpen
          ? 'h-[75vh] w-full' // AlÃ§ada mÃ xima quan estÃ  oberta
          : isLargeCard
            ? 'h-80 md:h-96' // AlÃ§ada de targeta "gran" al grid
            : 'h-64 md:h-72' // AlÃ§ada de targeta "petita" al grid
      )}
    >
      {/* 1. Imatge */}
      <Image
        src={imageSrc}
        alt={title}
        fill
        className={cn(
          'object-center transition-all duration-500 ease-out',
          
          // âœ… CANVI: 'contain' si obert (no es talla), 'cover' si tancat (omple)
          isOpen ? 'object-contain' : 'object-cover',
          
          !isOpen && 'group-hover:scale-105' // Zoom on hover nomÃ©s al grid
        )}
        // âœ… RENDIMENT: OptimitzaciÃ³ d'imatges
        quality={isOpen ? 90 : 75}
        priority={isOpen}
        placeholder="blur"
        blurDataURL={imageSrc}
        sizes={
          isOpen
            ? '90vw' // Quan estÃ  oberta, ocupa gairebÃ© tota la vista
            : '(max-width: 1024px) 100vw, 50vw' // Quan estÃ  al grid, ocupa la meitat (2 cols)
        }
      />

      {/* 2. Overlay/Scrim per llegibilitat */}
      <div
        className={cn(
          'absolute inset-0 bg-gradient-to-t to-transparent',
          
          // âœ… CANVI: Gradient molt mÃ©s suau per no enfosquir la imatge
          isOpen
            ? 'from-black/60 via-black/10' // Subtil quan obert
            : 'from-black/60 via-black/30' // Una mica mÃ©s fosc tancat
        )}
      />

      {/* 3. Contingut (a sobre de tot) */}
      <div className="relative z-10 flex flex-col justify-end h-full p-4 md:p-6 text-white">
        {/* CapÃ§alera (Icona + TÃ­tol) */}
        <div className="flex items-center gap-3 mb-2">
          <div
            className={cn(
              'p-2 bg-white/10 border border-white/20 rounded-lg backdrop-blur-sm',
              isOpen && 'p-3' // Icona mÃ©s gran si obert
            )}
          >
            <Icon
              className={cn(
                'w-5 h-5 text-white',
                isOpen && 'w-6 h-6' // Icona mÃ©s gran si obert
              )}
            />
          </div>
          <h3
            className={cn(
              'text-xl font-bold',
              isOpen && 'text-3xl' // TÃ­tol mÃ©s gran si obert
            )}
          >
            {title}
          </h3>
        </div>

        {/* DescripciÃ³ (pot ser mÃ©s llarga si estÃ  obert) */}
        <p
          className={cn(
            'text-white/100',
            isOpen
              ? 'text-base md:text-lg max-w-3xl' // MÃ©s text i mÃ©s gran
              : 'text-sx line-clamp-2' // Curt i petit al grid
          )}
        >
          {description}
        </p>
      </div>
    </motion.div>
  );
}

// =================== FILE: src/app/[locale]/(public)/_components/FeatureBentoGrid.tsx ===================

"use client";

import { useState } from 'react';
import { useTranslations } from 'next-intl';
import { motion, AnimatePresence, Variants } from 'framer-motion';

// ğŸ‘‡ 1. Importem les icones
import {
  Briefcase,
  Calendar,
  LayoutDashboard,
  BarChart,
  Share2,
  Repeat,
  Network,
  Inbox
} from 'lucide-react';

// âœ¨ NOU: Importem la BentoCard refactoritzada
import { BentoCard } from './BentoCard';
import type { BentoFeature } from './BentoCard'; // âœ¨ NOU: Importem el tipus
const classBentoFeatures = 'lg:col-span-1';
// InformaciÃ³ de les targetes
const bentoFeatures: BentoFeature[] = [
  {
    id: 'dashboard',
    titleKey: 'dashboard.title',
    descKey: 'dashboard.desc',
    imageSrc: '/dashboard3.png',
    icon: LayoutDashboard,
    className: classBentoFeatures, // Es fa servir per a l'alÃ§ada
  },
  {
    id: 'crm',
    titleKey: 'crm.title',
    descKey: 'crm.desc',
    imageSrc: '/crm2.png',
    icon: Briefcase,
    className: classBentoFeatures,
  },
  {
    id: 'calendari',
    titleKey: 'calendari.title',
    descKey: 'calendari.desc',
    imageSrc: '/calendari2.png',
    icon: Calendar,
    className: classBentoFeatures,
  },
  {
    id: 'pipeline',
    titleKey: 'pipeline.title',
    descKey: 'pipeline.desc',
    imageSrc: '/pipeline1.png',
    icon: BarChart,
    className: classBentoFeatures,
  },
  {
    id: 'social',
    titleKey: 'social.title',
    descKey: 'social.desc',
    imageSrc: '/rrss.png',
    icon: Share2,
    className: classBentoFeatures,
  },
  {
    id: 'invoicing',
    titleKey: 'invoicing.title',
    descKey: 'invoicing.desc',
    imageSrc: '/fluxPresupostos.png',
    icon: Repeat,
    className: classBentoFeatures,
  },
  {
    id: 'network',
    titleKey: 'network.title',
    descKey: 'network.desc',
    imageSrc: '/network2.jpg',
    icon: Network,
    className: classBentoFeatures,
  },
    {
    id: 'inboxDespesa',
    titleKey: 'inboxDespesa.title',
    descKey: 'inboxDespesa.desc',
    imageSrc: '/inboxDespesa.png',
    icon: Inbox,
    className: classBentoFeatures,
  },
];

// Variants per a l'animaciÃ³ escalonada de les columnes
const gridVariants: Variants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.2, // Les columnes apareixen amb un lleuger retard
      ease: 'easeOut',
    },
  },
};

// Variants per a les targetes dins de cada columna
const cardVariants: Variants = {
  hidden: { opacity: 0, scale: 0.95, y: 20 },
  visible: {
    opacity: 1,
    scale: 1,
    y: 0,
    transition: { type: 'spring', stiffness: 100, damping: 15 },
  },
};


/**
 * @summary El grid "Bento" que mostra les funcionalitats principals.
 * @description ARQUITECTURA: VersiÃ³ 3D "passadÃ­s" que anima
 * targetes individuals al centre en fer click.
 */
export function FeatureBentoGrid() {
  const t = useTranslations('MainLandingView.showcase');
  const [selectedId, setSelectedId] = useState<string | null>(null);

  const leftFeatures = bentoFeatures.slice(0, 4);
  const rightFeatures = bentoFeatures.slice(4);

  const selectedFeature = bentoFeatures.find((f) => f.id === selectedId);

  return (
    <>
      <motion.div
  className="grid grid-cols-1 lg:grid-cols-2 gap-8 px-4 sm:px-8 md:px-12 lg:px-16 [perspective:1200px]"
  variants={gridVariants}
  initial="hidden"
  whileInView="visible"
  viewport={{ once: true, amount: 0.1 }}
>

        {/* === Columna Esquerra === */}
        <motion.div
          className="flex flex-col gap-8 [transform-style:preserve-3d] lg:[transform:rotateY(10deg)_translateX(-5%)]"
          variants={gridVariants}
        >
          {leftFeatures.map((feature) => (
            <BentoCard
              key={feature.id}
              feature={feature}
              layoutId={feature.id}
              onClick={() => setSelectedId(feature.id)}
              isOpen={false}
              t={t}
              variants={cardVariants}
            />
          ))}
        </motion.div>

        {/* === Columna Dreta === */}
        <motion.div
          className="flex flex-col gap-8 [transform-style:preserve-3d] lg:[transform:rotateY(-10deg)_translateX(5%)]"
          variants={gridVariants}
        >
          {rightFeatures.map((feature) => (
            <BentoCard
              key={feature.id}
              feature={feature}
              layoutId={feature.id}
              onClick={() => setSelectedId(feature.id)}
              isOpen={false}
              t={t}
              variants={cardVariants}
            />
          ))}
        </motion.div>
      </motion.div>

      {/* === Modal per a la targeta seleccionada (AnimaciÃ³ individual) === */}
      <AnimatePresence>
        {selectedId && selectedFeature && (
          <motion.div
            className="fixed inset-0 z-50 flex items-center justify-center p-4 md:p-8"
            onClick={() => setSelectedId(null)}
          >
            {/* Overlay */}
            <motion.div
              className="absolute inset-0 bg-background/90 backdrop-blur-sm"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              transition={{ duration: 0.3 }}
            />

            {/* Contenidor de la targeta (evita que el click es propagui) */}
            <motion.div
              className="relative z-10 w-full max-w-4xl"
              onClick={(e) => e.stopPropagation()}
              initial={{ scale: 0.9, opacity: 0 }}
              animate={{ scale: 1, opacity: 1 }}
              exit={{ scale: 0.9, opacity: 0 }}
              transition={{ type: 'spring', stiffness: 200, damping: 25 }}
            >
              {/* La BentoCard s'anima grÃ cies a layoutId */}
              <BentoCard
                feature={selectedFeature}
                layoutId={selectedId}
                onClick={() => setSelectedId(null)} // Clicar la card tambÃ© la tanca
                isOpen={true} // <-- Prop clau
                t={t}
              />
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>
    </>
  );
}

// =================== FILE: src/app/[locale]/(public)/_components/HeroContent.tsx ===================

"use client";

import Link from 'next/link';
import { useTranslations } from 'next-intl';
import { motion } from 'framer-motion';
import { Button } from '@/components/ui/button';

// Les animacions escalonades sÃ³n perfectes per a aixÃ²
const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.15,
      delayChildren: 0.1,
    },
  },
} as const;

const childVariants = {
  hidden: { opacity: 0, y: 20 },
  visible: {
    opacity: 1,
    y: 0,
    transition: {
      duration: 0.5,
      ease: 'easeOut',
    },
  },
} as const;


export function HeroContent() {
  const t = useTranslations('MainLandingView');

  return (
    <motion.div
      variants={containerVariants}
      initial="hidden"
      animate="visible"
      // âœ… DISSENY: Tot centrat, amb un ample mÃ xim per a llegibilitat
      className="flex flex-col items-center text-center max-w-3xl"
    >
      <motion.h1 
        variants={childVariants}
        // âœ… DISSENY: TÃ­tol mÃ©s gran i impactant
        className="text-5xl md:text-7xl font-black tracking-tighter !leading-[1.1] mb-6"
      >
        {t('title')}
      </motion.h1>
      
      <motion.p 
        variants={childVariants}
        // âœ… DISSENY: Text mÃ©s gran i amb mÃ©s contrast
        className="text-lg md:text-xl text-foreground/80 max-w-2xl mb-12"
      >
        {t('subtitle')}
      </motion.p>
      
      <motion.div variants={childVariants} whileHover={{ scale: 1.05 }} whileTap={{ scale: 0.95 }}>
        {/* Aquest botÃ³ ja tÃ© el disseny net que vam definir (sense gradient) */}
        <Button 
          asChild 
          size="lg" 
          className="text-lg py-7 px-10 rounded-full font-bold
                     shadow-lg shadow-primary/20 hover:shadow-xl hover:shadow-primary/40
                     transition-all duration-300 ease-out"
        >
          <Link href="/signup">{t('ctaButton')}</Link>
        </Button>
      </motion.div>
    </motion.div>
  );
}

// =================== FILE: src/app/[locale]/(public)/_components/IconCloudBackground.tsx ===================

"use client";

import React, { useState, useEffect, useMemo } from 'react';
import { motion } from 'framer-motion';
import {
  LayoutDashboard,
  Briefcase,
  Landmark,
  Headphones,
  Mail,
  Contact,
  FileText,
  Receipt,
  Bot,
  Settings,
  Users,
  Workflow,
  CalendarDays,
  KeyRound,
  Download,
  ShieldOff,
  Wrench,
  Puzzle,
  CreditCard,
  User,
} from 'lucide-react';

// --- Helper Hook: useWindowSize (Sense canvis) ---
function useWindowSize() {
  const [windowSize, setWindowSize] = useState<{ width: number; height: number }>({
    width: 0,
    height: 0,
  });

  useEffect(() => {
    function handleResize() {
      setWindowSize({
        width: window.innerWidth,
        height: window.innerHeight,
      });
    }
    
    if (typeof window !== 'undefined') {
      window.addEventListener('resize', handleResize);
      handleResize();
      return () => window.removeEventListener('resize', handleResize);
    }
  }, []);
  
  return windowSize;
}

// 1. Totes les icones que volem utilitzar
const allIcons = [
  LayoutDashboard, Briefcase, Landmark, Headphones, Mail, Contact, FileText,
  Receipt, Bot, Settings, Users, Workflow, CalendarDays, KeyRound, Download,
  ShieldOff, Wrench, Puzzle, CreditCard, User,
];

// 2. Paleta de colors HSL
const colorPalette = [
  '220 80% 60%', // Blau
  '140 70% 50%', // Verd
  '40 90% 60%',  // Groc
  '330 80% 60%', // Rosa
  '260 80% 65%', // Morat
  '190 90% 50%', // Cyan
  '25 90% 55%',  // Taronja
];

// 3. âœ¨ NOU: Definim quants icones volem per a mÃ²bil i escriptori
const MOBILE_ICON_COUNT = 8; // <-- Pots ajustar aquest nÃºmero
const DESKTOP_ICON_COUNT = allIcons.length; // 20

/**
 * @summary Sub-component per a cada "Moneda" flotant (Sense canvis)
 */
function FloatingCoin({ Icon, colorHsl }: { 
  Icon: React.ElementType;
  colorHsl: string;
}) {
  const { width, height } = useWindowSize();

  const randomValues = useMemo(() => {
    if (width === 0 || height === 0) {
      return null;
    }

    const size = Math.random() * (74 - 50) + 50; 
    const deadZone = {
      x: [width * 0.3, width * 0.7], 
      y: [height * 0.3, height * 0.6],
    };

    const getSafeRandomPosition = () => {
      let x, y;
      do {
        x = Math.random() * (width - size);
      } while (x > deadZone.x[0] && x < deadZone.x[1]);
      
      do {
        y = Math.random() * (height - size);
      } while (y > deadZone.y[0] && y < deadZone.y[1]);
      
      return { x, y };
    };

    const { x: xInitial, y: yInitial } = getSafeRandomPosition();
    const { x: xAnimate, y: yAnimate } = getSafeRandomPosition();

    const floatDuration = Math.random() * 20 + 25; 
    const rotateDuration = Math.random() * 10 + 10;

    return { 
      size, xInitial, yInitial, xAnimate, yAnimate, 
      floatDuration, rotateDuration
    };
  }, [width, height]); 

  if (!randomValues) return null;

  const color = `hsl(${colorHsl})`;

  return (
    <motion.div
      className="absolute flex items-center justify-center
                bg-background/60 backdrop-blur-sm"
      
      style={{
        width: randomValues.size,
        height: randomValues.size,
        borderRadius: '50%',
        boxShadow: `0 0 20px 5px hsla(${colorHsl})`,
        border: `1px solid hsla(${colorHsl}, 0.4)`,
        backfaceVisibility: 'hidden',
      }}
      
      initial={{
        x: randomValues.xInitial,
        y: randomValues.yInitial,
        opacity: 0,
        rotateY: 0,
      }}
      
      animate={{
        x: randomValues.xAnimate,
        y: randomValues.yAnimate,
        opacity: 0.3,
        rotateY: 360,
      }}
      
      transition={{
        x: { 
          duration: randomValues.floatDuration, 
          repeat: Infinity, 
          repeatType: 'mirror', 
          ease: 'easeInOut' 
        },
        y: { 
          duration: randomValues.floatDuration, 
          repeat: Infinity, 
          repeatType: 'mirror', 
          ease: 'easeInOut' 
        },
        rotateY: { 
          duration: randomValues.rotateDuration, 
          repeat: Infinity, 
          ease: 'linear'
        },
        opacity: {
          duration: 3,
          ease: 'easeIn'
        }
      }}
    >
      <Icon 
        className="w-1/2 h-1/2" 
        style={{ color: color, opacity: 0.9 }}
      />
    </motion.div>
  );
}

/**
 * @summary Fons de la secciÃ³ Hero amb icones flotants aleatÃ²ries.
 * @description âœ… AFEGIDA LÃ’GICA RESPONSIVA
 * Ara comprova la mida de la finestra per renderitzar 
 * menys icones en dispositius mÃ²bils.
 */
export function IconCloudBackground() {
  
  // âœ… ARQUITECTURA: Cridem el hook useWindowSize al component pare.
  const { width } = useWindowSize();

  // âœ… RENDIMENT:
  // Utilitzem useMemo per decidir quantes icones renderitzar.
  // AixÃ² s'actualitzarÃ  nomÃ©s quan 'width' canviÃ¯ (o creuÃ¯ el breakpoint).
  const iconsToRender = useMemo(() => {
    // Si 'width' Ã©s 0 (estat inicial abans del 'mount' al client),
    // no renderitzem res per evitar problemes d'hidrataciÃ³ (hydration mismatch).
    if (width === 0) {
      return [];
    }

    // Definim el punt de tall (breakpoint). 768px Ã©s 'md' a Tailwind.
    const isMobile = width < 768;
    
    // Triem el nombre d'icones
    const count = isMobile ? MOBILE_ICON_COUNT : DESKTOP_ICON_COUNT;

    // Retornem un 'slice' de l'array original.
    // AixÃ² ens dÃ³na les primeres 8 icones si Ã©s mÃ²bil, o totes 20 si Ã©s escriptori.
    return allIcons.slice(0, count);

  }, [width]); // Aquesta lÃ²gica es re-executa NOMÃ‰S quan 'width' canvia.

  return (
    <div className="relative w-full h-full overflow-hidden">
      {/* Apliquem 'perspective' per a l'efecte 3D de la rotaciÃ³ */}
      <div style={{ perspective: '800px' }}>
        
        {/* âœ… CANVI: Mapegem sobre 'iconsToRender' (dinÃ mic) 
            en lloc de 'allIcons' (estÃ tic) */}
        {iconsToRender.map((Icon, i) => (
          <FloatingCoin 
            key={i} 
            Icon={Icon} 
            colorHsl={colorPalette[i % colorPalette.length]}
          />
        ))}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(public)/_components/LandingNav.tsx ===================

"use client";

import Link from 'next/link';
import Image from 'next/image';
import { Button, buttonVariants } from '@/components/ui/button';
import { LanguageSwitcher } from '@/components/LanguageSwitcher';
import { ThemeSwitcher } from '@/components/ThemeSwitcher';
import { useTranslations } from 'next-intl';
import { motion } from 'framer-motion';
import { cn } from '@/lib/utils/utils';

export function LandingNav() {
  const t = useTranslations('LandingNav');

  return (
    <motion.nav 
      initial={{ y: -100 }}
      animate={{ y: 0 }}
      transition={{ duration: 0.5, ease: 'easeOut' }}
      // âœ… ARQUITECTURA: Eliminem p-4 i flex. El 'nav' nomÃ©s s'encarrega del fons
      // i l'alÃ§ada (py-3).
      className="fixed top-0 left-0 right-0 z-50 
                 bg-background/50 backdrop-blur-lg border-b border-border py-3"
    >
      {/* âœ… NOU: Aquest 'div' fa de contenidor. 
           S'alinearÃ  perfectament amb el 'container' del 'main'.
           'px-4' Ã©s necessari per al padding en pantalles mÃ²bils.
      */}
      <div className="container mx-auto flex justify-between items-center px-4">
        
        {/* Grup Esquerra: Logo */}
        <Link href="/" className="flex items-center gap-2">
          <Image src="/android-chrome-192x192.png" alt={t('logoAlt')} width={32} height={32} />
          <span className="font-bold text-lg hidden sm:block text-foreground">{t('brandName')}</span>
        </Link>
        
        {/* Grup Dreta: Controls i Accions */}
        <div className="flex items-center gap-1">
          <LanguageSwitcher />
          <ThemeSwitcher />
          
          {/* Separador visual */}
          <div className="h-6 w-px bg-border mx-2" /> 

          {/* AcciÃ³ SecundÃ ria */}
          <Button variant="ghost" asChild>
            <Link href="/login">{t('login')}</Link>
          </Button>
          
          {/* AcciÃ³ PrimÃ ria */}
          <Link 
            href="/signup"
            className={cn(
              buttonVariants({ variant: 'default' }),
              "hidden sm:inline-flex font-bold hover:scale-105 transition-transform"
            )}
          >
            {t('signup')}
          </Link>
        </div>
      </div>
    </motion.nav>
  );
}

// =================== FILE: src/app/[locale]/(public)/_components/ParticleBackground.tsx ===================

"use client";

import { useEffect, useRef } from 'react';

export function ParticleBackground() {
  const canvasRef = useRef<HTMLCanvasElement>(null);

  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    let animationFrameId: number;
    let particlesArray: Particle[] = [];

    class Particle {
      x: number;
      y: number;
      directionX: number;
      directionY: number;
      size: number;
      color: string;

      constructor(x: number, y: number, dX: number, dY: number, size: number, color: string) {
        this.x = x;
        this.y = y;
        this.directionX = dX;
        this.directionY = dY;
        this.size = size;
        this.color = color;
      }

      draw(context: CanvasRenderingContext2D) {
        context.beginPath();
        context.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
        context.fillStyle = '#1a1a1a';
        context.fill();
      }

      update(canvasEl: HTMLCanvasElement, context: CanvasRenderingContext2D) {
        if (this.x > canvasEl.width || this.x < 0) this.directionX = -this.directionX;
        if (this.y > canvasEl.height || this.y < 0) this.directionY = -this.directionY;
        this.x += this.directionX;
        this.y += this.directionY;
        this.draw(context);
      }
    }

    const init = (canvasEl: HTMLCanvasElement) => {
      particlesArray = [];
      const numberOfParticles = (canvasEl.height * canvasEl.width) / 9000;
      for (let i = 0; i < numberOfParticles * 0.5; i++) {
        const size = (Math.random() * 2) + 1;
        const x = Math.random() * (canvasEl.width - size * 2) + size * 2;
        const y = Math.random() * (canvasEl.height - size * 2) + size * 2;
        const dX = (Math.random() * 0.4) - 0.2;
        const dY = (Math.random() * 0.4) - 0.2;
        particlesArray.push(new Particle(x, y, dX, dY, size, '#1a1a1a'));
      }
    };

    const connect = (canvasEl: HTMLCanvasElement, context: CanvasRenderingContext2D) => {
      for (let a = 0; a < particlesArray.length; a++) {
        for (let b = a; b < particlesArray.length; b++) {
          const distance = ((particlesArray[a].x - particlesArray[b].x) ** 2) + ((particlesArray[a].y - particlesArray[b].y) ** 2);
          if (distance < (canvasEl.width / 8) * (canvasEl.height / 8)) {
            const opacityValue = 1 - (distance / 20000);
            context.strokeStyle = `rgba(102, 102, 102, ${opacityValue})`;
            context.lineWidth = 1;
            context.beginPath();
            context.moveTo(particlesArray[a].x, particlesArray[a].y);
            context.lineTo(particlesArray[b].x, particlesArray[b].y);
            context.stroke();
          }
        }
      }
    };

    const animate = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particlesArray.forEach(p => p.update(canvas, ctx));
      connect(canvas, ctx);
      animationFrameId = requestAnimationFrame(animate);
    };

    const resizeCanvas = () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      init(canvas);
    };

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    animate();

    return () => {
      window.removeEventListener('resize', resizeCanvas);
      cancelAnimationFrame(animationFrameId);
    };
  }, []);

  return <canvas ref={canvasRef} className="fixed top-0 left-0 w-full h-full z-0 opacity-25" />;
}


// =================== FILE: src/app/[locale]/accept-invite/route.ts ===================

import { type NextRequest, NextResponse } from 'next/server';
import { headers } from 'next/headers';

// âœ… CORRECCIÃ“: Importem l'acciÃ³ des de la seva nova ubicaciÃ³ centralitzada.
import { resolveInvitationAction } from '@/app/actions/invitationActions';

export const dynamic = 'force-dynamic';

/**
 * Aquest Route Handler Ã©s el primer que s'executa quan un usuari
 * fa clic a l'enllaÃ§ de la invitaciÃ³ del correu.
 * La seva Ãºnica feina Ã©s actuar com un "director de trÃ nsit".
 */
export async function GET(request: NextRequest) {
  const token = request.nextUrl.searchParams.get('token');
  // Obtenim el locale a partir de les capÃ§aleres que injecta el middleware
  const locale = (await headers()).get('x-next-intl-locale') || 'ca';

  if (!token) {
    // Si per alguna raÃ³ no hi ha token, el portem al login amb un error.
    const url = request.nextUrl.clone();
    url.pathname = `/${locale}/login`;
    url.searchParams.set('message', 'Token d\'invitaciÃ³ invÃ lid o inexistent.');
    return NextResponse.redirect(url);
  }

  // Cridem a l'acciÃ³ que contÃ© la lÃ²gica per decidir si l'usuari
  // ha d'anar a la pÃ gina de login o a la de registre per a convidats.
  // Aquesta acciÃ³ ja retorna una NextResponse.redirect(), per la qual cosa
  // simplement retornem el seu resultat.
  return await resolveInvitationAction(token);
}


// =================== FILE: src/app/[locale]/global-error.tsx ===================

// src/app/[locale]/global-error.tsx
'use client';

import { useEffect } from 'react';
import { Button } from '@/components/ui/button';

export default function GlobalError({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    // AquÃ­ Ã©s on podrÃ­es enviar l'error a un servei de monitoritzaciÃ³
    // com Sentry, LogRocket, etc.
    console.error('S_ha produÃ¯t un error global no controlat:', error);
  }, [error]);

  return (
    <html>
      <body>
        <div className="flex min-h-screen flex-col items-center justify-center bg-background text-foreground">
          <div className="mx-auto max-w-md text-center">
            <h1 className="text-4xl font-bold tracking-tight sm:text-5xl">
              Ups! Alguna cosa ha fallat.
            </h1>
            <p className="mt-4 text-lg text-muted-foreground">
              El nostre equip tÃ¨cnic ja ha estat notificat. Estem treballant
              per solucionar-ho el mÃ©s aviat possible.
            </p>
            <div className="mt-8">
              <Button
                onClick={
                  // Intenta recuperar-te renderitzant de nou el segment
                  () => reset()
                }
                size="lg"
              >
                Torna-ho a intentar
              </Button>
            </div>
            {/* En desenvolupament, pots mostrar detalls de l'error si vols, 
                tot i que Next.js ja mostra el seu overlay. */}
            {process.env.NODE_ENV === 'development' && (
              <pre className="mt-4 rounded-md bg-muted p-4 text-left text-sm">
                <code>{error?.message}</code>
                <code>{error?.stack}</code>
              </pre>
            )}
          </div>
        </div>
      </body>
    </html>
  );
}

// =================== FILE: src/app/[locale]/invitation/accept/page.tsx ===================

// /app/[locale]/invitation/accept/page.tsx (VERSIÃ“ FINAL)

import { InvitedSignupForm } from './_components/InvitedSignupForm';
import { createClient } from '@/lib/supabase/server';

// Assegura que la pÃ gina sempre es renderitza dinÃ micament per a llegir els searchParams.
export const dynamic = 'force-dynamic';

// âœ… CORRECCIÃ“ CLAU: Definim searchParams com una Promise.
type InvitedSignupPageProps = {
    searchParams: Promise<{ 
        token?: string; 
        email?: string;
    }>;
};

export default async function InvitedSignupPage({ searchParams }: InvitedSignupPageProps) {
    console.log("Search params a la pÃ gina d'acceptaciÃ³ d'invitaciÃ³:", searchParams);
    
    // âœ… L'await Ã©s ara consistent amb el tipus definit (Promise<T>).
    const { token, email } = await searchParams;
    let teamName: string | null = null; 

    if (token) {
        // Utilitzem createClient() des del servidor [8]
        const supabase = createClient();
        
        // Consulta per obtenir el nom de l'equip a partir del token [9]
        const { data: invitationData } = await supabase
            .from('invitations')
            .select('team_name')
            .eq('token', token)
            .single();
        
        if (invitationData?.team_name) {
            teamName = invitationData.team_name;
        }
    }

    return (
        <div className="flex flex-col items-center justify-center min-h-screen bg-muted/40 p-4">
            <InvitedSignupForm 
                inviteToken={token}
                invitedEmail={email}
                teamName={teamName}
            />
        </div>
    );
}

// =================== FILE: src/app/[locale]/invitation/accept/_components/InvitedSignupForm.tsx ===================

"use client";

import { useTransition } from 'react';
import { signupAction } from '@/app/[locale]/(auth)/auth/actions';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Loader2, Mail, Lock, User as UserIcon } from 'lucide-react';

type InvitedSignupFormProps = {
  inviteToken?: string;
  invitedEmail?: string;
  teamName?: string | null;
};

export function InvitedSignupForm({ inviteToken, invitedEmail, teamName }: InvitedSignupFormProps) {
  const [isPending, startTransition] = useTransition();
  console.log("Props rebudes al formulari:", { inviteToken, invitedEmail, teamName });

  const handleSubmit = (formData: FormData) => {
    startTransition(() => {
      signupAction(formData);
    });
  };
  return (
    <Card className="w-full max-w-md shadow-lg">
      <CardHeader className="text-center">
        <CardTitle className="text-2xl">Benvingut/da a Bord!</CardTitle>
        <CardDescription>
          EstÃ s a punt d'unir-te a <strong>{teamName || "l'equip"}</strong>. NomÃ©s has de completar el teu perfil.
        </CardDescription>
      </CardHeader>
      <CardContent>
        <form action={handleSubmit} className="space-y-4">

          {/* Aquest input ocult Ã©s per al token, estÃ  perfecte. */}
          <input type="hidden" name="invite_token" value={inviteToken} />

          {/* El camp de l'email ja estÃ  configurat per a enviar-se amb el formulari
                        grÃ cies al 'name="email"'. Ã‰s visible perÃ² no editable. Perfecte! */}
          <div className="space-y-2">
            <Label htmlFor="email">El teu correu electrÃ²nic</Label>
            <div className="relative">
              <Mail className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" />
              <Input
                id="email"
                name="email" // Aquesta lÃ­nia l'envia amb el formulari
                type="email"
                required
                defaultValue={invitedEmail || ''}
                readOnly={true} // Aquesta lÃ­nia evita que es pugui editar
                className="pl-10 bg-muted/60 cursor-not-allowed focus-visible:ring-transparent"
              />
            </div>
          </div>

          {/* La resta del formulari es queda igual */}
          <div className="space-y-2">
            <Label htmlFor="fullName">Nom i cognoms</Label>
            <div className="relative">
              <UserIcon className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" />
              <Input
                id="fullName"
                name="fullName"
                placeholder="El teu nom complet"
                required
                className="pl-10"
                disabled={isPending}
              />
            </div>
          </div>
          <div className="space-y-2">
            <Label htmlFor="password">Crea una contrasenya</Label>
            <div className="relative">
              <Lock className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" />
              <Input
                id="password"
                name="password"
                type="password"
                placeholder="MÃ­nim 8 carÃ cters" // <-- Canvi aquÃ­
                required
                minLength={8} // <-- Canvi aquÃ­
                className="pl-10"
                disabled={isPending}
              />
            </div>
          </div>

          <Button type="submit" disabled={isPending} className="w-full">
            {isPending ? (
              <>
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                Creant compte...
              </>
            ) : (
              `Unir-se a ${teamName || "l'equip"}`
            )}
          </Button>
        </form>
      </CardContent>
    </Card>
  );
}

// =================== FILE: src/app/[locale]/layout.tsx ===================

import '../globals.css';
import 'prismjs/themes/prism-tomorrow.css';

import { Inter } from 'next/font/google';
import type { Metadata } from 'next';
import { ReactNode } from 'react';
import { Toaster } from 'sonner';
import { ThemeProvider } from '@/components/theme-provider';
import { NextIntlClientProvider } from 'next-intl';
import { getMessages, getTranslations } from 'next-intl/server';

const inter = Inter({ subsets: ['latin'] });

interface LocaleLayoutProps {
  children: ReactNode;
  params: Promise<{ locale: string }>;
}

export async function generateMetadata(props: { params: Promise<{ locale: string }> }): Promise<Metadata> {
  const { locale } = await props.params;
  const t = await getTranslations({ locale, namespace: 'Metadata' });
  const siteUrl = process.env.NEXT_PUBLIC_SITE_URL || 'https://ribotflow.com';

  return {
    title: { template: `%s | ${t('siteName')}`, default: t('defaultTitle') },
    description: t('description'),
    metadataBase: new URL(siteUrl),
    
    icons: {
      icon: '/favicon.ico',
      apple: '/apple-icon.png',
    },
    manifest: '/site.webmanifest',
  };
}

export default async function LocaleLayout(props: LocaleLayoutProps) {
  const { locale } = await props.params;
  const { children } = props;

  const messages = await getMessages({ locale });

  return (
    <html lang={locale} suppressHydrationWarning>
      <body className={inter.className}>
        <NextIntlClientProvider locale={locale} messages={messages}>
          <ThemeProvider
            attribute="class"
            defaultTheme="dark"
            enableSystem
            disableTransitionOnChange
          >
            {children}
          </ThemeProvider>
          <Toaster position="bottom-right" richColors closeButton />
        </NextIntlClientProvider>
      </body>
    </html>
  );
}

// =================== FILE: src/app/[locale]/onboarding/actions.ts ===================

// /app/[locale]/onboarding/actions.ts (FITXER CORREGIT I NET)
"use server";

// âŒ Eliminem 'zod', 'createAdminClient'
import { createClient } from "@/lib/supabase/server";
import { headers } from "next/headers";
import { redirect } from "next/navigation";

// âœ… 1. Importem el NOU servei i els seus tipus
import * as onboardingService from '@/lib/services/onboarding/onboarding.service';
import type { OnboardingFormData } from '@/lib/services/onboarding/schema';

export async function submitOnboardingAction(formData: OnboardingFormData) {
    // --- PAS 1: INICIALITZACIÃ“ I AUTENTICACIÃ“ ---
    const supabase = createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) {
        return { success: false, message: "Usuari no autenticat." };
    }

    // --- PAS 2: CRIDA AL SERVEI ---
    // Tota la lÃ²gica de validaciÃ³, BBDD, pipeline i auth estÃ  ara al servei.
    const result = await onboardingService.submitOnboarding(supabase, user, formData);

    if (result.success === false) {
      return result; // Retornem l'error al client
    }

    // --- PAS 3: REDIRECCIÃ“ SI TOT HA ANAT BÃ‰ ---
    await supabase.auth.refreshSession();
    const locale = (await headers()).get('x-next-intl-locale') || 'ca';
    redirect(`/${locale}/dashboard`);
}

// =================== FILE: src/app/[locale]/onboarding/page.tsx ===================

import { Suspense } from 'react';
import type { Metadata } from 'next';
import { OnboardingData } from './_components/OnboardingData';
import { OnboardingSkeleton } from './_components/OnboardingSkeleton';

export const metadata: Metadata = {
  title: 'Benvingut a Ribotflow',
  description: 'Completa el teu perfil per comenÃ§ar.',
};

export default function OnboardingPage() {
  return (
    <Suspense fallback={<OnboardingSkeleton />}>
      <OnboardingData />
    </Suspense>
  );
}

// =================== FILE: src/app/[locale]/onboarding/_components/OnboardingClient.tsx ===================

// /app/[locale]/onboarding/_components/OnboardingClient.tsx
"use client";

import React from 'react';
import { AnimatePresence } from 'framer-motion';
import { OnboardingProvider, useOnboarding } from './OnboardingContext';
import { OnboardingLayout } from './OnboardingLayout'; // Nou component per l'estructura
import { Step1, Step2, Step3 } from './steps'; // Components per a cada pas

interface OnboardingClientProps {
    initialFullName: string;
    availableServices: { id: number; name: string }[];
}

// Component intern que renderitza el pas actual
function OnboardingSteps({ availableServices }: { availableServices: { id: number; name: string }[] }) {
    const { step } = useOnboarding(); // Obtenim l'estat del context
    
    return (
        <AnimatePresence mode="wait">
            {step === 1 && <Step1 key="step1" />}
            {step === 2 && <Step2 key="step2" />}
            {step === 3 && <Step3 key="step3" availableServices={availableServices} />}
        </AnimatePresence>
    );
}

// El component principal ara Ã©s molt mÃ©s net
export function OnboardingClient({ initialFullName, availableServices }: OnboardingClientProps) {
    return (
        <OnboardingProvider initialFullName={initialFullName}>
            <OnboardingLayout>
                <OnboardingSteps availableServices={availableServices} />
            </OnboardingLayout>
        </OnboardingProvider>
    );
}

// =================== FILE: src/app/[locale]/onboarding/_components/OnboardingContext.tsx ===================

// /app/[locale]/onboarding/_context/OnboardingContext.tsx
"use client";

import { createContext, useContext, ReactNode } from 'react';
import { useOnboardingForm } from '../_hooks/useOnboardingForm';

// El 'ReturnType' ens estalvia haver de reescriure tots els tipus del hook
type OnboardingContextType = ReturnType<typeof useOnboardingForm> | null;

const OnboardingContext = createContext<OnboardingContextType>(null);

export function useOnboarding() {
    const context = useContext(OnboardingContext);
    if (!context) {
        throw new Error("useOnboarding ha de ser utilitzat dins d'un OnboardingProvider");
    }
    return context;
}

export function OnboardingProvider({ children, initialFullName }: { children: ReactNode, initialFullName: string }) {
    const value = useOnboardingForm(initialFullName);
    return (
        <OnboardingContext.Provider value={value}>
            {children}
        </OnboardingContext.Provider>
    );
}

// =================== FILE: src/app/[locale]/onboarding/_components/OnboardingData.tsx ===================

// /app/[locale]/onboarding/_components/OnboardingData.tsx (FITXER CORREGIT I NET)
import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { OnboardingClient } from './OnboardingClient';

// âœ… 1. Importem el NOU servei
import * as onboardingService from '@/lib/services/onboarding/onboarding.service';

export async function OnboardingData() {
    const supabase = createClient();

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
        return redirect('/login');
    }
    
    // âœ… 2. Cridem al SERVEI per obtenir les dades
    // Tota la lÃ²gica de 'Promise.all' i comprovacions s'ha mogut al servei.
    const { onboardingCompleted, availableServices, initialFullName } = 
      await onboardingService.getOnboardingData(supabase, user);

    // 3. Comprovem l'estat (lÃ²gica de visualitzaciÃ³)
    if (onboardingCompleted) {
        return redirect('/dashboard');
    }
    
    // 4. Renderitzem el Client Component amb les dades
    return (
        <OnboardingClient 
            initialFullName={initialFullName} 
            availableServices={availableServices}
        />
    );
}

// =================== FILE: src/app/[locale]/onboarding/_components/OnboardingLayout.tsx ===================

"use client";

import { useOnboarding } from './OnboardingContext';
import { useTranslations } from 'next-intl';
import { motion, AnimatePresence } from 'framer-motion';
import { Progress } from '@/components/ui/progress';
import { Button } from '@/components/ui/button';
import { ArrowLeft, ArrowRight, Loader2 } from 'lucide-react';

export function OnboardingLayout({ children }: { children: React.ReactNode }) {
    const { step, goToNextStep, goToPrevStep, handleSubmit, isPending } = useOnboarding();
    const t = useTranslations('OnboardingPage');
    const totalSteps = 3;
    const progress = (step / totalSteps) * 100;

    return (
        <div className="flex items-center justify-center min-h-screen p-4 bg-background">
            <div className="w-full max-w-2xl glass-card p-8 md:p-12 shadow-2xl space-y-6">
                <Progress value={progress} className="w-full" />
                <div className="text-center">
                    <p className="font-semibold text-primary mb-2">{t('step', { current: step, total: totalSteps })}</p>
                    <AnimatePresence mode="wait">
                        <motion.h1 key={step} initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }} className="text-3xl font-bold">
                            {step === 1 && t('step1.title')}
                            {step === 2 && t('step2.title')}
                            {step === 3 && t('step3.title')}
                        </motion.h1>
                    </AnimatePresence>
                </div>

                <div className="min-h-[250px] flex flex-col justify-center">
                    {children}
                </div>

                <div className="flex justify-between items-center pt-6 border-t">
                    <Button variant="ghost" onClick={goToPrevStep} disabled={step === 1 || isPending}>
                        <ArrowLeft className="mr-2 h-4 w-4" /> Enrere
                    </Button>
                    {step < totalSteps ? (
                        <Button onClick={goToNextStep} disabled={isPending}>
                            SegÃ¼ent <ArrowRight className="ml-2 h-4 w-4" />
                        </Button>
                    ) : (
                        <Button onClick={handleSubmit} disabled={isPending}>
                            {isPending ? <Loader2 className="animate-spin" /> : "Finalitzar"}
                        </Button>
                    )}
                </div>
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/onboarding/_components/OnboardingSkeleton.tsx ===================

"use client";

/**
 * @summary Esquelet de cÃ rrega per a la pÃ gina d'Onboarding.
 */
export function OnboardingSkeleton() {
  return (
    <div className="flex items-center justify-center min-h-screen p-4 bg-background animate-pulse">
      <div className="w-full max-w-2xl glass-card p-8 shadow-2xl">
        <div className="space-y-4">
          <div className="h-8 w-1/3 bg-gray-700/50 rounded-md"></div>
          <div className="h-5 w-2/3 bg-gray-700/50 rounded-md"></div>
          <div className="h-3 w-full bg-gray-700/50 rounded-md mt-4"></div>
        </div>
        <div className="mt-8 space-y-6">
          <div className="h-12 w-full bg-gray-700/50 rounded-md"></div>
          <div className="h-12 w-full bg-gray-700/50 rounded-md"></div>
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/onboarding/_components/ServiceSelectionModal.tsx ===================

"use client";

import React, { useState, useMemo, FC } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input'; // Importem l'Input per al cercador
import { Check, Search } from 'lucide-react'; // Importem la icona de cerca

// --- Component per a la targeta de servei individual (sense canvis) ---
const ServiceCard: FC<{ serviceName: string; isSelected: boolean; onClick: () => void; }> = ({ serviceName, isSelected, onClick }) => (
    <motion.button
        type="button"
        onClick={onClick}
        // ğŸ‘‡ PAS 1: ReduÃ¯m l'alÃ§ada i el padding per fer-la mÃ©s petita
        // ğŸ‘‡ PAS 2: Canviem les classes 'primary' per les 'green' quan estÃ  seleccionada
        className={`relative w-full h-16 p-2 rounded-lg border-2 flex items-center justify-center text-center font-semibold transition-all duration-200 ease-in-out ${ // -> h-24 p-4 a h-20 p-3
            isSelected 
                ? 'bg-green-100 border-green-600 text-green-700' // -> Canviat de 'primary' a 'green'
                : 'bg-muted/50 border-transparent hover:border-green-500/50' // -> BONUS: Canviat el hover a verd tambÃ©
        }`}
        whileTap={{ scale: 0.95 }}
    >
        {isSelected && (
            // ğŸ‘‡ PAS 3: Canviem el fons de la icona de 'check' a verd
            <div className="absolute top-2 right-2 bg-green-600 text-primary-foreground rounded-full p-1"> {/* // -> Canviat de 'bg-primary' a 'bg-green-600' */}
                <Check className="w-3 h-3" />
            </div>
        )}
        {serviceName}
    </motion.button>
);


// --- Component per al diÃ leg modal (AMB LES MILLORES) ---
interface ServiceSelectionModalProps {
    isOpen: boolean;
    onClose: () => void;
    availableServices: { id: number; name: string }[];
    selectedServices: string[];
    onToggleService: (serviceName: string) => void;
}

export const ServiceSelectionModal: FC<ServiceSelectionModalProps> = ({ isOpen, onClose, availableServices, selectedServices, onToggleService }) => {
    // âœ… PAS 1: Afegim un estat per al terme de cerca
    const [searchTerm, setSearchTerm] = useState('');

    // âœ… PAS 2: Filtrem els serveis basant-nos en el terme de cerca
    const filteredServices = useMemo(() => {
        if (!searchTerm) {
            return availableServices;
        }
        return availableServices.filter(service =>
            service.name.toLowerCase().includes(searchTerm.toLowerCase())
        );
    }, [searchTerm, availableServices]);

    return (
        <AnimatePresence>
            {isOpen && (
                <motion.div
                    initial={{ opacity: 0 }}
                    animate={{ opacity: 1 }}
                    exit={{ opacity: 0 }}
                    className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"
                    onClick={onClose}
                >
                    <motion.div
                        initial={{ scale: 0.9, opacity: 0, y: 20 }}
                        animate={{ scale: 1, opacity: 1, y: 0 }}
                        exit={{ scale: 0.9, opacity: 0, y: 20 }}
                        transition={{ type: 'spring', stiffness: 300, damping: 30 }}
                        className="bg-background rounded-xl shadow-2xl w-full max-w-3xl max-h-[80vh] flex flex-col"
                        onClick={(e) => e.stopPropagation()}
                    >
                        <div className="p-6 border-b">
                            <h2 className="text-2xl font-bold">Selecciona els teus serveis</h2>
                            {/* âœ… PAS 3: Augmentem la mida de la lletra de la descripciÃ³ */}
                            <p className="text-muted-foreground mt-1 text-sm">Tria les categories que millor descriuen la teva activitat.</p>
                            
                            {/* âœ… PAS 4: Afegim el camp de cerca */}
                            <div className="relative mt-4">
                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" />
                                <Input
                                    type="text"
                                    placeholder="Cerca serveis..."
                                    className="pl-10"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                        </div>
                        
                        {/* âœ… PAS 5: Renderitzem la llista filtrada */}
                        <div className="p-6 overflow-y-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            {filteredServices.length > 0 ? (
                                filteredServices.map(service => (
                                    <ServiceCard
                                        key={service.id}
                                        serviceName={service.name}
                                        isSelected={selectedServices.includes(service.name)}
                                        onClick={() => onToggleService(service.name)}
                                    />
                                ))
                            ) : (
                                <p className="text-muted-foreground col-span-full text-center py-8">No s'han trobat serveis.</p>
                            )}
                        </div>
                        
                        <div className="p-6 border-t mt-auto flex justify-end">
                            <Button onClick={onClose} size="lg">Fet</Button>
                        </div>
                    </motion.div>
                </motion.div>
            )}
        </AnimatePresence>
    );
};

// =================== FILE: src/app/[locale]/onboarding/_components/steps/index.ts ===================

export * from './Step1';
export * from './Step2';
export * from './Step3';

// =================== FILE: src/app/[locale]/onboarding/_components/steps/Step1.tsx ===================

"use client";

import { FC, ElementType } from 'react';
import { motion } from 'framer-motion';
import { useOnboarding } from '../OnboardingContext';
import { Input, type InputProps } from '@/components/ui/input';
import { User, Building, FileText } from 'lucide-react';

const InputWithIcon: FC<InputProps & { icon: ElementType }> = ({ icon: Icon, ...props }) => (
    <div className="relative">
        <Icon className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" />
        <Input className="pl-10" {...props} />
    </div>
);

export const Step1 = () => {
    const { formData, handleInputChange } = useOnboarding();

    return (
        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="space-y-6">
            <InputWithIcon icon={User} name="full_name" placeholder="El teu nom i cognoms" value={formData.full_name} onChange={handleInputChange} required />
            <InputWithIcon icon={Building} name="company_name" placeholder="Nom de la teva empresa o marca" value={formData.company_name} onChange={handleInputChange} required />
            <InputWithIcon icon={FileText} name="tax_id" placeholder="NIF/CIF (opcional)" value={formData.tax_id} onChange={handleInputChange} />
        </motion.div>
    );
};

// =================== FILE: src/app/[locale]/onboarding/_components/steps/Step2.tsx ===================

"use client";

import { motion } from 'framer-motion';
import { useOnboarding } from '../OnboardingContext';
import { AddressSearch } from '@/app/[locale]/_components/AddressSearch';
import { useTranslations } from 'next-intl';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';

// âœ… 1. IMPORTEM DE NOU ELS ICONES
import { Home, MapPin, Mailbox, Landmark } from 'lucide-react';

export const Step2 = () => {
    const { formData, handleAddressSelect, handleAddressChange } = useOnboarding();
    const t = useTranslations('OnboardingPage');

    return (
        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="space-y-6">
            <AddressSearch onAddressSelect={handleAddressSelect} />
            
            {formData.address && (
                <div className="pt-6 border-t grid grid-cols-1 sm:grid-cols-2 gap-4">
                    
                    {/* Camp del Carrer */}
                    <div className="space-y-2">
                        <Label htmlFor="street">{t('step2.streetLabel')}</Label>
                        {/* âœ… 2. AFEGIM EL CONTENIDOR I L'ICONE */}
                        <div className="relative flex items-center">
                            <Home className="absolute left-3 w-4 h-4 text-muted-foreground" />
                            <Input
                                id="street"
                                value={formData.address.street ?? ''}
                                onChange={(e) => handleAddressChange('street', e.target.value)}
                                placeholder={t('step2.addressPlaceholder')}
                                className="pl-10" // <-- Donem espai a l'esquerra per a l'icone
                            />
                        </div>
                    </div>

                    {/* Camp de la Ciutat */}
                    <div className="space-y-2">
                        <Label htmlFor="city">{t('step2.cityLabel')}</Label>
                        <div className="relative flex items-center">
                            <MapPin className="absolute left-3 w-4 h-4 text-muted-foreground" />
                            <Input
                                id="city"
                                value={formData.address.city ?? ''}
                                onChange={(e) => handleAddressChange('city', e.target.value)}
                                placeholder={t('step2.cityPlaceholder')}
                                className="pl-10"
                            />
                        </div>
                    </div>

                    {/* Camp del Codi Postal */}
                    <div className="space-y-2">
                        <Label htmlFor="postcode">{t('step2.postcodeLabel')}</Label>
                        <div className="relative flex items-center">
                            <Mailbox className="absolute left-3 w-4 h-4 text-muted-foreground" />
                            <Input
                                id="postcode"
                                value={formData.address.postcode ?? ''}
                                onChange={(e) => handleAddressChange('postcode', e.target.value)}
                                placeholder={t('step2.postcodePlaceholder')}
                                className="pl-10"
                            />
                        </div>
                    </div>

                    {/* Camp de la RegiÃ³/ProvÃ­ncia */}
                    <div className="space-y-2">
                        <Label htmlFor="region">{t('step2.regionLabel')}</Label>
                        <div className="relative flex items-center">
                            <Landmark className="absolute left-3 w-4 h-4 text-muted-foreground" />
                            <Input
                                id="region"
                                value={formData.address.region ?? ''}
                                onChange={(e) => handleAddressChange('region', e.target.value)}
                                placeholder={t('step2.regionLabel')}
                                className="pl-10"
                            />
                        </div>
                    </div>
                </div>
            )}
        </motion.div>
    );
};

// =================== FILE: src/app/[locale]/onboarding/_components/steps/Step3.tsx ===================

"use client";

import { useState, FC, ElementType } from 'react';
import { motion } from 'framer-motion';
import { useOnboarding } from '../OnboardingContext';
import { ServiceSelectionModal } from '../ServiceSelectionModal';
import { Input, type InputProps } from '@/components/ui/input';
import { Phone, Globe, Briefcase } from 'lucide-react';

const InputWithIcon: FC<InputProps & { icon: ElementType }> = ({ icon: Icon, ...props }) => (
    <div className="relative">
        <Icon className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" />
        <Input className="pl-10" {...props} />
    </div>
);

export const Step3 = ({ availableServices }: { availableServices: { id: number; name: string }[] }) => {
    const { formData, handleInputChange, handleToggleService } = useOnboarding();
    const [isServicesModalOpen, setIsServicesModalOpen] = useState(false);

    return (
        <>
            <ServiceSelectionModal
                isOpen={isServicesModalOpen}
                onClose={() => setIsServicesModalOpen(false)}
                availableServices={availableServices}
                selectedServices={formData.services}
                onToggleService={handleToggleService}
            />
            <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="space-y-6">
                <InputWithIcon icon={Phone} name="phone" type="tel" placeholder="TelÃ¨fon de contacte" value={formData.phone} onChange={handleInputChange} />
                <InputWithIcon icon={Globe} name="website" placeholder="PÃ gina web (opcional) Ex: https://digitaistudios.com/ " value={formData.website} onChange={handleInputChange} />
                <div>
                    <label className="text-sm font-medium text-muted-foreground mb-2 block">Serveis principals</label>
                    <button type="button" onClick={() => setIsServicesModalOpen(true)} className="w-full min-h-[40px] flex items-center gap-2 rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background text-left">
                        <Briefcase className="w-5 h-5 text-muted-foreground shrink-0" />
                        {formData.services.length > 0 ? (
                            <div className="flex flex-wrap gap-1">
                                {formData.services.map(service => (
                                    <span key={service} className="bg-muted text-muted-foreground px-2 py-0.5 rounded-md text-xs">{service}</span>
                                ))}
                            </div>
                        ) : (
                            <span className="text-muted-foreground">Fes clic per a seleccionar serveis</span>
                        )}
                    </button>
                    <p className="text-xs text-muted-foreground mt-1">Selecciona les categories que millor et defineixen.</p>
                </div>
            </motion.div>
        </>
    );
};

// =================== FILE: src/app/[locale]/onboarding/_hooks/useOnboardingForm.ts ===================

"use client";

import { useState, useTransition } from 'react';
import { toast } from 'sonner';
import type { DetailedAddress } from '@/types/shared/address';
import { submitOnboardingAction } from '../actions';

const initialFormData = {
    full_name: '',
    company_name: '',
    tax_id: '',
    website: '',
    phone: '',
    services: [] as string[],
    address: null as DetailedAddress | null,
    summary: '',
    sector: '',
};

export function useOnboardingForm(initialFullName: string) {
    const [formData, setFormData] = useState({ ...initialFormData, full_name: initialFullName });
    const [step, setStep] = useState(1);
    const [isPending, startTransition] = useTransition();

    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
        setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
    };

    const handleAddressSelect = (address: DetailedAddress) => {
        setFormData(prev => ({ ...prev, address }));
    };

    const handleToggleService = (serviceName: string) => {
        setFormData(prev => ({
            ...prev,
            services: prev.services.includes(serviceName)
                ? prev.services.filter(s => s !== serviceName)
                : [...prev.services, serviceName]
        }));
    };

    const validateStep = (currentStep: number): boolean => {
        switch (currentStep) {
            case 1: return !!formData.full_name && !!formData.company_name;
            case 2:
                // âœ… Comprovem que l'objecte 'address' existeix I que els seus camps obligatoris tenen valor.
                return (
                    !!formData.address &&
                    !!formData.address.street &&
                    !!formData.address.city &&
                    !!formData.address.postcode &&
                    !!formData.address.region && // <-- LA COMPROVACIÃ“ CLAU QUE FALTAVA
                    !!formData.address.country
                ); case 3: return formData.services.length > 0;
            default: return true;
        }
    };

    const goToNextStep = () => {
        if (validateStep(step)) setStep(s => Math.min(3, s + 1));
        else toast.error("Si us plau, completa els camps obligatoris.");
    };

    const goToPrevStep = () => setStep(s => Math.max(1, s - 1));

    const handleSubmit = () => {
        // 1. ValidaciÃ³ dels passos (aixÃ² ja ho tenies)
        if (!validateStep(1) || !validateStep(2) || !validateStep(3)) {
            toast.error("Falten camps per completar en alguns dels passos.");
            return;
        }

        // 2. âœ… AFEGIM LA COMPROVACIÃ“ DE SEGURETAT (LA GUARDA)
        // Aquesta lÃ­nia Ã©s la clau. Si l'adreÃ§a Ã©s nulÂ·la, mostrem un error i parem l'execuciÃ³.
        if (!formData.address) {
            toast.error("L'adreÃ§a Ã©s obligatÃ²ria. Si us plau, selecciona'n una.");
            return;
        }

        startTransition(async () => {
            // 3. Ara TypeScript ja sap que 'formData.address' no pot ser 'null' aquÃ­.
            const finalDataForAction = {
                full_name: formData.full_name,
                company_name: formData.company_name,
                tax_id: formData.tax_id,
                website: formData.website,
                summary: formData.summary,
                sector: formData.sector,
                services: formData.services,
                phone: formData.phone,
                street: formData.address!.street, // <-- Ara Ã©s segur accedir aquÃ­
                city: formData.address!.city,
                postal_code: formData.address!.postcode,
                region: formData.address!.region,
                country: formData.address!.country,
                latitude: formData.address!.latitude ?? undefined,
                longitude: formData.address!.longitude ?? undefined,
            };

            const result = await submitOnboardingAction(finalDataForAction);

            if (result?.success === false) {
                toast.error(result.message || "Hi ha hagut un error desconegut.");
            }
        });
    };
    // âœ… NOU GESTOR PER A L'EDICIÃ“ MANUAL DELS CAMPS DE L'ADREÃ‡A
    const handleAddressChange = (field: keyof DetailedAddress, value: string) => {
        setFormData(prev => ({
            ...prev,
            address: {
                // Si l'adreÃ§a no existeix, creem un objecte base per evitar errors
                ...(prev.address || { street: '', city: '', postcode: '', region: '', country: '', latitude: null, longitude: null }),
                [field]: value
            }
        }));
    };

    // âœ… Assegura't que l'objecte que retornes inclou TOTES aquestes funcions
    return {
        step,
        formData,
        isPending,
        handleInputChange,
        handleAddressSelect,
        handleAddressChange, // âœ… EXPORTEM LA NOVA FUNCIÃ“
        handleToggleService,
        goToNextStep,
        goToPrevStep,
        handleSubmit, // <-- La funciÃ³ que faltava!
    };
}

// =================== FILE: src/app/[locale]/page.tsx ===================

/**
 * @file src/app/[locale]/page.tsx
 * @summary Aquesta Ã©s la pÃ gina d'inici (Landing Page).
 * No fa cap redirecciÃ³. El middleware s'encarrega de tot.
 */
import type { Metadata } from 'next';
import { MainLandingView } from './(public)/MainLandingView';

export const metadata: Metadata = {
  title: 'Ribotflow - El Futur de la GestiÃ³ Empresarial',
  description: 'Unifica el teu CRM, vendes i comunicacions.',
};

export default function LandingPage() {
  return <MainLandingView />;
}

// =================== FILE: src/app/[locale]/quote/[secureId]/actions.ts ===================

// src/app/[locale]/quote/[secureId]/actions.ts (FITXER CORREGIT I NET)
"use server";

import { revalidatePath } from "next/cache";
// âŒ Eliminem 'createAdminClient', 'zod', 'QuoteItem'

// âœ… 1. Importem el NOU servei i els seus tipus
import * as publicQuoteService from '@/lib/services/publicQuote/public-quote.service';
import type { FormState } from '@/lib/services/publicQuote/public-quote.service';

/**
 * Gestiona l'acceptaciÃ³ d'un pressupost.
 */
export async function acceptQuoteAction(secureId: string): Promise<FormState> {
  // 1. Crida al servei (la validaciÃ³ Zod i la RPC es fan dins)
  const result = await publicQuoteService.acceptQuote(secureId);

  // 2. Efectes (revalidaciÃ³)
  if (result.success) {
    revalidatePath('/crm/quotes');
    revalidatePath('/finances/facturacio');
  }

  return result;
}

/**
 * Gestiona el rebuig d'un pressupost.
 */
export async function rejectQuoteAction(secureId: string, reason: string): Promise<FormState> {
  // 1. Crida al servei (la validaciÃ³ Zod i la RPC es fan dins)
  const result = await publicQuoteService.rejectQuote(secureId, reason);

  // 2. Efectes (revalidaciÃ³)
  if (result.success) {
    revalidatePath('/crm/quotes');
    revalidatePath('/crm/activitats'); // Revalidem tambÃ© activitats
  }

  return result;
}

// =================== FILE: src/app/[locale]/quote/[secureId]/page.tsx ===================

// FITXER: app/[locale]/(app)/crm/quotes/[secureId]/page.ts

import { notFound } from 'next/navigation';
import { PublicQuoteClient } from './_components/PublicQuoteClient';
import { getQuoteDataBySecureId } from './_components/PublicQuoteData';

// ğŸ‘‡ CORRECCIÃ“: 'params' Ã©s un objecte, no una Promise.
//    El nom de la propietat ha de coincidir amb el nom del directori dinÃ mic, que Ã©s '[id]'.
type PageProps = {
  params: Promise<{ secureId: string }>;
};

export default async function PublicQuotePage({ params }: PageProps) {
  // ğŸ‘‡ CORRECCIÃ“: No cal fer 'await' a 'params'. Accedeix directament.
 const { secureId: userId } = await params;
  
  // Utilitzem 'id' per a obtenir les dades.
  const quoteData = await getQuoteDataBySecureId(userId);

  if (!quoteData) {
    notFound();
  }

  return <PublicQuoteClient initialQuoteData={quoteData} />;
}

// =================== FILE: src/app/[locale]/quote/[secureId]/_components/PublicQuoteClient.tsx ===================

"use client";

import { usePublicQuote } from "../_hooks/usePublicQuote";
import { RejectionDialog } from "./RejectionDialog";
import { QuoteStatusScreen } from "./QuoteStatusScreeen";
import { PublicQuoteView } from "./PublicQuoteView";
import type { QuoteDataFromServer } from "@/types/finances/quotes"; // âœ… Importem el tipus correcte    

export function PublicQuoteClient({ initialQuoteData }: { initialQuoteData: QuoteDataFromServer; }) {
    // Tota la lÃ²gica complexa ara provÃ© d'aquest hook.
    const {
        quote,
        isPending,
        finalStatus,
        isRejecting,
        setIsRejecting,
        handleAccept,
        handleReject
    } = usePublicQuote(initialQuoteData);

    // Si el pressupost ja tÃ© un estat final (acceptat o rebutjat), mostrem la pantalla corresponent.
    if (finalStatus) {
        return <QuoteStatusScreen status={finalStatus} quote={quote} />;
    }

    // Si no, mostrem la vista principal del pressupost i el diÃ leg de rebuig (que estÃ  ocult per defecte).
    return (
        <>
            <PublicQuoteView
                quoteData={quote}
                onAccept={handleAccept}
                onReject={() => setIsRejecting(true)} // Aquest botÃ³ nomÃ©s obre el diÃ leg
                isPending={isPending}
            />
            <RejectionDialog
                isOpen={isRejecting}
                onOpenChange={setIsRejecting}
                onSubmit={handleReject} // La lÃ²gica de rebuig real s'executa aquÃ­
                isPending={isPending}
            />
        </>
    );
}


// =================== FILE: src/app/[locale]/quote/[secureId]/_components/PublicQuoteData.tsx ===================

// Al teu fitxer de servidor (p.ex. /quote/[secureId]/page.tsx)
import { createClient } from '@/lib/supabase/server'; 
import type { QuoteDataFromServer } from "@/types/finances/quotes"; 
// Importem els tipus de la base de dades (assegura't que la ruta Ã©s correcta)
import { type Database } from '@/types/supabase'; 

// Definim el tipus que SÃ esperem al Pas 1
type QuoteWithRelations = Database['public']['Tables']['quotes']['Row'] & {
  contacts: Database['public']['Tables']['contacts']['Row'] | null;
  team: Database['public']['Tables']['teams']['Row'] | null;
};

/**
Â * FunciÃ³ de servidor per obtenir les dades d'un pressupost (versiÃ³ manual).
Â * @param secureId L'ID Ãºnic del pressupost.
Â * @returns Les dades del pressupost o null si no es troba.
Â */
export async function getQuoteDataBySecureId(secureId: string): Promise<QuoteDataFromServer | null> {
Â  Â  
Â  Â  const supabase = createClient();

Â  Â  // PAS 1: Obtenim el pressupost (sense els items)
Â  Â  const selectString = "*, contacts (*), team:teams (*)";

Â  Â  const { data: quoteData, error: quoteError } = await supabase
Â  Â  Â  Â  .from("quotes")
Â  Â  Â  Â  .select(selectString) 
Â  Â  Â  Â  .eq("secure_id", secureId)
Â  Â  Â  Â  .single<QuoteWithRelations>(); 

Â  Â  if (quoteError || !quoteData) {
Â  Â  Â  Â  console.error("Error carregant dades del pressupost (Pas 1):", quoteError?.message || "Dades no trobades");
Â  Â  Â  Â  return null;
Â  Â  }
Â  Â  
Â  Â  // PAS 2: Obtenim els items manualment (Sabem que la RLS d'aixÃ² funciona)
Â  Â  const { data: itemsData, error: itemsError } = await supabase
Â  Â  Â  Â  .from("quote_items")
Â  Â  Â  Â  .select("*")
Â  Â  Â  Â  .eq("quote_id", quoteData.id);

Â  Â  if (itemsError) {
Â  Â  Â  Â  console.error("Pressupost trobat, perÃ² error en carregar items (Pas 2):", itemsError.message);
Â  Â  }

Â  Â  // PAS 3: Combinem els resultats manualment
Â  Â  // âœ… --- LA CORRECCIÃ“ DEFINITIVA ---
Â  Â  // Canviem el nom de 'quote_items' (BD) a 'items' (React)
Â  Â  const fullData = {
Â  Â  Â  Â  ...quoteData,
Â  Â  Â  Â  items: itemsData || [] // <-- Canviem 'quote_items' per 'items'
Â  Â  };

    // Fem una petita trampa a TypeScript per unificar els tipus
Â  Â  return fullData as unknown as QuoteDataFromServer;
}

// =================== FILE: src/app/[locale]/quote/[secureId]/_components/PublicQuoteView.tsx ===================

"use client";

import { Button } from "@/components/ui/button";
import { Loader2, CheckCircle, XCircle } from "lucide-react";
import { QuotePreview } from "@/app/[locale]/(app)/finances/quotes/[id]/_components/QuotePreview";
import { type QuoteDataFromServer } from "@/types/finances/quotes"; // âœ… Importem el tipus correcte
// âœ… 1. Importem els tipus que 'QuotePreview' realment espera.
import { type EditableQuote } from "@/app/[locale]/(app)/finances/quotes/[id]/_hooks/useQuoteEditor";
import { type Database } from "@/types/supabase";

// Definim els tipus locals que 'QuotePreview' utilitza
type Contact = Database['public']['Tables']['contacts']['Row'];
type Team = Database['public']['Tables']['teams']['Row'];

interface PublicQuoteViewProps {
    quoteData: QuoteDataFromServer;
    onAccept: () => void;
    onReject: () => void;
    isPending: boolean;
}

export function PublicQuoteView({ quoteData, onAccept, onReject, isPending }: PublicQuoteViewProps) {
    
    // âœ… 2. Creem l'objecte 'quoteForPreview' amb el tipus correcte 'EditableQuote'.
    //    Fem una asserciÃ³ de tipus perquÃ¨ sabem que l'estructura de dades Ã©s compatible.
    const quoteForPreview = quoteData as unknown as EditableQuote;

    return (
        <div className="bg-gray-100 min-h-screen p-4 sm:p-8">
            <div className="max-w-4xl mx-auto">
                <div className="text-center mb-6">
                    <h1 className="text-3xl text-black font-bold">RevisiÃ³ del Pressupost</h1>
                    <p className="text-gray-600">Hola {quoteData.contacts?.nom || "estimat client"}, revisa els detalls i confirma la teva decisiÃ³.</p>
                </div>
                <div className="bg-white rounded-lg shadow-lg">
                    <QuotePreview
                        quote={quoteForPreview}
                        // âœ… 3. Assegurem que els contactes es passen com el tipus correcte.
                        contacts={quoteData.contacts ? [quoteData.contacts as unknown as Contact] : []}
                        // âœ… 4. Assegurem que el perfil de l'empresa es passa com el tipus correcte.
                        companyProfile={quoteData.team as unknown as Team | null}
                        subtotal={quoteData.subtotal || 0}
                        discountAmount={(quoteData.subtotal || 0) * (quoteData.discount || 0) / 100}
                        tax={quoteData.tax || 0}
                        total={quoteData.total || 0}
                    />
                </div>
                <div className="mt-8 p-6 bg-white rounded-lg shadow-lg flex flex-col sm:flex-row justify-around items-center gap-4">
                    <p className="text-lg text-black font-semibold">EstÃ s d'acord amb aquest pressupost?</p>
                    <div className="flex gap-4">
                        <Button variant="destructive" size="lg" disabled={isPending} onClick={onReject}>
                            <XCircle className="w-5 h-5 mr-2" /> Rebutjar
                        </Button>
                        <Button className="bg-green-600 hover:bg-green-700" size="lg" onClick={onAccept} disabled={isPending}>
                            {isPending ? <Loader2 className="w-5 h-5 mr-2 animate-spin" /> : <CheckCircle className="w-5 h-5 mr-2" />}
                            Acceptar Pressupost
                        </Button>
                    </div>
                </div>
            </div>
        </div>
    );
}

// =================== FILE: src/app/[locale]/quote/[secureId]/_components/QuoteStatusScreeen.tsx ===================

"use client";

import { CheckCircle, XCircle } from "lucide-react";
import type { QuoteDataFromServer } from "@/types/finances/quotes"; // âœ… Importem el tipus correcte    

interface QuoteStatusScreenProps {
    status: 'accepted' | 'declined';
    quote: QuoteDataFromServer;
}

export function QuoteStatusScreen({ status, quote }: QuoteStatusScreenProps) {
    if (status === 'accepted') {
        return (
            <div className="flex flex-col h-screen w-full justify-center items-center bg-gray-100 text-center p-4">
                <CheckCircle className="w-24 h-24 text-green-500 mb-4" />
                <h1 className="text-3xl text-black font-bold mb-2">Pressupost Acceptat!</h1>
                <p className="text-lg text-black">GrÃ cies per la teva confianÃ§a, {quote.contacts?.nom}.</p>
                <p className="text-lg text-black">Hem notificat a {quote.team?.name || 'l\'empresa'} i es posaran en contacte amb tu aviat.</p>
            </div>
        );
    }

    return (
        <div className="flex flex-col h-screen w-full justify-center items-center bg-gray-100 text-center p-4">
            <XCircle className="w-24 h-24 text-red-500 mb-4" />
            <h1 className="text-3xl text-black font-bold mb-2">Feedback rebut</h1>
            <p className="text-lg text-black">GrÃ cies pels teus comentaris.</p>
        </div>
    );
}


// =================== FILE: src/app/[locale]/quote/[secureId]/_components/RejectionDialog.tsx ===================

"use client";

import { useState } from 'react';
import { toast } from 'sonner';

// UI Components
import { Button } from "@/components/ui/button";
import { AlertDialog, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from "@/components/ui/alert-dialog";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Loader2, Send } from "lucide-react";

interface RejectionDialogProps {
    isOpen: boolean;
    onOpenChange: (open: boolean) => void;
    onSubmit: (reason: string) => void;
    isPending: boolean;
}

export function RejectionDialog({ isOpen, onOpenChange, onSubmit, isPending }: RejectionDialogProps) {
    const [reason, setReason] = useState("");

    const handleSubmit = () => {
        if (reason.trim() === "") {
            toast.error("Motiu requerit", { description: "Si us plau, explica breument per quÃ¨ rebutges el pressupost." });
            return;
        }
        onSubmit(reason);
    };

    return (
        <AlertDialog open={isOpen} onOpenChange={onOpenChange}>
            <AlertDialogContent>
                <AlertDialogHeader>
                    <AlertDialogTitle>Rebutjar el Pressupost</AlertDialogTitle>
                    <AlertDialogDescription>Per ajudar-nos a millorar, si us plau, explica'ns breument els motius de la teva decisiÃ³.</AlertDialogDescription>
                </AlertDialogHeader>
                <div className="py-4">
                    <Label htmlFor="rejectionReason" className="text-left">Motius del rebuig</Label>
                    <Textarea id="rejectionReason" placeholder="Ex: El preu Ã©s massa alt, falten funcionalitats..." className="mt-2" value={reason} onChange={(e) => setReason(e.target.value)} />
                </div>
                <AlertDialogFooter>
                    <AlertDialogCancel disabled={isPending}>CancelÂ·lar</AlertDialogCancel>
                    <Button onClick={handleSubmit} disabled={isPending}>
                        {isPending ? <Loader2 className="w-4 h-4 mr-2 animate-spin" /> : <Send className="w-4 h-4 mr-2" />}
                        Enviar i Rebutjar
                    </Button>
                </AlertDialogFooter>
            </AlertDialogContent>
        </AlertDialog>
    );
}


// =================== FILE: src/app/[locale]/quote/[secureId]/_hooks/usePublicQuote.ts ===================

"use client";

import { useState, useTransition } from 'react';
import { toast } from 'sonner';
import { acceptQuoteAction, rejectQuoteAction } from '../actions';
import type { QuoteDataFromServer } from "@/types/finances/quotes"; // âœ… Importem el tipus correcte    

/**
 * Hook que encapsula tota la lÃ²gica per a la pÃ gina pÃºblica d'un pressupost.
 */
export function usePublicQuote(initialQuote: QuoteDataFromServer) {
    const [quote] = useState(initialQuote);
    const [isPending, startTransition] = useTransition();

    // L'estat final del pressupost (acceptat o rebutjat)
    const [finalStatus, setFinalStatus] = useState<'accepted' | 'declined' | null>(() => {
        if (quote.status === "Accepted") return "accepted";
        if (quote.status === "Declined") return "declined";
        return null;
    });

    // Estat per a controlar la visibilitat del diÃ leg de rebuig
    const [isRejecting, setIsRejecting] = useState(false);

    const handleAccept = () => {
        startTransition(async () => {
            const result = await acceptQuoteAction(quote.secure_id);
            if (result.success) {
                setFinalStatus("accepted");
            } else {
                toast.error("Error en acceptar", { description: result.message });
            }
        });
    };

    const handleReject = (reason: string) => {
        startTransition(async () => {
            const result = await rejectQuoteAction(quote.secure_id, reason);
            if (result.success) {
                setFinalStatus("declined");
                setIsRejecting(false);
            } else {
                toast.error("Error en rebutjar", { description: result.message });
            }
        });
    };

    return {
        quote,
        isPending,
        finalStatus,
        isRejecting,
        setIsRejecting,
        handleAccept,
        handleReject
    };
}


// =================== FILE: src/app/[locale]/_components/AddressSearch.tsx ===================

"use client";

import React, { useState, useCallback, useEffect } from 'react';
import { useTranslations } from 'next-intl';
import { useDebounce } from 'use-debounce';
import { Input } from '@/components/ui/input';
import { Loader2, MapPin } from 'lucide-react';
import type { DetailedAddress } from '@/types/shared/address';

interface AddressSearchProps {
  onAddressSelect: (address: DetailedAddress) => void;
}

// âœ… 1. DEFINIM UN TIPUS SEGUR PER ALS SUGGERIMENTS DE MAPBOX
interface MapboxSuggestion {
  name: string;
  mapbox_id: string;
  full_address: string;
}

export function AddressSearch({ onAddressSelect }: AddressSearchProps) {
  const t = useTranslations('OnboardingPage.step2');
  const [query, setQuery] = useState('');
  // âœ… 2. APLIQUEM EL NOU TIPUS A L'ESTAT DELS SUGGERIMENTS
  const [suggestions, setSuggestions] = useState<MapboxSuggestion[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [debouncedQuery] = useDebounce(query, 500);

  const fetchSuggestions = useCallback(async (searchTerm: string) => {
    if (searchTerm.length < 3) {
      setSuggestions([]);
      return;
    }
    setIsLoading(true);
    const accessToken = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;
    const endpoint = `https://api.mapbox.com/search/searchbox/v1/suggest?q=${encodeURIComponent(searchTerm)}&language=ca,es&session_token=08a700a8-1423-4c99-800a-471238634710&access_token=${accessToken}`;
    
    try {
      const response = await fetch(endpoint);
      const data = await response.json();
      setSuggestions(data.suggestions || []);
    } catch (error) {
      console.error(t('errorFetchingSuggestions'), error);
    } finally {
      setIsLoading(false);
    }
  }, [t]);

  useEffect(() => {
    fetchSuggestions(debouncedQuery);
  }, [debouncedQuery, fetchSuggestions]);

  // âœ… 3. APLIQUEM EL NOU TIPUS AL PARÃ€METRE DE LA FUNCIÃ“
  const handleSelectSuggestion = async (suggestion: MapboxSuggestion) => {
    setIsLoading(true);
    setQuery(''); 
    setSuggestions([]);

    const accessToken = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;
    const endpoint = `https://api.mapbox.com/search/searchbox/v1/retrieve/${suggestion.mapbox_id}?session_token=08a700a8-1423-4c99-800a-471238634710&access_token=${accessToken}`;
    
    try {
        const response = await fetch(endpoint);
        const data = await response.json();
        const feature = data.features[0];
        if (!feature) return;

        const context = feature.properties.context;
        
        onAddressSelect({
            street: feature.properties.address || '',
            city: context?.place?.name || '',
            postcode: context?.postcode?.name || '',
            region: context?.region?.name || '',
            country: context?.country?.name || '',
            latitude: feature.geometry.coordinates[1],
            longitude: feature.geometry.coordinates[0],
        });
    } catch (error) {
        console.error(t('errorRetrievingAddress'), error);
    } finally {
        setIsLoading(false);
    }
  };

  return (
    <div className="relative">
      <div className="relative">
        <MapPin className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" />
        <Input
          placeholder={t('addressPlaceholder')}
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          className="pl-10"
        />
        {isLoading && <Loader2 className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 animate-spin" />}
      </div>

      {suggestions.length > 0 && (
        <ul className="absolute z-10 w-full mt-2 bg-card border rounded-md shadow-lg max-h-60 overflow-y-auto">
          {suggestions.map((s) => (
            <li 
              key={s.mapbox_id}
              onClick={() => handleSelectSuggestion(s)}
              className="px-4 py-2 hover:bg-muted cursor-pointer"
            >
              <p className="font-semibold">{s.name}</p>
              <p className="text-sm text-muted-foreground">{s.full_address}</p>
            </li>
          ))}
        </ul>
      )}
    </div>
  );
}

// =================== FILE: src/components/chatbot/Chatbot.tsx ===================

"use client";

import { useState, useRef, useEffect } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Bot, Send, User, Loader2, X } from 'lucide-react';
import { useNavigationStore } from '@/stores/navigationStore';

export function Chatbot() {
    const [messages, setMessages] = useState<{ id: string; role: 'user' | 'assistant'; content: string }[]>([]);
    const [input, setInput] = useState('');
    const [isLoading, setIsLoading] = useState(false);
    const chatContainerRef = useRef<HTMLDivElement>(null);
    const { toggleChatbot } = useNavigationStore();

    useEffect(() => {
        if (chatContainerRef.current) {
            chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
        }
    }, [messages]);

    const handleSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault();
        if (!input.trim()) return;

        const userMessage = { id: crypto.randomUUID(), role: 'user' as const, content: input };
        setMessages(prev => [
            ...prev,
            userMessage,
            { id: crypto.randomUUID(), role: 'assistant', content: '' }
        ]);
        setIsLoading(true);
        const question = input;
        setInput('');

        try {
            const response = await fetch('/api/chatbot', {
                method: 'POST',
                body: JSON.stringify({ question }),
            });

            if (!response.ok || !response.body) throw new Error("Error en la resposta del servidor.");

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                setMessages(prev => {
                    const newMessages = [...prev];
                    newMessages[newMessages.length - 1].content += chunk;
                    return newMessages;
                });
            }
        // eslint-disable-next-line @typescript-eslint/no-unused-vars
        } catch (error) {
            setMessages(prev => {
                const newMessages = [...prev];
                newMessages[newMessages.length - 1].content = "Hi ha hagut un error. Si us plau, intenta-ho de nou.";
                return newMessages;
            });
        } finally {
            setIsLoading(false);
        }
    };

    function handleInputChange(event: React.ChangeEvent<HTMLInputElement>): void {
        setInput(event.target.value);
    }

    return (
        <div className="fixed bottom-4 right-4 w-96 h-[600px] bg-card border rounded-lg shadow-lg flex flex-col">
            <div className="p-4 border-b flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <Bot className="w-6 h-6 text-primary" />
                    <h2 className="font-semibold">Assistent d'IA</h2>
                </div>
                <Button variant="ghost" size="icon" onClick={toggleChatbot} className="h-8 w-8">
                    <X className="w-4 h-4" />
                </Button>
            </div>
            <div ref={chatContainerRef} className="flex-1 p-4 overflow-y-auto space-y-4">
                {messages.map((msg) => (
                    <div key={msg.id} className={`flex gap-3 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                        {msg.role === 'assistant' && <Bot className="w-6 h-6 flex-shrink-0" />}
                        <div className={`p-3 rounded-lg max-w-xs whitespace-pre-wrap ${msg.role === 'user' ? 'bg-primary text-primary-foreground' : 'bg-muted'}`}>
                            {msg.content}
                        </div>
                        {msg.role === 'user' && <User className="w-6 h-6 flex-shrink-0" />}
                    </div>
                ))}
                {isLoading && (
                    <div className="flex justify-start gap-3">
                        <Bot className="w-6 h-6 flex-shrink-0" />
                        <div className="p-3 rounded-lg bg-muted flex items-center justify-center">
                            <Loader2 className="w-5 h-5 animate-spin" />
                        </div>
                    </div>
                )}
            </div>
            <form onSubmit={handleSubmit} className="p-4 border-t flex gap-2">
                <Input
                    value={input}
                    onChange={handleInputChange}
                    placeholder="Fes una pregunta..."
                    disabled={isLoading}
                />
                <Button type="submit" disabled={isLoading || !input.trim()}>
                    <Send className="w-4 h-4" />
                </Button>
            </form>
        </div>
    );
}

// =================== FILE: src/components/features/contactes/ContactSelector.tsx ===================

"use client";

import { FC, useState } from 'react';
import { useTranslations } from 'next-intl';
import { Button } from '@/components/ui/button';
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from "@/components/ui/command";
import { Check, ChevronsUpDown } from 'lucide-react';
import { cn } from "@/lib/utils/utils";

type MinimalContact = {
  id: number;
  nom: string | null; 
};
interface Props {
    contacts: MinimalContact[]; // âœ… Ara espera el tipus de la BD
    selectedId: number | null;
    onSelect: (contactId: number | null) => void;
    disabled?: boolean;
}

export const ContactSelector: FC<Props> = ({ 
    contacts, 
    selectedId, 
    onSelect, 
    disabled = false 
}) => {
    const t = useTranslations('OpportunityDialog');
    const [open, setOpen] = useState(false);

    const selectedContact = contacts.find(c => c.id === selectedId);

    return (
        <Popover open={open} onOpenChange={setOpen}>
            <PopoverTrigger asChild>
                <Button 
                    variant="outline" 
                    role="combobox" 
                    className="w-full justify-between"
                    disabled={disabled}
                >
                    {/* âœ… Utilitzem 'nom' (el camp real) */}
                    {selectedContact ? selectedContact.nom : t('selectContactPlaceholder')}
                    <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                </Button>
            </PopoverTrigger>
            <PopoverContent className="w-[--radix-popover-trigger-width] p-0">
                <Command>
                    <CommandInput placeholder={t('searchContactPlaceholder')} />
                    <CommandList>
                        <CommandEmpty>{t('noContactFound')}</CommandEmpty>
                        <CommandGroup>
                            <CommandItem onSelect={() => {
                                onSelect(null);
                                setOpen(false);
                            }}>
                                <Check className={cn("mr-2 h-4 w-4", selectedId === null ? "opacity-100" : "opacity-0")} />
                                {t('noContact')}
                            </CommandItem>
                            {/* âœ… AixÃ² funcionarÃ  quan 'contacts' no estigui buit */}
                            {contacts.map(contact => (
                                <CommandItem 
                                    key={contact.id} 
                                    value={contact.nom || ''} // El valor de cerca Ã©s 'nom'
                                    onSelect={() => {
                                        onSelect(contact.id);
                                        setOpen(false);
                                    }}
                                >
                                    <Check className={cn("mr-2 h-4 w-4", selectedId === contact.id ? "opacity-100" : "opacity-0")} />
                                    {contact.nom}
                                </CommandItem>
                            ))}
                        </CommandGroup>
                    </CommandList>
                </Command>
            </PopoverContent>
        </Popover>
    );
};

// =================== FILE: src/components/features/EditorWysiwyg/EditorToolbar.tsx ===================

'use client';

import { Editor } from '@tiptap/react';

// Imports de shadcn/ui
import { Tooltip, TooltipContent, TooltipTrigger } from '@/components/ui/tooltip';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger, 
} from '@/components/ui/dropdown-menu';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';

// Imports d'icones de Lucide React (netejats)
import {
  Bold,
  Italic,
  Underline as UnderlineIcon,
  Strikethrough,
  List,
  ListOrdered,
  AlignLeft,
  AlignCenter,
  AlignRight,
  Link as LinkIcon,
  Image as ImageIcon,
  Undo,
  Redo,
  CaseSensitive,
  Type,
  Palette,
  CheckSquare,
  Highlighter,
  Loader2,
} from 'lucide-react';

interface EditorToolbarProps {
  editor: Editor;
  isUploading: boolean;
  addImage: () => void;
  setLink: () => void;
}

export function EditorToolbar({ editor, isUploading, addImage, setLink }: EditorToolbarProps) {
  return (
    <div className="flex-shrink-0 flex flex-wrap items-center gap-1 px-2 py-2 border-b border-input sticky top-0 z-10 bg-background">
      {/* SECCIÃ“ DE FORMAT ELIMINADA */}

      {/* Formats BÃ sics */}
      <Tooltip>
        <TooltipTrigger asChild>
          <Button
            type="button"
            variant="ghost"
            size="icon"
            onClick={() => editor.chain().focus().toggleBold().run()}
            className={
              editor.isActive('bold')
                ? 'bg-accent text-accent-foreground'
                : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground'
            }
          >
            <Bold className="w-4 h-4" />
          </Button>
        </TooltipTrigger>
        <TooltipContent>
          <p>Negreta</p>
        </TooltipContent>
      </Tooltip>
      {/* ... (Resta de botons: Cursiva, Subratllat, Ratllat) ... */}
       <Tooltip>
         <TooltipTrigger asChild>
           <Button
             type="button"
             variant="ghost"
             size="icon"
             onClick={() => editor.chain().focus().toggleItalic().run()}
             className={
               editor.isActive('italic')
                 ? 'bg-accent text-accent-foreground'
                 : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground'
             }
           >
             <Italic className="w-4 h-4" />
           </Button>
         </TooltipTrigger>
         <TooltipContent>
           <p>Cursiva</p>
         </TooltipContent>
       </Tooltip>
       <Tooltip>
         <TooltipTrigger asChild>
           <Button
             type="button"
             variant="ghost"
             size="icon"
             onClick={() => editor.chain().focus().toggleUnderline().run()}
             className={
               editor.isActive('underline')
                 ? 'bg-accent text-accent-foreground'
                 : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground'
             }
           >
             <UnderlineIcon className="w-4 h-4" />
           </Button>
         </TooltipTrigger>
         <TooltipContent>
           <p>Subratllat</p>
         </TooltipContent>
       </Tooltip>
       <Tooltip>
         <TooltipTrigger asChild>
           <Button
             type="button"
             variant="ghost"
             size="icon"
             onClick={() => editor.chain().focus().toggleStrike().run()}
             className={
               editor.isActive('strike')
                 ? 'bg-accent text-accent-foreground'
                 : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground'
             }
           >
             <Strikethrough className="w-4 h-4" />
           </Button>
         </TooltipTrigger>
         <TooltipContent>
           <p>Ratllat</p>
         </TooltipContent>
       </Tooltip>

      {/* BotÃ³ de Ressaltar CORREGIT */}
      <Tooltip>
        <TooltipTrigger asChild>
          <Button
            type="button"
            variant="ghost"
            size="icon"
            
            // âœ… CANVI: LÃ²gica 'toggle' corregida
            onClick={() => {
              // Comprovem si 'highlight' (qualsevol) estÃ  actiu
              if (editor.isActive('highlight')) {
                // Si estÃ  actiu, el treiem
                editor.chain().focus().unsetHighlight().run();
              } else {
                // Si no, posem el color groc
                editor.chain().focus().setHighlight({ color: '#FBBF24' }).run();
              }
            }}

            // âœ… CANVI: ComprovaciÃ³ 'isActive' corregida
            className={
              editor.isActive('highlight') // Comprova si 'highlight' (qualsevol) estÃ  actiu
                ? 'bg-accent text-accent-foreground'
                : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground'
            }
          >
            <Highlighter className="w-4 h-4" />
          </Button>
        </TooltipTrigger>
        <TooltipContent>
          <p>Ressaltar</p>
        </TooltipContent>
      </Tooltip>


      <div className="w-px h-6 bg-input mx-1"></div>

      {/* Mida de Text */}
      <DropdownMenu>
        <Tooltip>
          <DropdownMenuTrigger asChild>
            <Button type="button" variant="ghost" size="icon">
              <CaseSensitive className="w-4 h-4" />
            </Button>
          </DropdownMenuTrigger>
          <TooltipContent>
            <p>Mida de Text</p>
          </TooltipContent>
        </Tooltip>
        <DropdownMenuContent>
          {['12px', '14px', '16px', '18px', '24px'].map((size) => (
            <DropdownMenuItem
              key={size} 
              style={{ fontSize: size }}
              onClick={() => editor.chain().focus().setMark('textStyle', { fontSize: size }).run()}
              className={editor.isActive('textStyle', { fontSize: size }) ? 'bg-accent' : ''}
            >
              {size}
            </DropdownMenuItem>
          ))}
          <DropdownMenuSeparator />
          <DropdownMenuItem
            onClick={() => editor.chain().focus().unsetMark('textStyle').run()}
          >
            Reset
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>

      {/* FamÃ­lia de Font */}
      <DropdownMenu>
        <Tooltip>
          <DropdownMenuTrigger asChild>
            <Button type="button" variant="ghost" size="icon">
              <Type className="w-4 h-4" />
            </Button>
          </DropdownMenuTrigger>
          <TooltipContent>
            <p>Font</p>
          </TooltipContent>
        </Tooltip>
        <DropdownMenuContent>
          {['Inter', 'Arial', 'Georgia', 'monospace', 'serif'].map((font) => (
            <DropdownMenuItem
              key={font}
              style={{ fontFamily: font }}
              onClick={() => editor.chain().focus().setFontFamily(font).run()}
              className={editor.isActive('textStyle', { fontFamily: font }) ? 'bg-accent' : ''}
            >
              {font}
            </DropdownMenuItem>
          ))}
          <DropdownMenuSeparator />
          <DropdownMenuItem onClick={() => editor.chain().focus().unsetFontFamily().run()}>
            Reset
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>

      {/* ... (Resta del codi: Color, Llistes, AlineaciÃ³, etc.) ... */}
      
      {/* Color de Text */}
      <Tooltip>
         <TooltipTrigger asChild>
           <Button type="button" variant="ghost" size="icon" asChild>
             <label className="cursor-pointer">
               <Palette
                 className="w-4 h-4"
                 style={{ color: editor.getAttributes('textStyle').color || 'inherit' }}
               />
               <Input
                 type="color"
                 className="sr-only"
                 value={editor.getAttributes('textStyle').color || '#000000'}
                 onInput={(e) => editor.chain().focus().setColor((e.target as HTMLInputElement).value).run()}
               />
             </label>
           </Button>
         </TooltipTrigger>
         <TooltipContent>
           <p>Color de Text</p>
         </TooltipContent>
       </Tooltip>
 
       <div className="w-px h-6 bg-input mx-1"></div>
 
       {/* Llistes i blocs */}
       <Tooltip>
         <TooltipTrigger asChild>
           <Button
             type="button"
             variant="ghost"
             size="icon"
             onClick={() => editor.chain().focus().toggleBulletList().run()}
             className={
               editor.isActive('bulletList')
                 ? 'bg-accent text-accent-foreground'
                 : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground'
             }
           >
             <List className="w-4 h-4" />
           </Button>
         </TooltipTrigger>
         <TooltipContent>
           <p>Llista</p>
         </TooltipContent>
       </Tooltip>
       <Tooltip>
         <TooltipTrigger asChild>
           <Button
             type="button"
             variant="ghost"
             size="icon"
             onClick={() => editor.chain().focus().toggleOrderedList().run()}
             className={
               editor.isActive('orderedList')
                 ? 'bg-accent text-accent-foreground'
                 : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground'
             }
           >
             <ListOrdered className="w-4 h-4" />
           </Button>
         </TooltipTrigger>
         <TooltipContent>
           <p>Llista ordenada</p>
         </TooltipContent>
       </Tooltip>
       <Tooltip>
         <TooltipTrigger asChild>
           <Button
             type="button"
             variant="ghost"
             size="icon"
             onClick={() => editor.chain().focus().toggleTaskList().run()}
             className={
               editor.isActive('taskList')
                 ? 'bg-accent text-accent-foreground'
                 : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground'
             }
           >
             <CheckSquare className="w-4 h-4" />
           </Button>
         </TooltipTrigger>
         <TooltipContent>
           <p>Llista de tasques</p>
         </TooltipContent>
       </Tooltip>
 
       <div className="w-px h-6 bg-input mx-1"></div>
 
       {/* AlineaciÃ³, Insercions, Historial... */}
       <Tooltip>
         <TooltipTrigger asChild>
           <Button
             type="button"
             variant="ghost"
             size="icon"
             onClick={() => editor.chain().focus().setTextAlign('left').run()}
             className={
               editor.isActive({ textAlign: 'left' })
                 ? 'bg-accent text-accent-foreground'
                 : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground'
             }
           >
             <AlignLeft className="w-4 h-4" />
           </Button>
         </TooltipTrigger>
         <TooltipContent>
           <p>Alinear a l'esquerra</p>
         </TooltipContent>
       </Tooltip>
       <Tooltip>
         <TooltipTrigger asChild>
           <Button
             type="button"
             variant="ghost"
             size="icon"
             onClick={() => editor.chain().focus().setTextAlign('center').run()}
             className={
               editor.isActive({ textAlign: 'center' })
                 ? 'bg-accent text-accent-foreground'
                 : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground'
             }
           >
             <AlignCenter className="w-4 h-4" />
           </Button>
         </TooltipTrigger>
         <TooltipContent>
           <p>Centrar</p>
         </TooltipContent>
       </Tooltip>
       <Tooltip>
         <TooltipTrigger asChild>
           <Button
             type="button"
             variant="ghost"
             size="icon"
             onClick={() => editor.chain().focus().setTextAlign('right').run()}
             className={
               editor.isActive({ textAlign: 'right' })
                 ? 'bg-accent text-accent-foreground'
                 : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground'
             }
           >
             <AlignRight className="w-4 h-4" />
           </Button>
         </TooltipTrigger>
         <TooltipContent>
           <p>Alinear a la dreta</p>
         </TooltipContent>
       </Tooltip>
       <div className="w-px h-6 bg-input mx-1"></div>
       <Tooltip>
         <TooltipTrigger asChild>
           <Button
             type="button"
             variant="ghost"
             size="icon"
             onClick={setLink}
             className={
               editor.isActive('link')
                 ? 'bg-accent text-accent-foreground'
                 : 'text-muted-foreground hover:bg-accent hover:text-accent-foreground'
             }
           >
             <LinkIcon className="w-4 h-4" />
           </Button>
         </TooltipTrigger>
         <TooltipContent>
           <p>Afegir EnllaÃ§</p>
         </TooltipContent>
       </Tooltip>
 
       {/* BotÃ³ d'imatge amb estat de cÃ rrega */}
       <Tooltip>
         <TooltipTrigger asChild>
           <Button
             type="button"
             variant="ghost"
             size="icon"
             onClick={addImage}
             disabled={isUploading}
             className="text-muted-foreground hover:bg-accent hover:text-accent-foreground"
           >
             {isUploading ? (
               <Loader2 className="w-4 h-4 animate-spin" />
             ) : (
               <ImageIcon className="w-4 h-4" />
             )}
           </Button>
         </TooltipTrigger>
         <TooltipContent>
           <p>Afegir Imatge</p>
         </TooltipContent>
       </Tooltip>
 
       <div className="w-px h-6 bg-input mx-1"></div>
       <Tooltip>
         <TooltipTrigger asChild>
           <Button
             type="button"
             variant="ghost"
             size="icon"
             onClick={() => editor.chain().focus().undo().run()}
             disabled={!editor.can().undo()}
             className="text-muted-foreground hover:bg-accent hover:text-accent-foreground"
           >
             <Undo className="w-4 h-4" />
           </Button>
         </TooltipTrigger>
         <TooltipContent>
           <p>Desfer</p>
         </TooltipContent>
       </Tooltip>
       <Tooltip>
         <TooltipTrigger asChild>
           <Button
             type="button"
             variant="ghost"
             size="icon"
             onClick={() => editor.chain().focus().redo().run()}
             disabled={!editor.can().redo()}
             className="text-muted-foreground hover:bg-accent hover:text-accent-foreground"
           >
             <Redo className="w-4 h-4" />
           </Button>
         </TooltipTrigger>
         <TooltipContent>
           <p>Refer</p>
         </TooltipContent>
       </Tooltip>
    </div>
  );
}

// =================== FILE: src/components/features/EditorWysiwyg/EditorWysiwyg.tsx ===================

'use client';

import { useCallback, useRef, ChangeEvent, useTransition, useEffect } from 'react';
import { TooltipProvider } from '@/components/ui/tooltip';
// Importem 'Editor' i 'JSONContent' per al tipat
import { useEditor, EditorContent, JSONContent} from '@tiptap/react';
// Importem 'EditorProps' per al tipat de 'handlePaste'
import { type EditorProps } from '@tiptap/pm/view';
// Assegura't que aquestes rutes siguin correctes
import { defaultExtensions } from './tiptapExtensions';
import { EditorToolbar } from './EditorToolbar';
import { cn } from '@/lib/utils/utils';
// ğŸ‘‡ Verifica que aquesta ruta sigui correcta per al teu projecte
import { uploadTaskImageAction } from '@/app/actions/tasks/actions';
import { toast } from 'sonner';

interface EditorWysiwygProps {
    id: string;
    name: string;
    defaultValue?: string;
    onChange?: (html: string, json: JSONContent) => void;
    className?: string;
    minHeight?: string;
    maxHeight?: string;
}

export default function EditorWysiwyg({
    id,
    name,
    defaultValue = '',
    onChange,
    className,
    minHeight = '150px', // Valor per defecte
    maxHeight = 'none', // Valor per defecte
}: EditorWysiwygProps) {
    const [isPending, startTransition] = useTransition();
    const fileInputRef = useRef<HTMLInputElement>(null);

    const editor = useEditor({
        immediatelyRender: false,
        extensions: defaultExtensions,
        content: defaultValue,
        editorProps: {
            attributes: {
                class: cn(
                    'prose dark:prose-invert prose-sm sm:prose-base fossssssss:outline-none max-w-none w-full',
                ),
                style: `min-height: ${minHeight};`, // Estil inline per minHeight
                id: `editor-${id}`,
            },
        },
        onUpdate: ({ editor }) => {
            if (onChange) {
                onChange(editor.getHTML(), editor.getJSON());
            }
        },
    });

    // --- LÃ’GICA PER INJECTAR EL 'handlePaste' DE FORMA SEGURA ---
    useEffect(() => {
        if (!editor) {
            return;
        }

        /**
         * Definim la lÃ²gica de 'handlePaste' aquÃ­.
         * GrÃ cies al 'closure', tenim accÃ©s directe a la variable 'editor'
         * del hook 'useEditor' de forma totalment segura (type-safe).
         */
        const handlePasteCallback: EditorProps['handlePaste'] = (view, event) => {
            // No cal (view as any).editor, fem servir 'editor' directament.
            if (!editor.isActive('taskList')) {
                return false; // Comportament per defecte
            }

            const pastedText = event.clipboardData?.getData('text/plain');

            if (!pastedText || !pastedText.includes('\n')) {
                return false; // Comportament per defecte
            }

            // *** INICI DE LA LÃ’GICA PERSONALITZADA ***
            event.preventDefault();

            const lines = pastedText
                .split('\n')
                .filter((line) => line.trim().length > 0);

            if (lines.length === 0) {
                return true; // Hem gestionat l'esdeveniment
            }

            const { $from } = editor.state.selection;
            const currentNode = $from.node($from.depth);
            const isCurrentTaskEmpty = currentNode.textContent.trim().length === 0;

            let chain = editor.chain().focus();

            if (isCurrentTaskEmpty) {
                const [firstLine, ...otherLines] = lines;
                chain.insertContent(firstLine);
                for (const line of otherLines) {
                    chain = chain.splitListItem('taskItem').insertContent(line);
                }
            } else {
                for (const line of lines) {
                    chain = chain.splitListItem('taskItem').insertContent(line);
                }
            }

            chain.run();
            return true;
        };

        // Actualitzem les editorProps de l'editor ja inicialitzat
        editor.setOptions({
            editorProps: {
                ...editor.options.editorProps, // Preservem les props existents (ex: attributes)
                handlePaste: handlePasteCallback, // Afegim la nostra lÃ²gica
            },
        });
    }, [editor]); // El array de dependÃ¨ncies [editor] assegura que s'executi un sol cop

    // --- FI DE LA LÃ’GICA DEL 'handlePaste' ---

    const setLink = useCallback(() => {
        if (!editor) return;
        const previousUrl = editor.getAttributes('link').href;
        const url = window.prompt('Introdueix la URL', previousUrl || '');
        if (url === null) return;
        if (url === '') {
            editor.chain().focus().extendMarkRange('link').unsetLink().run();
            return;
        }
        editor.chain().focus().extendMarkRange('link').setLink({ href: url, target: '_blank' }).run();
    }, [editor]);

    const addImage = useCallback(() => {
        if (isPending) return;
        fileInputRef.current?.click();
    }, [isPending]);

    const handleImageUpload = useCallback(
        async (event: ChangeEvent<HTMLInputElement>) => {
            if (!editor || isPending || !event.target.files || event.target.files.length === 0) return;

            const file = event.target.files[0];
            if (file.size > 5 * 1024 * 1024) {
                toast.error("Imatge massa gran", { description: "La mida mÃ xima Ã©s 5MB." });
                if (fileInputRef.current) fileInputRef.current.value = '';
                return;
            }
            if (!file.type.startsWith('image/')) {
                toast.error("Format no permÃ¨s", { description: "NomÃ©s imatges." });
                if (fileInputRef.current) fileInputRef.current.value = '';
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            startTransition(async () => {
                let loadingToastId: string | number | undefined;
                try {
                    console.log("[Client] Cridant Server Action 'uploadTaskImageAction'...");
                    loadingToastId = toast.loading("Pujant imatge...");

                    const result = await uploadTaskImageAction(formData);

                    toast.dismiss(loadingToastId);

                    // âŒ EL TEU CODI ACTUAL (INCORRECTE)
                    // EstÃ  desant la URL temporal
                    /*
                    if (result.success && result.data?.signedUrl) {
                        console.log("[Client] Ãˆxit! Inserint imatge.");
                        editor.chain().focus().setImage({
                            src: result.data.signedUrl, // <-- PROBLEMA: AixÃ² caduca
                            alt: file.name
                        }).run();
                        toast.success("Imatge inserida.");
                    } else {
                        // ...
                    }
                    */

                    // âœ… LA SOLUCIÃ“ (CORRECTA)
                    // Desa el 'filePath' permanent
                    // âœ… LÃ’GICA CORREGIDA (fem servir la 'signedUrl' per a la preview)
                    if (result.success && result.data?.signedUrl) {
                        console.log("[Client] Ãˆxit! Inserint 'signedUrl' per a la PREVIEW.");
                        editor.chain().focus().setImage({
                            src: result.data.signedUrl, // <-- AixÃ² es pot previsualitzar
                            alt: file.name
                        }).run();
                        toast.success("Imatge inserida.");
                    } else {
                        console.error("[Client] Error SA:", result.message);
                        toast.error("Error en pujar", { description: result.message || "Problema al servidor." });
                    }
                } catch (error) {
                    if (loadingToastId) toast.dismiss(loadingToastId);
                    console.error('[Client] Error inesperat:', error);
                    toast.error("Error de connexiÃ³", { description: "No s'ha pogut contactar amb el servidor." });
                } finally {
                    if (fileInputRef.current) fileInputRef.current.value = '';
                }
            });
        },
        [editor, startTransition, isPending]
    );

    // SincronitzaciÃ³ del 'defaultValue' si canvia des de fora
    useEffect(() => {
        if (editor && !editor.isFocused) {
            const isSame = editor.getHTML() === defaultValue;
            if (!isSame) {
                // ğŸ‘‡ LÃNIA CORREGIDA:
                // Passem un objecte d'opcions en lloc d'un booleÃ .
                editor.commands.setContent(defaultValue, { emitUpdate: false });
            }
        }
    }, [defaultValue, editor]);

    if (!editor) return null;

    return (
        <TooltipProvider delayDuration={100}>
            <div className={cn('w-full rounded-md border border-input bg-background shadow-sm flex flex-col', className)}>
                <EditorToolbar
                    editor={editor}
                    isUploading={isPending}
                    addImage={addImage}
                    setLink={setLink}
                />
                <div className="flex-1 min-h-0 relative">
                    <div
                        className="overflow-y-auto p-4 border-t border-input"
                        style={{ maxHeight: maxHeight !== 'none' ? maxHeight : undefined }}
                    >
                        <EditorContent editor={editor} />
                    </div>
                    <input
                        type="file"
                        accept="image/*"
                        ref={fileInputRef}
                        onChange={handleImageUpload}
                        className="hidden"
                        disabled={isPending}
                    />
                    <textarea
                        id={id}
                        name={name}
                        value={editor.getHTML()}
                        className="hidden"
                        readOnly
                        aria-hidden="true"
                    />
                </div>
            </div>
        </TooltipProvider>
    );
}

// =================== FILE: src/components/features/EditorWysiwyg/index.ts ===================

export * from './EditorWysiwyg';

// =================== FILE: src/components/features/EditorWysiwyg/tiptapExtensions.ts ===================

// Imports de TipTap Extensions
import StarterKit from '@tiptap/starter-kit';
import { Underline } from '@tiptap/extension-underline';
import { Highlight } from '@tiptap/extension-highlight';
import { Subscript } from '@tiptap/extension-subscript';
import { Superscript } from '@tiptap/extension-superscript';
import { TextStyle } from '@tiptap/extension-text-style';
import { FontFamily } from '@tiptap/extension-font-family';
import { Color } from '@tiptap/extension-color';
import { TextAlign } from '@tiptap/extension-text-align';
import { Link } from '@tiptap/extension-link';
import { Image } from '@tiptap/extension-image';
import { Youtube } from '@tiptap/extension-youtube';
import { Table } from '@tiptap/extension-table';
import { TableCell } from '@tiptap/extension-table-cell';
import { TableHeader } from '@tiptap/extension-table-header';
import { TableRow } from '@tiptap/extension-table-row';
import { TaskList } from '@tiptap/extension-task-list';
import { TaskItem } from '@tiptap/extension-task-item';

// âœ… PAS 1: Importar les extensions de llista que falten
import { BulletList } from '@tiptap/extension-bullet-list';
import { OrderedList } from '@tiptap/extension-ordered-list';
import { ListItem } from '@tiptap/extension-list-item';

// DefiniciÃ³ de l'extensiÃ³ custom
export const FontSizeTextStyle = TextStyle.extend({
  addAttributes() {
    return {
      ...this.parent?.(),
      fontSize: {
        default: null,
        parseHTML: (el) => el.style.fontSize,
        renderHTML: (attrs) => (attrs.fontSize ? { style: `font-size: ${attrs.fontSize}` } : {}),
      },
    };
  },
});

// Llista d'extensions exportada
export const defaultExtensions = [
  // âœ… PAS 2: Desactivem les llistes del StarterKit per evitar conflictes
  StarterKit.configure({
    heading: { levels: [1, 2, 3] },
    bulletList: false,  // Desactivat
    orderedList: false, // Desactivat
    listItem: false,    // Desactivat
  }),
  Underline,
  Highlight,
  Subscript,
  Superscript,
  TextStyle,
  FontSizeTextStyle, 
  Color,
  FontFamily,
  TextAlign.configure({ types: ['heading', 'paragraph'] }),
  Link.configure({ openOnClick: false }),
  Image,
  Youtube,
  Table.configure({ resizable: true }),
  TableRow,
  TableHeader,
  TableCell,
  TaskList, // La teva llista de tasques (que funciona)
  TaskItem.configure({
    nested: true,
  }),
  
  // âœ… PAS 3: Afegim les llistes manualment
  ListItem,
  BulletList,
  OrderedList,
];

// =================== FILE: src/components/features/tasks/hooks/useTaskForm.ts ===================

// src/components/features/tasks/useTaskForm.ts (COMPLET I CORREGIT)
'use client';

import { useState, useTransition, FormEvent, useEffect, useCallback } from 'react';
import { createTask, updateTask } from '@/app/actions/tasks/actions';
import { EnrichedTask } from '../TaskDialogManager';
import { toast } from 'sonner';
import { JSONContent } from '@tiptap/react';
import { format } from 'date-fns';

// Definim les props que el hook necessita del seu component pare
interface UseTaskFormProps {
  task: EnrichedTask | null;
  onTaskMutationSuccess: () => void;
  initialDate?: Date;
}

export function useTaskForm({
  task,
  onTaskMutationSuccess,
  initialDate,
}: UseTaskFormProps) {
  const [isPending, startTransition] = useTransition();
  const isEditing = !!task;

  // âœ… --- INICI DE LA MODIFICACIÃ“ ---
  // Aquesta Ã©s ara la nostra Ãºnica font de veritat per inicialitzar l'estat.
  // S'executa NOMÃ‰S UN COP quan el hook es munta,
  // o quan les dependÃ¨ncies del 'useEffect' canvien.
  const getInitialDueDate = () => {
    // 1. Si Ã©s mode 'creaciÃ³' (no hi ha tasca) i rebem 'initialDate'
    if (!task && initialDate) {
      return initialDate;
    }
    // 2. Si Ã©s mode 'ediciÃ³' (hi ha tasca)
    if (task?.due_date) {
      return new Date(task.due_date);
    }
    // 3. Altrament (mode creaciÃ³ sense data)
    return undefined;
  };

  const getInitialDescriptionJson = () => {
    try {
      if (task?.description_json) {
        return typeof task.description_json === 'string'
          ? JSON.parse(task.description_json)
          : (task.description_json as JSONContent);
      }
      return null;
    } catch {
      return null;
    }
  };

  // --- Estats Locals del Formulari ---
  // Inicialitzem l'estat directament.
  const [dueDate, setDueDate] = useState<Date | undefined>(getInitialDueDate());
  const [selectedContactId, setSelectedContactId] = useState<string | null>(task?.contact_id?.toString() ?? null);
  const [assignedUserId, setAssignedUserId] = useState<string | null>(task?.user_asign_id ?? null);
  const [descriptionContent, setDescriptionContent] = useState<string>(task?.description ?? '');
  const [descriptionJson, setDescriptionJson] = useState<JSONContent | null>(getInitialDescriptionJson());

  const [contactComboboxOpen, setContactComboboxOpen] = useState(false);
  const [teamMemberComboboxOpen, setTeamMemberComboboxOpen] = useState(false);

  // --- Efecte per sincronitzar si la tasca canvia (ex: obrir un altre diÃ leg) ---
  useEffect(() => {
    // Quan 'task' o 'initialDate' canvien, reiniciem TOT l'estat del formulari.
    console.log("[useTaskForm] useEffect re-sincronitzant valors", { task, initialDate });
    setDueDate(getInitialDueDate());
    setSelectedContactId(task?.contact_id?.toString() ?? null);
    setAssignedUserId(task?.user_asign_id ?? null);
    setDescriptionContent(task?.description ?? '');
    setDescriptionJson(getInitialDescriptionJson());

    // Hem eliminat 'getInitialDate' de les dependÃ¨ncies per trencar el bucle.
    // La lÃ²gica ja Ã©s a 'getInitialDueDate()' a dins.
  }, [task, initialDate]);
  // âœ… --- FI DE LA MODIFICACIACIÃ“ ---

  // --- Gestor d'Enviament (Server Action) ---
  const handleSubmit = async (event: FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    const formData = new FormData(event.currentTarget);

    // Injectem valors controlats
    formData.set('description', descriptionContent);
    formData.set('description_json', JSON.stringify(descriptionJson));
    formData.set('due_date', dueDate ? dueDate.toISOString() : '');
    formData.set('contact_id', selectedContactId ?? 'none');
    formData.set('user_asign_id', assignedUserId ?? 'none');
    
    if (task) {
      formData.set('taskId', task.id.toString());
    }

    const action = task ? updateTask : createTask;

    startTransition(async () => {
      const result = await action({}, formData);

      if (result.error) {
        let errorDesc = 'Hi ha hagut un error.';
        if (typeof result.error === 'string') { errorDesc = result.error; }
        else if (typeof result.error === 'object') { 
          errorDesc = Object.entries(result.error)
            .map(([field, messages]) => `${field}: ${Array.isArray(messages) ? messages.join(', ') : messages}`)
            .join('\n'); 
        }
        toast.error('Error al guardar', { description: errorDesc });
      } else if (result.success) {
        toast.success(task ? 'Tasca actualitzada!' : 'Tasca creada!');
        onTaskMutationSuccess();
      }
    });
  };

  // --- Valors inicials per a camps no controlats ---
  const initialValues = {
    title: task?.title ?? '',
    priority: task?.priority ?? 'Mitjana',
    duration: task?.duration ?? '',
    departmentId: task?.department_id?.toString() ?? 'none',
    assignmentDate: task?.asigned_date ? format(new Date(task.asigned_date), "dd/MM/yyyy") : '-',
  };

  // Retornem l'estat i els gestors
  return {
    isPending,
    isEditing,
    handleSubmit,
    initialValues,
    state: {
      dueDate,
      selectedContactId,
      assignedUserId,
      descriptionContent,
      descriptionJson,
      contactComboboxOpen,
      teamMemberComboboxOpen,
    },
    handlers: {
      setDueDate,
      setSelectedContactId,
      setAssignedUserId,
      setDescriptionContent,
      setDescriptionJson,
      setContactComboboxOpen,
      setTeamMemberComboboxOpen,
    },
  };
}

// =================== FILE: src/components/features/tasks/TaskDetailView.tsx ===================

'use client';

import { useState, useEffect, useCallback, useTransition } from 'react'; // âœ… NOU: Importem useTransition
import { EnrichedTask } from './TaskDialogManager';
import { DialogHeader, DialogTitle, DialogFooter } from "@/components/ui/dialog";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Checkbox } from '@/components/ui/checkbox';
import { Switch } from '@/components/ui/switch';
import { Label } from '@/components/ui/label';
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from "@/components/ui/alert-dialog";
import { cn } from "@/lib/utils/utils";
import { format } from "date-fns";
import { es } from "date-fns/locale";
// âœ… NOU: Importem 'Loader2' i 'Send' (per a Google)
import { Calendar, Flag, User, CheckCircle2, Trash2, RotateCcw, Pencil, Building, Clock, Loader2, RefreshCw } from "lucide-react";
import { useTranslations } from "next-intl";
// âœ… NOU: Importem la nova acciÃ³
import { deleteTask, updateSimpleTask, setTaskActiveStatus, getSignedUrlForFile, syncTaskToGoogleAction } from '@/app/actions/tasks/actions';
import { toast } from 'sonner';
import { priorityStyles, TaskPriority } from '@/config/styles/task';
import parse, { domToReact, Element, DOMNode } from 'html-react-parser';
import { Tables, Json } from '@/types/supabase';
import { Skeleton } from '@/components/ui/skeleton';

type LogEntry = { timestamp: string; action: 'actiu' | 'inactiu'; user_id: string; status?: 'active' | 'inactive' };

function PrivateImage({ src, alt }: { src: string; alt: string }) {
    const [imageUrl, setImageUrl] = useState<string | null>(null);

    useEffect(() => {
        // NomÃ©s actuem si el 'src' Ã©s un filePath (no una URL http)
        if (src && !src.startsWith('http')) {
            const fetchUrl = async () => {
                const result = await getSignedUrlForFile(src); // Crida a la Server Action
                if (result.success && result.data) {
                    setImageUrl(result.data);
                }
            };
            fetchUrl();
        }
    }, [src]);

    if (!imageUrl) {
        return <Skeleton className="w-full h-32 rounded-md my-2" />;
    }

    return <img src={imageUrl} alt={alt} className="rounded-md" />;
}
function countCheckboxesFromHtml(html: string): { total: number; completed: number } {
    if (!html) return { total: 0, completed: 0 };
    try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const taskItems = doc.querySelectorAll('li[data-type="taskItem"]');
        const total = taskItems.length;
        let completed = 0;
        taskItems.forEach(item => {
            if (item.getAttribute('data-checked') === 'true') {
                completed++;
            }
        });
        return { total, completed };
    } catch (error) {
        console.error("Error counting checkboxes from HTML:", error);
        return { total: 0, completed: 0 }; // Retorna 0 en cas d'error
    }
}
// --- HOOK PER AL CRONÃ’METRE EN TEMPS REAL ---
const useDialogTaskTimer = (
    isTaskActive: boolean, // âœ… [MODIFICAT] Abans: task: EnrichedTask
    localLog: LogEntry[] | null
) => {
    const [liveTime, setLiveTime] = useState("00:00:00");

    useEffect(() => {
        let intervalId: NodeJS.Timeout | null = null;

        const calculateTotalTime = () => {
            if (!localLog || !Array.isArray(localLog)) return 0;

            let totalMs = 0;
            let startTime: number | null = null;

            const sortedLog = [...localLog].sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime());

            for (const entry of sortedLog) {
                if ((entry.action === 'actiu' || entry.status === 'active') && startTime === null) {
                    startTime = new Date(entry.timestamp).getTime();
                } else if ((entry.action === 'inactiu' || entry.status === 'inactive') && startTime !== null) {
                    totalMs += (new Date(entry.timestamp).getTime() - startTime);
                    startTime = null;
                }
            }

            // Si la tasca encara estÃ  activa, afegim el temps des de l'Ãºltim 'actiu' fins ara
            if (isTaskActive && startTime !== null) {
                totalMs += (new Date().getTime() - startTime);
            }
            return totalMs;
        };

        const updateTimer = () => {
            const totalMs = calculateTotalTime();
            const totalSeconds = Math.floor(totalMs / 1000);
            const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const s = String(totalSeconds % 60).padStart(2, '0');
            setLiveTime(`${h}:${m}:${s}`);
        };

        updateTimer(); // CÃ lcul inicial

        if (isTaskActive) {
            intervalId = setInterval(updateTimer, 1000);
        }

        return () => {
            if (intervalId) clearInterval(intervalId);
        };
    }, [isTaskActive, localLog]);

    return liveTime;
};


function DetailItem({ icon: Icon, label, children }: { icon: React.ElementType, label: string, children: React.ReactNode }) {
    if (!children) return null;
    return (
        <div className="flex items-start gap-3">
            <Icon className="w-5 h-5 text-muted-foreground mt-0.5 flex-shrink-0" />
            <div className="flex flex-col">
                <span className="text-sm text-muted-foreground">{label}</span>
                <span className="font-semibold">{children}</span>
            </div>
        </div>
    );
}

interface TaskDetailViewProps {
    task: EnrichedTask;
    onSetEditMode: () => void;
    onTaskMutation: (options?: { closeDialog?: boolean }) => void;
    onClose: () => void;
}

export function TaskDetailView({ task, onSetEditMode, onTaskMutation, onClose }: TaskDetailViewProps) {
    const t = useTranslations('DashboardClient.taskActions');
    const t2 = useTranslations('DashboardClient.taskDetails');

    // âœ… NOU: 'useTransition' per a la sincronitzaciÃ³
    const [isSyncing, startSyncTransition] = useTransition();

    const [isActive, setIsActive] = useState(task.is_active || false);
    const [localLog, setLocalLog] = useState(task.time_tracking_log as LogEntry[] | null);
    const [currentDescription, setCurrentDescription] = useState(task.description || '');

    const liveTimeDisplay = useDialogTaskTimer(isActive, localLog);
    const isSynced = !!task.google_calendar_id;
    useEffect(() => {
        setIsActive(task.is_active || false);
        setLocalLog(task.time_tracking_log as LogEntry[] | null);
        setCurrentDescription(task.description || '');
    }, [task]);

    const handleToggleActive = async (newCheckedState: boolean) => {
        const previousState = isActive;
        setIsActive(newCheckedState);

        const previousLog = localLog;
        const newLogEntry: LogEntry = {
            timestamp: new Date().toISOString(),
            action: newCheckedState ? 'actiu' : 'inactiu',
            user_id: 'optimistic_placeholder'
        };
        setLocalLog([...(localLog || []), newLogEntry]);

        const { error } = await setTaskActiveStatus(task.id, newCheckedState);

        if (error) {
            setIsActive(previousState);
            setLocalLog(previousLog);
            toast.error("No s'ha pogut actualitzar l'estat.", { description: "Si us plau, intenta-ho de nou." });
        } else {
            toast.success(newCheckedState ? "Tasca activada." : "Tasca desactivada.");
            onTaskMutation({ closeDialog: false });
        }
    };

    const handleToggleTaskItem = useCallback(async (itemIndex: number) => {
        if (!currentDescription) return;

        const parser = new DOMParser();
        const doc = parser.parseFromString(currentDescription, 'text/html');
        const taskItems = doc.querySelectorAll('li[data-type="taskItem"]');

        if (itemIndex < taskItems.length) {
            const item = taskItems[itemIndex];
            const isChecked = item.getAttribute('data-checked') === 'true';
            item.setAttribute('data-checked', isChecked ? 'false' : 'true');

            const newHtml = doc.body.innerHTML;
            setCurrentDescription(newHtml); // ActualitzaciÃ³ visual optimista

            const newProgress = countCheckboxesFromHtml(newHtml);

            const updateData: Partial<Tables<'tasks'>> = {
                description: newHtml,
                checklist_progress: newProgress as unknown as Json
            };

            const { error } = await updateSimpleTask(task.id, updateData);

            if (error) {
                toast.error("No s'ha pogut actualitzar la llista de tasques.");
                setCurrentDescription(task.description || '');
            } else {
                onTaskMutation({ closeDialog: false });
            }
        }
    }, [task.id, currentDescription, onTaskMutation, task.description]);

    let taskItemIndex = -1;
    const options = {
        replace: (domNode: DOMNode) => {
            if (domNode instanceof Element && domNode.name === 'img') {
                const src = domNode.attribs.src;
                const alt = domNode.attribs.alt;
                if (src && src.startsWith('task-uploads/')) {
                    return <PrivateImage src={src} alt={alt || 'Imatge de la tasca'} />;
                }
            }
            if (domNode instanceof Element && domNode.attribs && domNode.attribs['data-type'] === 'taskItem') {
                taskItemIndex++;
                const currentIndex = taskItemIndex;
                const isChecked = domNode.attribs['data-checked'] === 'true';

                const contentDiv = domNode.children.find(
                    (child): child is Element => child instanceof Element && child.name === 'div'
                );

                return (
                    <div className="flex items-start gap-3 my-2 first:mt-0 last:mb-0">
                        <Checkbox
                            checked={isChecked}
                            onCheckedChange={() => handleToggleTaskItem(currentIndex)}
                            className="w-5 h-5 mt-1"
                        />
                        <div className={cn("prose prose-sm dark:prose-invert max-w-none", isChecked && "line-through text-muted-foreground")}>
                            {contentDiv && domToReact(contentDiv.children as DOMNode[], options)}
                        </div>
                    </div>
                );
            }
        }
    };

    const handleToggle = async () => {
        const isCompleting = !task.is_completed;
        const updateData = {
            is_completed: isCompleting,
            finish_date: isCompleting ? new Date().toISOString() : null,
        };
        const { error } = await updateSimpleTask(task.id, updateData);
        if (error) {
            toast.error(t('toast.errorTitle'), { description: "No s'ha pogut actualitzar la tasca." });
        } else {
            toast.success("Estat de la tasca actualitzat.");
            onTaskMutation();
            onClose();
        }
    };

    const handleDelete = async () => {
        const { error } = await deleteTask(task.id);
        if (error) {
            const errorMessage = typeof error === 'object' && error !== null && 'message' in error ? (error as { message: string }).message : 'Error desconegut';
            toast.error(t('toast.deleteErrorTitle'), { description: errorMessage });
        } else {
            toast.success(t('toast.deleteSuccessTitle'));
            onTaskMutation();
            onClose();
        }
    };

    // âœ… NOU: FunciÃ³ per gestionar la sincronitzaciÃ³
    const handleSyncToGoogle = () => {
        // HaurÃ s d'afegir aquests textos al teu fitxer de traducciÃ³
        const toastId = toast.loading(t('toast.syncingGoogle'));

        startSyncTransition(async () => {
            const result = await syncTaskToGoogleAction(task.id);

            toast.dismiss(toastId); // Tanca el 'loading'

            if (result.success) {
                toast.success(result.message || t('toast.syncSuccessGoogle'));
                // Actualitzem les dades del diÃ leg sense tancar-lo
                // AixÃ² farÃ  que 'isSynced' es posi a 'true' i el botÃ³ canviÃ¯
                onTaskMutation({ closeDialog: false });
            } else {
                toast.error(t('toast.syncErrorGoogle'), {
                    description: result.message || "Error desconegut.",
                });
            }
        });
    };

    return (
        <>
            <DialogHeader className="pr-16 pb-4 border-b">
                <DialogTitle className="text-2xl font-bold leading-tight flex items-center gap-3">
                    <div className={cn("w-4 h-4 rounded-full flex-shrink-0")} style={{ backgroundColor: priorityStyles[task.priority as TaskPriority]?.hexColor }} />
                    {task.title}
                </DialogTitle>
                <Badge variant="outline" className={cn("absolute top-6 right-6 text-sm py-1 px-3", priorityStyles[task.priority as TaskPriority]?.badgeClasses)}>
                    <Flag className="w-3.5 h-3.5 mr-2" /> {task.priority}
                </Badge>
            </DialogHeader>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 py-6 max-h-[65vh] overflow-y-auto pr-2">
                {/* Columna Esquerra: DescripciÃ³ i detalls */}
                <div className="md:col-span-2 space-y-6">
                    {currentDescription && (
                        <div className='max-w-none'>
                            {parse(currentDescription, options)}
                        </div>
                    )}
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-6 text-sm border-t pt-6">
                        <DetailItem icon={Calendar} label={t2('limitDay')}>{task.due_date && format(new Date(task.due_date), "d MMM yyyy 'a les' HH:mm", { locale: es })}</DetailItem>
                        <DetailItem icon={Building} label="Departament">{task.departments?.name}</DetailItem>
                        <DetailItem icon={User} label={t2('assignedTo')}>{task.profiles?.full_name || 'Sense assignar'}</DetailItem>
                        <DetailItem icon={User} label="Contacte associat">{task.contacts?.nom}</DetailItem>
                    </div>
                </div>

                {/* Columna Dreta: Estat i Temps */}
                <div className="md:col-span-1 space-y-4">
                    <div className="bg-muted/50 rounded-lg p-4 space-y-4">
                        <div>
                            <Label htmlFor="task-status-active" className="text-sm text-muted-foreground mb-2 block">Estat de la Tasca</Label>
                            <div className="flex items-center space-x-3">
                                <Switch id="task-status-active" checked={isActive} onCheckedChange={handleToggleActive} />
                                <span className={cn("font-bold text-lg", isActive ? "text-green-600" : "text-foreground")}>{isActive ? 'Activa' : 'Inactiva'}</span>
                            </div>
                        </div>
                        <div className="text-center">
                            <Label className="text-sm text-muted-foreground">TEMPS TOTAL IMPUTAT</Label>
                            <div className="flex items-center justify-center gap-2 text-4xl font-mono font-bold text-foreground mt-2">
                                <Clock className="w-7 h-7 text-muted-foreground" />
                                <span>{liveTimeDisplay}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <DialogFooter className="flex-col sm:flex-row sm:justify-between gap-2 border-t pt-4">
                <div className='flex items-center gap-2'>
                    <Button variant="ghost" onClick={onSetEditMode}>
                        <Pencil className="w-4 h-4 mr-2" /> Editar
                    </Button>
                    {/* âœ…âœ…âœ… AQUEST Ã‰S EL BLOC MODIFICAT âœ…âœ…âœ… */}
                    <Button
                        variant={isSynced ? "ghost" : "outline"} // Canvi de variant
                        className="w-full"
                        onClick={handleSyncToGoogle}
                        disabled={isSyncing}
                    >
                        {isSyncing ? (
                            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                        ) : (
                            // Icona condicional
                            isSynced ? (
                                <RefreshCw className="w-4 h-4 mr-2" /> // Icona d'actualitzar
                            ) : (
                                <Calendar className="w-4 h-4 mr-2" /> // Icona d'enviar
                            )
                        )}
                        {/* Text condicional (que ja tenies) */}
                        {isSynced
                            ? t('toast.updateGoogle') // "Actualitzar a Google Calendar"
                            : t('toast.sendGoogle') // "Enviar a Google Calendar"
                        }
                    </Button>
                    {/* âœ…âœ…âœ… FI DEL BLOC MODIFICAT âœ…âœ…âœ… */}
                </div>
                <div className='flex items-center gap-2'>
                    <AlertDialog>
                        <AlertDialogTrigger asChild>
                            <Button variant="ghost" size="icon" className="text-destructive hover:text-destructive hover:bg-destructive/10">
                                <Trash2 className="w-4 h-4" />
                            </Button>
                        </AlertDialogTrigger>
                        <AlertDialogContent>
                            <AlertDialogHeader>
                                <AlertDialogTitle>{t('deleteConfirmTitle')}</AlertDialogTitle>
                                <AlertDialogDescription>{t('deleteConfirmDescription')}</AlertDialogDescription>
                            </AlertDialogHeader>
                            <AlertDialogFooter>
                                <AlertDialogCancel>{t2('cancelButton')}</AlertDialogCancel>
                                <AlertDialogAction onClick={handleDelete} className="bg-destructive text-destructive-foreground hover:bg-destructive/90">
                                    {t('deleteConfirmAction')}
                                </AlertDialogAction>
                            </AlertDialogFooter>
                        </AlertDialogContent>
                    </AlertDialog>
                    {task.is_completed ? (
                        <Button variant="outline" onClick={handleToggle}>
                            <RotateCcw className="w-4 h-4 mr-2" />
                            {t2('markAsPendingButton')}
                        </Button>
                    ) : (
                        <Button onClick={handleToggle} className="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white">
                            <CheckCircle2 className="w-4 h-4 mr-2" />
                            {t2('markAsCompletedButton')}
                        </Button>
                    )}
                </div>
            </DialogFooter>
        </>
    );
}

// =================== FILE: src/components/features/tasks/TaskDialogManager.tsx ===================

// src/components/features/tasks/TaskDialogManager.tsx (COMPLET I CORREGIT)
'use client';

// âœ… PAS 1: Importem 'useMemo'
import { useState, useEffect, useMemo } from 'react';
import { TaskDetailView } from './TaskDetailView';
import { TaskFormView } from './TaskFormView';
import { Dialog, DialogContent } from '@/components/ui/dialog';
import { Tables, Json } from '@/types/supabase';
import { JSONContent } from '@tiptap/react';

// Tipus per a les entrades del log de temps
interface TimeTrackingLogEntry {
  status?: 'active' | 'inactive';
  action?: 'actiu' | 'inactiu';
  timestamp: string;
  user_id?: string;
}

// Tipus EnrichedTask
export type EnrichedTask = Tables<'tasks'> & {
  contacts: { id: number; nom: string } | null;
  profiles: {
    id?: string;
    full_name: string | null;
    avatar_url: string | null;
  } | null;
  departments: { id: number; name: string } | null;
  description_json?: JSONContent | string | null;
  checklist_progress?: { total: number; completed: number } | null;
  time_tracking_log: TimeTrackingLogEntry[] | null | Json;
  is_active?: boolean;
};

// Props del component
interface TaskDialogManagerProps {
    task: EnrichedTask | null;
    open: boolean;
    onOpenChange: (open: boolean) => void;
    contacts: Tables<'contacts'>[];
    initialDepartments: Tables<'departments'>[];
    teamMembers: { id: string; full_name: string | null }[];
    onTaskMutation: (options?: { closeDialog?: boolean }) => void;
    activeTeamId: string; 
    initialDate?: Date;
}

export function TaskDialogManager({
    task,
    open,
    onOpenChange,
    contacts,
    initialDepartments,
    teamMembers,
    onTaskMutation,
    initialDate, // Aquesta Ã©s la prop que ve del pare
}: TaskDialogManagerProps) {
    const [viewMode, setViewMode] = useState<'detail' | 'form'>(task ? 'detail' : 'form');

    // âœ… DEBUGGING (LOG 1)
    console.log('[TaskDialogManager] Props rebudes:', { 
        task: task, 
        open: open, 
        initialDate_prop: initialDate 
    });

    useEffect(() => {
        if (open) {
            const newMode = task ? 'detail' : 'form';
            setViewMode(newMode);
            // âœ… DEBUGGING (LOG 2)
            console.log(`[TaskDialogManager] useEffect ha canviat el mode a: ${newMode}`);
        }
    }, [open, task]);

    const handleClose = () => {
        onOpenChange(false);
    };

    // âœ… PAS 2: Embolcallem la lÃ²gica amb 'useMemo'
    // AixÃ² crea la data UN SOL COP i la desa, evitant el bucle de renders.
    // NomÃ©s es recalcularÃ  si 'initialDate' o 'task' canvien.
    const formInitialDate = useMemo(() => {
      // âœ… DEBUGGING (LOG 3) - Ara dins del 'useMemo'
      console.log("[TaskDialogManager] useMemo: Calculant 'formInitialDate'...");
      
      // 1. Si el pare ens dona una 'initialDate' (p.ex., clicant un dia del calendari)
      if (initialDate) {
        return initialDate;
      }
      // 2. Si no hi ha 'task' (mode 'create') I no hi ha 'initialDate'
      if (!task) {
        return new Date(); // Creem la data d'avui
      }
      // 3. Altrament (mode ediciÃ³)
      return undefined;

    }, [initialDate, task]); // <-- Les dependÃ¨ncies

    if (!open) return null;

    return (
        <Dialog open={open} onOpenChange={onOpenChange}>
            <DialogContent className="max-w-4xl sm:max-w-6xl md:max-w-7xl">
                {viewMode === 'form' ? (
                    <TaskFormView
                        task={task}
                        onSetViewMode={() => task ? setViewMode('detail') : handleClose()}
                        onTaskMutationSuccess={onTaskMutation} 
                        contacts={contacts ?? []} 
                        initialDepartments={initialDepartments}
                        teamMembers={teamMembers ?? []}
                        // âœ… PAS 3: Passem la data estable (memoitzada)
                        initialDate={formInitialDate}
                    />
                ) : task ? (
                    <TaskDetailView
                        task={task}
                        onSetEditMode={() => setViewMode('form')}
                        onTaskMutation={onTaskMutation}
                        onClose={handleClose}
                    />
                ) : null}
            </DialogContent>
        </Dialog>
    );
}

// =================== FILE: src/components/features/tasks/TaskFormActrions.tsx ===================

// src/components/features/tasks/TaskFormActions.tsx
'use client';

import { Button } from '@/components/ui/button';
import { DialogClose, DialogFooter } from '@/components/ui/dialog';
import { ArrowLeft, Loader2 } from 'lucide-react';

interface FormActionsProps {
  isEditing: boolean;
  onSetViewMode: () => void;
  isPending: boolean;
}

export function TaskFormActions({ isEditing, onSetViewMode, isPending }: FormActionsProps) {
  return (
    <DialogFooter className="sm:justify-between mt-4 pt-4 border-t">
      <div>
        {isEditing && (
          <Button type="button" variant="ghost" onClick={onSetViewMode} disabled={isPending}>
            <ArrowLeft className="w-4 h-4 mr-2" />
            Tornar a la vista
          </Button>
        )}
      </div>
      <div className="flex gap-2">
        <DialogClose asChild>
          <Button type="button" variant="secondary" disabled={isPending}>CancelÂ·lar</Button>
        </DialogClose>
        <Button type="submit" disabled={isPending}>
          {isPending && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
          {isPending
            ? (isEditing ? 'Guardant...' : 'Creant...')
            : (isEditing ? 'Guardar Canvis' : 'Crear Tasca')}
        </Button>
      </div>
    </DialogFooter>
  );
}

// =================== FILE: src/components/features/tasks/TaskFormPrimary.tsx ===================

// src/components/features/tasks/TaskFormPrimary.tsx
'use client';

import EditorWysiwyg from '@/components/features/EditorWysiwyg/EditorWysiwyg';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { JSONContent } from '@tiptap/react';
import { AlignLeft, ListTodo } from 'lucide-react';

interface TaskFormPrimaryProps {
  initialTitle: string;
  descriptionContent: string;
  onDescriptionChange: (html: string, json: JSONContent) => void;
}

export function TaskFormPrimary({
  initialTitle,
  descriptionContent,
  onDescriptionChange,
}: TaskFormPrimaryProps) {
  return (
    <div className="space-y-4">
      {/* TÃ­tol */}
      <div className="space-y-2">
        <Label htmlFor="title" className="flex items-center gap-2 text-base">
          <ListTodo className="w-5 h-5" />
          TÃ­tol de la Tasca
        </Label>
        <Input
          id="title"
          name="title"
          defaultValue={initialTitle}
          placeholder="Ex: Preparar informe trimestral"
          required
          className="text-lg"
        />
      </div>

      {/* DescripciÃ³ */}
      <div className="space-y-2">
        <Label htmlFor="description" className="flex items-center gap-2 text-base">
          <AlignLeft className="w-5 h-5" />
          DescripciÃ³
        </Label>
        <EditorWysiwyg
          id="description"
          name="description"
          defaultValue={descriptionContent} // L'estat ve del hook
          onChange={onDescriptionChange}
        />
      </div>
    </div>
  );
}

// =================== FILE: src/components/features/tasks/TaskFormSecondary.tsx ===================

// src/components/features/tasks/TaskFormSecondary.tsx
'use client';

import { Button } from '@/components/ui/button';
import { Calendar } from '@/components/ui/calendar';
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from '@/components/ui/command';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { cn } from '@/lib/utils/utils';
import { Tables } from '@/types/supabase';
import { format } from 'date-fns';
import { es } from 'date-fns/locale';
import { Building, Calendar as CalendarIcon, Check, ChevronsUpDown, Clock, Flag, User } from 'lucide-react';

// Props del hook
interface StateFromHook {
  dueDate: Date | undefined;
  selectedContactId: string | null;
  assignedUserId: string | null;
  contactComboboxOpen: boolean;
  teamMemberComboboxOpen: boolean;
}
// Handlers del hook
interface HandlersFromHook {
  setDueDate: (date: Date | undefined) => void;
  setSelectedContactId: (id: string | null) => void;
  setAssignedUserId: (id: string | null) => void;
  setContactComboboxOpen: (open: boolean) => void;
  setTeamMemberComboboxOpen: (open: boolean) => void;
}
// Valors inicials (per camps no controlats)
interface InitialValues {
  priority: string;
  duration: string | number;
  departmentId: string;
  assignmentDate: string;
}
// Props estÃ tiques
interface StaticProps {
  contacts: Tables<'contacts'>[];
  teamMembers: { id: string; full_name: string | null }[];
  departments: Tables<'departments'>[];
}

// Props completes del component
type TaskFormSecondaryProps = {
  state: StateFromHook;
  handlers: HandlersFromHook;
  initialValues: InitialValues;
} & StaticProps;

export function TaskFormSecondary({
  state,
  handlers,
  initialValues,
  contacts,
  teamMembers,
  departments
}: TaskFormSecondaryProps) {

  return (
    <div className="space-y-4 p-4 border rounded-lg bg-muted/20 h-full">
      
      {/* Data Venciment */}
      <div className="space-y-2">
        <Label className="flex items-center gap-2"><CalendarIcon className="w-4 h-4" />Data de venciment</Label>
        <Popover>
          <PopoverTrigger asChild>
            <Button variant={"outline"} className={cn("w-full justify-start text-left font-normal", !state.dueDate && "text-muted-foreground")}>
              {state.dueDate ? format(state.dueDate, "PPP", { locale: es }) : <span>Selecciona una data</span>}
            </Button>
          </PopoverTrigger>
          <PopoverContent className="w-auto p-0"><Calendar mode="single" selected={state.dueDate} onSelect={handlers.setDueDate} initialFocus /></PopoverContent>
        </Popover>
      </div>

      {/* Prioritat */}
      <div className="space-y-2">
        <Label htmlFor="priority" className="flex items-center gap-2"><Flag className="w-4 h-4" />Prioritat</Label>
        <Select name="priority" defaultValue={initialValues.priority}>
          <SelectTrigger><SelectValue placeholder="Selecciona una prioritat" /></SelectTrigger>
          <SelectContent>
            <SelectItem value="Baixa">Baixa</SelectItem>
            <SelectItem value="Mitjana">Mitjana</SelectItem>
            <SelectItem value="Alta">Alta</SelectItem>
          </SelectContent>
        </Select>
      </div>

      {/* Assignar a */}
      <div className="space-y-2">
        <Label className="flex items-center gap-2"><User className="w-4 h-4" />Assignar a</Label>
        <Popover open={state.teamMemberComboboxOpen} onOpenChange={handlers.setTeamMemberComboboxOpen}>
          <PopoverTrigger asChild><Button variant="outline" role="combobox" className="w-full justify-between font-normal">{state.assignedUserId ? (teamMembers.find(m => m.id === state.assignedUserId)?.full_name ?? 'Membre no trobat') : "Selecciona un membre"}<ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" /></Button></PopoverTrigger>
          <PopoverContent className="w-[--radix-popover-trigger-width] p-0">
            <Command>
              <CommandInput placeholder="Cercar membre..." />
              <CommandList><CommandEmpty>No s'ha trobat cap membre.</CommandEmpty>
                <CommandGroup>
                  <CommandItem onSelect={() => { handlers.setAssignedUserId(null); handlers.setTeamMemberComboboxOpen(false); }}><Check className={cn("mr-2 h-4 w-4", !state.assignedUserId ? "opacity-100" : "opacity-0")} />Sense assignar</CommandItem>
                  {teamMembers.map((user) => (<CommandItem key={user.id} value={user.full_name ?? ''} onSelect={() => { handlers.setAssignedUserId(user.id); handlers.setTeamMemberComboboxOpen(false); }}><Check className={cn("mr-2 h-4 w-4", state.assignedUserId === user.id ? "opacity-100" : "opacity-0")} />{user.full_name}</CommandItem>))}
                </CommandGroup>
              </CommandList>
            </Command>
          </PopoverContent>
        </Popover>
        {/* Input ocult gestionat pel hook */}
      </div>

      {/* Contacte Associat */}
      <div className="space-y-2">
        <Label className="flex items-center gap-2"><User className="w-4 h-4" />Contacte associat</Label>
        <Popover open={state.contactComboboxOpen} onOpenChange={handlers.setContactComboboxOpen}>
          <PopoverTrigger asChild><Button variant="outline" role="combobox" className="w-full justify-between font-normal">{state.selectedContactId ? (contacts.find(c => c.id.toString() === state.selectedContactId)?.nom ?? 'Contacte no trobat') : "Selecciona un contacte"}<ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" /></Button></PopoverTrigger>
          <PopoverContent className="w-[--radix-popover-trigger-width] p-0">
            <Command>
              <CommandInput placeholder="Cercar contacte..." />
              <CommandList><CommandEmpty>No s'ha trobat cap contacte.</CommandEmpty>
                <CommandGroup>
                  <CommandItem onSelect={() => { handlers.setSelectedContactId(null); handlers.setContactComboboxOpen(false); }}><Check className={cn("mr-2 h-4 w-4", !state.selectedContactId ? "opacity-100" : "opacity-0")} />Cap</CommandItem>
                  {contacts.map((contact) => (<CommandItem key={contact.id} value={contact.nom ?? ''} onSelect={() => { handlers.setSelectedContactId(contact.id.toString()); handlers.setContactComboboxOpen(false); }}><Check className={cn("mr-2 h-4 w-4", state.selectedContactId === contact.id.toString() ? "opacity-100" : "opacity-0")} />{contact.nom}</CommandItem>))}
                </CommandGroup>
              </CommandList>
            </Command>
          </PopoverContent>
        </Popover>
        {/* Input ocult gestionat pel hook */}
      </div>
      
      {/* Departament */}
      <div className="space-y-2">
        <Label htmlFor="department_id" className="flex items-center gap-2"><Building className="w-4 h-4" />Departament</Label>
        <Select name="department_id" defaultValue={initialValues.departmentId}>
          <SelectTrigger><SelectValue placeholder="Selecciona un departament" /></SelectTrigger>
          <SelectContent>
            <SelectItem value="none">Cap</SelectItem>
            {departments.map(dep => (
              <SelectItem key={dep.id} value={dep.id.toString()}>{dep.name}</SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      {/* DuraciÃ³ */}
      <div className="space-y-2">
        <Label htmlFor="duration" className="flex items-center gap-2"><Clock className="w-4 h-4" />DuraciÃ³ (Hores)</Label>
        <Input id="duration" name="duration" type="number" step="0.01" placeholder="Ex: 1.25" defaultValue={initialValues.duration} />
      </div>

      {/* Data AssignaciÃ³ (Read Only) */}
      <div className="space-y-2">
        <Label htmlFor="assignment_date" className="flex items-center gap-2"><CalendarIcon className="w-4 h-4" />Data assignaciÃ³</Label>
        <Input id="assignment_date" name="assignment_date" type="text" value={initialValues.assignmentDate} readOnly className="bg-muted/50 cursor-not-allowed" />
      </div>

    </div>
  );
}

// =================== FILE: src/components/features/tasks/TaskFormView.tsx ===================

// src/components/features/tasks/TaskFormView.tsx
'use client';

import { DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { EnrichedTask } from './TaskDialogManager';
import { Tables } from '@/types/supabase';
import { useTaskForm } from './hooks/useTaskForm'; // Importem el Hook
import { TaskFormActions } from './TaskFormActrions';
import { TaskFormPrimary } from './TaskFormPrimary'; // Importem Columna Esquerra
import { TaskFormSecondary } from './TaskFormSecondary'; // Importem Columna Dreta

// --- Props ---
interface TaskFormViewProps {
  task: EnrichedTask | null;
  onSetViewMode: () => void;
  onTaskMutationSuccess: () => void;
  contacts: Tables<'contacts'>[];
  initialDepartments: Tables<'departments'>[];
  teamMembers: { id: string; full_name: string | null }[];
  initialDate?: Date;
}

// --- Component Principal del Formulari ---
export function TaskFormView({
  task,
  onSetViewMode,
  onTaskMutationSuccess,
  contacts,
  initialDepartments = [],
  teamMembers,
  initialDate,
}: TaskFormViewProps) {
  // 1. Tota la lÃ²gica i l'estat venen del hook
  const {
    isPending,
    isEditing,
    handleSubmit,
    initialValues,
    state,
    handlers,
  } = useTaskForm({
    task,
    onTaskMutationSuccess,
    initialDate,
  });

  return (
    <>
      <DialogHeader>
        <DialogTitle className="text-2xl">{isEditing ? 'Editar Tasca' : 'Crear Nova Tasca'}</DialogTitle>
      </DialogHeader>

      {/* 2. El 'form' utilitza el handleSubmit del hook */}
      <form onSubmit={handleSubmit}>
        
        {/* Camp ocult per a l'ediciÃ³ */}
        {task && <input type="hidden" name="taskId" value={task.id} />}

        {/* 3. Implementem el nou layout (Esquerra / Dreta) */}
        
        {/* âœ… CANVI: Canviat de lg:grid-cols-5 a lg:grid-cols-3 */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 max-h-[65vh] overflow-y-auto pr-4 custom-scrollbar">
          
          {/* Columna Esquerra (TÃ­tol i DescripciÃ³) */}
          {/* âœ… CANVI: Canviat de lg:col-span-3 a lg:col-span-2 */}
          <div className="lg:col-span-2">
            <TaskFormPrimary
              initialTitle={initialValues.title}
              descriptionContent={state.descriptionContent}
              onDescriptionChange={(html, json) => {
                handlers.setDescriptionContent(html);
                handlers.setDescriptionJson(json);
              }}
            />
          </div>

          {/* Columna Dreta (Metadades) */}
          {/* âœ… CANVI: Canviat de lg:col-span-2 a lg:col-span-1 */}
          <div className="lg:col-span-1">
            <TaskFormSecondary
              state={state}
              handlers={handlers}
              initialValues={initialValues}
              contacts={contacts}
              teamMembers={teamMembers}
              departments={initialDepartments}
            />
          </div>

        </div>

        {/* 4. Accions del formulari (component importat) */}
        <TaskFormActions
          isEditing={isEditing} 
          onSetViewMode={onSetViewMode} 
          isPending={isPending} 
        />
      </form>
    </>
  );
}

// =================== FILE: src/components/LanguageSwitcher.tsx ===================

"use client";

import * as React from "react";
import { usePathname, useRouter } from "next/navigation";
import { useLocale, useTranslations } from "next-intl";
import { Languages } from "lucide-react";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip";

const locales = [
  { code: "ca", label: "CatalÃ " },
  { code: "es", label: "EspaÃ±ol" },
  { code: "en", label: "English" },
];

export function LanguageSwitcher() {
  const router = useRouter();
  const pathname = usePathname();
  const currentLocale = useLocale();
  const t = useTranslations('LandingNav.langSwitcher');

  const onSelectChange = (nextLocale: string) => {
    // Evitem la navegaciÃ³ si ja estem al 'locale' seleccionat
    if (nextLocale === currentLocale) return;

    // LÃ²gica per extreure el 'pathname' sense el 'locale'
    const newPath = pathname.startsWith(`/${currentLocale}`)
      ? pathname.substring(`/${currentLocale}`.length) || '/'
      : pathname;
    
    // Fem 'replace' per no afegir-ho a l'historial del navegador
    router.replace(`/${nextLocale}${newPath}`);
  };

  return (
    <TooltipProvider delayDuration={100}>
      <Tooltip>
        <TooltipTrigger asChild>
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="ghost" size="icon" aria-label={t('title')}>
                <Languages className="w-5 h-5" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              {locales.map(({ code, label }) => (
                <DropdownMenuItem
                  key={code}
                  onClick={() => onSelectChange(code)}
                  // Destaquem visualment l'idioma actiu
                  className={currentLocale === code ? "font-bold" : ""}
                >
                  {label}
                </DropdownMenuItem>
              ))}
            </DropdownMenuContent>
          </DropdownMenu>
        </TooltipTrigger>
        <TooltipContent>
          <p>{t('title')}</p>
        </TooltipContent>
      </Tooltip>
    </TooltipProvider>
  );
}

// =================== FILE: src/components/PWARegistration.tsx ===================

// src/components/PWARegistration.tsx
'use client';

import { useEffect } from 'react';

export function PWARegistration() {
  useEffect(() => {
    // Aquesta lÃ²gica nomÃ©s s'executa un cop el component s'ha muntat al client.
    // Comprovem si el navegador suporta Service Workers.
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('/sw.js') // Registrem el nostre fitxer sw.js
          .then((registration) => {
            console.log('SW registrat amb Ã¨xit:', registration.scope);
          })
          .catch((error) => {
            console.error('Error durant el registre del SW:', error);
          });
      });
    }
  }, []); // L'array buit assegura que l'efecte nomÃ©s s'executa un cop.

  // Aquest component no renderitza res a la UI.
  return null;
}

// =================== FILE: src/components/shared/AccessDenied.tsx ===================

// src/components/shared/AccessDenied.tsx (exemple)
import { useTranslations } from 'next-intl';

// âœ… Defineix les props que el teu component accepta
interface AccessDeniedProps {
  message?: string; // Fes-la opcional amb '?'
}

export function AccessDenied({ message }: AccessDeniedProps) {
  const t = useTranslations('Errors');

  // Fes servir el missatge personalitzat si existeix, si no, un per defecte.
  const displayMessage = message || t('permissionDenied');

  return (
    <div className="text-center p-8 glass-card">
      <h2 className="text-xl font-bold text-destructive">AccÃ©s Denegat</h2>
      <p className="text-muted-foreground">{displayMessage}</p>
    </div>
  );
}

// =================== FILE: src/components/shared/ActivityItem.tsx ===================

// UbicaciÃ³: src/components/shared/ActivityItem.tsx

"use client";

import React from 'react';
import Link from 'next/link';
import { cva, type VariantProps } from 'class-variance-authority';
import { type LucideIcon } from 'lucide-react';
import { cn } from '@/lib/utils/utils';

// Variants per al fons de la icona
const iconContainerVariants = cva(
  "flex-shrink-0 w-10 h-10 rounded-lg flex items-center justify-center",
  {
    variants: {
      variant: {
        default: "bg-primary/10 text-primary",
        success: "bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300",
        danger: "bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300",
        warning: "bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-300",
        info: "bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
);

interface ActivityItemProps extends VariantProps<typeof iconContainerVariants> {
  icon: LucideIcon;
  title: string;
  meta: string;
  href?: string;
}

export function ActivityItem({ icon: Icon, title, meta, href, variant }: ActivityItemProps) {
  const content = (
    <div className="flex items-center gap-4 p-2 rounded-lg transition-colors hover:bg-muted/50">
      <div className={cn(iconContainerVariants({ variant }))}>
        <Icon className="w-5 h-5" />
      </div>
      <div className="flex-1 min-w-0">
        <p className="font-medium text-sm text-foreground truncate">{title}</p>
        <p className="text-xs text-muted-foreground">{meta}</p>
      </div>
    </div>
  );

  if (href) {
    return <Link href={href} className="w-full">{content}</Link>;
  }

  return content;
}

// =================== FILE: src/components/shared/ColumnToggleButton.tsx ===================

// src/components/shared/ColumnToggleButton.tsx
'use client';

import { SlidersHorizontal } from 'lucide-react';
import { useTranslations } from 'next-intl';

import { Button } from '@/components/ui/button';
import { DropdownMenu, DropdownMenuCheckboxItem, DropdownMenuContent, DropdownMenuLabel, DropdownMenuSeparator, DropdownMenuTrigger } from '@/components/ui/dropdown-menu';
import { type ColumnDef } from './GenericDataTable'; // Assumint que el tipus estÃ  aquÃ­

interface ColumnToggleButtonProps<TData> {
  allColumns: ColumnDef<TData>[];
  columnVisibility: Record<string, boolean>;
  toggleColumnVisibility: (columnKey: string) => void;
}

export function ColumnToggleButton<TData>({
  allColumns,
  columnVisibility,
  toggleColumnVisibility,
}: ColumnToggleButtonProps<TData>) {
  const t = useTranslations('Shared.table');

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="outline" size="sm" className="h-9 bg-card border border-input">
          <SlidersHorizontal className="mr-2 h-4 w-4 " />
          {t('view')}
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end">
        <DropdownMenuLabel>{t('toggleColumns')}</DropdownMenuLabel>
        <DropdownMenuSeparator />
        {allColumns
          // Opcional: Filtrem columnes que no volem que l'usuari pugui amagar (com les accions)
          .filter(column => column.accessorKey !== 'actions_edit')
          .map((column) => {
            const columnKey = column.accessorKey.toString();
            return (
              <DropdownMenuCheckboxItem
                key={columnKey}
                className="capitalize"
                checked={columnVisibility[columnKey] ?? true}
                onCheckedChange={() => toggleColumnVisibility(columnKey)}
              >
                {/* Intentem obtenir el header com a string, si no, fem servir la clau */}
                {typeof column.header === 'string' ? column.header : columnKey}
              </DropdownMenuCheckboxItem>
            );
          })}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}

// =================== FILE: src/components/shared/EmptyState.tsx ===================

import { FC } from 'react';

export const EmptyState: FC<{ message: string }> = ({ message }) => (
    <p className="text-center text-muted-foreground py-8">{message}</p>
);

// =================== FILE: src/components/shared/GenericDataTable.tsx ===================

// src/components/shared/GenericDataTable.tsx
"use client";

import React from 'react';
import { motion } from 'framer-motion';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from "@/components/ui/alert-dialog";
import { Button } from '@/components/ui/button';
import { Loader2, Trash2, ArrowUpDown } from 'lucide-react';
import { cn } from '@/lib/utils/utils';
import { useTranslations } from 'next-intl';

import {
  Pagination,
  PaginationContent,
  PaginationEllipsis,
  PaginationItem,
  PaginationLink,
} from "@/components/ui/pagination";
// âœ… Importem les icones necessÃ ries
import { 
  ChevronLeftIcon, 
  ChevronRightIcon, 
  DoubleArrowLeftIcon, // <-- Primera pÃ gina
  DoubleArrowRightIcon // <-- Ãšltima pÃ gina
} from '@radix-ui/react-icons';
// âœ… Importem el component Select
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";

export type ColumnDef<TData> = {
    accessorKey: keyof TData | string;
    header: React.ReactNode | string;
    cell: (row: TData) => React.ReactNode;
    enableSorting?: boolean;
    cellClassName?: string;
    headerClassName?: string;
};

// âœ… Pas 1: Afegim les noves propietats a la interfÃ­cie
interface GenericDataTableProps<TData extends { id: string | number }> {
    data: TData[];
    columns: ColumnDef<TData>[];
    onSort: (column: string) => void;
    currentSortColumn: string | null;
    currentSortOrder: 'asc' | 'desc' | null;
    isPending: boolean;
    onDelete: () => void;
    deleteItem: TData | null;
    setDeleteItem: (item: TData | null) => void;
    deleteTitleKey: string;
    deleteDescription: React.ReactNode;
    emptyStateMessage: string;
    className?: string;

    // Propietats de paginaciÃ³ existents
    page: number;
    totalPages: number;
    onPageChange: (newPage: number) => void;

    // âœ… Noves propietats per files per pÃ gina
    rowsPerPage: number;
    onRowsPerPageChange: (newRowsPerPage: number) => void;
    rowsPerPageOptions?: number[]; // Opcional, per defecte [10, 20, 50]
}

const DEFAULT_ROWS_PER_PAGE_OPTIONS = [10, 20, 50];

export function GenericDataTable<TData extends { id: string | number }>({
    data,
    columns,
    onSort,
    currentSortColumn,
    currentSortOrder,
    isPending,
    onDelete,
    deleteItem,
    setDeleteItem,
    deleteTitleKey,
    deleteDescription,
    emptyStateMessage,
    className,
    page,
    totalPages,
    onPageChange,
    rowsPerPage, // <-- Nova prop
    onRowsPerPageChange, // <-- Nova prop
    rowsPerPageOptions = DEFAULT_ROWS_PER_PAGE_OPTIONS, // <-- Nova prop amb valor per defecte
}: GenericDataTableProps<TData>): React.ReactElement {
    const t = useTranslations('Shared');
    const tPagination = useTranslations('Shared.pagination'); // Namespace per a paginaciÃ³

    // ... (Component intern SortableHeader no canvia) ...
     const SortableHeader = ({ column }: { column: ColumnDef<TData> }) => {
       const key = column.accessorKey.toString();
       const isCurrentSort = currentSortColumn === key;
       return (
         <TableHead
           onClick={column.enableSorting ? () => onSort(key) : undefined}
           className={cn(column.enableSorting ? "cursor-pointer hover:bg-muted/50 transition-colors" : "", column.headerClassName)}
         >
           <div className="flex items-center gap-2">
             {column.header}
             {column.enableSorting && (
               isCurrentSort ? (
                 <span className="text-foreground text-xs">{currentSortOrder === 'asc' ? 'â–²' : 'â–¼'}</span>
               ) : (
                 <ArrowUpDown className="w-4 h-4 text-muted-foreground/30" />
               )
             )}
           </div>
         </TableHead>
       );
     };

    // âœ… Refactoritzem PaginationControls i renderPaginationItems
    const PaginationControls = () => {
        if (totalPages <= 1 && rowsPerPageOptions.length === 0) return null;

        const handlePageClick = (e: React.MouseEvent<HTMLAnchorElement | HTMLButtonElement>, newPage: number) => {
            e.preventDefault();
            // ValidaciÃ³ simple per assegurar que la pÃ gina Ã©s vÃ lida abans de cridar onPageChange
            if (newPage >= 1 && newPage <= totalPages) {
              onPageChange(newPage);
            }
        };

        const handleRowsPerPageChangeInternal = (value: string) => {
            onRowsPerPageChange(Number(value));
        };

        // âœ… ======================================
        // âœ… LÃ’GICA MILLORADA PER RENDERITZAR ITEMS
        // âœ… ======================================
        const renderPaginationItems = () => {
            const items = [];
            // Definim quants botons volem al voltant de la pÃ gina activa (ex: prev, actual, next = 3)
            const siblingCount = 1; // 1 a cada costat de la pÃ gina actual
            const totalPageNumbersToShow = siblingCount * 2 + 1; // Total de nÃºmeros al bloc central

            // --- CAS 1: Poques pÃ gines en total ---
            // Si el nombre total de pÃ gines Ã©s menor o igual al que volem mostrar + els extrems + els ellipsis
            if (totalPages <= totalPageNumbersToShow + 2) { // +2 per la primera i Ãºltima pÃ gina potencialment separades
                for (let i = 1; i <= totalPages; i++) {
                    items.push(
                        <PaginationItem key={i}>
                            <PaginationLink
                                href="#"
                                onClick={(e) => handlePageClick(e, i)}
                                isActive={page === i}
                            >
                                {i}
                            </PaginationLink>
                        </PaginationItem>
                    );
                }
            }
            // --- CAS 2: Moltes pÃ gines, necessitem ellipsis ---
            else {
                const leftSiblingIndex = Math.max(page - siblingCount, 1);
                const rightSiblingIndex = Math.min(page + siblingCount, totalPages);

                const shouldShowLeftEllipsis = leftSiblingIndex > 2;
                const shouldShowRightEllipsis = rightSiblingIndex < totalPages - 1;

                // 1. Sempre mostrem la primera pÃ gina
                items.push(
                    <PaginationItem key={1}>
                        <PaginationLink
                            href="#"
                            onClick={(e) => handlePageClick(e, 1)}
                            isActive={page === 1}
                        >
                            1
                        </PaginationLink>
                    </PaginationItem>
                );

                // 2. Mostrem ellipsis esquerre si cal
                if (shouldShowLeftEllipsis) {
                    items.push(<PaginationEllipsis key="start-ellipsis" />);
                }

                // 3. Mostrem els nÃºmeros del mig (al voltant de l'actual)
                const startMiddle = shouldShowLeftEllipsis ? leftSiblingIndex : 2;
                const endMiddle = shouldShowRightEllipsis ? rightSiblingIndex : totalPages - 1;
                for (let i = startMiddle; i <= endMiddle; i++) {
                     items.push(
                        <PaginationItem key={i}>
                            <PaginationLink
                                href="#"
                                onClick={(e) => handlePageClick(e, i)}
                                isActive={page === i}
                            >
                                {i}
                            </PaginationLink>
                        </PaginationItem>
                    );
                }

                // 4. Mostrem ellipsis dret si cal
                if (shouldShowRightEllipsis) {
                    items.push(<PaginationEllipsis key="end-ellipsis" />);
                }

                // 5. Sempre mostrem l'Ãºltima pÃ gina
                items.push(
                    <PaginationItem key={totalPages}>
                        <PaginationLink
                            href="#"
                            onClick={(e) => handlePageClick(e, totalPages)}
                            isActive={page === totalPages}
                        >
                            {totalPages}
                        </PaginationLink>
                    </PaginationItem>
                );
            }

            return items;
        };


        return (
            <div className="flex items-center justify-between mt-4 px-2">
                {/* Selector de Files per PÃ gina */}
                <div className="flex items-center space-x-2 text-sm text-muted-foreground">
                    <span>{tPagination('rowsPerPage')}</span>
                    <Select value={String(rowsPerPage)} onValueChange={handleRowsPerPageChangeInternal}>
                        <SelectTrigger className="h-8 w-[70px] bg-card border border-input">
                            <SelectValue placeholder={rowsPerPage} />
                        </SelectTrigger>
                        <SelectContent side="top">
                            {rowsPerPageOptions.map(option => (
                                <SelectItem key={option} value={String(option)}>
                                    {option}
                                </SelectItem>
                            ))}
                        </SelectContent>
                    </Select>
                </div>

                {/* Controls de PaginaciÃ³ */}
                <Pagination className="mx-0 w-auto">
                    <PaginationContent>
                        {/* BotÃ³ Primera PÃ gina */}
                        <PaginationItem>
                            <Button
                                variant="outline"
                                size="icon"
                                className={cn("h-8 w-8", page === 1 ? "pointer-events-none opacity-50 bg-card" : undefined)}
                                onClick={(e) => handlePageClick(e, 1)} // Passem l'event
                                disabled={page === 1}
                                aria-label={tPagination('firstPage')}
                            >
                                <DoubleArrowLeftIcon className="h-4 w-4" />
                            </Button>
                        </PaginationItem>
                        {/* BotÃ³ Anterior */}
                        <PaginationItem>
                           <Button
                                variant="outline"
                                size="icon"
                                className={cn("h-8 w-8", page === 1 ? "pointer-events-none opacity-50 bg-card" : undefined)}
                                onClick={(e) => handlePageClick(e, page - 1)} // Passem l'event
                                disabled={page === 1}
                                aria-label={tPagination('previous')}
                            >
                                <ChevronLeftIcon className="h-4 w-4" />
                            </Button>
                        </PaginationItem>

                        {/* NÃºmeros de PÃ gina amb Ellipsis */}
                        {renderPaginationItems()}

                         {/* BotÃ³ SegÃ¼ent */}
                        <PaginationItem>
                            <Button
                                variant="outline"
                                size="icon"
                                className={cn("h-8 w-8", page >= totalPages ? "pointer-events-none opacity-50 bg-card" : undefined)} // >= per seguretat
                                onClick={(e) => handlePageClick(e, page + 1)} // Passem l'event
                                disabled={page >= totalPages}
                                aria-label={tPagination('next')}
                            >
                                <ChevronRightIcon className="h-4 w-4" />
                            </Button>
                        </PaginationItem>
                         {/* BotÃ³ Ãšltima PÃ gina */}
                        <PaginationItem>
                            <Button
                                variant="outline"
                                size="icon"
                                className={cn("h-8 w-8", page >= totalPages ? "pointer-events-none opacity-50 bg-card" : undefined)} // >= per seguretat
                                onClick={(e) => handlePageClick(e, totalPages)} // Passem l'event
                                disabled={page >= totalPages}
                                aria-label={tPagination('lastPage')}
                           >
                                <DoubleArrowRightIcon className="h-4 w-4" />
                            </Button>
                        </PaginationItem>
                    </PaginationContent>
                </Pagination>

                 {/* InformaciÃ³ de PÃ gina Actual */}
                 <div className="text-sm text-muted-foreground">
                    {tPagination('pageInfo', { currentPage: page, totalPages: totalPages })}
                 </div>
            </div>
        );
    };


    return (
        <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            className={cn("relative h-full flex flex-col", className, isPending && "opacity-50 pointer-events-none")}
        >
            {isPending && (<div className="absolute inset-0 flex items-center justify-center bg-background/50 z-20"><Loader2 className="w-8 h-8 animate-spin" /></div>)}

            <div className="flex-grow overflow-y-auto bg-card rounded-xl shadow-lg border border-border min-h-0">
                <Table className="relative">
                   {/* ... (TableHeader i TableBody no canvien) ... */}
                   <TableHeader className="sticky top-0 bg-card z-10 shadow-sm">
                       <TableRow>
                           {columns.map((column, index) => (<SortableHeader key={index} column={column} />))}
                           <TableHead className="text-right">{t('table.actions')}</TableHead>
                       </TableRow>
                   </TableHeader>
                   <TableBody>
                       {data.length > 0 ? data.map(row => (
                           <TableRow key={row.id}>
                               {columns.map((column, index) => (
                                   <TableCell key={index} className={cn("py-1", column.cellClassName)}>
                                       {column.cell(row)}
                                   </TableCell>
                               ))}
                               <TableCell className="text-right py-1">
                                   <Button
                                       variant="ghost"
                                       size="icon"
                                       title={t('actions.delete')}
                                       onClick={() => setDeleteItem(row)}
                                       disabled={isPending}
                                   >
                                       <Trash2 className="w-4 h-4 text-red-500" />
                                   </Button>
                               </TableCell>
                           </TableRow>
                       )) : (
                           <TableRow>
                               <TableCell colSpan={columns.length + 1} className="text-center h-24">{emptyStateMessage}</TableCell>
                           </TableRow>
                       )}
                   </TableBody>
                </Table>
            </div>

            {/* Renderitzem els nous controls de paginaciÃ³ */}
            <PaginationControls />

            {/* ... (AlertDialog no canvia) ... */}
            <AlertDialog open={!!deleteItem} onOpenChange={() => setDeleteItem(null)}>
                <AlertDialogContent>
                   <AlertDialogHeader>
                       <AlertDialogTitle>{t(deleteTitleKey)}</AlertDialogTitle>
                       <AlertDialogDescription>
                           {deleteDescription}
                       </AlertDialogDescription>
                   </AlertDialogHeader>
                   <AlertDialogFooter>
                       <AlertDialogCancel disabled={isPending}>{t('deleteDialog.cancelButton')}</AlertDialogCancel>
                       <AlertDialogAction onClick={onDelete} className="bg-destructive hover:bg-destructive/90" disabled={isPending}>
                           {isPending && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
                           {isPending ? t('deleteDialog.deleting') : t('deleteDialog.confirmButton')}
                       </AlertDialogAction>
                   </AlertDialogFooter>
                </AlertDialogContent>
            </AlertDialog>
        </motion.div>
    );
}

// =================== FILE: src/components/shared/GenericDataTableSkeleton.tsx ===================

// src/components/shared/GenericDataTableSkeleton.tsx
import { Skeleton } from "@/components/ui/skeleton";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { cn } from "@/lib/utils/utils";

interface GenericDataTableSkeletonProps {
  /** Nombre de columnes a mostrar (incloent accions) */
  columnCount?: number;
  /** Nombre de files a simular */
  rowCount?: number;
  /** Classe CSS addicional per al contenidor principal */
  className?: string;
  /** Mostrar skeleton per a la capÃ§alera de pÃ gina (PageHeader)? */
  showPageHeaderSkeleton?: boolean; // <-- Nova prop
  /** Mostrar skeleton per a la barra de filtres? */
  showFiltersSkeleton?: boolean;
  /** Quants controls de filtre (Selects) mostrar a la barra (a mÃ©s del cercador) */
  filterControlCount?: number; // <-- Nova prop
}

export function GenericDataTableSkeleton({
  columnCount = 6, // Ajustat per defecte (ex: quotes)
  rowCount = 10,
  className,
  showPageHeaderSkeleton = true, // Per defecte, mostrem capÃ§alera
  showFiltersSkeleton = true,
  filterControlCount = 1, // Per defecte, 1 filtre (com status a quotes)
}: GenericDataTableSkeletonProps) {

  const safeColumnCount = Math.max(1, columnCount);
  const safeRowCount = Math.max(1, rowCount);
  // Assegurem que el recompte de filtres sigui almenys 0
  const safeFilterControlCount = Math.max(0, filterControlCount);

  return (
    // âœ… Mantenim flex-col, ajustem espai a gap-4 per coherÃ¨ncia
    <div className={cn("h-full flex flex-col gap-4", className)}>

      {/* âœ… Skeleton per a PageHeader */}
      {showPageHeaderSkeleton && (
        <div className="flex justify-between items-center">
          {/* TÃ­tol (i descripciÃ³ si la tinguÃ©s) */}
          <div className="space-y-1">
            <Skeleton className="h-8 w-48" /> {/* TÃ­tol */}
            {/* <Skeleton className="h-4 w-64" /> */} {/* DescripciÃ³ opcional */}
          </div>
          {/* BotÃ³ d'acciÃ³ (ex: Nou) */}
          <Skeleton className="h-9 w-32" />
        </div>
      )}

      {/* Skeleton per a la Barra de Filtres/Accions */}
      {showFiltersSkeleton && (
        <div className="flex justify-between items-center">
          {/* Controls de Filtre */}
          <div className="flex items-center gap-2">
            <Skeleton className="h-9 w-48" /> {/* Cerca */}
            {/* Generem Skeletons per als filtres addicionals */}
            {Array.from({ length: safeFilterControlCount }).map((_, index) => (
              <Skeleton key={index} className="h-9 w-32" />
            ))}
          </div>
          {/* BotÃ³ Columnes */}
          <Skeleton className="h-9 w-24" />
        </div>
      )}

      {/* Skeleton de la Taula */}
      {/* âœ… Eliminem flex-grow d'aquÃ­ per posar-lo al contenidor pare si cal */}
      <div className="rounded-xl border bg-card shadow-lg overflow-hidden">
        <Table>
          <TableHeader>
            <TableRow>
              {Array.from({ length: safeColumnCount }).map((_, index) => (
                <TableHead key={index}>
                  <Skeleton className="h-5 w-20" />
                </TableHead>
              ))}
            </TableRow>
          </TableHeader>
          <TableBody>
            {Array.from({ length: safeRowCount }).map((_, rowIndex) => (
              <TableRow key={rowIndex}>
                {Array.from({ length: safeColumnCount }).map((_, cellIndex) => (
                  <TableCell key={cellIndex} className="py-2"> {/* Ajustat padding */}
                    <Skeleton className={`h-4 ${cellIndex === 0 ? 'w-3/4' : 'w-full'}`} /> {/* Ajustat amplada */}
                  </TableCell>
                ))}
              </TableRow>
            ))}
          </TableBody>
        </Table>
      </div>

      {/* Skeleton de la PaginaciÃ³ (es mantÃ© igual) */}
      <div className="flex items-center justify-between mt-auto pt-2 px-2"> {/* Afegit mt-auto per empÃ¨nyer avall */}
        {/* Skeleton Files per pÃ gina */}
        <div className="flex items-center gap-2">
          <Skeleton className="h-4 w-12" />
          <Skeleton className="h-8 w-[70px]" />
        </div>
        {/* Skeleton Botons PaginaciÃ³ */}
        <div className="flex items-center gap-1">
          <Skeleton className="h-8 w-8" /> {/* Primera */}
          <Skeleton className="h-8 w-8" /> {/* Anterior */}
          <Skeleton className="h-8 w-8 rounded-md" /> {/* Num 1 */}
          <Skeleton className="h-8 w-8 rounded-md" /> {/* Num 2 */}
          <Skeleton className="h-8 w-8 rounded-md" /> {/* Num 3 */}
          <Skeleton className="h-8 w-8" /> {/* SegÃ¼ent */}
          <Skeleton className="h-8 w-8" /> {/* Ãšltima */}
        </div>
        {/* Skeleton Info PÃ gina */}
        <Skeleton className="h-4 w-24" />
      </div>
    </div>
  );
}

// =================== FILE: src/components/shared/ModuleCard.tsx ===================

"use client";

import * as React from "react";
import { cva, type VariantProps } from "class-variance-authority";
import { ChevronUp, ChevronDown } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from "@/components/ui/collapsible";
import { cn } from "@/lib/utils/utils";

// ... (variants de CVA no canvien) ...
const cardHeaderVariants = cva(
  "flex items-center justify-between p-2 text-primary-foreground rounded-t-xl",
  {
    variants: {
      variant: {
        default: "bg-primary",
        sales: "bg-blue-600",
        agenda: "bg-green-700",
        activity: "bg-orange-500",
        radar: "bg-purple-600",
        invoices: "bg-teal-500",
        quotes: "bg-teal-600",
        tasks: "bg-yellow-600",
        inbox: "bg-indigo-600",
        info: "bg-blue-600",
        success: "bg-green-700",
        warning: "bg-yellow-600",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
);

interface ModuleCardProps extends VariantProps<typeof cardHeaderVariants> {
  title: string;
  icon: React.ElementType;
  children: React.ReactNode;
  className?: string;
  defaultOpen?: boolean;
  actions?: React.ReactNode;
  isCollapsible?: boolean;
  isVisible?: boolean; 
}

export function ModuleCard({ 
  title, 
  icon: Icon, 
  children, 
  className, 
  variant, 
  defaultOpen = true, 
  actions,
  isCollapsible = true,
  isVisible = true 
}: ModuleCardProps) {
  const [isOpen, setIsOpen] = React.useState(defaultOpen);

  if (!isVisible) {
    return null;
  }

  return (
    <Collapsible
      open={!isCollapsible || isOpen} 
      onOpenChange={setIsOpen}
      disabled={!isCollapsible}
      className={cn("rounded-xl border bg-card text-card-foreground shadow-lg overflow-hidden transition-all duration-300", className)}
    >
      <div className={cn(cardHeaderVariants({ variant }))}>
        <div className="flex items-center gap-3">
          <Icon className="w-5 h-5 text-primary-foreground/80" />
          <h2 className="text-base font-semibold">{title}</h2>
        </div>
        <div className="flex items-center gap-1">
          {actions}
          
          {isCollapsible && (
            <CollapsibleTrigger asChild>
              <Button 
                // âœ… --- AQUESTA Ã‰S LA CORRECCIÃ“ ---
                type="button" 
                // âœ… --- FI DE LA CORRECCIÃ“ ---
                variant="ghost" 
                size="icon" 
                className="text-primary-foreground/80 hover:text-primary-foreground hover:bg-white/10 h-8 w-8"
              >
                {isOpen ? <ChevronUp className="h-4 w-4" /> : <ChevronDown className="h-4 w-4" />}
                <span className="sr-only">Toggle</span>
              </Button>
            </CollapsibleTrigger>
          )}
        </div>
      </div>

      <CollapsibleContent>
        <div className="p-4 md:p-6 bg-card flex flex-col h-full">
          {children}
        </div>
      </CollapsibleContent>
    </Collapsible>
  );
}

// =================== FILE: src/components/shared/PageHeader.tsx ===================

"use client"; // Aquest component tÃ© interacciÃ³ (botÃ³ de tornar)

import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';

interface PageHeaderProps {
  title: string;
  description?: string;
  showBackButton?: boolean;
  children?: React.ReactNode; // Per a botons d'acciÃ³ (ex: "Nou ProveÃ¯dor")
}

export function PageHeader({ 
  title, 
  description, 
  showBackButton = false, 
  children 
}: PageHeaderProps) {
  const router = useRouter();

  return (
    <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div className="flex items-center gap-3">
        {showBackButton && (
          <Button
            variant="outline"
            size="icon"
            className="h-8 w-8"
            onClick={() => router.back()}
          >
            <ArrowLeft className="h-4 w-4" />
            <span className="sr-only">Tornar</span>
          </Button>
        )}
        <div className="grid gap-1">
          <h1 className="text-2xl md:text-3xl font-bold tracking-tight">
            {title}
          </h1>
          {description && (
            <p className="text-muted-foreground">
              {description}
            </p>
          )}
        </div>
      </div>
      
      {/* AquÃ­ es renderitzaran els botons d'acciÃ³ */}
      {children && (
        <div className="flex-shrink-0">
          {children}
        </div>
      )}
    </div>
  );
}

// =================== FILE: src/components/shared/PaginationBar.tsx ===================

"use client";

import { ChevronLeft, ChevronRight, Loader2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { useTranslations } from 'next-intl';

interface PaginationBarProps {
  currentPage: number;
  totalPages: number;
  onPageChange: (page: number) => void;
  totalItems: number;
  itemsPerPage: number;
  isLoading: boolean;
  resourceName: string; // Nom del recurs (e.g., 'despeses', 'factures')
}

export function PaginationBar({
  currentPage,
  totalPages,
  onPageChange,
  totalItems,
  itemsPerPage,
  isLoading,
  resourceName
}: PaginationBarProps) {
  const t = useTranslations('Shared.Pagination');

  const startItem = (currentPage - 1) * itemsPerPage + 1;
  const endItem = Math.min(currentPage * itemsPerPage, totalItems);

  return (
    <div
      className="
        flex flex-col sm:flex-row sm:items-center sm:justify-between 
        gap-2 sm:gap-4 p-3 border-t text-sm text-muted-foreground
      "
    >
      {/* ğŸ“Š InformaciÃ³ del rang */}
      <div className="flex items-center justify-center sm:justify-start gap-2 text-center sm:text-left">
        {isLoading && <Loader2 className="w-4 h-4 animate-spin text-primary" />}
        <span className="truncate text-xs sm:text-sm">
          {t('showing')} {startItem}-{endItem} {t('of')} {totalItems} {resourceName}
        </span>
      </div>

      {/* ğŸ” Controls de navegaciÃ³ */}
      <div className="flex items-center justify-center gap-1 sm:gap-2">
        <Button
          variant="outline"
          size="icon"
          onClick={() => onPageChange(currentPage - 1)}
          disabled={currentPage <= 1 || isLoading}
          className="h-8 w-8 sm:h-9 sm:w-9"
        >
          <ChevronLeft className="h-4 w-4" />
        </Button>

        <span className="font-medium text-foreground text-xs sm:text-sm min-w-[60px] text-center">
          {currentPage} / {totalPages}
        </span>

        <Button
          variant="outline"
          size="icon"
          onClick={() => onPageChange(currentPage + 1)}
          disabled={currentPage >= totalPages || isLoading}
          className="h-8 w-8 sm:h-9 sm:w-9"
        >
          <ChevronRight className="h-4 w-4" />
        </Button>
      </div>
    </div>
  );
}


// =================== FILE: src/components/shared/ProductSelector.tsx ===================

// /src/components/shared/ProductSelector.tsx (COMPLET I CORREGIT)
"use client";

// âœ… Importem 'useRef' per al fix del bucle i 'Textarea' per a la millora
import React, { useState, useEffect, useRef } from 'react';
import { useActionState } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea'; // ğŸ‘ˆ Importat!
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from "@/components/ui/command";
import { Plus, BookPlus, Save, Loader2 } from 'lucide-react';
import { toast } from 'sonner';
import { type Database } from '@/types/supabase';

// L'IMPORT CORREGIT A L'ACCIÃ“ QUE HAS PROPORCIONAT
import { createProduct } from '@/app/[locale]/(app)/finances/products/actions';
// âœ… 2. Importem els tipus NOMÃ‰S PER A ÃšS INTERN
import type {

    FormState,


} from '@/lib/services/finances/products/products.service';

type Product = Database['public']['Tables']['products']['Row'];

interface ProductSelectorProps {
    products: Product[];
    onProductSelect: (product: Product) => void;
    onManualAdd: () => void;
    /** FunciÃ³ de traducciÃ³ (t) amb el namespace ja aplicat. */
    t: (key: string) => string;
    /** Opcional: Permet personalitzar el botÃ³ que obre el Popover */
    triggerButton?: React.ReactNode;
}

// Estat inicial per useActionState
const initialState: FormState = {
    success: false,
    message: '',
    errors: {},
};

// âœ… 2. Hook personalitzat per obtenir el valor anterior (CORREGIT)
function usePrevious<T>(value: T): T | undefined {
    // âœ… CORRECCIÃ“: Inicialitzem el ref amb 'undefined'
    const ref = useRef<T | undefined>(undefined);

    // Guardem el valor actual (que Ã©s el previ abans de l'actualitzaciÃ³ de l'efecte)
    const previous = ref.current;

    useEffect(() => {
        // Actualitzem el ref amb el nou valor *desprÃ©s* del render
        ref.current = value;
    }, [value]);

    // Retornem el valor que tenÃ­em abans de l'actualitzaciÃ³ de l'efecte
    return previous;
}

export const ProductSelector: React.FC<ProductSelectorProps> = ({
    products,
    onProductSelect,
    onManualAdd,
    t,
    triggerButton
}) => {
    const [isCreating, setIsCreating] = useState(false);
    const [isPopoverOpen, setIsPopoverOpen] = useState(false);

    // Nou hook per gestionar l'estat del formulari
    const [formState, formAction, isPending] = useActionState(createProduct, initialState);

    // âœ… 3. Obtenim l'estat anterior (aquesta lÃ²gica Ã©s correcta)
    const prevFormState = usePrevious(formState);

    // âœ… 4. useEffect modificat (aquesta lÃ²gica Ã©s correcta)
    useEffect(() => {
        // Si l'estat actual Ã©s el mateix que l'anterior, sortim d'hora.
        if (prevFormState === formState) {
            return;
        }

        // La lÃ²gica nomÃ©s s'executa quan formState REALMENT canvia
        if (formState.success && formState.data) {
            toast.success(t('toast.productCreated'), { description: formState.message });

            // 1. Cridem el callback del pare amb el nou producte
            onProductSelect(formState.data as Product);

            // 2. Resetejem l'estat i tanquem el popover
            setIsCreating(false);
            setIsPopoverOpen(false);

        } else if (!formState.success && (formState.message || formState.errors) && formState.message !== '') {
            // Si hi ha un error de validaciÃ³ o de servidor
            const description = formState.errors
                ? Object.values(formState.errors).flat().join(' ')
                : t('toast.genericError');
            toast.error(formState.message || "Error", { description });
        }

    }, [formState, prevFormState, onProductSelect, t]); // DependÃ¨ncies completes


    const handleManualItemClick = () => {
        onManualAdd();
        setIsPopoverOpen(false);
    };

    const handleProductSelectClick = (product: Product) => {
        onProductSelect(product);
        setIsPopoverOpen(false);
    };

    // Component 'SubmitButton' intern per gestionar l'estat 'pending'
    const SubmitButton = () => {
        return (
            <Button size="sm" type="submit" disabled={isPending}>
                {isPending && <Loader2 className="w-4 h-4 mr-2 animate-spin" />}
                {t('saveAndAddButton')}
            </Button>
        );
    }

    return (
        <Popover open={isPopoverOpen} onOpenChange={setIsPopoverOpen}>
            <PopoverTrigger asChild>
                {triggerButton ? triggerButton : (
                    <Button variant="outline" size="sm" className="mt-4">
                        <BookPlus className="w-4 h-4 mr-2" />
                        {t('addButton')}
                    </Button>
                )}
            </PopoverTrigger>
            <PopoverContent className="w-[500px] p-0">
                {isCreating ? (
                    // Convertit a un <form> que crida la Server Action
                    <form action={formAction}>
                        <div className="p-4 space-y-2">
                            <p className="font-medium text-sm">{t('newProductTitle')}</p>

                            {/* Camp Nom (obligatori) */}
                            <div>
                                <Input
                                    name="name" // Coincideix amb el schema
                                    placeholder={t('newProductNamePlaceholder')}
                                    required
                                />
                                {formState.errors?.name && (
                                    <p className="text-xs text-destructive pt-1">{formState.errors.name.join(', ')}</p>
                                )}
                            </div>

                            {/* âœ… MILLORA: Camp DescripciÃ³ (opcional) */}
                            <div>
                                <Textarea
                                    name="description" // Coincideix amb el schema (opcional)
                                    placeholder={t('newProductDescPlaceholder')} // HaurÃ s d'afegir aquesta traducciÃ³!
                                    rows={3}
                                    className="text-sm"
                                />
                                {formState.errors?.description && (
                                    <p className="text-xs text-destructive pt-1">{formState.errors.description.join(', ')}</p>
                                )}
                            </div>
                            {/* âœ… FI DE LA MILLORA */}

                            {/* Camp Preu (obligatori) */}
                            <div>
                                <Input
                                    name="price" // Coincideix amb el schema
                                    type="number"
                                    placeholder={t('newProductPricePlaceholder')}
                                    step="0.01"
                                    required
                                />
                                {formState.errors?.price && (
                                    <p className="text-xs text-destructive pt-1">{formState.errors.price.join(', ')}</p>
                                )}
                            </div>

                            {/* Camp ocult 'is_active' */}
                            <input type="hidden" name="is_active" value="on" />

                            <div className="flex justify-end gap-2 pt-2">
                                <Button variant="ghost" size="sm" type="button" onClick={() => setIsCreating(false)}>{t('cancelButton')}</Button>
                                <SubmitButton />
                            </div>
                        </div>
                    </form>
                ) : (
                    <Command>
                        <CommandInput placeholder={t('searchPlaceholder')} />
                        <CommandList>
                            <CommandEmpty>{t('emptySearch')}</CommandEmpty>

                            {/* GRUP 1: ACCIONS */}
                            <CommandGroup>
                                <CommandItem
                                    onSelect={handleManualItemClick}
                                    className="bg-gray-600 text-card"
                                >
                                    <Plus className="mr-2 h-4 w-4" />
                                    <span>{t('addManualItem')}</span>
                                </CommandItem>
                                <p className="py-1"></p>
                                <CommandItem
                                    onSelect={() => setIsCreating(true)}
                                    className="bg-gray-600 text-card"
                                >
                                    <Save className="mr-2 h-4 w-4" />
                                    <span>{t('createNewItem')}</span>
                                </CommandItem>
                            </CommandGroup>

                            {/* GRUP 2: LLISTA DE PRODUCTES */}
                            <CommandGroup>
                                {products.map((product) => (
                                    <CommandItem key={product.id} value={product.name} onSelect={() => handleProductSelectClick(product)}>
                                        <div className="flex justify-between w-full">
                                            <span>{product.name}</span>
                                            <span className="text-muted-foreground">â‚¬{product.price}</span>
                                        </div>
                                    </CommandItem>
                                ))}
                            </CommandGroup>
                        </CommandList>
                    </Command>
                )}
            </PopoverContent>
        </Popover>
    );
};

// =================== FILE: src/components/shared/StatCard.tsx ===================

"use client";
import Link from 'next/link';
import { FC, ElementType } from 'react';
import { ArrowRight } from 'lucide-react';
import { cn } from '@/lib/utils/utils'; // âœ… AFEGEIX AQUESTA LÃNIA

interface StatCardProps {
  href: string;
  icon: ElementType;
  title: string;
  value: string;
  color: string;
  openText: string;
}

export const StatCard: FC<StatCardProps> = ({ href, icon: Icon, title, value, color, openText }) => (
  <Link href={href} className="group block rounded-xl border bg-card text-card-foreground shadow-sm transition-all hover:border-primary/50 hover:shadow-md">
    <div className="p-5">
      <div className="flex items-start justify-between">
        <div className="flex flex-col">
          <p className="text-sm font-medium text-muted-foreground">{title}</p>
          <span className="mt-1 text-2xl font-bold tracking-tight text-foreground">{value}</span>
        </div>
        <div className={cn("rounded-lg p-2", color.replace('text-', 'bg-') + '/10')}>
            <Icon className={cn("h-6 w-6", color)} />
        </div>
      </div>
      <div className="mt-4 flex items-center text-xs font-medium text-muted-foreground transition-colors group-hover:text-primary">
        {openText} <ArrowRight className="w-3.5 h-3.5 ml-1" />
      </div>
    </div>
  </Link>
);

// =================== FILE: src/components/shared/StatusBadge.tsx ===================

/**
 * @file StatusBadge.tsx
 * @summary Muestra una etiqueta de estado coloreada y traducida. Reutilizable para presupuestos, oportunidades, etc.
 */
"use client";

import { FC } from 'react';
import { useTranslations } from 'next-intl';

export const StatusBadge: FC<{ status?: string | null }> = ({ status }) => {
    const t = useTranslations('ContactDetailPage.status');
    
    // 1. Establecemos valores por defecto para el texto y el color.
    let colorClass = 'bg-muted text-muted-foreground';
    let text = status || t('notAvailable');

    // 2. Usamos el 'switch' para asignar el texto traducido y el color a la vez,
    //    basÃ¡ndonos en el valor que viene de la base de datos.
    switch (status?.toLowerCase()) {
        case 'draft':
            text = t('draft');
            colorClass = 'bg-yellow-500/10 text-yellow-500';
            break;
        case 'sent':
            text = t('sent');
            colorClass = 'bg-blue-500/10 text-blue-500';
            break;
        case 'accepted':
        case 'guanyat': // Mantenemos alias si vienen de la BD
        case 'paid':
            text = t('wonPaid');
            colorClass = 'bg-green-500/10 text-green-500';
            break;
        case 'declined':
        case 'perdut':
            text = t('rejected');
            colorClass = 'bg-red-500/10 text-red-500';
            break;
        case 'negociaciÃ³':
            text = t('negotiation');
            colorClass = 'bg-purple-500/10 text-purple-500';
            break;
        case 'overdue':
            text = t('overdue');
            colorClass = 'bg-orange-500/10 text-orange-500';
            break;
    }

    // 3. Renderizamos el resultado final.
    return <span className={`px-2.5 py-1 text-xs font-bold rounded-full ${colorClass}`}>{text}</span>;
};

// =================== FILE: src/components/shared/SupplierCombobox.tsx ===================

"use client";

import * as React from "react";
import { Check, ChevronsUpDown } from "lucide-react";
import { cn } from "@/lib/utils/utils";
import { Button } from "@/components/ui/button";
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from "@/components/ui/command";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";
import { type Supplier } from '@/types/finances/suppliers';
import { useTranslations } from "next-intl";
// âœ… Assegura't que la ruta d'importaciÃ³ ara apunta a la nova ubicaciÃ³ (suppliers)
import { searchSuppliers } from "@/app/[locale]/(app)/finances/suppliers/actions"; 

interface SupplierComboboxProps {
    // âœ… Props per a Formularis NO CONTROLATS (com el de contactes)
    name?: string; // Per al camp 'hidden' que recollirÃ  FormData
    defaultValue?: string | null; // El valor inicial (supplier_id)

    // âœ… Props per a Formularis CONTROLATS (com el de despeses)
    value?: string | null;
    onChange?: (value: string | null) => void;
    
    // Props generals
    initialSupplier: Pick<Supplier, 'id' | 'nom'> | null;
    disabled?: boolean;
}

export function SupplierCombobox({ 
    name, 
    defaultValue, 
    value: controlledValue, 
    onChange: controlledOnChange, 
    initialSupplier, 
    disabled 
}: SupplierComboboxProps) {
    
    const t = useTranslations('ExpenseDetailPage'); // Pots canviar el context de traducciÃ³ si vols
    const [open, setOpen] = React.useState(false);
    
    // --- LÃ²gica d'estat (Controlat vs. No Controlat) ---
    // Si 'defaultValue' existeix, el component gestiona el seu propi estat (no controlat)
    const [internalValue, setInternalValue] = React.useState(defaultValue ?? null);
    
    const isControlled = controlledValue !== undefined;
    const value = isControlled ? controlledValue : internalValue;
    
    const setValue = (newValue: string | null) => {
        if (isControlled) {
            controlledOnChange?.(newValue);
        } else {
            setInternalValue(newValue);
        }
    };
    // --- Fi LÃ²gica d'estat ---

    const [suppliers, setSuppliers] = React.useState<Pick<Supplier, 'id' | 'nom'>[]>(
        initialSupplier ? [initialSupplier] : []
    );
    
    // Troba el proveÃ¯dor seleccionat (objecte)
    const selectedSupplier = suppliers.find(s => s.id === value) || null;
    
    const [searchTerm, setSearchTerm] = React.useState(initialSupplier?.nom ?? "");

    // Cerca asÃ­ncrona (es queda igual que abans)
    React.useEffect(() => {
        if (!open) return;
        const fetchSuppliers = async () => {
            const results = await searchSuppliers(searchTerm);
            if (initialSupplier && !results.find(s => s.id === initialSupplier.id)) {
                 setSuppliers([initialSupplier, ...results]);
            } else {
                 setSuppliers(results);
            }
        };
        const timer = setTimeout(fetchSuppliers, 300);
        return () => clearTimeout(timer);
    }, [searchTerm, open, initialSupplier]);

    return (
        <Popover open={open} onOpenChange={setOpen}>
            
            {/* âœ… AQUESTA Ã‰S LA PART CLAU PER A FormData */}
            {/* Un camp ocult que desa l'ID seleccionat. El <form> el llegirÃ . */}
            {name && (
                <input 
                    type="hidden" 
                    name={name} 
                    value={value ?? ""} 
                />
            )}

            <PopoverTrigger asChild>
                <Button
                    variant="outline"
                    role="combobox"
                    aria-expanded={open}
                    className="w-full justify-between"
                    disabled={disabled}
                >
                    {selectedSupplier
                        ? selectedSupplier.nom
                        : t('select.selectSupplier')}
                    <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                </Button>
            </PopoverTrigger>
            <PopoverContent className="w-[--radix-popover-trigger-width] p-0">
                <Command>
                    <CommandInput 
                        placeholder={t('select.searchSupplier')}
                        onValueChange={setSearchTerm}
                    />
                    <CommandList>
                        <CommandEmpty>{t('select.noSupplierFound')}</CommandEmpty>
                        <CommandGroup>
                            <CommandItem
                                onSelect={() => {
                                    setValue(null); // Utilitzem el nostre 'setValue'
                                    setOpen(false);
                                }}
                            >
                                {t('select.noSupplier')}
                            </CommandItem>
                            
                            {suppliers.map((supplier) => (
                                <CommandItem
                                    key={supplier.id}
                                    value={supplier.nom}
                                    onSelect={() => {
                                        setValue(supplier.id); // Utilitzem el nostre 'setValue'
                                        setOpen(false);
                                    }}
                                >
                                    <Check
                                        className={cn(
                                            "mr-2 h-4 w-4",
                                            value === supplier.id ? "opacity-100" : "opacity-0"
                                        )}
                                    />
                                    {supplier.nom}
                                </CommandItem>
                            ))}
                        </CommandGroup>
                    </CommandList>
                </Command>
            </PopoverContent>
        </Popover>
    );
}

// =================== FILE: src/components/theme-provider.tsx ===================

/**
 * @file theme-provider.tsx
 * @summary Aquest fitxer defineix un component embolcall (wrapper) per al proveÃ¯dor de temes de 'next-themes'.
 * La seva funciÃ³ Ã©s configurar i proporcionar el context del tema (clar/fosc) a tota l'aplicaciÃ³.
 * Crear aquest component separat Ã©s una bona prÃ ctica recomanada per 'next-themes' per assegurar
 * que nomÃ©s el proveÃ¯dor sigui un component de client, permetent que la resta del layout pugui ser un component de servidor.
 */

"use client";

import * as React from "react";
import { ThemeProvider as NextThemesProvider } from "next-themes";

// En lloc de definir els tipus de les propietats manualment, els inferim directament del component
// 'NextThemesProvider'. AixÃ² Ã©s una prÃ ctica robusta que assegura que els nostres tipus
// sempre estaran sincronitzats amb els de la llibreria.
type ThemeProviderProps = React.ComponentProps<typeof NextThemesProvider>;

/**
 * @function ThemeProvider
 * @summary El component que embolcalla l'aplicaciÃ³ per proporcionar el context del tema.
 * @param {React.ReactNode} children - Els components fills que tindran accÃ©s al context del tema.
 * @param {ThemeProviderProps} props - La resta de propietats que es passaran al proveÃ¯dor de 'next-themes'.
 */
export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
Â  return <NextThemesProvider {...props}>{children}</NextThemesProvider>;
}


// =================== FILE: src/components/ThemeSwitcher.tsx ===================

"use client";

import * as React from "react";
import { useTheme } from "next-themes";
import { motion, AnimatePresence } from "framer-motion";
import { Sun, Moon } from "lucide-react";
import { Button } from "@/components/ui/button";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "@/components/ui/tooltip";
import { useTranslations } from "next-intl";

export function ThemeSwitcher() {
  const { theme, setTheme } = useTheme();
  const [mounted, setMounted] = React.useState(false);
  const t = useTranslations('LandingNav.themeSwitcher');

  // PER QUÃˆ: Ens assegurem que el component estigui muntat al client
  // abans de llegir el 'theme', per evitar hydration mismatch.
  React.useEffect(() => {
    setMounted(true);
  }, []);

  const toggleTheme = () => {
    setTheme(theme === "dark" ? "light" : "dark");
  };

  // Determinem el tema actual (ignorem "system" per a aquest toggle simple)
  const isDarkMode = theme === "dark";

  // Retornem un 'skeleton' mentre no estigui muntat
  if (!mounted) {
    return <div className="w-9 h-9" />; // Espai reservat
  }

  return (
    <TooltipProvider delayDuration={100}>
      <Tooltip>
        <TooltipTrigger asChild>
          <Button
            variant="ghost"
            size="icon"
            onClick={toggleTheme}
            aria-label={isDarkMode ? t('light') : t('dark')}
            className="relative w-9 h-9" // Assegurem la mida
          >
            <AnimatePresence initial={false} mode="wait">
              {isDarkMode ? (
                // Si Ã©s FOSC, mostrem la icona del SOL
                <motion.div
                  key="sun"
                  initial={{ opacity: 0, scale: 0.8, rotate: -90 }}
                  animate={{ opacity: 1, scale: 1, rotate: 0 }}
                  exit={{ opacity: 0, scale: 0.8, rotate: 90 }}
                  transition={{ duration: 0.2, ease: "easeOut" }}
                  className="absolute"
                >
                  <Sun className="w-5 h-5" />
                </motion.div>
              ) : (
                // Si Ã©s CLAR, mostrem la icona de la LLUNA
                <motion.div
                  key="moon"
                  initial={{ opacity: 0, scale: 0.8, rotate: 90 }}
                  animate={{ opacity: 1, scale: 1, rotate: 0 }}
                  exit={{ opacity: 0, scale: 0.8, rotate: -90 }}
                  transition={{ duration: 0.2, ease: "easeOut" }}
                  className="absolute"
                >
                  <Moon className="w-5 h-5" />
                </motion.div>
              )}
            </AnimatePresence>
          </Button>
        </TooltipTrigger>
        <TooltipContent>
          {isDarkMode ? t('light') : t('dark')}
        </TooltipContent>
      </Tooltip>
    </TooltipProvider>
  );
}

// =================== FILE: src/components/ui/accordion.tsx ===================

"use client"

import * as React from "react"
import * as AccordionPrimitive from "@radix-ui/react-accordion"
import { cn } from "@/lib/utils/utils"
import { ChevronDownIcon } from "@radix-ui/react-icons"

const Accordion = AccordionPrimitive.Root

const AccordionItem = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
>(({ className, ...props }, ref) => (
  <AccordionPrimitive.Item
    ref={ref}
    className={cn("border-b", className)}
    {...props}
  />
))
AccordionItem.displayName = "AccordionItem"

const AccordionTrigger = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Header className="flex">
    <AccordionPrimitive.Trigger
      ref={ref}
      className={cn(
        "flex flex-1 items-center justify-between py-4 text-sm font-medium transition-all hover:underline text-left [&[data-state=open]>svg]:rotate-180",
        className
      )}
      {...props}
    >
      {children}
      <ChevronDownIcon className="h-4 w-4 shrink-0 text-muted-foreground transition-transform duration-200" />
    </AccordionPrimitive.Trigger>
  </AccordionPrimitive.Header>
))
AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName

const AccordionContent = React.forwardRef<
  React.ElementRef<typeof AccordionPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <AccordionPrimitive.Content
    ref={ref}
    className="overflow-hidden text-sm data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
    {...props}
  >
    <div className={cn("pb-4 pt-0", className)}>{children}</div>
  </AccordionPrimitive.Content>
))
AccordionContent.displayName = AccordionPrimitive.Content.displayName

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }


// =================== FILE: src/components/ui/alert-dialog.tsx ===================

"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils/utils"
import { buttonVariants } from "@/components/ui/button"

const AlertDialog = AlertDialogPrimitive.Root

const AlertDialogTrigger = AlertDialogPrimitive.Trigger

const AlertDialogPortal = AlertDialogPrimitive.Portal

const AlertDialogOverlay = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
AlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName

const AlertDialogContent = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>
>(({ className, ...props }, ref) => (
  <AlertDialogPortal>
    <AlertDialogOverlay />
    <AlertDialogPrimitive.Content
      ref={ref}
      className={cn(
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    />
  </AlertDialogPortal>
))
AlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName

const AlertDialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
AlertDialogHeader.displayName = "AlertDialogHeader"

const AlertDialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
AlertDialogFooter.displayName = "AlertDialogFooter"

const AlertDialogTitle = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold", className)}
    {...props}
  />
))
AlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName

const AlertDialogDescription = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
AlertDialogDescription.displayName =
  AlertDialogPrimitive.Description.displayName

const AlertDialogAction = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Action>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Action
    ref={ref}
    className={cn(buttonVariants(), className)}
    {...props}
  />
))
AlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName

const AlertDialogCancel = React.forwardRef<
  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,
  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>
>(({ className, ...props }, ref) => (
  <AlertDialogPrimitive.Cancel
    ref={ref}
    className={cn(
      buttonVariants({ variant: "outline" }),
      "mt-2 sm:mt-0",
      className
    )}
    {...props}
  />
))
AlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}


// =================== FILE: src/components/ui/alert.tsx ===================

import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground [&>svg~*]:pl-7",
  {
    variants: {
      variant: {
        default: "bg-background text-foreground",
        destructive:
          "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

const Alert = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>
>(({ className, variant, ...props }, ref) => (
  <div
    ref={ref}
    role="alert"
    className={cn(alertVariants({ variant }), className)}
    {...props}
  />
))
Alert.displayName = "Alert"

const AlertTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h5
    ref={ref}
    className={cn("mb-1 font-medium leading-none tracking-tight", className)}
    {...props}
  />
))
AlertTitle.displayName = "AlertTitle"

const AlertDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm [&_p]:leading-relaxed", className)}
    {...props}
  />
))
AlertDescription.displayName = "AlertDescription"

export { Alert, AlertTitle, AlertDescription }


// =================== FILE: src/components/ui/avatar.tsx ===================

"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils/utils"

const Avatar = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",
      className
    )}
    {...props}
  />
))
Avatar.displayName = AvatarPrimitive.Root.displayName

const AvatarImage = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Image>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Image
    ref={ref}
    className={cn("aspect-square h-full w-full", className)}
    {...props}
  />
))
AvatarImage.displayName = AvatarPrimitive.Image.displayName

const AvatarFallback = React.forwardRef<
  React.ElementRef<typeof AvatarPrimitive.Fallback>,
  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>
>(({ className, ...props }, ref) => (
  <AvatarPrimitive.Fallback
    ref={ref}
    className={cn(
      "flex h-full w-full items-center justify-center rounded-full bg-muted",
      className
    )}
    {...props}
  />
))
AvatarFallback.displayName = AvatarPrimitive.Fallback.displayName

export { Avatar, AvatarImage, AvatarFallback }


// =================== FILE: src/components/ui/badge.jsx ===================

import * as React from 'react';
import { cva } from 'class-variance-authority';
import { cn } from '@/lib/utils/utils'; // Assegura't que tens aquest arxiu d'ajuda de shadcn

const badgeVariants = cva(
  'inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2',
  {
    variants: {
      variant: {
        default: 'border-transparent bg-primary text-primary-foreground hover:bg-primary/80',
        secondary: 'border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80',
        destructive: 'border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80',
        outline: 'text-foreground',
      },
    },
    defaultVariants: {
      variant: 'default',
    },
  }
);

function Badge({ className, variant, ...props }) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  );
}

export { Badge, badgeVariants };

// =================== FILE: src/components/ui/button.tsx ===================

// src/components/ui/button.tsx

import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default:
          "bg-primary text-primary-foreground shadow hover:bg-primary/90",
        destructive:
          "bg-destructive text-destructive-foreground shadow-sm hover:bg-destructive/90",
        // âœ… CANVI: hover:bg-accent -> hover:bg-muted
        // âœ… CANVI: hover:text-accent-foreground -> hover:text-muted-foreground (o hover:text-foreground si vols el text principal)
        outline:
          "border border-input bg-background shadow-sm hover:bg-muted hover:text-muted-foreground",
        "destructive-outline":
          "border border-destructive bg-transparent text-destructive hover:bg-destructive/10",
        secondary:
          "bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80",
        // âœ… CANVI: hover:bg-accent -> hover:bg-muted
        // âœ… CANVI: hover:text-accent-foreground -> hover:text-muted-foreground (o hover:text-foreground)
        ghost: "hover:bg-muted hover:text-muted-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2",
        sm: "h-8 rounded-md px-3 text-xs",
        lg: "h-10 rounded-md px-8",
        icon: "h-9 w-9",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }; // Eliminat VariantProps de l'exportaciÃ³ directa si no s'usa fora

// Re-exporta VariantProps per separat si cal
export type { VariantProps };

// =================== FILE: src/components/ui/calendar.tsx ===================

import * as React from "react"
import {
  ChevronDownIcon,
  ChevronLeftIcon,
  ChevronRightIcon,
} from "lucide-react"
// âœ… 1. IMPORTEM 'CalendarDay' I CANVIEM 'DayModifiers' PER 'Modifiers'
import { DayPicker, getDefaultClassNames, Modifiers, CalendarDay } from "react-day-picker";

import { cn } from "@/lib/utils/utils"
import { Button, buttonVariants, type VariantProps } from "@/components/ui/button"

export type CalendarProps = React.ComponentProps<typeof DayPicker> & {
  buttonVariant?: VariantProps<typeof buttonVariants>["variant"];
};

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  captionLayout = "label",
  buttonVariant = "ghost",
  formatters,
  components,
  ...props
}: CalendarProps) {
  const defaultClassNames = getDefaultClassNames()

  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn(
        "bg-background group/calendar p-3 [--cell-size:2rem] [[data-slot=card-content]_&]:bg-transparent [[data-slot=popover-content]_&]:bg-transparent",
        String.raw`rtl:**:[.rdp-button\_next>svg]:rotate-180`,
        String.raw`rtl:**:[.rdp-button\_previous>svg]:rotate-180`,
        className
      )}
      captionLayout={captionLayout}
      formatters={{
        formatMonthDropdown: (date) =>
          date.toLocaleString("default", { month: "short" }),
        ...formatters,
      }}
      classNames={{
        root: cn("w-fit", defaultClassNames.root),
        months: cn("relative flex flex-col gap-4 md:flex-row", defaultClassNames.months),
        month: cn("flex w-full flex-col gap-4", defaultClassNames.month),
        nav: cn(
          "absolute inset-x-0 top-0 flex w-full items-center justify-between gap-1",
          defaultClassNames.nav
        ),
        button_previous: cn(
          buttonVariants({ variant: buttonVariant }),
          "h-[--cell-size] w-[--cell-size] select-none p-0 aria-disabled:opacity-50",
          defaultClassNames.button_previous
        ),
        button_next: cn(
          buttonVariants({ variant: buttonVariant }),
          "h-[--cell-size] w-[--cell-size] select-none p-0 aria-disabled:opacity-50",
          defaultClassNames.button_next
        ),
        month_caption: cn(
          "flex h-[--cell-size] w-full items-center justify-center px-[--cell-size]",
          defaultClassNames.month_caption
        ),
        dropdowns: cn(
          "flex h-[--cell-size] w-full items-center justify-center gap-1.5 text-sm font-medium",
          defaultClassNames.dropdowns
        ),
        dropdown_root: cn(
          "has-focus:border-ring border-input shadow-xs has-focus:ring-ring/50 has-focus:ring-[3px] relative rounded-md border",
          defaultClassNames.dropdown_root
        ),
        dropdown: cn("bg-popover absolute inset-0 opacity-0", defaultClassNames.dropdown),
        caption_label: cn("select-none font-medium", captionLayout === "label"
          ? "text-sm"
          : "[&>svg]:text-muted-foreground flex h-8 items-center gap-1 rounded-md pl-2 pr-1 text-sm [&>svg]:size-3.5", defaultClassNames.caption_label),
        table: "w-full border-collapse",
        weekdays: cn("flex", defaultClassNames.weekdays),
        weekday: cn(
          "text-muted-foreground flex-1 select-none rounded-md text-[0.8rem] font-normal",
          defaultClassNames.weekday
        ),
        week: cn("mt-2 flex w-full", defaultClassNames.week),
        week_number_header: cn("w-[--cell-size] select-none", defaultClassNames.week_number_header),
        week_number: cn(
          "text-muted-foreground select-none text-[0.8rem]",
          defaultClassNames.week_number
        ),
        day: cn(
          "group/day relative aspect-square h-full w-full select-none p-0 text-center [&:first-child[data-selected=true]_button]:rounded-l-md [&:last-child[data-selected=true]_button]:rounded-r-md",
          defaultClassNames.day
        ),
        range_start: cn("bg-accent rounded-l-md", defaultClassNames.range_start),
        range_middle: cn("rounded-none", defaultClassNames.range_middle),
        range_end: cn("bg-accent rounded-r-md", defaultClassNames.range_end),
        today: cn(
          "bg-accent text-accent-foreground rounded-md data-[selected=true]:rounded-none",
          defaultClassNames.today
        ),
        outside: cn(
          "text-muted-foreground aria-selected:text-muted-foreground",
          defaultClassNames.outside
        ),
        disabled: cn("text-muted-foreground opacity-50", defaultClassNames.disabled),
        hidden: cn("invisible", defaultClassNames.hidden),
        ...classNames,
      }}
      components={{
        // Dins de calendar.tsx
        Root: ({ className, ...props }) => {
          // 1. Separem 'rootRef' de la resta de props.
          const { rootRef, ...rest } = props as { rootRef?: React.Ref<HTMLDivElement> };
          
          // 2. Usem 'rootRef' a la prop 'ref' i passem la resta de props.
          return (<div ref={rootRef} data-slot="calendar" className={cn(className)} {...rest} />);
        },
        // âœ… 2. AFEGIM "up" A LES ORIENTACIONS PERMESES
        Chevron: ({ className, orientation }: { className?: string; orientation?: "left" | "right" | "down" | "up" }) => {
          if (orientation === "left") {
            return (<ChevronLeftIcon className={cn("size-4", className)} />);
          }
          if (orientation === "right") {
            return (<ChevronRightIcon className={cn("size-4", className)} />);
          }
          if (orientation === "up") {
             // Pots canviar aquesta icona si vols una fletxa cap amunt
            return (<ChevronDownIcon className={cn("size-4 rotate-180", className)} />);
          }
          return (<ChevronDownIcon className={cn("size-4", className)} />);
        },
        DayButton: CalendarDayButton,
        WeekNumber: ({ children, ...props }: { children?: React.ReactNode }) => {
          return (
            <td {...props}>
              <div
                className="flex size-[--cell-size] items-center justify-center text-center">
                {children}
              </div>
            </td>
          );
        },
        ...components,
      }}
      {...props} />
  );
}
Calendar.displayName = "Calendar";


interface CalendarDayButtonProps extends React.HTMLAttributes<HTMLButtonElement> {
  // âœ… 3. CANVIEM 'Date' PER 'CalendarDay'
  day: CalendarDay;
  modifiers: Modifiers;
}

function CalendarDayButton({
  className,
  day,
  modifiers,
  ...props
}: CalendarDayButtonProps) {
  const defaultClassNames = getDefaultClassNames()
  const ref = React.useRef<HTMLButtonElement>(null);

  React.useEffect(() => {
    if (modifiers.focused && ref.current) {
      ref.current.focus();
    }
  }, [modifiers.focused]);

  return (
    <Button
      ref={ref}
      variant="ghost"
      size="icon"
      // âœ… 4. ACCEDIM A LA DATA REAL A TRAVÃ‰S DE 'day.date'
      data-day={day.date.toLocaleDateString()}
      data-selected-single={
        modifiers.selected &&
        !modifiers.range_start &&
        !modifiers.range_end &&
        !modifiers.range_middle
      }
      data-range-start={modifiers.range_start}
      data-range-end={modifiers.range_end}
      data-range-middle={modifiers.range_middle}
      className={cn(
        "data-[selected-single=true]:bg-primary data-[selected-single=true]:text-primary-foreground data-[range-middle=true]:bg-accent data-[range-middle=true]:text-accent-foreground data-[range-start=true]:bg-primary data-[range-start=true]:text-primary-foreground data-[range-end=true]:bg-primary data-[range-end=true]:text-primary-foreground group-data-[focused=true]/day:border-ring group-data-[focused=true]/day:ring-ring/50 flex aspect-square h-auto w-full min-w-[--cell-size] flex-col gap-1 font-normal leading-none data-[range-end=true]:rounded-md data-[range-middle=true]:rounded-none data-[range-start=true]:rounded-md group-data-[focused=true]/day:relative group-data-[focused=true]/day:z-10 group-data-[focused=true]/day:ring-[3px] [&>span]:text-xs [&>span]:opacity-70",
        defaultClassNames.day,
        className
      )}
      {...props} />
  );
}
CalendarDayButton.displayName = "CalendarDayButton";

export { Calendar, CalendarDayButton }

// =================== FILE: src/components/ui/card.tsx ===================

import * as React from "react"

import { cn } from "@/lib/utils/utils"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn(
      "rounded-xl border bg-card text-card-foreground shadow",
      className
    )}
    {...props}
  />
))
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("font-semibold leading-none tracking-tight", className)}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }


// =================== FILE: src/components/ui/checkbox.tsx ===================

"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { CheckIcon } from "lucide-react"

import { cn } from "@/lib/utils/utils"

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "peer border-input dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator
        data-slot="checkbox-indicator"
        className="flex items-center justify-center text-current transition-none"
      >
        <CheckIcon className="size-3.5" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}

export { Checkbox }


// =================== FILE: src/components/ui/collapsible.tsx ===================

"use client"

import * as CollapsiblePrimitive from "@radix-ui/react-collapsible"

const Collapsible = CollapsiblePrimitive.Root

const CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger

const CollapsibleContent = CollapsiblePrimitive.CollapsibleContent

export { Collapsible, CollapsibleTrigger, CollapsibleContent }


// =================== FILE: src/components/ui/command.tsx ===================

"use client"

import * as React from "react"
import { Command as CommandPrimitive } from "cmdk"
import { Search as SearchIcon } from "lucide-react"

import { cn } from "@/lib/utils/utils"
import {
Â  Dialog,
Â  DialogContent,
Â  DialogHeader,
Â  DialogTitle,
Â  DialogDescription,
} from "@/components/ui/dialog"

const Command = React.forwardRef<
Â  React.ElementRef<typeof CommandPrimitive>,
Â  React.ComponentPropsWithoutRef<typeof CommandPrimitive>
>(({ className, ...props }, ref) => (
Â  <CommandPrimitive
Â  Â  ref={ref}
Â  Â  className={cn(
Â  Â  Â  "flex h-full w-full flex-col overflow-hidden rounded-lg bg-popover text-popover-foreground", // âœ… Augmentat: rounded-lg
Â  Â  Â  className
Â  Â  )}
Â  Â  {...props}
Â  />
))
Command.displayName = CommandPrimitive.displayName

const CommandDialog = ({
Â  children,
Â  title = "Cerca General", // âœ… Canviat tÃ­tol per defecte
Â  description,
Â  ...props
}: React.ComponentProps<typeof Dialog> & { title?: string, description?: string }) => {
Â  return (
Â  Â  <Dialog {...props}>
Â  Â  Â  {/* âœ… Augmentat: sm:max-w-2xl per a un diÃ leg mÃ©s ample */}
Â  Â  Â  <DialogContent className="overflow-hidden p-0 shadow-lg sm:max-w-2xl">
Â  Â  Â  Â  {(title || description) && (
Â  Â  Â  Â  Â  <DialogHeader className="px-4 pt-4">
Â  Â  Â  Â  Â  Â  {title && <DialogTitle>{title}</DialogTitle>}
Â  Â  Â  Â  Â  Â  {description && <DialogDescription>{description}</DialogDescription>}
Â  Â  Â  Â  Â  </DialogHeader>
Â  Â  Â  Â  )}
        {/* âœ… Augmentat padding (px-2.5) i eliminat 'pt-0' per a millor espaiat entre grups */}
Â  Â  Â  Â  <Command className="[&_[cmdk-group-heading]]:px-2.5 [&_[cmdk-group-heading]]:py-2 [&_[cmdk-group-heading]]:font-semibold [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2.5 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
Â  Â  Â  Â  Â  {children}
Â  Â  Â  Â  </Command>
Â  Â  Â  </DialogContent>
Â  Â  </Dialog>
Â  )
}

const CommandInput = React.forwardRef<
Â  React.ElementRef<typeof CommandPrimitive.Input>,
Â  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>
>(({ className, ...props }, ref) => (
Â  <div className="flex items-center border-b px-3.5" cmdk-input-wrapper=""> 
    {/* âœ… Canviat 'opacity-50' per 'text-muted-foreground' */}
Â  Â  <SearchIcon className="mr-2.5 h-4 w-4 shrink-0 text-muted-foreground" />
Â  Â  <CommandPrimitive.Input
Â  Â  Â  ref={ref}
Â  Â  Â  className={cn(
        /* âœ… Augmentat: h-12 per a mÃ©s alÃ§ada */
Â  Â  Â  Â  "flex h-12 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",
Â  Â  Â  Â  className
Â  Â  Â  )}
Â  Â  Â  {...props}
Â  Â  />
Â  </div>
))
CommandInput.displayName = CommandPrimitive.Input.displayName

const CommandList = React.forwardRef<
Â  React.ElementRef<typeof CommandPrimitive.List>,
Â  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>
>(({ className, ...props }, ref) => (
Â  <CommandPrimitive.List
Â  Â  ref={ref}
    /* âœ… Augmentat: max-h-[400px] per a una llista mÃ©s llarga */
Â  Â  className={cn("h-[350px] overflow-y-auto overflow-x-hidden", className)}
Â  Â  {...props}
Â  />
))
CommandList.displayName = CommandPrimitive.List.displayName

const CommandEmpty = React.forwardRef<
Â  React.ElementRef<typeof CommandPrimitive.Empty>,
Â  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>
>((props, ref) => (
Â  <CommandPrimitive.Empty
Â  Â  ref={ref}
Â  Â  className="py-6 text-center text-sm"
Â  Â  {...props}
Â  />
))
CommandEmpty.displayName = CommandPrimitive.Empty.displayName

const CommandGroup = React.forwardRef<
Â  React.ElementRef<typeof CommandPrimitive.Group>,
Â  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>
>(({ className, ...props }, ref) => (
Â  <CommandPrimitive.Group
Â  Â  ref={ref}
Â  Â  className={cn(
      /* âœ… Augmentat: TÃ­tol de grup a 'text-sm' i mÃ©s padding 'py-2.5' */
Â  Â  Â  "bg-card backdrop-blur-sm overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2.5 [&_[cmdk-group-heading]]:py-2.5 [&_[cmdk-group-heading]]:text-sm [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",
Â  Â  Â  className
Â  Â  )}
Â  Â  {...props}
Â  />
))
CommandGroup.displayName = CommandPrimitive.Group.displayName

const CommandSeparator = React.forwardRef<
Â  React.ElementRef<typeof CommandPrimitive.Separator>,
Â  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>
>(({ className, ...props }, ref) => (
Â  <CommandPrimitive.Separator
Â  Â  ref={ref}
Â  Â  className={cn("-mx-1 h-px bg-border", className)}
Â  Â  {...props}
Â  />
))
CommandSeparator.displayName = CommandPrimitive.Separator.displayName

const CommandItem = React.forwardRef<
Â  React.ElementRef<typeof CommandPrimitive.Item>,
Â  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>
>(({ className, ...props }, ref) => (
Â  <CommandPrimitive.Item
Â  Â  ref={ref}
Â  Â  className={cn(
      /* âœ…âœ…âœ… CANVI PRINCIPAL âœ…âœ…âœ… */
      /* - Canviat 'aria-selected:bg-accent' per 'aria-selected:bg-muted' (elimina lila).
        - Canviat 'aria-selected:text-accent-foreground' per 'aria-selected:text-foreground'.
        - Augmentat padding: 'px-2.5 py-2'.
        - Augmentat rounding: 'rounded-md'.
        - Afegit 'transition-colors' per suavitat.
      */
Â  Â  Â  "relative flex cursor-default select-none items-center rounded-md px-2.5 py-2 text-sm outline-none transition-colors aria-selected:bg-muted aria-selected:text-foreground data-[disabled='true']:pointer-events-none data-[disabled='true']:opacity-50",
Â  Â  Â  className
Â  Â  )}
Â  Â  {...props}
Â  />
))
CommandItem.displayName = CommandPrimitive.Item.displayName

const CommandShortcut = ({
Â  className,
Â  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
Â  return (
Â  Â  <span
Â  Â  Â  className={cn(
Â  Â  Â  Â  "ml-auto text-xs tracking-widest text-muted-foreground",
Â  Â  Â  Â  className
Â  Â  Â  )}
Â  Â  Â  {...props}
Â  Â  />
Â  )
}
CommandShortcut.displayName = "CommandShortcut"

export {
Â  Command,
Â  CommandDialog,
Â  CommandInput,
Â  CommandList,
Â  CommandEmpty,
Â  CommandGroup,
Â  CommandItem,
Â  CommandShortcut,
Â  CommandSeparator,
}

// =================== FILE: src/components/ui/dialog.tsx ===================

// Ruta del fitxer: src/components/ui/dialog.tsx
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { X as XIcon } from "lucide-react"

import { cn } from "@/lib/utils/utils"

const Dialog = DialogPrimitive.Root
const DialogTrigger = DialogPrimitive.Trigger
const DialogPortal = DialogPrimitive.Portal
const DialogClose = DialogPrimitive.Close

const DialogOverlay = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Overlay
    ref={ref}
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
  />
))
DialogOverlay.displayName = DialogPrimitive.Overlay.displayName

const DialogContent = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DialogPortal>
    <DialogOverlay />
    <DialogPrimitive.Content
      ref={ref}
      className={cn(
        // âœ… CORRECCIÃ“: Restaurem l'amplada mÃ xima per defecte (max-w-lg)
        "fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",
        className
      )}
      {...props}
    >
      {children}
      <DialogPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground">
        <XIcon className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </DialogPrimitive.Close>
    </DialogPrimitive.Content>
  </DialogPortal>
))
DialogContent.displayName = DialogPrimitive.Content.displayName

const DialogHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-1.5 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
DialogHeader.displayName = "DialogHeader"

const DialogFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
DialogFooter.displayName = "DialogFooter"

const DialogTitle = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DialogTitle.displayName = DialogPrimitive.Title.displayName

const DialogDescription = React.forwardRef<
  React.ElementRef<typeof DialogPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DialogPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DialogDescription.displayName = DialogPrimitive.Description.displayName

export {
  Dialog,
  DialogTrigger,
  DialogContent,
  DialogHeader,
  DialogFooter,
  DialogTitle,
  DialogDescription,
  DialogClose,
  DialogPortal,
  DialogOverlay
}



// =================== FILE: src/components/ui/drawer.tsx ===================

"use client"

import * as React from "react"
import { Drawer as DrawerPrimitive } from "vaul"

import { cn } from "@/lib/utils/utils"

const Drawer = ({
  shouldScaleBackground = true,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (
  <DrawerPrimitive.Root
    shouldScaleBackground={shouldScaleBackground}
    {...props}
  />
)
Drawer.displayName = "Drawer"

const DrawerTrigger = DrawerPrimitive.Trigger

const DrawerPortal = DrawerPrimitive.Portal

const DrawerClose = DrawerPrimitive.Close

const DrawerOverlay = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Overlay
    ref={ref}
    className={cn("fixed inset-0 z-50 bg-black/80", className)}
    {...props}
  />
))
DrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName

const DrawerContent = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>
>(({ className, children, ...props }, ref) => (
  <DrawerPortal>
    <DrawerOverlay />
    <DrawerPrimitive.Content
      ref={ref}
      className={cn(
        "fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background",
        className
      )}
      {...props}
    >
      <div className="mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted" />
      {children}
    </DrawerPrimitive.Content>
  </DrawerPortal>
))
DrawerContent.displayName = "DrawerContent"

const DrawerHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn("grid gap-1.5 p-4 text-center sm:text-left", className)}
    {...props}
  />
)
DrawerHeader.displayName = "DrawerHeader"

const DrawerFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn("mt-auto flex flex-col gap-2 p-4", className)}
    {...props}
  />
)
DrawerFooter.displayName = "DrawerFooter"

const DrawerTitle = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Title
    ref={ref}
    className={cn(
      "text-lg font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
DrawerTitle.displayName = DrawerPrimitive.Title.displayName

const DrawerDescription = React.forwardRef<
  React.ElementRef<typeof DrawerPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>
>(({ className, ...props }, ref) => (
  <DrawerPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
DrawerDescription.displayName = DrawerPrimitive.Description.displayName

export {
  Drawer,
  DrawerPortal,
  DrawerOverlay,
  DrawerTrigger,
  DrawerClose,
  DrawerContent,
  DrawerHeader,
  DrawerFooter,
  DrawerTitle,
  DrawerDescription,
}


// =================== FILE: src/components/ui/dropdown-menu.tsx ===================

"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { cn } from "@/lib/utils/utils"
import { CheckIcon, ChevronRightIcon, DotFilledIcon } from "@radix-ui/react-icons"

const DropdownMenu = DropdownMenuPrimitive.Root

const DropdownMenuTrigger = DropdownMenuPrimitive.Trigger

const DropdownMenuGroup = DropdownMenuPrimitive.Group

const DropdownMenuPortal = DropdownMenuPrimitive.Portal

const DropdownMenuSub = DropdownMenuPrimitive.Sub

const DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup

const DropdownMenuSubTrigger = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {
    inset?: boolean
  }
>(({ className, inset, children, ...props }, ref) => (
  <DropdownMenuPrimitive.SubTrigger
    ref={ref}
    className={cn(
      "flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  >
    {children}
    <ChevronRightIcon className="ml-auto" />
  </DropdownMenuPrimitive.SubTrigger>
))
DropdownMenuSubTrigger.displayName =
  DropdownMenuPrimitive.SubTrigger.displayName

const DropdownMenuSubContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.SubContent
    ref={ref}
    className={cn(
      "z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",
      className
    )}
    {...props}
  />
))
DropdownMenuSubContent.displayName =
  DropdownMenuPrimitive.SubContent.displayName

const DropdownMenuContent = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <DropdownMenuPrimitive.Portal>
    <DropdownMenuPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md",
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]",
        className
      )}
      {...props}
    />
  </DropdownMenuPrimitive.Portal>
))
DropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName

const DropdownMenuItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName

const DropdownMenuCheckboxItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>
>(({ className, children, checked, ...props }, ref) => (
  <DropdownMenuPrimitive.CheckboxItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    checked={checked}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <CheckIcon className="h-4 w-4" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.CheckboxItem>
))
DropdownMenuCheckboxItem.displayName =
  DropdownMenuPrimitive.CheckboxItem.displayName

const DropdownMenuRadioItem = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>
>(({ className, children, ...props }, ref) => (
  <DropdownMenuPrimitive.RadioItem
    ref={ref}
    className={cn(
      "relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute left-2 flex h-3.5 w-3.5 items-center justify-center">
      <DropdownMenuPrimitive.ItemIndicator>
        <DotFilledIcon className="h-2 w-2 fill-current" />
      </DropdownMenuPrimitive.ItemIndicator>
    </span>
    {children}
  </DropdownMenuPrimitive.RadioItem>
))
DropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName

const DropdownMenuLabel = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {
    inset?: boolean
  }
>(({ className, inset, ...props }, ref) => (
  <DropdownMenuPrimitive.Label
    ref={ref}
    className={cn(
      "px-2 py-1.5 text-sm font-semibold",
      inset && "pl-8",
      className
    )}
    {...props}
  />
))
DropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName

const DropdownMenuSeparator = React.forwardRef<
  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <DropdownMenuPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
DropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName

const DropdownMenuShortcut = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLSpanElement>) => {
  return (
    <span
      className={cn("ml-auto text-xs tracking-widest opacity-60", className)}
      {...props}
    />
  )
}
DropdownMenuShortcut.displayName = "DropdownMenuShortcut"

export {
  DropdownMenu,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuGroup,
  DropdownMenuPortal,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuRadioGroup,
}


// =================== FILE: src/components/ui/form.tsx ===================

"use client";

import * as React from "react";
import * as LabelPrimitive from "@radix-ui/react-label";
import { Slot } from "@radix-ui/react-slot";
import {
  Controller,
  FormProvider,
  useFormContext,
  type ControllerProps,
  type FieldPath,
  type FieldValues,
  type UseFormReturn,
} from "react-hook-form";

import { cn } from "@/lib/utils/utils";
import { Label } from "@/components/ui/label";

// Tipus del formulari amb genÃ¨rics
type TypedFormProps<TFieldValues extends FieldValues = FieldValues> = {
  children?: React.ReactNode;
} & UseFormReturn<TFieldValues>;

// Wrapper tipat que assegura compatibilitat amb react-hook-form
const Form = <TFieldValues extends FieldValues = FieldValues>({
  children,
  ...methods
}: TypedFormProps<TFieldValues>) => {
  return (
    <FormProvider {...(methods as UseFormReturn<TFieldValues>)}>
      {children}
    </FormProvider>
  );
};

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
> = {
  name: TName;
};

const FormFieldContext = React.createContext<FormFieldContextValue | null>(
  null
);

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>
>(
  props: ControllerProps<TFieldValues, TName>
) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  );
};

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext);
  const itemContext = React.useContext(FormItemContext);
  const { getFieldState, formState } = useFormContext();

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>");
  }

  if (!itemContext) {
    throw new Error("useFormField should be used within <FormItem>");
  }

  const fieldState = getFieldState(fieldContext.name, formState);
  const { id } = itemContext;

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  };
};

type FormItemContextValue = {
  id: string;
};

const FormItemContext = React.createContext<FormItemContextValue | null>(null);

const FormItem = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const id = React.useId();

  return (
    <FormItemContext.Provider value={{ id }}>
      <div ref={ref} className={cn("space-y-2", className)} {...props} />
    </FormItemContext.Provider>
  );
});
FormItem.displayName = "FormItem";

const FormLabel = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>
>(({ className, ...props }, ref) => {
  const { error, formItemId } = useFormField();

  return (
    <Label
      ref={ref}
      className={cn(error && "text-destructive", className)}
      htmlFor={formItemId}
      {...props}
    />
  );
});
FormLabel.displayName = "FormLabel";

const FormControl = React.forwardRef<
  React.ElementRef<typeof Slot>,
  React.ComponentPropsWithoutRef<typeof Slot>
>(({ ...props }, ref) => {
  const { error, formItemId, formDescriptionId, formMessageId } =
    useFormField();

  return (
    <Slot
      ref={ref}
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  );
});
FormControl.displayName = "FormControl";

const FormDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => {
  const { formDescriptionId } = useFormField();

  return (
    <p
      ref={ref}
      id={formDescriptionId}
      className={cn("text-[0.8rem] text-muted-foreground", className)}
      {...props}
    />
  );
});
FormDescription.displayName = "FormDescription";

const FormMessage = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, children, ...props }, ref) => {
  const { error, formMessageId } = useFormField();
  const body = error ? String(error?.message ?? "") : children;

  if (!body) return null;

  return (
    <p
      ref={ref}
      id={formMessageId}
      className={cn("text-[0.8rem] font-medium text-destructive", className)}
      {...props}
    >
      {body}
    </p>
  );
});
FormMessage.displayName = "FormMessage";

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
};


// =================== FILE: src/components/ui/index.tsx ===================

export * from "./button";
export * from "./input";
export * from "./card";
export * from "./select";
export * from "./avatar";
export * from "./badge";
export * from "./tooltip";
export * from "./checkbox";
export * from "./tabs";
export * from "./alert-dialog";
export * from "./separator";
export * from "./dialog";
export * from "./scroll-area";
export * from "./popover";
export * from "./switch";


// =================== FILE: src/components/ui/input.tsx ===================

import * as React from "react"
import { cn } from "@/lib/utils/utils"

// Canviem la interfÃ­cie buida per un 'type' directe.
// AixÃ² soluciona l'error '@typescript-eslint/no-empty-object-type'.
export type InputProps = React.InputHTMLAttributes<HTMLInputElement>

const Input = React.forwardRef<HTMLInputElement, InputProps>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)

Input.displayName = "Input"

export { Input }

// =================== FILE: src/components/ui/label.tsx ===================

"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"

import { cn } from "@/lib/utils/utils"

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  )
}

export { Label }


// =================== FILE: src/components/ui/LegalModalTrigger.tsx ===================

"use client"

import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
  DialogClose,
  DialogFooter,
} from '@/components/ui/dialog'
import { ScrollArea } from '@/components/ui/scroll-area'
import { Button } from '@/components/ui/button'
import { X } from 'lucide-react'

interface LegalModalTriggerProps {
  triggerText: string
  title: string
  children: React.ReactNode
}

export function LegalModalTrigger({
  triggerText,
  title,
  children,
}: LegalModalTriggerProps) {
  return (
    <Dialog>
      <DialogTrigger asChild>
        <button
          type="button"
          className="underline hover:text-primary focus:outline-none focus:ring-2 focus:ring-ring rounded-sm"
        >
          {triggerText}
        </button>
      </DialogTrigger>
      {/* Mantenim la mida gran */}
      <DialogContent className="max-w-5xl w-full h-[90vh] flex flex-col p-0">
        {/* Header es mantÃ© igual */}
        <DialogHeader className="p-6 pb-5 border-b sticky top-0 bg-background z-10">
          <DialogTitle className="text-2xl">{title}</DialogTitle>
        </DialogHeader>

        {/* BotÃ³ X es mantÃ© igual */}
        <DialogClose asChild>
          <Button
            variant="ghost"
            size="icon"
            className="absolute top-4 right-4 text-muted-foreground"
          >
            <X className="h-5 w-5" />
            <span className="sr-only">Tancar</span>
          </Button>
        </DialogClose>

        {/* Contingut amb Scroll */}
        {/* âœ… Assegurem que l'Ã rea de scroll ocupi l'espai i tingui scroll automÃ tic */}
        <ScrollArea className="flex-1 overflow-y-auto">
          {/* Donem padding intern al text */}
          <div className="px-6 py-8">{children}</div>
        </ScrollArea>

        {/* Footer */}
        {/* âœ… Eliminem 'sticky' - flexbox s'encarregarÃ  de posar-lo a baix.
           Afegim 'mt-auto' per assegurar-nos que s'enganxi a baix si el contingut Ã©s curt.
           Afegim 'flex-shrink-0' per evitar que s'encongeixi. */}
        <DialogFooter className="p-4 border-t bg-background z-10 mt-auto flex-shrink-0">
          <DialogClose asChild>
            <Button variant="outline" size="lg">
              Tancar
            </Button>
          </DialogClose>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}

// =================== FILE: src/components/ui/pagination.tsx ===================

import * as React from "react"
import { cn } from "@/lib/utils/utils"
import { ButtonProps, buttonVariants } from "@/components/ui/button"
import { ChevronLeftIcon, ChevronRightIcon, DotsHorizontalIcon } from "@radix-ui/react-icons"

const Pagination = ({ className, ...props }: React.ComponentProps<"nav">) => (
  <nav
    role="navigation"
    aria-label="pagination"
    className={cn("mx-auto flex w-full justify-center", className)}
    {...props}
  />
)
Pagination.displayName = "Pagination"

const PaginationContent = React.forwardRef<
  HTMLUListElement,
  React.ComponentProps<"ul">
>(({ className, ...props }, ref) => (
  <ul
    ref={ref}
    className={cn("flex flex-row items-center gap-1", className)}
    {...props}
  />
))
PaginationContent.displayName = "PaginationContent"

const PaginationItem = React.forwardRef<
  HTMLLIElement,
  React.ComponentProps<"li">
>(({ className, ...props }, ref) => (
  <li ref={ref} className={cn("", className)} {...props} />
))
PaginationItem.displayName = "PaginationItem"

type PaginationLinkProps = {
  isActive?: boolean
} & Pick<ButtonProps, "size"> &
  React.ComponentProps<"a">

const PaginationLink = ({
  className,
  isActive,
  size = "icon",
  ...props
}: PaginationLinkProps) => (
  <a
    aria-current={isActive ? "page" : undefined}
    className={cn(
      buttonVariants({
        variant: isActive ? "outline" : "ghost",
        size,
      }),
      className
    )}
    {...props}
  />
)
PaginationLink.displayName = "PaginationLink"

const PaginationPrevious = ({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) => (
  <PaginationLink
    aria-label="Go to previous page"
    size="default"
    className={cn("gap-1 pl-2.5", className)}
    {...props}
  >
    <ChevronLeftIcon className="h-4 w-4" />
    <span>Previous</span>
  </PaginationLink>
)
PaginationPrevious.displayName = "PaginationPrevious"

const PaginationNext = ({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) => (
  <PaginationLink
    aria-label="Go to next page"
    size="default"
    className={cn("gap-1 pr-2.5", className)}
    {...props}
  >
    <span>Next</span>
    <ChevronRightIcon className="h-4 w-4" />
  </PaginationLink>
)
PaginationNext.displayName = "PaginationNext"

const PaginationEllipsis = ({
  className,
  ...props
}: React.ComponentProps<"span">) => (
  <span
    aria-hidden
    className={cn("flex h-9 w-9 items-center justify-center", className)}
    {...props}
  >
    <DotsHorizontalIcon className="h-4 w-4" />
    <span className="sr-only">More pages</span>
  </span>
)
PaginationEllipsis.displayName = "PaginationEllipsis"

export {
  Pagination,
  PaginationContent,
  PaginationLink,
  PaginationItem,
  PaginationPrevious,
  PaginationNext,
  PaginationEllipsis,
}


// =================== FILE: src/components/ui/popover.tsx ===================

"use client"

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils/utils"

function Popover({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Root>) {
  return <PopoverPrimitive.Root data-slot="popover" {...props} />
}

function PopoverTrigger({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Trigger>) {
  return <PopoverPrimitive.Trigger data-slot="popover-trigger" {...props} />
}

function PopoverContent({
  className,
  align = "center",
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Content>) {
  return (
    <PopoverPrimitive.Portal>
      <PopoverPrimitive.Content
        data-slot="popover-content"
        align={align}
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-72 origin-(--radix-popover-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden",
          className
        )}
        {...props}
      />
    </PopoverPrimitive.Portal>
  )
}

function PopoverAnchor({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Anchor>) {
  return <PopoverPrimitive.Anchor data-slot="popover-anchor" {...props} />
}

export { Popover, PopoverTrigger, PopoverContent, PopoverAnchor }


// =================== FILE: src/components/ui/progress.tsx ===================

"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils/utils"

const Progress = React.forwardRef<
  React.ElementRef<typeof ProgressPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>
>(({ className, value, ...props }, ref) => (
  <ProgressPrimitive.Root
    ref={ref}
    className={cn(
      "relative h-2 w-full overflow-hidden rounded-full bg-primary/20",
      className
    )}
    {...props}
  >
    <ProgressPrimitive.Indicator
      className="h-full w-full flex-1 bg-primary transition-all"
      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
    />
  </ProgressPrimitive.Root>
))
Progress.displayName = ProgressPrimitive.Root.displayName

export { Progress }


// =================== FILE: src/components/ui/scroll-area.tsx ===================

"use client"

import * as React from "react"
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area"

import { cn } from "@/lib/utils/utils"

const ScrollArea = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>
>(({ className, children, ...props }, ref) => (
  <ScrollAreaPrimitive.Root
    ref={ref}
    className={cn("relative overflow-hidden", className)}
    {...props}
  >
    <ScrollAreaPrimitive.Viewport className="h-full w-full rounded-[inherit]">
      {children}
    </ScrollAreaPrimitive.Viewport>
    <ScrollBar />
    <ScrollAreaPrimitive.Corner />
  </ScrollAreaPrimitive.Root>
))
ScrollArea.displayName = ScrollAreaPrimitive.Root.displayName

const ScrollBar = React.forwardRef<
  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,
  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>
>(({ className, orientation = "vertical", ...props }, ref) => (
  <ScrollAreaPrimitive.ScrollAreaScrollbar
    ref={ref}
    orientation={orientation}
    className={cn(
      "flex touch-none select-none transition-colors",
      orientation === "vertical" &&
        "h-full w-2.5 border-l border-l-transparent p-[1px]",
      orientation === "horizontal" &&
        "h-2.5 flex-col border-t border-t-transparent p-[1px]",
      className
    )}
    {...props}
  >
    <ScrollAreaPrimitive.ScrollAreaThumb className="relative flex-1 rounded-full bg-border" />
  </ScrollAreaPrimitive.ScrollAreaScrollbar>
))
ScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName

export { ScrollArea, ScrollBar }


// =================== FILE: src/components/ui/select.tsx ===================

"use client";

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { Check, ChevronDown } from "lucide-react"
import { cn } from "@/lib/utils/utils"

const Select = SelectPrimitive.Root
const SelectGroup = SelectPrimitive.Group
const SelectValue = SelectPrimitive.Value

const SelectTrigger = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Trigger
    ref={ref}
    className={cn(
      "flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",
      className
    )}
    {...props}
  >
    {children}
    <SelectPrimitive.Icon asChild>
      <ChevronDown className="h-4 w-4 opacity-50" />
    </SelectPrimitive.Icon>
  </SelectPrimitive.Trigger>
))
SelectTrigger.displayName = SelectPrimitive.Trigger.displayName

const SelectContent = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>
>(({ className, children, position = "popper", ...props }, ref) => (
  <SelectPrimitive.Portal>
    <SelectPrimitive.Content
      ref={ref}
      className={cn(
        "relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
        position === "popper" &&
          "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
        className
      )}
      position={position}
      {...props}
    >
      <SelectPrimitive.Viewport
        className={cn(
          "p-1",
          position === "popper" &&
            "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"
        )}
      >
        {children}
      </SelectPrimitive.Viewport>
    </SelectPrimitive.Content>
  </SelectPrimitive.Portal>
))
SelectContent.displayName = SelectPrimitive.Content.displayName

const SelectLabel = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Label>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Label
    ref={ref}
    className={cn("px-2 py-1.5 text-sm font-semibold", className)}
    {...props}
  />
))
SelectLabel.displayName = SelectPrimitive.Label.displayName

const SelectItem = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>
>(({ className, children, ...props }, ref) => (
  <SelectPrimitive.Item
    ref={ref}
    className={cn(
      "relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50",
      className
    )}
    {...props}
  >
    <span className="absolute right-2 flex h-3.5 w-3.5 items-center justify-center">
      <SelectPrimitive.ItemIndicator>
        <Check className="h-4 w-4" />
      </SelectPrimitive.ItemIndicator>
    </span>
    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
  </SelectPrimitive.Item>
))
SelectItem.displayName = SelectPrimitive.Item.displayName

const SelectSeparator = React.forwardRef<
  React.ElementRef<typeof SelectPrimitive.Separator>,
  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>
>(({ className, ...props }, ref) => (
  <SelectPrimitive.Separator
    ref={ref}
    className={cn("-mx-1 my-1 h-px bg-muted", className)}
    {...props}
  />
))
SelectSeparator.displayName = SelectPrimitive.Separator.displayName

export {
  Select,
  SelectGroup,
  SelectValue,
  SelectTrigger,
  SelectContent,
  SelectLabel,
  SelectItem,
  SelectSeparator,
}

// =================== FILE: src/components/ui/separator.tsx ===================

"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils/utils"

const Separator = React.forwardRef<
  React.ElementRef<typeof SeparatorPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>
>(
  (
    { className, orientation = "horizontal", decorative = true, ...props },
    ref
  ) => (
    <SeparatorPrimitive.Root
      ref={ref}
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "shrink-0 bg-border",
        orientation === "horizontal" ? "h-[1px] w-full" : "h-full w-[1px]",
        className
      )}
      {...props}
    />
  )
)
Separator.displayName = SeparatorPrimitive.Root.displayName

export { Separator }


// =================== FILE: src/components/ui/sheet.tsx ===================

"use client"

import * as React from "react"
import * as SheetPrimitive from "@radix-ui/react-dialog"
import { cva, type VariantProps } from "class-variance-authority"
import { cn } from "@/lib/utils/utils"
import { Cross2Icon } from "@radix-ui/react-icons"

const Sheet = SheetPrimitive.Root

const SheetTrigger = SheetPrimitive.Trigger

const SheetClose = SheetPrimitive.Close

const SheetPortal = SheetPrimitive.Portal

const SheetOverlay = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Overlay>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Overlay
    className={cn(
      "fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",
      className
    )}
    {...props}
    ref={ref}
  />
))
SheetOverlay.displayName = SheetPrimitive.Overlay.displayName

const sheetVariants = cva(
  "fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500 data-[state=open]:animate-in data-[state=closed]:animate-out",
  {
    variants: {
      side: {
        top: "inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",
        bottom:
          "inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",
        left: "inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",
        right:
          "inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm",
      },
    },
    defaultVariants: {
      side: "right",
    },
  }
)

interface SheetContentProps
  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,
    VariantProps<typeof sheetVariants> {}

const SheetContent = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Content>,
  SheetContentProps
>(({ side = "right", className, children, ...props }, ref) => (
  <SheetPortal>
    <SheetOverlay />
    <SheetPrimitive.Content
      ref={ref}
      className={cn(sheetVariants({ side }), className)}
      {...props}
    >
      <SheetPrimitive.Close className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary">
        <Cross2Icon className="h-4 w-4" />
        <span className="sr-only">Close</span>
      </SheetPrimitive.Close>
      {children}
    </SheetPrimitive.Content>
  </SheetPortal>
))
SheetContent.displayName = SheetPrimitive.Content.displayName

const SheetHeader = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col space-y-2 text-center sm:text-left",
      className
    )}
    {...props}
  />
)
SheetHeader.displayName = "SheetHeader"

const SheetFooter = ({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn(
      "flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",
      className
    )}
    {...props}
  />
)
SheetFooter.displayName = "SheetFooter"

const SheetTitle = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Title>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Title
    ref={ref}
    className={cn("text-lg font-semibold text-foreground", className)}
    {...props}
  />
))
SheetTitle.displayName = SheetPrimitive.Title.displayName

const SheetDescription = React.forwardRef<
  React.ElementRef<typeof SheetPrimitive.Description>,
  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>
>(({ className, ...props }, ref) => (
  <SheetPrimitive.Description
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
SheetDescription.displayName = SheetPrimitive.Description.displayName

export {
  Sheet,
  SheetPortal,
  SheetOverlay,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}


// =================== FILE: src/components/ui/skeleton.tsx ===================

// Ruta: src/components/ui/skeleton.tsx
import { cn } from "@/lib/utils/utils"

function Skeleton({
  className,
  ...props
}: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn("animate-pulse rounded-md bg-muted", className)}
      {...props}
    />
  )
}

export { Skeleton }

// =================== FILE: src/components/ui/sonner.tsx ===================

"use client"

import { useTheme } from "next-themes"
import { Toaster as Sonner } from "sonner"

type ToasterProps = React.ComponentProps<typeof Sonner>

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      toastOptions={{
        classNames: {
          toast:
            "group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",
          description: "group-[.toast]:text-muted-foreground",
          actionButton:
            "group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",
          cancelButton:
            "group-[.toast]:bg-muted group-[.toast]:text-muted-foreground",
        },
      }}
      {...props}
    />
  )
}

export { Toaster }


// =================== FILE: src/components/ui/switch.tsx ===================

"use client"

import * as React from "react"
import * as SwitchPrimitives from "@radix-ui/react-switch"

import { cn } from "@/lib/utils/utils"

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      "peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input",
      className
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0"
      )}
    />
  </SwitchPrimitives.Root>
))
Switch.displayName = SwitchPrimitives.Root.displayName

export { Switch }


// =================== FILE: src/components/ui/table.tsx ===================

// src/components/ui/table.tsx
"use client"

import * as React from "react"
import { cn } from "@/lib/utils/utils"

const Table = React.forwardRef<
  HTMLTableElement,
  React.HTMLAttributes<HTMLTableElement>
>(({ className, ...props }, ref) => (
  <div className="relative w-full overflow-auto">
    <table
      ref={ref}
      className={cn("w-full caption-bottom text-sm", className)}
      {...props}
    />
  </div>
))
Table.displayName = "Table"

const TableHeader = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <thead ref={ref} className={cn("[&_tr]:border-b", className)} {...props} />
))
TableHeader.displayName = "TableHeader"

const TableBody = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tbody
    ref={ref}
    className={cn("[&_tr:last-child]:border-0", className)}
    {...props}
  />
))
TableBody.displayName = "TableBody"

const TableFooter = React.forwardRef<
  HTMLTableSectionElement,
  React.HTMLAttributes<HTMLTableSectionElement>
>(({ className, ...props }, ref) => (
  <tfoot
    ref={ref}
    className={cn(
      "border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",
      className
    )}
    {...props}
  />
))
TableFooter.displayName = "TableFooter"

const TableRow = React.forwardRef<
  HTMLTableRowElement,
  React.HTMLAttributes<HTMLTableRowElement>
>(({ className, ...props }, ref) => (
  <tr
    ref={ref}
    className={cn(
      "border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted",
      className
    )}
    {...props}
  />
))
TableRow.displayName = "TableRow"

const TableHead = React.forwardRef<
  HTMLTableCellElement,
  React.ThHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <th
    ref={ref}
    className={cn(
      "h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",
      className
    )}
    {...props}
  />
))
TableHead.displayName = "TableHead"

const TableCell = React.forwardRef<
  HTMLTableCellElement,
  React.TdHTMLAttributes<HTMLTableCellElement>
>(({ className, ...props }, ref) => (
  <td
    ref={ref}
    className={cn("p-4 align-middle [&:has([role=checkbox])]:pr-0", className)}
    {...props}
  />
))
TableCell.displayName = "TableCell"

const TableCaption = React.forwardRef<
  HTMLTableCaptionElement,
  React.HTMLAttributes<HTMLTableCaptionElement>
>(({ className, ...props }, ref) => (
  <caption
    ref={ref}
    className={cn("mt-4 text-sm text-muted-foreground", className)}
    {...props}
  />
))
TableCaption.displayName = "TableCaption"

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}

// =================== FILE: src/components/ui/tabs.tsx ===================

"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils/utils"

function Tabs({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Root>) {
  return (
    <TabsPrimitive.Root
      data-slot="tabs"
      className={cn("flex flex-col gap-2", className)}
      {...props}
    />
  )
}

function TabsList({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.List>) {
  return (
    <TabsPrimitive.List
      data-slot="tabs-list"
      className={cn(
        "bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-lg p-[3px]",
        className
      )}
      {...props}
    />
  )
}

function TabsTrigger({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {
  return (
    <TabsPrimitive.Trigger
      data-slot="tabs-trigger"
      className={cn(
        "data-[state=active]:bg-background dark:data-[state=active]:text-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:shadow-sm [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function TabsContent({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Content>) {
  return (
    <TabsPrimitive.Content
      data-slot="tabs-content"
      className={cn("flex-1 outline-none", className)}
      {...props}
    />
  )
}

export { Tabs, TabsList, TabsTrigger, TabsContent }


// =================== FILE: src/components/ui/textarea.tsx ===================

import * as React from "react"
import { cn } from "@/lib/utils/utils"

// 1. Canviem la interfÃ­cie buida per un 'type'.
// 2. Renombrem a 'TextareaProps' i heretem de les propietats correctes: React.TextareaHTMLAttributes.
export type TextareaProps = React.TextareaHTMLAttributes<HTMLTextAreaElement>

const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(
  ({ className, ...props }, ref) => {
    return (
      <textarea
        className={cn(
          "flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-base shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Textarea.displayName = "Textarea"

export { Textarea }

// =================== FILE: src/components/ui/toast.tsx ===================

import { toast } from "sonner";

export { toast };

// =================== FILE: src/components/ui/toaster.tsx ===================

"use client"

import { Toaster as Sonner } from "sonner"

type ToasterProps = React.ComponentProps<typeof Sonner>

const Toaster = ({ ...props }: ToasterProps) => {
  return (
    <Sonner
      theme="light"
      className="toaster group"
      toastOptions={{
        classNames: {
          toast:
            "group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",
          description: "group-[.toast]:text-muted-foreground",
          actionButton:
            "group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",
          cancelButton:
            "group-[.toast]:bg-muted group-[.toast]:text-muted-foreground",
        },
      }}
      {...props}
    />
  )
}

export { Toaster }

// =================== FILE: src/components/ui/toggle-group.tsx ===================

"use client"

import * as React from "react"
import * as ToggleGroupPrimitive from "@radix-ui/react-toggle-group"
import { type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils/utils"
import { toggleVariants } from "@/components/ui/toggle"

const ToggleGroupContext = React.createContext<
  VariantProps<typeof toggleVariants>
>({
  size: "default",
  variant: "default",
})

const ToggleGroup = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &
    VariantProps<typeof toggleVariants>
>(({ className, variant, size, children, ...props }, ref) => (
  <ToggleGroupPrimitive.Root
    ref={ref}
    className={cn("flex items-center justify-center gap-1", className)}
    {...props}
  >
    <ToggleGroupContext.Provider value={{ variant, size }}>
      {children}
    </ToggleGroupContext.Provider>
  </ToggleGroupPrimitive.Root>
))

ToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName

const ToggleGroupItem = React.forwardRef<
  React.ElementRef<typeof ToggleGroupPrimitive.Item>,
  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &
    VariantProps<typeof toggleVariants>
>(({ className, children, variant, size, ...props }, ref) => {
  const context = React.useContext(ToggleGroupContext)

  return (
    <ToggleGroupPrimitive.Item
      ref={ref}
      className={cn(
        toggleVariants({
          variant: context.variant || variant,
          size: context.size || size,
        }),
        className
      )}
      {...props}
    >
      {children}
    </ToggleGroupPrimitive.Item>
  )
})

ToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName

export { ToggleGroup, ToggleGroupItem }


// =================== FILE: src/components/ui/toggle.tsx ===================

"use client"

import * as React from "react"
import * as TogglePrimitive from "@radix-ui/react-toggle"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils/utils"

const toggleVariants = cva(
  "inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline:
          "border border-input bg-transparent shadow-sm hover:bg-accent hover:text-accent-foreground",
      },
      size: {
        default: "h-9 px-2 min-w-9",
        sm: "h-8 px-1.5 min-w-8",
        lg: "h-10 px-2.5 min-w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

const Toggle = React.forwardRef<
  React.ElementRef<typeof TogglePrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &
    VariantProps<typeof toggleVariants>
>(({ className, variant, size, ...props }, ref) => (
  <TogglePrimitive.Root
    ref={ref}
    className={cn(toggleVariants({ variant, size, className }))}
    {...props}
  />
))

Toggle.displayName = TogglePrimitive.Root.displayName

export { Toggle, toggleVariants }


// =================== FILE: src/components/ui/tooltip.tsx ===================

"use client"

import * as React from "react"
import * as TooltipPrimitive from "@radix-ui/react-tooltip"

import { cn } from "@/lib/utils/utils"

const TooltipProvider = TooltipPrimitive.Provider

const Tooltip = TooltipPrimitive.Root

const TooltipTrigger = TooltipPrimitive.Trigger

const TooltipContent = React.forwardRef<
  React.ElementRef<typeof TooltipPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>
>(({ className, sideOffset = 4, ...props }, ref) => (
  <TooltipPrimitive.Portal>
    <TooltipPrimitive.Content
      ref={ref}
      sideOffset={sideOffset}
      className={cn(
        "z-50 overflow-hidden rounded-md bg-primary px-3 py-1.5 text-xs text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]",
        className
      )}
      {...props}
    />
  </TooltipPrimitive.Portal>
))
TooltipContent.displayName = TooltipPrimitive.Content.displayName

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }


// =================== FILE: src/config/billing.ts ===================

import type { PlanConfig } from '@/types/settings';

/**
 * ConfiguraciÃ³ centralitzada dels plans de subscripciÃ³.
 * El camp 'name' s'utilitzarÃ  com a clau per a les traduccions (en minÃºscules).
 */
export const plansStructure: PlanConfig[] = [
  {
    id: 'plan_free',
    name: 'Free', // Aquesta serÃ  la clau 'free' per a les traduccions
    iconName: 'Gift',
    priceMonthly: 0,
    priceYearly: 0,
    colors: { border: "border-muted", text: "text-muted-foreground", bg: "bg-muted", hoverBg: "hover:bg-muted/80" }
  },
  {
    id: process.env.PLAN_PRO_ID || 'plan_pro',
    name: 'Pro', // Aquesta serÃ  la clau 'pro' per a les traduccions
    iconName: 'Star',
    priceMonthly: 29,
    priceYearly: 290,
    isPopular: true,
    colors: { border: "border-primary", text: "text-primary", bg: "bg-primary", hoverBg: "hover:bg-primary/90" }
  },
  {
    id: process.env.PLAN_PREMIUM_ID || 'plan_premium',
    name: 'Premium', // Aquesta serÃ  la clau 'premium' per a les traduccions
    iconName: 'Gem',
    priceMonthly: 79,
    priceYearly: 790,
    colors: { border: "border-teal-500", text: "text-teal-500", bg: "bg-teal-500", hoverBg: "hover:bg-teal-500/90" }
  },
  {
    id: 'custom',
    name: 'Custom', // Aquesta serÃ  la clau 'custom' per a les traduccions
    iconName: 'Settings',
    priceMonthly: null,
    priceYearly: null,
    colors: { border: "border-foreground", text: "text-foreground", bg: "bg-foreground", hoverBg: "hover:bg-foreground/90" }
  },
];



// =================== FILE: src/config/contacts.ts ===================

// src/config/contacts.ts (NOU FITXER)

export const CONTACT_STATUS_MAP = [
  { code: 'L', key: 'Lead' },
  { code: 'P', key: 'Proveidor' },
  { code: 'C', key: 'Client' },
] as const;

export type ContactStatusCode = typeof CONTACT_STATUS_MAP[number]['code'];

// =================== FILE: src/config/inbox.ts ===================

// src/config/inbox.ts (NOU FITXER)

/**
 * @summary Defineix les constants i la lÃ²gica de negoci per al mÃ²dul de l'Inbox.
 */

// Mapa d'estats de tiquets. La 'font de la veritat' per als estats possibles.
export const TICKET_STATUS_MAP = [
  { dbValue: 'NoLlegit', key: 'unread' }, 
  { dbValue: 'Llegit', key: 'read' },
  { dbValue: 'Respost', key: 'replied' },
] as const;

// Tipus que representa els possibles valors de l'estat d'un tiquet a la base de dades.
export type TicketStatus = typeof TICKET_STATUS_MAP[number]['dbValue'];

// Tipus per als filtres de la interfÃ­cie d'usuari.
export type TicketFilter = 'tots' | 'rebuts' | 'enviats' | 'noLlegits';

// =================== FILE: src/config/invoices.ts ===================

// Mapa de dades per als estats (basat en el teu exemple)
// Adaptat per coincidir amb els valors ENUM de Supabase si els tens,
// o els valors 'text' que fas servir a la columna 'status'.
export const INVOICE_STATUS_MAP = [
 { dbValue: 'Draft',     key: 'draft',   colorClass: 'bg-gray-500/10 text-gray-400 border border-gray-400/30' },
 { dbValue: 'Sent',      key: 'sent',    colorClass: 'bg-blue-500/10 text-blue-400 border border-blue-400/30' }, // Canviat de Issued a Sent per coincidir amb ENUM
 { dbValue: 'Paid',      key: 'paid',    colorClass: 'bg-green-500/10 text-green-400 border border-green-400/30' },
 { dbValue: 'Overdue',   key: 'overdue', colorClass: 'bg-red-500/10 text-red-400 border border-red-400/30' },
 { dbValue: 'Cancelled', key: 'cancelled', colorClass: 'bg-yellow-500/10 text-yellow-400 border border-yellow-400/30' }, // Canviat de Cancelled per consistÃ¨ncia
] as const;


// Tipus per a l'estat, derivat del mapa o de l'ENUM de Supabase
// Si 'status' a Supabase Ã©s ENUM 'invoice_status', pots usar:
// export type InvoiceStatus = Database['public']['Enums']['invoice_status'];
// Si Ã©s 'text', definim els valors esperats:
export type InvoiceStatus = typeof INVOICE_STATUS_MAP[number]['dbValue'];

// =================== FILE: src/config/navigation.ts ===================

import {
  Activity,
  AudioWaveform,
  BookPlus,
  Bot,
  Briefcase,
  CalendarDays,
  Columns,
  Contact,
  CreditCard,
  Download,
  FileText,
  Headphones,
  KeyRound,
  Landmark,
  LayoutDashboard,
  LayoutTemplate,
  Mail,
  Puzzle,
  Receipt,
  Settings,
  ShieldOff,
  Truck,
  // âœ… 1. Importem les icones que necessitarem per als nous submenÃºs
  User,
  Users,
  Wrench,
} from "lucide-react";
import type { NavItem } from "@/types/app/navigation";

export const navModules: NavItem[] = [
  {
    id: "dashboard",
    labelKey: "dashboard",
    icon: LayoutDashboard,
    path: "/dashboard",
    isSingle: true,
  },
  {
    id: "crm",
    labelKey: "crm",
    icon: Briefcase,
    basePath: "/crm",
    path: "/crm/general",
    isSingle: false,
    children: [
      {
        id: "general_crm",
        labelKey: "crmGeneral",
        icon: Briefcase,
        path: "/crm/general",
        isSingle: true,
      },
      {
        id: "contactes",
        labelKey: "contacts",
        icon: Contact,
        path: "/crm/contactes",
        isSingle: true,
      },
      {
        id: "pipeline",
        labelKey: "pipeline",
        icon: Columns,
        path: "/crm/pipeline",
        isSingle: true,
      },
      {
        id: "activitats",
        labelKey: "activities",
        icon: Activity,
        path: "/crm/activitats",
        isSingle: true,
      },
      {
        id: "calendari",
        labelKey: "calendar",
        icon: CalendarDays,
        path: "/crm/calendari",
        isSingle: true,
      },
    ],
  },
  {
    id: "finances",
    labelKey: "finances",
    icon: Landmark,
    basePath: "/finances",
    path: "/finances/invoices",
    isSingle: false,
    children: [
      {
        id: "pressupostos",
        labelKey: "quotes",
        icon: FileText,
        path: "/finances/quotes",
        isSingle: true,
      },
      {
        id: "conceptes",
        labelKey: "concepts",
        icon: BookPlus,
        path: "/finances/products",
        isSingle: true,
      },
      {
        id: "facturacio",
        labelKey: "invoicing",
        icon: Receipt,
        path: "/finances/invoices",
        isSingle: true,
      },
      {
        id: "despeses",
        labelKey: "expenses",
        icon: Landmark,
        path: "/finances/expenses",
        isSingle: true,
      },
      {
        id: "proveÃ¯dors",
        labelKey: "suppliers",
        icon: Truck,
        path: "/finances/suppliers",
        isSingle: true,
      },
    ],
  },
  {
    id: "comunicacio",
    labelKey: "communication",
    icon: Headphones,
    basePath: "/comunicacio",
    path: "/comunicacio/inbox",
    isSingle: false,
    children: [
      {
        id: "inbox",
        labelKey: "inbox",
        icon: Mail,
        path: "/comunicacio/inbox",
        isSingle: true,
      },
      {
        id: "templates",
        labelKey: "templates",
        icon: LayoutTemplate,
        path: "/comunicacio/templates",
        isSingle: true,
      },
      {
        id: "marketing",
        labelKey: "marketing",
        icon: Headphones,
        path: "/comunicacio/marketing",
        isSingle: true,
      },
      {
        id: "planificador",
        labelKey: "planner",
        icon: CalendarDays,
        path: "/comunicacio/planificador",
        requiredPlan: ["plus", "premium"],
        isSingle: false,
      },
      {
        id: "transcripcio",
        labelKey: "transcription", // âš ï¸ HaurÃ s d'afegir "transcription": "TranscripciÃ³" al teu ca.json
        icon: AudioWaveform,
        path: "/comunicacio/transcripcio",
        isSingle: true,
      },
    ],
  },
  {
    id: "network",
    labelKey: "network",
    icon: Users,
    path: "/network",
    isSingle: true,
  },
  /*{
    id: 'projectStrocture',
    labelKey: 'architecture',
    icon: Workflow,
    path: '/projectStrocture',
    isSingle: true
  },*/
];

export const bottomItems: NavItem[] = [
  {
    id: "ai",
    labelKey: "ai",
    icon: Bot,
    path: "#",
    isSingle: true,
    notImplemented: true,
  },
  // âœ… 2. Modifiquem l'element 'settings' per a quÃ¨ tingui submenÃºs.
  {
    id: "settings",
    labelKey: "settings",
    icon: Settings,
    basePath: "/settings", // Important per saber quan mostrar els fills
    path: "/settings/profile", // La ruta per defecte en clicar
    isSingle: false, // Ara no Ã©s un enllaÃ§ Ãºnic, tÃ© fills
    children: [
      // âœ… 3. Afegim aquÃ­ tots els elements que abans estaven a 'SettingsNav.tsx'.
      {
        id: "profile",
        labelKey: "profile",
        icon: User,
        path: "/settings/profile",
        isSingle: true,
      },
      {
        id: "billing",
        labelKey: "billing",
        icon: CreditCard,
        path: "/settings/billing",
        isSingle: true,
      },
      {
        id: "team",
        labelKey: "team",
        icon: Users,
        path: "/settings/team",
        isSingle: true,
      },
      {
        id: "integrations",
        labelKey: "integrations",
        icon: Puzzle,
        path: "/settings/integrations",
        isSingle: true,
      },
      {
        id: "blacklist",
        labelKey: "blacklist",
        icon: ShieldOff,
        path: "/settings/blacklist",
        isSingle: true,
      },
      {
        id: "customization",
        labelKey: "customization",
        icon: Wrench,
        path: "/settings/customization",
        isSingle: true,
      },
      {
        id: "install",
        labelKey: "install",
        icon: Download,
        path: "/settings/install",
        isSingle: true,
      },
      {
        id: "permissions",
        labelKey: "permissions",
        icon: KeyRound,
        path: "/settings/permissions",
        isSingle: true,
      },
    ],
  },
];


// =================== FILE: src/config/pipeline.ts ===================

export const PIPELINE_STAGES_MAP = [
  { name: 'Prospecte', key: 'prospect' },
  { name: 'Contactat', key: 'contacted' },
  { name: 'Proposta Enviada', key: 'proposalSent' },
  { name: 'NegociaciÃ³', key: 'negotiation' },
  { name: 'Guanyat', key: 'won' },
  { name: 'Perdut', key: 'lost' },
] as const;
export type PipelineStageName = typeof PIPELINE_STAGES_MAP[number]['name'];

// =================== FILE: src/config/styles/quotes.ts ===================

export const QUOTE_STATUS_MAP = [
  { dbValue: 'Draft',    key: 'Draft',    colorClass: 'bg-yellow-900/50 text-yellow-300' },
  { dbValue: 'Sent',     key: 'Sent',     colorClass: 'bg-blue-900/50 text-blue-300' },
  { dbValue: 'Accepted', key: 'Accepted', colorClass: 'bg-green-900/50 text-green-300' },
  { dbValue: 'Declined', key: 'Declined', colorClass: 'bg-red-900/50 text-red-300' },
  { dbValue: 'Invoiced', key: 'Invoiced', colorClass: 'bg-purple-900/50 text-purple-300' },
] as const;

export type QuoteStatus = typeof QUOTE_STATUS_MAP[number]['dbValue'];


// =================== FILE: src/config/styles/task.ts ===================

export type TaskPriority = 'Baixa' | 'Mitjana' | 'Alta';

interface PriorityStyle {
  badgeClasses: string; // Classes de Tailwind per a les etiquetes
  hexColor: string;     // Color HEX per al calendari i altres elements
}

// âœ… AQUEST Ã‰S L'ÃšNIC LLOC ON HAURÃ€S DE MODIFICAR ELS COLORS EN EL FUTUR.
export const priorityStyles: Record<TaskPriority, PriorityStyle> = {
  Baixa: {
    badgeClasses: "bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-900/50 dark:text-blue-300 dark:border-blue-800",
    hexColor: '#3b82f6', // Correspon a tailwind-css blue-500
  },
  Mitjana: {
    badgeClasses: "bg-yellow-100 text-yellow-800 border-yellow-200 dark:bg-yellow-900/50 dark:text-yellow-300 dark:border-yellow-800",
    hexColor: '#f59e0b', // Correspon a tailwind-css yellow-500
  },
  Alta: {
    badgeClasses: "bg-red-100 text-red-800 border-red-200 dark:bg-red-900/50 dark:text-red-300 dark:border-red-800",
    hexColor: '#ef4444', // Correspon a tailwind-css red-500
  },
};

// =================== FILE: src/config/subscriptions.ts ===================

// IDs dels plans (idealment, que coincideixin amb els IDs de Stripe/Supabase)
export const PLAN_IDS = {
  FREE: 'plan_free',
  PRO: 'plan_pro',
  PREMIUM: 'plan_premium',

} as const;

export type PlanId = (typeof PLAN_IDS)[keyof typeof PLAN_IDS];

// Definim els lÃ­mits de manera centralitzada
export const PLAN_LIMITS = {
  [PLAN_IDS.FREE]: {
    maxTickets: 200,
    maxContacts: 15,
    maxTeamMembers: 3,
  },
  [PLAN_IDS.PRO]: {
    maxTickets: 10000,
    maxContacts: 20,
    maxTeamMembers: 25,
  },
  [PLAN_IDS.PREMIUM]: {
    // Usem Infinity (o null) per a ilÂ·limitat
    maxTickets: Infinity,
    maxContacts: Infinity,
    maxTeamMembers: Infinity,
  },
};

// Un tipus per assegurar que nomÃ©s demanem lÃ­mits que existeixen
export type PlanLimit = keyof (typeof PLAN_LIMITS)[PlanId];

// =================== FILE: src/emails/TranscriptionSummaryEmail.tsx ===================

import {
  Body,
  Button,
  Container,
  Head,
  Hr,
  Html,
  Img,
  Preview,
  Section,
  Text,

} from '@react-email/components';
import * as React from 'react';
import type { AudioJob } from '@/types/db'; // Importa el teu tipus
// import { TFunction } from 'next-intl'; // Removed, not exported by next-intl

// Definim els tipus basats en la Edge Function
type KeyMoment = {
  topic: string;
  details: string;
  decisions: string[];
  is_work_related: boolean;
}
type Participant = {
  contact_id: number;
  name: string;
  role: string;
}

interface TranscriptionSummaryEmailProps {
  job: AudioJob;
  emailSubject: string;
  t: (key: string) => string; // FunciÃ³ de traducciÃ³
}

const baseUrl = process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000';

export const TranscriptionSummaryEmail = ({
  job,
  emailSubject,
  t
}: TranscriptionSummaryEmailProps) => {

  const workMoments = (job.key_moments as KeyMoment[] || []).filter(m => m.is_work_related);
  const participants = (job.participants as Participant[] || []);

  return (
    <Html>
      <Head />
      <Preview>{emailSubject}</Preview>
      <Body style={main}>
        <Container style={container}>
          <Img
            src={`${baseUrl}/android-chrome-192x192.png`}
            width="48"
            height="48"
            alt="RibotFlow Logo"
            style={logo}
          />
          <Text style={title}>{emailSubject}</Text>
          <Section style={card}>
            <Text style={cardHeader}>{t('summaryTitle')}</Text>
            <Text style={cardContent}>{job.summary || t('summaryEmpty')}</Text>
          </Section>

          {workMoments.length > 0 && (
            <Section style={card}>
              <Text style={cardHeader}>{t('keyMomentsTitle')}</Text>
              {workMoments.map((moment, index) => (
                <div key={index} style={momentBox}>
                  <Text style={momentTopic}>{moment.topic}</Text>
                  <Text style={momentDetails}>{moment.details}</Text>
                  {moment.decisions.length > 0 && (
                    <>
                      <Text style={momentDecisionTitle}>{t('keyMomentsDecisions')}:</Text>
                      <ul style={list}>
                        {moment.decisions.map((d, i) => <li key={i}>{d}</li>)}
                      </ul>
                    </>
                  )}
                  {index < workMoments.length - 1 && <Hr style={hr} />}
                </div>
              ))}
            </Section>
          )}
          
          {participants.length > 0 && (
             <Section style={card}>
              <Text style={cardHeader}>{t('participantsTitle')}</Text>
                <ul style={list}>
                  {participants.map((p, i) => <li key={i}>{p.name} ({p.role})</li>)}
                </ul>
            </Section>
          )}

          <Section style={{ textAlign: 'center', marginTop: '32px' }}>
            <Button
              style={button}
              href={`${baseUrl}/comunicacio/transcripcio/${job.id}`}
            >
              {t('viewFullTranscriptionButton')}
            </Button>
          </Section>
          <Hr style={hr} />
          <Text style={footer}>RibotFlow | {t('automatedEmail')}</Text>
        </Container>
      </Body>
    </Html>
  );
};

export default TranscriptionSummaryEmail;

// --- Estils per a l'email ---
// (Simplificats per brevetat)

const main = {
  backgroundColor: '#f6f9fc',
  fontFamily: '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Ubuntu,sans-serif',
};
const container = {
  backgroundColor: '#ffffff',
  margin: '0 auto',
  padding: '20px 0 48px',
  marginBottom: '64px',
};
const logo = {
  margin: '0 auto',
};
const title = {
  fontSize: '24px',
  lineHeight: '1.25',
  fontWeight: '600',
  textAlign: 'center' as const,
  padding: '0 20px',
};
const card = {
  border: '1px solid #dfe1e4',
  borderRadius: '8px',
  margin: '24px 20px 0',
  padding: '20px',
};
const cardHeader = {
  fontSize: '18px',
  fontWeight: '600',
  margin: '0 0 16px 0',
};
const cardContent = {
  fontSize: '16px',
  lineHeight: '1.5',
  color: '#3c4043',
};
const momentBox = {
  paddingBottom: '16px',
};
const momentTopic = {
  fontSize: '16px',
  fontWeight: '600',
  margin: '0 0 8px 0',
};
const momentDetails = {
  fontSize: '14px',
  lineHeight: '1.5',
  color: '#3c4043',
  margin: '0',
};
const momentDecisionTitle = {
  fontSize: '14px',
  fontWeight: '600',
  margin: '12px 0 4px 0',
};
const list = {
  margin: '0',
  paddingLeft: '20px',
  fontSize: '14px',
  lineHeight: '1.5',
};
const hr = {
  borderColor: '#dfe1e4',
  margin: '24px 0',
};
const button = {
  backgroundColor: '#5e6ad2',
  borderRadius: '6px',
  color: '#fff',
  fontSize: '16px',
  textDecoration: 'none',
  padding: '12px 24px',
};
const footer = {
  color: '#8898aa',
  fontSize: '12px',
  lineHeight: '16px',
  textAlign: 'center' as const,
};

// =================== FILE: src/hooks/useAppNavigation.ts ===================

// UbicaciÃ³: /hooks/useAppNavigation.ts

import { useState, useEffect, useCallback } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { useLocale, useTranslations } from 'next-intl';
import { toast } from 'sonner';
import { useUser } from '@/hooks/useUser';
// âœ… 1. Importem els setters que ens falten de l'store
import { useNavigationStore } from '@/stores/navigationStore';
import { navModules } from '@/config/navigation';
import type { NavItem } from '@/types/app/navigation';

export function useAppNavigation() {
Â  Â  const pathname = usePathname();
Â  Â  const router = useRouter();
Â  Â  const locale = useLocale();
Â  Â  const t = useTranslations('Navigation');
Â  Â  
Â  Â  // âœ… 2. OBTENIM TOTES LES DADES NECESSÃ€RIES
Â  Â  // Obtenim l'objecte 'activeTeam' que ens proporciona el hook 'useUser'
Â  Â  const { user, teamRole, activeTeam } = useUser();
Â  Â  // Obtenim la funciÃ³ 'setActiveTeam' del nostre store
Â  Â  const { setIsNavigating, setActiveTeam } = useNavigationStore();

Â  Â  const [activeModule, setActiveModule] = useState<NavItem | null>(null);
Â  Â  const [isModuleSidebarOpen, setIsModuleSidebarOpen] = useState(false);

 Â  Â // ---
 Â  Â // âœ… 3. PUNT CLAU: SINCRONITZACIÃ“ DE L'ESTAT
 Â  Â // ---
 Â  Â // Aquest useEffect s'executarÃ  quan el hook useUser carregui les dades de l'usuari.
 Â  Â // Llavors, agafarÃ  l'activeTeam (que ve del UserContext) i l'establirÃ 
 Â  Â // al nostre store global (Zustand), fent-lo accessible a tota l'aplicaciÃ³
 Â  Â // (com per exemple, a NetworkClient.tsx).
 Â  Â useEffect(() => {
 Â  Â  Â  Â // Si 'activeTeam' encara s'estÃ  carregant, pot ser 'undefined'.
 Â  Â  Â  Â // Ens assegurem de passar 'null' si no estÃ  definit.
 Â  Â  Â  Â console.log("[useAppNavigation] Sincronitzant activeTeam amb el store:", activeTeam);
 Â  Â  Â  Â setActiveTeam(activeTeam || null); 
 Â  Â }, [activeTeam, setActiveTeam]); // S'executa quan activeTeam (de useUser) canvia

Â  Â  useEffect(() => {
Â  Â  Â  Â  setIsNavigating(false);
Â  Â  Â  Â  const prefix = `/${locale}`;
Â  Â  Â  Â  const pathnameWithoutLocale = pathname.startsWith(prefix) ? pathname.slice(prefix.length) || '/' : pathname;
Â  Â  Â  Â  
Â  Â  Â  Â  const currentModule = navModules.find(
Â  Â  Â  Â  Â  Â  module => !module.isSingle && module.basePath && pathnameWithoutLocale.startsWith(module.basePath)
Â  Â  Â  Â  );
Â  Â  Â  Â  
Â  Â  Â  Â  setActiveModule(currentModule || null);
Â  Â  Â  Â  if (!currentModule) {
Â  Â  Â  Â  Â  Â  setIsModuleSidebarOpen(false);
Â  Â  Â  Â  }
Â  Â  }, [pathname, locale, setIsNavigating]);
Â  Â  
Â  Â  
Â  Â  // âœ… CORRECCIÃ“ 1: La funciÃ³ 't' no canvia durant el cicle de vida del component,
Â  Â  // per la qual cosa no cal incloure-la a l'array de dependÃ¨ncies de 'useCallback'.
Â  Â  const checkPlanPermission = useCallback((item: NavItem) => {
Â  Â  Â  Â  const plan = user?.app_metadata?.active_team_plan as string | undefined;
Â  Â  Â  Â  
Â  Â  Â  Â  if (item.requiredPlan && item.requiredPlan.length > 0) {
Â  Â  Â  Â  Â  Â  if (!plan || !item.requiredPlan.includes(plan.toLowerCase())) {
Â  Â  Â  Â  Â  Â  Â  Â  // âœ… CORRECCIÃ“: Obtenim la traducciÃ³ fora del 'toast'
Â  Â  Â  Â  Â  Â  Â  Â  const translatedLabel = t(item.labelKey);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  toast.info("Funcionalitat Premium", {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  description: `El mÃ²dul '${translatedLabel}' nomÃ©s estÃ  disponible als plans ${item.requiredPlan.join(' o ')}.`,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  action: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: "Veure Plans",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onClick: () => router.push(`/${locale}/settings/billing`),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  return true;
Â  Â  }, [user, locale, router, t]); // âœ… Tornem a afegir 't' a les dependÃ¨ncies

Â  Â  // âœ… CORRECCIÃ“ 2: Simplifiquem aquesta funciÃ³.
Â  Â  // La comprovaciÃ³ de permisos ja es fa a 'handleMainMenuClick' o al 'SocialPlannerPage'.
Â  Â  // Aquesta funciÃ³ nomÃ©s s'ha d'encarregar de navegar.
Â  Â  const handleNavigation = useCallback((item: NavItem) => {
Â  Â  Â  Â  if (item.allowedRoles && (!teamRole || !item.allowedRoles.includes(teamRole))) {
Â  Â  Â  Â  Â  Â  toast.error("AccÃ©s restringit", { description: "No tens els permisos necessaris per a accedir a aquesta secciÃ³." });
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const targetPath = `/${locale}${item.path}`;
Â  Â  Â  Â  if (pathname !== targetPath) {
Â  Â  Â  Â  Â  Â  setIsNavigating(true);
Â  Â  Â  Â  Â  Â  router.push(targetPath);
Â  Â  Â  Â  }

Â  Â  Â  Â  if (activeModule?.children?.some(child => child.id === item.id)) {
Â  Â  Â  Â  Â  Â  setIsModuleSidebarOpen(false);
Â  Â  Â  Â  }
Â  Â  }, [teamRole, pathname, locale, router, setIsNavigating, activeModule]);

Â  Â  const handleMainMenuClick = useCallback((item: NavItem) => {
Â  Â  Â  Â  // âœ… CORRECCIÃ“ CLAU: Aquesta Ã©s la lÃ²gica que faltava.
Â  Â  Â  Â  // Si l'Ã­tem Ã©s un mÃ²dul (isSingle: false), no fem la comprovaciÃ³ de pla aquÃ­,
Â  Â  Â  Â  // sinÃ³ que simplement obrim el submenÃº. La comprovaciÃ³ es farÃ  quan es faci
Â  Â  Â  Â  // clic a l'Ã­tem del submenÃº (p. ex., 'Planificador') o a la pÃ gina de destÃ­.
Â  Â  Â  Â  
Â  Â  Â  Â  if (item.isSingle) {
Â  Â  Â  Â  Â  Â  // Si Ã©s un enllaÃ§ directe (com el Dashboard), comprovem el permÃ­s i naveguem.
Â  Â  Â  Â  Â  Â  if (checkPlanPermission(item)) {
Â  Â  Â  Â  Â  Â  Â  Â  handleNavigation(item);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Si Ã©s un mÃ²dul amb fills (com ComunicaciÃ³), nomÃ©s gestionem el submenÃº.
Â  Â  Â  Â  Â  Â  if (activeModule?.id === item.id) {
Â  Â  Â  Â  Â  Â  Â  Â  setIsModuleSidebarOpen(prev => !prev);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  setActiveModule(item);
Â  Â  Â  Â  Â  Â  Â  Â  setIsModuleSidebarOpen(true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }, [activeModule, handleNavigation, checkPlanPermission]);

Â  Â  return {
Â  Â  Â  Â  activeModule,
Â  Â  Â  Â  isModuleSidebarOpen,
Â  Â  Â  Â  setIsModuleSidebarOpen,
Â  Â  Â  Â  handleNavigation,
Â  Â  Â  Â  handleMainMenuClick,
Â  Â  };
}

// =================== FILE: src/hooks/useMediaQuery.ts ===================

/**
 * @file useMediaQuery.ts
 * @summary Aquest fitxer defineix un hook de React personalitzat (`useMediaQuery`) per a la
 * detecciÃ³ de media queries de CSS al costat del client. Ã‰s una eina molt Ãºtil per
 * crear components que s'adapten o canvien el seu comportament segons la mida de la pantalla
 * (ex: mostrar una vista per a mÃ²bils i una altra per a escriptori).
 */

"use client";

import { useState, useEffect } from 'react';

/**
 * @function useMediaQuery
 * @summary Un hook que retorna 'true' si la 'media query' proporcionada coincideix, i 'false' si no.
 * @param {string} query - La 'media query' de CSS a avaluar (ex: '(max-width: 768px)').
 * @returns {boolean} L'estat de coincidÃ¨ncia de la 'media query'.
 */
export function useMediaQuery(query: string) {
  // Inicialitzem l'estat a 'false'. AixÃ² Ã©s important perquÃ¨ aquest codi s'executa primer
  // al servidor durant el Server-Side Rendering (SSR), on l'objecte 'window' no existeix.
  // Si l'inicialitzÃ©ssim basant-nos en 'window.matchMedia', tindrÃ­em un error d'hidrataciÃ³.
Â  const [matches, setMatches] = useState(false);

Â  useEffect(() => {
    // Aquest codi dins de 'useEffect' nomÃ©s s'executa al client (al navegador),
    // on l'objecte 'window' sÃ­ que estÃ  disponible.
Â  Â  const media = window.matchMedia(query);

    // Comprovem si l'estat actual de la 'media query' Ã©s diferent del nostre estat de React
    // i, si Ã©s aixÃ­, el sincronitzem.
Â  Â  if (media.matches !== matches) {
Â  Â  Â  setMatches(media.matches);
Â  Â  }

    // Creem un oient d'esdeveniments que s'activarÃ  cada vegada que l'estat
    // de la 'media query' canviÃ¯ (ex: quan l'usuari redimensiona la finestra).
Â  Â  const listener = () => {
Â  Â  Â  setMatches(media.matches);
Â  Â  };

Â  Â  media.addEventListener('change', listener);
Â  Â  
    // FunciÃ³ de neteja: Quan el component que utilitza aquest hook es desmunta,
    // eliminem l'oient d'esdeveniments per evitar fuites de memÃ²ria.
Â  Â  return () => media.removeEventListener('change', listener);
Â  }, [matches, query]);

Â  return matches;
}


// =================== FILE: src/hooks/usePaginateResource.ts ===================

// src/hooks/usePaginatedResource.ts
import { useState, useEffect, useTransition, useRef, useCallback } from 'react'; // Afegim useCallbackimport { useDebounce } from "use-debounce";
import { toast } from "sonner";
import { type ColumnDef } from "@/components/shared/GenericDataTable";
import { type ActionResult } from "@/types/shared/actionResult"; // Assegura't que aquest tipus existeix
import { useDebounce } from 'use-debounce';
// --- Definicions de Tipus GenÃ¨rics ---
// Aquests tipus haurien de viure en un fitxer compartit,
// com 'src/types/shared/pagination.ts'

/**
 * La resposta paginada esperada del servidor.
 * @template TData El tipus de dades dels items.
 */
export interface PaginatedResponse<TData> {
  data: TData[];
  count: number;
}

/**
 * Els parÃ metres que la funciÃ³ de 'fetch' genÃ¨rica rebrÃ .
 * @template TFilters El tipus dels filtres especÃ­fics d'aquesta pÃ gina.
 */
export interface PaginatedActionParams<TFilters> {
  searchTerm: string;
  filters: TFilters;
  sortBy: string;
  sortOrder: "asc" | "desc";
  limit: number;
  offset: number;
}

// --- Props del Hook ---

interface UsePaginatedResourceProps<
  TData extends { id: string | number },
  TFilters,
> {
  /** Dades inicials carregades al Server Component */
  initialData: PaginatedResponse<TData>;
  /** Estat inicial per als filtres especÃ­fics */
  initialFilters: TFilters;
  /** OrdenaciÃ³ inicial */
  initialSort: { column: string; order: "asc" | "desc" };
  /** DefiniciÃ³ de totes les columnes (per gestionar visibilitat) */
  allColumns: ColumnDef<TData>[];
  /** La Server Action que s'ha de cridar per anar a buscar dades */
  fetchAction: (
    params: PaginatedActionParams<TFilters>,
  ) => Promise<PaginatedResponse<TData>>;
  /** (Opcional) La Server Action que s'ha de cridar per eliminar un item */
  deleteAction?: (id: string | number) => Promise<ActionResult>;
  /** LÃ­mit d'items per pÃ gina */
  initialRowsPerPage?: number;
  rowsPerPageOptions?: number[]; // Opcional, per passar a la taula
  onDeleteSuccess?: () => void;
  toastMessages?: {
    deleteSuccess?: string;
    deleteError?: string;
  };
}

const DEFAULT_ROWS_PER_PAGE = 10;
/**
 * Hook genÃ¨ric per gestionar la lÃ²gica d'un recurs paginat (dades, filtres,
 * ordenaciÃ³, paginaciÃ³, eliminaciÃ³ i visibilitat de columnes).
 */
export function usePaginatedResource<
  TData extends { id: string | number },
  TFilters,
>({
  initialData,
  initialFilters,
  initialSort,
  allColumns,
  fetchAction,
  deleteAction,
  initialRowsPerPage = DEFAULT_ROWS_PER_PAGE,
  rowsPerPageOptions, // Rebem les opcions per retornar-les
  onDeleteSuccess,
  toastMessages,
}: UsePaginatedResourceProps<TData, TFilters>) {
  const [isPending, startTransition] = useTransition();

  // --- Estats ---
  const [data, setData] = useState<TData[]>(initialData.data);
  const [page, setPage] = useState(1);
  // âœ… Nou estat per rowsPerPage
  const [rowsPerPage, setRowsPerPage] = useState(initialRowsPerPage);
  // âœ… TotalPages ara Ã©s un estat que depÃ¨n de count i rowsPerPage
  const [totalPages, setTotalPages] = useState(
    Math.ceil(initialData.count / rowsPerPage),
  );

  const [searchTerm, setSearchTerm] = useState("");
  const [filters, setFilters] = useState<TFilters>(initialFilters);
  const [sorting, setSorting] = useState(initialSort);

  const [debouncedSearchTerm] = useDebounce(searchTerm, 500);
  const isInitialMount = useRef(true);

  // Estat d'eliminaciÃ³
  const [itemToDelete, setItemToDelete] = useState<TData | null>(null);

  // Estat de visibilitat de columnes
  const [columnVisibility, setColumnVisibility] = useState<
    Record<string, boolean>
  >(() => {
    const initialState: Record<string, boolean> = {};
    allColumns.forEach((col) => {
      initialState[col.accessorKey.toString()] = true;
    });
    return initialState;
  });

  // --- Gestors d'Estat ---

  const toggleColumnVisibility = (columnKey: string) => {
    setColumnVisibility((prev) => ({
      ...prev,
      [columnKey]: !prev[columnKey],
    }));
  };
  // âœ… Nou gestor per canviar rowsPerPage
  const handleRowsPerPageChange = useCallback((newRowsPerPage: number) => {
    // ValidaciÃ³ bÃ sica
    if (newRowsPerPage > 0 && newRowsPerPage !== rowsPerPage) {
      setRowsPerPage(newRowsPerPage);
      setPage(1); // <-- Important: Reseteja a la pÃ gina 1
      // No cal fer refetch aquÃ­, l'efecte ho farÃ 
    }
  }, [rowsPerPage]); // DepÃ¨n de rowsPerPage per comparar
  const handleSort = (columnKey: string) => {
    setSorting((prev) => {
      const isSameColumn = prev.column === columnKey;
      const newOrder = isSameColumn && prev.order === "asc" ? "desc" : "asc";
      return { column: columnKey, order: newOrder as "asc" | "desc" };
    });
  };

  const handleSearchChange = (value: string) => {
    setSearchTerm(value);
  };

  /**
   * Gestor genÃ¨ric per actualitzar l'estat dels filtres.
   */
  const handleFilterChange = <K extends keyof TFilters>(
    key: K,
    value: TFilters[K],
  ) => {
    setFilters((prev) => ({ ...prev, [key]: value }));
  };

  const handlePageChange = (newPage: number) => {
    // Assegurem que newPage estigui dins dels lÃ­mits vÃ lids (1 a totalPages)
    const validPage = Math.max(1, Math.min(newPage, totalPages || 1)); // || 1 per evitar 0
    if (validPage !== page) {
      setPage(validPage);
      window.scrollTo(0, 0);
    }
  };

  // Quan filtre/cerca/ordre canvia, reseteja pÃ gina (rowsPerPage no reseteja pÃ gina aquÃ­)
  useEffect(() => {
    if (isInitialMount.current) return;
    setPage(1);
  }, [debouncedSearchTerm, filters, sorting]);

  // Efecte principal per carregar dades
  useEffect(() => {
    if (isInitialMount.current) {
      isInitialMount.current = false;
      return;
    }

    startTransition(async () => {
      // âœ… offset ara depÃ¨n de 'page' i 'rowsPerPage'
      const offset = (page - 1) * rowsPerPage;

      const params: PaginatedActionParams<TFilters> = {
        searchTerm: debouncedSearchTerm,
        filters: filters,
        sortBy: sorting.column,
        sortOrder: sorting.order,
        // âœ… Passem el 'rowsPerPage' actual com a lÃ­mit
        limit: rowsPerPage,
        offset: offset,
      };

      try {
        const result = await fetchAction(params);
        setData(result.data);
        // âœ… Actualitzem totalPages basant-nos en el nou count i rowsPerPage
        const newTotalPages = Math.ceil(result.count / rowsPerPage);
        setTotalPages(newTotalPages > 0 ? newTotalPages : 1); // Assegura mÃ­nim 1 pÃ gina

        // CorrecciÃ³ si estem en una pÃ gina que ja no existeix (desprÃ©s de canviar filtres/rowsPerPage)
        if (page > newTotalPages && newTotalPages > 0) {
            setPage(newTotalPages); // Ves a l'Ãºltima pÃ gina vÃ lida
        } else if (newTotalPages === 0 && page !== 1) {
            setPage(1); // Si no hi ha resultats, ves a la pÃ gina 1
        }

      } catch (error) {
        console.error("Error fetching paginated resource:", error);
        toast.error("Error en carregar les dades.");
      }
    });
    // âœ… Afegim 'rowsPerPage' a les dependÃ¨ncies de l'efecte!
  }, [page, rowsPerPage, debouncedSearchTerm, filters, sorting, fetchAction]);


  // --- LÃ²gica d'EliminaciÃ³ ---
  const handleDelete = () => {
    if (!itemToDelete || !deleteAction) return;

    startTransition(async () => {
        const currentItemId = itemToDelete.id; // Guardem l'ID per si itemToDelete canvia
        const result = await deleteAction(currentItemId);
        if (result.success) {
            toast.success(toastMessages?.deleteSuccess || result.message || "Item eliminat.");
            setItemToDelete(null); // Primer neteja l'estat
            onDeleteSuccess?.();

            // LÃ²gica de recÃ rrega de dades millorada
            setData(prevData => prevData.filter(item => item.id !== currentItemId)); // Elimina directament de l'estat local

            // Si hem eliminat l'Ãºltim element d'una pÃ gina que no era la primera,
            // hem de navegar a la pÃ gina anterior.
            // Fem la comprovaciÃ³ *abans* de recalcular totalPages.
            if (data.length === 1 && page > 1) {
                setPage(prevPage => Math.max(1, prevPage - 1));
            } else {
                 // Si no, forcem un refetch de la pÃ gina actual nomÃ©s si Ã©s necessari
                 // (potser ja no cal amb la neteja de 'data')
                 // Considera si realment necessites forÃ§ar un refetch aquÃ­ o si
                 // la UI ja s'actualitza correctament amb setData.
                 // Per assegurar consistÃ¨ncia amb el count del backend:
                 isInitialMount.current = false; // Permet que l'efecte s'executi
                 // Canviem una dependÃ¨ncia per forÃ§ar l'efecte
                 setFilters(f => ({ ...f })); 
            }

        } else {
            toast.error(toastMessages?.deleteError || result.message || "Error en eliminar.");
        }
    });
  };

  return {
    isPending,
    data,
    itemToDelete,
    setItemToDelete,
    handleDelete,
    columnVisibility,
    toggleColumnVisibility,
    searchTerm,
    handleSearchChange,
    filters,
    handleFilterChange,
    currentSortColumn: sorting.column,
    currentSortOrder: sorting.order,
    handleSort,
    
    // GestiÃ³ de paginaciÃ³
    page,
    totalPages,
    handlePageChange,
    // âœ… Retornem l'estat i el gestor nous
    rowsPerPage,
    handleRowsPerPageChange,
    rowsPerPageOptions, // Retornem les opcions per passar-les a la taula
  };
}

// =================== FILE: src/hooks/useUser.ts ===================

// UbicaciÃ³: /hooks/useUser.ts

import { createClient } from "@/lib/supabase/client";
import { type User } from "@supabase/supabase-js";
import { useEffect, useMemo, useState } from "react";
// âœ… 1. Importem el tipus 'ActiveTeam' que necessitarem
import type { ActiveTeam } from "@/types/app/navigation";

export function useUser() {
    const [user, setUser] = useState<User | null>(null);
    const [teamRole, setTeamRole] = useState<string | null>(null);
    // âœ… 2. Afegim un nou estat per guardar l'objecte de l'equip actiu
    const [activeTeam, setActiveTeam] = useState<ActiveTeam | null>(null);
    const [isLoading, setIsLoading] = useState(true);

    const supabase = useMemo(() => createClient(), []);

    useEffect(() => {
        const { data: authListener } = supabase.auth.onAuthStateChange(
            (event, session) => {
                const currentUser = session?.user || null;
                setUser(currentUser);

                console.log("\n--- onAuthStateChange EVENT (Non-blocking) ---");
                console.log("Event:", event);

                if (currentUser) {
                    const activeTeamId = currentUser.app_metadata
                        ?.active_team_id;
                    if (activeTeamId) {
                        console.log("Usuari amb equip actiu ID:", activeTeamId);

                        // âœ… 3. Creem les dues consultes en paralÂ·lel
                        const rolePromise = supabase
                            .from("team_members")
                            .select("role")
                            .eq("user_id", currentUser.id)
                            .eq("team_id", activeTeamId)
                            .single();

                        // Suposem que 'ActiveTeam' necessita id, name, i logo_url. Ajusta si cal.
                        const teamPromise = supabase
                            .from("teams")
                            .select("id, name, logo_url")
                            .eq("id", activeTeamId)
                            .single();

                        // âœ… 4. Executem les promeses
                        Promise.all([rolePromise, teamPromise])
                            .then(([roleResult, teamResult]) => {
                                const member = roleResult.data;
                                const team = teamResult.data;

                                // Actualitzem tots els estats alhora
                                setTeamRole(member?.role || null);
                                setActiveTeam(team as ActiveTeam || null);
                                setIsLoading(false); // Marquem com a carregat quan tenim tota la info.

                                console.log(
                                    "Rol obtingut:",
                                    member?.role || null,
                                );
                                console.log(
                                    "Equip actiu obtingut:",
                                    team || null,
                                );
                                console.log("-----------------------------\n");
                            })
                            .catch((error) => {
                                console.error(
                                    "Error en carregar dades de sessiÃ³ (rol/equip):",
                                    error,
                                );
                                setTeamRole(null);
                                setActiveTeam(null);
                                setIsLoading(false);
                            });
                    } else {
                        // Si no hi ha equip actiu, netegem tot i finalitzem la cÃ rrega.
                        setTeamRole(null);
                        setActiveTeam(null); // âœ… 5. Resetejem l'equip actiu
                        setIsLoading(false);
                        console.log("No hi ha equip actiu.");
                        console.log("-----------------------------\n");
                    }
                } else {
                    // Si no hi ha usuari, netegem tot i finalitzem la cÃ rrega.
                    setUser(null); // Assegurem que l'usuari tambÃ© es neteja
                    setTeamRole(null);
                    setActiveTeam(null); // âœ… 5. Resetejem l'equip actiu
                    setIsLoading(false);
                    console.log("Usuari desconnectat.");
                    console.log("-----------------------------\n");
                }
            },
        );

        return () => {
            authListener?.subscription.unsubscribe();
        };
    }, [supabase]);

    // âœ… 6. Afegim 'activeTeam' al valor de retorn
    return { user, teamRole, activeTeam, isLoading };
}


// =================== FILE: src/i18n.ts ===================

/**
 * @file src/i18n.ts
 * @summary ConfiguraciÃ³ central per a la internacionalitzaciÃ³ (i18n).
 */
import { getRequestConfig } from 'next-intl/server';
import { notFound } from 'next/navigation';

export const locales = ['ca', 'es', 'en'] as const;
export const defaultLocale = 'ca';

// Definim un tipus per als nostres idiomes
type Locale = typeof locales[number];

export default getRequestConfig(async ({ locale }) => {
  // Si `locale` Ã©s undefined, utilitzem l'idioma per defecte
  const safeLocale = locale || defaultLocale;

  
  // âœ… CORRECCIÃ“: ValidaciÃ³ segura de tipus sense 'as any'
  if (!locales.includes(safeLocale as Locale)) {
    notFound();
  }

  return {
    locale: safeLocale, // ğŸ‘ˆ Ara Ã©s sempre string
    messages: (await import(`../language/${safeLocale}.json`)).default,
  };
});

// =================== FILE: src/lib/data/dashboard.ts ===================

// src/lib/data/dashboard.ts

import { SupabaseClient } from '@supabase/supabase-js';
import { Database, Tables } from '@/types/supabase';
import { EnrichedTask } from '@/components/features/tasks/TaskDialogManager';

// âœ… CORRECCIÃ“ 1: Definim el nou tipus per a les variants de color, que faltava.
export type ServerActivityVariant = 'default' | 'success' | 'danger' | 'warning' | 'info';

export type ServerActivityIcon = 'fileWarning' | 'checkCircle' | 'clock' | 'users';

// âœ… CORRECCIÃ“ 2: Actualitzem el tipus principal per utilitzar `variant` en lloc de `tone`.
export type ServerActivityItem = {
  icon: ServerActivityIcon;
  variant: ServerActivityVariant; // Canviat de 'tone' a 'variant'
  title: string;
  meta: string;
  href: string;
  date: string | null;
};

// --- La resta de funcions per obtenir dades (getStats, getTasks, etc.) es mantenen igual ---
type DashboardStats = {
    total_contacts: number; active_clients: number; opportunities: number; invoiced_current_month: number;
    invoiced_previous_month: number; pending_total: number; expenses_current_month: number; expenses_previous_month: number;
};
export const getStats = async (supabase: SupabaseClient<Database> ): Promise<DashboardStats> => {
    const { data, error } = await supabase.rpc('get_dashboard_stats');
    if (error) { console.error('Error fetching dashboard stats:', error); return { total_contacts: 0, active_clients: 0, opportunities: 0, invoiced_current_month: 0, invoiced_previous_month: 0, pending_total: 0, expenses_current_month: 0, expenses_previous_month: 0 }; }
    return data?.[0] || { total_contacts: 0, active_clients: 0, opportunities: 0, invoiced_current_month: 0, invoiced_previous_month: 0, pending_total: 0, expenses_current_month: 0, expenses_previous_month: 0 };
};
export const getTasks = async (supabase: SupabaseClient<Database>, teamId: string): Promise<EnrichedTask[]> => {
    const { data, error } = await supabase.from('tasks').select('*, contacts(id, nom), departments(id, name), profiles:user_asign_id (id, full_name, avatar_url)').eq('team_id', teamId).order('created_at', { ascending: false });
    if (error) { console.error('Error fetching tasks:', error); return []; }
    return data as unknown as EnrichedTask[];
};
export const getOverdueInvoices = async (
    supabase: SupabaseClient<Database>, 
    teamId: string // <-- 1. AFEGIM EL PARÃ€METRE
): Promise<(Tables<'invoices'> & { contacts: { nom: string } | null })[]> => {
Â  Â  const { data, error } = await supabase
        .from('invoices')
        .select('*, contacts(nom)')
        .eq('team_id', teamId) // <-- 2. AFEGIM EL FILTRE
        .in('status', ['Sent', 'Overdue'])
        .lt('due_date', new Date().toISOString());
        
Â  Â  if (error) { console.error('Error fetching overdue invoices:', error); return []; }
Â  Â  return data ?? [];
};
export const getRecentContacts = async (supabase: SupabaseClient<Database>, teamId: string): Promise<Tables<'contacts'>[]> => {
    const { data, error } = await supabase.from('contacts').select('*').eq('team_id', teamId).order('created_at', { ascending: false });
    if (error) { console.error('Error fetching recent contacts:', error); return []; }
    return data ?? [];
};
// --- Fi de les funcions que no canvien ---


export const getRecentActivities = (
    invoices: (Tables<'invoices'> & { contacts: { nom: string } | null })[],
    tasks: EnrichedTask[],
    contacts: Tables<'contacts'>[]
): ServerActivityItem[] => {
    const activities: ServerActivityItem[] = [];

    invoices.slice(0, 7).forEach(inv => {
        if (inv.due_date) {
            activities.push({
                icon: 'fileWarning',
                variant: 'danger', // âœ… CORRECCIÃ“ 3: Assignem la variant correcta
                title: `Factura venÃ§uda: ${inv.contacts?.nom ?? 'client'}`,
                meta: `Vencia el ${new Date(inv.due_date).toLocaleDateString()}`,
                href: '/finances/facturacio',
                date: inv.due_date
            });
        }
    });

    tasks.slice(0, 7).forEach(task => {
        if (task.created_at) {
            activities.push({
                icon: task.is_completed ? 'checkCircle' : 'clock',
                variant: task.is_completed ? 'success' : 'warning', // âœ… CORRECCIÃ“ 3
                title: task.title,
                meta: `Tasca creada el ${new Date(task.created_at).toLocaleDateString()}`,
                href: '/dashboard', // Pots canviar-ho per l'URL especÃ­fica de la tasca si vols
                date: task.created_at
            });
        }
    });

    contacts.slice(0, 7).forEach(c => {
        if (c.created_at) {
            activities.push({
                icon: 'users',
                variant: 'info', // âœ… CORRECCIÃ“ 3
                title: `Nou contacte: ${c.nom}`,
                meta: `Afegit el ${new Date(c.created_at).toLocaleDateString()}`,
                href: `/crm/contactes/${c.id}`,
                date: c.created_at
            });
        }
    });

    return activities
        .sort((a, b) => new Date(b.date!).getTime() - new Date(a.date!).getTime())
        .slice(0, 15);
};

// =================== FILE: src/lib/google/google-api.ts ===================

// src/lib/google-api.ts
"use server";

import { createClient, createAdminClient } from "@/lib/supabase/server";
// âœ… CORRECCIÃ“: Importem les nostres noves funcions hÃ­brides
import { encryptToken, decryptToken } from '@/lib/utils/crypto';
import { validateUserSession } from "@/lib/supabase/session";
import { Task  } from "@/types/db";
import { ActionResult } from "@/types/shared";
import { revalidatePath } from "next/cache";

// ... (Els teus tipus 'EncryptedCredential' i 'GoogleRefreshResponse' es queden igual)
type EncryptedCredential = {
  refresh_token: string | null;
  access_token: string;
  expires_at: string; // ISO string
  provider_user_id: string;
  team_id: string | null;
};
type GoogleRefreshResponse = {
  access_token: string;
  expires_in: number;
  scope: string;
  token_type: "Bearer";
};


export async function getValidGoogleCalendarToken(userId: string): Promise<string> {
  
  const supabase = createClient(); 
  
  const secretKey = process.env.ENCRYPTION_SECRET_KEY;
  if (!secretKey) {
    throw new Error("La clau d'encriptaciÃ³ no estÃ  configurada.");
  }

  // 1. Obtenir la credencial ENCRIPTADA de la BD
  const { data: creds, error } = await supabase
    .from("user_credentials")
    .select("refresh_token, access_token, expires_at, provider_user_id, team_id")
    .eq("user_id", userId)
    .eq("provider", "google_calendar")
    .returns<EncryptedCredential[]>()
    .single();

  if (error || !creds) {
    throw new Error("No s'ha trobat la credencial de Google Calendar. Si us plau, torna a connectar.");
  }

  // 2. DESENCRIPTAR els tokens usant la funciÃ³ hÃ­brida
  // âœ… CORRECCIÃ“: Fem servir 'await decryptToken'
  const access_token = await decryptToken(creds.access_token, secretKey);
  const refresh_token = creds.refresh_token 
    ? await decryptToken(creds.refresh_token, secretKey) 
    : null;
  
  if (!refresh_token) {
    throw new Error("No s'ha trobat un refresh token vÃ lid (necessari per a l'accÃ©s offline).");
  }

  const expires_at = creds.expires_at;
  const expiresAtDate = new Date(expires_at);

  // 3. Comprovar si el token ha caducat (amb un marge de 5 minuts)
  if (expiresAtDate > new Date(Date.now() + 5 * 60 * 1000)) {
    console.log("Token de Google Calendar vÃ lid. Reutilitzant.");
    return access_token; // El token encara Ã©s bo
  }

  // 4. El token ha caducat. L'hem de refrescar.
  console.log("Token de Google Calendar caducat. Refrescant...");
  const response = await fetch("https://oauth2.googleapis.com/token", {
    // ... (la teva crida a fetch es queda igual)
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      client_id: process.env.GOOGLE_CLIENT_ID!,
      client_secret: process.env.GOOGLE_CLIENT_SECRET!,
      refresh_token: refresh_token,
      grant_type: "refresh_token",
    }),
  });

  if (!response.ok) {
    const errorBody = await response.json();
    console.error("Error en refrescar el token de Google:", errorBody);
    throw new Error("No s'ha pogut refrescar el token de Google. Si us plau, torna a connectar.");
  }

  const newTokens: GoogleRefreshResponse = await response.json();
  const new_expires_at = new Date(Date.now() + newTokens.expires_in * 1000).toISOString();

  // 5. Guardar els nous tokens (encriptats) a la BD
  // âœ… CORRECCIÃ“: Encriptem amb el mÃ¨tode NOU i RÃ€PID (SubtleCrypto)
  const new_encrypted_access_token = await encryptToken(newTokens.access_token, secretKey);
  
  // El refresh token que guardem Ã©s l'original ENCRIPTAT
  // (El 'refresh_token' de Google nomÃ©s es retorna la primera vegada, aixÃ­ que reutilitzem el vell)
  const original_encrypted_refresh_token = creds.refresh_token; 

  const supabaseAdmin = createAdminClient();
  const { error: updateError } = await supabaseAdmin.from("user_credentials").upsert({
      user_id: userId,
      provider: "google_calendar",
      access_token: new_encrypted_access_token, // El nou token rÃ pid
      refresh_token: original_encrypted_refresh_token, // El refresh token encriptat original
      expires_at: new_expires_at,
      team_id: creds.team_id, 
      provider_user_id: creds.provider_user_id,
  }, { onConflict: 'user_id, provider' });


  if (updateError) {
    console.error(`Error en guardar el token refrescat: ${updateError.message}`);
  }

  // 6. Retornar el nou access token (desencriptat)
  return newTokens.access_token;
}

// ... (La resta del teu codi)
// type SyncResult = ...
// async function syncTaskWithGoogle(...)
// export async function syncTaskToGoogleAction(...)
// ... (Tota la lÃ²gica de 'syncTaskWithGoogle' i 'syncTaskToGoogleAction' es queda exactament igual)
type SyncResult = {
  synced: boolean;
  googleCalendarId: string | null;
  message: string;
};

async function syncTaskWithGoogle(
  task: Task,
  accessToken: string,
): Promise<SyncResult> {

  // 1. Definir l'inici i el final de l'esdeveniment
  const endDate = new Date(task.due_date as string);
  const durationInMinutes = typeof task.duration === 'number' ? task.duration : 60;
  const startDate = new Date(endDate.getTime() - durationInMinutes * 60 * 1000);

  // 2. Construir el cos de l'esdeveniment
  const eventBody = {
    summary: task.title,
    description: task.description || "Tasca de Ribotflow",
    start: {
      dateTime: startDate.toISOString(),
      timeZone: "UTC", 
    },
    end: {
      dateTime: endDate.toISOString(),
      timeZone: "UTC",
    },
  };

  let url: string;
  let method: string;

  // 3. Decidir si CREEM (POST) o ACTUALITZEM (PATCH)
  if (task.google_calendar_id) {
    console.log(`Actualitzant tasca ${task.id} a Google Calendar...`);
    url = `https://www.googleapis.com/calendar/v3/calendars/primary/events/${task.google_calendar_id}`;
    method = "PATCH";
  } else {
    console.log(`Creant tasca ${task.id} a Google Calendar...`);
    url = "https://www.googleapis.com/calendar/v3/calendars/primary/events";
    method = "POST";
  }

  // 4. Cridar a l'API de Google
  const response = await fetch(url, {
    method: method,
    headers: {
      "Authorization": `Bearer ${accessToken}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify(eventBody),
  });

  if (!response.ok) {
    const errorBody = await response.json();
    console.error(`Error de Google API [${method}] per a la tasca ${task.id}:`, errorBody);
    
    if (response.status === 404 && task.google_calendar_id) {
      console.log("L'esdeveniment no existia a Google. ForÃ§ant nova creaciÃ³...");
      const newTask = { ...task, google_calendar_id: null };
      return syncTaskWithGoogle(newTask, accessToken);
    }
    
    return {
      synced: false,
      googleCalendarId: task.google_calendar_id, 
      message: errorBody.error.message || "Error desconegut de Google API",
    };
  }

  // 5. Ãˆxit! Obtenim l'ID de Google i el retornem
  const googleEvent = await response.json();
  return {
    synced: true,
    googleCalendarId: googleEvent.id, 
    message: "Sincronitzat correctament.",
  };
}

export async function syncTaskToGoogleAction(
  taskId: number,
): Promise<ActionResult> {
  const session = await validateUserSession();
  if ("error" in session) {
    return { success: false, message: "No autenticat" };
  }
  const { user, supabase } = session;

  try {
    // 1. Obtenim la tasca completa
    const { data: task, error: taskError } = await supabase
      .from("tasks")
      .select("*")
      .eq("id", taskId)
      .single();

    if (taskError) throw new Error(`No s'ha trobat la tasca amb ID ${taskId}`);

    // 2. Obtenim un token vÃ lid (la nostra funciÃ³ mÃ gica)
    const accessToken = await getValidGoogleCalendarToken(user.id);

    // 3. Cridem a la lÃ²gica de sincronitzaciÃ³
    const syncResult = await syncTaskWithGoogle(task, accessToken);

    if (!syncResult.synced) {
      throw new Error(syncResult.message);
    }

    // 4. Si ha anat bÃ©, actualitzem la nostra BD amb el nou google_calendar_id
    if (syncResult.googleCalendarId !== task.google_calendar_id) {
      const { error: updateError } = await supabase
        .from("tasks")
        .update({ google_calendar_id: syncResult.googleCalendarId })
        .eq("id", task.id);
      
      if (updateError) {
        console.error(`Error en desar el google_calendar_id per a la tasca ${task.id}:`, updateError);
      }
    }

    revalidatePath("/[locale]/(app)/crm/calendari", "layout");
    return { success: true, message: "Tasca sincronitzada amb Google Calendar!" };

  } catch (error: unknown) {
    const message = error instanceof Error ? error.message : "Error desconegut";
    console.error("[syncTaskToGoogleAction] Error:", message, error);
    return { success: false, message: message };
  }
}

// =================== FILE: src/lib/pdf/generateInvoicePDF.tsx ===================

// /lib/pdf/generateInvoicePdfBuffer.ts (o la ruta que tinguis)
import { renderToBuffer } from '@react-pdf/renderer'
import qrcode from 'qrcode'
import { type InvoiceDetail } from '@/types/finances/invoices'

// âœ… 1. Importem els nous tipus necessaris
import { type CompanyProfile } from '@/types/settings/team'
import { type Database } from '@/types/supabase'
type Contact = Database['public']['Tables']['contacts']['Row'] | null

// Ajusta la ruta d'importaciÃ³ per apuntar al component "pur"
import { InvoicePdfDocument } from '@/app/[locale]/(app)/finances/invoices/[invoiceId]/_components/PDF/InvoicePdfDocument'

/**
 * AQUESTA Ã‰S L'ADAPTADOR DE SERVIDOR.
 * Genera el buffer del PDF per a una factura.
 * * âœ… 2. La signatura de la funciÃ³ ARA ACCEPTA les dades "en viu"
 */
export async function generateInvoicePdfBuffer(
  invoiceData: InvoiceDetail,
  company: CompanyProfile, // ğŸ‘ˆ NOU
  contact: Contact          // ğŸ‘ˆ NOU
): Promise<Buffer> {
  
  // 1. Generar el QR Code (aixÃ² queda igual)
  let qrCodeDataUrl: string | null = null
  if (invoiceData.verifactu_qr_data) {
    try {
      qrCodeDataUrl = await qrcode.toDataURL(invoiceData.verifactu_qr_data)
    } catch (qrErr) {
      console.error('Error generant QR code al servidor:', qrErr)
    }
  }

  // 2. Definir el document PDF utilitzant el component "pur"
  const PdfDocument = (
    <InvoicePdfDocument
      invoice={invoiceData}
      company={company} // ğŸ‘ˆ PASSEM LA PROP
      contact={contact} // ğŸ‘ˆ PASSEM LA PROP
      qrCodeDataUrl={qrCodeDataUrl}
    />
  )

  // 3. Renderitzar a un buffer
  try {
    const buffer = await renderToBuffer(PdfDocument)
    return buffer
  } catch (error) {
    console.error('Error fatal al renderitzar PDF a buffer:', error)
    throw new Error("No s'ha pogut generar el PDF.")
  }
}

// =================== FILE: src/lib/pdf/generateQuotePDF.tsx ===================

import { renderToBuffer } from '@react-pdf/renderer'
import { QuotePdfDocument } from '@/app/[locale]/(app)/finances/quotes/[id]/_components/PDF/QuotePdfDocument'
import { type EditableQuote } from '@/app/[locale]/(app)/finances/quotes/[id]/_hooks/useQuoteEditor'
import { type Database } from '@/types/supabase'

type Contact = Database['public']['Tables']['contacts']['Row']
type Team = Database['public']['Tables']['teams']['Row']

// FunciÃ³ HELPER per calcular totals
const calculateQuoteTotals = (
  items: EditableQuote['items'],
  discount: number,
  tax_percent: number
) => {
  const subtotal = items.reduce((acc, item) => acc + (item.total || 0), 0)
  const discountAmount = (subtotal * (discount || 0)) / 100
  const taxableBase = subtotal - discountAmount
  const tax = (taxableBase * (tax_percent || 0)) / 100
  const total = taxableBase + tax
  return { subtotal, discountAmount, tax, total }
}

export async function generateQuotePdfBuffer(
  quote: EditableQuote,
  company: Team | null,
  contact: Contact | null
): Promise<Buffer> {
  // Calculem els totals al servidor per assegurar-nos
  const { subtotal, discountAmount, tax, total } = calculateQuoteTotals(
    quote.items || [],
    quote.discount || 0,
    quote.tax_percent || 0
  )

  const document = (
    <QuotePdfDocument
      quote={quote}
      company={company}
      contact={contact}
      subtotal={subtotal}
      discountAmount={discountAmount}
      tax={tax}
      total={total}
    />
  )

  try {
    // âœ… CORRECCIÃ“: Eliminat el 'as ReactElement'.
    // renderToBuffer accepta directament el JSX del Document.
    const buffer = await renderToBuffer(document)
    return buffer
  } catch (error) {
    console.error('Error generant el buffer del PDF del pressupost:', error)
    throw new Error("No s'ha pogut generar el PDF del pressupost.")
  }
}

// =================== FILE: src/lib/permissions/permissions.config.ts ===================

// /src/lib/permissions.config.ts  (AQUEST Ã‰S EL FITXER UNIVERSAL I SEGUR)

// Definim explÃ­citament els rols per a mÃ©s seguretat de tipus.
export const ROLES_LIST = ['owner', 'admin', 'member'] as const;
export type Role = typeof ROLES_LIST[number];

// Definim els permisos de manera granular i clara.
export const PERMISSIONS = {
    MANAGE_TEAM_MEMBERS: 'manage_team_members',
    MANAGE_TEAM_ROLES: 'manage_team_roles',
    MANAGE_TEAM_PROFILE: 'manage_team_profile',
    VIEW_BILLING: 'view_billing',
    MANAGE_BILLING: 'manage_billing',
    VIEW_BLACKLIST: 'view_blacklist',
    MANAGE_BLACKLIST: 'manage_blacklist',
    VIEW_TEAM_STATS: 'view_team_stats',
    MANAGE_INTEGRATIONS: 'manage_integrations',
    MANAGE_CONTACTS: 'manage_contacts',
    VIEW_CONTACTS: 'view_contacts',
} as const;

export type Permission = typeof PERMISSIONS[keyof typeof PERMISSIONS];

// El nostre mapa de rols a permisos, 100% tipat.
export const ROLES: Record<Role, Permission[]> = {
    owner: [
        PERMISSIONS.MANAGE_TEAM_MEMBERS,
        PERMISSIONS.MANAGE_TEAM_ROLES,
        PERMISSIONS.MANAGE_TEAM_PROFILE,
        PERMISSIONS.VIEW_BILLING,
        PERMISSIONS.MANAGE_BILLING,
        PERMISSIONS.VIEW_BLACKLIST,
        PERMISSIONS.MANAGE_BLACKLIST,
        PERMISSIONS.VIEW_TEAM_STATS,
        PERMISSIONS.MANAGE_INTEGRATIONS,
        PERMISSIONS.MANAGE_CONTACTS, // âœ… Afegit
        PERMISSIONS.VIEW_CONTACTS,
    ],
    admin: [
        PERMISSIONS.MANAGE_TEAM_MEMBERS,
        PERMISSIONS.MANAGE_TEAM_ROLES,
        PERMISSIONS.MANAGE_TEAM_PROFILE,
        PERMISSIONS.VIEW_BILLING,
        PERMISSIONS.MANAGE_BILLING,
        PERMISSIONS.VIEW_BLACKLIST,
        PERMISSIONS.MANAGE_BLACKLIST,
        PERMISSIONS.VIEW_TEAM_STATS,
        PERMISSIONS.MANAGE_INTEGRATIONS,
        PERMISSIONS.MANAGE_CONTACTS, // âœ… Afegit
        PERMISSIONS.VIEW_CONTACTS,
    ],
    member: [
        PERMISSIONS.VIEW_BLACKLIST,
        PERMISSIONS.MANAGE_CONTACTS, // âœ… Afegit (Assumim que els membres poden gestionar contactes)
        PERMISSIONS.VIEW_CONTACTS,
    ],
};

/**
 * FunciÃ³ "pura" que comprova si un rol tÃ© un permÃ­s.
 * Ã‰s segura per a ser executada a client i servidor.
 */
export const hasPermission = (role: Role | undefined | null, permission: Permission): boolean => {
    if (!role) return false;
    return ROLES[role]?.includes(permission) || false;
};

// =================== FILE: src/lib/permissions/permissions.ts ===================

import 'server-only';
import {
  validateUserSession,
  type ValidatedSession,
  type SessionError,
} from '../supabase/session'; // Aquest fitxer no canvia

// âœ… Importem les definicions i helpers universals
import {
  hasPermission,
 
  type Permission,
} from './permissions.config';
export * from './permissions.config'; // Re-exportem

// âœ… Importem la nostra NOVA funciÃ³ de context
import {
  getUserTeamContext,
  type UserTeamContext,
} from '../supabase/teamContext';

/**
 * [DEPRECATED] Aquesta funciÃ³ ja no Ã©s necessÃ ria.
 * La lÃ²gica ara estÃ  dins de getUserTeamContext.
 * export async function getUserRoleInTeam(...)
 */

// El nostre "guardiÃ  de seguretat" per a Server Actions.
// Ara retorna el context complet.
type ValidatedSessionWithContext = ValidatedSession & {
  context: UserTeamContext;
};

export async function validateSessionAndPermission(
  requiredPermission: Permission
): Promise<ValidatedSessionWithContext | SessionError> {
  
  // 1. Validem la sessiÃ³ (aixÃ² no canvia)
  // DB Call 1: auth.getUser() (+ fallback a 'profiles' si cal)
  const sessionValidation = await validateUserSession();
  if ('error' in sessionValidation) return sessionValidation;

  const { supabase, user, activeTeamId } = sessionValidation;

  // 2. Obtenim TOT el context (Rol, Pla, etc.) d'UN SOL COP
  // DB Call 2: RPC('get_user_team_context')
  // Aquesta crida estÃ  embolicada amb cache()
  const context = await getUserTeamContext(supabase, user.id, activeTeamId);

  // 3. Validem el permÃ­s contra el rol del context
  if (!hasPermission(context.role, requiredPermission)) {
    return {
      error: { message: 'No tens permisos per a realitzar aquesta acciÃ³.' },
    };
  }

  // 4. Retornem tot
  return { supabase, user, activeTeamId, context };
}

// =================== FILE: src/lib/services/comunicacio/inbox.service.ts ===================

// src/lib/services/comunicacio/inbox.service.ts

import { type SupabaseClient, type PostgrestError } from '@supabase/supabase-js';
import { type Database } from '@/types/supabase';
import type { 
    Contact, 
    EnrichedTicket, 
    TeamMemberWithProfile, 
    Template, 
    InboxPermission,
    DbTableInsert,
    TicketFilter,
    TicketForSupplier, // âœ… Importem el tipus que vam definir a db.ts
    Team 
} from '@/types/db';
import { getTeamMembersWithProfiles } from "@/lib/supabase/teams";

// --- Tipus de Retorn del Servei (Ja el tenies) ---
export type InboxInitialData = {
Â  Â  permissions: InboxPermission[];
Â  Â  teamMembers: TeamMemberWithProfile[];
Â  Â  allTeamContacts: Contact[];
Â  Â  templates: Template[];
Â  Â  receivedCount: number;
Â  Â  sentCount: number;
Â  Â  tickets: EnrichedTicket[];
};

export type InboxDataError = {
Â  Â  permissionsError?: PostgrestError | null;
Â  Â  teamMembersError?: PostgrestError | { message: string } | null;
Â  Â  contactsError?: PostgrestError | null;
Â  Â  templatesError?: PostgrestError | null;
Â  Â  receivedCountError?: PostgrestError | null;
Â  Â  sentCountError?: PostgrestError | null;
Â  Â  ticketsError?: PostgrestError | null;
};

/**
Â * SERVEI (Ja el tenies)
Â * ObtÃ© totes les dades inicials necessÃ ries per a la pÃ gina de l'Inbox.
Â */
export async function getInboxInitialData(
Â  Â  supabase: SupabaseClient<Database>,
Â  Â  userId: string,
Â  Â  teamId: string
): Promise<{ data: InboxInitialData | null; error: InboxDataError | null }> {
    // ... (Aquesta funciÃ³ ja era correcta i no es modifica) ...
Â  Â  // 1. Obtenir permisos
Â  Â  const { data: permissions, error: permissionsError } = await supabase
Â  Â  Â  Â  .from('inbox_permissions')
Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  .eq('team_id', teamId)
Â  Â  Â  Â  .eq('grantee_user_id', userId);

Â  Â  if (permissionsError) {
Â  Â  Â  Â  console.error("Error en carregar els permisos de l'inbox (service):", permissionsError);
Â  Â  Â  Â  return { data: null, error: { permissionsError } };
Â  Â  }

Â  Â  const safePermissions: InboxPermission[] = permissions || [];
Â  Â  const visibleUserIds = [userId, ...(safePermissions.map(p => p.target_user_id).filter(Boolean) || [])];

Â  Â  // 2. Executar la resta de consultes en paralÂ·lel
Â  Â  const [
Â  Â  Â  Â  teamMembersRes,
Â  Â  Â  Â  allTeamContactsRes,
Â  Â  Â  Â  templatesRes,
Â  Â  Â  Â  receivedCountRes,
Â  Â  Â  Â  sentCountRes,
Â  Â  Â  Â  ticketsRes
Â  Â  ] = await Promise.all([
Â  Â  Â  Â  getTeamMembersWithProfiles(supabase, teamId),
Â  Â  Â  Â  supabase.from('contacts').select('*').eq('team_id', teamId),
Â  Â  Â  Â  supabase.from("email_templates").select("*").eq('team_id', teamId),
Â  Â  Â  Â  supabase.rpc('get_inbox_received_count', { p_visible_user_ids: visibleUserIds }),
Â  Â  Â  Â  supabase.rpc('get_inbox_sent_count', { p_visible_user_ids: visibleUserIds }),
Â  Â  Â  Â  supabase.rpc('get_inbox_tickets', {
Â  Â  Â  Â  Â  Â  p_user_id: userId,
Â  Â  Â  Â  Â  Â  p_team_id: teamId,
Â  Â  Â  Â  Â  Â  p_visible_user_ids: visibleUserIds,
Â  Â  Â  Â  Â  Â  p_limit: 50,
Â  Â  Â  Â  Â  Â  p_offset: 0,
Â  Â  Â  Â  Â  Â  p_search_term: '',
Â  Â  Â  Â  Â  Â  p_active_filter: ''
Â  Â  Â  Â  })
Â  Â  ]);

Â  Â  // 3. Comprovar errors
Â  Â  const errors: InboxDataError = {};
Â  Â  if (teamMembersRes.error) errors.teamMembersError = teamMembersRes.error;
Â  Â  if (allTeamContactsRes.error) errors.contactsError = allTeamContactsRes.error;
Â  Â  if (templatesRes.error) errors.templatesError = templatesRes.error;
Â  Â  if (receivedCountRes.error) errors.receivedCountError = receivedCountRes.error;
Â  Â  if (sentCountRes.error) errors.sentCountError = sentCountRes.error;
Â  Â  if (ticketsRes.error) errors.ticketsError = ticketsRes.error;

Â  Â  if (Object.keys(errors).length > 0) {
Â  Â  Â  Â  console.error("Error(s) a getInboxInitialData (service):", errors);
Â  Â  Â  Â  if (permissionsError) errors.permissionsError = permissionsError;
Â  Â  Â  Â  return { data: null, error: errors };
Â  Â  }

Â  Â  // 4. Construir i retornar les dades
Â  Â  const data: InboxInitialData = {
Â  Â  Â  Â  permissions: safePermissions,
Â  Â  Â  Â  teamMembers: (teamMembersRes.data as TeamMemberWithProfile[]) || [],
Â  Â  Â  Â  allTeamContacts: (allTeamContactsRes.data as Contact[]) || [],
Â  Â  Â  Â  templates: (templatesRes.data as Template[]) || [],
Â  Â  Â  Â  receivedCount: receivedCountRes.data || 0,
Â  Â  Â  Â  sentCount: sentCountRes.data || 0,
Â  Â  Â  Â  tickets: (ticketsRes.data as EnrichedTicket[] || [])
Â  Â  };

Â  Â  return { data, error: null };
}

// ---
// âš™ï¸ FUNCIONS DE SERVEI (Mogudes des de 'actions.ts')
// ---

/**
 * SERVEI: Retorna el cos d'un tiquet.
 */
export async function getTicketBody(
    supabase: SupabaseClient<Database>,
    ticketId: number
    // âŒ ELIMINAT: teamId: string -> Aquesta columna no existeix a 'tickets'
): Promise<string> {
    const { data, error } = await supabase
        .from("tickets")
        .select("body")
        .eq("id", ticketId)
        // âŒ ELIMINAT: .eq("team_id", teamId)
        .single();

    if (error) {
        console.error("Error fetching ticket body (service):", error);
        return "<p>Error carregant el cos del tiquet.</p>";
    }
    return data.body ?? "<p>(Sense contingut)</p>";
}

/**
 * SERVEI: Elimina un tiquet.
 * LlanÃ§a un error si falla.
 */
export async function deleteTicket(
    supabase: SupabaseClient<Database>,
    ticketId: number
    // âŒ ELIMINAT: teamId: string
): Promise<void> {
    const { error } = await supabase
        .from("tickets")
        .delete()
        .eq("id", ticketId);
        // âŒ ELIMINAT: .eq("team_id", teamId)

    if (error) {
        console.error("Error a deleteTicket (service):", error);
        throw new Error("No s'ha pogut eliminar el tiquet.");
    }
}

/**
 * SERVEI: Marca un tiquet com a llegit.
 * LlanÃ§a un error si falla.
 */
export async function markTicketAsRead(
    supabase: SupabaseClient<Database>,
    ticketId: number
    // âŒ ELIMINAT: teamId: string
): Promise<void> {
    const { error } = await supabase
        .from("tickets")
        .update({ status: "Llegit" })
        .eq("id", ticketId);
        // âŒ ELIMINAT: .eq("team_id", teamId)

    if (error) {
        console.error("Error a markTicketAsRead (service):", error);
        throw new Error("No s'ha pogut marcar com a llegit.");
    }
}

/**
 * ParÃ metres per al servei d'enviament d'email.
 */
interface SendEmailServiceParams {
    supabase: SupabaseClient<Database>;
    contactId: number;
    subject: string;
    htmlBody: string;
    isReply: boolean;
    userId: string;
    teamId: string;
}

/**
 * SERVEI: Envia un email i realitza lÃ²giques associades
 * (Aquesta funciÃ³ era correcta, no es modifica)
 */
export async function sendEmail({
    supabase,
    contactId,
    subject,
    htmlBody,
    isReply,
    userId,
    teamId,
}: SendEmailServiceParams): Promise<void> {
    // 1. Validar que el contacte pertany a l'equip (Correcte)
    const { data: contact } = await supabase
        .from('contacts')
        .select('id')
        .eq('id', contactId)
        .eq('team_id', teamId) 
        .maybeSingle();

    if (!contact) {
        throw new Error("El contacte no pertany al teu equip actiu.");
    }

    // 2. Invocar la Edge Function (Correcte)
    const { error: invokeError } = await supabase.functions.invoke("send-email", {
        body: { contactId, subject, htmlBody },
    });

    if (invokeError) {
        console.error("Error en invocar 'send-email' (service):", invokeError);
        throw new Error(`Error en el servei d'enviament: ${invokeError.message}`);
    }

    // 3. LÃ²gica de negoci addicional (Correcte)
    if (isReply) {
        const { data: existingOpportunities } = await supabase
            .from("opportunities")
            .select("id")
            .eq("contact_id", contactId)
            .eq("team_id", teamId) // Correcte
            .limit(1);

        if (!existingOpportunities || existingOpportunities.length === 0) {
            const newOpportunity: DbTableInsert<'opportunities'> = {
                team_id: teamId,
                user_id: userId,
                contact_id: contactId,
                name: `Oportunitat: ${subject}`,
                stage_name: "Contactat",
                source: "Resposta Email",
                value: 0,
            };
            await supabase.from("opportunities").insert(newOpportunity).throwOnError();
        }
    }
}

/**
 * SERVEI: Assigna un tiquet a un tracte (opportunity).
 * (Aquesta funciÃ³ era correcta, no es modifica)
 */
export async function assignTicket(
    supabase: SupabaseClient<Database>,
    ticketId: number,
    dealId: number,
    teamId: string
): Promise<void> {
    const newAssignment: DbTableInsert<'ticket_assignments'> = {
        ticket_id: ticketId,
        team_id: teamId,
        deal_id: dealId
    };

    const { error } = await supabase.from('ticket_assignments').insert(newAssignment);

    if (error) {
        console.error("Error en assignar el tiquet (service):", error);
        throw new Error("No s'ha pogut assignar el tiquet.");
    }
}

/**
 * SERVEI: Carrega mÃ©s tiquets de forma paginada.
 * (Aquesta funciÃ³ era correcta, no es modifica)
 */
export async function loadMoreTickets(
    supabase: SupabaseClient<Database>,
    page: number,
    filter: TicketFilter,
    inboxOwnerId: string,
    userId: string,
    teamId: string
): Promise<EnrichedTicket[]> {
    const { data: permissions } = await supabase
        .from('inbox_permissions')
        .select('target_user_id')
        .eq('team_id', teamId)
        .eq('grantee_user_id', userId);

    const allVisibleUserIds = [userId, ...(permissions?.map(p => p.target_user_id) || [])];
    const visibleUserIds = inboxOwnerId === 'all' ? allVisibleUserIds : [inboxOwnerId];
    const ITEMS_PER_PAGE = 50;
    const offset = (page - 1) * ITEMS_PER_PAGE;

    let query = supabase
        .from("enriched_tickets")
        .select('*')
        .in('user_id', visibleUserIds)
        .order("sent_at", { ascending: false })
        .range(offset, offset + ITEMS_PER_PAGE - 1);

    if (filter === "rebuts") {
        query = query.or("type.eq.rebut,type.is.null");
    } else if (filter === "enviats") {
        query = query.eq("type", "enviat");
    }

    const { data, error } = await query;

    if (error) {
        console.error("Error loading more tickets (service):", error);
        return [];
    }

    return data || [];
}

/**
 * SERVEI: Afegeix un email a la llista negra.
 * (Aquesta funciÃ³ era correcta, no es modifica)
 */
export async function addToBlacklist(
    supabase: SupabaseClient<Database>,
    emailToBlock: string,
    userId: string,
    teamId: string
): Promise<void> {
    const cleanedEmail = emailToBlock.trim().toLowerCase();
    if (!cleanedEmail) {
        throw new Error("L'email no pot estar buit.");
    }

    const newRule: DbTableInsert<'blacklist_rules'> = {
        team_id: teamId,
        user_id: userId,
        value: cleanedEmail,
        rule_type: 'email',
    };
    await supabase.from('blacklist_rules').insert(newRule).throwOnError();
}

/**
 * SERVEI: Vincula tots els tiquets d'un remitent a un contacte existent.
 */
export async function linkTicketsToContact(
    supabase: SupabaseClient<Database>,
    contactId: number,
    senderEmail: string,
    userId: string
    // âŒ ELIMINAT: teamId: string
): Promise<void> {
    const { error } = await supabase
        .from("tickets")
        .update({ contact_id: contactId })
        .eq("user_id", userId) // âœ… Aquesta era la lÃ²gica original i correcta
        .eq("sender_email", senderEmail.toLowerCase());
        // âŒ ELIMINAT: .eq("team_id", teamId)

    if (error) {
        console.error("Error a linkTicketsToContact (service):", error);
        throw new Error("Error desconegut al vincular tiquets.");
    }
}

/**
 * SERVEI: Carrega tiquets de forma paginada o per cerca usant RPC.
 * (Aquesta funciÃ³ era correcta, no es modifica)
 */
export async function getTickets(
    supabase: SupabaseClient<Database>,
    page: number,
    filter: TicketFilter,
    inboxOwnerId: string,
    searchTerm: string,
    userId: string,
    teamId: string
): Promise<EnrichedTicket[]> {
    const { data: permissions } = await supabase
        .from('inbox_permissions')
        .select('target_user_id')
        .eq('team_id', teamId)
        .eq('grantee_user_id', userId);

    const allVisibleUserIds = [userId, ...(permissions?.map(p => p.target_user_id) || [])];
    const visibleUserIds = inboxOwnerId === 'all' ? allVisibleUserIds : [inboxOwnerId];
    const ITEMS_PER_PAGE = 50;
    const offset = (page - 1) * ITEMS_PER_PAGE;

    const { data, error } = await supabase.rpc('get_inbox_tickets', {
        p_user_id: userId,
        p_team_id: teamId,
        p_visible_user_ids: visibleUserIds,
        p_limit: ITEMS_PER_PAGE,
        p_offset: offset,
        p_search_term: searchTerm,
        p_active_filter: filter
    });

    if (error) {
        console.error("Error a getTickets (service):", error);
        return [];
    }
    return (data ?? []) as EnrichedTicket[];
}

/**
 * SERVEI: Carrega un tiquet especÃ­fic pel seu ID.
 * (Aquesta funciÃ³ era correcta, no es modifica)
 */
export async function getTicketById(
    supabase: SupabaseClient<Database>,
    ticketId: number,
    userId: string,
    teamId: string
): Promise<EnrichedTicket | null> {
    const { data: permissions } = await supabase
        .from('inbox_permissions')
        .select('target_user_id')
        .eq('team_id', teamId)
        .eq('grantee_user_id', userId);

    const visibleUserIds = [userId, ...(permissions?.map(p => p.target_user_id) || [])];

    const { data: ticket, error } = await supabase
        .from('enriched_tickets')
        .select('*')
        .eq('id', ticketId)
        .in('user_id', visibleUserIds) 
        .limit(1)
        .single();

    if (error) {
        console.error('Error in getTicketById (service):', error);
        throw error;
    }
    return ticket as EnrichedTicket | null;
}

/**
 * SERVEI: ObtÃ© els tickets dels contactes associats a un proveÃ¯dor.
 */
export async function fetchTicketsForSupplierContacts(
  supabase: SupabaseClient<Database>,
  supplierId: string,
  teamId: string
): Promise<TicketForSupplier[]> {
  // 1. ObtÃ© els IDs dels contactes (aquesta part estava bÃ©)
  const { data: contacts, error: contactsError } = await supabase
    .from('contacts')
    .select('id')
    .eq('supplier_id', supplierId)
    .eq('team_id', teamId)

  if (contactsError) {
    console.error(
      'Error fetching contacts for supplier (service):',
      contactsError
    )
    return []
  }

  if (!contacts || contacts.length === 0) {
    return [] // No hi ha contactes, retornem array buit
  }

  const contactIds = contacts.map((c) => c.id)

  // 2. ObtÃ© els tickets per a aquests contactes
  const { data: tickets, error: ticketsError } = await supabase
    .from('tickets')
    .select(
      `
      *, 
      contacts!inner (  /* âœ… 1. Canviem a !inner per assegurar el join */
        id, 
        full_name,
        email
      )
      `
    )
    .in('contact_id', contactIds)
    .eq('team_id', teamId)
    // âœ…âœ…âœ… LÃNIA CLAU DE LA SOLUCIÃ“ âœ…âœ…âœ…
    .eq('contacts.team_id', teamId) /* 2. Afegim filtre RLS a la taula annidada */
    // âœ…âœ…âœ… FI DE LA SOLUCIÃ“ âœ…âœ…âœ…
    .order('last_reply_at', { ascending: false })

  if (ticketsError) {
    // Ara aquest error ja no hauria de ser {}, sinÃ³ un error real si n'hi haguÃ©s
    console.error(
      'Error fetching tickets for supplier contacts (service):',
      ticketsError
    )
    return []
  }

  // Assegurem el tipus de retorn
  return (tickets as unknown as TicketForSupplier[]) || []
}

/**
 * SERVEI: Elimina mÃºltiples tiquets alhora.
 * LlanÃ§a un error si falla.
 */
export async function deleteMultipleTickets(
    supabase: SupabaseClient<Database>,
    ticketIds: number[]
    // âŒ ELIMINAT: teamId: string
): Promise<void> {
    if (!ticketIds || ticketIds.length === 0) {
        throw new Error("No s'han proporcionat tiquets per eliminar.");
    }

    const { error } = await supabase
        .from("tickets")
        .delete()
        .in("id", ticketIds);
        // âŒ ELIMINAT: .eq("team_id", teamId)

    if (error) {
        console.error("Error en l'esborrat mÃºltiple (service):", error);
        throw new Error("No s'han pogut eliminar els tiquets.");
    }
}

/**
 * Tipus de retorn per prepareNetworkContact
 */
export interface NetworkContactData {
    contactId: string;
    subject: string;
    body: string;
}

/**
 * SERVEI: Prepara les dades per a un nou missatge de Network.
 * (Aquesta funciÃ³ era correcta, no es modifica)
 */
export async function prepareNetworkContact(
    supabase: SupabaseClient<Database>,
    recipientTeamId: string,
    projectId: string,
    activeTeam: Team
): Promise<{ data: NetworkContactData, contactCreated: boolean }> {

    // 1. Obtenir dades del projecte
    const { data: projectData, error: projectError } = await supabase
        .from('job_postings')
        .select('title')
        .eq('id', projectId)
        .single();

    if (projectError || !projectData) {
        console.error("Error prepareNetworkContact [Project] (service):", projectError);
        throw new Error("No s'ha pogut trobar el projecte.");
    }
    const { title: projectTitle } = projectData;

    // 2. Obtenir dades de l'equip destinatari
    const { data: recipientTeamData, error: teamError } = await supabase
        .from('teams')
        .select('name, email, owner_id')
        .eq('id', recipientTeamId)
        .single();

    if (teamError || !recipientTeamData) {
        console.error("Error prepareNetworkContact [Team] (service):", teamError);
        throw new Error("No s'ha pogut trobar l'equip destinatari.");
    }

    let recipientEmail = recipientTeamData.email;
    let recipientName = recipientTeamData.name || 'Contacte de Network';

    // 3. Fallback
    if (!recipientEmail) {
        const { data: ownerProfile, error: ownerError } = await supabase
            .from('profiles')
            .select('email, full_name')
            .eq('id', recipientTeamData.owner_id)
            .single();

        if (ownerError || !ownerProfile || !ownerProfile.email) {
            console.error("Error prepareNetworkContact [Owner Profile] (service):", ownerError);
            throw new Error("L'equip destinatari no tÃ© un email de contacte configurat.");
        }
        recipientEmail = ownerProfile.email;
        recipientName = recipientTeamData.name || ownerProfile.full_name || 'Contacte de Network';
    }

    // 4. Buscar si ja existeix un contacte
    let contactId: number;
    let contactCreated = false;
    const { data: existingContact } = await supabase
        .from('contacts')
        .select('id')
        .eq('team_id', activeTeam.id) // Correcte
        .eq('email', recipientEmail)
        .maybeSingle();

    if (existingContact) {
        contactId = existingContact.id;
    } else {
        // 5. Si no existeix, el creem
        const { data: newContact, error: createError } = await supabase
            .from('contacts')
            .insert({
                team_id: activeTeam.id,
                nom: recipientName,
                email: recipientEmail,
            })
            .select('id')
            .single();

        if (createError || !newContact) {
            console.error("Error prepareNetworkContact [Contact Create] (service):", createError);
            throw new Error("No s'ha pogut crear el nou contacte.");
        }
        contactId = newContact.id;
        contactCreated = true; 
    }

    // 6. Preparar les dades inicials
    const initialData: NetworkContactData = {
        contactId: String(contactId),
        subject: `Consulta sobre el projecte: ${projectTitle}`,
        body: `<p>Hola ${recipientName},</p><p><br></p><p>Estic interessat/da en el vostre projecte "<strong>${projectTitle}</strong>" que he vist a la xarxa de Ribotflow.</p><p><br></p><p>Salutacions,</p>`,
    };

    return { data: initialData, contactCreated };
}

// =================== FILE: src/lib/services/comunicacio/marketing.service.ts ===================

// UbicaciÃ³: src/lib/services/marketing/marketing.service.ts

import type { SupabaseClient } from '@supabase/supabase-js';
import type { Database } from '@/types/supabase';
import type {
  Campaign,
  Strategy,
  MarketingPageData,
  
} from '@/types/comunicacio/marketing';

// Definim el tipus per al client de Supabase que rebrem
type ServerSupabaseClient = SupabaseClient<Database>;

/**
 * @summary FunciÃ³ d'ajuda interna per centralitzar les crides a l'API de Gemini.
 * @private
 * @description Aquesta funciÃ³ ara viu dins del servei i Ã©s privada.
 */
async function _callGeminiApi(
  prompt: string,
): Promise<{ data: string | null; error: string | null }> {
  if (!process.env.GEMINI_API_KEY) {
    return { data: null, error: "La clau de l'API de Gemini no estÃ  configurada." };
  }
  try {
    const payload = { contents: [{ role: 'user', parts: [{ text: prompt }] }] };
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${process.env.GEMINI_API_KEY}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      },
    );

    if (!response.ok) {
      console.error('Error de API de Gemini:', await response.text());
      throw new Error(`Error de API de Gemini: ${response.statusText}`);
    }

    const result = await response.json();
    const content = result?.candidates?.[0]?.content?.parts?.[0]?.text;
    if (typeof content !== 'string') {
      throw new Error("La resposta de l'API de Gemini no tÃ© el format esperat.");
    }

    return { data: content, error: null };
  } catch (error: unknown) {
    const message = error instanceof Error ? error.message : 'Error desconegut';
    console.error('Error en la crida a Gemini:', message);
    return { data: null, error: message };
  }
}

/**
 * @summary Genera idees d'estratÃ¨gies de mÃ rqueting.
 * @description ContÃ© la lÃ²gica de prompt i parsing.
 */
async function generateStrategies(
  goal: string,
): Promise<{ data: Strategy[] | null; error: string | null }> {
  const prompt = `
        Ets un director de mÃ rqueting expert per a autÃ²noms i PIMES.
        Un client tÃ© aquest objectiu: "${goal}".
        Proposa 3 estratÃ¨gies de campanya de mÃ rqueting diferents i creatives.
        Respon nomÃ©s amb un array JSON amb camps: 'name', 'type', 'target_audience', 'description'.
    `;

  const { data: rawText, error } = await _callGeminiApi(prompt);
  if (error || !rawText) {
    return { data: null, error: error || "No s'ha rebut resposta de l'IA." };
  }

  try {
    const cleanedJson = rawText.replace(/```json|```/g, '').trim();
    const strategies: Strategy[] = JSON.parse(cleanedJson);
    return { data: strategies, error: null };
  } catch (parseError) {
    console.error("Error en parsejar la resposta JSON de l'IA:", parseError);
    return { data: null, error: "La resposta de l'IA no tenia un format JSON vÃ lid." };
  }
}

/**
 * @summary Redacta el contingut d'una campanya.
 */
async function draftContent(
  goal: string,
  strategy: Strategy,
): Promise<{ data: string | null; error: string | null }> {
  const prompt = `Basant-te en l'objectiu "${goal}" i l'estratÃ¨gia "${strategy.name}", escriu el contingut complet per a la campanya de tipus "${strategy.type}".`;
  return await _callGeminiApi(prompt);
}

/**
 * @summary Desa una nova campanya a la base de dades.
 * @description Rep el client de Supabase per injecciÃ³ de dependÃ¨ncies.
 */
async function saveCampaign(
  supabase: ServerSupabaseClient,
  activeTeamId: string,
  userId: string,
  campaignData: Partial<Campaign>,
  goal: string,
) {
  const dataToInsert = {
    user_id: userId,
    team_id: activeTeamId,
    name: campaignData.name ?? '', // Ensure string, not undefined
    type: campaignData.type ?? '', // Ensure string, not undefined
    status: 'Planificat' as const,
    campaign_date: new Date().toISOString().split('T')[0],
    goal: goal,
    target_audience: campaignData.target_audience ?? null,
    content: campaignData.content ?? null,
  };

  return await supabase.from('campaigns').insert(dataToInsert).select().single();
}

/**
 * @summary Actualitza una campanya existent.
 * @description Afegeix el 'team_id' a la consulta per seguretat RLS.
 */
async function updateCampaign(
  supabase: ServerSupabaseClient,
  campaignId: string,
  updateData: { name: string; content: string },
  activeTeamId: string, // Sempre passem el teamId per RLS
) {
  return await supabase
    .from('campaigns')
    .update(updateData)
    .eq('id', Number(campaignId))
    .eq('team_id', activeTeamId); // Assegurem la pertinenÃ§a a l'equip
}

/**
 * @summary ObtÃ© totes les dades per a la pÃ gina de mÃ rqueting (usat per Server Components).
 * @description ContÃ© la lÃ²gica de crida a l'RPC i el parsing/fallback.
 */
async function getMarketingPageData(
  supabase: ServerSupabaseClient,
  activeTeamId: string,
): Promise<{ data: MarketingPageData | null; error: string | null }> {
  const { data, error } = await supabase.rpc('get_marketing_page_data', {
    p_team_id: activeTeamId,
  });

  if (error) {
    return { data: null, error: typeof error === 'string' ? error : JSON.stringify(error) };
  }

  // Assegurem que les dades sÃ³n correctes abans de retornar-les
  const isObject = typeof data === 'object' && data !== null && !Array.isArray(data);
  const typedData = isObject ? (data as MarketingPageData) : null;

  if (!typedData) {
    // Retornem un estat buit si l'RPC no retorna el format esperat
    const fallbackData: MarketingPageData = {
      kpis: { totalLeads: 0, conversionRate: 0 },
      campaigns: [],
    };
    return { data: fallbackData, error: null };
  }

  return { data: typedData, error: null };
}

// Exportem un objecte 'marketingService' que agrupa totes les funcions
export const marketingService = {
  generateStrategies,
  draftContent,
  saveCampaign,
  updateCampaign,
  getMarketingPageData,
};

// =================== FILE: src/lib/services/comunicacio/socialPlanner.service.ts ===================

// src/lib/services/comunicacio/socialPlanner.service.ts

import { type SupabaseClient, type PostgrestError } from '@supabase/supabase-js';
import { type Database} from '@/types/supabase';

// âœ… CANVI: Importem el tipus des de la nostra font de la veritat
import type { SocialPost } from "@/types/db";
export type { SocialPost }; // Re-exportem per a Ãºs extern (com al SocialPlannerData)

// Definim el nom del bucket centralitzat
const bucketName = 'assets-publics';

// --- Tipus de Dades del Servei ---

export type ConnectionStatuses = {
Â  Â  linkedin: boolean;
Â  Â  facebook: boolean;
Â  Â  instagram: boolean;
};

export type SocialPlannerInitialData = {
Â  Â  posts: SocialPost[];
Â  Â  connectionStatuses: ConnectionStatuses;
};

export type SocialPlannerDataError = {
Â  Â  postsError?: PostgrestError | null;
Â  Â  userCredsError?: PostgrestError | null;
Â  Â  teamCredsError?: PostgrestError | null;
};

type ServerSupabaseClient = SupabaseClient<Database>;


// --- Funcions de LECTURA (Ja la tenies) ---

/**
Â * ObtÃ© les dades inicials per al Planificador Social.
Â */
export async function getSocialPlannerInitialData(
Â  Â  supabase: ServerSupabaseClient,
Â  Â  userId: string,
Â  Â  teamId: string
): Promise<{ data: SocialPlannerInitialData | null; error: SocialPlannerDataError | null }> {

Â  Â  const [postsRes, userCredsRes, teamCredsRes] = await Promise.all([
Â  Â  Â  Â  supabase
Â  Â  Â  Â  Â  Â  .from('social_posts')
Â  Â  Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  Â  Â  .eq('team_id', teamId)
Â  Â  Â  Â  Â  Â  .order('created_at', { ascending: false }),
Â  Â  Â  Â  supabase.from('user_credentials').select('provider').eq('user_id', userId),
Â  Â  Â  Â  supabase.from('team_credentials').select('provider').eq('team_id', teamId)
Â  Â  ]);

Â  Â  // Comprovar errors
Â  Â  const errors: SocialPlannerDataError = {};
Â  Â  if (postsRes.error) errors.postsError = postsRes.error;
Â  Â  if (userCredsRes.error) errors.userCredsError = userCredsRes.error;
Â  Â  if (teamCredsRes.error) errors.teamCredsError = teamCredsRes.error;

Â  Â  if (Object.keys(errors).length > 0) {
Â  Â  Â  Â  console.error("Error(s) a getSocialPlannerInitialData (service):", errors);
Â  Â  Â  Â  return { data: null, error: errors };
Â  Â  }

Â  Â  // Processar dades
Â  Â  const posts = (postsRes.data as SocialPost[]) || [];

Â  Â  const userProviders = userCredsRes.data?.map(c => c.provider) || [];
Â  Â  const teamProviders = teamCredsRes.data?.map(c => c.provider) || [];
Â  Â  const allConnectedProviders = new Set([...userProviders, ...teamProviders]);

Â  Â  const connectionStatuses: ConnectionStatuses = {
Â  Â  Â  Â  linkedin: allConnectedProviders.has('linkedin'),
Â  Â  Â  Â  facebook: allConnectedProviders.has('facebook'),
Â  Â  Â  Â  instagram: allConnectedProviders.has('instagram'),
Â  Â  };

Â  Â  const data: SocialPlannerInitialData = {
Â  Â  Â  Â  posts,
Â  Â  Â  Â  connectionStatuses
Â  Â  };

Â  Â  return { data, error: null };
}

// ---
// âš™ï¸ NOVES Funcions de SERVEI (Escriptura)
// ---

/**
 * SERVEI: Crea URLs de pujada signades.
 * LlanÃ§a un error si falla.
 */
export async function getPresignedUploadUrls(
    supabase: ServerSupabaseClient,
    fileNames: string[],
    userId: string,
    activeTeamId: string
): Promise<{ signedUrls: { signedUrl: string; path: string; }[] }> {
    const signedUrls = await Promise.all(
        fileNames.map(async (fileName) => {
            const fileExt = fileName.split('.').pop();
            // Estructura: 'social_media/[team_id]/[user_id]-[timestamp].[ext]'
            const filePath = `social_media/${activeTeamId}/${userId}-${Date.now()}-${Math.random()}.${fileExt}`;
            
            const { data, error } = await supabase.storage
                .from(bucketName)
                .createSignedUploadUrl(filePath);

            if (error) {
                console.error("Error RLS en crear Signed URL (service):", error.message);
                throw new Error(`Error creant URL per a ${fileName}: ${error.message}`);
            }
            
            return { signedUrl: data.signedUrl, path: data.path };
        })
    );
    return { signedUrls };
}

/**
 * SERVEI: Crea un registre de publicaciÃ³ en esborrany.
 * LlanÃ§a un error si falla.
 */
export async function createSocialPost(
    supabase: ServerSupabaseClient,
    content: string,
    providers: string[],
    mediaPaths: string[] | null,
    mediaType: string | null,
    userId: string,
    activeTeamId: string
): Promise<SocialPost> {
    let media_urls: string[] | null = null;
    if (mediaPaths && mediaPaths.length > 0) {
        media_urls = mediaPaths.map(path =>
            supabase.storage.from(bucketName).getPublicUrl(path).data.publicUrl
        );
    }

    const { data: postData, error: postError } = await supabase
        .from('social_posts') 
        .insert({
            user_id: userId,
            team_id: activeTeamId,
            provider: providers,
            content: content,
            media_url: media_urls as string[], // Supabase espera jsonb, 'string[]' Ã©s el tipus correcte aquÃ­
            media_type: mediaType,
            status: 'draft',
        })
        .select()
        .single();

    if (postError) {
        console.error("Error creant la publicaciÃ³ (service):", postError);
        throw new Error("Error en la base de dades al crear la publicaciÃ³.");
    }
    
    return postData;
}

/**
 * SERVEI: Planifica una publicaciÃ³.
 * LlanÃ§a un error si falla.
 */
export async function scheduleSocialPost(
    supabase: ServerSupabaseClient,
    postId: number,
    scheduledAt: string
): Promise<void> {
    const { error } = await supabase
        .from('social_posts')
        .update({ status: 'scheduled', scheduled_at: scheduledAt })
        .eq('id', postId);

    if (error) {
        console.error("Error planificant la publicaciÃ³ (service):", error);
        throw new Error("No s'ha pogut planificar la publicaciÃ³.");
    }
}

/**
 * SERVEI: Retorna una publicaciÃ³ a l'estat d'esborrany.
 * LlanÃ§a un error si falla.
 */
export async function unscheduleSocialPost(
    supabase: ServerSupabaseClient,
    postId: number
): Promise<void> {
    const { error } = await supabase
        .from('social_posts')
        .update({ status: 'draft', scheduled_at: null })
        .eq('id', postId);

    if (error) {
        console.error("Error desplanificant la publicaciÃ³ (service):", error);
        throw new Error("No s'ha pogut desplanificar la publicaciÃ³.");
    }
}

/**
 * SERVEI: Elimina una publicaciÃ³ social i els seus fitxers d'storage.
 * LlanÃ§a un error si falla.
 */
export async function deleteSocialPost(
    supabase: ServerSupabaseClient,
    postId: number
): Promise<void> {
    // 1. Obtenir els paths dels fitxers
    const { data: post } = await supabase
        .from('social_posts')
        .select('media_url')
        .eq('id', postId)
        .single();

    // 2. Eliminar fitxers d'Storage (si n'hi ha)
    if (post && Array.isArray(post.media_url)) {
        try {
            const pathsToRemove = post.media_url.map((url: string) => {
                const pathname = new URL(url).pathname;
                const pathParts = pathname.split(`/${bucketName}/`);
                return pathParts[1];
            }).filter(Boolean) as string[];

            if (pathsToRemove.length > 0) {
                await supabase.storage.from(bucketName).remove(pathsToRemove);
            }
        } catch (e) {
            console.error("Error en eliminar de Storage (service):", e);
            // No aturem l'esborrat de la BD si falla l'esborrat del fitxer
        }
    }

    // 3. Eliminar la publicaciÃ³ de la BD
    const { error: deleteError } = await supabase
        .from('social_posts')
        .delete()
        .eq('id', postId);

    if (deleteError) {
        console.error("Error eliminant la publicaciÃ³ (service):", deleteError);
        throw new Error("No s'ha pogut eliminar la publicaciÃ³ de la base de dades.");
    }
}

// âŒ ELIMINADA: La definiciÃ³ manual 'interface SocialPost' s'ha esborrat.
// Ara utilitzem la que ve de 'db.ts'.

// =================== FILE: src/lib/services/comunicacio/templates.service.ts ===================

// src/lib/services/comunicacio/templates.service.ts
import { type SupabaseClient } from '@supabase/supabase-js';
import { type Database } from '@/types/supabase';
import type { EmailTemplate, DbTableInsert, DbTableUpdate } from '@/types/db';

type ServerSupabaseClient = SupabaseClient<Database>;

/**
 * SERVEI: ObtÃ© totes les plantilles d'un equip.
 * LlanÃ§a un error si falla.
 */
export async function getTemplates(
    supabase: ServerSupabaseClient,
    teamId: string // Afegim teamId per seguretat explÃ­cita
): Promise<EmailTemplate[]> {
    const { data, error } = await supabase
        .from('email_templates')
        .select('*')
        .eq('team_id', teamId) // RLS ja ho hauria de fer, perÃ² ser explÃ­cit Ã©s bo
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Error en carregar les plantilles (service):', error);
        throw new Error("No s'han pogut carregar les plantilles.");
    }

    // El tipus 'data' ja Ã©s EmailTemplate[] grÃ cies a db.ts
    return data || [];
}

/**
 * SERVEI: Desa (crea o actualitza) una plantilla d'email.
 * LlanÃ§a un error si falla.
 */
export async function saveTemplate(
    supabase: ServerSupabaseClient,
    templateData: Omit<EmailTemplate, "id" | "created_at" | "user_id" | "team_id">,
    templateId: string | null,
    userId: string,
    activeTeamId: string
): Promise<EmailTemplate> {
    if (!templateData.name) {
        throw new Error("El nom de la plantilla Ã©s obligatori.");
    }

    let query;

    if (templateId && templateId !== 'new') {
        // ActualitzaciÃ³
        const updateData: DbTableUpdate<'email_templates'> = templateData;
        query = supabase
            .from('email_templates')
            .update(updateData)
            .eq('id', Number(templateId))
            .eq('team_id', activeTeamId) // Seguretat
            .select()
            .single();
    } else {
        // CreaciÃ³
        const insertData: DbTableInsert<'email_templates'> = {
            ...templateData,
            user_id: userId,
            team_id: activeTeamId
        };
        query = supabase
            .from('email_templates')
            .insert(insertData)
            .select()
            .single();
    }

    const { data, error } = await query;

    if (error) {
        console.error("Error en desar la plantilla (service):", error);
        throw new Error(error.message);
    }

    return data;
}

/**
 * SERVEI: Elimina una plantilla d'email.
 * LlanÃ§a un error si falla.
 */
export async function deleteTemplate(
    supabase: ServerSupabaseClient,
    templateId: string,
    activeTeamId: string
): Promise<void> {
    const { error } = await supabase
        .from('email_templates')
        .delete()
        .eq('id', Number(templateId))
        .eq('team_id', activeTeamId); // Seguretat

    if (error) {
        console.error("Error en eliminar la plantilla (service):", error);
        throw new Error(error.message);
    }
}

// =================== FILE: src/lib/services/comunicacio/transcripcio.service.ts ===================

// src/lib/services/comunicacio/transcripcio.service.ts
import { type SupabaseClient } from '@supabase/supabase-js';
import { type Database } from '@/types/supabase';
import type { DbTableInsert, AudioJob, AudioJobStatus } from '@/types/db';

// ... (Tipus CreateAudioJobArgs es mantÃ© igual) ...
export interface CreateAudioJobArgs {
Â  storagePath: string
Â  participants: ParticipantInput[]
Â  projectId?: string | null
}
type ParticipantInput = {
Â  contact_id: number
Â  name: string
Â  role: string
}

/**
Â * SERVEI: Crea una nova feina (job) a la taula 'audio_jobs'.
Â * LlanÃ§a un error si falla.
Â */
export async function createAudioJob(
Â  Â  supabase: SupabaseClient<Database>,
Â  Â  args: CreateAudioJobArgs,
Â  Â  userId: string,
Â  Â  teamId: string
// âœ… CANVI: La feina retorna un 'string' (el UUID), no un 'number'.
): Promise<string> { 
Â  const { storagePath, participants, projectId } = args;

Â  const dataToInsert: DbTableInsert<'audio_jobs'> = {
Â  Â  team_id: teamId,
Â  Â  user_id: userId,
Â  Â  project_id: projectId || null,
Â  Â  storage_path: storagePath,
Â  Â  participants: participants as ParticipantInput[], 
Â  Â  status: 'pending' as AudioJobStatus,
Â  };

Â  const { data: newJob, error } = await supabase
Â  Â  .from('audio_jobs')
Â  Â  .insert(dataToInsert)
Â  Â  .select('id')
Â  Â  .single();

Â  if (error) {
Â  Â  console.error('Error creant audio_job (service):', error.message);
Â  Â  throw new Error("No s'ha pogut crear la feina d'Ã udio.");
Â  }

Â  // âœ… CANVI: Retornem l'ID directament. Ã‰s un string (uuid).
Â  // âŒ NO FACIS: return Number(newJob.id);
Â  return newJob.id;
}

/**
Â * SERVEI: ObtÃ© els detalls d'una feina d'Ã udio especÃ­fica.
Â * LlanÃ§a un error si falla.
Â */
export async function getAudioJobDetails(
Â  Â  supabase: SupabaseClient<Database>,
Â  Â  jobId: string,
Â  Â  teamId: string
): Promise<AudioJob> {
Â  const { data: job, error } = await supabase
Â  Â  .from('audio_jobs')
Â  Â  .select('*')
Â  Â  .eq('id', jobId) // <--- Ara 'jobId' serÃ  un UUID string vÃ lid
Â  Â  .eq('team_id', teamId) 
Â  Â  .single();

Â  if (error) {
    // Aquesta lÃ­nia Ã©s on es mostrava l'error que has vist
Â  Â  console.error('Error fetching audio job (service):', error.message); 
Â  Â  throw new Error("No s'ha trobat la feina d'Ã udio.");
Â  }

Â  return job as AudioJob;
}

/**
Â * SERVEI: ObtÃ© totes les feines d'Ã udio per a l'equip.
Â * LlanÃ§a un error si falla.
Â */
export async function getTeamAudioJobs(
Â  Â  supabase: SupabaseClient<Database>,
Â  Â  teamId: string
): Promise<Pick<AudioJob, 'id' | 'created_at' | 'status' | 'summary' | 'error_message'>[]> {
Â  const { data: jobs, error } = await supabase
Â  Â  .from('audio_jobs')
Â  Â  .select('id, created_at, status, summary, error_message')
Â  Â  .eq('team_id', teamId)
Â  Â  .order('created_at', { ascending: false });

Â  if (error) {
Â  Â  console.error('Error fetching audio jobs (service):', error.message);
Â  Â  throw new Error("No s'han pogut carregar les feines.");
Â  }
Â  
Â  return jobs || [];
}

/**
 * âœ… NOU SERVEI: Esborra una feina d'Ã udio i el seu arxiu a l'storage.
 * LlanÃ§a un error si falla.
 */
export async function deleteAudioJob(
 Â  Â  supabase: SupabaseClient<Database>,
 Â  Â  jobId: string,
 Â  Â  teamId: string,
    storagePath: string
): Promise<void> {
    // 1. Esborrar la fila de la taula 'audio_jobs'
    const { error: dbError } = await supabase
        .from('audio_jobs')
        .delete()
        .eq('id', jobId)
        .eq('team_id', teamId);

    if (dbError) {
        console.error('Error esborrant feina (service):', dbError.message);
        throw new Error("No s'ha pogut esborrar la transcripciÃ³.");
    }

    // 2. Esborrar l'arxiu de l'storage
    const { error: storageError } = await supabase.storage
        .from('audio-uploads')
        .remove([storagePath]);

    if (storageError) {
        // No llancem error, nomÃ©s ho registrem. La feina ja estÃ  esborrada.
        console.warn(`Error esborrant arxiu de l'storage (${storagePath}):`, storageError.message);
    }
}

/**
 * âœ… NOU SERVEI: ObtÃ© els emails dels contactes participants.
 * LlanÃ§a un error si falla.
 */
export async function getParticipantEmails(
 Â  Â  supabase: SupabaseClient<Database>,
    contactIds: number[],
    teamId: string
): Promise<string[]> {
    if (contactIds.length === 0) return [];

    const { data, error } = await supabase
        .from('contacts')
        .select('email')
        .in('id', contactIds)
        .eq('team_id', teamId)
        .not('email', 'is', null); // Assegurem que l'email no sigui nul

    if (error) {
        console.error('Error obtenint emails participants (service):', error.message);
        throw new Error("No s'han pogut obtenir els emails dels destinataris.");
    }
    
    // Filtrem per assegurar que nomÃ©s retornem emails vÃ lids
    return data.map(c => c.email).filter((email): email is string => !!email);
}

// =================== FILE: src/lib/services/crm/activities/activities.service.ts ===================

import { type SupabaseClient, type PostgrestError } from '@supabase/supabase-js';
import { type Database } from '@/types/supabase';

// 1. El tipus de dada es defineix al servei, que Ã©s el "contracte"
export type ActivityWithContact = Database['public']['Tables']['activities']['Row'] & {
  contacts: Database['public']['Tables']['contacts']['Row'] | null;
};

/**
 * ObtÃ© totes les activitats d'un equip, enriquides amb la informaciÃ³ del contacte.
 */
export async function getActivities(
  supabase: SupabaseClient<Database>, 
  teamId: string
): Promise<{ data: ActivityWithContact[] | null; error: PostgrestError | null }> {
  
  const { data, error } = await supabase
    .from('activities')
    .select('*, contacts(*)')
    .eq('team_id', teamId) // â¬…ï¸ CORRECCIÃ“ DE SEGURETAT: Filtrem per equip
    .order('created_at', { ascending: false });

  if (error) {
    console.error("Error in getActivities (service):", error.message);
    return { data: null, error };
  }
  
  // 2. El 'casting' de tipus es fa dins del servei
  return { data: data as ActivityWithContact[], error: null };
}

// =================== FILE: src/lib/services/crm/calendar/calendar.service.ts ===================

// src/lib/services/calendar.service.ts

import { type SupabaseClient, type PostgrestError } from '@supabase/supabase-js';
import { type Database, type Tables } from '@/types/supabase';
import { type TaskWithAssignee } from '@/types/crm'; // Assegura't que la ruta Ã©s correcta
import { type ActiveSources } from '@/types/crm/calendar'; // Importem el tipus dels filtres
import { z } from 'zod';

// Serveis d'entitat que orquestrarem
import { getTeamMembers } from '@/lib/services/settings/team/team.service';
import { getAllContacts } from '../contacts/contacts.service';
import { getDepartments } from '../../departments.service';

// --- Tipus de Dades ---
export type EnrichedTaskForCalendar = TaskWithAssignee & {
  contacts: Tables<'contacts'> | null;
  departments: Tables<'departments'> | null;
};
export type EnrichedQuoteForCalendar = Tables<'quotes'> & {
  contacts: Pick<Tables<'contacts'>, 'id' | 'nom'> | null;
};
export type EnrichedEmailForCalendar = Tables<'tickets'> & {
  contacts: Pick<Tables<'contacts'>, 'id' | 'nom'> | null;
};

// --- Tipus de Payloads ---
export type CalendarEventsPayload = {
  tasks: EnrichedTaskForCalendar[];
  quotes: EnrichedQuoteForCalendar[];
  sentEmails: EnrichedEmailForCalendar[];
  receivedEmails: EnrichedEmailForCalendar[];
};
export type TeamMember = { id: string; full_name: string | null };
export type CalendarMetadataPayload = {
  teamUsers: TeamMember[];
  contacts: Tables<'contacts'>[];
  departments: Tables<'departments'>[];
};

// --- Tipus d'Errors ---
export type CalendarEventsError = {
    tasksError?: PostgrestError | null;
    quotesError?: PostgrestError | null;
    sentEmailsError?: PostgrestError | null;
    receivedEmailsError?: PostgrestError | null;
    membersError?: PostgrestError | null;
    validationError?: string;
};
export type CalendarMetadataError = {
  usersError?: PostgrestError | null;
  contactsError?: PostgrestError | null;
  departmentsError?: PostgrestError | null;
};

// --- FUNCIÃ“ 1: Obtenir Events (LÃ²gica central integrada des de 'actions') ---
export async function getCalendarEvents(
  supabase: SupabaseClient<Database>,
  teamId: string, // Rep teamId com a parÃ metre
  startDate: string,
  endDate: string,
  activeSources?: ActiveSources
): Promise<{ data: CalendarEventsPayload | null; error: CalendarEventsError | null }> {

  // 1. Definim filtres per defecte
  const filters: ActiveSources = activeSources || {
    tasks: true,
    quotes: false,
    emails: false,
    receivedEmails: false,
  };

  // 2. ValidaciÃ³ de dades d'entrada
  const dateSchema = z.string().datetime({ message: 'La data ha de ser una ISO 8601 string vÃ lida.' });
  if (!dateSchema.safeParse(startDate).success || !dateSchema.safeParse(endDate).success) {
    console.error("Validation error in getCalendarEvents:", { startDate, endDate });
    return { data: null, error: { validationError: 'Rang de dates invÃ lid.' } };
  }

  // 3. Obtenim IDs d'usuaris condicionalment
  let userIdsInTeam: string[] = [];
  if (filters.emails || filters.receivedEmails) {
    const { data: teamMembers, error } = await supabase // Utilitza el 'supabase' rebut
      .from('team_members')
      .select('user_id')
      .eq('team_id', teamId); // Utilitza el 'teamId' rebut

    if (error) {
      console.error("Error fetching team members for calendar (service):", error);
      return { data: null, error: { membersError: error } };
    }
    userIdsInTeam = teamMembers.map(member => member.user_id);
  }

  // 4. Executem consultes condicionalment
  const promises = [];

  // 1. Tasques
  if (filters.tasks) {
    promises.push(
      supabase // Utilitza el 'supabase' rebut
        .from('tasks')
        .select('*, profiles:user_asign_id (id, full_name, avatar_url), contacts(id, nom), departments(id, name)')
        .eq('team_id', teamId) // Utilitza el 'teamId' rebut
        .gte('due_date', startDate)
        .lte('due_date', endDate)
    );
  } else {
    promises.push(Promise.resolve({ data: [] as EnrichedTaskForCalendar[], error: null }));
  }

  // 2. Pressupostos
  if (filters.quotes) {
    promises.push(
      supabase // Utilitza el 'supabase' rebut
        .from('quotes')
        .select('*, contacts (id, nom)')
        .eq('team_id', teamId) // Utilitza el 'teamId' rebut
        .not('expiry_date', 'is', null)
        .gte('expiry_date', startDate)
        .lte('expiry_date', endDate)
    );
  } else {
    promises.push(Promise.resolve({ data: [] as EnrichedQuoteForCalendar[], error: null }));
  }

  // 3. Correus Enviats
  if (filters.emails && userIdsInTeam.length > 0) {
    promises.push(
      supabase // Utilitza el 'supabase' rebut
        .from('tickets')
        .select('*, contacts (id, nom)')
        .in('user_id', userIdsInTeam)
        .eq('type', 'enviat')
        .not('sent_at', 'is', null)
        .gte('sent_at', startDate)
        .lte('sent_at', endDate)
    );
  } else {
    promises.push(Promise.resolve({ data: [] as EnrichedEmailForCalendar[], error: null }));
  }

  // 4. Correus Rebuts
  if (filters.receivedEmails && userIdsInTeam.length > 0) {
    promises.push(
      supabase // Utilitza el 'supabase' rebut
        .from('tickets')
        .select('*, contacts (id, nom)')
        .in('user_id', userIdsInTeam)
        .eq('type', 'rebut')
        .not('sent_at', 'is', null)
        .gte('sent_at', startDate)
        .lte('sent_at', endDate)
    );
  } else {
    promises.push(Promise.resolve({ data: [] as EnrichedEmailForCalendar[], error: null }));
  }

  const [tasksResult, quotesResult, sentEmailsResult, receivedEmailsResult] = await Promise.all(promises);

  // 5. GestiÃ³ d'errors millorada
  const errors: CalendarEventsError = {};
  if (tasksResult.error) errors.tasksError = tasksResult.error;
  if (quotesResult.error) errors.quotesError = quotesResult.error;
  if (sentEmailsResult.error) errors.sentEmailsError = sentEmailsResult.error;
  if (receivedEmailsResult.error) errors.receivedEmailsError = receivedEmailsResult.error;

  if (Object.keys(errors).length > 0) {
    console.error("Error fetching calendar data (service):", errors);
    return { data: null, error: errors };
  }

  // 6. Retornem les dades amb 'casting' segur
  return {
    data: {
      // Afegim '?? []' per assegurar que sempre retornem un array
      tasks: (tasksResult.data as EnrichedTaskForCalendar[] ?? []),
      quotes: (quotesResult.data as EnrichedQuoteForCalendar[] ?? []),
      sentEmails: (sentEmailsResult.data as EnrichedEmailForCalendar[] ?? []),
      receivedEmails: (receivedEmailsResult.data as EnrichedEmailForCalendar[] ?? []),
    },
    error: null
  };
}


// --- FUNCIÃ“ 2: Obtenir Metadata (Sense canvis respecte a la versiÃ³ anterior) ---
export async function getCalendarMetadata(
  supabase: SupabaseClient<Database>,
  teamId: string
): Promise<{ data: CalendarMetadataPayload | null; error: CalendarMetadataError | null }> {

  const [usersResult, contactsResult, departmentsResult] = await Promise.all([
    getTeamMembers(supabase, teamId),
    getAllContacts(supabase, teamId),
    getDepartments(supabase, teamId)
  ]);

  const errors: CalendarMetadataError = {};
  if (usersResult.error) errors.usersError = usersResult.error;
  if (
    'error' in contactsResult &&
    contactsResult.error !== null &&
    typeof contactsResult.error === 'object' &&
    'message' in contactsResult.error &&
    'details' in contactsResult.error &&
    'hint' in contactsResult.error &&
    'code' in contactsResult.error &&
    'name' in contactsResult.error
  ) {
    errors.contactsError = contactsResult.error as PostgrestError;
  }
  if (departmentsResult.error) errors.departmentsError = departmentsResult.error;

  if (Object.keys(errors).length > 0) {
    console.error('Error a getCalendarMetadata (service):', errors);
    return { data: null, error: errors };
  }

  // Processament d'usuaris
  const users = usersResult.data
    ?.filter(member => member.user_id)
    .map(member => ({ id: member.user_id!, full_name: member.full_name })) ?? [];

  return {
    data: {
      teamUsers: users,
      contacts: contactsResult ?? [],
      departments: departmentsResult.data ?? []
    },
    error: null
  };
}


// --- FUNCIÃ“ 3: "Cas d'Ãšs" per a la CÃ rrega Inicial (Sense canvis) ---
export async function getCalendarPageData(
  supabase: SupabaseClient<Database>,
  teamId: string,
  startDate: string,
  endDate: string,
  activeSources?: ActiveSources
): Promise<{
  data: { events: CalendarEventsPayload, metadata: CalendarMetadataPayload } | null;
  error: { eventsError?: CalendarEventsError | null, metadataError?: CalendarMetadataError | null } | null
}> {

  const [eventsResult, metadataResult] = await Promise.all([
    getCalendarEvents(supabase, teamId, startDate, endDate, activeSources),
    getCalendarMetadata(supabase, teamId)
  ]);

  const combinedError: { eventsError?: CalendarEventsError | null, metadataError?: CalendarMetadataError | null } = {};
  if (eventsResult.error) combinedError.eventsError = eventsResult.error;
  if (metadataResult.error) combinedError.metadataError = metadataResult.error;

  if (Object.keys(combinedError).length > 0) {
    console.error("Error a getCalendarPageData (service):", combinedError);
    return { data: null, error: combinedError };
  }

  // Assegurem que data no sigui null si no hi ha error
  return {
    data: {
      events: eventsResult.data!,
      metadata: metadataResult.data!
    },
    error: null
  };
}

// =================== FILE: src/lib/services/crm/contacts/contacts.service.ts ===================

// src/lib/services/crm/contacts/contacts.service.ts

import { type SupabaseClient, type PostgrestError } from '@supabase/supabase-js';
import { type Database } from "@/types/supabase";
import type { 
    Contact, 
    DbTableInsert, 
    DbTableUpdate, 
    Supplier,
    Quote,
    Opportunity,
    Invoice,
    Activity,
    ContactForSupplier
} from '@/types/db';

const ITEMS_PER_PAGE = 50;

// --- Tipus de Retorn del Servei ---

export type ContactWithOpportunities = Contact & {
  opportunities: Pick<Database['public']['Tables']['opportunities']['Row'], 'id' | 'value'>[] | null;
};

export interface GetContactsOptions {
  teamId: string;
  page?: number;
  sortBy?: string;
  status?: string;
  searchTerm?: string;
}

export interface GetContactsPayload {
  contacts: ContactWithOpportunities[];
  totalPages: number;
  currentPage: number;
  totalCount: number;
}

export type ContactDetail = Omit<Contact, 'suppliers'> & {
  suppliers: Pick<Supplier, 'id' | 'nom'> | null;
};

export type ContactRelatedData = {
  quotes: Quote[];
  opportunities: Opportunity[];
  invoices: Invoice[];
  activities: Activity[];
};

// ---
// âš™ï¸ FUNCIONS DE LECTURA (Totes centralitzades aquÃ­)
// ---

export async function getPaginatedContacts(
  supabase: SupabaseClient<Database>,
  options: GetContactsOptions
): Promise<{ data: GetContactsPayload | null; error: PostgrestError | null }> { 
    // ... (lÃ²gica de getPaginatedContacts)
    const { teamId, status, searchTerm, sortBy } = options;
    const currentPage = Number(options.page) || 1;
    const from = (currentPage - 1) * ITEMS_PER_PAGE;
    const to = from + ITEMS_PER_PAGE - 1;

    let query = supabase
      .from('contacts')
      .select('*, opportunities(id, value)', { count: 'exact' })
      .eq('team_id', teamId); 

    if (searchTerm) {
      query = query.or(`nom.ilike.%${searchTerm}%,empresa.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);
    }
    if (status && status !== 'all') {
      query = query.eq('estat', status);
    }
    if (sortBy === 'oldest') {
      query = query.order('created_at', { ascending: true });
    } else {
      query = query.order('created_at', { ascending: false });
    }
    query = query.range(from, to);

    const { data: contacts, error, count } = await query;

    if (error) {
      console.error("Error a getPaginatedContacts (service):", error.message);
      return { data: null, error };
    }

    const totalCount = count || 0;
    const totalPages = Math.ceil(totalCount / ITEMS_PER_PAGE);

    return {
      data: {
        contacts: contacts as ContactWithOpportunities[] || [],
        totalPages,
        currentPage,
        totalCount
      },
      error: null
    };
}

export async function getAllContacts(supabase: SupabaseClient<Database>, teamId: string): Promise<Contact[]> {
  const { data, error } = await supabase.from('contacts').select('*').eq('team_id', teamId);
  if (error) { throw new Error("No s'han pogut carregar els contactes."); }
  return data || [];
}

export async function fetchContactsList(supabase: SupabaseClient<Database>, teamId: string): Promise<Partial<Contact>[]> {
  const { data, error } = await supabase
    .from("contacts")
    .select(`id, nom, email, telefon, estat, empresa, valor`)
    .eq('team_id', teamId)
    .order("nom", { ascending: true });
  if (error) { throw new Error("No s'han pogut carregar la llista de contactes."); }
  return data || [];
}


export async function fetchContactsForSupplier(supabase: SupabaseClient<Database>, supplierId: string, teamId: string): Promise<ContactForSupplier[]> { 
  const { data, error } = await supabase
    .from("contacts")
    .select("id, nom, email, telefon") 
    .eq("supplier_id", supplierId)
    .eq("team_id", teamId)
    .order("nom", { ascending: true });
  if (error) { throw new Error("Error en carregar els contactes del proveÃ¯dor."); }
  return (data as ContactForSupplier[]) || []; 
}

export async function searchContactsForLinking(supabase: SupabaseClient<Database>, teamId: string, searchTerm: string): Promise<Pick<Contact, "id" | "nom" | "email">[]> {
  let query = supabase.from("contacts").select("id, nom, email").eq("team_id", teamId).is("supplier_id", null).limit(10);
  if (searchTerm) { query = query.ilike("nom", `%${searchTerm}%`); }
  const { data, error } = await query;
  if (error) { return []; }
  return data || [];
}

// ---
// âš™ï¸ NOVES FUNCIONS DE LECTURA (per a la pÃ gina de detall)
// ---

export async function fetchContactDetail(
    supabase: SupabaseClient<Database>, 
    contactId: number, 
    teamId: string
): Promise<ContactDetail | null> {
  const { data, error } = await supabase
    .from("contacts")
    .select(`
      *, 
      suppliers (id, nom)
    `)
    .eq("id", contactId)
    .eq("team_id", teamId)
    .single();

  if (error) {
    console.error("Error fetching contact detail (service):", error.message);
    return null; 
  }
  return data as unknown as ContactDetail;
}

export async function getContactRelatedData(
    supabase: SupabaseClient<Database>, 
    contactId: number, 
    teamId: string
): Promise<ContactRelatedData> {
    const [quotesRes, oppsRes, invoicesRes, activitiesRes] = await Promise.all([
        supabase.from('quotes').select('*').eq('contact_id', contactId).eq('team_id', teamId).order('created_at', { ascending: false }),
        supabase.from('opportunities').select('*').eq('contact_id', contactId).eq('team_id', teamId).order('created_at', { ascending: false }),
        supabase.from('invoices').select('*').eq('contact_id', contactId).eq('team_id', teamId).order('created_at', { ascending: false }),
        supabase.from('activities').select('*').eq('contact_id', contactId).eq('team_id', teamId).order('created_at', { ascending: false })
    ]);
    
    return {
        quotes: (quotesRes.data as Quote[]) || [],
        opportunities: (oppsRes.data as Opportunity[]) || [],
        invoices: (invoicesRes.data as Invoice[]) || [],
        activities: (activitiesRes.data as Activity[]) || []
    };
}

// ---
// âš™ï¸ FUNCIONS DE MUTACIÃ“ (Centralitzades)
// ---

export async function createContact(supabase: SupabaseClient<Database>, formData: FormData, userId: string, activeTeamId: string): Promise<Contact> {
  // ... (lÃ²gica de createContact)
  const nom = formData.get("nom") as string;
  const email = formData.get("email") as string;
  if (!nom || !email) { throw new Error("El nom i l'email sÃ³n obligatoris."); }
  const dataToInsert: DbTableInsert<'contacts'> = {
    nom, email,
    empresa: formData.get("empresa") as string,
    telefon: formData.get("telefon") as string,
    estat: formData.get("estat") as Contact['estat'],
    valor: parseFloat(formData.get("valor") as string) || 0,
    team_id: activeTeamId, user_id: userId,
  };
  const { data, error } = await supabase.from("contacts").insert(dataToInsert).select().single();
  if (error) { throw new Error(error.message); }
  return data as Contact;
}

export async function linkContactToSupplier(supabase: SupabaseClient<Database>, contactId: number, supplierId: string, activeTeamId: string): Promise<Contact> {
  // ... (lÃ²gica de linkContactToSupplier)
  const { data: supplierData, error: supplierError } = await supabase.from("suppliers").select("nom").eq("id", supplierId).eq("team_id", activeTeamId).single();
  if (supplierError || !supplierData) { throw new Error("No s'ha pogut trobar el proveÃ¯dor."); }
  const supplierName = (supplierData as Supplier).nom;
  const updateData: DbTableUpdate<'contacts'> = { supplier_id: supplierId, estat: "Proveidor", empresa: supplierName };
  const { data, error } = await supabase.from("contacts").update(updateData).eq("id", contactId).eq("team_id", activeTeamId).select().single();
  if (error) { throw new Error(`Error en vincular el contacte: ${error.message}`); }
  return data as Contact;
}

export async function unlinkContactFromSupplier(supabase: SupabaseClient<Database>, contactId: number, activeTeamId: string): Promise<void> {
  // ... (lÃ²gica de unlinkContactFromSupplier)
  const updateData: DbTableUpdate<'contacts'> = { supplier_id: null, estat: "Lead", empresa: null };
  const { error } = await supabase.from("contacts").update(updateData).eq("id", contactId).eq("team_id", activeTeamId);
  if (error) { throw new Error(`Error en desvincular el contacte: ${error.message}`); }
}

export async function updateContact(
    supabase: SupabaseClient<Database>,
    contactId: number,
    teamId: string,
    formData: FormData
): Promise<ContactDetail> {
  // ... (lÃ²gica de updateContact)
    const hobbiesValue = formData.get('hobbies') as string;
    const supplierId = formData.get('supplier_id') as string;
    
    const birthdayValue = formData.get('birthday') as string;

    const dataToUpdate: DbTableUpdate<'contacts'> = {
        nom: formData.get('nom') as string,
        supplier_id: supplierId || null, 
        email: formData.get('email') as string,
        telefon: formData.get('telefon') as string,
        estat: formData.get('estat') as Contact['estat'],
        job_title: formData.get('job_title') as string,
        industry: formData.get('industry') as string,
        lead_source: formData.get('lead_source') as string,
        birthday: birthdayValue ? birthdayValue : null, 
        notes: formData.get('notes') as string,
        children_count: formData.get('children_count') ? parseInt(formData.get('children_count') as string, 10) : null,
        partner_name: formData.get('partner_name') as string,
        hobbies: hobbiesValue ? hobbiesValue.split(',').map(item => item.trim()) : [],
        address: {
            city: formData.get('address.city') as string,
        },
        social_media: {
            linkedin: formData.get('social_media.linkedin') as string,
        }
    };

    if (dataToUpdate.supplier_id) {
        const { data: supplierData } = await supabase
            .from("suppliers").select("nom").eq("id", dataToUpdate.supplier_id)
            .eq("team_id", teamId).single();
        if (supplierData) {
            dataToUpdate.empresa = supplierData.nom;
        }
    } else {
        dataToUpdate.empresa = null;
    }

    const { data, error } = await supabase
        .from('contacts')
        .update(dataToUpdate)
        .eq('id', contactId)
        .eq('team_id', teamId)
        .select(`*, suppliers (id, nom)`)
        .single();

    if (error) {
        console.error("Error updating contact (service):", error);
        throw new Error(error.message);
    }
    return data as unknown as ContactDetail;
}

export async function deleteContact(
    supabase: SupabaseClient<Database>,
    contactId: number,
    teamId: string
): Promise<void> {
    const { error } = await supabase
        .from('contacts')
        .delete()
        .eq('id', contactId)
        .eq('team_id', teamId);

    if (error) {
        console.error("Error deleting contact (service):", error);
        throw new Error("No s'ha pogut eliminar el contacte.");
    }
}

// ---
// âœ… FUNCIONS AFEGIDES (PER A DETALL DE FACTURA I ALTRES)
// ---

/**
 * SERVEI: ObtÃ© tots els contactes (per a selectors/dropdowns).
 * La consulta Ã©s la que tenÃ­em a 'InvoiceDetailData.tsx'.
 */
export async function getActiveContacts(
  supabase: SupabaseClient<Database>, 
  teamId: string
): Promise<Contact[]> {
  const { data, error } = await supabase
    .from('contacts')
    .select('*') // Obtenim totes les dades
    .eq('team_id', teamId)
    // .is('is_client', true) // Opcional: si nomÃ©s vols clients
    .order('nom', { ascending: true });

  if (error) {
    console.error('Error service(getActiveContacts):', error.message);
    return [];
  }
  return (data as Contact[]) || [];
}

/**
 * SERVEI: ObtÃ© un contacte especÃ­fic pel seu ID.
 * La consulta Ã©s la que tenÃ­em a 'InvoiceDetailData.tsx'.
 */
export async function getContactById(
  supabase: SupabaseClient<Database>,
  teamId: string,
  contactId: number
): Promise<Contact | null> {
  const { data, error } = await supabase
    .from('contacts')
    .select('*')
    .eq('id', contactId)
    .eq('team_id', teamId)
    .single<Contact>();

  if (error) {
    console.error('Error service(getContactById):', error.message);
    return null;
  }
  return data;
}

// =================== FILE: src/lib/services/crm/general/campaignPerformance.service.ts ===================

import { type CampaignPerformanceData } from './types'; // Importa tipus

// Abans _processCampaignPerformance
export function processCampaignPerformance(): CampaignPerformanceData[] {
    // Mantenim les dades mock ja que la consulta a BD fallava
    const mockCampaigns = [
        { name: "Campanya Estiu", cost: 500, revenue_generated: 1500 },
        { name: "Black Friday", cost: 1000, revenue_generated: 4500 },
        { name: "LlanÃ§ament Producte", cost: 200, revenue_generated: 300 },
    ];
    const campaignColors = ["#8b5cf6", "#3b82f6", "#10b981", "#f97316"];
    return mockCampaigns.map((campaign, index) => {
        const cost = campaign.cost ?? 0;
        const revenue = campaign.revenue_generated ?? 0;
        let roi: number | typeof Infinity = 0;
        if (cost > 0) roi = Math.round(((revenue - cost) / cost) * 100);
        else if (revenue > 0) roi = Infinity;
        return {
            name: campaign.name,
            roi: roi,
            fill: campaignColors[index % campaignColors.length],
        };
    });
}

// =================== FILE: src/lib/services/crm/general/charts.service.ts ===================

import { type Tables } from '@/types/supabase';
import { type RawCrmDataResults, type LeadSource, type OpportunityAgingData, type LeadConversionData } from './types'; // Importa tipus

// Abans _processCharts
export function processCharts(rawData: RawCrmDataResults): {
    leadSources: LeadSource[];
    opportunityAging: OpportunityAgingData[];
    leadConversion: LeadConversionData[];
} {
    const now = new Date(); // Necessari per aging

    // Lead Sources
    type OpportunitySource = Pick<Tables<'opportunities'>, 'source'>;
    const leadSourcesData = rawData.leadSourcesRes.data || [];
    const leadSourcesCount = leadSourcesData.reduce<Record<string, number>>((acc, op: OpportunitySource) => {
        const source = op.source || 'Desconegut';
        acc[source] = (acc[source] || 0) + 1;
        return acc;
    }, {});
    const leadSources: LeadSource[] = Object.entries(leadSourcesCount).map(([source, count]) => ({ source, count }));

    // Opportunity Aging & Conversion by Source
    type OpportunityForProcessing = Pick<Tables<'opportunities'>, 'created_at' | 'stage_name' | 'source'>;
    const allOpportunities = (rawData.allOpportunitiesRes.data || []) as OpportunityForProcessing[];

    const agingData: Record<string, { total_days: number; count: number }> = {};
    const conversionData: Record<string, { total: number; won: number }> = {};

    allOpportunities.forEach(op => {
        const source = op.source || 'Desconegut';
        // Processament ConversiÃ³
        if (!conversionData[source]) conversionData[source] = { total: 0, won: 0 };
        conversionData[source].total++;
        if (op.stage_name === 'Guanyat') conversionData[source].won++;

        // Processament Aging (nomÃ©s si no estÃ  tancada)
        if (op.stage_name !== null && op.stage_name !== 'Guanyat' && op.stage_name !== 'Perdut') {
             if (op.created_at) {
                const stageName = op.stage_name;
                if (!agingData[stageName]) agingData[stageName] = { total_days: 0, count: 0 };
                const createdDate = new Date(op.created_at);
                const diffTime = Math.abs(now.getTime() - createdDate.getTime());
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                agingData[stageName].total_days += diffDays;
                agingData[stageName].count++;
             }
        }
    });

    const opportunityAging: OpportunityAgingData[] = Object.entries(agingData).map(([stage_name, data]) => ({
        stage_name,
        avg_days: data.count > 0 ? Math.round(data.total_days / data.count) : 0
    }));
    const leadConversion: LeadConversionData[] = Object.entries(conversionData).map(([source, data]) => ({
        source,
        conversion_rate: data.total > 0 ? Math.round((data.won / data.total) * 100) : 0,
        total: data.total,
    }));

    return { leadSources, opportunityAging, leadConversion };
}

// =================== FILE: src/lib/services/crm/general/dailySummary.service.ts ===================

import { type Tables } from '@/types/supabase';
// âœ… CORRECCIÃ“: Importem des del fitxer d'origen dels tipus
import { type RawCrmDataResults } from './types'; 
import { type DailySummaryData } from '../../crm.service'; // Importa el tipus des de l'arxiu principal

// Abans _processDailySummary
export function processDailySummary(rawData: RawCrmDataResults): DailySummaryData {
    const dailyActivities = rawData.dailyActivitiesRes.data || [];
    // âœ… CORRECCIÃ“: Tipus explÃ­cit per a 'a' dins del filter
    type DailyActivity = Pick<Tables<'activities'>, 'type'>; 
    return {
        tasks_completed: 0, // Fixat a 0 temporalment
        emails_sent: dailyActivities.filter((a: DailyActivity) => a.type === "Email").length,
        quotes_sent: rawData.dailyQuotesRes.count ?? 0,
        meetings_held: dailyActivities.filter((a: DailyActivity) => a.type === "ReuniÃ³").length,
    };
}

// =================== FILE: src/lib/services/crm/general/data.service.ts ===================

// src/lib/services/crm/data.service.ts

import { type SupabaseClient } from '@supabase/supabase-js';
import { type Database } from '@/types/supabase';
import { startOfMonth, subMonths, subDays, startOfDay, endOfDay } from 'date-fns';
import { type RawCrmDataResults} from './types'; // Importem els tipus necessaris

// Helper per definir els tipus de retorn de cada promesa individualment
// AixÃ² fa que el resultat de Promise.all sigui un tuple amb tipus coneguts
const definePromises = (supabase: SupabaseClient<Database>, teamId: string, dates: ReturnType<typeof getDateRanges>) => {
    const { startOfCurrentMonth, startOfLastMonth, thirtyDaysAgo, todayStart, todayEnd } = dates;

    // Definim cada promesa amb el seu tipus de retorn esperat
    return [
        supabase.from('contacts').select('id', { count: 'exact', head: true }).eq('team_id', teamId), // 0
        supabase.from('contacts').select('id', { count: 'exact', head: true }).eq('team_id', teamId).gte('created_at', startOfCurrentMonth), // 1
        supabase.from('opportunities').select('value', { count: 'exact' }).eq('team_id', teamId).not('stage_name', 'in', '("Guanyat", "Perdut")'), // 2
        supabase.from('invoices').select('total_amount, contact_id, issue_date').eq('team_id', teamId).eq('status', 'Paid'), // 3
        supabase.from('opportunities').select('created_at, last_updated_at, value').eq('team_id', teamId).eq('stage_name', 'Guanyat').gte('last_updated_at', startOfCurrentMonth), // 4
        supabase.from('contacts').select('id', { count: 'exact', head: true }).eq('team_id', teamId).lt('created_at', startOfCurrentMonth), // 5
        supabase.from('contacts').select('id', { count: 'exact', head: true }).eq('team_id', teamId).gte('created_at', startOfLastMonth).lt('created_at', startOfCurrentMonth), // 6
        supabase.from('opportunities').select('value', { count: 'exact' }).eq('team_id', teamId).not('stage_name', 'in', '("Guanyat", "Perdut")').gte('created_at', startOfLastMonth).lt('created_at', startOfCurrentMonth), // 7
        supabase.from('opportunities').select('id', { count: 'exact', head: true }).eq('team_id', teamId).gte('created_at', startOfLastMonth).lt('created_at', startOfCurrentMonth), // 8
        supabase.from('opportunities').select('id', { count: 'exact', head: true }).eq('team_id', teamId).eq('stage_name', 'Guanyat').gte('last_updated_at', startOfLastMonth).lt('last_updated_at', startOfCurrentMonth), // 9
        supabase.from('contacts').select('id', { count: 'exact', head: true }).eq('team_id', teamId).eq('estat', 'Lead'), // 10
        supabase.from('contacts').select('id', { count: 'exact', head: true }).eq('team_id', teamId).eq('estat', 'Client'), // 11
        supabase.from('quotes').select('contact_id').eq('team_id', teamId).not('contact_id', 'is', null), // 12
        supabase.from('activities').select('*, contacts(nom, email)').eq('team_id', teamId).eq('is_read', false).order('created_at', { ascending: false }).limit(5), // 13
        supabase.from('invoices').select('total_amount, contacts(id, nom)').eq('team_id', teamId).eq('status', 'Paid'), // 14
        supabase.from('contacts').select('id, nom, last_interaction_at').eq('team_id', teamId).lt('last_interaction_at', thirtyDaysAgo).order('last_interaction_at', { ascending: true }).limit(5), // 15
        supabase.from('opportunities').select('source').eq('team_id', teamId), // 16
        supabase.from('invoices').select('total_amount, contact_id').eq('team_id', teamId).eq('status', 'Paid').gte('issue_date', startOfLastMonth).lt('issue_date', startOfCurrentMonth), // 17
        supabase.from('opportunities').select('created_at, stage_name, source').eq('team_id', teamId), // 18
        supabase.from('activities').select('type').eq('team_id', teamId).gte('created_at', todayStart).lte('created_at', todayEnd), // 19
        supabase.from('quotes').select('id', { count: 'exact', head: true }).eq('team_id', teamId).gte('sent_at', todayStart).lte('sent_at', todayEnd), // 20
    ] as const; // âœ… Usar 'as const' ajuda TypeScript a inferir un tuple type
};

// Helper per a les dates
const getDateRanges = (now: Date = new Date()) => ({
    now,
    startOfCurrentMonth: startOfMonth(now).toISOString(),
    startOfLastMonth: startOfMonth(subMonths(now, 1)).toISOString(),
    thirtyDaysAgo: subDays(now, 30).toISOString(),
    todayStart: startOfDay(now).toISOString(),
    todayEnd: endOfDay(now).toISOString(),
});


// FunciÃ³ principal per obtenir les dades
export async function fetchAllCrmRawData(supabase: SupabaseClient<Database>, teamId: string): Promise<RawCrmDataResults> {

    const dates = getDateRanges();
    const promises = definePromises(supabase, teamId, dates);

    // âœ… Promise.all ara retorna un tuple amb tipus inferits grÃ cies a 'as const'
    const results = await Promise.all(promises);

    // Mapeig manual (ara hauria de ser type-safe si els Ã­ndexs sÃ³n correctes)
    const namedResults: RawCrmDataResults = {
        contactsRes: results[0], newContactsRes: results[1], opportunitiesRes: results[2], paidInvoicesRes: results[3], wonOpportunitiesRes: results[4],
        contactsLastMonthRes: results[5], newContactsLastMonthRes: results[6], opportunitiesLastMonthRes: results[7], allOpportunitiesLastMonthRes: results[8], wonOpportunitiesLastMonthRes: results[9],
        funnelLeadsCountRes: results[10], funnelClientsCountRes: results[11], funnelQuotedCountRes: results[12],
        // Castings explÃ­cits per a resultats amb joins complexos que TS potser no infereix perfectament
        unreadActivitiesRes: results[13] as unknown as RawCrmDataResults['unreadActivitiesRes'],
        topClientsRes: results[14] as unknown as RawCrmDataResults['topClientsRes'],
        coldContactsRes: results[15] as unknown as RawCrmDataResults['coldContactsRes'],
        leadSourcesRes: results[16], paidInvoicesLastMonthRes: results[17], allOpportunitiesRes: results[18],
        dailyActivitiesRes: results[19], dailyQuotesRes: results[20],
        dailyTasksRes: { data: null, error: null, count: 0 }, // Dummy
    };

    // ComprovaciÃ³ d'errors (simplificada)
    const queryNames = Object.keys(namedResults);
    for (let i = 0; i < promises.length; i++) { // Iterem sobre l'Ã­ndex de promeses/resultats
        const res = results[i]; // Accedim al resultat per Ã­ndex
        if (res.error) {
            const queryName = queryNames[i] || `Consulta Ãndex ${i}`;
            console.error(`ğŸš¨ Error en la consulta "${queryName}":`, res.error);
            throw new Error(`Error carregant dades CRM (${queryName}): ${res.error.message || 'Error desconegut (possible RLS?)'}`);
        }
    }

    // Retornem l'objecte amb tipus correcte
    return namedResults;
}

// =================== FILE: src/lib/services/crm/general/funnel.service.ts ===================

import { type RawCrmDataResults, type CrmData } from './types'; // Importa tipus

// Abans _processFunnel
export function processFunnel(rawData: RawCrmDataResults): CrmData['funnel'] {
    const funnelLeadsCount = rawData.funnelLeadsCountRes.count ?? 0;
    const funnelClientsCount = rawData.funnelClientsCountRes.count ?? 0;
    // Comptem contactes Ãºnics que han rebut pressupost
    const funnelQuotedContacts = new Set(rawData.funnelQuotedCountRes.data?.map(q => q.contact_id).filter(Boolean) ?? []).size;

    return {
        leads: funnelLeadsCount,
        quoted: funnelQuotedContacts,
        clients: funnelClientsCount,
    };
}

// =================== FILE: src/lib/services/crm/general/lists.service.ts ===================

import { type Tables } from '@/types/supabase';
import { type RawCrmDataResults, type UnreadActivity, type TopClient, type ColdContact } from './types'; // Importa tipus

// Abans _processLists
export function processLists(rawData: RawCrmDataResults): {
    unreadActivities: UnreadActivity[];
    topClients: TopClient[];
    coldContacts: ColdContact[];
} {
    const unreadActivities = (rawData.unreadActivitiesRes.data as UnreadActivity[] ?? []);

    type TopClientInvoice = Pick<Tables<'invoices'>, 'total_amount'> & {
        contacts: Pick<Tables<'contacts'>, 'id' | 'nom'> | null
    };
    const clientRevenueMap = (rawData.topClientsRes.data ?? []).reduce<Record<string, { id: number; nom: string | null; total: number }>>((acc, inv: TopClientInvoice) => {
        const contact = inv.contacts;
        if (contact && contact.id) {
            if (!acc[contact.id]) acc[contact.id] = { id: contact.id, nom: contact.nom, total: 0 };
            acc[contact.id].total += inv.total_amount ?? 0;
        }
        return acc;
    }, {});
    const topClients: TopClient[] = Object.values(clientRevenueMap)
        .sort((a, b) => b.total - a.total)
        .slice(0, 5)
        .map(c => ({ id: c.id, nom: c.nom, total_invoiced: c.total }));

    const coldContacts = (rawData.coldContactsRes.data as ColdContact[] ?? []);

    return { unreadActivities, topClients, coldContacts };
}

// =================== FILE: src/lib/services/crm/general/revenue.service.ts ===================

import { type Tables } from '@/types/supabase';
import { type RawCrmDataResults, type CrmData } from './types'; // Importa tipus
import { startOfMonth } from 'date-fns';

// Abans _processRevenue
export function processRevenue(
    rawData: RawCrmDataResults,
    // Rep els stats ja processats per obtenir pipelineValue i conversionRate
    stats: CrmData['stats']
): CrmData['revenue'] {
    const now = new Date();
    const startOfCurrentMonth = startOfMonth(now).toISOString();

    const paidInvoices = rawData.paidInvoicesRes.data ?? [];
    type PaidInvoice = Pick<Tables<'invoices'>, 'total_amount' | 'contact_id' | 'issue_date'>;

    const currentMonthRevenue = paidInvoices
        .filter(inv => inv.issue_date && new Date(inv.issue_date) >= new Date(startOfCurrentMonth))
        .reduce((sum: number, inv: PaidInvoice) => sum + (inv.total_amount ?? 0), 0);

    // Parsejem pipelineValue i conversionRate dels stats processats
    const pipelineValue = parseFloat(String(stats.pipelineValue.value).replace(/[â‚¬.]/g, '').replace(',', '.')) || 0;
    const conversionRate = parseFloat(String(stats.conversionRate.value).replace('%', '')) || 0;

    return {
        monthlyForecast: pipelineValue * (conversionRate / 100),
        currentMonthRevenue: currentMonthRevenue,
    };
}

// =================== FILE: src/lib/services/crm/general/stats.service.ts ===================

import { type Tables } from '@/types/supabase';
// âœ… CORRECCIÃ“ 1: Importem des de './types' i assegurem que tots els tipus necessaris hi sÃ³n
import { type RawCrmDataResults, type CrmData } from './types';

// Helper privat si nomÃ©s s'usa aquÃ­
const calculateTrend = (current: number, previous: number): number => {
    if (previous === 0) return current > 0 ? 100 : 0;
    return Math.round(((current - previous) / previous) * 100);
};

// Abans _processStats
export function processStats(rawData: RawCrmDataResults): CrmData['stats'] {
    const totalContacts = rawData.contactsRes.count ?? 0;
    const totalContactsLastMonth = rawData.contactsLastMonthRes.count ?? 0;
    const newContactsThisMonth = rawData.newContactsRes.count ?? 0;
    const newContactsLastMonth = rawData.newContactsLastMonthRes.count ?? 0;
    const opportunitiesCount = rawData.opportunitiesRes.count ?? 0;
    const opportunitiesCountLastMonth = rawData.opportunitiesLastMonthRes.count ?? 0;

    type OpportunityValue = Pick<Tables<'opportunities'>, 'value'>;
    const pipelineValue = rawData.opportunitiesRes.data?.reduce((sum: number, op: OpportunityValue) => sum + (op.value ?? 0), 0) ?? 0;
    const pipelineValueLastMonth = rawData.opportunitiesLastMonthRes.data?.reduce((sum: number, op: OpportunityValue) => sum + (op.value ?? 0), 0) ?? 0;

    type PaidInvoice = Pick<Tables<'invoices'>, 'total_amount' | 'contact_id' | 'issue_date'>;
    const paidInvoices = rawData.paidInvoicesRes.data ?? [];
    const totalRevenue = paidInvoices.reduce((sum: number, inv: PaidInvoice) => sum + (inv.total_amount ?? 0), 0);
    // âœ… CORRECCIÃ“ 2: Tipem 'inv' explÃ­citament en el .map()
    const uniqueClientsWithRevenue = new Set(paidInvoices.map((inv: PaidInvoice) => inv.contact_id).filter(Boolean)).size;
    const avgRevenuePerClient = uniqueClientsWithRevenue > 0 ? totalRevenue / uniqueClientsWithRevenue : 0;

    type PaidInvoiceLastMonth = Pick<Tables<'invoices'>, 'total_amount' | 'contact_id'>;
    const paidInvoicesLastMonth = rawData.paidInvoicesLastMonthRes.data ?? [];
    const totalRevenueLastMonth = paidInvoicesLastMonth.reduce((sum: number, inv: PaidInvoiceLastMonth) => sum + (inv.total_amount ?? 0), 0);
    // âœ… CORRECCIÃ“ 2: Tipem 'inv' explÃ­citament en el .map()
    const uniqueClientsLastMonth = new Set(paidInvoicesLastMonth.map((inv: PaidInvoiceLastMonth) => inv.contact_id).filter(Boolean)).size;
    const avgRevenuePerClientLastMonth = uniqueClientsLastMonth > 0 ? totalRevenueLastMonth / uniqueClientsLastMonth : 0;

    const funnelLeadsCount = rawData.funnelLeadsCountRes.count ?? 0;
    const funnelClientsCount = rawData.funnelClientsCountRes.count ?? 0;
    const conversionRate = funnelLeadsCount > 0 ? (funnelClientsCount / funnelLeadsCount) * 100 : 0;
    const totalOpportunitiesCreatedLastMonth = rawData.allOpportunitiesLastMonthRes.count ?? 0;
    const wonOpportunitiesLastMonthCount = rawData.wonOpportunitiesLastMonthRes.count ?? 0;
    const conversionRateLastMonth = totalOpportunitiesCreatedLastMonth > 0 ? (wonOpportunitiesLastMonthCount / totalOpportunitiesCreatedLastMonth) * 100 : 0;

    type WonOpportunityTiming = Pick<Tables<'opportunities'>, 'created_at' | 'last_updated_at' | 'value'>;
    const wonOpportunities = rawData.wonOpportunitiesRes.data ?? [];
    const totalConversionTimeMillis = wonOpportunities.reduce((sum: number, op: WonOpportunityTiming) => {
        if (op.created_at && op.last_updated_at) {
          const timeDiff = new Date(op.last_updated_at).getTime() - new Date(op.created_at).getTime();
          return sum + (timeDiff > 0 ? timeDiff : 0);
        }
        return sum;
    }, 0);
    const avgConversionTimeDays = wonOpportunities.length > 0 ? Math.round(totalConversionTimeMillis / wonOpportunities.length / (1000 * 60 * 60 * 24)) : 0;
    const avgDealValue = wonOpportunities.length > 0 ? wonOpportunities.reduce((sum: number, op: WonOpportunityTiming) => sum + (op.value ?? 0), 0) / wonOpportunities.length : 0;
    const salesVelocity = avgConversionTimeDays > 0 ? (opportunitiesCount * avgDealValue * (conversionRate / 100)) / avgConversionTimeDays : 0;

    return {
        totalContacts: { value: totalContacts, trend: calculateTrend(totalContacts, totalContactsLastMonth) },
        newContactsThisMonth: { value: newContactsThisMonth, trend: calculateTrend(newContactsThisMonth, newContactsLastMonth) },
        opportunities: { value: opportunitiesCount, trend: calculateTrend(opportunitiesCount, opportunitiesCountLastMonth) },
        pipelineValue: { value: `â‚¬${pipelineValue.toLocaleString('es-ES', { maximumFractionDigits: 0 })}`, trend: calculateTrend(pipelineValue, pipelineValueLastMonth) },
        avgRevenuePerClient: { value: `â‚¬${avgRevenuePerClient.toLocaleString('es-ES', { maximumFractionDigits: 0 })}`, trend: calculateTrend(avgRevenuePerClient, avgRevenuePerClientLastMonth) },
        conversionRate: { value: `${conversionRate.toFixed(1)}%`, trend: calculateTrend(conversionRate, conversionRateLastMonth) },
        salesVelocity: { value: `â‚¬${salesVelocity.toLocaleString('es-ES', { maximumFractionDigits: 0 })}/dia`, trend: 0 },
        avgConversionTimeDays: { value: `${avgConversionTimeDays} dies`, trend: 0 },
    };
}

// =================== FILE: src/lib/services/crm/general/types.ts ===================

// src/lib/services/crm/types.ts

import {  type Tables } from '@/types/supabase';
import { type PostgrestError } from '@supabase/supabase-js';

// --- Tipus de Dades EspecÃ­fics del Dashboard ---
export type CampaignPerformanceData = {
    name: string;
    roi: number | typeof Infinity;
    fill: string;
};
export type DailySummaryData = {
    tasks_completed: number;
    emails_sent: number;
    quotes_sent: number;
    meetings_held: number;
};
export type KpiData = {
    value: number | string;
    trend: number;
};
export type UnreadActivity = Tables<'activities'> & {
    contacts: Pick<Tables<'contacts'>, 'nom' | 'email'> | null;
};
export type TopClient = { id: number; nom: string | null; total_invoiced: number; };
export type ColdContact = Pick<Tables<'contacts'>, 'id' | 'nom' | 'last_interaction_at'>;
export type LeadSource = { source: string; count: number; };
export type OpportunityAgingData = {
    stage_name: string;
    avg_days: number;
};
export type LeadConversionData = {
    source: string;
    conversion_rate: number;
    total: number;
};

// --- Payload Principal ---
export type CrmData = {
    stats: {
        totalContacts: KpiData;
        newContactsThisMonth: KpiData;
        opportunities: KpiData;
        pipelineValue: KpiData;
        avgRevenuePerClient: KpiData;
        conversionRate: KpiData;
        salesVelocity: KpiData;
        avgConversionTimeDays: KpiData;
    };
    funnel: {
        leads: number;
        quoted: number; // Nombre de contactes Ãºnics amb pressupost
        clients: number;
    };
    revenue: {
        monthlyForecast: number;
        currentMonthRevenue: number;
    };
    unreadActivities: UnreadActivity[];
    topClients: TopClient[];
    coldContacts: ColdContact[];
    leadSources: LeadSource[];
    opportunityAging: OpportunityAgingData[];
    leadConversion: LeadConversionData[];
    campaignPerformance: CampaignPerformanceData[];
    dailySummary: DailySummaryData;
};

// --- Tipus de Retorn del Servei Principal ---
export type CrmServiceResponse = Promise<{ data: CrmData | null; error: { message: string, details?: unknown } | null }>;

// --- Tipus per a les Dades Brutes Obtingudes ---
// Definim un tipus genÃ¨ric per a les respostes de Supabase amb possibles errors
type SupabaseResponse<T> = { data: T | null; error: PostgrestError | null; count?: number | null };

// Usem el tipus genÃ¨ric per definir RawCrmDataResults
export type RawCrmDataResults = {
    contactsRes: SupabaseResponse<Pick<Tables<'contacts'>, 'id'>[]>;
    newContactsRes: SupabaseResponse<Pick<Tables<'contacts'>, 'id'>[]>;
    opportunitiesRes: SupabaseResponse<Pick<Tables<'opportunities'>, 'value'>[]>;
    paidInvoicesRes: SupabaseResponse<Pick<Tables<'invoices'>, 'total_amount' | 'contact_id' | 'issue_date'>[]>;
    wonOpportunitiesRes: SupabaseResponse<Pick<Tables<'opportunities'>, 'created_at' | 'last_updated_at' | 'value'>[]>;
    contactsLastMonthRes: SupabaseResponse<Pick<Tables<'contacts'>, 'id'>[]>;
    newContactsLastMonthRes: SupabaseResponse<Pick<Tables<'contacts'>, 'id'>[]>;
    opportunitiesLastMonthRes: SupabaseResponse<Pick<Tables<'opportunities'>, 'value'>[]>;
    allOpportunitiesLastMonthRes: SupabaseResponse<Pick<Tables<'opportunities'>, 'id'>[]>;
    wonOpportunitiesLastMonthRes: SupabaseResponse<Pick<Tables<'opportunities'>, 'id'>[]>;
    funnelLeadsCountRes: SupabaseResponse<Pick<Tables<'contacts'>, 'id'>[]>;
    funnelClientsCountRes: SupabaseResponse<Pick<Tables<'contacts'>, 'id'>[]>;
    funnelQuotedCountRes: SupabaseResponse<Pick<Tables<'quotes'>, 'contact_id'>[]>;
    unreadActivitiesRes: SupabaseResponse<UnreadActivity[]>;
    topClientsRes: SupabaseResponse<(Pick<Tables<'invoices'>, 'total_amount'> & { contacts: Pick<Tables<'contacts'>, 'id' | 'nom'> | null })[]>;
    coldContactsRes: SupabaseResponse<ColdContact[]>;
    leadSourcesRes: SupabaseResponse<Pick<Tables<'opportunities'>, 'source'>[]>;
    paidInvoicesLastMonthRes: SupabaseResponse<Pick<Tables<'invoices'>, 'total_amount' | 'contact_id'>[]>;
    allOpportunitiesRes: SupabaseResponse<Pick<Tables<'opportunities'>, 'created_at' | 'stage_name' | 'source'>[]>;
    dailyActivitiesRes: SupabaseResponse<Pick<Tables<'activities'>, 'type'>[]>;
    dailyQuotesRes: SupabaseResponse<Pick<Tables<'quotes'>, 'id'>[]>;
    dailyTasksRes: { data: null; error: null; count: number }; // Resultat dummy
};

// =================== FILE: src/lib/services/crm/pipeline/opportunities.service.ts ===================

import { type SupabaseClient } from '@supabase/supabase-js';
import { type Database } from '@/types/supabase';
import type { Opportunity, DbTableInsert, DbTableUpdate } from '@/types/db';

/**
Â * SERVEI: ObtÃ© oportunitats amb la informaciÃ³ bÃ sica del contacte.
Â */
export async function getOpportunitiesWithContact(supabase: SupabaseClient<Database>, teamId: string) {
Â  return supabase
Â  Â  .from('opportunities')
Â  Â  .select('*, contacts(id, nom)')
Â  Â  .eq('team_id', teamId);
}

// ---
// âš™ï¸ NOVES FUNCIONS DE MUTACIÃ“ (Mogudes des de 'actions.ts')
// ---

/**
Â * SERVEI: Desa (crea o actualitza) una oportunitat.
Â * LlanÃ§a un error si falla.
Â */
export async function saveOpportunity(
Â  Â  supabase: SupabaseClient<Database>,
Â  Â  formData: FormData,
Â  Â  userId: string,
Â  Â  activeTeamId: string
): Promise<Opportunity> {
Â  Â  
Â  Â  const rawData = Object.fromEntries(formData.entries());
Â  Â  
Â  Â  const contactId = rawData.contact_id ? parseInt(rawData.contact_id as string, 10) : null;
Â  Â  const opportunityId = rawData.id ? parseInt(rawData.id as string, 10) : null;
Â  Â  const closeDateValue = rawData.close_date as string;

    // âœ… CORRECCIÃ“: En lloc d'un tipus uniÃ³, definim l'objecte base.
Â  Â  const dataToSave = {
Â  Â  Â  Â  name: rawData.name as string,
Â  Â  Â  Â  description: rawData.description as string,
Â  Â  Â  Â  contact_id: contactId,
Â  Â  Â  Â  stage_name: rawData.stage_name as string,
Â  Â  Â  Â  value: rawData.value ? parseFloat(rawData.value as string) : null,
Â  Â  Â  Â  close_date: closeDateValue ? new Date(closeDateValue).toISOString() : null,
Â  Â  Â  Â  user_id: userId,
Â  Â  Â  Â  team_id: activeTeamId,
Â  Â  };

Â  Â  let query;
Â  Â  if (opportunityId) {
Â  Â  Â  Â  // ActualitzaciÃ³: El tipus DbTableUpdate Ã©s correcte
Â  Â  Â  Â  query = supabase
Â  Â  Â  Â  Â  Â  .from("opportunities")
Â  Â  Â  Â  Â  Â  .update(dataToSave as DbTableUpdate<'opportunities'>) // Cast explÃ­cit
Â  Â  Â  Â  Â  Â  .eq("id", opportunityId)
Â  Â  Â  Â  Â  Â  .eq("team_id", activeTeamId);
Â  Â  } else {
Â  Â  Â  Â  // InserciÃ³: El tipus DbTableInsert Ã©s correcte
Â  Â  Â  Â  query = supabase
Â  Â  Â  Â  Â  Â  .from("opportunities")
            // âœ… CORRECCIÃ“: Assegurem que el tipus Ã©s DbTableInsert
Â  Â  Â  Â  Â  Â  .insert(dataToSave as DbTableInsert<'opportunities'>); 
Â  Â  }

Â  Â  const { data, error } = await query.select().single();

Â  Â  if (error) {
Â  Â  Â  Â  console.error("Error en desar l'oportunitat (service):", error);
Â  Â  Â  Â  throw new Error(error.message);
Â  Â  }
Â  Â  
Â  Â  return data as Opportunity;
}

/**
Â * SERVEI: Actualitza l'etapa (stage) d'una oportunitat.
Â * LlanÃ§a un error si falla.
Â */
export async function updateOpportunityStage(
Â  Â  supabase: SupabaseClient<Database>,
Â  Â  opportunityId: number,
Â  Â  newStage: string,
Â  Â  activeTeamId: string
): Promise<void> {
Â  Â  const { error } = await supabase
Â  Â  Â  Â  .from("opportunities")
Â  Â  Â  Â  .update({ stage_name: newStage })
Â  Â  Â  Â  .eq("id", opportunityId)
Â  Â  Â  Â  .eq("team_id", activeTeamId);

Â  Â  if (error) {
Â  Â  Â  Â  console.error("Error en actualitzar l'etapa (service):", error);
Â  Â  Â  Â  throw new Error(error.message);
Â  Â  }
}

// =================== FILE: src/lib/services/crm/pipeline/pipline.service.ts ===================

import { type SupabaseClient, type PostgrestError } from '@supabase/supabase-js';
import { type Database } from '@/types/supabase';

// âœ… 1. Importem els nostres serveis d'entitat
import { getPipelineStages } from './stages.service';
import { getAllContacts } from '../contacts/contacts.service'; // Aquesta funciÃ³ retorna Promise<Contact[]>
import { getOpportunitiesWithContact } from './opportunities.service';

import type { Contact } from '@/types/db';

export type Stage = Database['public']['Tables']['pipeline_stages']['Row'];
export type OpportunityWithContact = Database['public']['Tables']['opportunities']['Row'] & {
Â  contacts: Pick<Database['public']['Tables']['contacts']['Row'], 'id' | 'nom'> | null;
};

export type PipelineDataPayload = {
Â  stages: Stage[];
Â  contacts: Contact[];
Â  opportunities: OpportunityWithContact[];
};

export type PipelineDataError = {
Â  stagesError?: PostgrestError | null;
Â  contactsError?: Error | null; // âœ… Canviat a 'Error' genÃ¨ric
Â  opportunitiesError?: PostgrestError | null;
}

/**
Â * ObtÃ© totes les dades necessÃ ries per a la vista del Pipeline (Cas d'Ãšs).
Â */
export async function getPipelineData(
Â  supabase: SupabaseClient<Database>, 
Â  teamId: string
): Promise<{ data: PipelineDataPayload | null; error: PipelineDataError | null }> {
Â  
Â  // âœ… CORRECCIÃ“: Embolcallem 'getAllContacts' per gestionar el seu retorn
Â  const [stagesRes, contactsRes, opportunitiesRes] = await Promise.all([
Â  Â  getPipelineStages(supabase, teamId),
Â  Â  
    // Embolcallador (wrapper) per a getAllContacts
Â  Â  (async () => {
Â  Â  Â  try {
Â  Â  Â  Â  const data = await getAllContacts(supabase, teamId);
Â  Â  Â  Â  return { data, error: null };
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  return { data: null, error: error as Error };
Â  Â  Â  }
Â  Â  })(),
Â  Â  
Â  Â  getOpportunitiesWithContact(supabase, teamId)
Â  ]);

Â  // 5. GestiÃ³ d'errors (Ara 'contactsRes.error' existeix)
Â  if (stagesRes.error || contactsRes.error || opportunitiesRes.error) {
Â  Â  console.error("Error a getPipelineData (service):", { 
Â  Â  Â  stages: stagesRes.error, 
Â  Â  Â  contacts: contactsRes.error, 
Â  Â  Â  opps: opportunitiesRes.error 
Â  Â  });
Â  Â  
Â  Â  return {
Â  Â  Â  data: null,
Â  Â  Â  error: {
Â  Â  Â  Â  stagesError: stagesRes.error,
Â  Â  Â  Â  contactsError: contactsRes.error,
Â  Â  Â  Â  opportunitiesError: opportunitiesRes.error
Â  Â  Â  }
Â  Â  };
Â  }

Â  const payload: PipelineDataPayload = {
Â  Â  stages: (stagesRes.data as Stage[]) || [],
Â  Â  contacts: (contactsRes.data as Contact[]) || [], // âœ… Ara Ã©s correcte
Â  Â  opportunities: (opportunitiesRes.data as OpportunityWithContact[]) || []
Â  };
Â  
Â  return { data: payload, error: null };
}

// =================== FILE: src/lib/services/crm/pipeline/stages.service.ts ===================

import { type SupabaseClient } from '@supabase/supabase-js';
import { type Database } from '@/types/supabase';

export async function getPipelineStages(supabase: SupabaseClient<Database>, teamId: string) {
  return supabase
    .from('pipeline_stages')
    .select('id, name, position')
    .eq('team_id', teamId)
    .order('position', { ascending: true });
}

// =================== FILE: src/lib/services/crm.service.ts ===================

import { type SupabaseClient } from '@supabase/supabase-js';
import { type Database } from '@/types/supabase';

// Importa els tipus principals des del nou arxiu
import { 
    type CrmData, 
    type CrmServiceResponse,
    type CampaignPerformanceData, // Re-exporta els tipus necessaris per al component
    type DailySummaryData, 
    type KpiData, 
    type UnreadActivity, 
    type TopClient, 
    type ColdContact, 
    type LeadSource, 
    type OpportunityAgingData, 
    type LeadConversionData 
} from './crm/general/types';

// Importa les funcions de servei modulars
import { fetchAllCrmRawData } from './crm/general/data.service';
import { processStats } from './crm/general/stats.service';
import { processFunnel } from './crm/general/funnel.service';
import { processRevenue } from './crm/general/revenue.service';
import { processLists } from './crm/general/lists.service';
import { processCharts } from './crm/general/charts.service';
import { processCampaignPerformance } from './crm/general/campaignPerformance.service';
import { processDailySummary } from './crm/general/dailySummary.service';


/**
 * ObtÃ© i processa TOTES les dades per al Dashboard del CRM (Cas d'Ãšs).
 * Orquestra l'obtenciÃ³ i processament de dades des de serveis especÃ­fics.
 */
export async function getCrmDashboardData(
  supabase: SupabaseClient<Database>,
  teamId: string,
): CrmServiceResponse {
    try {
        // 1. Obtenir totes les dades brutes
        const rawData = await fetchAllCrmRawData(supabase, teamId);

        // 2. Processar les dades en blocs lÃ²gics
        const stats = processStats(rawData);
        const funnel = processFunnel(rawData);
        const revenue = processRevenue(rawData, stats); // Passa stats si Ã©s necessari
        const lists = processLists(rawData);
        const charts = processCharts(rawData);
        const campaignPerformance = processCampaignPerformance(); // Usa mocks internament
        const dailySummary = processDailySummary(rawData);

        // 3. Construir l'objecte final
        const data: CrmData = {
            stats,
            funnel,
            revenue,
            unreadActivities: lists.unreadActivities,
            topClients: lists.topClients,
            coldContacts: lists.coldContacts,
            leadSources: charts.leadSources,
            opportunityAging: charts.opportunityAging,
            leadConversion: charts.leadConversion,
            campaignPerformance,
            dailySummary,
        };

        return { data, error: null };

    } catch (err: unknown) {
        const error = err as Error;
        // L'error ja s'hauria logat a fetchAllCrmRawData si Ã©s de Supabase
        if (!error.message.startsWith('Error carregant dades CRM')) {
             console.error("Error catastrÃ²fic processant dades a getCrmDashboardData (service):", error.message, error.stack);
        }
        return {
            data: null,
            // Retornem l'error capturat (pot ser de fetch o de processament)
            error: { message: `Error inesperat obtenint dades del CRM: ${error.message}`, details: error }
        };
    }
}

// Re-exporta els tipus necessaris per al component CrmDataDashboard
export type { CampaignPerformanceData, DailySummaryData, KpiData, UnreadActivity, TopClient, ColdContact, LeadSource, OpportunityAgingData, LeadConversionData, CrmData };

// =================== FILE: src/lib/services/dashboard/dashboard.service.ts ===================

// src/lib/services/dashboard.service.ts

import { type SupabaseClient, type User, type PostgrestError } from '@supabase/supabase-js';
import { type Database, type Tables } from '@/types/supabase';
import { type EnrichedTask } from '@/components/features/tasks/TaskDialogManager';
import { type EnrichedQuote } from '@/app/[locale]/(app)/dashboard/_components/RecentQuotes';
import { type EnrichedEmail } from '@/app/[locale]/(app)/dashboard/_components/RecentEmails';
import { type ServerActivityItem } from '@/lib/data/dashboard';
export type { EnrichedTask, EnrichedQuote, EnrichedEmail };
// Importem els tipus de la nostra font de la veritat
import type { DbTableInsert,  Department } from '@/types/db';
import type { NewTaskPayload } from '@/types/dashboard/types';

import {
    getStats as fetchStats,
    getTasks as fetchTasks,
    getOverdueInvoices as fetchOverdueInvoices,
    getRecentContacts as fetchRecentContacts,
    getRecentActivities,
} from '@/lib/data/dashboard';

// --- Tipus de Dades Retornades pel Servei ---
export type DashboardInitialData = {
    stats: {
        totalContacts: number;
        activeClients: number;
        opportunities: number;
        invoiced: number;
        pending: number;
        expenses: number;
        invoicedChange: string;
        expensesChange: string;
        invoicedIsPositive: boolean;
        expensesIsPositive: boolean;
    };
    tasks: EnrichedTask[];
    departments: Tables<'departments'>[];
    contacts: Tables<'contacts'>[]; // Contactes recents per a 'attentionContacts'
    overdueInvoices: (Tables<'invoices'> & { contacts: { nom: string } | null })[];
    attentionContacts: Tables<'contacts'>[];
    notifications: Tables<'notifications'>[];
    recentActivities: ServerActivityItem[]; // Activitats ja processades
    recentQuotes: EnrichedQuote[];
    recentEmails: EnrichedEmail[];
    teamMembers: Tables<'team_members_with_profiles'>[]; // Afegim teamMembers aquÃ­
};

// Tipus per a errors detallats
export type DashboardDataError = {
    permissionsError?: PostgrestError | null;
    statsError?: unknown;
    tasksError?: unknown;
    overdueInvoicesError?: unknown;
    contactsError?: unknown; // Canviat de PostgrestError a unknown
    notificationsError?: PostgrestError | null;
    departmentsError?: PostgrestError | null;
    teamMembersError?: PostgrestError | null;
    recentQuotesError?: PostgrestError | null;
    recentEmailsError?: PostgrestError | null;
};

// --- Helpers ---
const calculatePercentageChange = (current: number, previous: number): string => {
    if (previous === 0) return current > 0 ? '+100%' : '0%';
    const change = ((current - previous) / previous) * 100;
    return `${change >= 0 ? '+' : ''}${change.toFixed(0)}% vs mes anterior`;
};

/**
 * ObtÃ© i processa les dades inicials per al Dashboard principal.
 */
export async function getDashboardInitialData(
    supabase: SupabaseClient<Database>,
    user: User,
    teamId: string
): Promise<{ data: DashboardInitialData | null; error: DashboardDataError | { message: string, details?: unknown } | null }> {
    try {
        const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();

        // 1. Obtenir permisos
        const { data: permissions, error: permissionsError } = await supabase
            .from('inbox_permissions')
            .select('target_user_id')
            .eq('team_id', teamId)
            .eq('grantee_user_id', user.id);

        if (permissionsError) {
            console.error(`ğŸš¨ Error en la consulta "permissions":`, permissionsError);
            throw new Error(`Error carregant permisos: ${permissionsError.message}`);
        }
        const visibleUserIds = [user.id, ...(permissions?.map(p => p.target_user_id).filter(Boolean) || [])];

        // 2. Executar consultes en paralÂ·lel
        const results = await Promise.allSettled([
            fetchStats(supabase), // 0
            fetchTasks(supabase, teamId), // 1
            fetchOverdueInvoices(supabase, teamId), // 2
            fetchRecentContacts(supabase, teamId), // 3
            supabase.from('notifications').select('*').eq('user_id', user.id).eq('is_read', false), // 4
            supabase.from('departments').select('*').eq('team_id', teamId), // 5
            supabase.from('team_members_with_profiles').select('*').eq('team_id', teamId), // 6
            supabase.from('quotes').select('*, contacts(nom)').eq('team_id', teamId).order('created_at', { ascending: false }).limit(10), // 7
            supabase.from('tickets').select('*, contacts(nom)').in('user_id', visibleUserIds).order('created_at', { ascending: false }).limit(10) // 8
        ]);

        // 3. Processar resultats i errors
        const errors: DashboardDataError = {};
        // âœ… CORRECCIÃ“: Inicialitzem amb tipus mÃ©s flexibles (permetent el tipus de dada o null)
        const dataResults: {
            statsData: Awaited<ReturnType<typeof fetchStats>> | null;
            tasksData: EnrichedTask[] | null;
            overdueInvoicesData: Awaited<ReturnType<typeof fetchOverdueInvoices>> | null;
            contactsData: Tables<'contacts'>[] | null; // Tipus correcte
            notificationsRes: Tables<'notifications'>[] | null;
            departmentsRes: Tables<'departments'>[] | null;
            teamMembersRes: Tables<'team_members_with_profiles'>[] | null;
            recentQuotesRes: EnrichedQuote[] | null;
            recentEmailsRes: EnrichedEmail[] | null;
        } = {
            statsData: null, tasksData: null, overdueInvoicesData: null, contactsData: null,
            notificationsRes: null, departmentsRes: null, teamMembersRes: null,
            recentQuotesRes: null, recentEmailsRes: null
        };

        // FunciÃ³ helper per comprovar resultats de allSettled
        const processSettledResult = <T>(
            result: PromiseSettledResult<unknown>, // Accepta 'unknown' per simplificar el tipatge d'entrada
            name: keyof DashboardDataError | keyof typeof dataResults,
            isSupabaseQuery: boolean = true
        ): T | null => {
            if (result.status === 'rejected') {
                console.error(`ğŸš¨ Error en la consulta "${String(name)}":`, result.reason);
                errors[name as keyof DashboardDataError] = result.reason ?? new Error('Unknown error');
                return null;
            }
            // Comprovem error intern de Supabase si s'espera
            // Verifiquem que result.value existeix i tÃ© la propietat 'error'
            if (isSupabaseQuery && result.value && typeof result.value === 'object' && 'error' in result.value && result.value.error) {
                console.error(`ğŸš¨ Error en la consulta "${String(name)}" (Supabase):`, result.value.error);
                errors[name as keyof DashboardDataError] = (result.value.error && typeof result.value.error === 'object' && 'message' in result.value.error)
                    ? result.value.error as PostgrestError
                    : null;
                return null;
            }
            // âœ… CORRECCIÃ“: Retornem 'data' si existeix i Ã©s una consulta Supabase, altrament el valor complet
             if (isSupabaseQuery && result.value && typeof result.value === 'object' && 'data' in result.value) {
                return result.value.data as T | null; // Casting segur aquÃ­
            } else {
                return result.value as T | null; // Casting segur per a funcions no-supabase
            }
        };


        // Assignem resultats usant la funciÃ³ helper
        dataResults.statsData = processSettledResult<Awaited<ReturnType<typeof fetchStats>>>(results[0], 'statsError', false);
        dataResults.tasksData = processSettledResult<EnrichedTask[]>(results[1], 'tasksError', false);
        dataResults.overdueInvoicesData = processSettledResult<Awaited<ReturnType<typeof fetchOverdueInvoices>>>(results[2], 'overdueInvoicesError', false);
        dataResults.contactsData = processSettledResult<Tables<'contacts'>[]>(results[3], 'contactsError', false);
        dataResults.notificationsRes = processSettledResult<Tables<'notifications'>[]>(results[4], 'notificationsError');
        dataResults.departmentsRes = processSettledResult<Tables<'departments'>[]>(results[5], 'departmentsError');
        dataResults.teamMembersRes = processSettledResult<Tables<'team_members_with_profiles'>[]>(results[6], 'teamMembersError');
        dataResults.recentQuotesRes = processSettledResult<EnrichedQuote[]>(results[7], 'recentQuotesError');
        dataResults.recentEmailsRes = processSettledResult<EnrichedEmail[]>(results[8], 'recentEmailsError');


        // Si alguna consulta essencial falla, retornem error
        if (errors.statsError || errors.tasksError || errors.contactsError) {
             console.error("Error(s) fetching essential dashboard data:", errors);
             return { data: null, error: { message: "Error carregant dades essencials del dashboard.", details: errors } };
        }

        // Valors per defecte robustos
        const statsData = dataResults.statsData || { total_contacts: 0, active_clients: 0, opportunities: 0, invoiced_current_month: 0, pending_total: 0, expenses_current_month: 0, invoiced_previous_month: 0, expenses_previous_month: 0 };
        const tasksData = dataResults.tasksData || [];
        const overdueInvoicesData = dataResults.overdueInvoicesData || [];
        const contactsData = dataResults.contactsData || [];


        // 4. Processament addicional
        const recentActivities = getRecentActivities(overdueInvoicesData, tasksData, contactsData);
        // âœ… CORRECCIÃ“: Assegurem que 'c' tÃ© el tipus correcte (Tables<'contacts'>)
        const attentionContacts = contactsData.filter(c => c.last_interaction_at && new Date(c.last_interaction_at).toISOString() < sevenDaysAgo).slice(0, 5);

        // 5. Construir l'objecte final
        const data: DashboardInitialData = {
            stats: {
                totalContacts: statsData.total_contacts,
                activeClients: statsData.active_clients,
                opportunities: statsData.opportunities,
                invoiced: statsData.invoiced_current_month,
                pending: statsData.pending_total,
                expenses: statsData.expenses_current_month,
                invoicedChange: calculatePercentageChange(statsData.invoiced_current_month, statsData.invoiced_previous_month),
                expensesChange: calculatePercentageChange(statsData.expenses_current_month, statsData.expenses_previous_month),
                invoicedIsPositive: statsData.invoiced_current_month >= statsData.invoiced_previous_month,
                expensesIsPositive: statsData.expenses_current_month <= statsData.expenses_previous_month,
            },
            tasks: tasksData,
            departments: dataResults.departmentsRes ?? [],
            contacts: contactsData,
            overdueInvoices: overdueInvoicesData,
            attentionContacts: attentionContacts,
            notifications: dataResults.notificationsRes ?? [],
            recentActivities: recentActivities,
            recentQuotes: dataResults.recentQuotesRes ?? [],
            recentEmails: dataResults.recentEmailsRes ?? [],
            teamMembers: dataResults.teamMembersRes ?? [],
        };

        return { data, error: null };

    } catch (err: unknown) {
        const error = err as Error;
        console.error("Error catastrÃ²fic a getDashboardInitialData (service):", error.message, error.stack);
        return { data: null, error: { message: `Error inesperat obtenint dades del dashboard: ${error.message}`, details: error } };
    }
}

// ---
// âš™ï¸ NOVES FUNCIONS DE MUTACIÃ“ (Mogudes des de 'actions.ts')
// ---

/**
 * SERVEI: Afegeix una nova tasca.
 * LlanÃ§a un error si falla.
 */
export async function addTask(
    supabase: SupabaseClient<Database>,
    taskData: NewTaskPayload,
    userId: string,
    teamId: string
): Promise<void> {
    const dataToInsert: DbTableInsert<'tasks'> = {
        ...taskData,
        user_id: userId,
        team_id: teamId,
        is_active: false
    };

Â  Â  const { error } = await supabase.from('tasks').insert(dataToInsert);

Â  Â  if (error) {
Â  Â  Â  Â  console.error('Error creating task (service):', error);
Â  Â  Â  Â  throw new Error(error.message);
Â  Â  }
}

/**
 * SERVEI: Elimina una tasca.
 * LlanÃ§a un error si falla.
 */
export async function deleteTask(
    supabase: SupabaseClient<Database>,
    taskId: number
): Promise<void> {
    // La RLS hauria de gestionar la seguretat de l'equip
Â  Â  const { error } = await supabase
Â  Â  Â  Â  .from('tasks')
Â  Â  Â  Â  .delete()
Â  Â  Â  Â  .eq('id', taskId);

Â  Â  if (error) {
Â  Â  Â  Â  console.error('Error en eliminar la tasca (service):', error);
Â  Â  Â  Â  throw new Error(error.message);
Â  Â  }
}

/**
 * SERVEI: Afegeix un nou departament.
 * LlanÃ§a un error si falla (incloent duplicats).
 */
export async function addDepartment(
    supabase: SupabaseClient<Database>,
    name: string,
    teamId: string
): Promise<Department> {
Â  Â  const { data, error } = await supabase
Â  Â  Â  Â  .from('departments')
Â  Â  Â  Â  .insert({ name, team_id: teamId })
Â  Â  Â  Â  .select()
Â  Â  Â  Â  .single();

Â  Â  if (error) {
Â  Â  Â  Â  console.error('Error en crear el departament (service):', error);
Â  Â  Â  Â  if (error.code === '23505') { // Error de clau duplicada
Â  Â  Â  Â  Â  Â  throw new Error(`El departament "${name}" ja existeix.`);
Â  Â  Â  Â  }
Â  Â  Â  Â  throw new Error(error.message);
Â  Â  }
    return data as Department;
}

/**
 * SERVEI: Actualitza una tasca.
 * LlanÃ§a un error si falla.
 */
export async function updateTask(
    supabase: SupabaseClient<Database>,
    taskId: number,
    updatedData: Partial<Tables<'tasks'>>
): Promise<void> {
Â  Â  const { error } = await supabase
Â  Â  Â  Â  .from('tasks')
Â  Â  Â  Â  .update(updatedData)
Â  Â  Â  Â  .eq('id', taskId);

Â  Â  if (error) {
        console.error('Error en actualitzar la tasca (service):', error);
        throw new Error(error.message);
    }
}

// =================== FILE: src/lib/services/departments.service.ts ===================

import { type SupabaseClient } from '@supabase/supabase-js';
import { type Database } from '@/types/supabase';

export async function getDepartments(
  supabase: SupabaseClient<Database>, 
  teamId: string
) {
  return supabase
    .from('departments')
    .select('*')
    .eq('team_id', teamId);
}

// =================== FILE: src/lib/services/finances/expenses/expenseDetail.service.ts ===================

// src/lib/services/finances/expenses/expenseDetail.service.ts (FITXER NOU)
import { 
    type SupabaseClient, 
} from '@supabase/supabase-js';
import { type Database } from '@/types/supabase';
import { 
    type Expense, 
    type ExpenseItem,
    type ExpenseDetail,
    type ExpenseFormDataForAction,
    type ExpenseAttachment
} from '@/types/finances/expenses';
import { type DbTableInsert, type DbTableUpdate } from '@/types/db';
import { createAdminClient } from "@/lib/supabase/admin";

// ---
// âš™ï¸ FUNCIONS DE SERVEI (DETALL I MUTACIONS)
// ---

/**
 * SERVEI: Processa un OCR (Edge Function).
 */
export async function processOcr(
  supabase: SupabaseClient<Database>,
  formData: FormData,
): Promise<Record<string, unknown>> {
  const file = formData.get("file") as File | null;
  if (!file) {
    throw new Error("No s'ha proporcionat cap fitxer.");
  }

  const { data, error } = await supabase.functions.invoke("process-ocr", {
    body: { file_name: file.name, file_type: file.type },
  });

  if (error) {
    throw new Error(error.message);
  }
  return data;
}

/**
 * SERVEI: ObtÃ© despeses per a un proveÃ¯dor (per a la pestanya de proveÃ¯dors).
 */
export async function fetchExpensesForSupplier(
  supabase: SupabaseClient<Database>,
  supplierId: string,
  teamId: string,
) {
  const { data, error } = await supabase
    .from("expenses")
    .select("id, expense_date, description, total_amount, status")
    .eq("supplier_id", supplierId)
    .eq("team_id", teamId)
    .order("expense_date", { ascending: false })
    .limit(50);

  if (error) {
    console.error(
      "Error fetching expenses for supplier (service):",
      error.message,
    );
    return []; 
  }
  return data;
}

/**
 * SERVEI: Cerca despeses per vincular (per al modal de proveÃ¯dors).
 */
export async function searchExpensesForLinking(
  supabase: SupabaseClient<Database>,
  teamId: string,
  searchTerm: string,
): Promise<
  Pick<Expense, "id" | "description" | "expense_date" | "total_amount">[]
> {
  let query = supabase
    .from("expenses")
    .select("id, description, expense_date, total_amount")
    .eq("team_id", teamId)
    .is("supplier_id", null)
    .order("expense_date", { ascending: false })
    .limit(10);

  if (searchTerm) {
    query = query.ilike("description", `%${searchTerm}%`);
  }

  const { data, error } = await query;

  if (error) {
    console.error(
      "Error searching expenses for linking (service):",
      error.message,
    );
    return [];
  }
  return data || [];
}

/**
 * SERVEI: Vincula una despesa a un proveÃ¯dor.
 * LlanÃ§a un error si falla.
 */
export async function linkExpenseToSupplier(
  supabase: SupabaseClient<Database>,
  teamId: string,
  expenseId: number,
  supplierId: string,
): Promise<Expense> {
  const { data, error } = await supabase
    .from("expenses")
    .update({ supplier_id: supplierId })
    .eq("id", expenseId)
    .eq("team_id", teamId)
    .select()
    .single();

  if (error) {
    console.error("Error linking expense (service):", error);
    throw new Error(`Error en vincular la despesa: ${error.message}`);
  }
  return data as Expense;
}

/**
 * SERVEI: Desvincula una despesa d'un proveÃ¯dor.
 * LlanÃ§a un error si falla.
 */
export async function unlinkExpenseFromSupplier(
  supabase: SupabaseClient<Database>,
  teamId: string,
  expenseId: number,
): Promise<void> {
  const { error } = await supabase
    .from("expenses")
    .update({ supplier_id: null })
    .eq("id", expenseId)
    .eq("team_id", teamId);

  if (error) {
    console.error("Error unlinking expense (service):", error);
    throw new Error(`Error en desvincular la despesa: ${error.message}`);
  }
}

/**
 * SERVEI: ObtÃ© el detall complet d'una despesa.
 * LlanÃ§a un error si falla.
 */
export async function fetchExpenseDetail(
    supabase: SupabaseClient<Database>, 
    expenseId: number, 
    teamId: string
): Promise<ExpenseDetail | null> {
  const { data, error } = await supabase
    .from('expenses')
    .select(`
      *,
      suppliers (id, nom, nif),
      expense_items (*),
      expense_attachments (*)
    `)
    .eq('id', expenseId)
    .eq('team_id', teamId) // Seguretat
    .single();

  if (error) {
    console.error("Error fetching expense detail (service):", error.message);
    return null; 
  }
  return data as unknown as ExpenseDetail;
}


// --- Helpers Interns per a 'saveExpense' ---

async function upsertExpenseDetails(
  supabase: SupabaseClient<Database>,
  expenseData: Omit<ExpenseFormDataForAction, 'id' | 'expense_items'>,
  expenseId: number | null,
  userId: string,
  teamId: string
): Promise<{ id: number }> {
  
  const expenseDate = expenseData.expense_date ? new Date(expenseData.expense_date).toISOString().split('T')[0] : null;
  const paymentDate = expenseData.payment_date ? new Date(expenseData.payment_date).toISOString().split('T')[0] : null;

  const dataToUpsert = {
    ...expenseData,
    expense_date: expenseDate,
    payment_date: paymentDate,
    supplier_id: expenseData.supplier_id || null,
    project_id: expenseData.project_id || null,
  };

  delete (dataToUpsert as Record<string, unknown>).suppliers;
  delete (dataToUpsert as Record<string, unknown>).expense_attachments;

  const query = expenseId
    ? supabase.from("expenses").update(dataToUpsert as DbTableUpdate<'expenses'>).eq("id", expenseId)
    : supabase.from("expenses").insert({ ...dataToUpsert, user_id: userId, team_id: teamId } as DbTableInsert<'expenses'>);

  const { data, error } = await query.select('id').single();

  if (error) {
    console.error("Error upserting expense (service):", error);
    throw new Error(`Error en desar la despesa: ${error.message}`);
  }
  if (!data || typeof data.id !== 'number') {
    throw new Error("Error en desar: ID no retornat.");
  }
  return { id: data.id };
}

async function syncExpenseItems(
  supabase: SupabaseClient<Database>,
  expenseId: number,
  items: ExpenseItem[] | undefined,
  userId: string,
  teamId: string
): Promise<void> {
  if (!items || items.length === 0) {
    const { error: deleteError } = await supabase.from('expense_items').delete().eq('expense_id', expenseId);
    if (deleteError) {
      throw new Error(`Error netejant conceptes antics: ${deleteError.message}`);
    }
    return;
  }

  const existingItemIds = items.map(item => item.id).filter(id => typeof id === 'number' && id > 0);

  let deleteQuery = supabase
    .from('expense_items')
    .delete()
    .eq('expense_id', expenseId);

  if (existingItemIds.length > 0) {
    deleteQuery = deleteQuery.not('id', 'in', `(${existingItemIds.join(',')})`);
  }
  const { error: deleteError } = await deleteQuery;
  if (deleteError) {
    throw new Error(`Error esborrant conceptes: ${deleteError.message}`);
  }

  const itemsToUpsert = items.map(item => ({
    id: (typeof item.id === 'number' && item.id > 0) ? String(item.id) : undefined,
    description: item.description,
    quantity: item.quantity,
    unit_price: item.unit_price,
    total: item.total,
    expense_id: expenseId,
    user_id: userId,
    team_id: teamId,
  }));
  
  const { error: upsertError } = await supabase
    .from("expense_items")
    .upsert(itemsToUpsert, { onConflict: 'id', ignoreDuplicates: false });

  if (upsertError) {
    console.error("Error upserting items (service):", upsertError);
    throw new Error(`Error actualitzant conceptes: ${upsertError.message}`);
  }
}

/**
 * SERVEI: Desa una despesa i els seus Ã­tems (Cas d'Ãšs).
 * LlanÃ§a un error si falla.
 */
export async function saveExpense(
    supabase: SupabaseClient<Database>,
    expenseData: ExpenseFormDataForAction,
    expenseId: string | number | null, // ID de la URL
    userId: string,
    teamId: string
): Promise<{ id: number }> { // Retorna l'ID resultant
  const { expense_items, id: formId, ...dataToUpsert } = expenseData;

  const currentId: number | null = (typeof expenseId === 'number') 
    ? expenseId 
    : (typeof formId === 'number' && formId > 0 ? formId : null);

  // 1. Desar la despesa principal
  const { id: resultingExpenseId } = await upsertExpenseDetails(supabase, dataToUpsert, currentId, userId, teamId);

  // 2. Sincronitzar els Ã­tems
  await syncExpenseItems(supabase, resultingExpenseId, expense_items, userId, teamId);

  return { id: resultingExpenseId };
}

/**
 * SERVEI: Puja un adjunt.
 * LlanÃ§a un error si falla.
 */
export async function uploadAttachment(
    supabase: SupabaseClient<Database>,
    expenseId: number,
    formData: FormData,
    userId: string,
    teamId: string
): Promise<ExpenseAttachment> {
  const file = formData.get("file") as File | null;
  if (!file) throw new Error("No s'ha proporcionat cap fitxer.");

  const filePath = `${teamId}/${expenseId}/${Date.now()}-${file.name}`;
  
  const { error: uploadError } = await supabase.storage
    .from("despeses-adjunts")
    .upload(filePath, file);
    
  if (uploadError) {
    console.error("Storage upload error (service):", uploadError);
    throw new Error(`Error de Storage: ${uploadError.message}`);
  }

  const attachmentData: DbTableInsert<'expense_attachments'> = {
    expense_id: expenseId,
    user_id: userId,
    team_id: teamId,
    file_path: filePath,
    filename: file.name,
    mime_type: file.type,
  };

  const { data: dbData, error: dbError } = await supabase
    .from("expense_attachments")
    .insert(attachmentData)
    .select()
    .single();
    
  if (dbError) {
    console.error("DB insert error after upload (service):", dbError);
    await supabase.storage.from("despeses-adjunts").remove([filePath]);
    throw new Error(`Error de BD: ${dbError.message}`);
  }
  return dbData as ExpenseAttachment;
}

/**
 * SERVEI: Elimina una despesa (i Ã­tems/adjunts en cascada).
 * LlanÃ§a un error si falla.
 */
export async function deleteExpense(
    supabase: SupabaseClient<Database>,
    expenseId: number,
    teamId: string
): Promise<void> {
  const { error } = await supabase
    .from('expenses')
    .delete()
    .eq('id', expenseId)
    .eq('team_id', teamId); // Seguretat

  if (error) {
    console.error("Error deleting expense (service):", error.message);
    throw new Error(`Error al eliminar la despesa: ${error.message}`);
  }
}

/**
 * SERVEI: ObtÃ© una URL signada per a un adjunt.
 * LlanÃ§a un error si falla.
 */
export async function getAttachmentSignedUrl(
    filePath: string,
    userTeamId: string
): Promise<string> {
  const fileTeamId = filePath.split('/')[0];
  if (userTeamId !== fileTeamId) {
    throw new Error("AccÃ©s denegat.");
  }

  const supabaseAdmin = createAdminClient();
  const { data, error } = await supabaseAdmin.storage
    .from('despeses-adjunts')
    .createSignedUrl(filePath, 60 * 5); // 5 minuts

  if (error) {
    throw new Error(error.message);
  }
  return data.signedUrl;
}

/**
 * SERVEI: Elimina un adjunt (fitxer i registre BBDD).
 * LlanÃ§a un error si falla.
 */
export async function deleteAttachment(
    supabase: SupabaseClient<Database>,
    adminSupabase: SupabaseClient<Database>, // Client Admin
    attachmentId: string, 
    filePath: string,
    teamId: string
): Promise<void> {
  const { error: dbError } = await supabase
    .from('expense_attachments')
    .delete()
    .eq('id', attachmentId)
    .eq('team_id', teamId);

  if (dbError) {
    console.error("Error deleting attachment from DB (service):", dbError);
    throw new Error(`Error esborrant adjunt de la BD: ${dbError.message}`);
  }

  const { error: storageError } = await adminSupabase.storage
    .from('despeses-adjunts')
    .remove([filePath]);

  if (storageError) {
    console.error("Error deleting attachment from Storage (service):", storageError);
    throw new Error(`Error esborrant fitxer de Storage: ${storageError.message}`);
  }
}

// =================== FILE: src/lib/services/finances/expenses/expenses.service.ts ===================

// src/lib/services/finances/expenses.service.ts (CORREGIT - LLISTA)
import { type SupabaseClient } from "@supabase/supabase-js";
import { type Database } from "@/types/supabase";
import {
  type ExpenseStatus,
  type ExpenseWithContact,
} from "@/types/finances/expenses";
import {
  type PaginatedActionParams,
  type PaginatedResponse,
} from "@/hooks/usePaginateResource";
import { unstable_cache as cache } from "next/cache";
import { createAdminClient } from "@/lib/supabase/admin";

// --- Tipus Locals del Servei ---

export interface ExpensePageFilters {
  category: string;
  status: string;
}

type FetchExpensesParams = PaginatedActionParams<ExpensePageFilters>;
type PaginatedExpensesData = PaginatedResponse<ExpenseWithContact>;

type RpcSearchResult = {
  id: number;
  invoice_number: string | null;
  expense_date: string;
  total_amount: number;
  category: string | null;
  description: string;
  supplier_id: string | null;
  supplier_nom: string | null;
  status: ExpenseStatus;
  payment_date: string | null;
  is_billable: boolean;
  project_id: string | null;
};
type RpcArgs = Database['public']['Functions']['search_expenses']['Args'];
// ---
// âš™ï¸ FUNCIONS DE SERVEI (LLISTA)
// ---

/**
 * SERVEI: ObtÃ© les despeses paginades usant RPC.
 * LlanÃ§a un error si falla.
 */
export async function fetchPaginatedExpenses(
  supabase: SupabaseClient<Database>,
  teamId: string,
  params: FetchExpensesParams,
): Promise<PaginatedExpensesData> {
  const { searchTerm, filters, sortBy, sortOrder, limit, offset } = params;

  // El teu objecte rpcParams Ã©s LÃ’GICAMENT CORRECTE (amb null)
  const rpcParams = {
    p_team_id: teamId,
    p_search_term: searchTerm || null, // Correcte
    p_category: filters.category && filters.category !== "all"
      ? filters.category
      : null, // Correcte
    p_status: filters.status && filters.status !== "all"
      ? filters.status
      : null, // Correcte
    p_sort_by: sortBy || "expense_date",
    p_sort_order: sortOrder || "desc",
    p_limit: limit ?? 50,
    p_offset: offset ?? 0,
  };

  // Els teus logs sÃ³n perfectes
  console.log(
    "expenses.service.ts: Trucant RPC 'search_expenses' amb parÃ metres:",
    JSON.stringify(rpcParams, null, 2),
  );

  // --- 1. Consulta de Dades (RPC) ---

  // ğŸ‘‡ AQUESTA Ã‰S L'ÃšNICA LÃNIA MODIFICADA ğŸ‘‡
  // Afegim 'as any' per saltar la comprovaciÃ³ de tipus incorrecta de Supabase (ts(2345))
  const { data: rpcData, error: rpcError } = await supabase.rpc(
    "search_expenses",
    rpcParams as unknown as RpcArgs,
  );
  // ğŸ‘† AQUESTA Ã‰S L'ÃšNICA LÃNIA MODIFICADA ğŸ‘†

  if (rpcError) {
    console.error(
      "Error calling RPC search_expenses (service):",
      rpcError.message,
    );
    throw new Error("Error en carregar les dades de despeses.");
  }

  // LOG 2
  console.log(
    `expenses.service.ts: RPC 'search_expenses' ha retornat ${
      rpcData?.length || 0
    } files.`,
  );

  if (!rpcData || rpcData.length === 0) {
    return { data: [], count: 0 };
  }

  const formattedData = rpcData.map((item: RpcSearchResult) => ({
    ...item,
    suppliers: item.supplier_id
      ? { id: item.supplier_id, nom: item.supplier_nom }
      : null,
  }));

  // --- 2. Consulta de Recompte Total ---
  let countQuery = supabase
    .from("expenses")
    .select("id", { count: "exact", head: true })
    .eq("team_id", teamId);

  if (filters.status && filters.status !== "all") {
    countQuery = countQuery.eq("status", filters.status as ExpenseStatus);
  }
  if (filters.category && filters.category !== "all") {
    countQuery = countQuery.eq("category", filters.category);
  }
  if (searchTerm) {
    countQuery = countQuery.or(
      `description.ilike.%${searchTerm}%,invoice_number.ilike.%${searchTerm}%`,
    );
  }

  const { count, error: countError } = await countQuery;

  if (countError) {
    console.error(
      "Error fetching expenses count (service):",
      countError.message,
    );
    throw new Error("Error en obtenir el recompte de despeses.");
  }

  // LOG 3
  console.log(`expenses.service.ts: Recompte total de despeses: ${count}`);

  return {
    data: formattedData as unknown as ExpenseWithContact[],
    count: count ?? 0,
  };
}
// --- GestiÃ³ de la memÃ²ria cau (moguda aquÃ­) ---
const getCachedUniqueCategories = cache(
  async (activeTeamId: string): Promise<string[]> => {
    const supabaseAdmin = createAdminClient();
    // ğŸ”´ LOG 4: Miss de la memÃ²ria cau (Consola del Servidor)
    console.log(
      `[Cache Miss] expenses.service.ts: Buscant categories per team ${activeTeamId}`,
    );

    const { data, error } = await supabaseAdmin
      .from("expenses")
      .select("category")
      .eq("team_id", activeTeamId)
      .not("category", "is", null)
      .not("category", "eq", "");

    if (error) {
      console.error(
        `Error fetching unique categories for team ${activeTeamId} (Admin):`,
        error.message,
      );
      return [];
    }

    const uniqueCategories = [
      ...new Set(data.map((item) => item.category).filter(Boolean)),
    ];
    // ğŸ”´ LOG 5: Categories trobades (Consola del Servidor)
    console.log(
      `[Cache Miss] expenses.service.ts: Categories trobades: ${uniqueCategories.length}`,
    );
    return uniqueCategories.sort();
  },
  ["expense_categories_by_team"],
  { tags: ["filters", "expenses"] },
);

/**
 * SERVEI: ObtÃ© categories Ãºniques (funciÃ³ pÃºblica que crida la cau).
 */
export async function getUniqueExpenseCategories(
  teamId: string,
): Promise<string[]> {
  console.log(
    `expenses.service.ts: Crida a getCachedUniqueCategories per team ${teamId}`,
  );
  const categories = await getCachedUniqueCategories(teamId);
  console.log(
    `expenses.service.ts: Retornant ${categories.length} categories per team ${teamId}`,
  );
  return categories;
}


// =================== FILE: src/lib/services/finances/invoices/invoices.service.ts ===================

// src/lib/services/finances/invoices/invoices.service.ts (FITXER CORREGIT)
import { createAdminClient } from "@/lib/supabase/admin";
import { type SupabaseClient } from '@supabase/supabase-js';
import { type InvoiceListRow } from '@/types/finances/invoices';
import { type InvoiceStatus } from '@/types/db'; // âœ… Importem el tipus ENUM des de db.ts
import { unstable_cache as cache } from 'next/cache';

// âœ… CORRECCIÃ“: Definim i EXPORTEM el tipus RPC aquÃ­.
// Aquest tipus pertany a la capa de dades/servei.
export interface RpcInvoiceRow {
  id: number;
  invoice_number: string;
  issue_date: string;
  due_date: string | null;
  total_amount: number;
  status: InvoiceStatus;
  client_name: string;
  contact_id: number | null;
  contact_nom: string | null;
  total_count: number;
}

// âœ… CORRECCIÃ“: Els parÃ metres del servei ara sÃ³n primitius o tipus de DB.
// Ja no depÃ¨n de 'InvoicePageFilters' de l'acciÃ³.
interface GetPaginatedInvoicesParams {
  teamId: string;
  supabase: SupabaseClient;
  searchTerm: string | null;
  statusParam: InvoiceStatus | null; // <-- ParÃ metre simple
  contactIdParam: number | null;     // <-- ParÃ metre simple
  sortBy: string;
  sortOrder: string;
  limit: number;
  offset: number;
}

/**
 * SERVEI: ObtÃ© factures paginades des de la base de dades (RPC).
 */
export async function getPaginatedInvoices(params: GetPaginatedInvoicesParams) {
  const {
    teamId,
    supabase,
    searchTerm,
    statusParam, // âœ… Utilitzem el parÃ metre simple
    contactIdParam, // âœ… Utilitzem el parÃ metre simple
    sortBy,
    sortOrder,
    limit,
    offset,
  } = params;

  const rpcParams = {
    team_id_param: teamId,
    search_term_param: searchTerm || null,
    status_param: statusParam,
    contact_id_param: contactIdParam,
    sort_by_param: sortBy,
    sort_order_param: sortOrder,
    limit_param: limit,
    offset_param: offset,
  };

  // âœ… CORRECCIÃ“: Ja no cal importar RpcInvoiceRow, estÃ  definit localment.
  const { data, error } = await supabase
    .rpc('search_paginated_invoices', rpcParams)
    .returns<RpcInvoiceRow[]>();

  if (error) {
    console.error("Error in getPaginatedInvoices service:", error, "Params:", rpcParams);
    throw new Error("Error en carregar les factures des del servei.");
  }

  if (!Array.isArray(data) || data.length === 0) {
    return { data: [], count: 0 };
  }

  const totalCount = data[0].total_count ?? 0;

  const mappedData: InvoiceListRow[] = data.map((row): InvoiceListRow => ({
    id: row.id,
    invoice_number: row.invoice_number,
    issue_date: row.issue_date,
    due_date: row.due_date,
    total_amount: row.total_amount,
    status: row.status,
    client_name: row.client_name,
    contact_id: row.contact_id,
    contacts: row.contact_id ? { nom: row.contact_nom || null } : null,
  }));

  return {
    data: mappedData,
    count: totalCount,
  };
}

// --- Servei per als Filtres (Aquest ja estava bÃ©) ---

const getCachedClientsForFilter = cache(
  async (activeTeamId: string): Promise<{ id: number; nom: string | null }[]> => {
    const supabaseAdmin = createAdminClient(); 
    console.log(`[Cache Miss] Fetching clients for filter, team ${activeTeamId}`);
    
    const { data, error } = await supabaseAdmin
      .from('contacts')
      .select('id, nom')
      .eq('team_id', activeTeamId)
      //
      // âœ…âœ…âœ… LÃNIA CORREGIDA âœ…âœ…âœ…
      //
      // .is('is_client', true) // <--- LÃNIA INCORRECTA
      .eq('estat', 'Client')  // <--- LÃNIA CORRECTA
      //
      .order('nom', { ascending: true });

    if (error) {
      console.error(`Error fetching clients for filter (Admin):`, error.message);
      return [];
    }
    console.log(`[Cache Miss] Fetched ${data.length} clients for filter (Admin)`);
    return data || [];
  },
  ['clients_for_invoice_filter'],
  { tags: ["filters", "contacts"] }
);

export async function getClientsForFilterService(teamId: string): Promise<{ id: number; nom: string | null }[]> {
    return getCachedClientsForFilter(teamId);
}

// =================== FILE: src/lib/services/finances/invoices/invoicesDetail.service.ts ===================

import { type SupabaseClient } from "@supabase/supabase-js";
import { type Database } from '@/types/supabase';
import { createAdminClient } from "@/lib/supabase/admin";
import { 
    type InvoiceDetail,
    type InvoiceItem,
    type InvoiceAttachment,
    type InvoiceFormDataForAction,
    type InvoiceRow,
    type InvoiceAttachmentRow 
} from '@/types/finances/invoices';
import { type ActionResult } from "@/types/shared/index";
import { Resend } from 'resend';
import { generateInvoicePdfBuffer } from '@/lib/pdf/generateInvoicePDF';
import { registerInvoiceWithHacienda } from '@/lib/verifactu/service';

// Importem serveis que ja tenim per ser DRY (Do not Repeat Yourself)
import { getCompanyProfile } from '@/lib/services/settings/team/team.service';
import { getContactById } from '@/lib/services/crm/contacts/contacts.service'; // Assumim que aquest servei existeix
import { fetchInvoiceDetail } from "@/app/[locale]/(app)/finances/invoices/[invoiceId]/_hooks/fetchInvoiceDetail"; // Movem l'import aquÃ­

// Tipus locals
type Contact = Database['public']['Tables']['contacts']['Row'] | null;


// --- Funcions Internes del Servei (No exportades) ---

/**
 * FunciÃ³ auxiliar interna per desar la capÃ§alera de la factura.
 */
async function _upsertInvoiceHeader(
    supabase: SupabaseClient,
    invoiceData: InvoiceFormDataForAction,
    invoiceId: number | null,
    userId: string,
    teamId: string
): Promise<{ id: number; error: string | null }> {
    const dataToUpsert: Partial<InvoiceRow> = {
        // ... (tota la lÃ²gica de mapeig de dataToUpsert que ja tenies)
Â  Â  Â  Â  contact_id: invoiceData.contact_id || null,
Â  Â  Â  Â  budget_id: invoiceData.budget_id || null,
Â  Â  Â  Â  quote_id: invoiceData.quote_id || null,
Â  Â  Â  Â  project_id: invoiceData.project_id || null,
Â  Â  Â  Â  invoice_number: invoiceData.invoice_number,
Â  Â  Â  Â  issue_date: invoiceData.issue_date ? new Date(invoiceData.issue_date).toISOString().split('T')[0] : undefined,
Â  Â  Â  Â  due_date: invoiceData.due_date ? new Date(invoiceData.due_date).toISOString().split('T')[0] : null,
Â  Â  Â  Â  status: invoiceData.status,
Â  Â  Â  Â  notes: invoiceData.notes,
Â  Â  Â  Â  terms: invoiceData.terms,
Â  Â  Â  Â  payment_details: invoiceData.payment_details,
Â  Â  Â  Â  client_reference: invoiceData.client_reference,
Â  Â  Â  Â  currency: invoiceData.currency || 'EUR',
Â  Â  Â  Â  language: invoiceData.language || 'ca',
Â  Â  Â  Â  discount_amount: Number(invoiceData.discount_amount) || 0,
Â  Â  Â  Â  tax_rate: Number(invoiceData.tax_rate) || 0,
Â  Â  Â  Â  shipping_cost: Number(invoiceData.shipping_cost) || 0,
Â  Â  Â  Â  extra_data: invoiceData.extra_data,
    };

    let query;
    if (invoiceId) {
        query = supabase.from('invoices').update(dataToUpsert).eq('id', invoiceId).eq('team_id', teamId);
    } else {
        query = supabase.from('invoices').insert({
            ...dataToUpsert,
            user_id: userId,
            team_id: teamId,
        });
    }

    const { data, error } = await query.select('id').single();

    if (error) {
        console.error("Error upserting invoice header:", error);
        return { id: 0, error: `Error desant capÃ§alera: ${error.message ?? 'Error desconegut'}` };
    }
    if (!data?.id) {
        return { id: 0, error: "No s'ha pogut obtenir l'ID de la factura." };
    }
    return { id: data.id, error: null };
}

/**
 * FunciÃ³ auxiliar interna per sincronitzar les lÃ­nies de la factura.
 */
async function _syncInvoiceItems(
    supabase: SupabaseClient,
    invoiceId: number,
    items: InvoiceItem[],
    userId: string,
    teamId: string
): Promise<{ calculatedSubtotal: number; calculatedTotalLineDiscount: number; error: string | null }> {
    // ... (Tota la lÃ²gica de cÃ lcul i BBDD de 'syncInvoiceItems' que ja tenies)
Â  Â  let calculatedSubtotal = 0;
Â  Â  let calculatedTotalLineDiscount = 0;

Â  Â  const { data: existingDbItems, error: fetchError } = await supabase
Â  Â  Â  Â  .from('invoice_items')
Â  Â  Â  Â  .select('id')
Â  Â  Â  Â  .eq('invoice_id', invoiceId)
Â  Â  Â  Â  .returns<{ id: string }[]>();

Â  Â  if (fetchError) return { calculatedSubtotal: 0, calculatedTotalLineDiscount: 0, error: `Error obtenint items antics: ${fetchError.message}` };

    // ... (Resta de la lÃ²gica de syncInvoiceItems)
Â  Â  const existingDbItemIds = existingDbItems ? existingDbItems.map(item => item.id) : [];

Â  Â  const itemsToUpsert = items.map(item => {
Â  Â  Â  Â  const quantity = Number(item.quantity) || 0;
Â  Â  Â  Â  const unit_price = Number(item.unit_price) || 0;
Â  Â  Â  Â  const lineTotal = quantity * unit_price;
Â  Â  Â  Â  calculatedSubtotal += lineTotal;

Â  Â  Â  Â  let lineDiscount = 0;
Â  Â  Â  Â  const discountPercentage = Number(item.discount_percentage) || 0;
Â  Â  Â  Â  const discountAmount = Number(item.discount_amount) || 0;
Â  Â  Â  Â  if (discountAmount > 0) {
Â  Â  Â  Â  Â  Â  lineDiscount = discountAmount;
Â  Â  Â  Â  } else if (discountPercentage > 0) {
Â  Â  Â  Â  Â  Â  lineDiscount = lineTotal * (discountPercentage / 100);
Â  Â  Â  Â  }
Â  Â  Â  Â  calculatedTotalLineDiscount += lineDiscount;

Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â id: typeof item.id === 'string' && item.id.startsWith('temp-') ? undefined : item.id,
Â  Â  Â  Â  Â  Â invoice_id: invoiceId,
Â  Â  Â  Â  Â  Â user_id: userId,
Â  Â  Â  Â  Â  Â team_id: teamId,
Â  Â  Â  Â  Â  Â product_id: item.product_id ? Number(item.product_id) : null,
Â  Â  Â  Â  Â  Â description: item.description,
Â  Â  Â  Â  Â  Â quantity: quantity,
Â  Â  Â  Â  Â  Â unit_price: unit_price,
Â  Â  Â  Â  Â  Â total: lineTotal - lineDiscount,
Â  Â  Â  Â  Â  Â tax_rate: Number(item.tax_rate) || null,
Â  Â  Â  Â  Â  Â discount_percentage: discountPercentage > 0 ? discountPercentage : null,
Â  Â  Â  Â  Â  Â discount_amount: discountAmount > 0 ? discountAmount : null,
Â  Â  Â  Â  Â  Â reference_sku: item.reference_sku || null,
Â  Â  Â  Â };
Â  Â  });

Â  Â  const currentFormItemIds = items
Â  Â  Â  Â  .map(item => item.id)
Â  Â  Â  Â  .filter((id): id is string => typeof id === 'string' && !id.startsWith('temp-'));

Â  Â  const itemsToDeleteIds = existingDbItemIds.filter(dbId => !currentFormItemIds.includes(dbId));

Â  Â  if (itemsToUpsert.length > 0) {
Â  Â  Â  Â  const { error: upsertError } = await supabase.from('invoice_items').upsert(itemsToUpsert, { onConflict: 'id' });
Â  Â  Â  Â  if (upsertError) {
Â  Â  Â  Â  Â  Â  Â console.error("Error upserting invoice items:", upsertError);
Â  Â  Â  Â  Â  Â  return { calculatedSubtotal: 0, calculatedTotalLineDiscount: 0, error: `Error actualitzant lÃ­nies: ${upsertError.message}` };
Â  Â  Â  Â  }
Â  Â  }

Â  Â  if (itemsToDeleteIds.length > 0) {
Â  Â  Â  Â  const { error: deleteError } = await supabase.from('invoice_items').delete().in('id', itemsToDeleteIds);
Â  Â  Â  Â  if (deleteError) {
Â  Â  Â  Â  Â  Â  console.error("Error deleting old invoice items:", deleteError);
Â  Â  Â  Â  Â  Â  return { calculatedSubtotal: 0, calculatedTotalLineDiscount: 0, error: `Error esborrant lÃ­nies antigues: ${deleteError.message}` };
Â  Â  Â  Â  }
Â  Â  }

    return { calculatedSubtotal, calculatedTotalLineDiscount, error: null };
}

/**
 * FunciÃ³ auxiliar interna per actualitzar els totals de la factura.
 */
async function _updateInvoiceTotals(
    supabase: SupabaseClient,
    invoiceId: number,
    subtotal: number,
    totalLineDiscount: number,
    generalDiscount: number,
    taxRate: number,
    shippingCost: number
): Promise<{ error: string | null }> {
    // ... (Tota la lÃ²gica de cÃ lcul de 'updateInvoiceTotals' que ja tenies)
Â  Â const subtotalAfterLineDiscounts = subtotal - totalLineDiscount;
Â  Â const effectiveSubtotal = subtotalAfterLineDiscounts - generalDiscount;
Â  Â const calculatedTaxRate = taxRate || 0;
Â  Â const taxAmount = effectiveSubtotal > 0 ? effectiveSubtotal * (calculatedTaxRate / 100) : 0;
Â  Â const totalAmount = effectiveSubtotal + taxAmount + shippingCost;

Â  Â const { error } = await supabase
Â  Â  Â  Â .from('invoices')
Â  Â  Â  Â .update({
Â  Â  Â  Â  Â  Â subtotal: subtotal,
Â  Â  Â  Â  Â  Â tax_amount: taxAmount,
Â  Â  Â  Â  Â  Â total_amount: totalAmount,
Â  Â  Â  Â  Â  Â shipping_cost: shippingCost,
Â  Â  Â  Â })
Â  Â  Â  Â .eq('id', invoiceId);

    if (error) {
        console.error("Error updating invoice totals:", error);
        return { error: `Error actualitzant totals: ${error.message}` };
    }
    return { error: null };
}

/**
 * FunciÃ³ auxiliar interna per obtenir dades de context (Emissor/Receptor)
 */
async function _getInvoiceContext(supabase: SupabaseClient, teamId: string, contactId: number | null) {
    const companyProfile = await getCompanyProfile(supabase, teamId);

    let contact: Contact = null;
    if (contactId) {
        // Reutilitzem el servei de contactes
        contact = await getContactById(supabase, teamId, contactId); 
    }
    
    return { companyProfile, contact };
}


// --- Serveis Principals (Exportats per a les Accions) ---

/**
 * SERVEI: Desa una factura (capÃ§alera, lÃ­nies i totals).
 */
export async function saveInvoice(
    supabase: SupabaseClient,
    formData: InvoiceFormDataForAction & { invoice_items?: InvoiceItem[] },
    invoiceId: number | null,
    userId: string,
    teamId: string
): Promise<ActionResult<{ id: number }>> {
    
    const { invoice_items, ...invoiceData } = formData;

    const invoiceResult = await _upsertInvoiceHeader(supabase, invoiceData, invoiceId, userId, teamId);

    if (invoiceResult.error || !invoiceResult.id) {
        return { success: false, message: invoiceResult.error || "Error desant la capÃ§alera." };
    }
    const resultingInvoiceId = invoiceResult.id;

    const itemsResult = await _syncInvoiceItems(supabase, resultingInvoiceId, invoice_items || [], userId, teamId);

    if (itemsResult.error) {
        return { success: false, message: itemsResult.error, data: { id: resultingInvoiceId } };
    }
    
    const { calculatedSubtotal, calculatedTotalLineDiscount } = itemsResult;

    const totalsResult = await _updateInvoiceTotals(
        supabase,
        resultingInvoiceId,
        calculatedSubtotal,
        calculatedTotalLineDiscount,
        Number(invoiceData.discount_amount),
        Number(invoiceData.tax_rate),
        Number(invoiceData.shipping_cost)
    );

    if (totalsResult.error) {
        console.warn(`Factura ${resultingInvoiceId} desada, perÃ² error actualitzant totals: ${totalsResult.error}`);
    }

    return { success: true, message: "Factura desada correctament.", data: { id: resultingInvoiceId } };
}

/**
 * SERVEI: Esborra una factura (lÃ²gica de negoci + dades).
 */
export async function deleteInvoice(supabase: SupabaseClient, invoiceId: number, teamId: string): Promise<ActionResult> {
    const { data: invoiceStatus, error: statusError } = await supabase
        .from('invoices')
        .select('status')
        .eq('id', invoiceId)
        .eq('team_id', teamId)
        .single();

    if (statusError) {
        return { success: false, message: "Factura no trobada o accÃ©s denegat." };
    }

    if (invoiceStatus.status !== 'Draft') {
        return { success: false, message: "No es pot esborrar una factura que ja ha estat emesa. NomÃ©s esborranys." };
    }

    const supabaseAdmin = createAdminClient();
    const { data: attachments, error: attachError } = await supabase
        .from('invoice_attachments')
        .select('id, file_path')
        .eq('invoice_id', invoiceId);

    if (attachError) console.error("Error obtenint adjunts per esborrar:", attachError.message);

    if (attachments && attachments.length > 0) {
        const filePaths = attachments.map(a => a.file_path).filter((p): p is string => p !== null);
        if (filePaths.length > 0) {
            const { error: storageError } = await supabaseAdmin.storage.from('factures-adjunts').remove(filePaths);
            if (storageError) console.warn("Error esborrant adjunts de Storage:", storageError.message);
        }
    }

    const { error: deleteError } = await supabase
        .from('invoices')
        .delete()
        .eq('id', invoiceId)
        .eq('team_id', teamId);

    if (deleteError) {
        return { success: false, message: `Error esborrant factura: ${deleteError.message}` };
    }

    return { success: true, message: "Factura esborrada." };
}

/**
 * SERVEI: Puja un adjunt.
 */
export async function uploadAttachment(
    supabase: SupabaseClient,
    invoiceId: number,
    teamId: string,
    formData: FormData
): Promise<ActionResult<{ newAttachment: InvoiceAttachment }>> {
    const file = formData.get("file") as File | null;
    if (!file) return { success: false, message: "No s'ha proporcionat cap fitxer." };

    const { data: invoiceCheckData, error: invoiceCheckError } = await supabase
        .from('invoices')
        .select('id')
        .eq('id', invoiceId)
        .eq('team_id', teamId)
        .maybeSingle();

    if(invoiceCheckError || !invoiceCheckData) {
        return { success: false, message: "Factura no trobada o accÃ©s denegat." };
    }

    const filePath = `${teamId}/invoices/${invoiceId}/${Date.now()}-${file.name}`;
    const { error: uploadError } = await supabase.storage.from("factures-adjunts").upload(filePath, file);
    if (uploadError) {
        return { success: false, message: `Error pujant a Storage: ${uploadError.message}` };
    }

    const attachmentData: Partial<InvoiceAttachmentRow> = {
        invoice_id: invoiceId,
        file_path: filePath,
        filename: file.name,
        mime_type: file.type,
    };

    const { data: dbData, error: dbError } = await supabase
        .from("invoice_attachments")
        .insert(attachmentData)
        .select()
        .single();

    if (dbError) {
        await supabase.storage.from("factures-adjunts").remove([filePath]);
        return { success: false, message: `Error desant adjunt a BD: ${dbError.message}` };
    }

    return {
        success: true,
        message: "Adjunt pujat correctament.",
        data: { newAttachment: dbData as InvoiceAttachment }
    };
}

/**
 * SERVEI: ObtÃ© una URL signada per a un adjunt.
 */
export async function getAttachmentSignedUrl(teamId: string, filePath: string): Promise<ActionResult<{ signedUrl: string }>> {
    if (!filePath || typeof filePath !== 'string' || !filePath.startsWith(`${teamId}/`)) {
        return { success: false, message: "Ruta de fitxer invÃ lida o accÃ©s denegat." };
    }

    const supabaseAdmin = createAdminClient();
    const { data, error } = await supabaseAdmin.storage
        .from('factures-adjunts')
        .createSignedUrl(filePath, 300); // 5 minuts de validesa

    if (error) {
        return { success: false, message: `Error generant URL signada: ${error.message}` };
    }
    
    return { success: true, message: "URL signada generada.", data: { signedUrl: data.signedUrl } };
}

/**
 * SERVEI: Esborra un adjunt.
 */
export async function deleteAttachment(
    supabase: SupabaseClient,
    teamId: string,
    attachmentId: string,
    filePath: string | null
): Promise<ActionResult> {
    if (!attachmentId) return { success: false, message: "Falta l'ID de l'adjunt."};

    const { data: attachment, error: fetchError } = await supabase
        .from('invoice_attachments')
        .select('id, file_path, team_id, invoice_id')
        .eq('id', attachmentId)
        .single();

    if (fetchError || !attachment) {
        return { success: false, message: "Adjunt no trobat." };
    }
    if (attachment.team_id !== teamId) {
        return { success: false, message: "AccÃ©s denegat." };
    }

    const finalFilePath = filePath || attachment.file_path;

    const { error: dbError } = await supabase.from('invoice_attachments').delete().eq('id', attachmentId);
    if (dbError) {
        return { success: false, message: `Error esborrant adjunt de BD: ${dbError.message}` };
    }

    if (finalFilePath) {
        const supabaseAdmin = createAdminClient();
        const { error: storageError } = await supabaseAdmin.storage.from('factures-adjunts').remove([finalFilePath]);
        if (storageError) {
            console.warn(`Adjunt ${attachmentId} esborrat de BD, perÃ² error esborrant de Storage: ${storageError.message}`);
        }
    }

    return { success: true, message: "Adjunt eliminat correctament." };
}

/**
 * SERVEI: Finalitza una factura (VeriFactu).
 */
export async function finalizeInvoice(
    supabase: SupabaseClient, 
    invoiceId: number, 
    teamId: string
): Promise<ActionResult<{ signature: string }>> {
    
    // 1. Obtenir factura
    const { data: invoiceData, error: invoiceError } = await supabase
        .from('invoices')
        .select('*, invoice_items (*)')
        .eq('id', invoiceId)
        .eq('team_id', teamId)
        .single();

    if (invoiceError) return { success: false, message: 'Factura no trobada.' };
    if (invoiceData.status !== 'Draft') return { success: false, message: 'Aquesta factura ja ha estat emesa.' };

    // 2. Obtenir signatura anterior
    const { data: lastSignatureData, error: lastSignatureError } = await supabase
        .from('invoices')
        .select('verifactu_signature')
        .eq('team_id', teamId)
        .not('sent_at', 'is', null)
        .order('sent_at', { ascending: false })
        .limit(1)
        .maybeSingle();

    if (lastSignatureError) {
        return { success: false, message: "No s'ha pogut obtenir l'historial de signatures." };
    }
    const previousSignature = lastSignatureData?.verifactu_signature || null;

    // 3. Obtenir context (Emissor i Receptor)
    // âœ… REUTILITZEM EL NOSTRE HELPER
    const { companyProfile, contact } = await _getInvoiceContext(supabase, teamId, invoiceData.contact_id);

    if (!companyProfile) {
        return { success: false, message: "No s'ha pogut trobar el perfil de la teva empresa." };
    }
    if (!contact) {
        return { success: false, message: "No s'ha pogut trobar el contacte de la factura." };
    }
    
    // 3c. Preparar dades "bloquejades"
    // âœ… CORRECCIÃ“: Mapegem camps de 'contacts' (no 'team_profiles')
    const lockedInvoiceData = {
        company_name: companyProfile.company_name,
        company_address: companyProfile.company_address,
        company_tax_id: companyProfile.company_tax_id,
        company_email: companyProfile.company_email,
        company_logo_url: companyProfile.logo_url,
        
        client_name: contact.nom,
        client_address: contact.address, // Camp correcte d'esquema.sql
        client_email: contact.email,
    };

    const fullInvoiceForAPI = { ...invoiceData, ...lockedInvoiceData };

    // 4. Crida a VeriFactu
    const verifactuResult = await registerInvoiceWithHacienda(
        fullInvoiceForAPI as InvoiceDetail & { invoice_items: InvoiceItem[] },
        previousSignature
    );

    if (!verifactuResult.success) {
        return { success: false, message: verifactuResult.error };
    }
    const { uuid, qrData, signature } = verifactuResult.data;

    // 5. ActualitzaciÃ³ final a BBDD
    const { error: updateError } = await supabase
        .from('invoices')
        .update({
            status: 'Sent',
            sent_at: new Date().toISOString(),
            verifactu_uuid: uuid,
            verifactu_signature: signature,
            verifactu_previous_signature: previousSignature,
            verifactu_qr_data: qrData,
            ...lockedInvoiceData,
        })
        .eq('id', invoiceId)
        .eq('team_id', teamId)
        .eq('status', 'Draft'); // Control de concurrÃ¨ncia

    if (updateError) {
        return { success: false, message: `Error crÃ­tic: La factura s'ha registrat a Hisenda (ID: ${uuid}) perÃ² no s'ha pogut guardar a la BBDD.` };
    }

    return { success: true, message: 'Factura emesa i registrada.', data: { signature } };
}

/**
 * SERVEI: Envia la factura per email (PDF + Resend).
 */
export async function sendInvoiceByEmail(
    supabase: SupabaseClient,
    invoiceId: number,
    teamId: string,
    recipientEmail: string
): Promise<ActionResult> {
    
    // 1. Obtenir factura
    const invoiceData = (await fetchInvoiceDetail(invoiceId)) as InvoiceDetail;
    if (!invoiceData) return { success: false, message: 'Factura no trobada.' };
    if (invoiceData.team_id !== teamId) return { success: false, message: 'No tens permÃ­s.' };
    if (invoiceData.status === 'Draft') {
        return { success: false, message: "No es pot enviar un esborrany." };
    }

    // 2. Obtenir context (Emissor i Receptor)
    // âœ… REUTILITZEM EL NOSTRE HELPER
    const { companyProfile, contact } = await _getInvoiceContext(supabase, teamId, invoiceData.contact_id);

    if (!companyProfile) {
        return { success: false, message: "No s'ha pogut trobar el perfil de la teva empresa." };
    }
    // 'contact' pot ser null si la factura no en tÃ©, el PDF ho ha de gestionar.

    // 3. Generar PDF
    let pdfBuffer: Buffer;
    try {
        pdfBuffer = await generateInvoicePdfBuffer(
            invoiceData,
            companyProfile, // Ja no cal 'as CompanyProfile' si getCompanyProfile retorna el tipus correcte
            contact
        );
    } catch (error) {
        console.error('Error generant el PDF al servidor:', error);
        return { success: false, message: (error as Error).message || "No s'ha pogut generar el PDF." };
    }

    // 4. Enviar Email
    const resend = new Resend(process.env.RESEND_API_KEY);
    const fileName = `factura-${invoiceData.invoice_number || invoiceData.id}.pdf`;

    try {
        await resend.emails.send({
            from: 'facturacio@ribotflow.com', // TODO: Fer configurable
            to: recipientEmail,
            subject: `Nova Factura: ${invoiceData.invoice_number}`,
            html: `<p>Adjunt trobarÃ s la factura ${invoiceData.invoice_number}.</p>`, // TODO: Utilitzar plantilles
            attachments: [{
                filename: fileName,
                content: pdfBuffer,
                contentType: 'application/pdf',
            }],
        });
    } catch (error) {
        console.error("Error enviant email amb Resend:", error);
        return { success: false, message: "Error en el servei d'enviament d'email." };
    }

    // 5. Registrar lliurament
    if (process.env.NODE_ENV !== 'development') {
        try {
            await supabase.from('invoice_deliveries').insert({
                invoice_id: invoiceId,
                team_id: teamId,
                method: 'email',
                recipient: recipientEmail,
            });
        } catch (dbError) {
            console.warn("No s'ha pogut registrar el lliurament:", dbError);
        }
    }

    return { success: true, message: `Factura enviada a ${recipientEmail}.` };
}

// =================== FILE: src/lib/services/finances/products/products.service.ts ===================

// src/lib/services/finances/products.service.ts (COMPLET I CORREGIT)
import { type SupabaseClient } from '@supabase/supabase-js';
import { type Database, type Tables } from '@/types/supabase';
import { type Product as DbProduct } from '@/types/db';
import { 
  type PaginatedActionParams, 
  type PaginatedResponse 
} from '@/hooks/usePaginateResource';
import { unstable_cache as cache } from 'next/cache';
import { createAdminClient } from "@/lib/supabase/admin";
// âœ… Importem l'schema des de la seva nova ubicaciÃ³
import { productSchema } from '@/app/[locale]/(app)/finances/products/schemas'; 
import { notFound } from 'next/navigation';

// --- Tipus PÃºblics del Servei ---

export type Product = Tables<'products'>;

// Filtres per a la pÃ gina (TFilters)
export interface ProductPageFilters {
  category: string | 'all';
}

// âœ… Tipus de retorn per als formularis (MOGUT DES DE 'schemas.ts')
export type FormState = { 
  success: boolean;
  message: string;
  data?: Product;
  errors?: Record<string, string[]>; 
};

// Tipus per al hook de paginaciÃ³
type FetchProductsParams = PaginatedActionParams<ProductPageFilters>;
export type PaginatedProductsData = PaginatedResponse<Product>;

// ---
// âš™ï¸ FUNCIONS DE LECTURA (LLISTA I FILTRES)
// ---

/**
 * SERVEI: ObtÃ© productes paginats.
 */
export async function getPaginatedProducts(
  supabase: SupabaseClient<Database>,
  teamId: string,
  params: FetchProductsParams
): Promise<PaginatedProductsData> {
  const { searchTerm, filters, sortBy, sortOrder, limit, offset } = params;
  let query = supabase
    .from('products')
    .select('*', { count: 'exact' })
    .eq('team_id', teamId)
    .order(sortBy || 'name', { ascending: sortOrder === 'asc' });

  if (filters.category && filters.category !== 'all') {
    query = query.eq('category', filters.category);
  }
  if (searchTerm) {
    query = query.or(`name.ilike.%${searchTerm}%,description.ilike.%${searchTerm}%`);
  }
  query = query.range(offset, offset + limit - 1);

  const { data, error, count } = await query;

  if (error) {
    console.error("Error fetching paginated products (service):", error);
    return { data: [], count: 0 };
  }
  return { data: data || [], count: count || 0 };
}

/**
 * SERVEI: ObtÃ© categories Ãºniques (Cache).
 */
const getCachedUniqueProductCategories = cache(
  async (activeTeamId: string): Promise<string[]> => {
    const supabaseAdmin = createAdminClient();
    const { data, error } = await supabaseAdmin
      .from('products')
      .select('category')
      .eq('team_id', activeTeamId)
      .not('category', 'is', null)
      .not('category', 'eq', '');

    if (error) {
      console.error(`Error fetching product categories (Admin):`, error.message);
      return [];
    }
    const isString = (s: string | null): s is string => typeof s === 'string';
    const uniqueCategories = [...new Set(data.map((item) => item.category).filter(isString))];
    return uniqueCategories.sort();
  },
  ['product_categories_by_team'],
  { tags: ["filters", "products"] }
);

/**
 * SERVEI: FunciÃ³ pÃºblica per cridar la cau de categories.
 */
export async function getUniqueProductCategories(teamId: string): Promise<string[]> {
  return getCachedUniqueProductCategories(teamId);
}

/**
 * SERVEI: ObtÃ© tots els productes actius (per a selectors).
 */
export async function getActiveProducts(
  supabase: SupabaseClient<Database>, 
  teamId: string
): Promise<DbProduct[]> { 
  const { data, error } = await supabase
    .from('products')
    .select('*')
    .eq('team_id', teamId)
    .eq('is_active', true)
    .order('name', { ascending: true });

  if (error) {
    console.error('Error service(getActiveProducts):', error.message);
    return [];
  }
  return (data as DbProduct[]) || [];
}

/**
 * âœ… NOU SERVEI: ObtÃ© el detall d'un producte per ID.
 * (Mogut des de [productId]/actions.ts)
 */
export async function fetchProductDetail(
  supabase: SupabaseClient<Database>,
  teamId: string,
  productId: number
): Promise<Product> {
  const { data: product, error } = await supabase
    .from('products')
    .select('*')
    .eq('id', productId)
    .eq('team_id', teamId)
    .maybeSingle();

  if (error) {
    console.error("Error fetching product detail (service):", error);
    throw new Error("No s'ha pogut carregar el producte.");
  }
  if (!product) {
    notFound(); // Correcte: el servei pot llanÃ§ar notFound
  }
  return product;
}

// ---
// âš™ï¸ FUNCIONS DE MUTACIÃ“ (CRUD)
// ---

/**
 * SERVEI: Crea un nou producte.
 */
export async function createProduct(
  supabase: SupabaseClient<Database>,
  userId: string,
  teamId: string,
  formData: FormData
): Promise<FormState> {
  const validatedFields = productSchema.safeParse({
    ...Object.fromEntries(formData.entries()),
    is_active: formData.get('is_active') === 'on',
  });

  if (!validatedFields.success) {
    return {
      success: false,
      message: 'Errors de validaciÃ³.',
      errors: validatedFields.error.flatten().fieldErrors,
    };
  }

  const { data: newProduct, error } = await supabase
    .from('products')
    .insert({
      ...validatedFields.data,
      user_id: userId,
      team_id: teamId,
    })
    .select()
    .single();

  if (error) {
    return {
      success: false,
      message: `Error en crear el producte: ${error.message}`,
    };
  }

  return {
    success: true,
    message: 'Producte creat correctament.',
    data: newProduct,
  };
}

/**
 * âœ… NOU SERVEI: Actualitza un producte existent.
 * (Mogut des de [productId]/actions.ts)
 */
export async function updateProduct(
  supabase: SupabaseClient<Database>,
  id: number,
  formData: FormData
): Promise<FormState> {
  const validatedFields = productSchema.safeParse({
    ...Object.fromEntries(formData.entries()),
    is_active: formData.get('is_active') === 'on',
  });

  if (!validatedFields.success) {
    return {
      success: false,
      message: 'Errors de validaciÃ³.',
      errors: validatedFields.error.flatten().fieldErrors,
    };
  }

  const { data: updatedProduct, error } = await supabase
    .from('products')
    .update(validatedFields.data)
    .eq('id', id)
    .select()
    .single();

  if (error) {
    return {
      success: false,
      message: `Error en actualitzar el producte: ${error.message}`,
    };
  }

  return {
    success: true,
    message: 'Producte actualitzat correctament.',
    data: updatedProduct,
  };
}

/**
 * SERVEI: Elimina un producte.
 */
export async function deleteProduct(
  supabase: SupabaseClient<Database>,
  id: number
): Promise<FormState> {
  const { error } = await supabase.from('products').delete().eq('id', id);

  if (error) {
    return {
      success: false,
      message: `Error en eliminar el producte: ${error.message}`,
    };
  }

  return { success: true, message: 'Producte eliminat correctament.' };
}

// =================== FILE: src/lib/services/finances/quotes/quote-editor.service.ts ===================

// /src/lib/services/crm/quotes/quote-editor.service.ts (CORREGIT)
import {
  type SupabaseClient,
  type PostgrestError,
  type User, // âœ… CORRECCIÃ“ 2: Importem el tipus 'User'
} from '@supabase/supabase-js'
import { type Database } from '@/types/supabase'
import { type ActionResult } from '@/types/shared/index'

// Importem tots els tipus necessaris des del fitxer centralitzat
import {
  type QuotePayload,
  type QuoteEditorDataPayload,
  type QuoteDetailsResponse,
  type NewQuote,
  type InitialQuoteType,
  type Team,
  type Product,
  type Quote,
  type QuoteItem,
} from '@/types/finances/quotes' // Assegura't que la ruta Ã©s correcta
import { generateQuotePdfBuffer } from '@/lib/pdf/generateQuotePDF'
import { type EditableQuote } from '@/app/[locale]/(app)/finances/quotes/[id]/_hooks/useQuoteEditor'

// âœ… CORRECCIÃ“ 1: Importem 'Base64' des de 'js-base64'
import { Base64 } from 'js-base64'
import crypto from 'crypto' // Per al randomUUID de Node.js

// âœ… Importem la teva funciÃ³ de crypto.ts
import { decryptToken } from '@/lib/utils/crypto'

// --- Tipus Locals ---
type Contact = Database['public']['Tables']['contacts']['Row']
type GoogleTokenResponse = {
  access_token: string
  expires_in: number
  scope: string
  token_type: string
}

/**
 * SERVEI: ObtÃ© totes les dades necessÃ ries per a l'editor de pressupostos.
 */
export async function getQuoteEditorData(
  supabase: SupabaseClient<Database>,
  teamId: string,
  userId: string,
  quoteId: string | 'new'
): Promise<{ data: QuoteEditorDataPayload | null; error: string | null }> {
  try {
    if (quoteId === 'new') {
      // --- LÃ’GICA PER A UN PRESSUPOST NOU ---
      const [contactsRes, productsRes, teamRes, lastQuoteRes] =
        await Promise.all([
          supabase.from('contacts').select('*').eq('team_id', teamId),
          supabase
            .from('products')
            .select('*')
            .eq('is_active', true)
            .eq('team_id', teamId),
          supabase.from('teams').select('*').eq('id', teamId).single(),
          supabase
            .from('quotes')
            .select('sequence_number')
            .eq('team_id', teamId)
            .order('sequence_number', { ascending: false })
            .limit(1)
            .maybeSingle(),
        ])

      const errors = [
        contactsRes.error,
        productsRes.error,
        teamRes.error,
        lastQuoteRes.error,
      ].filter(Boolean)
      if (errors.length > 0) {
        console.error(
          "Error en carregar les dades per a un nou pressupost (service):",
          errors
        )
        throw new Error("Error en carregar les dades de l'editor.")
      }

      // LÃ²gica de negoci (cÃ lcul del nÃºmero de pressupost)
      const lastSequence = lastQuoteRes.data?.sequence_number || 0
      const nextSequence = lastSequence + 1
      const year = new Date().getFullYear()
      const formattedQuoteNumber = `PRE-${year}-${String(
        nextSequence
      ).padStart(4, '0')}`

      const initialQuote: NewQuote = {
        id: 'new',
        team_id: teamId,
        user_id: userId,
        contact_id: null,
        opportunity_id: null,
        quote_number: formattedQuoteNumber,
        sequence_number: nextSequence,
        issue_date: new Date().toISOString().slice(0, 10),
        expiry_date: null,
        status: 'Draft',
        notes: 'GrÃ cies pel vostre interÃ¨s en els nostres serveis.',
        subtotal: 0,
        discount: 0,
        tax: 0,
        tax_percent: 21,
        total: 0,
        show_quantity: true,
        created_at: new Date().toISOString(),
        sent_at: null,
        rejection_reason: null,
        send_at: null,
        theme_color: null,
        secure_id: crypto.randomUUID(),
        items: [
          {
            description: '',
            quantity: 1,
            unit_price: 0,
          },
        ],
      }

      const payload: QuoteEditorDataPayload = {
        initialQuote: initialQuote as InitialQuoteType,
        contacts: contactsRes.data || [],
        products: productsRes.data || [],
        companyProfile: teamRes.data as Team | null,
        initialOpportunities: [],
        pdfUrl: null, // No hi ha PDF per a un pressupost nou
      }
      return { data: payload, error: null }
    } else {
      // --- LÃ’GICA PER A EDITAR UN PRESSUPOST EXISTENT ---
      const numericQuoteId = Number(quoteId)
      const [contactsRes, productsRes, teamRes, quoteDetailsRes] =
        await Promise.all([
          supabase.from('contacts').select('*').eq('team_id', teamId),
          supabase
            .from('products')
            .select('*')
            .eq('is_active', true)
            .eq('team_id', teamId),
          supabase.from('teams').select('*').eq('id', teamId).single(),
          supabase
            .rpc('get_quote_details', { p_quote_id: numericQuoteId })
            .single<QuoteDetailsResponse>(),
        ])

      const errors = [
        contactsRes.error,
        productsRes.error,
        teamRes.error,
        quoteDetailsRes.error,
      ].filter(Boolean)
      if (errors.length > 0) {
        console.error(
          "Error en carregar les dades d'un pressupost existent (service):",
          errors
        )
        throw new Error("Error en carregar les dades de l'editor.")
      }

      const quoteDetails = quoteDetailsRes.data
      if (!quoteDetails?.quote) {
        return { data: null, error: 'Pressupost no trobat.' }
      }

      // ğŸš¨ ATENCIÃ“: Aquesta lÃ²gica de 'pdfUrl' Ã©s la que estem eliminant
      // La deixem de moment per no trencar el 'QuoteEditorData',
      // perÃ² el botÃ³ de descÃ rrega hauria de ser on-the-fly.
      let pdfUrl: string | null = null
      const filePath = `quotes/${teamId}/${quoteId}.pdf`
      const { data: signedUrlData, error: signedUrlError } =
        await supabase.storage
          .from('fitxers-privats')
          .createSignedUrl(filePath, 60 * 5) // 5 minuts

      if (signedUrlError) {
        console.warn(
          `No s'ha pogut generar la URL signada per a ${filePath} (service): ${signedUrlError.message}`
        )
      } else {
        pdfUrl = signedUrlData.signedUrl
      }

      const payload: QuoteEditorDataPayload = {
        initialQuote: quoteDetails.quote as Quote & { items: QuoteItem[] },
        contacts: contactsRes.data || [],
        products: productsRes.data || [],
        companyProfile: teamRes.data as Team | null,
        initialOpportunities: quoteDetails.opportunities || [],
        pdfUrl: pdfUrl,
      }
      return { data: payload, error: null }
    }
  } catch (error: unknown) {
    const message =
      error instanceof Error
        ? error.message
        : "Error desconegut al carregar les dades de l'editor."
    console.error('Error a getQuoteEditorData (service):', message)
    return { data: null, error: message }
  }
}

/**
 * SERVEI: Desa (crea o actualitza) un pressupost i els seus conceptes.
 */
export async function saveQuote(
  supabase: SupabaseClient<Database>,
  quoteData: QuotePayload,
  teamId: string
): Promise<ActionResult<number>> {
  // 1. ValidaciÃ³ de dades
  if (!quoteData.contact_id) {
    return { success: false, message: 'Cal seleccionar un client.' }
  }
  if (quoteData.id === 'new') {
    quoteData.team_id = teamId
  }
  if (!quoteData.team_id) {
    return { success: false, message: 'El pressupost no estÃ  assignat a cap equip.' }
  }
  if (quoteData.items.length === 0) {
    return {
      success: false,
      message: 'El pressupost ha de tenir almenys un concepte.',
    }
  }
  const hasInvalidItem = quoteData.items.some(
    (item) => !item.description?.trim() || (item.quantity ?? 1) <= 0
  )
  if (hasInvalidItem) {
    return {
      success: false,
      message:
        'Un o mÃ©s conceptes tenen dades invÃ lides (descripciÃ³ buida o quantitat 0).',
    }
  }

  // 2. Crida a la BD
  try {
    const { data, error } = await supabase.rpc('upsert_quote_with_items', {
      quote_payload: quoteData as QuotePayload,
    })

    if (error) {
      console.error(
        'Supabase RPC Error (service):',
        JSON.stringify(error, null, 2)
      )
      throw new Error(
        error.message || "Error a la funciÃ³ RPC 'upsert_quote_with_items'"
      )
    }

    const finalQuoteId = (data as { quote_id: number }).quote_id
    return { success: true, message: 'Pressupost desat.', data: finalQuoteId }
  } catch (error: unknown) {
    const message =
      error instanceof Error
        ? error.message
        : 'Error desconegut al desar el pressupost.'
    console.error('Error a saveQuote (service):', message)
    if (message.includes('constraint')) {
      return {
        success: false,
        message:
          "Error de dades. Assegura't que tots els camps obligatoris estan omplerts.",
      }
    }
    return { success: false, message }
  }
}

/**
 * SERVEI: Esborra un pressupost i els seus items.
 */
export async function deleteQuote(
  supabase: SupabaseClient<Database>,
  quoteId: number
): Promise<{ error: PostgrestError | null }> {
  const { error: itemsError } = await supabase
    .from('quote_items')
    .delete()
    .eq('quote_id', quoteId)

  if (itemsError) {
    console.error('Error deleting quote items (service):', itemsError)
    return { error: itemsError }
  }

  const { error: quoteError } = await supabase
    .from('quotes')
    .delete()
    .eq('id', quoteId)

  if (quoteError) {
    console.error('Error deleting quote (service):', quoteError)
    return { error: quoteError }
  }

  return { error: null }
}

/**
 * SERVEI: Crea un nou producte.
 */
export async function createProduct(
  supabase: SupabaseClient<Database>,
  newProduct: { name: string; price: number },
  userId: string,
  teamId: string
): Promise<ActionResult<Product>> {
  try {
    const { data, error } = await supabase
      .from('products')
      .insert({
        user_id: userId,
        team_id: teamId,
        name: newProduct.name,
        price: newProduct.price,
      })
      .select()
      .single()

    if (error) throw error
    return { success: true, message: 'Nou producte desat.', data }
  } catch (error: unknown) {
    const message =
      error instanceof Error ? error.message : 'Error en crear el producte.'
    return { success: false, message }
  }
}

/**
 * SERVEI: Actualitza el perfil de l'equip.
 */
export async function updateTeamProfile(
  supabase: SupabaseClient<Database>,
  teamData: Partial<Team>,
  teamId: string
): Promise<ActionResult<Team>> {
  try {
    const { data, error } = await supabase
      .from('teams')
      .update(teamData)
      .eq('id', teamId)
      .select()
      .single()

    if (error) throw error
    return { success: true, message: 'Perfil actualitzat.', data }
  } catch (error: unknown) {
    const message =
      error instanceof Error
        ? error.message
        : 'Error en actualitzar el perfil.'
    return { success: false, message }
  }
}

// --- INICI DE LA LÃ’GICA D'ENVIAMENT (Moguda de l'Edge Function) ---

/**
 * HELPER 1: AutenticaciÃ³ de Google
 */
async function getGoogleAccessToken(
  supabase: SupabaseClient<Database>,
  userId: string
): Promise<{ accessToken: string; userEmail: string }> {
  
  if (!process.env.ENCRYPTION_SECRET_KEY) {
    throw new Error(
      "Falta ENCRYPTION_SECRET_KEY a les variables d'entorn per desxifrar el token."
    )
  }

  console.log('[sendQuote] Obtenint credencials d_usuari...')
  // âœ… CORRECCIÃ“ 3: Canviat 'provider_email' per 'provider_user_id'
  // âœ… CORRECCIÃ“ PRINCIPAL: Canviat 'google' per 'google_gmail'
  const { data: creds, error: credsError } = await supabase
    .from('user_credentials')
    .select('refresh_token, provider_user_id') 
    .eq('user_id', userId)
    .eq('provider', 'google_gmail') // ğŸ‘ˆ EL GRAN CANVI Ã‰S AQUÃ
    .maybeSingle()

  if (credsError)
    throw new Error(`Error obtenint credencials: ${credsError.message}`)
  if (!creds?.refresh_token)
    throw new Error(
      "No s'han trobat les credencials de Google (refresh token). Si us plau, connecta el teu compte a 'Integracions'."
    )
  // âœ… CORRECCIÃ“ 3: Comprovem 'provider_user_id'
  if (!creds.provider_user_id)
    throw new Error("Les credencials no tenen un email (provider_user_id) associat.")


  console.log('[sendQuote] Desencriptant refresh token...')
  const decryptedToken = await decryptToken(
    creds.refresh_token,
    process.env.ENCRYPTION_SECRET_KEY
  )
  console.log('[sendQuote] Token desencriptat correctament.')

  console.log('[sendQuote] SolÂ·licitant nou Google Access Token...')
  const tokenResponse = await fetch('https://oauth2.googleapis.com/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      client_id: process.env.GOOGLE_CLIENT_ID,
      client_secret: process.env.GOOGLE_CLIENT_SECRET,
      refresh_token: decryptedToken,
      grant_type: 'refresh_token',
    }),
  })

  const tokenData: GoogleTokenResponse = await tokenResponse.json()

  if (!tokenResponse.ok || !tokenData.access_token) {
    console.error('Error en la resposta de Google Token:', tokenData)
    throw new Error("No s'ha pogut refrescar l'access token de Google.")
  }

  console.log('[sendQuote] Google Access Token obtingut.')
  // âœ… CORRECCIÃ“ 3: Retornem el 'provider_user_id' com a 'userEmail'
  return { accessToken: tokenData.access_token, userEmail: creds.provider_user_id }
}

/**
 * HELPER 2: Cos de l'Email
 */
function buildHtmlBody(
  contact: Contact,
  quote: EditableQuote,
  companyName: string,
  clientPortalUrl: string,
  senderEmail: string
): string {
  // (Aquesta funciÃ³ no tÃ© canvis, Ã©s la teva plantilla)
  return `
    <div style="font-family: 'Inter', Arial, sans-serif; font-size: 16px; color: #333; line-height: 1.6; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; border-radius: 10px;">
      <p>Hola <strong>${contact.nom}</strong>,</p>
      <p>GrÃ cies per la teva confianÃ§a. Hem adjuntat una cÃ²pia en PDF del pressupost <strong>#${quote.quote_number}</strong>.</p>
      <p>Per a la teva comoditat, tambÃ© pots revisar, acceptar o rebutjar el pressupost de forma digital fent clic al segÃ¼ent botÃ³:</p>
      <div style="text-align: center; margin: 25px 0;">
        <a href="${clientPortalUrl}" style="display: inline-block; background-color: #007bff; color: #fff; padding: 14px 24px; text-decoration: none; border-radius: 8px; font-size: 16px; font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: all 0.3s ease;">
          Revisar i Acceptar Online
        </a>
      </div>
      <p>Estem a la teva disposiciÃ³ per a qualsevol dubte que puguis tenir.</p>
      <p>Salutacions,<br><strong>${companyName}</strong></p>
      <hr style="border: none; border-top: 1px solid #ddd; margin: 30px 0;">
      <p style="font-size: 12px; color: #999; text-align: center;">
        Aquest missatge Ã©s automÃ tic. Si tens algun problema amb els enllaÃ§os, contacta amb nosaltres a <a href="mailto:${senderEmail}" style="color: #007bff; text-decoration: none;">${senderEmail}</a>.
      </p>
    </div>
  `
}

/**
 * HELPER 3: Missatge MIME
 */
function buildMimeMessage(
  contact: Contact,
  quote: EditableQuote,
  companyName: string,
  clientPortalUrl: string,
  senderEmail: string,
  pdfBase64: string
): string {
  console.log('[sendQuote] Construint missatge MIME...')
  const subject = `El teu pressupost ${quote.quote_number} de ${companyName}`

  const encodeSubject = (subject: string): string => {
    // âœ… CORRECCIÃ“ 1: Fem servir Base64.encode
    const encoded = Base64.encode(subject, true) // true = URL-safe
    return `=?UTF-8?B?${encoded}?=`
  }

  const boundary = `----=_Part_${crypto.randomUUID()}`
  const htmlBody = buildHtmlBody(
    contact,
    quote,
    companyName,
    clientPortalUrl,
    senderEmail
  )
  const fileName = `pressupost-${quote.quote_number || quote.id}.pdf`

  const emailMessage = [
    `Content-Type: multipart/mixed; boundary="${boundary}"`,
    `MIME-Version: 1.0`,
    `To: ${contact.email}`,
    `From: "${companyName}" <${senderEmail}>`,
    `Subject: ${encodeSubject(subject)}`,
    ``,
    `--${boundary}`,
    `Content-Type: text/html; charset="UTF-8"`,
    ``,
    htmlBody,
    ``,
    `--${boundary}`,
    `Content-Type: application/pdf`,
    `Content-Transfer-Encoding: base64`,
    `Content-Disposition: attachment; filename="${fileName}"`,
    ``,
    pdfBase64,
    ``,
    `--${boundary}--`,
  ].join('\n')

  console.log('[sendQuote] Estructura MIME construÃ¯da.')
  return emailMessage
}

/**
 * SERVEI PRINCIPAL: Envia el pressupost per email (PDF "al vol" + Gmail API)
 */
export async function sendQuote(
  supabase: SupabaseClient<Database>,
  user: User, // Ara necessitem l'usuari per a l'autenticaciÃ³
  quoteId: number
): Promise<ActionResult> {
  try {
    // --- 1. Obtenir Dades ---
    console.log(`[sendQuote] Obtenint dades per al pressupost ${quoteId}...`)
    const { data: quoteData, error: quoteError } = await supabase
      .from('quotes')
      .select('*, items:quote_items(*), contacts(*), team:teams(*)')
      .eq('id', quoteId)
      .single()

    if (quoteError)
      throw new Error(`Error en llegir el pressupost: ${quoteError.message}`)
    if (!quoteData) throw new Error('Pressupost no trobat.')

    const quote = quoteData as unknown as EditableQuote
    const contact = quoteData.contacts as Contact | null
    const company = quoteData.team as Team | null

    // Validacions
    if (!contact)
      return { success: false, message: 'El pressupost no tÃ© un contacte assignat.' }
    if (!contact.email)
      return { success: false, message: 'El contacte no tÃ© un email assignat.' }
    if (!company)
      return {
        success: false,
        message: "No s'ha pogut trobar el perfil de la teva empresa.",
      }
    if (!quote.secure_id)
      return {
        success: false,
        message: "Falta l'ID segur per a l'enllaÃ§ pÃºblic.",
      }
    
    console.log('[sendQuote] Dades obtingudes correctament.')

    // --- 2. Generar el PDF "al vol" ---
    console.log(`[sendQuote] Generant PDF per al pressupost ${quote.quote_number}...`)
    const pdfBuffer = await generateQuotePdfBuffer(quote, company, contact)
    const pdfBase64 = pdfBuffer.toString('base64')
    console.log(
      `[sendQuote] PDF generat (${(pdfBuffer.length / 1024).toFixed(1)} KB)`
    )

    // --- 3. Obtenir AutenticaciÃ³ de Google ---
    // Aquesta funciÃ³ ara retorna l'email de la integraciÃ³ (provider_user_id)
    const { accessToken, userEmail } = await getGoogleAccessToken(supabase, user.id)

    // --- 4. Construir Email MIME ---
    const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'
    const clientPortalUrl = `${baseUrl}/quote/${quote.secure_id}`
    const companyName = company.name || 'El teu equip'

    const mimeMessage = buildMimeMessage(
      contact,
      quote,
      companyName,
      clientPortalUrl,
      userEmail, // âœ… Fem servir l'email de la integraciÃ³ (provider_user_id)
      pdfBase64
    )

    // âœ… CORRECCIÃ“ 1: Fem servir Base64.encode
    const rawEmail = Base64.encode(mimeMessage, true)
      .replace(/\+/g, '-')
      .replace(/\//g, '_')
      .replace(/=+$/, '')

    // --- 5. Enviar Email via Gmail API ---
    console.log(`[sendQuote] Enviant email via Gmail API com a ${userEmail}...`)
    const gmailRes = await fetch(
      'https://www.googleapis.com/gmail/v1/users/me/messages/send',
      {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${accessToken}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ raw: rawEmail }),
      }
    )

    if (!gmailRes.ok) {
      const errorData = await gmailRes.json()
      console.error('Error enviant Gmail:', errorData)
      throw new Error(`Error de l'API de Gmail: ${errorData.error.message}`)
    }
    console.log(`[sendQuote] Email enviat correctament a ${contact.email}.`)

    // --- 6. Actualitzar Estats ---
    const { error: updateError } = await supabase
      .from('quotes')
      .update({ status: 'Sent', sent_at: new Date().toISOString() })
      .eq('id', quoteId)

    if (updateError) {
      console.warn(
        `[sendQuote] Email enviat, perÃ² no s'ha pogut actualitzar l'estat: ${updateError.message}`
      )
    }

    if (quote.opportunity_id) {
      await supabase
        .from('opportunities')
        .update({ stage_name: 'Proposta Enviada' })
        .eq('id', quote.opportunity_id)
    }

    return { success: true, message: `Pressupost enviat a ${contact.email}.` }
  } catch (error) {
    console.error('[sendQuote] Error fatal:', error)
    const message =
      error instanceof Error
        ? error.message
        : "No s'ha pogut enviar el pressupost."
    return { success: false, message }
  }
}

// =================== FILE: src/lib/services/finances/quotes/quotes.service.ts ===================

// src/lib/services/crm/quotes/quotes.service.ts
import { type SupabaseClient, type PostgrestError } from '@supabase/supabase-js';
import { type Database } from '@/types/supabase';
import { type PaginatedActionParams } from '@/hooks/usePaginateResource';

// Importem els tipus centralitzats (assegura't que la ruta Ã©s correcta)
import {
  type QuoteWithContact,
  type RpcQuoteRow,
  type QuoteId,
  type QuotePageFilters,
  type PaginatedQuotesData,
  // Ja no necessitem 'Quote' base aquÃ­ per mapejar
} from '@/types/finances/quotes'; // O /crm/quotes

/**
 * FunciÃ³ auxiliar aÃ¯llada per mapejar la fila RPC a l'objecte QuoteWithContact.
 * âœ… CORRECCIÃ“ (Error 3): Ara transforma RpcQuoteRow -> QuoteWithContact.
 */
function mapRpcRowToQuote(row: RpcQuoteRow): QuoteWithContact | null {
  if (!row || typeof row !== "object") {
    console.warn("Invalid row data found during mapping:", row);
    return null;
  }

  // 1. Destructurem els camps que anem a transformar o eliminar
  const { 
    contact_id, 
    contact_nom, 
    contact_empresa, 
    ...quoteBase 
  } = row;

  // 2. Creem l'objecte 'contacts' enriquit
  const contacts = contact_id
    ? {
        id: contact_id,
        nom: contact_nom ?? "",
        empresa: contact_empresa,
      }
    : null;

  // 3. Retornem l'objecte final que espera la UI (QuoteWithContact)
  // 'quoteBase' ara contÃ© correctament 'currency', 'language', 'terms', etc.
  // perquÃ¨ venen de 'RpcQuoteRow'.
  return {
    ...quoteBase, // ContÃ© tots els camps de RpcQuoteRow excepte els destructurats
    contact_id: contact_id, // El tornem a afegir, ja que Omit no el va treure
    contacts: contacts,
  };
}

/**
 * ObtÃ© una llista paginada de pressupostos des de la funciÃ³ RPC.
 */
export async function getPaginatedQuotes(
  supabase: SupabaseClient<Database>,
  teamId: string,
  params: PaginatedActionParams<QuotePageFilters>
): Promise<PaginatedQuotesData> {
  const { searchTerm, filters, sortBy, sortOrder, limit, offset } = params;

  const statusParam = (filters.status === "all" || !filters.status)
    ? null
    : filters.status;
    
  const effectiveSortBy = sortBy === "client_name"
    ? "c.nom"
    : (sortBy || "issue_date");

  // âœ… CORRECCIÃ“ (Error 1): Canviem '|| null' per '|| undefined' 
  // per coincidir amb els tipus de la RPC de Supabase.
  const rpcParams = {
    team_id_param: teamId,
    search_term_param: searchTerm || undefined, // <-- Canviat de null a undefined
    status_param: statusParam || undefined, // <-- Canviat de null a undefined
    sort_by_param: effectiveSortBy,
    sort_order_param: sortOrder || "desc",
    limit_param: limit,
    offset_param: offset,
  };

  // console.log("Calling RPC 'search_paginated_quotes' (service) with params:", rpcParams);
  
  // (Error 2) Aquesta lÃ­nia Ã©s correcta i funcional, ignorem el 'warning' de moment.
  const { data, error } = await supabase
    .rpc("search_paginated_quotes", rpcParams)
    .returns<RpcQuoteRow[]>();

  if (error) {
    console.error("Error calling search_paginated_quotes RPC (service):", {
      message: error.message,
      code: error.code,
      details: error.details,
      rpcParams,
    });
    return { data: [], count: 0 };
  }

  if (!Array.isArray(data) || data.length === 0) {
    // console.log("RPC returned no data (service).");
    return { data: [], count: 0 };
  }

  const totalCount = data[0].total_count ?? 0;
  // console.log(`RPC returned ${data.length} rows, total count: ${totalCount} (service)`);

  const mappedData = data
    .map(mapRpcRowToQuote) // âœ… Ara 'mapRpcRowToQuote' Ã©s correcta
    .filter((item): item is QuoteWithContact => item !== null);

  return {
    data: mappedData,
    count: totalCount,
  };
}

/**
 * Esborra un pressupost i els seus items associats.
 * Retorna nomÃ©s l'error si n'hi ha.
 */
export async function deleteQuote(
  supabase: SupabaseClient<Database>,
  quoteId: QuoteId
): Promise<{ error: PostgrestError | null }> {
  
  // 1. Eliminem items primer
  const { error: itemsError } = await supabase
    .from("quote_items")
    .delete()
    .eq("quote_id", quoteId);

  if (itemsError) {
    console.error("Error deleting quote items (service):", itemsError);
    return { error: itemsError };
  }

  // 2. Eliminem el pressupost
  const { error: quoteError } = await supabase
    .from("quotes")
    .delete()
    .eq("id", quoteId);

  if (quoteError) {
    console.error("Error deleting quote (service):", quoteError);
    return { error: quoteError };
  }

  // Ãˆxit
  return { error: null };
}

// =================== FILE: src/lib/services/finances/suppliers/suppliers.service.ts ===================

// src/lib/services/finances/suppliers/suppliers.service.ts (FITXER NOU)
import { type SupabaseClient } from '@supabase/supabase-js';
import { type Database, type Tables } from '@/types/supabase';
import { type ActionResult } from "@/types/shared/actionResult";
import { 
  type PaginatedActionParams, 
  type PaginatedResponse 
} from '@/hooks/usePaginateResource';
import { notFound } from 'next/navigation';

// --- Tipus PÃºblics del Servei ---

export type Supplier = Tables<'suppliers'>;
export type SupplierFormData = Omit<Supplier, 'id' | 'created_at' | 'user_id' | 'team_id'>;

// Filtres per a la pÃ gina
export type SupplierPageFilters = object;

// Tipus per al hook de paginaciÃ³
type FetchSuppliersParams = PaginatedActionParams<SupplierPageFilters>;
export type PaginatedSuppliersData = PaginatedResponse<Supplier>;

// ---
// âš™ï¸ FUNCIONS DE LECTURA (LLISTA)
// ---

/**
 * SERVEI: ObtÃ© proveÃ¯dors paginats.
 */
/**
 * SERVEI: ObtÃ© proveÃ¯dors paginats.
 */
export async function getPaginatedSuppliers(
  supabase: SupabaseClient<Database>,
  teamId: string,
  params: FetchSuppliersParams
): Promise<PaginatedSuppliersData> {
  const { searchTerm, sortBy, sortOrder, limit, offset } = params;

  let query = supabase
    .from('suppliers')
    .select('*', { count: 'exact' })
    .eq('team_id', teamId)
    .order(sortBy || 'nom', { ascending: sortOrder === 'asc' })
    .range(offset, offset + limit - 1);

  if (searchTerm) {
    query = query.or(`nom.ilike.%${searchTerm}%,nif.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);
  }

  const { data, error, count } = await query;

  if (error) {
    console.error("Error fetching paginated suppliers (service):", error);
    return { data: [], count: 0 };
  }

  return {
    data: data || [],
    count: count ?? 0
  };
}

/**
 * SERVEI: ObtÃ© la llista completa de proveÃ¯dors (per a selectors).
 */
export async function fetchSuppliers(
  supabase: SupabaseClient<Database>,
  teamId: string
): Promise<Pick<Supplier, 'id' | 'nom'>[]> {
  const { data, error } = await supabase
    .from('suppliers')
    .select('id, nom')
    .eq('team_id', teamId) // âœ… Afegim filtre de teamId
    .order('nom', { ascending: true });
    
  if (error) {
    console.error("Error fetching suppliers list (service):", error.message);
    return [];
  }
  return data || [];
}

/**
 * SERVEI: Cerca proveÃ¯dors per nom per al combobox asÃ­ncron.
 */
export async function searchSuppliers(
  supabase: SupabaseClient<Database>,
  teamId: string,
  searchTerm: string
): Promise<Pick<Supplier, 'id' | 'nom'>[]> {
  let query = supabase
    .from('suppliers')
    .select('id, nom')
    .eq('team_id', teamId) // âœ… Afegim filtre de teamId
    .order('nom', { ascending: true })
    .limit(20);
    
  if (searchTerm) query = query.ilike('nom', `%${searchTerm}%`);
  
  const { data, error } = await query;
  if (error) { 
    console.error("Error searching suppliers (service):", error.message); 
    return []; 
  }
  return data || [];
}

/**
 * SERVEI: ObtÃ© el detall d'un Ãºnic proveÃ¯dor.
 */
export async function fetchSupplierDetail(
  supabase: SupabaseClient<Database>,
  teamId: string,
  id: string
): Promise<Supplier> {
  const { data, error } = await supabase
    .from('suppliers')
    .select('*')
    .eq('id', id)
    .eq('team_id', teamId)
    .single();

  if (error) {
    console.error("Error fetching supplier detail (service):", error.message);
    notFound(); // LlanÃ§a un 404 si hi ha error o no es troba
  }
  return data;
}

// ---
// âš™ï¸ FUNCIONS DE MUTACIÃ“ (CRUD)
// ---

/**
 * SERVEI: Desa (crea o actualitza) un proveÃ¯dor.
 */
export async function saveSupplier(
  supabase: SupabaseClient<Database>,
  userId: string,
  teamId: string,
  formData: SupplierFormData,
  supplierId: string | null
): Promise<ActionResult<Supplier>> {
  const isNew = supplierId === null || supplierId === 'new';

  try {
    if (isNew) {
      const { data, error } = await supabase
        .from('suppliers')
        .insert({ ...formData, user_id: userId, team_id: teamId })
        .select()
        .single();
      if (error) throw error;
      return { success: true, message: "ProveÃ¯dor creat amb Ã¨xit.", data: data as Supplier };
    } else {
      const { data, error } = await supabase
        .from('suppliers')
        .update(formData)
        .eq('id', supplierId)
        .eq('team_id', teamId)
        .select()
        .single();
      if (error) throw error;
      return { success: true, message: "ProveÃ¯dor actualitzat amb Ã¨xit.", data: data as Supplier };
    }
  } catch (e) {
    const error = e as Error;
    console.error("Unexpected error saving supplier (service):", error);
    return { success: false, message: `Un error inesperat ha ocorregut: ${error.message}` };
  }
}

/**
 * SERVEI: Esborra un proveÃ¯dor.
 */
export async function deleteSupplier(
  supabase: SupabaseClient<Database>,
  teamId: string,
  supplierId: string
): Promise<ActionResult> {
  // 1. Comprovem si hi ha despeses associades
  const { count: expenseCount, error: expenseError } = await supabase
    .from('expenses')
    .select('id', { count: 'exact', head: true })
    .eq('supplier_id', supplierId)
    .eq('team_id', teamId);

  if (expenseError) {
    console.error("Error checking related expenses (service):", expenseError);
    return { success: false, message: "Error en comprovar despeses relacionades." };
  }

  if (expenseCount && expenseCount > 0) {
    return { success: false, message: `No es pot eliminar. Hi ha ${expenseCount} despesa(es) associada(es).` };
  }

  // 2. Si no hi ha despeses, procedim a eliminar
  const { error: deleteError } = await supabase
    .from('suppliers')
    .delete()
    .eq('id', supplierId)
    .eq('team_id', teamId);

  if (deleteError) {
    console.error("Error deleting supplier (service):", deleteError);
    return { success: false, message: `Error esborrant proveÃ¯dor: ${deleteError.message}` };
  }

  return { success: true, message: "ProveÃ¯dor esborrat amb Ã¨xit." };
}

// =================== FILE: src/lib/services/network/network.service.ts ===================

// src/lib/services/network/network.service.ts (FITXER NOU)
import { type SupabaseClient } from '@supabase/supabase-js';
import { type Database } from '@/types/supabase';
import type { PublicProfileDetail, PublicJobPostingDetail } from '@/app/[locale]/(app)/network/types'; // Importem els tipus de vista
import type { CreateJobPostingData } from '@/app/[locale]/(app)/network/schemas'; // Importem el tipus del schema

/**
 * SERVEI: ObtÃ© les dades detallades d'un sol equip (perfil professional).
 */
export async function getTeamDetails(
  supabase: SupabaseClient<Database>,
  teamId: string
): Promise<PublicProfileDetail> {
  const { data: teamData, error: teamError } = await supabase
    .from('teams')
    .select('*')
    .eq('id', teamId)
    .single();

  if (teamError || !teamData) {
    throw new Error("No s'ha pogut trobar l'equip especificat.");
  }

  let ownerData = null;
  if (teamData.owner_id) {
    const { data: profileData, error: profileError } = await supabase
      .from('profiles')
      .select('full_name')
      .eq('id', teamData.owner_id)
      .single();

    if (profileError) {
      console.warn(`No s'ha trobat el perfil per a l'owner_id ${teamData.owner_id}:`, profileError.message);
    } else {
      ownerData = { full_name: profileData.full_name };
    }
  }

  const detailedProfile: PublicProfileDetail = {
    ...teamData,
    services: Array.isArray(teamData.services)
      ? teamData.services as string[]
      : typeof teamData.services === 'string'
        ? [teamData.services]
        : null,
    owner: ownerData,
  };

  return detailedProfile;
}

/**
 * SERVEI: ObtÃ© les dades detallades d'un sol projecte (job_posting).
 */
export async function getJobPostingDetails(
  supabase: SupabaseClient<Database>,
  jobId: string
): Promise<PublicJobPostingDetail> {
  const { data: jobData, error: jobError } = await supabase
    .from('job_postings')
    .select(`
      *,
      teams (
        name,
        logo_url
      )
    `)
    .eq('id', jobId)
    .single();

  if (jobError || !jobData) {
    console.error("Error getJobPostingDetails (service):", jobError);
    throw new Error("No s'ha pogut trobar el projecte especificat.");
  }
  
  return jobData as PublicJobPostingDetail;
}

/**
 * SERVEI: Crea un nou 'job_posting'.
 */
export async function createJobPosting(
  supabase: SupabaseClient<Database>,
  validatedData: CreateJobPostingData // Rep les dades ja validades
) {
  const { data, error } = await supabase
    .from('job_postings')
    .insert(validatedData)
    .select()
    .single();

  if (error) {
    console.error("Error d'inserciÃ³ a Supabase (service):", error.message);
    throw new Error("No s'ha pogut publicar el projecte. Assegura't que tens permisos.");
  }

  return data;
}

// =================== FILE: src/lib/services/onboarding/onboarding.service.ts ===================

"use server";

import { type SupabaseClient, type User } from '@supabase/supabase-js';
import { type Database } from '@/types/supabase';
import { OnboardingSchema, type OnboardingFormData } from './schema';

// ğŸ”¹ Tipus auxiliars
type AvailableService = { id: number; name: string };

export type OnboardingData = {
  onboardingCompleted: boolean;
  availableServices: AvailableService[];
  initialFullName: string;
};

export type FormState = {
  success: boolean;
  message: string;
};

// ---
// 1ï¸âƒ£ FUNCIÃ“ DE LECTURA DE DADES
// ---
export async function getOnboardingData(
  supabase: SupabaseClient<Database>,
  user: User
): Promise<OnboardingData> {
  const [profileRes, servicesRes] = await Promise.all([
    supabase.from('profiles').select('onboarding_completed').eq('id', user.id).single(),
    supabase.from('services').select('id, name').order('name')
  ]);

  if (servicesRes.error) {
    console.error("Error al carregar els serveis:", servicesRes.error);
  }

  return {
    onboardingCompleted: profileRes.data?.onboarding_completed || false,
    availableServices: servicesRes.data || [],
    initialFullName: user.user_metadata?.full_name || ''
  };
}

// ---
// 2ï¸âƒ£ FUNCIÃ“ DE MUTACIÃ“ (RPC)
// ---
export async function submitOnboarding(
  supabase: SupabaseClient<Database>,
  user: User,
  formData: OnboardingFormData
): Promise<FormState> {

  // ValidaciÃ³ amb Zod
  const validationResult = OnboardingSchema.safeParse(formData);
  if (!validationResult.success) {
    return { success: false, message: validationResult.error.issues[0].message };
  }

  const validData = validationResult.data;

  // ParÃ metres per a la RPC
  const rpcParams = {
    p_user_id: user.id,
    p_full_name: validData.full_name,
    p_email: user.email!,
    p_company_name: validData.company_name,
    p_tax_id: validData.tax_id ?? '',
    p_website: validData.website ?? '',
    p_summary: validData.summary ?? '',
    p_sector: validData.sector ?? '',
    p_services: validData.services,
    p_phone: validData.phone ?? '',
    p_street: validData.street,
    p_city: validData.city,
    p_postal_code: validData.postal_code,
    p_region: validData.region,
    p_country: validData.country,
    p_latitude: validData.latitude !== undefined ? validData.latitude : undefined,
    p_longitude: validData.longitude !== undefined ? validData.longitude : undefined,
  };

  try {
    const { error } = await supabase.rpc('handle_onboarding', rpcParams);
    if (error) throw error;

    return { success: true, message: "Onboarding completat!" };
  } catch (error) {
    const message = error instanceof Error ? error.message : "Hi ha hagut un error desconegut.";
    console.error("Error durant la RPC d'Onboarding:", message);
    return { success: false, message: "No s'ha pogut completar el registre. Intenta-ho de nou." };
  }
}


// =================== FILE: src/lib/services/onboarding/schema.ts ===================

import { z } from 'zod';

export const OnboardingSchema = z.object({
  full_name: z.string().min(3, "El nom complet Ã©s obligatori."),
  company_name: z.string().min(2, "El nom de l'empresa Ã©s obligatori."),
  tax_id: z.string().optional(),
  website: z.string().url("Introdueix una URL vÃ lida.").optional().or(z.literal('')),
  summary: z.string().optional(),
  sector: z.string().optional(),
  services: z.array(z.string()).min(1, "Has de seleccionar almenys un servei."),
  phone: z.string().optional(),
  street: z.string().min(1, "El carrer Ã©s obligatori."),
  city: z.string().min(1, "La ciutat Ã©s obligatÃ²ria."),
  postal_code: z.string().min(1, "El codi postal Ã©s obligatori."),
  region: z.string().min(1, "La regiÃ³ Ã©s obligatÃ²ria."),
  country: z.string().min(1, "El paÃ­s Ã©s obligatori."),
  latitude: z.number().optional(),
  longitude: z.number().optional(),
});

export type OnboardingFormData = z.infer<typeof OnboardingSchema>;


// =================== FILE: src/lib/services/publicQuote/public-quote.service.ts ===================

// src/lib/services/public-quote.service.ts (FITXER NOU I COMPLET)
"use server";

import { createAdminClient } from "@/lib/supabase/server";
import { z } from 'zod';
import type { QuoteDataFromServer } from '@/types/finances/quotes';
import { type Database } from '@/types/supabase';

// --- Tipus de Retorn ---
export type FormState = { success: boolean; message: string; };

// --- Esquemes de ValidaciÃ³ (Moguts des de 'actions.ts') ---
const AcceptQuoteSchema = z.string().uuid("L'identificador del pressupost Ã©s invÃ lid.");
const RejectQuoteSchema = z.object({
  secureId: z.string().uuid("L'identificador del pressupost Ã©s invÃ lid."),
  reason: z.string().min(10, "El motiu del rebuig ha de tenir almenys 10 carÃ cters.").max(500, "El motiu Ã©s massa llarg."),
});

// Tipus interns per a la consulta
type QuoteWithRelations = Database['public']['Tables']['quotes']['Row'] & {
  contacts: Database['public']['Tables']['contacts']['Row'] | null;
  team: Database['public']['Tables']['teams']['Row'] | null;
};

// ---
// âš™ï¸ FUNCIÃ“ DE LECTURA (LÃ²gica de 'getQuoteDataBySecureId')
// ---
export async function getPublicQuoteData(secureId: string): Promise<QuoteDataFromServer | null> {
  // Aquesta pÃ gina Ã©s pÃºblica, per tant fem servir Admin per bypassar RLS
  const supabaseAdmin = createAdminClient();

  const { data: quoteData, error: quoteError } = await supabaseAdmin
    .from("quotes")
    .select("*, contacts (*), team:teams (*)")
    .eq("secure_id", secureId)
    .single<QuoteWithRelations>();

  if (quoteError || !quoteData) {
    console.error("Error carregant dades del pressupost (Pas 1):", quoteError?.message || "Dades no trobades");
    return null;
  }
  
  const { data: itemsData, error: itemsError } = await supabaseAdmin
    .from("quote_items")
    .select("*")
    .eq("quote_id", quoteData.id);

  if (itemsError) {
    console.error("Pressupost trobat, perÃ² error en carregar items (Pas 2):", itemsError.message);
  }

  // Combinem les dades i solucionem el 'type casting'
  const fullData = {
    ...quoteData,
    items: itemsData || [] 
  };

  return fullData as unknown as QuoteDataFromServer; // Aquest 'unknown' Ã©s necessari per la diferÃ¨ncia de tipus
}

// ---
// âš™ï¸ FUNCIONS DE MUTACIÃ“ (LÃ²gica de 'actions.ts')
// ---

export async function acceptQuote(secureId: string): Promise<FormState> {
  const validation = AcceptQuoteSchema.safeParse(secureId);
  if (!validation.success) {
    return { success: false, message: validation.error.issues[0].message };
  }

  const supabaseAdmin = createAdminClient();

  try {
    // âœ… CRIDA ÃšNICA I TRANSACCIONAL
    const { error } = await supabaseAdmin.rpc('accept_quote_and_create_invoice', {
      p_secure_id: secureId
    });
    if (error) throw error;
    
    return { success: true, message: "Pressupost acceptat i esborrany de factura creat correctament." };
  } catch (error: unknown) {
    const message = error instanceof Error ? error.message : "Error desconegut en processar l'acceptaciÃ³.";
    console.error("[acceptQuote Service] Error:", message);
    return { success: false, message };
  }
}

export async function rejectQuote(secureId: string, reason: string): Promise<FormState> {
  const validation = RejectQuoteSchema.safeParse({ secureId, reason });
  if (!validation.success) {
    return { success: false, message: validation.error.issues[0].message };
  }
  
  const supabaseAdmin = createAdminClient();

  try {
    // âœ… CRIDA ÃšNICA I TRANSACCIONAL
    const { error } = await supabaseAdmin.rpc('reject_quote_with_reason', {
      p_secure_id: secureId,
      p_reason: reason
    });
    if (error) throw error;

    return { success: true, message: "El rebuig s'ha processat correctament." };
  } catch (error: unknown) {
    const message = error instanceof Error ? error.message : "Error desconegut";
    return { success: false, message };
  }
}

// =================== FILE: src/lib/services/settings/billing/billing.service.ts ===================

// src/lib/services/settings/billing.service.ts (FITXER CORREGIT I COMPLET)
"use server";

import { type SupabaseClient } from '@supabase/supabase-js';
import { type Database, type Tables } from '@/types/supabase';
import { type User } from '@supabase/supabase-js';
import { createAdminClient } from "@/lib/supabase/admin";

// Importem el tipus de domini MANUAL (el correcte) per a Subscription
import type { Subscription as DomainSubscription } from '@/types/settings';

// âœ… 1. Importem el tipus 'Role' (el correcte) des dels permisos
// Aquest Ã©s el tipus que el 'BillingClient.tsx' espera.
import type { Role } from '@/lib/permissions/permissions.config';

// --- Tipus PÃºblics del Servei ---

export type Subscription = DomainSubscription;

// âœ… 2. Definim TeamMemberRole utilitzant el tipus 'Role' correcte, no el 'string' generat
export type TeamMemberRole = Role;

// El que espera 'useFormState' a les Server Actions
export type FormState = {
  success: boolean;
  message: string;
};

// El que necessita la pÃ gina (el Server Component)
export type BillingPageData = {
  activeSubscription: Subscription | null;
  currentUserRole: TeamMemberRole | null; // âœ… Ara utilitza el tipus Role correcte
};

// ---
// âš™ï¸ FUNCIONS DE LECTURA (per a la pÃ gina)
// ---

/**
 * SERVEI: ObtÃ© les dades de facturaciÃ³ per a la pÃ gina de settings.
 */
export async function getBillingPageData(
  supabase: SupabaseClient<Database>,
  userId: string,
  teamId: string
): Promise<BillingPageData> {
  
  const [subscriptionRes, memberRes] = await Promise.all([
    supabase.from('subscriptions').select('*').eq('team_id', teamId).maybeSingle(),
    supabase.from('team_members').select('role').eq('user_id', userId).eq('team_id', teamId).single()
  ]);

  if (subscriptionRes.error) {
    console.error("Error fetching subscription (service):", subscriptionRes.error);
  }
  if (memberRes.error) {
    console.error("Error fetching member role (service):", memberRes.error);
  }

  // AsserciÃ³ de tipus per a la subscripciÃ³ (de l'error anterior)
  const activeSubscription = subscriptionRes.data as Subscription | null; 
  
  // âœ… 3. Fem l'asserciÃ³ de tipus per a 'role'
  // Diem a TypeScript: "Confia, 'memberRes.data.role' (que tu creus string) 
  // Ã©s en realitat del tipus 'TeamMemberRole' (l'enum)".
  const currentUserRole = (memberRes.data?.role as TeamMemberRole) || null;

  // ... (El console.log de depuraciÃ³ es mantÃ© igual) ...
  console.log("\n--- DEPURACIÃ“ DE PERMISOS (billing.service.ts) ---");
  console.log("ID de l'usuari actual:", userId);
  console.log("ID de l'equip actiu:", teamId);
  console.log("Rol de l'usuari detectat:", currentUserRole);
  console.log("-------------------------------------------------\n");

  return { activeSubscription, currentUserRole };
}


// ---
// âš™ï¸ FUNCIONS DE MUTACIÃ“ (per a les Server Actions)
// ---

/**
 * SERVEI: Subscriu un equip a un pla.
 */
export async function subscribeToPlan(
  supabase: SupabaseClient<Database>,
  user: User,
  teamId: string,
  planId: string
): Promise<FormState> {
  
  // Aquesta funciÃ³ no retorna el rol, es mantÃ© igual que abans
  try {
    await supabase
      .from('subscriptions')
      .upsert({
        team_id: teamId,
        plan_id: planId,
        status: 'active',
        current_period_end: new Date(new Date().setMonth(new Date().getMonth() + 1)).toISOString(),
      }, { onConflict: 'team_id' })
      .throwOnError();

    const supabaseAdmin = createAdminClient();
    await supabaseAdmin.auth.admin.updateUserById(
      user.id,
      { app_metadata: { ...user.app_metadata, active_team_plan: planId } }
    );

  } catch (error) {
    const message = error instanceof Error ? error.message : "Error en subscriure's al pla.";
    console.error("Error subscribeToPlan (service):", message);
    return { success: false, message };
  }

  return { success: true, message: `SubscripciÃ³ al pla '${planId}' realitzada!` };
}

/**
 * SERVEI: CancelÂ·la una subscripciÃ³.
 */
export async function cancelSubscription(
  supabase: SupabaseClient<Database>,
  user: User,
  teamId: string
): Promise<FormState> {

  // 1. ComprovaciÃ³ de permisos (lÃ²gica de negoci)
  const { data: member } = await supabase
    .from('team_members')
    .select('role')
    .eq('user_id', user.id)
    .eq('team_id', teamId)
    .single();

  // âœ… 4. Afegim asserciÃ³ de tipus tambÃ© aquÃ­ per a la comprovaciÃ³
  const userRole = member?.role as TeamMemberRole | null;

  if (userRole !== 'owner') {
    return { success: false, message: "NomÃ©s el propietari de l'equip pot cancelÂ·lar la subscripciÃ³." };
  }

  // 2. ExecuciÃ³ de la lÃ²gica (es mantÃ© igual)
  try {
    await supabase
      .from('subscriptions')
      .update({ status: 'canceled', plan_id: 'free' })
      .eq('team_id', teamId)
      .throwOnError();

    const supabaseAdmin = createAdminClient();
    await supabaseAdmin.auth.admin.updateUserById(
      user.id,
      { app_metadata: { ...user.app_metadata, active_team_plan: 'free' } }
    );

  } catch (error) {
    const message = error instanceof Error ? error.message : "Error en cancelÂ·lar la subscripciÃ³.";
    console.error("Error cancelSubscription (service):", message);
    return { success: false, message };
  }

  return { success: true, message: "SubscripciÃ³ cancelÂ·lada." };
}

// =================== FILE: src/lib/services/settings/blacklist/blacklist.service.ts ===================

// src/lib/services/settings/blacklist.service.ts (FITXER NOU I COMPLET)
"use server";

import { type SupabaseClient, type User } from '@supabase/supabase-js';
import { type Database, type Tables } from '@/types/supabase';
import { hasPermission, PERMISSIONS, type Role } from '@/lib/permissions/permissions.config';
import type { BlacklistRule } from '@/types/settings';

// --- Tipus PÃºblics del Servei ---

// El que espera 'useFormState' a les Server Actions
export type FormState = {
  success: boolean;
  message: string;
};

// ---
// âš™ï¸ FUNCIONS DE LECTURA (per a la pÃ gina)
// ---

/**
 * SERVEI: ObtÃ© les regles de la blacklist per a l'equip actiu.
 * S'encarrega de filtrar per equip i transformar les dades.
 */
export async function getBlacklistRules(
  supabase: SupabaseClient<Database>,
  teamId: string
): Promise<BlacklistRule[]> {
  
  const { data: rulesFromDb, error } = await supabase
    .from('blacklist_rules')
    .select('*')
    .eq('team_id', teamId) // âœ… SEGURETAT: Assegurem filtrar per equip
    .order('created_at', { ascending: false });

  if (error) {
    console.error("Error en carregar les regles de la blacklist (service):", error.message);
    return [];
  }

  // âœ… LÃ²gica de transformaciÃ³ moguda del component al servei
  const formattedRules: BlacklistRule[] = (rulesFromDb || [])
    // 1. Filtrem (tot i que el 'eq' ja ho hauria d'haver fet)
    .filter(rule => !!rule.team_id) 
    // 2. Transformem tipus
    .map(rule => ({
      ...rule,
      id: String(rule.id), // Converteix id: number -> string (si fos necessari)
      team_id: rule.team_id as string, // Assegurem el tipus
      rule_type: rule.rule_type as 'domain' | 'email', // Assegurem l'ENUM
    }));
  
  return formattedRules;
}

// FunciÃ³ helper interna per obtenir rol (evita duplicaciÃ³)
async function getUserRole(
  supabase: SupabaseClient<Database>,
  userId: string,
  teamId: string
): Promise<Role | null> {
  const { data: member } = await supabase
    .from('team_members')
    .select('role')
    .eq('user_id', userId)
    .eq('team_id', teamId)
    .single();
  
  return (member?.role as Role) || null;
}

// ---
// âš™ï¸ FUNCIONS DE MUTACIÃ“ (per a les Server Actions)
// ---

/**
 * SERVEI: Afegeix una nova regla de blacklist.
 * Inclou comprovaciÃ³ de permisos i validaciÃ³ de dades.
 */
export async function addRule(
  supabase: SupabaseClient<Database>,
  user: User,
  teamId: string,
  formData: FormData
): Promise<FormState> {
  
  // 1. ComprovaciÃ³ de permisos
  const userRole = await getUserRole(supabase, user.id, teamId);
  if (!hasPermission(userRole, PERMISSIONS.MANAGE_BLACKLIST)) {
    return { success: false, message: "No tens permisos per a gestionar la llista negra." };
  }

  // 2. ValidaciÃ³ i LÃ²gica de Negoci
  const newRule = formData.get('newRule') as string;
  if (!newRule || !newRule.trim()) {
    return { success: false, message: "La regla no pot estar buida." };
  }

  const value = newRule.trim().toLowerCase();
  const rule_type = value.includes('@') ? 'email' : 'domain';

  // 3. AccÃ©s a Dades
  const { error } = await supabase.from('blacklist_rules').insert({
    user_id: user.id,
    team_id: teamId,
    value,
    rule_type
  });

  if (error) {
    console.error('Error afegint regla de blacklist (service):', error);
    return { success: false, message: "No s'ha pogut afegir la regla. Potser ja existeix." };
  }

  return { success: true, message: "Regla afegida correctament." };
}

/**
 * SERVEI: Elimina una regla de la blacklist.
 * Inclou comprovaciÃ³ de permisos.
 */
export async function deleteRule(
  supabase: SupabaseClient<Database>,
  user: User,
  teamId: string,
  id: string
): Promise<FormState> {

  // 1. ComprovaciÃ³ de permisos
  const userRole = await getUserRole(supabase, user.id, teamId);
  if (!hasPermission(userRole, PERMISSIONS.MANAGE_BLACKLIST)) {
    return { success: false, message: "No tens permisos per a gestionar la llista negra." };
  }

  // 2. AccÃ©s a Dades
  // L'RLS s'encarregarÃ  de la seguretat a nivell de fila, 
  // perÃ² el permÃ­s d'usuari Ã©s una bona primera barrera.
  const numericId = Number(id);
  const { error } = await supabase.from('blacklist_rules').delete().eq('id', numericId);

  if (error) {
    console.error('Error eliminant regla de blacklist (service):', error);
    return { success: false, message: "No s'ha pogut eliminar la regla." };
  }

  return { success: true, message: "Regla eliminada correctament." };
}

// =================== FILE: src/lib/services/settings/integrations/integrations.service.ts ===================

// src/lib/services/settings/integrations.service.ts (FITXER NOU I COMPLET)
"use server";

import { type SupabaseClient, type User } from '@supabase/supabase-js';
import { type Database } from '@/types/supabase';
import { type TransportOptions } from 'nodemailer';
import nodemailer from 'nodemailer';
import imaps from 'imap-simple';
import AES from 'crypto-js/aes';

import { ImapSmtpSchema, type ImapSmtpFormData } from '@/app/[locale]/(app)/settings/integrations/schemas';

// --- Tipus PÃºblics del Servei ---

// El que espera 'IntegrationsClient'
export type ConnectionStatuses = {
  google_gmail: boolean;
  google_calendar: boolean;
  microsoft: boolean;
  linkedin: boolean;
  facebook: boolean;
  instagram: boolean;
  custom_email: boolean;
};

// El que espera 'useFormState' per a IMAP
export type ImapFormState = {
  success: boolean;
  message: string;
  errors?: Record<string, string[]>;
};

// El que esperen les accions de desconnexiÃ³
export type DisconnectFormState = {
  success: boolean;
  message: string;
};

// ---
// âš™ï¸ FUNCIONS DE LECTURA (per a la pÃ gina)
// ---

/**
 * SERVEI: ObtÃ© l'estat de totes les connexions per a l'usuari i equip actius.
 * (Aquesta lÃ²gica estava abans a 'IntegrationsData.tsx')
 */
export async function getIntegrationStatuses(
  supabase: SupabaseClient<Database>,
  userId: string,
  teamId: string
): Promise<ConnectionStatuses> {

  const [userCredsRes, teamCredsRes] = await Promise.all([
    supabase.from('user_credentials').select('provider').eq('user_id', userId),
    supabase.from('team_credentials').select('provider').eq('team_id', teamId)
  ]);

  const userProviders = userCredsRes.data?.map(c => c.provider) || [];
  const teamProviders = teamCredsRes.data?.map(c => c.provider) || [];

  const allConnectedProviders = new Set([...userProviders, ...teamProviders]);

  return {
    google_gmail: allConnectedProviders.has('google_gmail'),
    google_calendar: allConnectedProviders.has('google_calendar'),
    microsoft: allConnectedProviders.has('microsoft'),
    linkedin: allConnectedProviders.has('linkedin'),
    facebook: allConnectedProviders.has('facebook'),
    instagram: allConnectedProviders.has('instagram'),
    custom_email: allConnectedProviders.has('custom_email'),
  };
}

// ---
// âš™ï¸ FUNCIONS DE MUTACIÃ“ (per a les Server Actions)
// ---

// --- LÃ²gica IMAP/SMTP ---

type ImapConfig = {
  imap: {
    user: string;
    password: string;
    host: string;
    port: number;
    tls: boolean;
    authTimeout: number;
    tlsOptions?: {
      rejectUnauthorized?: boolean;
    };
  }
}

async function verifyImap(config: ImapConfig): Promise<void> {
  let connection;
  try {
    connection = await imaps.connect(config);
    await connection.end();
  } catch (err) {
    throw new Error(`Error de connexiÃ³ IMAP: ${(err as Error).message}`);
  }
}

async function verifySmtp(config: TransportOptions): Promise<void> {
  const transporter = nodemailer.createTransport(config);
  try {
    await transporter.verify();
  } catch (err) {
    throw new Error(`Error de connexiÃ³ SMTP: ${(err as Error).message}`);
  }
}

/**
 * SERVEI: Connecta un compte IMAP/SMTP personalitzat.
 * Inclou validaciÃ³, verificaciÃ³ de connexiÃ³, encriptaciÃ³ i desat a BBDD.
 */
export async function connectImapSmtp(
  supabase: SupabaseClient<Database>,
  user: User,
  formData: ImapSmtpFormData
): Promise<ImapFormState> {

  // 1. ValidaciÃ³ Zod
  const validation = ImapSmtpSchema.safeParse(formData);
  if (!validation.success) {
    return { success: false, message: "Dades del formulari invÃ lides.", errors: validation.error.flatten().fieldErrors };
  }
  const { email, password, imapHost, imapPort, smtpHost, smtpPort } = validation.data;

  // 2. LÃ²gica de VerificaciÃ³
  const imapConfig: ImapConfig = { imap: { user: email, password: password, host: imapHost, port: imapPort, tls: true, authTimeout: 5000, tlsOptions: { rejectUnauthorized: false } } };
  const smtpConfig = { host: smtpHost, port: smtpPort, secure: smtpPort === 465, auth: { user: email, pass: password }, tls: { rejectUnauthorized: false } };

  try {
    await Promise.all([
      verifyImap(imapConfig),
      verifySmtp(smtpConfig as TransportOptions) 
    ]);
  } catch (error) {
    return { success: false, message: `No s'ha pogut verificar la connexiÃ³: ${(error as Error).message}` };
  }
  
  // 3. LÃ²gica de Criptografia i Emmagatzematge
  try {
    const secretKey = process.env.ENCRYPTION_SECRET_KEY;
    if (!secretKey) {
      throw new Error("La clau d'encriptaciÃ³ no estÃ  configurada al servidor.");
    }

    const encryptedPassword = AES.encrypt(password, secretKey).toString();
    
    // Guardem nomÃ©s la configuraciÃ³, no la contrasenya en text pla
    const configPayload = {
      imap: { user: imapConfig.imap.user, host: imapConfig.imap.host, port: imapConfig.imap.port, tls: imapConfig.imap.tls, authTimeout: imapConfig.imap.authTimeout, },
      smtp: { host: smtpConfig.host, port: smtpConfig.port, secure: smtpConfig.secure, auth: { user: smtpConfig.auth.user, }, },
    };
    
    const { error: dbError } = await supabase.from('user_credentials').upsert({ 
      user_id: user.id, 
      provider: 'custom_email', 
      config: configPayload, 
      encrypted_password: encryptedPassword,
      access_token: null, 
      refresh_token: null, 
      expires_at: null, 
    }, { onConflict: 'user_id, provider' });
    
    if (dbError) throw dbError;
    
    return { success: true, message: "Compte de correu connectat correctament!" };

  } catch (error) {
    console.error("Error en connectImapSmtp (service):", error);
    const errorMessage = error instanceof Error ? error.message : "Error desconegut";
    return { success: false, message: `Error en el procÃ©s de connexiÃ³: ${errorMessage}` };
  }
}

/**
 * SERVEI: Desconnecta una integraciÃ³ per a l'usuari o equip.
 */
export async function disconnectIntegration(
  supabase: SupabaseClient<Database>,
  user: User,
  activeTeamId: string,
  provider: string
): Promise<DisconnectFormState> {
  try {
    const isTeamIntegration = ['linkedin', 'facebook', 'instagram'].includes(provider);
    let query;

    if (isTeamIntegration) {
      query = supabase.from('team_credentials').delete().match({ team_id: activeTeamId, provider });
    } else {
      query = supabase.from('user_credentials').delete().match({ user_id: user.id, provider });
    }

    const { error } = await query;
    if (error) throw error;

    return { success: true, message: `IntegraciÃ³ desconnectada correctament.` };
  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : "Error desconegut";
    return { success: false, message: `No s'ha pogut desconnectar: ${errorMessage}` };
  }
}

// =================== FILE: src/lib/services/settings/permissions/permissions.service.ts ===================

// src/lib/services/settings/permissions.service.ts (FITXER NOU I COMPLET)
"use server";

import { type SupabaseClient, type User } from '@supabase/supabase-js';
import { type Database } from '@/types/supabase';
import type { Role } from '@/lib/permissions/permissions.config'; // Assegurem que el tipus Role existeix

// --- Tipus PÃºblics del Servei ---

export type Member = { 
  id: string; 
  full_name: string | null; 
  email: string | null; 
};

export type Permission = { 
  grantee_user_id: string; // Qui rep el permÃ­s
  target_user_id: string;  // De qui veurÃ  els correus
};

// Dades que la pÃ gina necessita
export type PermissionsPageData = {
  teamMembers: Member[];
  initialPermissions: Permission[];
};

// Retorn de l'acciÃ³
export type FormState = {
  success: boolean;
  message: string;
};

// ---
// âš™ï¸ FUNCIONS DE LECTURA (per a la pÃ gina)
// ---

/**
 * SERVEI: ObtÃ© les dades per a la pÃ gina de permisos (membres i permisos).
 * (LÃ²gica extreta de 'page.tsx')
 */
export async function getPermissionsPageData(
  supabase: SupabaseClient<Database>,
  teamId: string
): Promise<PermissionsPageData> {

  const [membersRes, permissionsRes] = await Promise.all([
    supabase.from('team_members').select('profiles(id, full_name, email)').eq('team_id', teamId),
    supabase.from('inbox_permissions').select('grantee_user_id, target_user_id').eq('team_id', teamId)
  ]);

  const teamMembers: Member[] = membersRes.data
    ?.map(m => m.profiles)
    .filter(Boolean) as unknown as Member[] || [];
    
  const initialPermissions: Permission[] = permissionsRes.data || [];

  return { teamMembers, initialPermissions };
}

// ---
// âš™ï¸ FUNCIONS DE MUTACIÃ“ (per a les Server Actions)
// ---

/**
 * SERVEI: Actualitza tots els permisos d'inbox per a l'equip.
 * Inclou comprovaciÃ³ de permisos i lÃ²gica de BBDD.
 * (LÃ²gica extreta de 'updateInboxPermissionsAction')
 */
export async function updateInboxPermissions(
  supabase: SupabaseClient<Database>,
  user: User,
  teamId: string,
  permissions: Permission[]
): Promise<FormState> {
  
  // 1. ComprovaciÃ³ de permisos (LÃ²gica de negoci)
  const { data: member } = await supabase
    .from('team_members')
    .select('role')
    .eq('user_id', user.id)
    .eq('team_id', teamId)
    .single();

  if (!['owner', 'admin'].includes(member?.role || '')) {
    return { success: false, message: "No tens permisos per a gestionar els permisos de l'inbox." };
  }
  
  // 2. LÃ²gica d'accÃ©s a dades
  try {
    // EstratÃ¨gia "esborrar i tornar a crear"
    await supabase.from('inbox_permissions').delete().eq('team_id', teamId);

    if (permissions.length > 0) {
      const permissionsToInsert = permissions.map(p => ({ ...p, team_id: teamId }));
      await supabase.from('inbox_permissions').insert(permissionsToInsert).throwOnError();
    }

    return { success: true, message: "Permisos actualitzats correctament." };
  } catch (error) {
    const message = error instanceof Error ? error.message : "Error desconegut en desar els permisos.";
    return { success: false, message };
  }
}

// =================== FILE: src/lib/services/settings/profile/profile.service.ts ===================

// src/lib/services/settings/profile.service.ts (FITXER NOU I COMPLET)
"use server";

import { type SupabaseClient, type User } from '@supabase/supabase-js';
import { type Database } from '@/types/supabase';
import { z } from 'zod';
import { hasPermission, PERMISSIONS, type Role } from '@/lib/permissions/permissions.config';
import { getActiveTeam } from '@/lib/supabase/teams';
// âœ… Importem els tipus de domini
import type { Profile, Team } from "@/types/settings";

// --- Tipus PÃºblics del Servei ---

// Dades que la pÃ gina necessita
export type ProfilePageData = {
  profile: Profile | null; // âœ… El servei SÃ pot retornar null
  team: Team | null;
  role: Role | null;
};

// Retorn de les accions de formulari
export type FormState = {
  success: boolean;
  message: string;
  errors?: Record<string, string[]>; 
};

// --- ValidaciÃ³ Zod (moguda des de 'actions.ts') ---
const TeamSchema = z.object({
  name: z.string().min(1, "El nom de l'empresa Ã©s obligatori."),
  tax_id: z.string().optional().nullable(),
  // âœ… Adrecem els camps del formulari al servei
  street: z.string().optional().nullable(),
  city: z.string().optional().nullable(),
  postal_code: z.string().optional().nullable(),
  country: z.string().optional().nullable(),
  company_phone: z.string().optional().nullable(),
  company_email: z.string().email("L'email de l'empresa no Ã©s vÃ lid.").optional().or(z.literal('')),
  website: z.string().url("L'URL de la web no Ã©s vÃ lida.").optional().or(z.literal('')),
  summary: z.string().optional().nullable(),
  sector: z.string().optional().nullable(),
  logo_url: z.string().optional().nullable(),
});

// ---
// âš™ï¸ FUNCIONS DE LECTURA (per a la pÃ gina)
// ---

/**
 * SERVEI: ObtÃ© les dades per a la pÃ gina de perfil.
 * (LÃ²gica extreta de 'ProfileData.tsx')
 */
export async function getProfilePageData(
  supabase: SupabaseClient<Database>,
  user: User,
  activeTeamId: string | null
): Promise<ProfilePageData> {

  const [profileRes, team, memberRes] = await Promise.all([
    supabase.from('profiles').select('*').eq('id', user.id).single(),
    activeTeamId ? getActiveTeam(supabase, activeTeamId) : Promise.resolve(null),
    activeTeamId ? supabase.from('team_members').select('role').eq('user_id', user.id).eq('team_id', activeTeamId).single() : Promise.resolve({ data: null })
  ]);
  
  const profile = profileRes.data as Profile | null;
  const role = memberRes?.data?.role as Role | null;

  return { profile, team: team as Team | null, role };
}

// ---
// âš™ï¸ FUNCIONS DE MUTACIÃ“ (per a les Server Actions)
// ---

/**
 * SERVEI: Actualitza les dades PERSONALS de l'usuari.
 * (LÃ²gica extreta de 'updateUserProfileAction')
 */
export async function updateUserProfile(
  supabase: SupabaseClient<Database>,
  user: User,
  formData: FormData
): Promise<FormState> {
  
  const profileData = {
    full_name: formData.get('full_name') as string,
    phone: formData.get('phone') as string,
    job_title: formData.get('job_title') as string,
  };

  const { error } = await supabase.from('profiles').update(profileData).eq('id', user.id);

  if (error) return { success: false, message: `Error en actualitzar el perfil: ${error.message}` };
  
  return { success: true, message: "Perfil personal actualitzat." };
}

/**
 * SERVEI: Actualitza les dades DE L'EMPRESA de l'equip actiu.
 * (LÃ²gica extreta de 'updateTeamAction')
 */
export async function updateTeamProfile(
  supabase: SupabaseClient<Database>,
  user: User,
  activeTeamId: string,
  formData: FormData
): Promise<FormState> {
  
  // 1. ComprovaciÃ³ de permisos
  const { data: member } = await supabase.from('team_members').select('role').eq('user_id', user.id).eq('team_id', activeTeamId).single();
  if (!hasPermission(member?.role as Role, PERMISSIONS.MANAGE_TEAM_PROFILE)) {
    return { success: false, message: "No tens permisos per a editar aquest equip." };
  }

  // 2. ValidaciÃ³ de dades amb Zod
  const rawData = Object.fromEntries(formData.entries());
  const validation = TeamSchema.safeParse(rawData);

  if (!validation.success) {
    return { 
      success: false, 
      message: "Hi ha errors en les dades del formulari.",
      errors: validation.error.flatten().fieldErrors
    };
  }
  
  // 3. TransformaciÃ³ de dades (mapeig de camps)
  const { company_email, company_phone, ...teamData } = validation.data;
  const finalTeamData = {
    ...teamData,
    email: company_email,
    phone: company_phone
  };

  // 4. AccÃ©s a BBDD
  const { error } = await supabase.from('teams').update(finalTeamData).eq('id', activeTeamId);

  if (error) return { success: false, message: `Error en actualitzar l'empresa: ${error.message}` };
  
  return { success: true, message: "Dades de l'empresa actualitzades." };
}

// =================== FILE: src/lib/services/settings/team/team.service.ts ===================

// src/lib/services/settings/team.service.ts (FITXER CORREGIT I COMPLET)
"use server";

import { type SupabaseClient, type User } from "@supabase/supabase-js";
import { type Database } from "@/types/supabase";
import { createAdminClient } from "@/lib/supabase/admin";
import { PERMISSIONS, type Role } from "@/lib/permissions/permissions";
import { Resend } from "resend";
// âœ… Importem el tipus que faltava per a getCompanyProfile
import type { CompanyProfile } from "@/types/settings/team";

// ---
// âœ… 1. DEFINICIÃ“ I EXPORTACIÃ“ DE TIPUS DE DOMINI
// Aquests tipus ara sÃ³n la font de veritat i s'importaran a 'page.tsx' i 'TeamData.tsx'.
// (Aquests sÃ³n els tipus que abans estaven a 'page.tsx')
// ---

export type Team = { id: string; name: string };
export type Invitation = { id: string; email: string; role: string };
export type TeamMember = {
  role: string;
  profiles: {
    id: string;
    full_name: string | null;
    email: string | null;
    avatar_url: string | null;
  } | null;
};
export type ActiveTeamData = {
  team: Team;
  teamMembers: TeamMember[];
  pendingInvitations: Invitation[];
  currentUserRole: string;
  inboxPermissions: { grantee_user_id: string; target_user_id: string }[];
};
export type UserTeam = {
  role: string;
  teams: { id: string; name: string } | null;
};
export type PersonalInvitation = {
  id: string;
  team_name: string;
  inviter_name: string;
};

// --- Tipus PÃºblics del Servei (Interns) ---
export type FormState = { success: boolean; message: string };
export type TeamHubData = {
  userTeams: UserTeam[];
  personalInvitations: PersonalInvitation[];
};
// âŒ Ja no necessitem: export type { ActiveTeamData, TeamMember, Invitation };
// perquÃ¨ ara s'exporten directament a dalt.

// ---
// âš™ï¸ FUNCIONS DE LECTURA (per a la pÃ gina)
// ---

/**
 * SERVEI: ObtÃ© les dades del "Lobby"
 */
export async function getTeamHubData(
  supabase: SupabaseClient<Database>,
  userId: string,
): Promise<TeamHubData> {
  const [teamsRes, invitesRes] = await Promise.all([
    supabase.from("team_members").select("role, teams(id, name)").eq(
      "user_id",
      userId,
    ),
    supabase.from("invitations")
      .select("id, team_name, inviter_name")
      .match({ user_id: userId, status: "pending" }),
  ]);

  // âœ… CORRECCIÃ“ 1 (de l'error anterior): Mapegem les invitacions per eliminar els 'null'
  const personalInvitations: PersonalInvitation[] = (invitesRes.data || []).map(
    (invite) => ({
      id: invite.id,
      team_name: invite.team_name || "Equip desconegut", // Valor per defecte
      inviter_name: invite.inviter_name || "AlgÃº", // Valor per defecte
    })
  );

  return {
    userTeams: (teamsRes.data as unknown as UserTeam[]) || [],
    personalInvitations: personalInvitations,
  };
}

/**
 * SERVEI: ObtÃ© les dades del panell de control d'un equip actiu.
 */
export async function getActiveTeamData(
  supabase: SupabaseClient<Database>,
  activeTeamId: string,
  currentUserId: string, // No el fem servir aquÃ­, perÃ² podria ser Ãºtil
  currentUserRole: string,
): Promise<ActiveTeamData> {
  const [teamRes, invitesRes, permissionsRes, membersRes] = await Promise.all([
    supabase.from("teams").select("id, name").eq("id", activeTeamId).single(),
    supabase.from("invitations").select("id, email, role").eq(
      "team_id",
      activeTeamId,
    ).eq("status", "pending"),
    supabase.from("inbox_permissions").select("grantee_user_id, target_user_id")
      .eq("team_id", activeTeamId),
    supabase.from("team_members_with_profiles").select("*").eq(
      "team_id",
      activeTeamId,
    ),
  ]);

  const finalTeamMembers: TeamMember[] = (membersRes.data || []).map((m) => ({
    role: m.role ?? "",
    profiles: m.user_id
      ? {
        id: m.user_id,
        full_name: m.full_name,
        email: m.email,
        avatar_url: m.avatar_url,
      }
      : null,
  }));

  return {
    team: teamRes.data as Team,
    teamMembers: finalTeamMembers,
    pendingInvitations: (invitesRes.data as Invitation[]) || [],
    currentUserRole: currentUserRole,
    inboxPermissions: permissionsRes.data || [],
  };
}

// ---
// âš™ï¸ FUNCIONS DE MUTACIÃ“ (per a les Server Actions)
// ---

/**
 * SERVEI: Crea un nou equip.
 */
export async function createTeam(
  supabase: SupabaseClient<Database>,
  teamName: string,
): Promise<FormState> {
  try {
    const { error } = await supabase.rpc("create_team_with_defaults", {
      team_name: teamName,
    });
    if (error) throw error;
    return { success: true, message: "Equip creat." };
  } catch (error: unknown) {
    console.error("Error en la transacciÃ³ de crear equip:", error);
    const msg = error instanceof Error
      ? error.message
      : "No s'ha pogut crear l'equip.";
    return { success: false, message: msg };
  }
}

/**
 * SERVEI: Convida un usuari a un equip.
 */
export async function inviteUser(
  supabase: SupabaseClient<Database>,
  inviter: User,
  activeTeamId: string,
  email: string,
  role: Role,
): Promise<FormState> {
  try {
    const { data: existingInvite } = await supabase.from("invitations").select(
      "id",
    ).match({ email, team_id: activeTeamId, status: "pending" }).maybeSingle();
    if (existingInvite) {
      return {
        success: false,
        message:
          "Ja s'ha enviat una invitaciÃ³ a aquest usuari per a aquest equip.",
      };
    }

    const { data: existingUserId } = await supabase.rpc(
      "get_user_id_by_email",
      { email_to_check: email },
    );

    const [teamRes, inviterProfileRes] = await Promise.all([
      supabase.from("teams").select("name").eq("id", activeTeamId).single(),
      supabase.from("profiles").select("full_name").eq("id", inviter.id)
        .single(),
    ]);

    if (teamRes.error) throw new Error("L'equip actiu no s'ha trobat.");
    const teamName = teamRes.data.name;
    const inviterName = inviterProfileRes.data?.full_name || inviter.email!;

    const { data: invitation, error: inviteError } = await supabase
      .from("invitations")
      .insert({
        team_id: activeTeamId,
        email,
        role,
        inviter_name: inviterName,
        team_name: teamName,
        user_id: existingUserId,
      })
      .select("id, token")
      .single();

    if (inviteError) throw inviteError;
    if (!invitation) throw new Error("No s'ha pogut crear la invitaciÃ³.");

    const resend = new Resend(process.env.RESEND_API_KEY);
    const inviteUrl =
      `${process.env.NEXT_PUBLIC_SITE_URL}/invitation/accept?token=${invitation.token}&email=${
        encodeURIComponent(email)
      }`;
    const loginUrl = `${process.env.NEXT_PUBLIC_SITE_URL}/settings/team`;

    if (existingUserId) {
      await resend.emails.send({
        from: `NotificaciÃ³ de "${teamName}" <invitacions@ribotflow.com>`,
        to: email,
        subject: `Has estat convidat a unir-te a l'equip ${teamName}`,
        html:
          `<p>Hola de nou, <strong>${inviterName}</strong> t'ha convidat a l'equip <strong>${teamName}</strong>. Com que ja tens un compte, pots acceptar-la des del teu panell d'equips.</p><div style="text-align: center; margin: 25px 0;"><a href="${loginUrl}" target="_blank" style="background-color: #007bff; color: #ffffff; padding: 15px 25px; text-decoration: none; border-radius: 5px; font-weight: bold;">Anar al meu panell</a></div>`,
      });
    } else {
      await resend.emails.send({
        from: `InvitaciÃ³ de "${teamName}" <invitacions@ribotflow.com>`,
        to: email,
        subject: `Has estat convidat a unir-te a l'equip ${teamName}`,
        html:
          `<p><strong>${inviterName}</strong> t'ha convidat a unir-te a <strong>${teamName}</strong>.</p><div style="text-align: center; margin: 25px 0;"><a href="${inviteUrl}" target="_blank" style="background-color: #007bff; color: #ffffff; padding: 15px 25px; text-decoration: none; border-radius: 5px; font-weight: bold;">Uneix-te a l'equip</a></div>`,
      });
    }

    return { success: true, message: `InvitaciÃ³ enviada a ${email}.` };
  } catch (error: unknown) {
    console.error("Error en el procÃ©s d'invitaciÃ³:", error);
    const msg = error instanceof Error
      ? error.message
      : "No s'ha pogut enviar la invitaciÃ³.";
    return { success: false, message: msg };
  }
}

/**
 * SERVEI: Resol una invitaciÃ³ (no requereix sessiÃ³).
 */
export async function resolveInvitation(
  token: string,
): Promise<{ redirectUrl: string }> {
  if (!token) {
    return { redirectUrl: "/login?message=El token d'invitaciÃ³ no Ã©s vÃ lid." };
  }

  const supabaseAdmin = createAdminClient();
  const { data: invitation } = await supabaseAdmin
    .from("invitations")
    .select("email")
    .match({ token, status: "pending" })
    .single();

  if (!invitation) {
    return {
      redirectUrl:
        "/login?message=La teva invitaciÃ³ no Ã©s vÃ lida o ja ha estat utilitzada.",
    };
  }

  const invitedEmail = invitation.email;
  const { data: existingUserId, error: rpcError } = await supabaseAdmin.rpc(
    "get_user_id_by_email",
    {
      email_to_check: invitedEmail,
    },
  );

  if (rpcError) {
    console.error("Error a l'RPC get_user_id_by_email:", rpcError);
    return { redirectUrl: "/login?message=Hi ha hagut un error al servidor." };
  }

  if (existingUserId) {
    return {
      redirectUrl: `/login?invite_token=${token}&email=${
        encodeURIComponent(invitedEmail)
      }`,
    };
  } else {
    return {
      redirectUrl: `/invitation/accept?token=${token}&email=${
        encodeURIComponent(invitedEmail)
      }`,
    };
  }
}

/**
 * SERVEI: Accepta una invitaciÃ³ (requereix usuari logat).
 */
/**
 * SERVEI: Accepta una invitaciÃ³ (requereix usuari logat).
 * (LÃ²gica de 'acceptInviteAction')
 */
export async function acceptInvite(
  supabase: SupabaseClient<Database>,
  user: User,
  token: string,
): Promise<{ redirectUrl: string }> {
  try {
    const { error } = await supabase.rpc(
      "accept_invitation_and_set_active_team",
      {
        invite_token: token,
      },
    );
    if (error) throw error;

    await supabase.auth.refreshSession();
    const locale = user.user_metadata?.locale || "ca";
    return { redirectUrl: `/${locale}/dashboard?success=Benvingut a l'equip!` };
  } catch (error: unknown) {
    let errorMessage = "Error en processar la invitaciÃ³.";
    if (error instanceof Error) {
      if (error.message.includes("INVITATION_NOT_FOUND")) {
        errorMessage =
          "La teva invitaciÃ³ no Ã©s vÃ lida o ja ha estat utilitzada.";
      } else if (error.message.includes("INVITATION_FOR_DIFFERENT_USER")) {
        errorMessage =
          "Aquesta invitaciÃ³ estÃ  destinada a un altre compte de correu.";
      } else {
        errorMessage = error.message;
      }
    }
    console.error("Error a acceptInviteAction:", errorMessage);
    return {
      redirectUrl: `/dashboard?error=${encodeURIComponent(errorMessage)}`,
    };
  }
}

/**
 * SERVEI: Revoca una invitaciÃ³ pendent.
 */
export async function revokeInvitation(
  supabase: SupabaseClient<Database>,
  activeTeamId: string,
  invitationId: string,
): Promise<FormState> {
  try {
    const { error } = await supabase
      .from("invitations")
      .delete()
      .match({ id: invitationId, team_id: activeTeamId });
    if (error) throw error;
    return { success: true, message: "InvitaciÃ³ revocada." };
  } catch (error: unknown) {
    const msg = error instanceof Error
      ? error.message
      : "No s'ha pogut revocar la invitaciÃ³.";
    return { success: false, message: msg };
  }
}

/**
 * SERVEI: Canvia l'equip actiu de l'usuari.
 */
export async function switchActiveTeam(
  supabase: SupabaseClient<Database>,
  user: User,
  teamId: string,
): Promise<FormState> {
  try {
    const { data: member } = await supabase
      .from("team_members")
      .select("team_id")
      .match({ user_id: user.id, team_id: teamId })
      .maybeSingle();
    if (!member) {
      return { success: false, message: "No tens accÃ©s a aquest equip." };
    }

    const { data: subscription } = await supabase
      .from("subscriptions")
      .select("plan_id, status")
      .eq("team_id", teamId)
      .maybeSingle();
    const newTeamPlan = (subscription?.status === "active")
      ? subscription.plan_id
      : "free";

    const supabaseAdmin = createAdminClient();
    const { error: updateError } = await supabaseAdmin.auth.admin
      .updateUserById(
        user.id,
        {
          app_metadata: {
            ...user.app_metadata,
            active_team_id: teamId,
            active_team_plan: newTeamPlan,
          },
        },
      );
    if (updateError) throw updateError;

    await supabase.auth.refreshSession();
    return { success: true, message: "Equip canviat." };
  } catch (error: unknown) {
    const msg = error instanceof Error
      ? error.message
      : "No s'ha pogut canviar d'equip.";
    return { success: false, message: msg };
  }
}

/**
 * SERVEI: Activa/desactiva permÃ­s d'inbox.
 */
export async function toggleInboxPermission(
  supabase: SupabaseClient<Database>,
  granteeUser: User,
  activeTeamId: string,
  targetUserId: string,
): Promise<FormState> {
  if (granteeUser.id === targetUserId) {
    return {
      success: false,
      message: "No pots assignar-te permisos a tu mateix.",
    };
  }

  try {
    const { data: existingPermission } = await supabase
      .from("inbox_permissions")
      .select("id")
      .match({
        team_id: activeTeamId,
        grantee_user_id: granteeUser.id,
        target_user_id: targetUserId,
      })
      .maybeSingle();

    if (existingPermission) {
      const { error } = await supabase.from("inbox_permissions").delete().eq(
        "id",
        existingPermission.id,
      );
      if (error) throw error;
      return { success: true, message: "PermÃ­s revocat." };
    } else {
      const { error } = await supabase.from("inbox_permissions").insert({
        team_id: activeTeamId,
        grantee_user_id: granteeUser.id,
        target_user_id: targetUserId,
      });
      if (error) throw error;
      return { success: true, message: "PermÃ­s concedit." };
    }
  } catch (error: unknown) {
    const msg = error instanceof Error
      ? error.message
      : "No s'ha pogut actualitzar el permÃ­s.";
    return { success: false, message: msg };
  }
}

/**
 * SERVEI: Neteja l'equip actiu (torna al lobby).
 */
export async function clearActiveTeam(user: User): Promise<FormState> {
  try {
    const supabaseAdmin = createAdminClient();
    const { error } = await supabaseAdmin.auth.admin.updateUserById(
      user.id,
      {
        app_metadata: {
          ...user.app_metadata,
          active_team_id: null,
          active_team_plan: null,
        },
      },
    );
    if (error) throw error;
    return { success: true, message: "Has sortit de l'equip." };
  } catch (error: unknown) {
    const msg = error instanceof Error
      ? error.message
      : "No s'ha pogut sortir de l'equip.";
    return { success: false, message: msg };
  }
}

/**
 * SERVEI: Accepta una invitaciÃ³ personal (des del lobby).
 */
export async function acceptPersonalInvite(
  supabase: SupabaseClient<Database>,
  invitationId: string,
): Promise<FormState> {
  try {
    const { error } = await supabase.rpc("accept_personal_invitation", {
      invitation_id: invitationId,
    });
    if (error) throw error;
    await supabase.auth.refreshSession();
    return { success: true, message: "InvitaciÃ³ acceptada." };
  } catch (error: unknown) {
    let msg = "No s'ha pogut acceptar la invitaciÃ³.";
    if (
      error instanceof Error && error.message.includes("INVALID_INVITATION")
    ) {
      msg = "Aquesta invitaciÃ³ no Ã©s vÃ lida o ja no estÃ  disponible.";
    }
    return { success: false, message: msg };
  }
}

/**
 * SERVEI: Rebutja una invitaciÃ³ personal (des del lobby).
 */
export async function declinePersonalInvite(
  supabase: SupabaseClient<Database>,
  user: User,
  invitationId: string,
): Promise<FormState> {
  try {
    const { error } = await supabase
      .from("invitations")
      .update({ status: "declined" })
      .match({ id: invitationId, user_id: user.id });
    if (error) throw error;
    return { success: true, message: "InvitaciÃ³ rebutjada." };
  } catch (error: unknown) {
    return { success: false, message: "No s'ha pogut rebutjar la invitaciÃ³." };
  }
}

/**
 * SERVEI: Elimina un membre de l'equip.
 */
export async function removeMember(
  supabase: SupabaseClient<Database>,
  activeTeamId: string,
  actionUser: User,
  userIdToRemove: string,
): Promise<FormState> {
  if (actionUser.id === userIdToRemove) {
    return { success: false, message: "No et pots eliminar a tu mateix." };
  }
  const { data: team } = await supabase.from("teams").select("owner_id").eq(
    "id",
    activeTeamId,
  ).single();
  if (team?.owner_id === userIdToRemove) {
    return {
      success: false,
      message: "No es pot eliminar el propietari de l'equip.",
    };
  }

  try {
    const supabaseAdmin = createAdminClient();
    const { error: deleteError } = await supabaseAdmin
      .from("team_members")
      .delete()
      .match({ user_id: userIdToRemove, team_id: activeTeamId });
    if (deleteError) throw deleteError;

    const { data: { user: removedUser } } = await supabaseAdmin.auth.admin
      .getUserById(userIdToRemove);
    if (removedUser?.app_metadata?.active_team_id === activeTeamId) {
      await supabaseAdmin.auth.admin.updateUserById(userIdToRemove, {
        app_metadata: {
          ...removedUser.app_metadata,
          active_team_id: null,
          active_team_plan: null,
        },
      });
    }
    return { success: true, message: "Membre eliminat correctament." };
  } catch (error: unknown) {
    const msg = error instanceof Error
      ? error.message
      : "No s'ha pogut eliminar el membre.";
    return { success: false, message: msg };
  }
}

/**
 * SERVEI: Actualitza el rol d'un membre.
 */
export async function updateMemberRole(
  supabase: SupabaseClient<Database>,
  activeTeamId: string,
  memberUserId: string,
  newRole: Role,
): Promise<FormState> {
  if (newRole === "owner") {
    return {
      success: false,
      message:
        "La propietat de l'equip no es pot assignar, s'ha de transferir.",
    };
  }

  try {
    const { data: team } = await supabase.from("teams").select("owner_id").eq(
      "id",
      activeTeamId,
    ).single();
    if (team?.owner_id === memberUserId) {
      return {
        success: false,
        message: "No es pot canviar el rol del propietari de l'equip.",
      };
    }

    const { error } = await supabase
      .from("team_members")
      .update({ role: newRole })
      .match({ user_id: memberUserId, team_id: activeTeamId });
    if (error) throw error;

    return { success: true, message: "Rol actualitzat correctament." };
  } catch (error: unknown) {
    const msg = error instanceof Error
      ? error.message
      : "No s'ha pogut actualitzar el rol.";
    return { success: false, message: msg };
  }
}

/**
 * SERVEI: ObtÃ© el perfil de l'empresa (dades de l'emissor).
 */
export async function getCompanyProfile(
  supabase: SupabaseClient<Database>,
  teamId: string,
): Promise<CompanyProfile | null> { // âœ… CORRECCIÃ“ 2: Canviat 'any' per 'CompanyProfile'
  const { data, error } = await supabase
    .from("teams")
    .select(
      "id, company_name: name, company_tax_id: tax_id, company_address: address, company_email: email, company_phone: phone, logo_url",
    )
    .eq("id", teamId)
    .single<CompanyProfile>(); // âœ… Tipem la resposta

  if (error) {
    console.error("Error service(getCompanyProfile):", error.message);
    return null;
  }
  return data;
}

/**
 * SERVEI: ObtÃ© membres (simplificat).
 */
export async function getTeamMembers(
  supabase: SupabaseClient<Database>,
  teamId: string,
) {
  return supabase
    .from("team_members_with_profiles")
    .select("user_id, full_name")
    .eq("team_id", teamId);
}


// =================== FILE: src/lib/subscription/subscription.ts ===================

import 'server-only';
import type { SupabaseClient } from '@supabase/supabase-js';
import {
  PLAN_IDS,
  PLAN_LIMITS,
  type PlanId,
  type PlanLimit,
} from '@/config/subscriptions'; // O @/config/subscriptions
import { validatePageSession } from "@/lib/supabase/session";
import { getUserTeamContext } from "@/lib/supabase/teamContext";
/**
 * [DEPRECATED] Aquesta funciÃ³ ja no Ã©s necessÃ ria.
 * La lÃ²gica ara estÃ  dins de getUserTeamContext.
 * export async function getActivePlan(...)
 */

/**
 * ObtÃ© el lÃ­mit numÃ¨ric per a una caracterÃ­stica.
 * âœ… Aquesta funciÃ³ ara Ã©s SÃNCRONA.
 * Rep el planId directament.
 */
export function getPlanLimit(
  planId: PlanId,
  limit: PlanLimit
): number {
  const limits = PLAN_LIMITS[planId] || PLAN_LIMITS[PLAN_IDS.FREE];
  return limits[limit] ?? 0;
}

/**
 * Tipus per al resultat de la comprovaciÃ³ de lÃ­mit.
 */
export type UsageCheckResult = {
  allowed: boolean;
  current: number;
  max: number;
  error?: string;
};

/**
 * Comprova si un equip pot crear un nou recurs.
 * âœ… Aquesta funciÃ³ ara Ã©s mÃ©s simple. Rep el planId directament
 * i nomÃ©s s'encarrega de FER EL RECOMPTE.
 */
export async function checkUsageLimit(
  supabase: SupabaseClient,
  teamId: string,
  limit: PlanLimit,
  planId: PlanId // <-- Rep el planId obtingut del context!
): Promise<UsageCheckResult> {
  
  // 1. Obtenim el lÃ­mit (crida sÃ­ncrona, 0 cost)
  const max = getPlanLimit(planId, limit);

  // 2. Comprovem si Ã©s ilÂ·limitat
  if (max === Infinity) {
    return { allowed: true, current: -1, max: Infinity }; // -1 = no comptat
  }

  let current = 0;
  let errorMessage = 'Has assolit el lÃ­mit del teu pla.';

  // 3. Fem el recompte (Aquest switch Ã©s perfecte, no canvia)
  try {
    switch (limit) {
      case 'maxTickets':
        const { count: ticketCount } = await supabase
          .from('tickets')
          .select('*', { count: 'exact', head: true })
          .eq('team_id', teamId);
        current = ticketCount || 0;
        errorMessage = 'Has assolit el lÃ­mit de tickets per al teu pla.';
        break;

      case 'maxContacts':
        const { count: contactCount } = await supabase
          .from('contacts')
          .select('*', { count: 'exact', head: true })
          .eq('team_id', teamId);
        current = contactCount || 0;
        errorMessage = 'Has assolit el lÃ­mit de contactes per al teu pla.';
        break;

      case 'maxTeamMembers':
        const { count: memberCount } = await supabase
          .from('team_members')
          .select('*', { count: 'exact', head: true })
          .eq('team_id', teamId);
        current = memberCount || 0;
        errorMessage = 'Has assolit el lÃ­mit de membres d\'equip per al teu pla.';
        break;

      default:
        // Aquesta Ã©s la millora de robustesa que vam comentar
        throw new Error(
          `[UsageLimit] LÃ²gica de recompte no implementada per al lÃ­mit: ${limit}`
        );
    }
  } catch (error) {
    console.error(`Error checking usage for ${limit}:`, error);
    if (error instanceof Error && error.message.startsWith('[UsageLimit]')) {
      throw error; // Propaguem l'error de desenvolupament
    }
    return {
      allowed: false,
      current: 0,
      max: 0,
      error: 'Error en verificar el lÃ­mit.',
    };
  }

  // 4. Retornem el resultat
  if (current >= max) {
    return { allowed: false, current, max, error: errorMessage };
  }

  return { allowed: true, current, max };
}

/**
 * FunciÃ³ d'alt nivell per obtenir l'estat d'Ãºs d'un lÃ­mit per a l'usuari actual.
 * * Centralitza la lÃ²gica de:
 * 1. Validar la sessiÃ³ de l'usuari.
 * 2. Obtenir el seu equip actiu i el seu pla (via getUserTeamContext).
 * 3. Comprovar l'Ãºs actual contra el lÃ­mit del pla (via checkUsageLimit).
 * * @param limitType El tipus de lÃ­mit a comprovar (ex: 'maxContacts', 'maxTickets').
 * @returns Un objecte UsageCheckResult amb l'estat del lÃ­mit.
 */
export async function getUsageLimitStatus(
  limitType: PlanLimit // âœ… 2. Utilitzem el tipus correcte 'PlanLimit'
): Promise<UsageCheckResult> {
  
  // 1. Validem la sessiÃ³
  const session = await validatePageSession();
  if ('error' in session) {
    console.error("getUsageLimitStatus: SessiÃ³ invÃ lida", session.error);
    return { allowed: false, current: 0, max: 0, error: "SessiÃ³ no vÃ lida" };
  }
  
  const { supabase, user, activeTeamId } = session;

  // 2. Obtenim el context (inclou el planId)
  // Aquesta crida utilitza React.cache, per tant Ã©s eficient
  const context = await getUserTeamContext(supabase, user.id, activeTeamId);

  // 3. Cridem la funciÃ³ de baix nivell 'checkUsageLimit'
  // El planId ja ve validat des de 'getUserTeamContext'
  return checkUsageLimit(
    supabase,
    activeTeamId,
    limitType,
    context.planId 
  );
}

// =================== FILE: src/lib/supabase/admin.ts ===================

// A /lib/supabase/admin.ts
import { createClient } from '@supabase/supabase-js';

// NOTA: Aquest client NOMÃ‰S s'ha d'utilitzar en entorns de servidor (Server Actions, Route Handlers).
// Mai l'exposis al client!
export const createAdminClient = () => {
  if (!process.env.NEXT_PUBLIC_SUPABASE_URL || !process.env.SUPABASE_SERVICE_ROLE_KEY) {
    throw new Error('Supabase URL or service role key is missing.');
  }

  return createClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL,
    process.env.SUPABASE_SERVICE_ROLE_KEY,
    {
      auth: {
        autoRefreshToken: false,
        persistSession: false,
      },
    }
  );
};

// =================== FILE: src/lib/supabase/client.ts ===================

// Aquest arxiu crea un client de Supabase dissenyat per a ser utilitzat de forma segura
// als "Client Components" (arxius amb la directiva "use client").

import { createBrowserClient } from '@supabase/ssr';

/**
 * FunciÃ³ per crear una instÃ ncia del client de Supabase per al navegador.
 * Aquesta instÃ ncia Ã©s un "singleton", el que significa que nomÃ©s es crea una vegada
 * i es reutilitza a tota l'aplicaciÃ³ del costat del client.
 */
export function createClient() {
  // 'createBrowserClient' Ã©s la funciÃ³ recomanada de la llibreria '@supabase/ssr'
  // per a la interacciÃ³ des del navegador. No necessita gestionar les cookies manualment.
  return createBrowserClient(
    // Aquestes sÃ³n variables d'entorn pÃºbliques. El prefix 'NEXT_PUBLIC_'
    // les fa accessibles al codi del navegador. MAI s'han de posar claus
    // secretes amb aquest prefix.
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!
  );
}


// =================== FILE: src/lib/supabase/server.ts ===================

import { createServerClient} from '@supabase/ssr'
import { cookies } from 'next/headers'
import { createClient as createStandardClient } from "@supabase/supabase-js";
import { Database } from '@/types/supabase'; // Importem el tipus Database

export const createClient = () => {
    const cookieStore = cookies()

    return createServerClient<Database>( // <-- L'Ãºnic canvi Ã©s afegir <Database> aquÃ­
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                // âœ… NOVA IMPLEMENTACIÃ“ AMB getAll i setAll
                async getAll() {
                    return (await cookieStore).getAll()
                },
                async setAll(cookiesToSet) {
                    try {
                        // Utilitzem un bucle 'for...of' per a gestionar correctament les promeses
                        // si en el futur 'set' fos asÃ­ncron.
                        for (const { name, value, options } of cookiesToSet) {
                            (await cookieStore).set(name, value, options)
                        }
                    } catch (error) {
                        // âœ… Ara passem l'objecte 'error' al console.error
                        console.error("Hi ha hagut un error:", error);
                        // Opcionalment, pots mostrar un missatge mÃ©s especÃ­fic a l'usuari
                        // toast.error("Error", { description: error.message });
                    }
                },
            },
        }
    )
}

// La funciÃ³ per a crear el client d'administrador no canvia.
export const createAdminClient = () => {
    return createStandardClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.SUPABASE_SERVICE_ROLE_KEY!,
        { auth: { autoRefreshToken: false, persistSession: false } }
    );
};

// =================== FILE: src/lib/supabase/session.ts ===================

import { createClient } from "@/lib/supabase/server";
import { redirect } from "next/navigation";
import type { User, SupabaseClient } from "@supabase/supabase-js";

// Aquest tipus representa una sessiÃ³ completament validada.
export type ValidatedSession = {
    supabase: SupabaseClient;
    user: User;
    activeTeamId: string;
};

// Aquest tipus representa una resposta d'error estandarditzada.
export type SessionError = {
    error: { message: string };
};

// A /lib/session.ts (o on tinguis aquest codi)

// FunciÃ³ base que contÃ© la lÃ²gica comuna
async function getSessionCore() {
Â  Â  const supabase = createClient(); // Tipat amb <Database> per defecte
Â  Â  const { data: { user } } = await supabase.auth.getUser();

Â  Â  if (!user) {
Â  Â  Â  Â  return { user: null, supabase: null, activeTeamId: null };
Â  Â  }

Â  Â  // 1. (FONT PRIMÃ€RIA) Intentem obtenir-ho del token (metadades)
Â  Â  let activeTeamId = user.app_metadata?.active_team_id as string | null;

Â  Â  // 2. (FALLBACK) Si no hi Ã©s, el busquem al perfil.
Â  Â  // Aquesta lÃ²gica ara estÃ  centralitzada aquÃ­.
Â  Â  if (!activeTeamId) {
Â  Â  Â  Â  console.warn("active_team_id no trobat a app_metadata. Fent fallback a 'profiles'.");
Â  Â  Â  Â  const { data: profile } = await supabase
Â  Â  Â  Â  Â  Â  .from('profiles')
Â  Â  Â  Â  Â  Â  .select('active_team_id')
Â  Â  Â  Â  Â  Â  .eq('id', user.id)
Â  Â  Â  Â  Â  Â  .single();
Â  Â  Â  Â  
Â  Â  Â  Â  activeTeamId = profile?.active_team_id ?? null;
Â  Â  }

Â  Â  // 3. Retornem la informaciÃ³ de sessiÃ³ bÃ sica
Â  Â  return { user, supabase, activeTeamId };
}

// Nova versiÃ³ per a Server Actions
export async function validateUserSession(): Promise<ValidatedSession | SessionError> {
    const { user, supabase, activeTeamId } = await getSessionCore();

    if (!user || !supabase) {
        return { error: { message: "Usuari no autenticat." } };
    }
    if (!activeTeamId) {
        return { error: { message: "No s'ha pogut determinar l'equip actiu." } };
    }

    // El tipat ens assegura que user i supabase no sÃ³n nulls aquÃ­
    return { supabase, user, activeTeamId };
}

// Nova versiÃ³ per a PÃ gines
export async function validatePageSession() {
    const { user, supabase, activeTeamId } = await getSessionCore();

    if (!user) {
        redirect('/login');
    }
    if (!activeTeamId) {
        // Redirigim a un lloc on pugui crear o seleccionar un equip
        redirect('/settings/team');
    }
    
    // El redirect atura l'execuciÃ³, aixÃ­ que sabem que aquÃ­ tot Ã©s vÃ lid
Â  Â  // supabase! Ã©s segur grÃ cies a la comprovaciÃ³ de !user
  
    return { supabase: supabase!, user, activeTeamId };
}

// =================== FILE: src/lib/supabase/teamContext.ts ===================

import 'server-only';
import { cache } from 'react';
import type { SupabaseClient } from '@supabase/supabase-js';
import { PLAN_IDS, type PlanId } from '@/config/subscriptions';
import type { Role } from '../permissions/permissions.config'; // Comprova la ruta
import type { Database } from '@/types/supabase';

// âœ… MILLORA: Definim el tipus que ESPEREM de la funciÃ³ RPC
// AixÃ² ens permet evitar 'as any' i tenir un cast segur.
type RpcContextResponse = {
  role: string | null;
  plan_id: string | null;
  team_name: string | null;
} | null; // L'RPC pot tornar null si hi ha un error

// Tipus per a la resposta del nostre context
export type UserTeamContext = {
  role: Role | null;
  planId: PlanId;
  teamName: string | null;
};

/**
 * ObtÃ© tot el context crÃ­tic de l'usuari i l'equip (rol, pla)
 * en UNA ÃšNICA crida a la base de dades (via RPC).
 *
 * Embolicada amb React.cache, es pot cridar mÃºltiples vegades
 * en un mateix cicle de request (Server Components, Server Actions)
 * sense cost addicional.
 */
export const getUserTeamContext = cache(
  async (
    supabase: SupabaseClient<Database>,
    userId: string,
    teamId: string
  ): Promise<UserTeamContext> => {
    
    if (!userId || !teamId) {
      return { role: null, planId: PLAN_IDS.FREE, teamName: null };
    }

    // 1. Cridem la funciÃ³ RPC
    // DesprÃ©s de regenerar els tipus, 'get_user_team_context' serÃ  vÃ lid.
    const { data, error } = await supabase.rpc('get_user_team_context', {
      p_user_id: userId,
      p_team_id: teamId,
    });

    // 2. Gestionem errors
    if (error) {
      console.error('Error critical al obtenir user_team_context:', error);
      return { role: null, planId: PLAN_IDS.FREE, teamName: null };
    }

    // 3. Processem la resposta JSON
    // âœ… MILLORA: Fem un cast al nostre tipus definit (RpcContextResponse)
    // en lloc de 'as any'. AixÃ² satisfÃ  Eslint i Ã©s mÃ©s segur.
    const contextData = data as RpcContextResponse;

    const planId = (contextData?.plan_id) ?? PLAN_IDS.FREE;
    
    // 4. Validem el planId
    const validPlans = Object.values(PLAN_IDS) as string[];
    const finalPlanId = validPlans.includes(planId)
      ? (planId as PlanId)
      : PLAN_IDS.FREE;

    // 5. Retornem el context net
    return {
      role: (contextData?.role as Role | null) ?? null,
      planId: finalPlanId,
      teamName: contextData?.team_name ?? null,
    };
  }
);

// =================== FILE: src/lib/supabase/teams.ts ===================

// A /lib/supabase/teams.ts (o on sigui que visqui getActiveTeam)
import type { SupabaseClient } from "@supabase/supabase-js";
import { Database } from "@/types/supabase";

type Team = Database['public']['Tables']['teams']['Row'];

/**
 * ObtÃ© les dades d'un equip especÃ­fic pel seu ID.
 * @param supabase El client de Supabase.
 * @param teamId L'ID de l'equip a obtenir.
 * @returns Les dades de l'equip o null si no es troba o hi ha error.
 */
export async function getActiveTeam(
    supabase: SupabaseClient<Database>, 
    teamId: string
): Promise<Team | null> {
    
Â  Â  const { data: team, error: teamError } = await supabase
Â  Â  Â  Â  .from('teams')
Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  .eq('id', teamId)
Â  Â  Â  Â  .single();

Â  Â  if (teamError) {
Â  Â  Â  Â  console.error("Error en obtenir les dades de l'equip:", teamError.message);
Â  Â  Â  Â  return null;
Â  Â  }

Â  Â  return team;
}

// Aquesta funciÃ³ es torna molt mÃ©s simple i rÃ pida
export async function getTeamMembersWithProfiles(
    supabase: SupabaseClient,
    teamId: string
) {
    // La funciÃ³ nomÃ©s ha de fer la consulta i retornar la resposta.
    // Aquesta resposta SEMPRE serÃ  un objecte amb format { data, error }.
    const response = await supabase
        .from('team_members_with_profiles')
        .select('*')
        .eq('team_id', teamId);

    // Si hi ha un error, 'response.error' tindrÃ  valor.
    // Si no, 'response.data' tindrÃ  valor. PerÃ² el format Ã©s el mateix.
    return response;
}

// =================== FILE: src/lib/utils/crypto.ts ===================

// src/lib/utils/crypto.ts
// Aquest arxiu s'executa a l'entorn de Next.js (Node.js)
import { webcrypto } from "crypto";

// âœ… CORRECCIÃ“: Importem el que falta per a la 'Via 2' (desxifratge antic)
import AES from 'crypto-js/aes';
import Utf8 from 'crypto-js/enc-utf8';

const subtle = webcrypto.subtle;

// --- Funcions HÃ­brides ---

async function getKey(secret: string): Promise<CryptoKey> {
  const secretBuffer = new TextEncoder().encode(secret);
  const keyBuffer = await subtle.digest("SHA-256", secretBuffer);
  return subtle.importKey("raw", keyBuffer, { name: "AES-GCM" }, false, [
    "encrypt",
    "decrypt",
  ]);
}

// âœ… CORRECCIÃ“: FunciÃ³ optimitzada per a Node.js (Buffer -> Base64)
function bufferToBase64(buffer: ArrayBuffer | Uint8Array): string {
  // Assegurem que sempre passem un Uint8Array a Buffer.from
  const uint8Buffer = buffer instanceof Uint8Array ? buffer : new Uint8Array(buffer);
  return Buffer.from(uint8Buffer).toString('base64');
}

// âœ… CORRECCIÃ“: FunciÃ³ optimitzada per a Node.js (Base64 -> ArrayBuffer)
function base64ToBuffer(base64: string): ArrayBuffer {
  const buf = Buffer.from(base64, 'base64');
  // Retornem una cÃ²pia com a ArrayBuffer pur per evitar problemes de tipus amb 'subtle'
  return buf.buffer.slice(buf.byteOffset, buf.byteOffset + buf.byteLength);
}

/**
 * Xifra text pla utilitzant AES-GCM (SubtleCrypto, el mÃ¨tode rÃ pid).
 * Retorna el format 'iv:ciphertext' en Base64.
 */
export async function encryptToken(
  plaintext: string,
  secret: string,
): Promise<string> {
  if (!plaintext) return plaintext;
  if (!secret) throw new Error("ENCRYPTION_SECRET_KEY no proporcionada."); 
  
  try {
    const key = await getKey(secret);
    const iv = webcrypto.getRandomValues(new Uint8Array(12));
    const encodedPlaintext = new TextEncoder().encode(plaintext);

    const ciphertext = await subtle.encrypt(
      { name: "AES-GCM", iv: iv },
      key,
      encodedPlaintext,
    );

    // âœ… CORRECCIÃ“: Aquesta funciÃ³ ara accepta Uint8Array
    const base64_iv = bufferToBase64(iv); 
    const base64_ciphertext = bufferToBase64(ciphertext);

    return `${base64_iv}:${base64_ciphertext}`;
  } catch (error) {
    console.error("Error encriptant amb SubtleCrypto:", error);
    throw new Error("No s'ha pogut xifrar el token.");
  }
}

/**
 * Desxifra dades que poden estar en format SubtleCrypto (iv:cipher)
 * o en format antic CryptoJS (U2Fsd...).
 */
export async function decryptToken(
  encryptedData: string | null,
  secret: string,
): Promise<string> {
  if (!secret) {
    throw new Error("[CRYPTO] ENCRYPTION_SECRET_KEY no estÃ  definida.");
  }
  if (!encryptedData) {
    console.warn("[CRYPTO] La dada a desxifrar Ã©s nulÂ·la.");
    return "";
  }

  // --- VIA 1: Nou format SubtleCrypto (RÃ pid) ---
  if (encryptedData.includes(":")) {
    try {
      const parts = encryptedData.split(":");
      if (parts.length !== 2) {
        throw new Error("Format de dades SubtleCrypto invÃ lid.");
      }
      
      const [base64_iv, base64_ciphertext] = parts;
      const key = await getKey(secret);
      const iv = base64ToBuffer(base64_iv);
      const ciphertext = base64ToBuffer(base64_ciphertext);

      const decryptedBuffer = await subtle.decrypt(
        { name: 'AES-GCM', iv: iv },
        key,
        ciphertext,
      );

      return new TextDecoder().decode(decryptedBuffer);
    } catch (error) {
      console.error(`[CRYPTO-SUBTLE] Error desxifrant:`, (error as Error).message);
      throw new Error("No s'ha pogut desxifrar el token (SubtleCrypto). La clau pot ser incorrecta o la dada corrupta.");
    }
  }

  // --- VIA 2: Format antic CryptoJS (Lent) ---
  if (encryptedData.startsWith("U2FsdGVkX1")) {
    console.warn("[CRYPTO-JS] S'estÃ  desxifrant un token antic (format CryptoJS).");
    try {
      // âœ… CORRECCIÃ“: Ara 'AES' i 'Utf8' estan importats
      const bytes = AES.decrypt(encryptedData, secret);
      const decrypted = bytes.toString(Utf8);

      if (!decrypted) {
        throw new Error("Dades desxifrades buides (CryptoJS). La clau pot ser incorrecta.");
      }
      return decrypted;
    } catch (error) {
      console.error(`[CRYPTO-JS] Error desxifrant:`, (error as Error).message);
      throw new Error("No s'ha pogut desxifrar el token (CryptoJS).");
    }
  }

  // --- VIA 3: Dada no encriptada ---
  console.log("[CRYPTO] La dada no sembla encriptada, es retorna tal qual.");
  return encryptedData;
}

// =================== FILE: src/lib/utils/formatters.ts ===================

import { ca, es, enUS } from "date-fns/locale";
import { format } from "date-fns";

/**
 * ObtÃ© l'objecte de 'locale' de date-fns basat en l'string del locale actual (ex: 'ca', 'es').
 */
export const getDateLocale = (locale: string) => {
    switch (locale) {
        case 'es': return es;
        case 'en': return enUS;
        default: return ca;
    }
};

/**
 * Formata una data en una cadena de text localitzada.
 * @param date La data a formatar (pot ser string, Date, o null).
 * @param formatString El format desitjat (ex: "PPP", "dd MMM, yyyy").
 * @param currentLocale El locale actual ('ca', 'es', 'en').
 * @returns La data formatada o un guiÃ³ si la data Ã©s nulÂ·la.
 */
export function formatLocalizedDate(
    date: string | Date | null | undefined,
    formatString: string,
    currentLocale: string
): string {
    if (!date) return '-';
    const locale = getDateLocale(currentLocale);
    return format(new Date(date), formatString, { locale });
}

/** Formata una data a un format localitzat (e.g., dd/mm/yyyy) */
export function formatDate(dateStr: string | number | Date, locale: string = 'ca'): string {
    if (!dateStr) return '';
    try {
        return new Date(dateStr).toLocaleDateString(locale, {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
        });
    } catch {
        return String(dateStr);
    }
}

/** Formata una quantitat amb la moneda (e.g., â‚¬ 1.234,56) */
export function formatCurrency(amount: number | null | undefined, currency: string = 'EUR', locale: string = 'ca'): string {
    if (amount === null || amount === undefined) return 'â‚¬ 0,00';
    try {
        return amount.toLocaleString(locale, {
            style: 'currency',
            currency: currency,
            minimumFractionDigits: 2,
        });
    } catch {
        return `${currency} ${amount.toFixed(2)}`;
    }
}

// =================== FILE: src/lib/utils/media.ts ===================

// UbicaciÃ³: /lib/utils/media.ts (fitxer nou)

/**
 * Genera una miniatura (thumbnail) a partir del primer fotograma d'un fitxer de vÃ­deo.
 * @param file El fitxer de vÃ­deo.
 * @returns Una promesa que resol a un Data URL (string) de la imatge generada.
 */
export const generateVideoThumbnail = (file: File): Promise<string> => {
    return new Promise((resolve, reject) => {
        const video = document.createElement('video');
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');

        if (!context) {
            return reject(new Error('No es pot obtenir el context del canvas.'));
        }

        // Carreguem el vÃ­deo en memÃ²ria
        video.src = URL.createObjectURL(file);
        video.muted = true;

        // Quan el vÃ­deo ha carregat les seves metadades (dimensions, durada)...
        video.onloadedmetadata = () => {
            video.currentTime = 1; // Anem al segon 1 per evitar fotogrames negres
        };

        // Quan el fotograma actual ja es pot renderitzar...
        video.onseeked = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
            
            // Netegem l'objecte URL per alliberar memÃ²ria
            URL.revokeObjectURL(video.src);
            
            // Retornem la imatge del canvas com a Data URL
            resolve(canvas.toDataURL('image/jpeg', 0.8));
        };

        video.onerror = () => {
            reject(new Error('Error en carregar el vÃ­deo.'));
        };
    });
};

// =================== FILE: src/lib/utils/templates.ts ===================

// UbicaciÃ³: /lib/utils/templates.ts

/**
 * FunciÃ³ utilitÃ ria pura per substituir les variables (ex: {{nom_contacte}}) en un text
 * pels seus valors corresponents.
 * @param templateString El text de la plantilla amb variables.
 * @param values Un objecte amb els valors per a cada variable.
 * @returns El text amb les variables substituÃ¯des.
 */
export const renderTemplate = (templateString: string, values: { [key: string]: string }): string => {
    if (!templateString) return '';
    
    // Utilitza una expressiÃ³ regular per buscar totes les ocurrÃ¨ncies de {{...}}
    return templateString.replace(/\{\{([^}]+)\}\}/g, (_match, varName) => {
        const key = varName.trim();
        // Retorna el valor si existeix, o la variable original si no.
        return values[key] || `{{${key}}}`;
    });
};

// =================== FILE: src/lib/utils/utils.ts ===================

import { clsx, type ClassValue } from "clsx";
import { twMerge } from "tailwind-merge";
import DOMPurify from 'dompurify';

/**
 * FunciÃ³ d'utilitat per fusionar classes de Tailwind CSS de forma intelÂ·ligent.
 */
export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}

/**
 * Elimina el prefix de l'idioma d'una ruta.
 */
export const getCleanPathname = (pathname: string, locale: string): string => {
    const prefix = `/${locale}`;
    return pathname.startsWith(prefix) ? pathname.slice(prefix.length) || '/' : pathname;
};

/**
 * Saneja una cadena HTML per evitar atacs XSS.
 */
export function sanitizeHtml(html: string | null | undefined, options?: DOMPurify.Config): string {
  if (typeof window === 'undefined' || !html) {
    return '';
  }

  const configToUse = options || { ALLOWED_TAGS: [], ALLOWED_ATTR: [] };
  
  // âœ… SOLUCIÃ“ CORRECTA: Ignorem l'error de tipus esperat amb @ts-expect-error.
  // Si en el futur l'error desapareix, el compilador ens avisarÃ .
  // @ts-expect-error TypeScript is confused by the DOMPurify config type in this context.
  return DOMPurify.sanitize(html, configToUse);
}

// =================== FILE: src/lib/verifactu/service.ts ===================

import { type InvoiceDetail, type InvoiceItem } from '@/types/finances/invoices'

/**
 * Defineix la cÃ rrega de dades (payload) que la nostra funciÃ³
 * enviarÃ  a l'API externa de VeriFactu.
 * * NOTA: AixÃ² Ã©s una suposiciÃ³ basada en la teva lÃ²gica MOCK.
 * Has d'ajustar aquests camps als camps REALS que l'API d'Hisenda
 * o del teu proveÃ¯dor de SIF (Sistema d'InformaciÃ³ de FacturaciÃ³) requereixi.
 */
interface VeriFactuItemPayload {
  description: string | null
  quantity: number | null
  unitPrice: number | null // L'API segurament voldrÃ  el preu unitari, no el total
}

interface VeriFactuPayload {
  nifEmisor: string
  nifReceptor: string
  numeroFactura: string
  fechaExpedicion: string
  totalFactura: number
  items: VeriFactuItemPayload[]
  firmaPrevia: string | null // Encadenament
  // ... Altres camps que l'API requereixi (ex: impostos desglossats, etc.)
}

/**
 * Defineix la resposta que esperem rebre de l'API de VeriFactu
 * un cop registren la factura.
 */
interface VeriFactuResponse {
  uuid: string       // L'identificador Ãºnic del registre (ex: "T-123-ABC")
  qrData: string     // La URL o text complet per generar el QR (ex: "https://aeat.es/verifactu/T-123-ABC")
  signature: string  // La signatura digital d'aquesta factura (per encadenar la segÃ¼ent)
}

/**
 * Registra una factura al sistema VeriFactu (API externa).
 *
 * @param invoice - L'objecte de factura complet, incloent els 'invoice_items'.
 * @param previousSignature - La signatura de l'Ãºltima factura emesa per aquest equip.
 * @returns Un objecte amb les dades de VeriFactu si tÃ© Ã¨xit, o un error.
 */
export async function registerInvoiceWithHacienda(
  invoice: InvoiceDetail & { invoice_items: InvoiceItem[] },
  previousSignature: string | null,
): Promise<
  { success: true; data: VeriFactuResponse } | { success: false; error: string }
> {
  
  // 1. Mapejar les nostres dades (InvoiceDetail) al format de l'API (VeriFactuPayload)
  // Aquesta Ã©s la part mÃ©s important i depÃ¨n 100% de la documentaciÃ³ de l'API.
  const payload: VeriFactuPayload = {
    nifEmisor: invoice.company_tax_id || '',
    nifReceptor: invoice.client_tax_id || '',
    numeroFactura: invoice.invoice_number || `INV-${invoice.id}`,
    fechaExpedicion: invoice.issue_date || new Date().toISOString(),
    totalFactura: invoice.total_amount || 0,
    firmaPrevia: previousSignature,
    items: (invoice.invoice_items || []).map((item) => ({
      description: item.description,
      quantity: item.quantity,
      unitPrice: item.unit_price,
    })),
    // ... Assegura't d'omplir tots els camps obligatoris de l'API
  }

  // 2. Comprovar variables d'entorn (bona prÃ ctica)
  if (
    !process.env.VERIFACTU_API_ENDPOINT ||
    !process.env.VERIFACTU_API_KEY
  ) {
    console.error('Error: Manca la configuraciÃ³ de VERIFACTU_API')
    return {
      success: false,
      error: 'El servei de facturaciÃ³ no estÃ  configurat.',
    }
  }

  // 3. Cridar a l'API real (amb autenticaciÃ³, etc.)
  try {
    const response = await fetch(process.env.VERIFACTU_API_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        // L'autenticaciÃ³ pot variar (Bearer token, ApiKey, OAuth...)
        'Authorization': `Bearer ${process.env.VERIFACTU_API_KEY}`,
      },
      body: JSON.stringify(payload),
    })

    if (!response.ok) {
      // Si l'API retorna un error (400, 401, 500...), intentem llegir-lo
      const errorBody = await response.text()
      console.error('Error API VeriFactu:', errorBody)
      return {
        success: false,
        error: `Error d'Hisenda (${response.status}): ${
          errorBody || response.statusText
        }`,
      }
    }

    // L'API ha respost correctament (200 o 201)
    const data: VeriFactuResponse = await response.json()

    // ValidaciÃ³ simple de la resposta
    if (!data.uuid || !data.qrData || !data.signature) {
        console.error("Resposta invÃ lida de l'API VeriFactu:", data);
        return { success: false, error: "La resposta del servei de facturaciÃ³ Ã©s incompleta."}
    }

    return { success: true, data }

  } catch (error) {
    // Error de xarxa (fetch ha fallat, no hi ha connexiÃ³, etc.)
    console.error('Error de xarxa VeriFactu:', error)
    return {
      success: false,
      error: "Error de connexiÃ³ amb el servei de facturaciÃ³.",
    }
  }
}

// =================== FILE: src/middleware.ts ===================

import { createServerClient } from '@supabase/ssr';
import { NextResponse, type NextRequest } from 'next/server';
import createIntlMiddleware from 'next-intl/middleware';
import { locales, defaultLocale } from './i18n';

const LOCALE_COOKIE_NAME = 'NEXT_LOCALE';
const isProduction = process.env.NODE_ENV === 'production';
type AppLocale = typeof locales[number];

// -----------------------------------------------------------------
// ğŸ”‘ AQUESTA Ã‰S LA CORRECCIÃ“ CLAU QUE VAM TROBAR AL FÃ’RUM
// Forcem el middleware a executar-se en l'entorn Node.js
// per evitar el conflicte de runtimes (Node vs Deno/Edge).
export const runtime = 'nodejs';
// -----------------------------------------------------------------

export async function middleware(request: NextRequest) {

    const allCookies = request.cookies.getAll();
    const localeCookie = allCookies.find(c => c.name === LOCALE_COOKIE_NAME);
    const storedLocale = localeCookie?.value;

    // ğŸ”‘ CLAU FIX 1 (TypeScript): Determinem el locale per a la redirecciÃ³ d'Auth. 
    // Utilitzem la cookie si Ã©s un idioma suportat, altrament el default.
    const authRedirectLocale: AppLocale = (storedLocale && locales.includes(storedLocale as AppLocale))
        ? (storedLocale as AppLocale)
        : defaultLocale;

    // 1. Next-intl processa la peticiÃ³
    const handleI18nRouting = createIntlMiddleware({
        locales,
        defaultLocale,
        localeDetection: true, // Mantenim la detecciÃ³ de la cookie
        localePrefix: 'always',
        localeCookie: {
            name: LOCALE_COOKIE_NAME,
            path: '/',
            maxAge: 60 * 60 * 24 * 365,
            sameSite: 'lax',
            secure: isProduction,
        }
    });

    const response = handleI18nRouting(request);

    // ----------------------------------------------------------------
    // ğŸ”‘ CLAU FIX 2: ATURAR EL BUCLE. Si next-intl ja ha decidit redirigir (canviant l'idioma), 
    // hem d'aturar la nostra lÃ²gica d'Auth i deixar que next-intl executi la seva redirecciÃ³.
    // ----------------------------------------------------------------
    if (response.headers.get('Location')) {
        // En aquest punt, next-intl ha determinat que l'usuari ha de ser redirigit a un altre URL
        // (p. ex., de / a /ca o de /es a /ca, o viceversa). Deixem que la redirecciÃ³ es produeixi.
        return response;
    }
    // ----------------------------------------------------------------

    // 2. Extreure dades i executar la lÃ²gica de Supabase
    const pathnameWithoutLocale = request.nextUrl.pathname.replace(new RegExp(`^/(${locales.join('|')})`), '') || '/';

    // Cridem Supabase per obtenir l'usuari (necessari per a la redirecciÃ³ d'Auth)
    const supabase = createServerClient(
        process.env.NEXT_PUBLIC_SUPABASE_URL!,
        process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
        {
            cookies: {
                getAll() { return request.cookies.getAll(); },
                setAll(cookiesToSet) {
                    cookiesToSet.forEach(({ name, value, options }) => response.cookies.set(name, value, options));
                },
            },
        }
    );
    const { data: { user } } = await supabase.auth.getUser();


    // 3. LÃ²gica de RedirecciÃ³ (Auth) - Utilitza el locale fiable
    const publicPrefixes = ['/login', '/signup', '/auth', '/accept-invite', '/quote', '/invitation/accept',
    '/politica-privacitat',
    '/termes-condicions',
    '/politica-cookies',];
    
    const isPublicPath = pathnameWithoutLocale === '/' || publicPrefixes.some(p => pathnameWithoutLocale.startsWith(p));
    const isAppPath = !isPublicPath;

    // --- REGLA 1: Usuari NO autenticat ---
    if (!user && isAppPath) {
        // Redirigim a /<locale_cookie>/login
        return NextResponse.redirect(new URL(`/${authRedirectLocale}/login`, request.url));
    }

    // --- REGLA 2: Usuari SÃ ESTÃ€ AUTENTICAT ---
    if (user && isPublicPath) {
        // Redirigim de la ruta pÃºblica (com / o /login) a /<locale_cookie>/dashboard
        return NextResponse.redirect(new URL(`/${authRedirectLocale}/dashboard`, request.url));
    }

    // Si no hi ha cap redirecciÃ³ d'Auth, retornem la resposta de next-intl (que farÃ  el rewrite).
    return response;
}

export const config = {
    matcher: ['/((?!api|_next/static|_next/image|.*\\..*).*)'],
};

// =================== FILE: src/stores/navigationStore.ts ===================

// src/stores/navigationStore.ts

import { create } from 'zustand';
// âœ… 1. Importem el nou tipus que acabem de crear
import type { ActiveTeam } from '@/types/app/navigation'; 

interface NavigationState {
  isNavigating: boolean;
  setIsNavigating: (isNavigating: boolean) => void;
  isChatbotOpen: boolean;
  toggleChatbot: () => void;
  
  // âœ… 2. AFEGIM LES PROPIETATS QUE FALTAVEN
  activeTeam: ActiveTeam | null;
  setActiveTeam: (team: ActiveTeam | null) => void;
}

export const useNavigationStore = create<NavigationState>((set) => ({
  isNavigating: false,
  setIsNavigating: (isNavigating) => set({ isNavigating }),
  isChatbotOpen: false,
  toggleChatbot: () => set((state) => ({ isChatbotOpen: !state.isChatbotOpen })),

  // âœ… 3. AFEGIM ELS VALORS PER DEFECTE
  activeTeam: null, // ComenÃ§a sent null
  setActiveTeam: (team) => set({ activeTeam: team }),
}));

// =================== FILE: src/types/app/navigation.ts ===================

// src/types/navigation.ts
import type { LucideIcon } from 'lucide-react';

/**
 * @summary Aquesta constant defineix TOTES les claus de traducciÃ³ possibles per a la navegaciÃ³.
 * Ã‰s la nostra font Ãºnica de la veritat. Si afegeixes un nou element al menÃº,
 * has d'afegir la seva 'labelKey' aquÃ­ primer.
 */
export const NAVIGATION_KEYS = [
  'dashboard', 'crm', 'finances', 'communication', 'network', 'architecture',
  'crmGeneral', 'contacts', 'pipeline', 'quotes', 'concepts', 'activities', // âœ… 'concepts' i 'activities' afegits
  'invoicing', 'expenses', 'inbox', 'templates', 'marketing', 'profile', 'customization',
  'ai', 'settings', 'planner', 'calendar', 'projects', 'tasks', 'reports', 'suppliers', 'billing', 'team', 'integrations', 'blacklist', 'customization', 'install', 'permissions', 'transcription'
] as const;

/**
 * @summary Aquest tipus es genera automÃ ticament a partir de la constant de dalt.
 * Crea una uniÃ³ de tots els possibles valors: 'dashboard' | 'crm' | 'finances' | ...
 */
export type NavigationKey = typeof NAVIGATION_KEYS[number];

/**
 * @summary Aquesta Ã©s la interfÃ­cie per a cada element de navegaciÃ³.
 * Ara utilitza 'NavigationKey' per assegurar que 'labelKey' sempre sigui un valor vÃ lid.
 */
export interface NavItem {
  id: string;
  labelKey: NavigationKey; // âœ… Ara Ã©s totalment segur i tipat.
  descKey?: NavigationKey; // âœ… NOU: Clau per a la descripciÃ³ (opcional).
  icon: LucideIcon;
  path: string;
  isSingle: boolean;
  basePath?: string;
  children?: NavItem[];
  notImplemented?: boolean;
  // âœ… AQUÃ AFEGIM LA NOVA PROPIETAT
  // Ã‰s opcional ('?') perquÃ¨ no tots els enllaÃ§os requeriran un pla especÃ­fic.
  // SerÃ  un array de strings, ex: ['plus', 'premium'].
  requiredPlan?: string[];
  allowedRoles?: string[]; // Rols que poden accedir (ex: ['owner', 'admin'])


}


/**
 * @summary Dades essencials de l'equip actiu.
 * Aquestes sÃ³n les dades que desarem al 'navigationStore'
 * i que consumirem a components com 'NetworkClient'.
 */
export type ActiveTeam = {
  id: string;
  name: string;
  logo_url: string | null;
  // PodrÃ­em afegir mÃ©s camps si fossin necessaris globalment
};

// =================== FILE: src/types/comunicacio/inbox.ts ===================

// src/types/crm/inbox.ts
import { z } from 'zod';
// 1. Encara importem 'Contact' per si el necessitem en altres llocs,
//    perÃ² no el farem servir al 'ticketSchema' directament.
import { TicketStatus, TICKET_STATUS_MAP} from '@/config/inbox';

// --- TIPUS PRINCIPALS ---
export type TicketFilter = 'tots' | 'rebuts' | 'enviats' | 'noLlegits';

// âœ… SOLUCIÃ“ 1: Definim un esquema Zod per al *que realment rebem* de l'RPC.
// Aquest objecte NO Ã©s un 'Contact' complet.
const rpcContactSchema = z.object({
Â  id: z.number(), // âœ… CORRECCIÃ“: L'ID de la BD sempre Ã©s 'number', no 'string'
Â  nom: z.string(),
Â  email: z.string(),
Â  empresa: z.string().nullable(),
}).nullable();

// Esquema de validaciÃ³ per a un Tiquet
export const ticketSchema = z.object({
Â  id: z.number(),
Â  user_id: z.string().uuid(),
  // Aquest contact_id Ã©s un UUID (string), Ã©s correcte si la teva taula 'tickets' el tÃ© com a text
Â  contact_id: z.string().uuid().nullable(), 
Â  
Â  sender_name: z.string().nullable(),
Â  sender_email: z.string().email(),
Â  subject: z.string().nullable(),
Â  preview: z.string().nullable(),
Â  
Â  sent_at: z.string().datetime(),
Â  status: z.custom<TicketStatus>(),
Â  type: z.enum(['rebut', 'enviat']),
Â  body: z.string().optional().nullable(),
Â  
Â  // âœ… SOLUCIÃ“ 2: Utilitzem l'esquema parcial 'rpcContactSchema'
Â  // en lloc de 'z.custom<Contact>()'
Â  contacts: rpcContactSchema, 
});

// El 'Ticket' inferit ara espera el tipus correcte
export type Ticket = z.infer<typeof ticketSchema>;

// Tipus que representa les dades en brut que arriben de la funciÃ³ RPC
export type TicketFromRpc = {
Â  id: number;
Â  user_id: string;
Â  subject: string | null;
Â  body: string | null;
Â  status: string | null;
Â  provider_message_id: string | null;
Â  type: string | null;
Â  preview: string | null;
Â  sent_at: string | null;
Â  sender_name: string | null;
Â  sender_email: string | null;
Â  created_at: string;
Â  contact_id: string | null;
Â  provider: string | null;
Â  attachments: unknown;
Â  contacts: { 
    // âœ… CORRECCIÃ“: L'ID ha de ser 'number'
    id: number; 
    nom: string; 
    email: string; 
    empresa: string | null; 
  } | null;
Â  assignment: { deal_id: string | null } | null;
};


/**
Â * FunciÃ³ transformadora que converteix de manera segura un objecte RPC a un tipus Ticket.
Â * Ara, 't.contacts' (amb id: number) coincideix amb el que 'ticketSchema' espera.
Â */
export function transformRpcToTicket(t: TicketFromRpc): Ticket {
Â  const validStatusValues = TICKET_STATUS_MAP.map(s => s.dbValue);

Â  return {
Â  Â  ...t,
Â  Â  sender_email: t.sender_email ?? 'desconegut@email.com',
Â  Â  sent_at: t.sent_at ?? new Date().toISOString(),
Â  Â  status: (validStatusValues.includes(t.status as TicketStatus) ? t.status : 'Obert') as TicketStatus,
Â  Â  type: (t.type === 'enviat' ? 'enviat' : 'rebut'),
Â  Â  
Â  Â  // Aquests camps ara sÃ³n compatibles
Â  Â  sender_name: t.sender_name,
Â  Â  subject: t.subject,
Â  Â  preview: t.preview,
Â  Â  contact_id: t.contact_id,
Â  Â  body: t.body,
Â  Â  contacts: t.contacts, // âœ… AixÃ² ara funciona!
Â  };
}

// ... (la resta de tipus com templateSchema, activitySchema, etc. es mantenen iguals)
export const templateSchema = z.object({
Â  id: z.number(),
Â  name: z.string(),
Â  subject: z.string(),
Â  body: z.string(),
Â  variables: z.array(z.string()).nullable(),
});
export type Template = z.infer<typeof templateSchema>;

export const activitySchema = z.object({
Â  Â  id: z.string(),
Â  Â  created_at: z.string(),
Â  Â  type: z.string(),
Â  Â  content: z.string(),
Â  Â  is_read: z.boolean(),
Â  Â  contact_id: z.string().nullable(),
Â  Â  contact_name: z.string().nullable(),
Â  Â  contact_email: z.string().nullable(),
Â  Â  contacts: z.object({ nom: z.string().nullable() }).nullable(),
});
export type Activity = z.infer<typeof activitySchema>;

// =================== FILE: src/types/comunicacio/marketing.ts ===================

// UbicaciÃ³: src/types/marketing/types.ts

import type { Database } from '@/types/supabase'; // Assumim que aquest Ã©s el camÃ­ correcte

// --- Tipus de Base de Dades (DRY) ---
// Derivat directament de la BBDD. Aquesta Ã©s la font de veritat.
export type Campaign = Database['public']['Tables']['campaigns']['Row'];
export type CampaignInsert = Database['public']['Tables']['campaigns']['Insert'];
export type CampaignUpdate = Database['public']['Tables']['campaigns']['Update'];

// --- Tipus de LÃ²gica de Negoci (IA) ---
// Aquest Ã©s un tipus per a la lÃ²gica de negoci, no de la BBDD.
export interface Strategy {
  name: string;
  type: string;
  target_audience: string;
  description: string;
}

export type Kpis = {
Â  totalLeads: number;
Â  conversionRate: number;
};

// Tipus compost que defineix el que l'RPC 'get_marketing_page_data' retorna
export type MarketingPageData = {
  kpis: Kpis;
  campaigns: Campaign[]; // Reutilitzem el tipus Campaign!
};

// =================== FILE: src/types/crm/calendar.ts ===================

import { Tables } from '@/types/supabase';

// Aquest tipus ara defineix 'profiles' amb les dues propietats que seleccionem a la consulta,
// fent-lo mÃ©s precÃ­s i ajudant a TypeScript.
export type TaskWithAssignee = Omit<Tables<'tasks'>, 'user_id'> & {
  profiles: {
    id: string;
    full_name: string | null;
    avatar_url: string | null; // âœ… SOLUCIÃ“: Afegim la propietat que faltava.

  } | null;
  user_id: string | null; // Mantenim user_id per al diÃ leg d'ediciÃ³
};


// src/types/crm/index.ts (o el teu fitxer de tipus)

export interface CalendarEvent {
  id: number | string; // âœ… SOLUCIÃ“ 1: Ara pot ser un nÃºmero o un text.
  title: string;
  start: Date;
  end: Date;
  allDay?: boolean;
  resource?: unknown; // Use 'unknown' for a safer alternative to 'any'.
  eventType?: 'task' | 'quote' | 'email' | 'receivedEmail' | 'skeleton'; // âœ… SOLUCIÃ“ 2: Afegim 'skeleton' com a tipus vÃ lid.
}

// ğŸ§  DefiniciÃ³ centralitzada de l'estat dels filtres (ActiveSources)
// Aquest tipus Ã©s el contracte entre el Client Component i la Server Action.
export type ActiveSources = {
    tasks: boolean;
    quotes: boolean;
    emails: boolean;
    receivedEmails: boolean;
};

// Tipus per a l'estat del formulari
export type FormState = {
Â  error?: {
Â  Â  form?: string;
Â  Â  db?: string;
Â  Â  title?: string[];
Â  Â  description?: string[];
Â  Â  due_date?: string[];
Â  Â  priority?: string[];
Â  Â  user_id?: string[];
Â  };
Â  success?: boolean;
};

// =================== FILE: src/types/crm/contacts.ts ===================

/**
 * @file src/types/crm/contacts.ts
 * @summary Defineix els tipus de dades per als Contactes i el Dashboard General del CRM.
 */

// Importem tipus d'altres mÃ²duls a travÃ©s del fitxer 'index.ts' per evitar errors de dependÃ¨ncia circular.
import type { Activity, Opportunity, Task , CrmNotification} from './index';
import type { Invoice , Quote} from '@/types/db';
import type { ContactStatusCode } from '@/config/contacts';
// --- MAPA I TIPUS D'ESTAT DE CONTACTE ---



// --- TIPUS PRINCIPALS ---

export type Contact = {
  id: string;
  nom: string;
  nif?: string | null;
  empresa: string | null;
  created_at?: string;
  email?: string | null;
  telefon?: string | null;
  estat?: ContactStatusCode;
  valor?: number | null;
  user_id?: string;
  main_address?: string | null;
  job_title?: string | null;
  industry?: string | null;
  lead_source?: string | null;
  birthday?: string | null;
  notes?: string | null;
  children_count?: number | null;
  partner_name?: string | null;
  hobbies?: string[] | null;
  address?: { city: string | null } | null;
  social_media?: { linkedin: string | null } | null;
  ubicacio?: string | null;
  last_interaction_at?: string | null;


};

// Tipus Mestre per a les dades relacionades d'un contacte
export type ContactRelatedData = {
  quotes: Quote[];
  opportunities: Opportunity[];
  invoices: Invoice[];
  activities: Activity[];
}

// Tipus mestre per a les dades del Dashboard General
export type CrmData = {
  stats: {
    totalContacts: number;
    newContactsThisMonth: number;
    opportunities: number;
    pipelineValue: number;
    avgRevenuePerClient: number;
    avgConversionTimeDays: number;
  };
  funnel: {
    leads: number;
    quoted: number;
    clients: number;
  };
  topClients: {
    id: string;
    nom: string;
    total_invoiced: number;
  }[];
  coldContacts: {
    id: string;
    nom: string;
    last_interaction_at: string;
  }[];
  bestMonths: {
    month: string;
    total: number;
  }[];
  unreadActivities: Activity[];
};

// InterfÃ­cie per a les estadÃ­stiques principals del Dashboard
export interface DashboardStats {
  totalContacts: number;
  activeClients: number;
  opportunities: number;
  invoiced: number;
  pending: number;
  expenses: number;
  invoicedChange: string;
  expensesChange: string;
  invoicedIsPositive: boolean;
  expensesIsPositive: boolean;
}

// InterfÃ­cie per al conjunt de dades inicials que el Dashboard rep
export interface DashboardInitialData {
  stats: DashboardStats;
  tasks: Task[]; // Assegura't que Task s'importi des de './index'
  contacts: Contact[];
  overdueInvoices: Invoice[];
  attentionContacts: Contact[];
  notifications: CrmNotification[]; // âœ… Assegura't que aquÃ­ tambÃ© s'usa el nou nom
}

// =================== FILE: src/types/crm/deals.ts ===================

// Dins de /types/crm/deals.ts (per exemple)

export interface Stage {
  id: string;
  name: string;
  position: number; 
 
}

// TambÃ© pots exportar altres tipus relacionats aquÃ­
export interface Deal {
  id: string;
  title: string;
  value: number;
  stage_id: string;
 
}

// =================== FILE: src/types/crm/general.ts ===================


// âœ… NOU: Tipus per a les dades inicials del diÃ leg de composiciÃ³ de correu
export type ComposeEmailData = {
  contactId: string;
  to: string;
  subject: string;
  body: string;
};
export type CompanyProfileObject = {
  id: string;
  user_id: string;
  company_name?: string | null;
  company_tax_id?: string | null;
  company_address?: string | null;
  company_email?: string | null;
  company_phone?: string | null;
  logo_url?: string | null;
};
// âœ… NOU: Definim i exportem el tipus per a una Tasca (Task)
export type Task = {
  id: string; // O number, depenent de la teva BD
  created_at: string;
  title: string;
  is_completed: boolean;
  contact_id: string | null;
  user_id: string;

  // âœ… NOU CAMP: Pot ser un objecte Contact o null si no hi ha cap contacte associat.
  contacts: {
    id: string;
    nom: string;
  } | null;

  // âœ… NOUS CAMPS AFEGITS
  description: string | null;
  due_date: string | null; // El tipus 'date' de SQL es representa com a string (YYYY-MM-DD)
  priority: 'Baixa' | 'Mitjana' | 'Alta' | null;
};
export type CompanyProfile = CompanyProfileObject | null;

// =================== FILE: src/types/crm/index.ts ===================

/**
 * @file src/types/crm/index.ts
 * @summary Aquest Ã©s un "fitxer barril" que re-exporta tots els tipus del domini CRM.
 * AixÃ² permet que la resta de l'aplicaciÃ³ importi qualsevol tipus del CRM des d'un sol lloc,
 * mantenint l'organitzaciÃ³ interna en mÃ²duls.
 * * @example
 * import type { Contact, Quote, Ticket } from '@/types/crm';
 */
export * from './opportunitys';
export * from './contacts';
export * from '../comunicacio/inbox';
export * from './general';
export * from '../finances/products';
export * from './deals';
export * from '../shared/notification';
export * from './calendar';

// =================== FILE: src/types/crm/opportunitys.ts ===================

import type {PipelineStageName} from "@/config/pipeline";
import type { Contact } from "@/types/db"; 

export type OpportunityPipline = { 
  id: string; 
  name: string; 
  stage_name: PipelineStageName;
  value: number | null;
  close_date?: string | null;
  description?: string | null;
  contact_id: string;
  contacts?: { id: string; nom: string | null; } | null;
};

//Oportunitat _hooks useOpportunityForm i usePipeline
export type Opportunity= {
  id: string;
  name: string;
  stage_name: string;
  value: number | null;
  close_date: string | null;
  description: string | null;
  contact_id: string;
  contacts: Contact | null;
};

// =================== FILE: src/types/dashboard/types.ts ===================

import { Database, Tables } from "@/types/supabase";

export type TaskPriority = Database['public']['Enums']['task_priority'];

// Aquest tipus Ã©s per a la CREACIÃ“. Enviem nomÃ©s els IDs.
export type NewTaskPayload = {
  title: string;
  description: string | null;
  due_date: string | null;
  priority: TaskPriority | null;
  contact_id: number | null;
  department_id: number | null; // âœ… CORRECCIÃ“: Afegeix el camp per a l'ID del departament
  duration: number | null; // âœ… CORRECCIÃ“: Afegeix el camp per a la durada
  user_asign_id: string | null; // âœ… CORRECCIÃ“: Nom de columna correcte
  asigned_date: string | null; // âœ… CORRECCIÃ“: Nom de columna correcte
};

// Aquest tipus Ã©s per a la VISUALITZACIÃ“. Rebem els objectes niuats.
export type TaskWithContact = Tables<'tasks'> & {
  contacts: { id: number; nom: string; } | null;
  departments: { id: number; name: string; } | null; // âœ… CORRECCIÃ“: Afegeix l'objecte department
};

// =================== FILE: src/types/db.ts ===================

import { type Database } from './supabase'; // Importem el gegant

// --- Ã€lies Generals ---
// Tipus per a una fila completa d'una taula o vista
export type DbTableRow<
Â  T extends keyof (Database['public']['Tables'] & Database['public']['Views'])
> = (Database['public']['Tables'] & Database['public']['Views'])[T]['Row'];

// Tipus per a una nova inserciÃ³
export type DbTableInsert<T extends keyof Database['public']['Tables']> =
Â  Database['public']['Tables'][T]['Insert'];

// Tipus per a una actualitzaciÃ³
export type DbTableUpdate<T extends keyof Database['public']['Tables']> =
Â  Database['public']['Tables'][T]['Update'];

// --- Ã€lies per a Funcions RPC ---
export type DbFunction<T extends keyof Database['public']['Functions']> =
Â  Database['public']['Functions'][T]['Returns'];

// --- Exportacions EspecÃ­fiques (Les mÃ©s usades) ---
export type Contact = DbTableRow<'contacts'>;
export type Opportunity = DbTableRow<'opportunities'>;
export type Invoice = DbTableRow<'invoices'>;
export type InvoiceItem = DbTableRow<'invoice_items'>; // âœ… AFEGIT (per a la lÃ²gica de syncInvoiceItems)
export type Profile = DbTableRow<'profiles'>;
export type Team = DbTableRow<'teams'>;
export type Product = DbTableRow<'products'>;
export type Quote = DbTableRow<'quotes'>;
export type Template = DbTableRow<'email_templates'>;
export type Activity = DbTableRow<'activities'>;
export type Task = DbTableRow<'tasks'>; // âœ… Canviat 'Tables' per 'Task' per claredat

// --- TIPUS ESPECÃFICS PER A L'INBOX ---
export type EnrichedTicket = DbTableRow<'enriched_tickets'>;
export type TeamMemberWithProfile = DbTableRow<'team_members_with_profiles'>;
export type InboxPermission = DbTableRow<'inbox_permissions'>;
export type Ticket = DbTableRow<'tickets'>;

// --- TIPUS ESPECÃFICS PER A COMUNICACIÃ“ ---
export type SocialPost = DbTableRow<'social_posts'>;
export type AudioJob = DbTableRow<'audio_jobs'>; // âœ… AFEGIT

// Aquest tipus Ã©s especÃ­fic per a una funciÃ³ de lectura.
// Idealment, mou-ho a src/types/db.ts o similar.
export type TicketForSupplier = Database['public']['Tables']['tickets']['Row'] & {
Â  contacts: {
Â  Â  id: number;
Â  Â  nom: string | null;
Â  Â  email: string | null;
Â  } | null;
};

export type Department = DbTableRow<'departments'>;
export type EmailTemplate = DbTableRow<'email_templates'>;
export type Supplier = DbTableRow<'suppliers'>;

// --- Tipus d'Enums ---
export type InvoiceStatus = Database['public']['Enums']['invoice_status'];
export type OpportunityStage = Database['public']['Enums']['opportunity_stage'];
export type AudioJobStatus = Database['public']['Enums']['audio_job_status']; // âœ… AFEGIT

// Aquest tipus Ã©s local de la UI, estÃ  bÃ© mantenir-lo aquÃ­.
export type TicketFilter = 'tots' | 'rebuts' | 'noLlegits' | 'enviats';

export type ContactForSupplier = Contact & {
  supplier?: Pick<Supplier, "id" | "nom" | "email"> | null;
};



// =================== FILE: src/types/declarations/mapbox.d.ts ===================

// mapbox.d.ts

declare module '@mapbox/search-js-react' {
    import * as React from 'react';
    import type { Geometry } from 'geojson'; // Tipus oficial GeoJSON
  
    export type MapboxContext = {
      id: string;
      name: string;
    };
  
    export type MapboxFeature = {
      geometry: Geometry; // âœ… SubstituÃ¯m 'any' per GeoJSON.Geometry
      properties: {
        address: string;
        context?: MapboxContext[];
      };
    };
  
    export type MapboxRetrieveResponse = {
      features: MapboxFeature[];
    };
  
    export interface AddressAutofillProps {
      accessToken: string;
      onRetrieve?: (res: MapboxRetrieveResponse) => void;
      children?: React.ReactNode;
    }
  
    export const AddressAutofill: React.FC<AddressAutofillProps>;
  }
  

// =================== FILE: src/types/declarations/prism.d.ts ===================

// src/types/prism.d.ts

declare module 'prismjs/components/prism-core';
declare module 'prismjs/components/prism-clike';
declare module 'prismjs/components/prism-javascript';
declare module 'prismjs/components/prism-markup';

// =================== FILE: src/types/declarations.d.ts ===================

// src/types/declarations.d.ts
declare module 'imap-simple';

// =================== FILE: src/types/finances/expenses.ts ===================

// src/types/finances/expenses.ts (VersiÃ³ consolidada i tipada)

import type { Contact } from "@/types/db"; 
// import { Database } from '@/types/supabase'; // Si l'SDK ho genera automÃ ticament

// --- 1. Tipus d'Elements (Basats en les teves definicions) ---

export type ExpenseItem = {
    id?: number; // bigint (opcional per a la creaciÃ³, present per a l'actualitzaciÃ³)
    expense_id: number; // Clau forana, afegida aquÃ­ per claredat en la sincronitzaciÃ³
    description: string;
    quantity: number;
    unit_price: number;
    total: number; // Afegit per consistÃ¨ncia amb el cÃ lcul
};

export type ExpenseAttachment = {
    id: string; // UUID de l'adjunt
    file_path: string;
    filename: string;
    mime_type: string;
    expense_id: number;
};

// --- 2. Tipus Base de Despesa (Taula `expenses`) ---

// âœ… NOU: Definim el tipus per a l'estat de la despesa, basat en l'ENUM de la DB
export type ExpenseStatus = 'pending' | 'paid' | 'overdue' | 'cancelled';

export interface Expense {
    id: number;
    user_id: string;
    team_id: string;
    description: string;
    total_amount: number;
    expense_date: string; // format YYYY-MM-DD
    category: string | null;
    created_at: string;
    invoice_number: string | null;
    tax_amount: number | null;
    subtotal: number | null;
    discount_amount: number | null;
    notes: string | null;
    tax_rate: number | null;
    supplier_id: string | null;
    
    // âœ… NOU: Camps afegits
    status: ExpenseStatus;
    payment_date: string | null; // format YYYY-MM-DD
    payment_method: string | null;
    is_billable: boolean;
    project_id: string | null;
    is_reimbursable: boolean;
}
// --- 3. Tipus Compostos (per a les vistes i accions) ---

// Tipus usat a la llista (nomÃ©s amb el nom del proveÃ¯dor)
export type ExpenseWithContact = Expense & {
    suppliers: Pick<Contact, 'id' | 'nom'> | null; 
};

// Tipus per a la vista de detall (totes les dades relacionals)
export type ExpenseDetail = ExpenseWithContact & {
    suppliers: Pick<Contact, 'id' | 'nom'> | null; // Tipus de detall del proveÃ¯dor
    expense_items: ExpenseItem[];
    expense_attachments: ExpenseAttachment[];
};


// Tipus que s'envia a `saveExpenseAction`
// Exclou camps de DB auto-generats/gestionats per la sessiÃ³ (user_id, team_id, created_at)
// Exclou camps de relaciÃ³ que no van a la taula principal (suppliers, attachments)
export type ExpenseFormDataForAction = Omit<
  Expense,
  'id' | 'created_at' | 'user_id' | 'team_id' | 'suppliers' // 'suppliers' s'elimina
> & {
    id?: string | number | null; // L'ID pot ser opcional o string/number
    expense_items?: ExpenseItem[]; // Els Ã­tems venen separats
};


// Mapeig d'Estatus de Despeses (configuraciÃ³ d'UI, utilitzat a ExpensesClient)
export const EXPENSE_STATUS_MAP = [
    { dbValue: 'pending', key: 'pending', colorClass: 'bg-yellow-100' },
    { dbValue: 'paid', key: 'paid', colorClass: 'bg-green-600' },
    { dbValue: 'reimbursed', key: 'reimbursed', colorClass: 'bg-blue-100' },
    { dbValue: 'rejected', key: 'rejected', colorClass: 'bg-red-600' },
];

// =================== FILE: src/types/finances/index.ts ===================

export * from './invoices';
export * from './expenses';
export * from './scheams';
export * from './suppliers';
export * from './products';


// =================== FILE: src/types/finances/invoices.ts ===================

// src/types/finances/invoices.ts
import { type Database } from '@/types/supabase';
import type { InvoiceStatus } from "@/config/invoices";
export type {
  InvoiceStatus
} from "@/config/invoices"; 
// --- Tipus Base (Reflectint Supabase - S'actualitzaran amb 'npx supabase gen types...') ---
export type InvoiceRow = Database['public']['Tables']['invoices']['Row'];
export type InvoiceItemRow = Database['public']['Tables']['invoice_items']['Row'];
export type InvoiceAttachmentRow = Database['public']['Tables']['invoice_attachments']['Row'];
// --- Constants i Tipus per a Status ---



// --- Tipus Enriquits ---

// LÃ­nia de factura - Ara inclou els nous camps
export interface InvoiceItem extends InvoiceItemRow {
    // InvoiceItemRow ja tÃ© id: string (UUID), product_id: number | null, etc.
    // NomÃ©s afegim/modifiquem si Ã©s estrictament necessari per a la UI
    // âœ… CORRECCIÃ“: Assegurem que els tipus opcionals coincideixen amb InvoiceItemRow (probablement number | null)
    discount_percentage: number | null; // Assegurem que no Ã©s undefined si InvoiceItemRow no ho permet
    discount_amount: number | null; // Assegurem que no Ã©s undefined si InvoiceItemRow no ho permet
    reference_sku: string | null; // Ja Ã©s string | null a InvoiceItemRow
}

// Adjunt de factura
export interface InvoiceAttachment extends InvoiceAttachmentRow {
  // L'ID Ã©s UUID (string)
  id: string;
}

// Contacte relacionat (si fas servir contact_id com a FK)
// L'ID a la taula contacts Ã©s bigint (number)
export type RelatedContact = {
  id: number;
  nom: string | null;
  // Afegeix altres camps si cal (nif, email...)
} | null; // Permetem null si no hi ha contacte vinculat

// Factura completa per a la vista de detall - Ara inclou els nous camps de InvoiceRow
export interface InvoiceDetail extends InvoiceRow {
    // InvoiceRow ja tÃ© id: number (bigint), contact_id: number | null, etc.
    // âœ… CORRECCIÃ“: project_id ara Ã©s string | null (UUID)
    project_id: string | null; // InvoiceRow tÃ© UUID, que Ã©s string | null
    invoice_items: InvoiceItem[];
    invoice_attachments: InvoiceAttachment[];
    contacts?: RelatedContact; // MantÃ© la relaciÃ³ opcional
    // Els altres nous camps (terms, currency, etc.) venen d'InvoiceRow
}
// --- Tipus per a Formularis i Accions ---

// Tipus per a l'estat del formulari del client
// Ometem IDs/timestamps/camps de servidor/Verifactu.
// Mantenim camps calculats (totals) perquÃ¨ la UI els necessita.
// Tipus per a l'estat del formulari del client
// Inclou els nous camps editables. Ometem timestamps especÃ­fics com paid_at, sent_at
// Tipus per a l'estat del formulari del client
export interface InvoiceFormData extends Omit < InvoiceRow,
    'id' |
    'created_at' | 'updated_at' | 'user_id' | 'team_id' |
    'verifactu_uuid' | 'verifactu_qr_data' | 'verifactu_signature' | 'verifactu_previous_signature' |
    'paid_at' | 'sent_at' |
    'invoice_items' |
    'invoice_attachments' |
    // Excloem camps calculats que no es guarden directament des del formulari base
    'subtotal' | 'tax_amount' | 'total_amount'
    > {
    // Redefinim camps necessaris per al formulari amb tipus especÃ­fics o opcionalitat
    id?: number; // Permetem ID opcional (bigint Ã©s number)
    invoice_items: InvoiceItem[];
    status: InvoiceStatus; // Usem el tipus estricte per al formulari
    issue_date: string; // Format YYYY-MM-DD
    due_date: string | null; // Format YYYY-MM-DD
    contact_id: number | null; // bigint Ã©s number
    budget_id: number | null; // bigint Ã©s number
    quote_id: number | null; // bigint Ã©s number
    // âœ… CORRECCIÃ“: project_id Ã©s string | null
    project_id: string | null; // UUID Ã©s string
    // Camps per a l'ediciÃ³/cÃ lcul a la UI
    discount_amount: number; // Descompte GENERAL (number, no null)
    tax_rate: number; // Taxa GENERAL (number, no null)
    shipping_cost: number; // Cost enviament (number, no null)
    // Camps calculats (necessaris per a la UI, perÃ² exclosos de l'Omit base)
    subtotal: number;
    tax_amount: number;
    total_amount: number;
    // La resta de camps de InvoiceRow (terms, currency, language, etc.)
    // heretats via Omit haurien de tenir el tipus correcte (string | null, string, etc.)
    // âœ… CORRECCIÃ“: Assegurem que els camps que poden ser null a InvoiceRow tambÃ© ho puguin ser aquÃ­
    terms: string | null;
    currency: string; // A la BD Ã©s NOT NULL
    language: string; // A la BD Ã©s NOT NULL
    payment_details: string | null;
    company_logo_url: string | null; // Assegurem que coincideix (string | null)
    client_reference: string | null;
    // tax i discount (de InvoiceRow) sÃ³n number | null
    tax: number | null;
    discount: number | null;
    // Camps denormalitzats (sÃ³n string | null a InvoiceRow)
    client_name: string | null;
    client_tax_id: string | null;
    client_address: string | null;
    client_email: string | null;
    company_name: string | null;
    company_tax_id: string | null;
    company_address: string | null;
    company_email: string | null;
    // extra_data (jsonb | null)
    extra_data: Database['public']['Tables']['invoices']['Row']['extra_data'];
}

// Dades que s'envien a l'acciÃ³ saveInvoiceAction
// Excloem camps calculats, IDs, timestamps, camps nomÃ©s lectura, etc.
export type InvoiceFormDataForAction = Omit < InvoiceFormData,
    'id' | 'invoice_items' |
    // 'created_at' | 'updated_at' | 'user_id' | 'team_id' | // Ja exclosos per Omit base
    'subtotal' | 'tax_amount' | 'total_amount' | // Es recalculen al servidor
    // 'verifactu_uuid' | ... | // Ja exclosos
    // 'paid_at' | 'sent_at' | // Ja exclosos
    // Camps denormalitzats (s'omplen al servidor si cal)
    'client_name' | 'client_tax_id' | 'client_address' | 'client_email' |
    'company_name' | 'company_tax_id' | 'company_address' | 'company_email'
    // company_logo_url podria venir d'un altre lloc (configuraciÃ³ d'empresa)
    // tax/discount sÃ³n redundants si ja tenim rate/amount
    // 'tax' | 'discount'
>;


// --- Tipus per a Llistes i Filtres ---

// Columnes seleccionades per a la taula de llista
// Inclou camps de 'invoices' i opcionalment 'contacts.nom'
export type InvoiceListRow = Pick<InvoiceRow,
    'id' | 'invoice_number' | 'issue_date' | 'due_date' | 'total_amount' | 'status' | 'client_name' | 'contact_id'
> & {
    // RelaciÃ³ opcional per mostrar el nom del contacte si fas JOIN
     contacts?: { nom: string | null } | null
};

// Resposta paginada per a l'acciÃ³ fetchPaginatedInvoices
export interface PaginatedInvoicesResponse {
  data: InvoiceListRow[];
  count: number;
}

// Filtres per a l'acciÃ³ fetchPaginatedInvoices
export interface InvoiceFilters {
  searchTerm?: string;
  status?: InvoiceStatus | 'all';
  contactId?: number | 'all'; // bigint Ã©s number
   // âœ… Corregit: sortBy hauria d'incloure els nous camps si vols ordenar per ells
   //    i ajustar-se als tipus reals (project_id Ã©s string, etc.)
  sortBy?: keyof Pick<InvoiceRow, 'invoice_number' | 'issue_date' | 'due_date' | 'total_amount' | 'status' | 'client_name' | 'currency' /* afegeix mÃ©s si cal */ > | 'contacts.nom';
  sortOrder?: 'asc' | 'desc';
  limit?: number;
  offset?: number;
}

// =================== FILE: src/types/finances/products.ts ===================

// Ja no necessitem definir el tipus 'Product' aquÃ­, ja que ve del fitxer central.
// âœ… AFEGEIX L'EXPORTACIÃ“ DELS TIPUS AQUÃ
export type Product = {
  id: number;
  name: string;
  price: number;
  description: string | null;
  category: string | null;
  unit: string | null;
  iva: number | null;
  discount: number | null; // Ã‰s una bona idea incloure tots els camps possibles
  is_active: boolean;
};

// =================== FILE: src/types/finances/quotes.ts ===================

// src/types/finances/quotes.ts
// (O src/types/crm/quotes.ts, depenent d'on el posis. Assegura't que l'import al service coincideixi)

import { type Database, type Tables } from '@/types/supabase';
import { type PaginatedResponse } from '@/hooks/usePaginateResource'; // âœ… Assegura't que aquÃ­ posa 'from'

// --- Tipus Base (Font de la Veritat) ---
export type Quote = Tables<'quotes'>;
export type QuoteId = Quote["id"];
export type QuoteStatus = Database["public"]["Enums"]["quote_status"]; 
export type QuoteRow = Database['public']['Tables']['quotes']['Row'];
export type ContactRow = Database['public']['Tables']['contacts']['Row'];
export type TeamRow = Database['public']['Tables']['teams']['Row'];

// --- Tipus de la FunciÃ³ RPC (Contracte Manual) ---
// Aquest Ã©s el tipus que la BD retorna de la funciÃ³ 'search_paginated_quotes'
// INCLOU camps de la taula 'quotes' + camps extra (currency, language, joins, etc.)
export interface RpcQuoteRow {
  id: QuoteId;
  quote_number: string | null;
  issue_date: string;
  expiry_date: string | null;
  total: number | null;
  status: QuoteStatus;
  contact_id: number | null;
  currency: string | null; // âœ… Aquest camp NO estÃ  a Tables<'quotes'>
  terms: string | null; // âœ… Aquest camp NO estÃ  a Tables<'quotes'>
  language: string | null; // âœ… Aquest camp NO estÃ  a Tables<'quotes'>
  created_at: string;
  updated_at: string | null;
  subtotal: number | null;
  tax_percent: number | null;
  show_quantity: boolean | null;
  discount: number | null;
  tax: number | null;
  opportunity_id: number | null;
  send_at: string | null;
  secure_id: string | null;
  sent_at: string | null;
  notes: string | null;
  rejection_reason: string | null;
  theme_color: string | null;
  sequence_number: number | null;
  user_id: string;
  team_id: string;
  verifactu_uuid: string | null;
  
  // Camps del JOIN
  contact_nom: string | null;
  contact_empresa: string | null;
  
  // Camp Calculat
  total_count: number;
}

// --- Tipus Enriquit per la UI (El "View Model") ---
// Aquest Ã©s el tipus que el client (QuotesClient) espera.
// Ã‰s el resultat de 'mapRpcRowToQuote'.
// Fem servir Omit per treure els camps del contacte (que re-mapejarem) i el comptador.
export type QuoteWithContact = Omit<RpcQuoteRow, 'contact_nom' | 'contact_empresa' | 'total_count'> & {
  contacts: {
    id: number;
    nom: string;
    empresa: string | null;
  } | null;
};

// --- Tipus per a Filtres i PaginaciÃ³ ---
export interface QuotePageFilters {
  status: QuoteStatus | "all";
}
export type PaginatedQuotesData = PaginatedResponse<QuoteWithContact>;



// --- Tipus addicionals per a l'Editor [id] ---

export type QuoteItem = Tables<'quote_items'>;
export type Product = Tables<'products'>;
export type Team = Tables<'teams'>;
export type Opportunity = Tables<'opportunities'>;
export type Contact = Tables<'contacts'>;

/**
 * El payload que la RPC 'upsert_quote_with_items' espera.
 * Definit a 'actions.ts'
 */
export type QuotePayload = Partial<Omit<Quote, "id">> & {
  id: "new" | number;
  items: Partial<QuoteItem>[];
};

/**
 * El tipus de dades que retorna la RPC 'get_quote_details'
 * Definit a 'QuoteEditorData.tsx'
 */
export type QuoteDetailsResponse = {
  quote: (Quote & { items: QuoteItem[] }) | null; // Pot ser null si no es troba
  opportunities: Opportunity[];
}

/**
 * Tipus per a un nou pressupost que encara no tÃ© ID a la BD
 * Definit a 'QuoteEditorData.tsx'
 */
export type NewQuote = Omit<Quote, 'id'> & { id: 'new'; items: Partial<QuoteItem>[] };

/**
 * Tipus uniÃ³ per al pressupost inicial (nou o existent)
 * Definit a 'QuoteEditorData.tsx'
 */
export type InitialQuoteType = (Quote & { items: QuoteItem[] }) | NewQuote;

/**
 * Tipus de dades agregades que el servei 'getQuoteEditorData' retornarÃ 
 * al Server Component 'QuoteEditorData.tsx'.
 */
export type QuoteEditorDataPayload = {
    initialQuote: InitialQuoteType;
    contacts: Contact[];
    products: Product[];
    companyProfile: Team | null;
    initialOpportunities: Opportunity[];
    pdfUrl: string | null;
}

/**
 * Aquest Ã©s el tipus de dades que passem del servidor al client
 * a la pÃ gina PÃšBLICA del pressupost.
 */
export type QuoteDataFromServer = QuoteRow & {
  contacts: ContactRow | null;  // 'contacts' (en minÃºscula)
  team: TeamRow | null;         // 'team' (en minÃºscula)
  items: QuoteItem[];           // 'items' (en lloc de 'quote_items')
};



// =================== FILE: src/types/finances/scheams.ts ===================

import { z } from 'zod';

// Definim aquÃ­ els esquemes, que seran la nostra font de veritat

export const expenseItemSchema = z.object({
  description: z.string().min(1, "La descripciÃ³ de l'Ã­tem Ã©s necessÃ ria."),
  quantity: z.number().min(0),
  unit_price: z.number().min(0),
  total: z.number().min(0),
});

export const expenseSchema = z.object({
  description: z.string().min(3, "La descripciÃ³ ha de tenir almenys 3 carÃ cters."),
  total_amount: z.number().positive("L'import total ha de ser un nÃºmero positiu."),
  expense_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, "El format de la data ha de ser AAAA-MM-DD."),
  supplier_id: z.string().uuid("L'ID del proveÃ¯dor no Ã©s vÃ lid.").optional().nullable(),
  category: z.string().optional().nullable(),
  invoice_number: z.string().optional().nullable(),
  tax_amount: z.number().min(0).optional().nullable(),
  subtotal: z.number().min(0).optional().nullable(),
  discount_amount: z.number().min(0).optional().nullable(),
  notes: z.string().optional().nullable(),
  tax_rate: z.number().min(0).optional().nullable(),
  extra_data: z.any().optional().nullable(),
  expense_items: z.array(expenseItemSchema).optional(),
});

// Definim el tipus de TypeScript a partir de l'esquema per poder-lo reutilitzar
export type ExpenseFormData = z.infer<typeof expenseSchema>;

// =================== FILE: src/types/finances/suppliers.ts ===================

// src/types/finances/suppliers.ts

/**
 * Representa l'estructura completa d'un proveÃ¯dor, tal com estÃ  a la base de dades.
 */
export interface Supplier {
  id: string; // Correspon al tipus 'uuid' de Supabase
  user_id: string;
  team_id: string;
  nom: string;
  email?: string | null;
  telefon?: string | null;
  nif?: string | null;
  created_at: string; // Correspon al tipus 'timestamp with time zone'
}

/**
 * Un tipus mÃ©s simple per a llistes o selectors, per optimitzar les dades que es transfereixen.
 */
export type SupplierForSelector = Pick<Supplier, 'id' | 'nom'>;

// =================== FILE: src/types/network/network.ts ===================

// types/network.ts
export interface PublicProfile {
  id: string;
  full_name: string | null; // âœ… AFEGIT: Camp que faltava
  company_name: string;
  logo_url: string | null;
  summary: string | null;
  services: string[] | null;
  website_url: string | null;
  latitude: number;
  longitude: number;
}

// =================== FILE: src/types/settings/blackListRule.ts ===================

/**
 * Defineix l'estructura d'una regla de la llista negra (blacklist)
 * tal com es guarda a la base de dades i s'utilitza a l'aplicaciÃ³.
 */
export type BlacklistRule = {
  id: string;
  value: string;
  rule_type: 'email' | 'domain';
  created_at: string;
  user_id: string; // ID de l'usuari que va crear la regla
  team_id: string; // ID de l'equip al qual pertany la regla
};


// =================== FILE: src/types/settings/index.ts ===================


export * from './profiles';
export * from './team';
export * from './subscription';
export * from './blackListRule';

// =================== FILE: src/types/settings/profiles.ts ===================

// Definim un tipus de dades estricte per a l'entrada de la funciÃ³
export type ProfileData = {
    full_name: string;
    company_name: string;
    summary: string;
    company_phone: string;
    services: string[];
    street: string;
    city: string;
    postal_code: string;
    region: string;
    country: string;
    latitude?: number;
    longitude?: number;
};

export type Profile = {
    id: string; // Coincideix amb auth.users.id
    full_name: string | null;
    phone: string | null;
    avatar_url: string | null;
    job_title: string | null;
    onboarding_completed: boolean;
};

// =================== FILE: src/types/settings/subscription.ts ===================

// /src/types/crm.ts (o on tinguis els teus tipus centrals)

/**
 * Representa les propietats VISUALS d'un pla de preus.
 * Aquesta Ã©s la informaciÃ³ que es mostra a la interfÃ­cie.
 */
export type Plan = {
    id: string; // Ex: 'free', 'plus', 'premium'
    name: string;
    iconName: string;
    priceMonthly: number | null;
    priceYearly: number | null;
    description: string;
    features: string[];
    isPopular?: boolean;
    isCurrent?: boolean; // Aquesta propietat s'afegeix dinÃ micament
    colors: { border: string; text: string; bg: string; hoverBg: string; }
};

/**
 * Representa la subscripciÃ³ d'un EQUIP guardada a la base de dades.
 */
export type Subscription = {
    id: string;
    team_id: string;
    plan_id: string;
    status: 'active' | 'trialing' | 'canceled';
    current_period_end: string; // Data en format ISO string
    // ... altres camps de Stripe si els tens
};

// âœ… Defineix i exporta el tipus PlanConfig
export type PlanConfig = {
    id: string;
    name: string;
    iconName: string;
    priceMonthly: number | null;
    priceYearly: number | null;
    isPopular?: boolean; // Opcional, ja que no tots els plans ho tenen
    colors: {
        border: string;
        text: string;
        bg: string;
        hoverBg: string;
    };
};



// =================== FILE: src/types/settings/team.ts ===================

import { Profile } from "./profiles";

/**
 * Representa les dades d'una EMPRESA o EQUIP.
 * Aquesta informaciÃ³ es mostra a factures, pressupostos, etc.
 */
export type Team = {
    id: string; // UUID de l'equip
    name: string; // Nom de l'empresa
    owner_id: string; // Qui Ã©s el propietari
    
    // Dades de contacte i fiscals
    tax_id: string | null;
    address: string | null;
    phone: string | null;
    email: string | null;
    website: string | null;
    logo_url: string | null;

    // Dades descriptives
    summary: string | null;
    sector: string | null;
    services: string[] | null; // Guardat com a JSONB a la base de dades

    // Dades d'adreÃ§a estructurada (si les tens separades)
    street?: string | null;
    city?: string | null;
    postal_code?: string | null;
    region?: string | null;
    country?: string | null;
    
    // GeolocalitzaciÃ³
    latitude: number | null;
    longitude: number | null;
};

/**
 * Representa la relaciÃ³ entre un usuari i un equip.
 * Aquest tipus s'utilitza quan carreguem la llista de membres.
 */
export type TeamMember = {
    role: 'owner' | 'admin' | 'member';
    // Quan fem una consulta, podem incloure el perfil complet de l'usuari
    profiles: Pick<Profile, 'id' | 'full_name'> & { email: string | null };
};

/**
 * Representa una invitaciÃ³ pendent.
 */
export type Invitation = {
    id: string;
    email: string;
    role: string;
};

// Aquest tipus representa les dades tal com venen de la taula 'teams' de Supabase
export type TeamData = {
    id: string;
    name: string | null;
    tax_id: string | null;
    address: string | null;
    phone: string | null;
    email: string | null;
    logo_url: string | null;
    // afegeix altres camps de la taula 'teams' que necessitis
};

// Aquest tipus representa les dades tal com les esperen els components de React.
// Ã‰s el format que volem obtenir DESPRÃ‰S de mapejar les dades de 'teams'.
export type CompanyProfile = {
    id: string;
    user_id?: string; // El fem opcional per si no sempre hi Ã©s
    company_name: string | null;
    company_tax_id: string | null;
    company_address: string | null;
    company_email: string | null;
    company_phone: string | null;
    logo_url: string | null;
};

// =================== FILE: src/types/shared/actionResult.ts ===================

// En un fitxer de tipus compartit, com src/types/shared/index.ts

export type ActionResult<T = unknown> = {
    success: boolean;
    message?: string;
    data?: T; // <-- AquÃ­ estÃ  la clau. 'T' serÃ  el tipus de les dades que retornem.
};

// =================== FILE: src/types/shared/address.ts ===================

export interface DetailedAddress {
  street: string;
  city: string;
  postcode: string;
  region: string;
  country: string;
  latitude: number | null;
  longitude: number | null;
}


// =================== FILE: src/types/shared/index.ts ===================

export * from './address';
export * from './notification';
export * from './actionResult';



// =================== FILE: src/types/shared/nextPageProps.ts ===================

// src/types/shared/next-page-props.ts

/**
 * Defineix les propietats estÃ ndard que reben
 * els components de pÃ gina (page.tsx) a Next.js (App Router).
 */
export type PageProps = {
  /**
   * ParÃ metres de ruta dinÃ mica.
   * Per a una ruta /product/[id], 'params' seria { id: '...' }
   */
  params: { [key: string]: string };

  /**
   * ParÃ metres de cerca de la URL (query string).
   * Per a una ruta /products?q=test&page=2,
   * 'searchParams' seria { q: 'test', page: '2' }
   */
  searchParams: { [key: string]: string | string[] | undefined };
};

// =================== FILE: src/types/shared/notification.ts ===================

export interface CrmNotification { // âœ… Nom canviat
    id: number;
    user_id: string;
    message: string;
    type?: string;
    is_read: boolean;
    created_at: string;
  }

// =================== FILE: src/types/supabase.ts ===================

export type Json =
  | string
  | number
  | boolean
  | null
  | { [key: string]: Json | undefined }
  | Json[]

export type Database = {
  // Allows to automatically instantiate createClient with right options
  // instead of createClient<Database, { PostgrestVersion: 'XX' }>(URL, KEY)
  __InternalSupabase: {
    PostgrestVersion: "12.2.12 (cd3cf9e)"
  }
  graphql_public: {
    Tables: {
      [_ in never]: never
    }
    Views: {
      [_ in never]: never
    }
    Functions: {
      graphql: {
        Args: {
          extensions?: Json
          operationName?: string
          query?: string
          variables?: Json
        }
        Returns: Json
      }
    }
    Enums: {
      [_ in never]: never
    }
    CompositeTypes: {
      [_ in never]: never
    }
  }
  public: {
    Tables: {
      activities: {
        Row: {
          contact_id: number | null
          content: string
          created_at: string | null
          id: number
          is_read: boolean | null
          opportunity_id: number | null
          quote_id: number | null
          team_id: string | null
          type: string
          user_id: string | null
        }
        Insert: {
          contact_id?: number | null
          content: string
          created_at?: string | null
          id?: never
          is_read?: boolean | null
          opportunity_id?: number | null
          quote_id?: number | null
          team_id?: string | null
          type: string
          user_id?: string | null
        }
        Update: {
          contact_id?: number | null
          content?: string
          created_at?: string | null
          id?: never
          is_read?: boolean | null
          opportunity_id?: number | null
          quote_id?: number | null
          team_id?: string | null
          type?: string
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "activities_contact_id_fkey"
            columns: ["contact_id"]
            isOneToOne: false
            referencedRelation: "contacts"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "activities_opportunity_id_fkey"
            columns: ["opportunity_id"]
            isOneToOne: false
            referencedRelation: "opportunities"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "activities_quote_id_fkey"
            columns: ["quote_id"]
            isOneToOne: false
            referencedRelation: "quotes"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "activities_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      audio_jobs: {
        Row: {
          created_at: string
          error_message: string | null
          id: string
          key_moments: Json | null
          participants: Json | null
          project_id: string | null
          status: Database["public"]["Enums"]["audio_job_status"]
          storage_path: string
          summary: string | null
          team_id: string
          transcription_text: string | null
          user_id: string
        }
        Insert: {
          created_at?: string
          error_message?: string | null
          id?: string
          key_moments?: Json | null
          participants?: Json | null
          project_id?: string | null
          status?: Database["public"]["Enums"]["audio_job_status"]
          storage_path: string
          summary?: string | null
          team_id: string
          transcription_text?: string | null
          user_id: string
        }
        Update: {
          created_at?: string
          error_message?: string | null
          id?: string
          key_moments?: Json | null
          participants?: Json | null
          project_id?: string | null
          status?: Database["public"]["Enums"]["audio_job_status"]
          storage_path?: string
          summary?: string | null
          team_id?: string
          transcription_text?: string | null
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "audio_jobs_project_id_fkey"
            columns: ["project_id"]
            isOneToOne: false
            referencedRelation: "projects"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "audio_jobs_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      blacklist_rules: {
        Row: {
          created_at: string
          id: number
          rule_type: string
          team_id: string | null
          user_id: string
          value: string
        }
        Insert: {
          created_at?: string
          id?: number
          rule_type: string
          team_id?: string | null
          user_id: string
          value: string
        }
        Update: {
          created_at?: string
          id?: number
          rule_type?: string
          team_id?: string | null
          user_id?: string
          value?: string
        }
        Relationships: [
          {
            foreignKeyName: "blacklist_rules_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      campaign_templates: {
        Row: {
          content: string | null
          created_at: string
          goal: string | null
          id: number
          name: string
          target_audience: string | null
          type: string | null
          user_id: string
        }
        Insert: {
          content?: string | null
          created_at?: string
          goal?: string | null
          id?: number
          name: string
          target_audience?: string | null
          type?: string | null
          user_id: string
        }
        Update: {
          content?: string | null
          created_at?: string
          goal?: string | null
          id?: number
          name?: string
          target_audience?: string | null
          type?: string | null
          user_id?: string
        }
        Relationships: []
      }
      campaigns: {
        Row: {
          campaign_date: string
          content: string | null
          created_at: string | null
          goal: string | null
          id: number
          metrics: Json | null
          name: string
          sent_at: string | null
          status: string | null
          subject: string | null
          target_audience: string | null
          team_id: string | null
          type: string
          user_id: string
        }
        Insert: {
          campaign_date: string
          content?: string | null
          created_at?: string | null
          goal?: string | null
          id?: number
          metrics?: Json | null
          name: string
          sent_at?: string | null
          status?: string | null
          subject?: string | null
          target_audience?: string | null
          team_id?: string | null
          type: string
          user_id: string
        }
        Update: {
          campaign_date?: string
          content?: string | null
          created_at?: string | null
          goal?: string | null
          id?: number
          metrics?: Json | null
          name?: string
          sent_at?: string | null
          status?: string | null
          subject?: string | null
          target_audience?: string | null
          team_id?: string | null
          type?: string
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "campaigns_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      contact_tags: {
        Row: {
          color: string | null
          created_at: string | null
          id: number
          name: string
          team_id: string | null
          user_id: string
        }
        Insert: {
          color?: string | null
          created_at?: string | null
          id?: number
          name: string
          team_id?: string | null
          user_id: string
        }
        Update: {
          color?: string | null
          created_at?: string | null
          id?: number
          name?: string
          team_id?: string | null
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "contact_tags_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      contacts: {
        Row: {
          address: Json | null
          birthday: string | null
          children_count: number | null
          created_at: string | null
          email: string
          empresa: string | null
          estat: string | null
          hobbies: string[] | null
          id: number
          industry: string | null
          job_title: string | null
          last_interaction_at: string | null
          lead_source: string | null
          marital_status: string | null
          nom: string
          notes: string | null
          partner_name: string | null
          social_media: Json | null
          supplier_id: string | null
          team_id: string | null
          telefon: string | null
          ubicacio: string | null
          ultim_contacte: string | null
          user_id: string | null
          valor: number | null
        }
        Insert: {
          address?: Json | null
          birthday?: string | null
          children_count?: number | null
          created_at?: string | null
          email: string
          empresa?: string | null
          estat?: string | null
          hobbies?: string[] | null
          id?: number
          industry?: string | null
          job_title?: string | null
          last_interaction_at?: string | null
          lead_source?: string | null
          marital_status?: string | null
          nom: string
          notes?: string | null
          partner_name?: string | null
          social_media?: Json | null
          supplier_id?: string | null
          team_id?: string | null
          telefon?: string | null
          ubicacio?: string | null
          ultim_contacte?: string | null
          user_id?: string | null
          valor?: number | null
        }
        Update: {
          address?: Json | null
          birthday?: string | null
          children_count?: number | null
          created_at?: string | null
          email?: string
          empresa?: string | null
          estat?: string | null
          hobbies?: string[] | null
          id?: number
          industry?: string | null
          job_title?: string | null
          last_interaction_at?: string | null
          lead_source?: string | null
          marital_status?: string | null
          nom?: string
          notes?: string | null
          partner_name?: string | null
          social_media?: Json | null
          supplier_id?: string | null
          team_id?: string | null
          telefon?: string | null
          ubicacio?: string | null
          ultim_contacte?: string | null
          user_id?: string | null
          valor?: number | null
        }
        Relationships: [
          {
            foreignKeyName: "contacts_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "fk_contact_supplier"
            columns: ["supplier_id"]
            isOneToOne: false
            referencedRelation: "suppliers"
            referencedColumns: ["id"]
          },
        ]
      }
      departments: {
        Row: {
          created_at: string | null
          id: number
          name: string
          team_id: string
        }
        Insert: {
          created_at?: string | null
          id?: never
          name: string
          team_id: string
        }
        Update: {
          created_at?: string | null
          id?: never
          name?: string
          team_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "departments_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      documents: {
        Row: {
          content: string | null
          embedding: string | null
          id: number
          metadata: Json | null
        }
        Insert: {
          content?: string | null
          embedding?: string | null
          id?: number
          metadata?: Json | null
        }
        Update: {
          content?: string | null
          embedding?: string | null
          id?: number
          metadata?: Json | null
        }
        Relationships: []
      }
      email_templates: {
        Row: {
          body: string | null
          created_at: string
          id: number
          name: string
          subject: string | null
          team_id: string | null
          user_id: string
          variables: Json | null
        }
        Insert: {
          body?: string | null
          created_at?: string
          id?: number
          name: string
          subject?: string | null
          team_id?: string | null
          user_id: string
          variables?: Json | null
        }
        Update: {
          body?: string | null
          created_at?: string
          id?: number
          name?: string
          subject?: string | null
          team_id?: string | null
          user_id?: string
          variables?: Json | null
        }
        Relationships: [
          {
            foreignKeyName: "email_templates_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      expense_attachments: {
        Row: {
          expense_id: number
          file_path: string
          filename: string
          id: string
          mime_type: string | null
          team_id: string | null
          uploaded_at: string | null
          user_id: string | null
        }
        Insert: {
          expense_id: number
          file_path: string
          filename: string
          id?: string
          mime_type?: string | null
          team_id?: string | null
          uploaded_at?: string | null
          user_id?: string | null
        }
        Update: {
          expense_id?: number
          file_path?: string
          filename?: string
          id?: string
          mime_type?: string | null
          team_id?: string | null
          uploaded_at?: string | null
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "expense_attachments_expense_id_fkey"
            columns: ["expense_id"]
            isOneToOne: false
            referencedRelation: "expenses"
            referencedColumns: ["id"]
          },
        ]
      }
      expense_items: {
        Row: {
          created_at: string | null
          description: string
          expense_id: number
          id: string
          quantity: number
          team_id: string | null
          total: number | null
          unit_price: number
          user_id: string | null
        }
        Insert: {
          created_at?: string | null
          description: string
          expense_id: number
          id?: string
          quantity?: number
          team_id?: string | null
          total?: number | null
          unit_price?: number
          user_id?: string | null
        }
        Update: {
          created_at?: string | null
          description?: string
          expense_id?: number
          id?: string
          quantity?: number
          team_id?: string | null
          total?: number | null
          unit_price?: number
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "expense_items_expense_id_fkey"
            columns: ["expense_id"]
            isOneToOne: false
            referencedRelation: "expenses"
            referencedColumns: ["id"]
          },
        ]
      }
      expenses: {
        Row: {
          category: string | null
          created_at: string
          description: string
          discount_amount: number | null
          expense_date: string
          extra_data: Json | null
          id: number
          invoice_number: string | null
          is_billable: boolean
          is_reimbursable: boolean
          notes: string | null
          payment_date: string | null
          payment_method: string | null
          project_id: string | null
          status: Database["public"]["Enums"]["expense_status"]
          subtotal: number | null
          supplier_id: string | null
          tax_amount: number | null
          tax_rate: number | null
          team_id: string | null
          total_amount: number
          user_id: string
        }
        Insert: {
          category?: string | null
          created_at?: string
          description: string
          discount_amount?: number | null
          expense_date: string
          extra_data?: Json | null
          id?: number
          invoice_number?: string | null
          is_billable?: boolean
          is_reimbursable?: boolean
          notes?: string | null
          payment_date?: string | null
          payment_method?: string | null
          project_id?: string | null
          status?: Database["public"]["Enums"]["expense_status"]
          subtotal?: number | null
          supplier_id?: string | null
          tax_amount?: number | null
          tax_rate?: number | null
          team_id?: string | null
          total_amount: number
          user_id: string
        }
        Update: {
          category?: string | null
          created_at?: string
          description?: string
          discount_amount?: number | null
          expense_date?: string
          extra_data?: Json | null
          id?: number
          invoice_number?: string | null
          is_billable?: boolean
          is_reimbursable?: boolean
          notes?: string | null
          payment_date?: string | null
          payment_method?: string | null
          project_id?: string | null
          status?: Database["public"]["Enums"]["expense_status"]
          subtotal?: number | null
          supplier_id?: string | null
          tax_amount?: number | null
          tax_rate?: number | null
          team_id?: string | null
          total_amount?: number
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "expenses_project_id_fkey"
            columns: ["project_id"]
            isOneToOne: false
            referencedRelation: "projects"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "expenses_supplier_id_fkey"
            columns: ["supplier_id"]
            isOneToOne: false
            referencedRelation: "suppliers"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "expenses_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      inbox_permissions: {
        Row: {
          created_at: string | null
          grantee_user_id: string
          id: string
          target_user_id: string
          team_id: string
        }
        Insert: {
          created_at?: string | null
          grantee_user_id: string
          id?: string
          target_user_id: string
          team_id: string
        }
        Update: {
          created_at?: string | null
          grantee_user_id?: string
          id?: string
          target_user_id?: string
          team_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "inbox_permissions_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      invitations: {
        Row: {
          created_at: string | null
          email: string
          id: string
          inviter_name: string | null
          role: string
          status: string | null
          team_id: string | null
          team_name: string | null
          token: string
          user_id: string | null
        }
        Insert: {
          created_at?: string | null
          email: string
          id?: string
          inviter_name?: string | null
          role: string
          status?: string | null
          team_id?: string | null
          team_name?: string | null
          token?: string
          user_id?: string | null
        }
        Update: {
          created_at?: string | null
          email?: string
          id?: string
          inviter_name?: string | null
          role?: string
          status?: string | null
          team_id?: string | null
          team_name?: string | null
          token?: string
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "invitations_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      invoice_attachments: {
        Row: {
          file_path: string
          filename: string
          id: string
          invoice_id: number
          mime_type: string | null
          uploaded_at: string | null
        }
        Insert: {
          file_path: string
          filename: string
          id?: string
          invoice_id: number
          mime_type?: string | null
          uploaded_at?: string | null
        }
        Update: {
          file_path?: string
          filename?: string
          id?: string
          invoice_id?: number
          mime_type?: string | null
          uploaded_at?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "invoice_attachments_invoice_id_fkey"
            columns: ["invoice_id"]
            isOneToOne: false
            referencedRelation: "invoices"
            referencedColumns: ["id"]
          },
        ]
      }
      invoice_deliveries: {
        Row: {
          delivered_at: string
          id: string
          invoice_id: number
          method: string
          recipient: string | null
          team_id: string
        }
        Insert: {
          delivered_at?: string
          id?: string
          invoice_id: number
          method: string
          recipient?: string | null
          team_id: string
        }
        Update: {
          delivered_at?: string
          id?: string
          invoice_id?: number
          method?: string
          recipient?: string | null
          team_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "invoice_deliveries_invoice_id_fkey"
            columns: ["invoice_id"]
            isOneToOne: false
            referencedRelation: "invoices"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "invoice_deliveries_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      invoice_items: {
        Row: {
          created_at: string | null
          description: string
          discount_amount: number | null
          discount_percentage: number | null
          id: string
          invoice_id: number
          product_id: number | null
          quantity: number
          reference_sku: string | null
          tax_rate: number | null
          team_id: string | null
          total: number | null
          unit_price: number
          user_id: string | null
        }
        Insert: {
          created_at?: string | null
          description: string
          discount_amount?: number | null
          discount_percentage?: number | null
          id?: string
          invoice_id: number
          product_id?: number | null
          quantity?: number
          reference_sku?: string | null
          tax_rate?: number | null
          team_id?: string | null
          total?: number | null
          unit_price?: number
          user_id?: string | null
        }
        Update: {
          created_at?: string | null
          description?: string
          discount_amount?: number | null
          discount_percentage?: number | null
          id?: string
          invoice_id?: number
          product_id?: number | null
          quantity?: number
          reference_sku?: string | null
          tax_rate?: number | null
          team_id?: string | null
          total?: number | null
          unit_price?: number
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "invoice_items_invoice_id_fkey"
            columns: ["invoice_id"]
            isOneToOne: false
            referencedRelation: "invoices"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "invoice_items_product_id_fkey"
            columns: ["product_id"]
            isOneToOne: false
            referencedRelation: "products"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "invoice_items_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      invoices: {
        Row: {
          budget_id: number | null
          client_address: string | null
          client_email: string | null
          client_name: string | null
          client_reference: string | null
          client_tax_id: string | null
          company_address: string | null
          company_email: string | null
          company_logo_url: string | null
          company_name: string | null
          company_tax_id: string | null
          contact_id: number | null
          created_at: string
          currency: string
          discount: number | null
          discount_amount: number | null
          due_date: string | null
          extra_data: Json | null
          id: number
          invoice_number: string | null
          issue_date: string
          language: string
          notes: string | null
          paid_at: string | null
          payment_details: string | null
          project_id: string | null
          quote_id: number | null
          sent_at: string | null
          shipping_cost: number | null
          status: string
          subtotal: number | null
          tax: number | null
          tax_amount: number | null
          tax_rate: number | null
          team_id: string | null
          terms: string | null
          total_amount: number
          updated_at: string | null
          user_id: string
          verifactu_previous_signature: string | null
          verifactu_qr_data: string | null
          verifactu_signature: string | null
          verifactu_uuid: string | null
        }
        Insert: {
          budget_id?: number | null
          client_address?: string | null
          client_email?: string | null
          client_name?: string | null
          client_reference?: string | null
          client_tax_id?: string | null
          company_address?: string | null
          company_email?: string | null
          company_logo_url?: string | null
          company_name?: string | null
          company_tax_id?: string | null
          contact_id?: number | null
          created_at?: string
          currency?: string
          discount?: number | null
          discount_amount?: number | null
          due_date?: string | null
          extra_data?: Json | null
          id?: number
          invoice_number?: string | null
          issue_date: string
          language?: string
          notes?: string | null
          paid_at?: string | null
          payment_details?: string | null
          project_id?: string | null
          quote_id?: number | null
          sent_at?: string | null
          shipping_cost?: number | null
          status: string
          subtotal?: number | null
          tax?: number | null
          tax_amount?: number | null
          tax_rate?: number | null
          team_id?: string | null
          terms?: string | null
          total_amount: number
          updated_at?: string | null
          user_id: string
          verifactu_previous_signature?: string | null
          verifactu_qr_data?: string | null
          verifactu_signature?: string | null
          verifactu_uuid?: string | null
        }
        Update: {
          budget_id?: number | null
          client_address?: string | null
          client_email?: string | null
          client_name?: string | null
          client_reference?: string | null
          client_tax_id?: string | null
          company_address?: string | null
          company_email?: string | null
          company_logo_url?: string | null
          company_name?: string | null
          company_tax_id?: string | null
          contact_id?: number | null
          created_at?: string
          currency?: string
          discount?: number | null
          discount_amount?: number | null
          due_date?: string | null
          extra_data?: Json | null
          id?: number
          invoice_number?: string | null
          issue_date?: string
          language?: string
          notes?: string | null
          paid_at?: string | null
          payment_details?: string | null
          project_id?: string | null
          quote_id?: number | null
          sent_at?: string | null
          shipping_cost?: number | null
          status?: string
          subtotal?: number | null
          tax?: number | null
          tax_amount?: number | null
          tax_rate?: number | null
          team_id?: string | null
          terms?: string | null
          total_amount?: number
          updated_at?: string | null
          user_id?: string
          verifactu_previous_signature?: string | null
          verifactu_qr_data?: string | null
          verifactu_signature?: string | null
          verifactu_uuid?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "fk_invoices_quote_id"
            columns: ["quote_id"]
            isOneToOne: false
            referencedRelation: "quotes"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "invoices_budget_id_fkey"
            columns: ["budget_id"]
            isOneToOne: false
            referencedRelation: "quotes"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "invoices_contact_id_fkey"
            columns: ["contact_id"]
            isOneToOne: false
            referencedRelation: "contacts"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "invoices_project_id_fkey"
            columns: ["project_id"]
            isOneToOne: false
            referencedRelation: "projects"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "invoices_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      job_postings: {
        Row: {
          address_text: string | null
          budget: number | null
          city: string | null
          country: string | null
          created_at: string
          description: string | null
          expires_at: string | null
          id: string
          latitude: number | null
          longitude: number | null
          postcode: string | null
          region: string | null
          required_skills: string[] | null
          status: Database["public"]["Enums"]["job_status"]
          team_id: string
          title: string
        }
        Insert: {
          address_text?: string | null
          budget?: number | null
          city?: string | null
          country?: string | null
          created_at?: string
          description?: string | null
          expires_at?: string | null
          id?: string
          latitude?: number | null
          longitude?: number | null
          postcode?: string | null
          region?: string | null
          required_skills?: string[] | null
          status?: Database["public"]["Enums"]["job_status"]
          team_id: string
          title: string
        }
        Update: {
          address_text?: string | null
          budget?: number | null
          city?: string | null
          country?: string | null
          created_at?: string
          description?: string | null
          expires_at?: string | null
          id?: string
          latitude?: number | null
          longitude?: number | null
          postcode?: string | null
          region?: string | null
          required_skills?: string[] | null
          status?: Database["public"]["Enums"]["job_status"]
          team_id?: string
          title?: string
        }
        Relationships: [
          {
            foreignKeyName: "job_postings_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      notifications: {
        Row: {
          created_at: string
          id: number
          is_read: boolean
          message: string
          type: string | null
          user_id: string
        }
        Insert: {
          created_at?: string
          id?: number
          is_read?: boolean
          message: string
          type?: string | null
          user_id: string
        }
        Update: {
          created_at?: string
          id?: number
          is_read?: boolean
          message?: string
          type?: string | null
          user_id?: string
        }
        Relationships: []
      }
      opportunities: {
        Row: {
          close_date: string | null
          contact_id: number | null
          created_at: string | null
          description: string | null
          id: number
          last_updated_at: string | null
          name: string
          pipeline_stage_id: number | null
          probability: number | null
          source: string | null
          stage_name: string | null
          team_id: string | null
          user_id: string
          value: number | null
        }
        Insert: {
          close_date?: string | null
          contact_id?: number | null
          created_at?: string | null
          description?: string | null
          id?: number
          last_updated_at?: string | null
          name: string
          pipeline_stage_id?: number | null
          probability?: number | null
          source?: string | null
          stage_name?: string | null
          team_id?: string | null
          user_id: string
          value?: number | null
        }
        Update: {
          close_date?: string | null
          contact_id?: number | null
          created_at?: string | null
          description?: string | null
          id?: number
          last_updated_at?: string | null
          name?: string
          pipeline_stage_id?: number | null
          probability?: number | null
          source?: string | null
          stage_name?: string | null
          team_id?: string | null
          user_id?: string
          value?: number | null
        }
        Relationships: [
          {
            foreignKeyName: "opportunities_contact_id_fkey"
            columns: ["contact_id"]
            isOneToOne: false
            referencedRelation: "contacts"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "opportunities_pipeline_stage_id_fkey"
            columns: ["pipeline_stage_id"]
            isOneToOne: false
            referencedRelation: "pipeline_stages"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "opportunities_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      pipeline_stages: {
        Row: {
          created_at: string | null
          id: number
          name: string
          position: number
          team_id: string | null
          user_id: string
        }
        Insert: {
          created_at?: string | null
          id?: number
          name: string
          position: number
          team_id?: string | null
          user_id: string
        }
        Update: {
          created_at?: string | null
          id?: number
          name?: string
          position?: number
          team_id?: string | null
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "pipeline_stages_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      prices: {
        Row: {
          active: boolean | null
          currency: string | null
          description: string | null
          id: string
          interval: string | null
          interval_count: number | null
          metadata: Json | null
          product_id: string | null
          trial_period_days: number | null
          type: string | null
          unit_amount: number | null
        }
        Insert: {
          active?: boolean | null
          currency?: string | null
          description?: string | null
          id: string
          interval?: string | null
          interval_count?: number | null
          metadata?: Json | null
          product_id?: string | null
          trial_period_days?: number | null
          type?: string | null
          unit_amount?: number | null
        }
        Update: {
          active?: boolean | null
          currency?: string | null
          description?: string | null
          id?: string
          interval?: string | null
          interval_count?: number | null
          metadata?: Json | null
          product_id?: string | null
          trial_period_days?: number | null
          type?: string | null
          unit_amount?: number | null
        }
        Relationships: []
      }
      products: {
        Row: {
          category: string | null
          created_at: string
          description: string | null
          discount: number | null
          id: number
          is_active: boolean
          iva: number | null
          name: string
          price: number
          team_id: string | null
          unit: string | null
          user_id: string
        }
        Insert: {
          category?: string | null
          created_at?: string
          description?: string | null
          discount?: number | null
          id?: number
          is_active?: boolean
          iva?: number | null
          name: string
          price: number
          team_id?: string | null
          unit?: string | null
          user_id: string
        }
        Update: {
          category?: string | null
          created_at?: string
          description?: string | null
          discount?: number | null
          id?: number
          is_active?: boolean
          iva?: number | null
          name?: string
          price?: number
          team_id?: string | null
          unit?: string | null
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "products_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      profiles: {
        Row: {
          active_team_id: string | null
          avatar_url: string | null
          billing_address: Json | null
          email: string | null
          full_name: string | null
          id: string
          is_public_profile: boolean | null
          job_title: string | null
          logo_url: string | null
          onboarding_completed: boolean
          payment_method: Json | null
          phone: string | null
          services: Json | null
          summary: string | null
          website_url: string | null
        }
        Insert: {
          active_team_id?: string | null
          avatar_url?: string | null
          billing_address?: Json | null
          email?: string | null
          full_name?: string | null
          id: string
          is_public_profile?: boolean | null
          job_title?: string | null
          logo_url?: string | null
          onboarding_completed?: boolean
          payment_method?: Json | null
          phone?: string | null
          services?: Json | null
          summary?: string | null
          website_url?: string | null
        }
        Update: {
          active_team_id?: string | null
          avatar_url?: string | null
          billing_address?: Json | null
          email?: string | null
          full_name?: string | null
          id?: string
          is_public_profile?: boolean | null
          job_title?: string | null
          logo_url?: string | null
          onboarding_completed?: boolean
          payment_method?: Json | null
          phone?: string | null
          services?: Json | null
          summary?: string | null
          website_url?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "profiles_active_team_id_fkey"
            columns: ["active_team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      project_layouts: {
        Row: {
          created_at: string
          id: number
          node_id: string
          position_x: number
          position_y: number
          user_id: string
        }
        Insert: {
          created_at?: string
          id?: number
          node_id: string
          position_x: number
          position_y: number
          user_id: string
        }
        Update: {
          created_at?: string
          id?: number
          node_id?: string
          position_x?: number
          position_y?: number
          user_id?: string
        }
        Relationships: []
      }
      projects: {
        Row: {
          created_at: string
          description: string | null
          end_date: string | null
          id: string
          name: string
          start_date: string | null
          status: string | null
          team_id: string
        }
        Insert: {
          created_at?: string
          description?: string | null
          end_date?: string | null
          id?: string
          name: string
          start_date?: string | null
          status?: string | null
          team_id: string
        }
        Update: {
          created_at?: string
          description?: string | null
          end_date?: string | null
          id?: string
          name?: string
          start_date?: string | null
          status?: string | null
          team_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "projects_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      quote_items: {
        Row: {
          description: string
          id: number
          product_id: number | null
          quantity: number
          quote_id: number
          team_id: string
          total: number
          unit_price: number
          user_id: string | null
        }
        Insert: {
          description: string
          id?: number
          product_id?: number | null
          quantity: number
          quote_id: number
          team_id: string
          total: number
          unit_price: number
          user_id?: string | null
        }
        Update: {
          description?: string
          id?: number
          product_id?: number | null
          quantity?: number
          quote_id?: number
          team_id?: string
          total?: number
          unit_price?: number
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "quote_items_product_id_fkey"
            columns: ["product_id"]
            isOneToOne: false
            referencedRelation: "products"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "quote_items_quote_id_fkey"
            columns: ["quote_id"]
            isOneToOne: false
            referencedRelation: "quotes"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "quote_items_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      quotes: {
        Row: {
          contact_id: number | null
          created_at: string | null
          discount: number | null
          expiry_date: string | null
          id: number
          issue_date: string
          notes: string | null
          opportunity_id: number | null
          quote_number: string
          rejection_reason: string | null
          secure_id: string
          send_at: string | null
          sent_at: string | null
          sequence_number: number | null
          show_quantity: boolean
          status: Database["public"]["Enums"]["quote_status"] | null
          subtotal: number
          tax: number | null
          tax_percent: number | null
          team_id: string | null
          theme_color: string | null
          total: number
          user_id: string
        }
        Insert: {
          contact_id?: number | null
          created_at?: string | null
          discount?: number | null
          expiry_date?: string | null
          id?: number
          issue_date: string
          notes?: string | null
          opportunity_id?: number | null
          quote_number: string
          rejection_reason?: string | null
          secure_id?: string
          send_at?: string | null
          sent_at?: string | null
          sequence_number?: number | null
          show_quantity?: boolean
          status?: Database["public"]["Enums"]["quote_status"] | null
          subtotal: number
          tax?: number | null
          tax_percent?: number | null
          team_id?: string | null
          theme_color?: string | null
          total: number
          user_id: string
        }
        Update: {
          contact_id?: number | null
          created_at?: string | null
          discount?: number | null
          expiry_date?: string | null
          id?: number
          issue_date?: string
          notes?: string | null
          opportunity_id?: number | null
          quote_number?: string
          rejection_reason?: string | null
          secure_id?: string
          send_at?: string | null
          sent_at?: string | null
          sequence_number?: number | null
          show_quantity?: boolean
          status?: Database["public"]["Enums"]["quote_status"] | null
          subtotal?: number
          tax?: number | null
          tax_percent?: number | null
          team_id?: string | null
          theme_color?: string | null
          total?: number
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "quotes_contact_id_fkey"
            columns: ["contact_id"]
            isOneToOne: false
            referencedRelation: "contacts"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "quotes_opportunity_id_fkey"
            columns: ["opportunity_id"]
            isOneToOne: false
            referencedRelation: "opportunities"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "quotes_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "quotes_user_id_fkey1"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "quotes_user_id_fkey1"
            columns: ["user_id"]
            isOneToOne: false
            referencedRelation: "team_members_with_profiles"
            referencedColumns: ["user_id"]
          },
        ]
      }
      services: {
        Row: {
          id: number
          name: string
        }
        Insert: {
          id?: never
          name: string
        }
        Update: {
          id?: never
          name?: string
        }
        Relationships: []
      }
      social_posts: {
        Row: {
          content: string | null
          created_at: string
          error_message: string | null
          id: number
          media_type: string | null
          media_url: string[] | null
          provider: string[]
          published_at: string | null
          scheduled_at: string | null
          status: string
          team_id: string | null
          updated_at: string
          user_id: string
        }
        Insert: {
          content?: string | null
          created_at?: string
          error_message?: string | null
          id?: number
          media_type?: string | null
          media_url?: string[] | null
          provider: string[]
          published_at?: string | null
          scheduled_at?: string | null
          status?: string
          team_id?: string | null
          updated_at?: string
          user_id: string
        }
        Update: {
          content?: string | null
          created_at?: string
          error_message?: string | null
          id?: number
          media_type?: string | null
          media_url?: string[] | null
          provider?: string[]
          published_at?: string | null
          scheduled_at?: string | null
          status?: string
          team_id?: string | null
          updated_at?: string
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "social_posts_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      spatial_ref_sys: {
        Row: {
          auth_name: string | null
          auth_srid: number | null
          proj4text: string | null
          srid: number
          srtext: string | null
        }
        Insert: {
          auth_name?: string | null
          auth_srid?: number | null
          proj4text?: string | null
          srid: number
          srtext?: string | null
        }
        Update: {
          auth_name?: string | null
          auth_srid?: number | null
          proj4text?: string | null
          srid?: number
          srtext?: string | null
        }
        Relationships: []
      }
      subscriptions: {
        Row: {
          created_at: string | null
          current_period_end: string | null
          id: string
          plan_id: string
          status: string
          stripe_customer_id: string | null
          stripe_subscription_id: string | null
          team_id: string
        }
        Insert: {
          created_at?: string | null
          current_period_end?: string | null
          id?: string
          plan_id: string
          status: string
          stripe_customer_id?: string | null
          stripe_subscription_id?: string | null
          team_id: string
        }
        Update: {
          created_at?: string | null
          current_period_end?: string | null
          id?: string
          plan_id?: string
          status?: string
          stripe_customer_id?: string | null
          stripe_subscription_id?: string | null
          team_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "subscriptions_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: true
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      suppliers: {
        Row: {
          created_at: string | null
          email: string | null
          id: string
          nif: string | null
          nom: string
          team_id: string | null
          telefon: string | null
          user_id: string
        }
        Insert: {
          created_at?: string | null
          email?: string | null
          id?: string
          nif?: string | null
          nom: string
          team_id?: string | null
          telefon?: string | null
          user_id: string
        }
        Update: {
          created_at?: string | null
          email?: string | null
          id?: string
          nif?: string | null
          nom?: string
          team_id?: string | null
          telefon?: string | null
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "suppliers_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      tasks: {
        Row: {
          asigned_date: string | null
          checklist_progress: Json | null
          contact_id: number | null
          created_at: string
          department_id: number | null
          description: string | null
          description_json: Json | null
          due_date: string | null
          duration: number | null
          finish_date: string | null
          google_calendar_id: string | null
          id: number
          is_active: boolean | null
          is_completed: boolean
          priority: Database["public"]["Enums"]["task_priority"] | null
          team_id: string | null
          time_tracking_log: Json | null
          title: string
          user_asign_id: string | null
          user_id: string
        }
        Insert: {
          asigned_date?: string | null
          checklist_progress?: Json | null
          contact_id?: number | null
          created_at?: string
          department_id?: number | null
          description?: string | null
          description_json?: Json | null
          due_date?: string | null
          duration?: number | null
          finish_date?: string | null
          google_calendar_id?: string | null
          id?: number
          is_active?: boolean | null
          is_completed?: boolean
          priority?: Database["public"]["Enums"]["task_priority"] | null
          team_id?: string | null
          time_tracking_log?: Json | null
          title: string
          user_asign_id?: string | null
          user_id: string
        }
        Update: {
          asigned_date?: string | null
          checklist_progress?: Json | null
          contact_id?: number | null
          created_at?: string
          department_id?: number | null
          description?: string | null
          description_json?: Json | null
          due_date?: string | null
          duration?: number | null
          finish_date?: string | null
          google_calendar_id?: string | null
          id?: number
          is_active?: boolean | null
          is_completed?: boolean
          priority?: Database["public"]["Enums"]["task_priority"] | null
          team_id?: string | null
          time_tracking_log?: Json | null
          title?: string
          user_asign_id?: string | null
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "tasks_contact_id_fkey"
            columns: ["contact_id"]
            isOneToOne: false
            referencedRelation: "contacts"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "tasks_department_id_fkey"
            columns: ["department_id"]
            isOneToOne: false
            referencedRelation: "departments"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "tasks_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "tasks_user_asign_id_fkey"
            columns: ["user_asign_id"]
            isOneToOne: false
            referencedRelation: "profiles"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "tasks_user_asign_id_fkey"
            columns: ["user_asign_id"]
            isOneToOne: false
            referencedRelation: "team_members_with_profiles"
            referencedColumns: ["user_id"]
          },
        ]
      }
      team_credentials: {
        Row: {
          access_token: string | null
          connected_by_user_id: string | null
          created_at: string | null
          expires_at: string | null
          id: string
          provider: string
          provider_page_id: string | null
          provider_page_name: string | null
          provider_user_id: string | null
          refresh_token: string | null
          team_id: string
          user_id: string | null
        }
        Insert: {
          access_token?: string | null
          connected_by_user_id?: string | null
          created_at?: string | null
          expires_at?: string | null
          id?: string
          provider: string
          provider_page_id?: string | null
          provider_page_name?: string | null
          provider_user_id?: string | null
          refresh_token?: string | null
          team_id: string
          user_id?: string | null
        }
        Update: {
          access_token?: string | null
          connected_by_user_id?: string | null
          created_at?: string | null
          expires_at?: string | null
          id?: string
          provider?: string
          provider_page_id?: string | null
          provider_page_name?: string | null
          provider_user_id?: string | null
          refresh_token?: string | null
          team_id?: string
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "team_credentials_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      team_members: {
        Row: {
          created_at: string | null
          role: string
          team_id: string
          user_id: string
        }
        Insert: {
          created_at?: string | null
          role: string
          team_id: string
          user_id: string
        }
        Update: {
          created_at?: string | null
          role?: string
          team_id?: string
          user_id?: string
        }
        Relationships: [
          {
            foreignKeyName: "team_members_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
      teams: {
        Row: {
          address: string | null
          city: string | null
          country: string | null
          created_at: string | null
          email: string | null
          id: string
          latitude: number | null
          logo_url: string | null
          longitude: number | null
          name: string
          owner_id: string
          phone: string | null
          postal_code: string | null
          region: string | null
          sector: string | null
          services: Json | null
          street: string | null
          summary: string | null
          tax_id: string | null
          website: string | null
        }
        Insert: {
          address?: string | null
          city?: string | null
          country?: string | null
          created_at?: string | null
          email?: string | null
          id?: string
          latitude?: number | null
          logo_url?: string | null
          longitude?: number | null
          name: string
          owner_id: string
          phone?: string | null
          postal_code?: string | null
          region?: string | null
          sector?: string | null
          services?: Json | null
          street?: string | null
          summary?: string | null
          tax_id?: string | null
          website?: string | null
        }
        Update: {
          address?: string | null
          city?: string | null
          country?: string | null
          created_at?: string | null
          email?: string | null
          id?: string
          latitude?: number | null
          logo_url?: string | null
          longitude?: number | null
          name?: string
          owner_id?: string
          phone?: string | null
          postal_code?: string | null
          region?: string | null
          sector?: string | null
          services?: Json | null
          street?: string | null
          summary?: string | null
          tax_id?: string | null
          website?: string | null
        }
        Relationships: []
      }
      ticket_assignments: {
        Row: {
          created_at: string
          deal_id: number | null
          id: number
          team_id: string
          ticket_id: number
        }
        Insert: {
          created_at?: string
          deal_id?: number | null
          id?: number
          team_id: string
          ticket_id: number
        }
        Update: {
          created_at?: string
          deal_id?: number | null
          id?: number
          team_id?: string
          ticket_id?: number
        }
        Relationships: [
          {
            foreignKeyName: "ticket_assignments_deal_id_fkey"
            columns: ["deal_id"]
            isOneToOne: false
            referencedRelation: "opportunities"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "ticket_assignments_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "ticket_assignments_ticket_id_fkey"
            columns: ["ticket_id"]
            isOneToOne: false
            referencedRelation: "enriched_tickets"
            referencedColumns: ["id"]
          },
          {
            foreignKeyName: "ticket_assignments_ticket_id_fkey"
            columns: ["ticket_id"]
            isOneToOne: false
            referencedRelation: "tickets"
            referencedColumns: ["id"]
          },
        ]
      }
      tickets: {
        Row: {
          attachments: Json | null
          body: string | null
          contact_id: number | null
          created_at: string | null
          id: number
          preview: string | null
          provider: string | null
          provider_message_id: string | null
          sender_email: string | null
          sender_name: string | null
          sent_at: string | null
          status: string | null
          subject: string | null
          type: string | null
          user_id: string | null
        }
        Insert: {
          attachments?: Json | null
          body?: string | null
          contact_id?: number | null
          created_at?: string | null
          id?: number
          preview?: string | null
          provider?: string | null
          provider_message_id?: string | null
          sender_email?: string | null
          sender_name?: string | null
          sent_at?: string | null
          status?: string | null
          subject?: string | null
          type?: string | null
          user_id?: string | null
        }
        Update: {
          attachments?: Json | null
          body?: string | null
          contact_id?: number | null
          created_at?: string | null
          id?: number
          preview?: string | null
          provider?: string | null
          provider_message_id?: string | null
          sender_email?: string | null
          sender_name?: string | null
          sent_at?: string | null
          status?: string | null
          subject?: string | null
          type?: string | null
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "tickets_contact_id_fkey"
            columns: ["contact_id"]
            isOneToOne: false
            referencedRelation: "contacts"
            referencedColumns: ["id"]
          },
        ]
      }
      user_credentials: {
        Row: {
          access_token: string | null
          config: Json | null
          created_at: string | null
          encrypted_password: string | null
          expires_at: string | null
          id: number
          provider: string
          provider_page_id: string | null
          provider_user_id: string | null
          refresh_token: string | null
          team_id: string | null
          updated_at: string | null
          user_id: string | null
        }
        Insert: {
          access_token?: string | null
          config?: Json | null
          created_at?: string | null
          encrypted_password?: string | null
          expires_at?: string | null
          id?: number
          provider: string
          provider_page_id?: string | null
          provider_user_id?: string | null
          refresh_token?: string | null
          team_id?: string | null
          updated_at?: string | null
          user_id?: string | null
        }
        Update: {
          access_token?: string | null
          config?: Json | null
          created_at?: string | null
          encrypted_password?: string | null
          expires_at?: string | null
          id?: number
          provider?: string
          provider_page_id?: string | null
          provider_user_id?: string | null
          refresh_token?: string | null
          team_id?: string | null
          updated_at?: string | null
          user_id?: string | null
        }
        Relationships: [
          {
            foreignKeyName: "user_credentials_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
    }
    Views: {
      enriched_tickets: {
        Row: {
          attachments: Json | null
          body: string | null
          contact_email: string | null
          contact_id: number | null
          contact_nom: string | null
          created_at: string | null
          id: number | null
          preview: string | null
          profile_avatar_url: string | null
          profile_full_name: string | null
          provider: string | null
          provider_message_id: string | null
          sender_email: string | null
          sender_name: string | null
          sent_at: string | null
          status: string | null
          subject: string | null
          type: string | null
          user_id: string | null
        }
        Relationships: [
          {
            foreignKeyName: "tickets_contact_id_fkey"
            columns: ["contact_id"]
            isOneToOne: false
            referencedRelation: "contacts"
            referencedColumns: ["id"]
          },
        ]
      }
      geography_columns: {
        Row: {
          coord_dimension: number | null
          f_geography_column: unknown
          f_table_catalog: unknown
          f_table_name: unknown
          f_table_schema: unknown
          srid: number | null
          type: string | null
        }
        Relationships: []
      }
      geometry_columns: {
        Row: {
          coord_dimension: number | null
          f_geometry_column: unknown
          f_table_catalog: string | null
          f_table_name: unknown
          f_table_schema: unknown
          srid: number | null
          type: string | null
        }
        Insert: {
          coord_dimension?: number | null
          f_geometry_column?: unknown
          f_table_catalog?: string | null
          f_table_name?: unknown
          f_table_schema?: unknown
          srid?: number | null
          type?: string | null
        }
        Update: {
          coord_dimension?: number | null
          f_geometry_column?: unknown
          f_table_catalog?: string | null
          f_table_name?: unknown
          f_table_schema?: unknown
          srid?: number | null
          type?: string | null
        }
        Relationships: []
      }
      team_members_with_profiles: {
        Row: {
          avatar_url: string | null
          email: string | null
          full_name: string | null
          role: string | null
          team_id: string | null
          user_id: string | null
        }
        Relationships: [
          {
            foreignKeyName: "team_members_team_id_fkey"
            columns: ["team_id"]
            isOneToOne: false
            referencedRelation: "teams"
            referencedColumns: ["id"]
          },
        ]
      }
    }
    Functions: {
      _postgis_deprecate: {
        Args: { newname: string; oldname: string; version: string }
        Returns: undefined
      }
      _postgis_index_extent: {
        Args: { col: string; tbl: unknown }
        Returns: unknown
      }
      _postgis_pgsql_version: { Args: never; Returns: string }
      _postgis_scripts_pgsql_version: { Args: never; Returns: string }
      _postgis_selectivity: {
        Args: { att_name: string; geom: unknown; mode?: string; tbl: unknown }
        Returns: number
      }
      _postgis_stats: {
        Args: { ""?: string; att_name: string; tbl: unknown }
        Returns: string
      }
      _st_3dintersects: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      _st_contains: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      _st_containsproperly: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      _st_coveredby:
        | { Args: { geog1: unknown; geog2: unknown }; Returns: boolean }
        | { Args: { geom1: unknown; geom2: unknown }; Returns: boolean }
      _st_covers:
        | { Args: { geog1: unknown; geog2: unknown }; Returns: boolean }
        | { Args: { geom1: unknown; geom2: unknown }; Returns: boolean }
      _st_crosses: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      _st_dwithin: {
        Args: {
          geog1: unknown
          geog2: unknown
          tolerance: number
          use_spheroid?: boolean
        }
        Returns: boolean
      }
      _st_equals: { Args: { geom1: unknown; geom2: unknown }; Returns: boolean }
      _st_intersects: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      _st_linecrossingdirection: {
        Args: { line1: unknown; line2: unknown }
        Returns: number
      }
      _st_longestline: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: unknown
      }
      _st_maxdistance: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: number
      }
      _st_orderingequals: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      _st_overlaps: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      _st_sortablehash: { Args: { geom: unknown }; Returns: number }
      _st_touches: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      _st_voronoi: {
        Args: {
          clip?: unknown
          g1: unknown
          return_polygons?: boolean
          tolerance?: number
        }
        Returns: unknown
      }
      _st_within: { Args: { geom1: unknown; geom2: unknown }; Returns: boolean }
      accept_invitation: {
        Args: { invitation_token: string }
        Returns: undefined
      }
      accept_invitation_and_set_active_team: {
        Args: { invite_token: string }
        Returns: Json
      }
      accept_personal_invitation: {
        Args: { invitation_id: string }
        Returns: Json
      }
      addauth: { Args: { "": string }; Returns: boolean }
      addgeometrycolumn:
        | {
            Args: {
              column_name: string
              new_dim: number
              new_srid: number
              new_type: string
              schema_name: string
              table_name: string
              use_typmod?: boolean
            }
            Returns: string
          }
        | {
            Args: {
              column_name: string
              new_dim: number
              new_srid: number
              new_type: string
              table_name: string
              use_typmod?: boolean
            }
            Returns: string
          }
        | {
            Args: {
              catalog_name: string
              column_name: string
              new_dim: number
              new_srid_in: number
              new_type: string
              schema_name: string
              table_name: string
              use_typmod?: boolean
            }
            Returns: string
          }
      create_new_organization: { Args: { org_name: string }; Returns: string }
      create_team_with_defaults: {
        Args: { team_name: string }
        Returns: string
      }
      delete_user_credential: {
        Args: { provider_name: string }
        Returns: undefined
      }
      disablelongtransactions: { Args: never; Returns: string }
      dropgeometrycolumn:
        | {
            Args: {
              column_name: string
              schema_name: string
              table_name: string
            }
            Returns: string
          }
        | { Args: { column_name: string; table_name: string }; Returns: string }
        | {
            Args: {
              catalog_name: string
              column_name: string
              schema_name: string
              table_name: string
            }
            Returns: string
          }
      dropgeometrytable:
        | { Args: { schema_name: string; table_name: string }; Returns: string }
        | { Args: { table_name: string }; Returns: string }
        | {
            Args: {
              catalog_name: string
              schema_name: string
              table_name: string
            }
            Returns: string
          }
      enablelongtransactions: { Args: never; Returns: string }
      equals: { Args: { geom1: unknown; geom2: unknown }; Returns: boolean }
      geometry: { Args: { "": string }; Returns: unknown }
      geometry_above: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_below: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_cmp: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: number
      }
      geometry_contained_3d: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_contains: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_contains_3d: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_distance_box: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: number
      }
      geometry_distance_centroid: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: number
      }
      geometry_eq: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_ge: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_gt: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_le: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_left: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_lt: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_overabove: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_overbelow: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_overlaps: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_overlaps_3d: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_overleft: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_overright: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_right: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_same: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_same_3d: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geometry_within: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      geomfromewkt: { Args: { "": string }; Returns: unknown }
      get_active_team_id: { Args: never; Returns: string }
      get_column_valid_values: {
        Args: { p_column_name: string; p_ref_table_name: string }
        Returns: {
          value: string
        }[]
      }
      get_crm_dashboard_data: { Args: never; Returns: Json }
      get_crm_overview: { Args: never; Returns: Json }
      get_current_jwt_claims: { Args: never; Returns: string }
      get_current_team_id: { Args: never; Returns: string }
      get_dashboard_stats: {
        Args: never
        Returns: {
          active_clients: number
          expenses_current_month: number
          expenses_previous_month: number
          invoiced_current_month: number
          invoiced_previous_month: number
          opportunities: number
          pending_total: number
          total_contacts: number
        }[]
      }
      get_dashboard_stats_for_team: {
        Args: { p_team_id: string }
        Returns: {
          active_clients: number
          expenses_current_month: number
          expenses_previous_month: number
          invoiced_current_month: number
          invoiced_previous_month: number
          opportunities: number
          pending_total: number
          total_contacts: number
          total_value: number
        }[]
      }
      get_financial_summary: {
        Args: never
        Returns: {
          despeses: number
          facturat: number
          pendent: number
        }[]
      }
      get_inbox_received_count: {
        Args: { p_visible_user_ids: string[] }
        Returns: number
      }
      get_inbox_sent_count: {
        Args: { p_visible_user_ids: string[] }
        Returns: number
      }
      get_inbox_tickets: {
        Args: {
          p_active_filter: string
          p_limit: number
          p_offset: number
          p_search_term: string
          p_team_id: string
          p_user_id: string
          p_visible_user_ids: string[]
        }
        Returns: {
          attachments: Json
          body: string
          contact_email: string
          contact_id: number
          contact_nom: string
          created_at: string
          id: number
          preview: string
          profile_avatar_url: string
          profile_full_name: string
          provider: string
          provider_message_id: string
          sender_email: string
          sender_name: string
          sent_at: string
          status: string
          subject: string
          type: string
          user_id: string
        }[]
      }
      get_marketing_kpis: {
        Args: never
        Returns: {
          conversion_rate: number
          total_leads: number
        }[]
      }
      get_marketing_page_data: { Args: { p_team_id: string }; Returns: Json }
      get_my_team_id: { Args: never; Returns: string }
      get_my_team_ids: { Args: never; Returns: string[] }
      get_my_teams: { Args: never; Returns: string[] }
      get_public_profiles: {
        Args: never
        Returns: {
          company_name: string
          id: string
          latitude: number
          logo_url: string
          longitude: number
          services: Json
          summary: string
          website_url: string
        }[]
      }
      get_quote_details: { Args: { p_quote_id: number }; Returns: Json }
      get_table_columns: {
        Args: { table_name_param: string }
        Returns: {
          column_name: string
        }[]
      }
      get_table_columns_excluding_security: {
        Args: { p_table_name: string }
        Returns: string[]
      }
      get_table_columns_info: {
        Args: { p_table_name: string }
        Returns: {
          column_name: string
          data_type: string
        }[]
      }
      get_user_id_by_email: {
        Args: { email_to_check: string }
        Returns: string
      }
      get_user_team_context: {
        Args: { p_team_id: string; p_user_id: string }
        Returns: Json
      }
      gettransactionid: { Args: never; Returns: unknown }
      handle_onboarding:
        | {
            Args: {
              p_city: string
              p_company_name: string
              p_country: string
              p_email: string
              p_full_name: string
              p_latitude: number
              p_longitude: number
              p_phone: string
              p_postal_code: string
              p_region: string
              p_sector: string
              p_services: string[]
              p_street: string
              p_summary: string
              p_tax_id: string
              p_user_id: string
              p_website: string
            }
            Returns: string
          }
        | {
            Args: {
              p_city: string
              p_company_name: string
              p_country: string
              p_email: string
              p_full_name: string
              p_latitude?: number
              p_longitude?: number
              p_phone: string
              p_postal_code: string
              p_region: string
              p_sector: string
              p_services: string[]
              p_street: string
              p_summary: string
              p_tax_id: string
              p_user_id: string
              p_website: string
            }
            Returns: string
          }
      increment_invoice_sequence: {
        Args: { p_series: string; p_user_id: string }
        Returns: number
      }
      is_contact_on_public_quote: {
        Args: { contact_id_to_check: number }
        Returns: boolean
      }
      is_quote_public: { Args: { quote_id_to_check: number }; Returns: boolean }
      is_team_member: { Args: { team_id_to_check: string }; Returns: boolean }
      is_team_on_public_quote: {
        Args: { team_id_to_check: string }
        Returns: boolean
      }
      log_task_activity: {
        Args: { new_status_input: boolean; task_id_input: number }
        Returns: undefined
      }
      longtransactionsenabled: { Args: never; Returns: boolean }
      match_documents: {
        Args: {
          match_count: number
          match_threshold: number
          query_embedding: string
        }
        Returns: {
          content: string
          id: number
          metadata: Json
          similarity: number
        }[]
      }
      populate_geometry_columns:
        | { Args: { use_typmod?: boolean }; Returns: string }
        | { Args: { tbl_oid: unknown; use_typmod?: boolean }; Returns: number }
      postgis_constraint_dims: {
        Args: { geomcolumn: string; geomschema: string; geomtable: string }
        Returns: number
      }
      postgis_constraint_srid: {
        Args: { geomcolumn: string; geomschema: string; geomtable: string }
        Returns: number
      }
      postgis_constraint_type: {
        Args: { geomcolumn: string; geomschema: string; geomtable: string }
        Returns: string
      }
      postgis_extensions_upgrade: { Args: never; Returns: string }
      postgis_full_version: { Args: never; Returns: string }
      postgis_geos_version: { Args: never; Returns: string }
      postgis_lib_build_date: { Args: never; Returns: string }
      postgis_lib_revision: { Args: never; Returns: string }
      postgis_lib_version: { Args: never; Returns: string }
      postgis_libjson_version: { Args: never; Returns: string }
      postgis_liblwgeom_version: { Args: never; Returns: string }
      postgis_libprotobuf_version: { Args: never; Returns: string }
      postgis_libxml_version: { Args: never; Returns: string }
      postgis_proj_version: { Args: never; Returns: string }
      postgis_scripts_build_date: { Args: never; Returns: string }
      postgis_scripts_installed: { Args: never; Returns: string }
      postgis_scripts_released: { Args: never; Returns: string }
      postgis_svn_version: { Args: never; Returns: string }
      postgis_type_name: {
        Args: {
          coord_dimension: number
          geomname: string
          use_new_name?: boolean
        }
        Returns: string
      }
      postgis_version: { Args: never; Returns: string }
      postgis_wagyu_version: { Args: never; Returns: string }
      save_expense_with_items: {
        Args: {
          expense_data: Json
          items_data: Json
          p_expense_id_to_update?: number
          p_team_id: string
          p_user_id: string
        }
        Returns: {
          category: string | null
          created_at: string
          description: string
          discount_amount: number | null
          expense_date: string
          extra_data: Json | null
          id: number
          invoice_number: string | null
          is_billable: boolean
          is_reimbursable: boolean
          notes: string | null
          payment_date: string | null
          payment_method: string | null
          project_id: string | null
          status: Database["public"]["Enums"]["expense_status"]
          subtotal: number | null
          supplier_id: string | null
          tax_amount: number | null
          tax_rate: number | null
          team_id: string | null
          total_amount: number
          user_id: string
        }[]
        SetofOptions: {
          from: "*"
          to: "expenses"
          isOneToOne: false
          isSetofReturn: true
        }
      }
      save_refresh_token: {
        Args: { provider_name: string; refresh_token_value: string }
        Returns: undefined
      }
      search_expenses: {
        Args: {
          p_category: string
          p_limit: number
          p_offset: number
          p_search_term: string
          p_sort_by: string
          p_sort_order: string
          p_status: string
          p_team_id: string
        }
        Returns: {
          category: string
          created_at: string
          description: string
          discount_amount: number
          expense_date: string
          extra_data: Json
          id: number
          invoice_number: string
          is_billable: boolean
          is_reimbursable: boolean
          notes: string
          payment_date: string
          payment_method: string
          project_id: string
          status: Database["public"]["Enums"]["expense_status"]
          subtotal: number
          supplier_id: string
          supplier_nom: string
          tax_amount: number
          tax_rate: number
          team_id: string
          total_amount: number
          total_count: number
          user_id: string
        }[]
      }
      search_invoices: {
        Args: {
          page_limit: number
          page_offset: number
          search_term: string
          sort_direction: string
          sort_field: string
          status_filter?: string
        }
        Returns: {
          client_name: string
          contact_id: number
          created_at: string
          due_date: string
          id: number
          invoice_number: string
          issue_date: string
          notes: string
          secure_id: string
          status: string
          team_id: string
          total_amount: number
          total_count: number
          user_id: string
        }[]
      }
      search_paginated_invoices: {
        Args: {
          contact_id_param: number
          limit_param: number
          offset_param: number
          search_term_param: string
          sort_by_param: string
          sort_order_param: string
          status_param: string
          team_id_param: string
        }
        Returns: {
          client_name: string
          contact_id: number
          contact_nom: string
          due_date: string
          id: number
          invoice_number: string
          issue_date: string
          status: string
          total_amount: number
          total_count: number
        }[]
      }
      search_paginated_quotes: {
        Args: {
          limit_param?: number
          offset_param?: number
          search_term_param?: string
          sort_by_param?: string
          sort_order_param?: string
          status_param?: Database["public"]["Enums"]["quote_status"]
          team_id_param: string
        }
        Returns: {
          contact_empresa: string
          contact_id: number
          contact_nom: string
          created_at: string
          discount: number
          expiry_date: string
          id: number
          issue_date: string
          notes: string
          opportunity_id: number
          quote_number: string
          rejection_reason: string
          secure_id: string
          send_at: string
          sent_at: string
          sequence_number: number
          show_quantity: boolean
          status: Database["public"]["Enums"]["quote_status"]
          subtotal: number
          tax: number
          tax_percent: number
          team_id: string
          theme_color: string
          total: number
          total_count: number
          user_id: string
        }[]
      }
      st_3dclosestpoint: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: unknown
      }
      st_3ddistance: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: number
      }
      st_3dintersects: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      st_3dlongestline: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: unknown
      }
      st_3dmakebox: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: unknown
      }
      st_3dmaxdistance: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: number
      }
      st_3dshortestline: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: unknown
      }
      st_addpoint: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: unknown
      }
      st_angle:
        | { Args: { line1: unknown; line2: unknown }; Returns: number }
        | {
            Args: { pt1: unknown; pt2: unknown; pt3: unknown; pt4?: unknown }
            Returns: number
          }
      st_area:
        | { Args: { geog: unknown; use_spheroid?: boolean }; Returns: number }
        | { Args: { "": string }; Returns: number }
      st_asencodedpolyline: {
        Args: { geom: unknown; nprecision?: number }
        Returns: string
      }
      st_asewkt: { Args: { "": string }; Returns: string }
      st_asgeojson:
        | {
            Args: {
              geom_column?: string
              maxdecimaldigits?: number
              pretty_bool?: boolean
              r: Record<string, unknown>
            }
            Returns: string
          }
        | {
            Args: { geom: unknown; maxdecimaldigits?: number; options?: number }
            Returns: string
          }
        | {
            Args: { geog: unknown; maxdecimaldigits?: number; options?: number }
            Returns: string
          }
        | { Args: { "": string }; Returns: string }
      st_asgml:
        | {
            Args: { geom: unknown; maxdecimaldigits?: number; options?: number }
            Returns: string
          }
        | {
            Args: {
              geom: unknown
              id?: string
              maxdecimaldigits?: number
              nprefix?: string
              options?: number
              version: number
            }
            Returns: string
          }
        | {
            Args: {
              geog: unknown
              id?: string
              maxdecimaldigits?: number
              nprefix?: string
              options?: number
              version: number
            }
            Returns: string
          }
        | {
            Args: {
              geog: unknown
              id?: string
              maxdecimaldigits?: number
              nprefix?: string
              options?: number
            }
            Returns: string
          }
        | { Args: { "": string }; Returns: string }
      st_askml:
        | {
            Args: { geom: unknown; maxdecimaldigits?: number; nprefix?: string }
            Returns: string
          }
        | {
            Args: { geog: unknown; maxdecimaldigits?: number; nprefix?: string }
            Returns: string
          }
        | { Args: { "": string }; Returns: string }
      st_aslatlontext: {
        Args: { geom: unknown; tmpl?: string }
        Returns: string
      }
      st_asmarc21: { Args: { format?: string; geom: unknown }; Returns: string }
      st_asmvtgeom: {
        Args: {
          bounds: unknown
          buffer?: number
          clip_geom?: boolean
          extent?: number
          geom: unknown
        }
        Returns: unknown
      }
      st_assvg:
        | {
            Args: { geom: unknown; maxdecimaldigits?: number; rel?: number }
            Returns: string
          }
        | {
            Args: { geog: unknown; maxdecimaldigits?: number; rel?: number }
            Returns: string
          }
        | { Args: { "": string }; Returns: string }
      st_astext: { Args: { "": string }; Returns: string }
      st_astwkb:
        | {
            Args: {
              geom: unknown[]
              ids: number[]
              prec?: number
              prec_m?: number
              prec_z?: number
              with_boxes?: boolean
              with_sizes?: boolean
            }
            Returns: string
          }
        | {
            Args: {
              geom: unknown
              prec?: number
              prec_m?: number
              prec_z?: number
              with_boxes?: boolean
              with_sizes?: boolean
            }
            Returns: string
          }
      st_asx3d: {
        Args: { geom: unknown; maxdecimaldigits?: number; options?: number }
        Returns: string
      }
      st_azimuth:
        | { Args: { geom1: unknown; geom2: unknown }; Returns: number }
        | { Args: { geog1: unknown; geog2: unknown }; Returns: number }
      st_boundingdiagonal: {
        Args: { fits?: boolean; geom: unknown }
        Returns: unknown
      }
      st_buffer:
        | {
            Args: { geom: unknown; options?: string; radius: number }
            Returns: unknown
          }
        | {
            Args: { geom: unknown; quadsegs: number; radius: number }
            Returns: unknown
          }
      st_centroid: { Args: { "": string }; Returns: unknown }
      st_clipbybox2d: {
        Args: { box: unknown; geom: unknown }
        Returns: unknown
      }
      st_closestpoint: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: unknown
      }
      st_collect: { Args: { geom1: unknown; geom2: unknown }; Returns: unknown }
      st_concavehull: {
        Args: {
          param_allow_holes?: boolean
          param_geom: unknown
          param_pctconvex: number
        }
        Returns: unknown
      }
      st_contains: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      st_containsproperly: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      st_coorddim: { Args: { geometry: unknown }; Returns: number }
      st_coveredby:
        | { Args: { geog1: unknown; geog2: unknown }; Returns: boolean }
        | { Args: { geom1: unknown; geom2: unknown }; Returns: boolean }
      st_covers:
        | { Args: { geog1: unknown; geog2: unknown }; Returns: boolean }
        | { Args: { geom1: unknown; geom2: unknown }; Returns: boolean }
      st_crosses: { Args: { geom1: unknown; geom2: unknown }; Returns: boolean }
      st_curvetoline: {
        Args: { flags?: number; geom: unknown; tol?: number; toltype?: number }
        Returns: unknown
      }
      st_delaunaytriangles: {
        Args: { flags?: number; g1: unknown; tolerance?: number }
        Returns: unknown
      }
      st_difference: {
        Args: { geom1: unknown; geom2: unknown; gridsize?: number }
        Returns: unknown
      }
      st_disjoint: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      st_distance:
        | { Args: { geom1: unknown; geom2: unknown }; Returns: number }
        | {
            Args: { geog1: unknown; geog2: unknown; use_spheroid?: boolean }
            Returns: number
          }
      st_distancesphere:
        | { Args: { geom1: unknown; geom2: unknown }; Returns: number }
        | {
            Args: { geom1: unknown; geom2: unknown; radius: number }
            Returns: number
          }
      st_distancespheroid: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: number
      }
      st_dwithin: {
        Args: {
          geog1: unknown
          geog2: unknown
          tolerance: number
          use_spheroid?: boolean
        }
        Returns: boolean
      }
      st_equals: { Args: { geom1: unknown; geom2: unknown }; Returns: boolean }
      st_expand:
        | {
            Args: {
              dm?: number
              dx: number
              dy: number
              dz?: number
              geom: unknown
            }
            Returns: unknown
          }
        | {
            Args: { box: unknown; dx: number; dy: number; dz?: number }
            Returns: unknown
          }
        | { Args: { box: unknown; dx: number; dy: number }; Returns: unknown }
      st_force3d: { Args: { geom: unknown; zvalue?: number }; Returns: unknown }
      st_force3dm: {
        Args: { geom: unknown; mvalue?: number }
        Returns: unknown
      }
      st_force3dz: {
        Args: { geom: unknown; zvalue?: number }
        Returns: unknown
      }
      st_force4d: {
        Args: { geom: unknown; mvalue?: number; zvalue?: number }
        Returns: unknown
      }
      st_generatepoints:
        | {
            Args: { area: unknown; npoints: number; seed: number }
            Returns: unknown
          }
        | { Args: { area: unknown; npoints: number }; Returns: unknown }
      st_geogfromtext: { Args: { "": string }; Returns: unknown }
      st_geographyfromtext: { Args: { "": string }; Returns: unknown }
      st_geohash:
        | { Args: { geom: unknown; maxchars?: number }; Returns: string }
        | { Args: { geog: unknown; maxchars?: number }; Returns: string }
      st_geomcollfromtext: { Args: { "": string }; Returns: unknown }
      st_geometricmedian: {
        Args: {
          fail_if_not_converged?: boolean
          g: unknown
          max_iter?: number
          tolerance?: number
        }
        Returns: unknown
      }
      st_geometryfromtext: { Args: { "": string }; Returns: unknown }
      st_geomfromewkt: { Args: { "": string }; Returns: unknown }
      st_geomfromgeojson:
        | { Args: { "": Json }; Returns: unknown }
        | { Args: { "": Json }; Returns: unknown }
        | { Args: { "": string }; Returns: unknown }
      st_geomfromgml: { Args: { "": string }; Returns: unknown }
      st_geomfromkml: { Args: { "": string }; Returns: unknown }
      st_geomfrommarc21: { Args: { marc21xml: string }; Returns: unknown }
      st_geomfromtext: { Args: { "": string }; Returns: unknown }
      st_gmltosql: { Args: { "": string }; Returns: unknown }
      st_hasarc: { Args: { geometry: unknown }; Returns: boolean }
      st_hausdorffdistance: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: number
      }
      st_hexagon: {
        Args: { cell_i: number; cell_j: number; origin?: unknown; size: number }
        Returns: unknown
      }
      st_hexagongrid: {
        Args: { bounds: unknown; size: number }
        Returns: Record<string, unknown>[]
      }
      st_interpolatepoint: {
        Args: { line: unknown; point: unknown }
        Returns: number
      }
      st_intersection: {
        Args: { geom1: unknown; geom2: unknown; gridsize?: number }
        Returns: unknown
      }
      st_intersects:
        | { Args: { geom1: unknown; geom2: unknown }; Returns: boolean }
        | { Args: { geog1: unknown; geog2: unknown }; Returns: boolean }
      st_isvaliddetail: {
        Args: { flags?: number; geom: unknown }
        Returns: Database["public"]["CompositeTypes"]["valid_detail"]
        SetofOptions: {
          from: "*"
          to: "valid_detail"
          isOneToOne: true
          isSetofReturn: false
        }
      }
      st_length:
        | { Args: { geog: unknown; use_spheroid?: boolean }; Returns: number }
        | { Args: { "": string }; Returns: number }
      st_letters: { Args: { font?: Json; letters: string }; Returns: unknown }
      st_linecrossingdirection: {
        Args: { line1: unknown; line2: unknown }
        Returns: number
      }
      st_linefromencodedpolyline: {
        Args: { nprecision?: number; txtin: string }
        Returns: unknown
      }
      st_linefromtext: { Args: { "": string }; Returns: unknown }
      st_linelocatepoint: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: number
      }
      st_linetocurve: { Args: { geometry: unknown }; Returns: unknown }
      st_locatealong: {
        Args: { geometry: unknown; leftrightoffset?: number; measure: number }
        Returns: unknown
      }
      st_locatebetween: {
        Args: {
          frommeasure: number
          geometry: unknown
          leftrightoffset?: number
          tomeasure: number
        }
        Returns: unknown
      }
      st_locatebetweenelevations: {
        Args: { fromelevation: number; geometry: unknown; toelevation: number }
        Returns: unknown
      }
      st_longestline: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: unknown
      }
      st_makebox2d: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: unknown
      }
      st_makeline: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: unknown
      }
      st_makevalid: {
        Args: { geom: unknown; params: string }
        Returns: unknown
      }
      st_maxdistance: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: number
      }
      st_minimumboundingcircle: {
        Args: { inputgeom: unknown; segs_per_quarter?: number }
        Returns: unknown
      }
      st_mlinefromtext: { Args: { "": string }; Returns: unknown }
      st_mpointfromtext: { Args: { "": string }; Returns: unknown }
      st_mpolyfromtext: { Args: { "": string }; Returns: unknown }
      st_multilinestringfromtext: { Args: { "": string }; Returns: unknown }
      st_multipointfromtext: { Args: { "": string }; Returns: unknown }
      st_multipolygonfromtext: { Args: { "": string }; Returns: unknown }
      st_node: { Args: { g: unknown }; Returns: unknown }
      st_normalize: { Args: { geom: unknown }; Returns: unknown }
      st_offsetcurve: {
        Args: { distance: number; line: unknown; params?: string }
        Returns: unknown
      }
      st_orderingequals: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      st_overlaps: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: boolean
      }
      st_perimeter: {
        Args: { geog: unknown; use_spheroid?: boolean }
        Returns: number
      }
      st_pointfromtext: { Args: { "": string }; Returns: unknown }
      st_pointm: {
        Args: {
          mcoordinate: number
          srid?: number
          xcoordinate: number
          ycoordinate: number
        }
        Returns: unknown
      }
      st_pointz: {
        Args: {
          srid?: number
          xcoordinate: number
          ycoordinate: number
          zcoordinate: number
        }
        Returns: unknown
      }
      st_pointzm: {
        Args: {
          mcoordinate: number
          srid?: number
          xcoordinate: number
          ycoordinate: number
          zcoordinate: number
        }
        Returns: unknown
      }
      st_polyfromtext: { Args: { "": string }; Returns: unknown }
      st_polygonfromtext: { Args: { "": string }; Returns: unknown }
      st_project: {
        Args: { azimuth: number; distance: number; geog: unknown }
        Returns: unknown
      }
      st_quantizecoordinates: {
        Args: {
          g: unknown
          prec_m?: number
          prec_x: number
          prec_y?: number
          prec_z?: number
        }
        Returns: unknown
      }
      st_reduceprecision: {
        Args: { geom: unknown; gridsize: number }
        Returns: unknown
      }
      st_relate: { Args: { geom1: unknown; geom2: unknown }; Returns: string }
      st_removerepeatedpoints: {
        Args: { geom: unknown; tolerance?: number }
        Returns: unknown
      }
      st_segmentize: {
        Args: { geog: unknown; max_segment_length: number }
        Returns: unknown
      }
      st_setsrid:
        | { Args: { geom: unknown; srid: number }; Returns: unknown }
        | { Args: { geog: unknown; srid: number }; Returns: unknown }
      st_sharedpaths: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: unknown
      }
      st_shortestline: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: unknown
      }
      st_simplifypolygonhull: {
        Args: { geom: unknown; is_outer?: boolean; vertex_fraction: number }
        Returns: unknown
      }
      st_split: { Args: { geom1: unknown; geom2: unknown }; Returns: unknown }
      st_square: {
        Args: { cell_i: number; cell_j: number; origin?: unknown; size: number }
        Returns: unknown
      }
      st_squaregrid: {
        Args: { bounds: unknown; size: number }
        Returns: Record<string, unknown>[]
      }
      st_srid:
        | { Args: { geom: unknown }; Returns: number }
        | { Args: { geog: unknown }; Returns: number }
      st_subdivide: {
        Args: { geom: unknown; gridsize?: number; maxvertices?: number }
        Returns: unknown[]
      }
      st_swapordinates: {
        Args: { geom: unknown; ords: unknown }
        Returns: unknown
      }
      st_symdifference: {
        Args: { geom1: unknown; geom2: unknown; gridsize?: number }
        Returns: unknown
      }
      st_symmetricdifference: {
        Args: { geom1: unknown; geom2: unknown }
        Returns: unknown
      }
      st_tileenvelope: {
        Args: {
          bounds?: unknown
          margin?: number
          x: number
          y: number
          zoom: number
        }
        Returns: unknown
      }
      st_touches: { Args: { geom1: unknown; geom2: unknown }; Returns: boolean }
      st_transform:
        | { Args: { geom: unknown; to_proj: string }; Returns: unknown }
        | {
            Args: { from_proj: string; geom: unknown; to_srid: number }
            Returns: unknown
          }
        | {
            Args: { from_proj: string; geom: unknown; to_proj: string }
            Returns: unknown
          }
      st_triangulatepolygon: { Args: { g1: unknown }; Returns: unknown }
      st_union:
        | {
            Args: { geom1: unknown; geom2: unknown; gridsize: number }
            Returns: unknown
          }
        | { Args: { geom1: unknown; geom2: unknown }; Returns: unknown }
      st_voronoilines: {
        Args: { extend_to?: unknown; g1: unknown; tolerance?: number }
        Returns: unknown
      }
      st_voronoipolygons: {
        Args: { extend_to?: unknown; g1: unknown; tolerance?: number }
        Returns: unknown
      }
      st_within: { Args: { geom1: unknown; geom2: unknown }; Returns: boolean }
      st_wkbtosql: { Args: { wkb: string }; Returns: unknown }
      st_wkttosql: { Args: { "": string }; Returns: unknown }
      st_wrapx: {
        Args: { geom: unknown; move: number; wrap: number }
        Returns: unknown
      }
      unlockrows: { Args: { "": string }; Returns: number }
      update_contact_last_interaction: {
        Args: { contact_id_to_update: number }
        Returns: undefined
      }
      updategeometrysrid: {
        Args: {
          catalogn_name: string
          column_name: string
          new_srid_in: number
          schema_name: string
          table_name: string
        }
        Returns: string
      }
      upsert_expense_with_items: {
        Args: {
          p_expense_details: Json
          p_expense_id: number
          p_expense_items: Json
          p_team_id: string
          p_user_id: string
        }
        Returns: {
          category: string
          created_at: string
          description: string
          discount_amount: number
          expense_date: string
          extra_data: Json
          id: number
          invoice_number: string
          notes: string
          subtotal: number
          supplier_id: string
          tax_amount: number
          tax_rate: number
          team_id: string
          total_amount: number
          user_id: string
        }[]
      }
      upsert_invoice_with_items: {
        Args: {
          invoice_data: Json
          items_data: Json
          team_id: string
          user_id: string
        }
        Returns: {
          generated_invoice_id: number
        }[]
      }
      upsert_quote_with_items: { Args: { quote_payload: Json }; Returns: Json }
    }
    Enums: {
      audio_job_status: "pending" | "processing" | "completed" | "failed"
      expense_status: "pending" | "paid" | "overdue" | "cancelled"
      invoice_status: "Draft" | "Sent" | "Paid" | "Overdue" | "Cancelled"
      job_status: "open" | "closed"
      opportunity_stage:
        | "Nou Lead"
        | "Contactat"
        | "Proposta Enviada"
        | "Negociaciâ”œâ”‚"
        | "Guanyat"
        | "Perdut"
      quote_status: "Draft" | "Sent" | "Accepted" | "Declined" | "Invoiced"
      task_priority: "Baixa" | "Mitjana" | "Alta"
      ticket_filter: "tots" | "rebuts" | "enviats" | "noLlegits"
      ticket_status:
        | "Obert"
        | "En progrâ”œÂ®s"
        | "Esperant resposta"
        | "Tancat"
        | "Llegit"
      ticket_type: "rebut" | "enviat"
    }
    CompositeTypes: {
      geometry_dump: {
        path: number[] | null
        geom: unknown
      }
      valid_detail: {
        valid: boolean | null
        reason: string | null
        location: unknown
      }
    }
  }
}

type DatabaseWithoutInternals = Omit<Database, "__InternalSupabase">

type DefaultSchema = DatabaseWithoutInternals[Extract<keyof Database, "public">]

export type Tables<
  DefaultSchemaTableNameOrOptions extends
    | keyof (DefaultSchema["Tables"] & DefaultSchema["Views"])
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
        DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? (DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"] &
      DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Views"])[TableName] extends {
      Row: infer R
    }
    ? R
    : never
  : DefaultSchemaTableNameOrOptions extends keyof (DefaultSchema["Tables"] &
        DefaultSchema["Views"])
    ? (DefaultSchema["Tables"] &
        DefaultSchema["Views"])[DefaultSchemaTableNameOrOptions] extends {
        Row: infer R
      }
      ? R
      : never
    : never

export type TablesInsert<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Insert: infer I
    }
    ? I
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Insert: infer I
      }
      ? I
      : never
    : never

export type TablesUpdate<
  DefaultSchemaTableNameOrOptions extends
    | keyof DefaultSchema["Tables"]
    | { schema: keyof DatabaseWithoutInternals },
  TableName extends DefaultSchemaTableNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"]
    : never = never,
> = DefaultSchemaTableNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaTableNameOrOptions["schema"]]["Tables"][TableName] extends {
      Update: infer U
    }
    ? U
    : never
  : DefaultSchemaTableNameOrOptions extends keyof DefaultSchema["Tables"]
    ? DefaultSchema["Tables"][DefaultSchemaTableNameOrOptions] extends {
        Update: infer U
      }
      ? U
      : never
    : never

export type Enums<
  DefaultSchemaEnumNameOrOptions extends
    | keyof DefaultSchema["Enums"]
    | { schema: keyof DatabaseWithoutInternals },
  EnumName extends DefaultSchemaEnumNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"]
    : never = never,
> = DefaultSchemaEnumNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[DefaultSchemaEnumNameOrOptions["schema"]]["Enums"][EnumName]
  : DefaultSchemaEnumNameOrOptions extends keyof DefaultSchema["Enums"]
    ? DefaultSchema["Enums"][DefaultSchemaEnumNameOrOptions]
    : never

export type CompositeTypes<
  PublicCompositeTypeNameOrOptions extends
    | keyof DefaultSchema["CompositeTypes"]
    | { schema: keyof DatabaseWithoutInternals },
  CompositeTypeName extends PublicCompositeTypeNameOrOptions extends {
    schema: keyof DatabaseWithoutInternals
  }
    ? keyof DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"]
    : never = never,
> = PublicCompositeTypeNameOrOptions extends {
  schema: keyof DatabaseWithoutInternals
}
  ? DatabaseWithoutInternals[PublicCompositeTypeNameOrOptions["schema"]]["CompositeTypes"][CompositeTypeName]
  : PublicCompositeTypeNameOrOptions extends keyof DefaultSchema["CompositeTypes"]
    ? DefaultSchema["CompositeTypes"][PublicCompositeTypeNameOrOptions]
    : never

export const Constants = {
  graphql_public: {
    Enums: {},
  },
  public: {
    Enums: {
      audio_job_status: ["pending", "processing", "completed", "failed"],
      expense_status: ["pending", "paid", "overdue", "cancelled"],
      invoice_status: ["Draft", "Sent", "Paid", "Overdue", "Cancelled"],
      job_status: ["open", "closed"],
      opportunity_stage: [
        "Nou Lead",
        "Contactat",
        "Proposta Enviada",
        "Negociaciâ”œâ”‚",
        "Guanyat",
        "Perdut",
      ],
      quote_status: ["Draft", "Sent", "Accepted", "Declined", "Invoiced"],
      task_priority: ["Baixa", "Mitjana", "Alta"],
      ticket_filter: ["tots", "rebuts", "enviats", "noLlegits"],
      ticket_status: [
        "Obert",
        "En progrâ”œÂ®s",
        "Esperant resposta",
        "Tancat",
        "Llegit",
      ],
      ticket_type: ["rebut", "enviat"],
    },
  },
} as const


// =================== FILE: src/types/tasks/task.ts ===================


export interface TimeTrackingEntry {
  action: 'start' | 'stop';
  timestamp: string; // Data en format ISO 8601
}
